# ==================================================
# Path: C:\SAN\DA\SHNGEar\SHNGear
# Detected tech: csharp, docker, gitlab_ci, javascript, python, react, rust, typescript
# ==================================================

## DIRECTORY STRUCTURE
```
SHNGear/
â”œâ”€â”€ .git/
â”œâ”€â”€ .vscode/
â”œâ”€â”€ ClientApp/
â”‚   â”œâ”€â”€ .vscode/
â”‚   â”œâ”€â”€ node_modules/
â”‚   â”œâ”€â”€ public/
â”‚   â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â”‚   â”œâ”€â”€ IMG_3351.JPG
â”‚   â”‚   â”‚   â”œâ”€â”€ IMG_3403.JPG
â”‚   â”‚   â”‚   â”œâ”€â”€ IMG_4202.JPG
â”‚   â”‚   â”‚   â”œâ”€â”€ IMG_4208.jpg
â”‚   â”‚   â”‚   â”œâ”€â”€ IMG_4237.JPG
â”‚   â”‚   â”‚   â”œâ”€â”€ IMG_4242.JPG
â”‚   â”‚   â”‚   â”œâ”€â”€ herobanner.JPG
â”‚   â”‚   â”‚   â””â”€â”€ sale-banner.jpg
â”‚   â”‚   â”œâ”€â”€ favicon.ico
â”‚   â”‚   â”œâ”€â”€ index.html
â”‚   â”‚   â””â”€â”€ manifest.webmanifest
â”‚   â”œâ”€â”€ scripts/
â”‚   â”‚   â”œâ”€â”€ convert-all-imports.bat
â”‚   â”‚   â””â”€â”€ convert-imports.js
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ assets/
â”‚   â”‚   â”‚   â”œâ”€â”€ icon/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ facebook.svg
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ gmail.svg
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ linkedin.svg
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ menu.svg
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ search.svg
â”‚   â”‚   â”‚   â”œâ”€â”€ img/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ HeadPhone/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SonyWH-1000XM5.jpg
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ banner_headphone.jpg
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ headphones.jpg
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Laptop/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Laptop_Dell_XPS_13.jpg
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ banner_laptop.jpg
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ laptops.jpg
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Phone/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ banner_iphone.jpg
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ logo.png
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ samsung_S24.jpg
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ smartphones.jpg
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ anhcuanghia/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ background1.png
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ background2.png
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ background3.png
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ banner1.jpg
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ banner1.png
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ banner2.png
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ banner_1.png
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ bannervip.png
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ dien_gia_dung_thumb_2_54c5efa451.png
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ dienthoai_banner.png
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ herobanner.JPG
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ hieuthuhai.png
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ hot-sale-cuoi-tuan.gif
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ laptop_thumb_2_4df0fab60f.png
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ phu_kien_thum_2_21c419aa09.png
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ sale-banner.jpg
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ tivi_baber.png
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ tu_lanh_cate_thumb_77da11d0c4.png
â”‚   â”‚   â”‚   â””â”€â”€ styles/
â”‚   â”‚   â”‚       â”œâ”€â”€ MonumentExtended-Regular.woff
â”‚   â”‚   â”‚       â”œâ”€â”€ MonumentExtended-Regular.woff2
â”‚   â”‚   â”‚       â””â”€â”€ base.css
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ Admin/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ analytics/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AIPoweredInsights.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ChannelPerformance.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CustomerSegmentation.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OverviewCards.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProductPerformance.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RevenueChart.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ UserRetention.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CardProduct.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Header.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Sidebar.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ StatCard.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ orders/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DailyOrders.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EditOrder.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OrderDetailDrawer.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OrderDetailItem.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OrderDistribution.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OrderItem.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ OrdersTable.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ overview/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CategoryDistributionChart.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SalesChannelChart.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ SalesOverviewChart.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ products/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AddProductDrawer.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AddSpecificationDrawer.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BrandDrawer.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BrandModal.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CategoryBrandDrawer.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CategoryModal.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EditProductDrawer.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProductsTable.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SalesTrendChart.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ VoucherDrawer.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ sales/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DailySalesTrend.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SalesByCategoryChart.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ SalesOverviewChart.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ConnectedAccounts.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DangerZone.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Notifications.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Profile.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Security.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SettingSection.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ToggleSwitch.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ users/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ RoleDrawer.jsx
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ UpdateUserDrawer.jsx
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ UserActivityHeatmap.jsx
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ UserDemographicsChart.jsx
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ UserGrowthChart.jsx
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ UsersTable.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Auth/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AuthModal.css
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ AuthModal.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ BestSellerManager/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ BestSellerManager.js
â”‚   â”‚   â”‚   â”œâ”€â”€ BestSellers/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BestSellers.css
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BestSellers.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ BestSellers.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Chat/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AdminChatDashboard.css
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AdminChatDashboard.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ChatWidget.css
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ChatWidget.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Checkout/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Checkout.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Commitment/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Commitment.css
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Commitment.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Commitment.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ CompareProduct/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CompareModal.css
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CompareModal.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ComparePage.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SpecificationComparison.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ SpecificationFilter.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ FeaturedBrands/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ FeaturedBrands.css
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ FeaturedBrands.js
â”‚   â”‚   â”‚   â”œâ”€â”€ FeaturedCategories/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CategoryLarge.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ FeaturedCategories.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ FeaturedCategories.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ FlashSale/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ FlashSale.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ FlashSale.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ FlashSaleManager/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ FlashSaleManager.js
â”‚   â”‚   â”‚   â”œâ”€â”€ Footer/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Footer.css
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Footer.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ HeroBanner/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ HeroBanner.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ HeroBanner.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ HeroSlider/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ HeroSlider.css
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ HeroSlider.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Homepage/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BannerSlider.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BannerSlider.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BrandTrustSection.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CategoriesSection.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ FeaturedProductsSection.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ HeroSection.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ SpecialOfferSection.js
â”‚   â”‚   â”‚   â”œâ”€â”€ List/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CategoryMenu.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ FilterSection.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProductActions.css
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProductCard.css
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProductGrid.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProductHoverPreview.css
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProductHoverPreview.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ProductPagination.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Navbar/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Navbar.css
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Navbar.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ NotificationBar/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ notification.css
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ notification.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Order/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OrderLookup.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ PaymentSuccess.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ PaymentSuccess/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ PaymentSuccess.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ProductInfoPage/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProductImage.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProductInfo.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProductReviews.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProductSpecifications.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProductVariants.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ RelatedProducts.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Profile/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AddPaymentMethod.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AddressBook.css
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AddressBook.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ LoyaltyProgram.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProfileInfo.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProfileSidebar.css
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProfileSidebar.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ UserOrders.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ViewedProducts.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ServiceSlider/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ServiceSlider.css
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ServiceSlider.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ layouts/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AdminLayout.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ DefaultLayout.js
â”‚   â”‚   â”‚   â”œâ”€â”€ shared/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ProductCard.js
â”‚   â”‚   â”‚   â”œâ”€â”€ shoppingcart/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CartDrawer.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CartItem.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ OrderSummary.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ProtectedRoute.jsx
â”‚   â”‚   â”‚   â””â”€â”€ SessionExpiredModal.jsx
â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useAddresses.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useAdmin.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useApi.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useBrands.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useCart.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useCategories.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useChat.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useFeatures.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useFlashSaleProducts.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useLoyalty.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useOrderLookup.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useOrders.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ usePaymentMethod.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useProductData.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useProductForm.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useProductImageManager.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useProductSpecificationManager.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useProducts.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useReviews.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useSearch.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ useUserProfile.js
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ useAuth.js
â”‚   â”‚   â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ useUI.js
â”‚   â”‚   â”‚   â”œâ”€â”€ EXAMPLES.md
â”‚   â”‚   â”‚   â”œâ”€â”€ MIGRATION.md
â”‚   â”‚   â”‚   â”œâ”€â”€ README.md
â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”‚   â”œâ”€â”€ Admin/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AnalyticsPage.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BestSellerAdminPage.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CategoryAdminPage.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ FlashSaleAdminPage.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ HomepageAdminPage.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ HomepageOverviewPage.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OrdersPage.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OverviewPage.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProductsPage.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ReviewManagementPage.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SalesPage.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SettingsPage.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ UsersPage.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Home/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ HomePage.js
â”‚   â”‚   â”‚   â”œâ”€â”€ OrderLookupPage/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ OrderLookupPage.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ProductList/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProductList.css
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ProductList.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ProductPage/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProductPage.css
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ProductPage.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ProfilePage/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProfilePage.css
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ProfilePage.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Unauthorized/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Unauthorized.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ blog/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BlogList.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BlogPostDetail.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ BlogPostEditor.js
â”‚   â”‚   â”‚   â””â”€â”€ shoppingcart/
â”‚   â”‚   â”‚       â””â”€â”€ shoppingcart.jsx
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â””â”€â”€ ChatSignalRService.js
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â”œâ”€â”€ ChatTestRunner.js
â”‚   â”‚   â”‚   â”œâ”€â”€ FormatInfo.js
â”‚   â”‚   â”‚   â”œâ”€â”€ formatCurrency.js
â”‚   â”‚   â”‚   â”œâ”€â”€ timezoneTest.js
â”‚   â”‚   â”‚   â””â”€â”€ useDebounce.js
â”‚   â”‚   â”œâ”€â”€ App.js
â”‚   â”‚   â”œâ”€â”€ App.test.js
â”‚   â”‚   â”œâ”€â”€ AppRoutes.js
â”‚   â”‚   â”œâ”€â”€ index.js
â”‚   â”‚   â”œâ”€â”€ reportWebVitals.js
â”‚   â”‚   â”œâ”€â”€ service-worker.js
â”‚   â”‚   â”œâ”€â”€ serviceWorkerRegistration.js
â”‚   â”‚   â””â”€â”€ setupProxy.js
â”‚   â”œâ”€â”€ .env
â”‚   â”œâ”€â”€ .env.development
â”‚   â”œâ”€â”€ .env.development.local
â”‚   â”œâ”€â”€ .gitignore
â”‚   â”œâ”€â”€ IMPORT_ALIAS_GUIDE.md
â”‚   â”œâ”€â”€ README.md
â”‚   â”œâ”€â”€ SETUP_COMPLETE.md
â”‚   â”œâ”€â”€ aspnetcore-https.js
â”‚   â”œâ”€â”€ aspnetcore-react.js
â”‚   â”œâ”€â”€ craco.config.js
â”‚   â”œâ”€â”€ jsconfig.json
â”‚   â”œâ”€â”€ package-lock.json
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ postcss.config.js
â”‚   â””â”€â”€ tailwind.config.js
â”œâ”€â”€ Configuration/
â”‚   â””â”€â”€ CorsConfiguration.cs
â”œâ”€â”€ Controllers/
â”‚   â”œâ”€â”€ AddressController.cs
â”‚   â”œâ”€â”€ AuthController.cs
â”‚   â”œâ”€â”€ BlogPostsController.cs
â”‚   â”œâ”€â”€ BrandController.cs
â”‚   â”œâ”€â”€ CartController.cs
â”‚   â”œâ”€â”€ CategoriesController.cs
â”‚   â”œâ”€â”€ ChatController.cs
â”‚   â”œâ”€â”€ CorsTestController.cs
â”‚   â”œâ”€â”€ HomepageConfigController.cs
â”‚   â”œâ”€â”€ LoyaltyController.cs
â”‚   â”œâ”€â”€ OrderController.cs
â”‚   â”œâ”€â”€ PayPalController.cs
â”‚   â”œâ”€â”€ PaymentMethodController.cs
â”‚   â”œâ”€â”€ ProductsController.cs
â”‚   â”œâ”€â”€ ReviewsController.cs
â”‚   â”œâ”€â”€ RoleController.cs
â”‚   â”œâ”€â”€ SearchController.cs
â”‚   â”œâ”€â”€ SpecificationsController.cs
â”‚   â”œâ”€â”€ UploadController.cs
â”‚   â”œâ”€â”€ UserController.cs
â”‚   â”œâ”€â”€ VoucherController.cs
â”‚   â””â”€â”€ WeatherForecastController.cs
â”œâ”€â”€ DTOs/
â”‚   â”œâ”€â”€ AccountDto.cs
â”‚   â”œâ”€â”€ AddressDTO.cs
â”‚   â”œâ”€â”€ AdminMessageDto.cs
â”‚   â”œâ”€â”€ AdminUserUpdateDto.cs
â”‚   â”œâ”€â”€ BlogPostDto.cs
â”‚   â”œâ”€â”€ CartDto.cs
â”‚   â”œâ”€â”€ CategoryDto.cs
â”‚   â”œâ”€â”€ ChatDto.cs
â”‚   â”œâ”€â”€ CreateBlogPostDto.cs
â”‚   â”œâ”€â”€ CreateProductDto.cs
â”‚   â”œâ”€â”€ FlashSaleUpdateDto.cs
â”‚   â”œâ”€â”€ HeadphoneSpecificationDto.cs
â”‚   â”œâ”€â”€ HomepageDtos.cs
â”‚   â”œâ”€â”€ LaptopSpecificationDto.cs
â”‚   â”œâ”€â”€ LoyaltyStatusDto.cs
â”‚   â”œâ”€â”€ OrderDto.cs
â”‚   â”œâ”€â”€ PhoneSpecificationDto.cs
â”‚   â”œâ”€â”€ ProductDto.cs
â”‚   â”œâ”€â”€ ProductSpecificationDetailDto.cs
â”‚   â”œâ”€â”€ ProductSpecificationDto.cs
â”‚   â”œâ”€â”€ ReviewDto.cs
â”‚   â”œâ”€â”€ SearchDto.cs
â”‚   â”œâ”€â”€ UpdateBlogPostDto.cs
â”‚   â”œâ”€â”€ UploadResponseDto.cs
â”‚   â”œâ”€â”€ UserDto.cs
â”‚   â””â”€â”€ VoucherDto.cs
â”œâ”€â”€ Data/
â”‚   â”œâ”€â”€ AppDbContext.cs
â”‚   â””â”€â”€ WebsiteKnowledgeBase.json
â”œâ”€â”€ Docs/
â”‚   â”œâ”€â”€ AI_Architecture_Analysis.md
â”‚   â”œâ”€â”€ AI_Chat_Implementation_Status.md
â”‚   â”œâ”€â”€ AI_Chat_Operation_Manual.md
â”‚   â”œâ”€â”€ AI_Test_Cases.md
â”‚   â”œâ”€â”€ Fallback_Escalation_Logic.md
â”‚   â”œâ”€â”€ Project_Functionalities_Summary.md
â”‚   â”œâ”€â”€ Prompt_Templates_Flow.md
â”‚   â””â”€â”€ UX_UI_Optimization.md
â”œâ”€â”€ Hubs/
â”‚   â””â”€â”€ ChatHub.cs
â”œâ”€â”€ Middleware/
â”‚   â”œâ”€â”€ CorsDebugMiddleware.cs
â”‚   â”œâ”€â”€ GlobalCorsMiddleware.cs
â”‚   â”œâ”€â”€ HeaderLoggingMiddleware.cs
â”‚   â”œâ”€â”€ SignalRCorsMiddleware.cs
â”‚   â”œâ”€â”€ SignalRNegotiationCorsMiddleware.cs
â”‚   â”œâ”€â”€ SimpleRateLimitMiddleware.cs
â”‚   â””â”€â”€ UnifiedCorsMiddleware.cs
â”œâ”€â”€ Migrations/
â”‚   â””â”€â”€ AppDbContextModelSnapshot.cs
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ AIKnowledgeBase.cs
â”‚   â”œâ”€â”€ Address.cs
â”‚   â”œâ”€â”€ BlogPost.cs
â”‚   â”œâ”€â”€ Brand.cs
â”‚   â”œâ”€â”€ Cart.cs
â”‚   â”œâ”€â”€ CartItem.cs
â”‚   â”œâ”€â”€ Category.cs
â”‚   â”œâ”€â”€ ChatMessage.cs
â”‚   â”œâ”€â”€ ChatSession.cs
â”‚   â”œâ”€â”€ Delivery.cs
â”‚   â”œâ”€â”€ HomepageConfig.cs
â”‚   â”œâ”€â”€ Order.cs
â”‚   â”œâ”€â”€ OrderItem.cs
â”‚   â”œâ”€â”€ PaymentMethod.cs
â”‚   â”œâ”€â”€ ProductImages.cs
â”‚   â”œâ”€â”€ ProductSpecification.cs
â”‚   â”œâ”€â”€ ProductVariant.cs
â”‚   â”œâ”€â”€ Products.cs
â”‚   â”œâ”€â”€ Review.cs
â”‚   â”œâ”€â”€ Role.cs
â”‚   â”œâ”€â”€ User.cs
â”‚   â”œâ”€â”€ UserVoucher.cs
â”‚   â””â”€â”€ Voucher.cs
â”œâ”€â”€ Pages/
â”‚   â”œâ”€â”€ Admin/
â”‚   â”‚   â”œâ”€â”€ Blog.cshtml
â”‚   â”‚   â””â”€â”€ Blog.cshtml.cs
â”‚   â”œâ”€â”€ Error.cshtml
â”‚   â”œâ”€â”€ Error.cshtml.cs
â”‚   â””â”€â”€ _ViewImports.cshtml
â”œâ”€â”€ Properties/
â”‚   â””â”€â”€ launchSettings.json
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ AIService.cs
â”‚   â”œâ”€â”€ AIService_New.cs
â”‚   â”œâ”€â”€ ChatService.cs
â”‚   â”œâ”€â”€ CloudinaryService.cs
â”‚   â”œâ”€â”€ ContextManager.cs
â”‚   â”œâ”€â”€ DatabaseSeeder.cs
â”‚   â”œâ”€â”€ EmailService.cs
â”‚   â”œâ”€â”€ GeminiService.cs
â”‚   â”œâ”€â”€ ICloudinaryService.cs
â”‚   â”œâ”€â”€ JwtService.cs
â”‚   â”œâ”€â”€ KnowledgeBaseSeeder.cs
â”‚   â”œâ”€â”€ KnowledgeExportService.cs
â”‚   â”œâ”€â”€ MoMoPaymentService.cs
â”‚   â”œâ”€â”€ PayPalService.cs
â”‚   â””â”€â”€ UserService.cs
â”œâ”€â”€ bin/
â”œâ”€â”€ obj/
â”œâ”€â”€ wwwroot/
â”‚   â”œâ”€â”€ 638777289693476398_FB_IMG_1555386600216.jpg
â”‚   â”œâ”€â”€ 638777301336393535_iphone_16_pro_max_desert_titan_3552a28ae0.png
â”‚   â”œâ”€â”€ 638777308153943069_FB_IMG_1555386600216.jpg
â”‚   â”œâ”€â”€ 638781973986999931_iphone_16_pro_max_desert_titan_3552a28ae0.png
â”‚   â”œâ”€â”€ 638782724359458464_Screenshot 2024-12-14 110409.png
â”‚   â”œâ”€â”€ 638785860496963266_iphone-16-pro-max-titan-tu-nhien_2.webp
â”‚   â”œâ”€â”€ 638786227099043452_nappa.jpg
â”‚   â”œâ”€â”€ 638787272129082719_JAY_2020.jpg
â”‚   â”œâ”€â”€ 638787272807398721_JAY_2055.jpg
â”‚   â”œâ”€â”€ 638787272833945420_JAY_2055.jpg
â”‚   â”œâ”€â”€ 638787272897870762_JAY_2055.jpg
â”‚   â”œâ”€â”€ 638787273014418338_JAY_2046.jpg
â”‚   â”œâ”€â”€ 638787273063720114_JAY_2046.jpg
â”‚   â”œâ”€â”€ 638787273194311800_JAY_2055.jpg
â”‚   â”œâ”€â”€ 638787273230303421_JAY_2055.jpg
â”‚   â”œâ”€â”€ 638788272033742183_dell_xps_13_9350_xam_1_adcc33cd57.jpg
â”‚   â”œâ”€â”€ 638788276476562956_dell_xps_13_9350_xam_1_adcc33cd57.jpg
â”‚   â”œâ”€â”€ 638788288762590589_tai_nghe_chup_tai_gaming_sony_inzone_h3_dd_cd6ab0d099.jpg
â”‚   â”œâ”€â”€ 638789596878470228_iphone_16_pro_max_desert_titan_3552a28ae0.png
â”‚   â”œâ”€â”€ 638789600041707668_iphone_16_pro_max_desert_titan_3552a28ae0.png
â”‚   â”œâ”€â”€ 638789608324917318_SonyWH-1000XM5.jpg
â”‚   â”œâ”€â”€ 638789613041488955_SonyWH-1000XM5.jpg
â”‚   â”œâ”€â”€ 638789696909576202_Screenshot 2024-02-29 215741.png
â”‚   â”œâ”€â”€ 638792361638664844_JAY_2055.jpg
â”‚   â””â”€â”€ 638832540143370150_596c5b52-9dd0-4544-840e-e895e2e6bcbd.jpg
â”œâ”€â”€ .gitignore
â”œâ”€â”€ .hintrc
â”œâ”€â”€ CORS_CONFIGURATION.md
â”œâ”€â”€ CORS_SOLUTION_SUMMARY.md
â”œâ”€â”€ CORS_TESTING.md
â”œâ”€â”€ Program.cs
â”œâ”€â”€ SHN-Gear.csproj
â”œâ”€â”€ SHNGear.sln
â”œâ”€â”€ WeatherForecast.cs
â”œâ”€â”€ appsettings.Development.json
â”œâ”€â”€ appsettings.json
â”œâ”€â”€ appsettings.ratelimit.json
â”œâ”€â”€ package.json
â””â”€â”€ tailwind.config.js
```

## FILE CONTENTS

### Program.cs
```cs
using Microsoft.Extensions.FileProviders;
using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.IdentityModel.Tokens;
using System.Text;
using SHN_Gear.Data;
using System.Text.Json.Serialization;
using CloudinaryDotNet;
using SHN_Gear.Services;
using Microsoft.OpenApi.Models;
using SHN_Gear.Middleware;
using SHN_Gear.Configuration;
// using SHN_Gear.Export; // KnowledgeExportService náº±m trong SHN_Gear.Services, khÃ´ng cáº§n dÃ²ng nÃ y

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddMemoryCache();

// ğŸ”¹ Káº¿t ná»‘i SQL Server
builder.Services.AddDbContext<AppDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection"),
    sqlOptions => sqlOptions.UseQuerySplittingBehavior(QuerySplittingBehavior.SplitQuery)));

// ğŸ”¹ Session
builder.Services.AddDistributedMemoryCache();
builder.Services.AddSession(options =>
{
    options.IdleTimeout = TimeSpan.FromMinutes(30);
    options.Cookie.HttpOnly = true;
    options.Cookie.IsEssential = true;
});

// ğŸ”¹ CÃ¡c dá»‹ch vá»¥
builder.Services.AddScoped<UserService>();
builder.Services.AddScoped<EmailService>();
builder.Services.AddSingleton<PayPalService>();
builder.Services.AddScoped<MoMoPaymentService>();

// ğŸ”¹ Chat & AI Services
builder.Services.AddScoped<ContextManager>();
// builder.Services.AddScoped<AIService>(); // Táº¡m thá»i vÃ´ hiá»‡u hÃ³a AI

// ÄÄƒng kÃ½ KnowledgeExportService Ä‘á»ƒ export tri thá»©c tá»« DB
// Ensure KnowledgeExportService exists in your project and the correct namespace is used above.
// If it does not exist, comment out or remove the following line:
// builder.Services.AddScoped<KnowledgeExportService>();
builder.Services.AddScoped<KnowledgeExportService>();
builder.Services.AddScoped<ChatService>();
builder.Services.AddScoped<DatabaseSeeder>();

// ğŸ”¹ HttpClient for external API calls
builder.Services.AddHttpClient<GeminiService>();
builder.Services.AddMemoryCache();

// ğŸ”¹ SignalR for real-time chat
builder.Services.AddSignalR(options =>
{
    options.EnableDetailedErrors = true;
}).AddJsonProtocol(options =>
{
    options.PayloadSerializerOptions.ReferenceHandler = ReferenceHandler.IgnoreCycles;
});

// ğŸ”¹ JWT Authentication
var jwtKey = builder.Configuration["Jwt:Key"] ?? throw new InvalidOperationException("JWT Key not configured");
var key = Encoding.UTF8.GetBytes(jwtKey);
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = builder.Configuration["Jwt:Issuer"],
            ValidAudience = builder.Configuration["Jwt:Audience"],
            IssuerSigningKey = new SymmetricSecurityKey(key),
            RoleClaimType = System.Security.Claims.ClaimTypes.Role
        };


        // Configure for SignalR
        options.Events = new JwtBearerEvents
        {
            OnMessageReceived = context =>
            {
                var accessToken = context.Request.Query["access_token"];
                var path = context.HttpContext.Request.Path;

                // If the request is for our hub and there's a token, use it
                if (!string.IsNullOrEmpty(accessToken) && path.StartsWithSegments("/chatHub"))
                {
                    context.Token = accessToken;
                }

                return Task.CompletedTask;
            }
        };
    });

// ğŸ”¹ CORS Configuration
builder.Services.ConfigureCors(builder.Environment);

// ğŸ”¹ Swagger + JWT Support
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new OpenApiInfo { Title = "SHN_Gear API", Version = "v1" });

    c.AddSecurityDefinition("Bearer", new OpenApiSecurityScheme
    {
        Description = "Nháº­p token theo Ä‘á»‹nh dáº¡ng: Bearer {token}",
        Name = "Authorization",
        In = ParameterLocation.Header,
        Type = SecuritySchemeType.Http,
        Scheme = "Bearer",
        BearerFormat = "JWT"
    });

    c.AddSecurityRequirement(new OpenApiSecurityRequirement
    {
        {
            new OpenApiSecurityScheme
            {
                Reference = new OpenApiReference
                {
                    Type = ReferenceType.SecurityScheme,
                    Id = "Bearer"
                }
            },
            Array.Empty<string>()
        }
    });
});

// ğŸ”¹ JSON vÃ²ng láº·p
builder.Services.AddControllersWithViews()
    .AddJsonOptions(options =>
    {
        options.JsonSerializerOptions.ReferenceHandler = ReferenceHandler.IgnoreCycles;
        // Ensure UTC DateTimes are serialized with 'Z' suffix for proper timezone handling
        options.JsonSerializerOptions.WriteIndented = false;
        // Default converter will serialize DateTime as ISO 8601 with 'Z' for UTC
    });

builder.Services.AddHttpContextAccessor();

var app = builder.Build();

// ğŸ”¹ Unified CORS Middleware - handles ALL CORS scenarios in one place
app.UseMiddleware<UnifiedCorsMiddleware>();

// ğŸ”¹ CORS Debug Middleware (development only)
if (app.Environment.IsDevelopment())
{
    app.UseMiddleware<HeaderLoggingMiddleware>();
    app.UseMiddleware<CorsDebugMiddleware>();
}

// ThÃªm middleware rate limit Ä‘Æ¡n giáº£n cho API Gemini/chat
app.UseMiddleware<SimpleRateLimitMiddleware>();

// ğŸ”¹ Middlewares (Ä‘Ãºng thá»© tá»±)
if (!app.Environment.IsDevelopment())
{
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();

app.UseRouting();

// ğŸ”¹ CORS Configuration
app.UseCorsConfiguration();

app.UseAuthentication();
app.UseAuthorization();

app.UseSession();

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}



// Tá»± Ä‘á»™ng export tri thá»©c website ra file JSON khi khá»Ÿi Ä‘á»™ng (Ä‘á»“ng bá»™, Ä‘áº£m báº£o cháº¯c cháº¯n export xong trÆ°á»›c khi app cháº¡y)
try
{
    using (var scope = app.Services.CreateScope())
    {
        var exportService = scope.ServiceProvider.GetService<KnowledgeExportService>();
        if (exportService != null)
        {
            // Äáº£m báº£o export ra Ä‘Ãºng thÆ° má»¥c Data á»Ÿ gá»‘c project
            var projectRoot = AppContext.BaseDirectory;
            while (!string.IsNullOrEmpty(projectRoot) && !File.Exists(Path.Combine(projectRoot, "SHNGear.sln")))
            {
                projectRoot = Directory.GetParent(projectRoot)?.FullName ?? "";
            }
            var dataDir = Path.Combine(projectRoot, "Data");
            if (!Directory.Exists(dataDir)) Directory.CreateDirectory(dataDir);
            var knowledgePath = Path.Combine(dataDir, "WebsiteKnowledgeBase.json");
            exportService.ExportWebsiteKnowledgeBaseAsync(knowledgePath).GetAwaiter().GetResult();
            Console.WriteLine($"[KnowledgeExport] Exported tri thá»©c website ra {knowledgePath}");
        }
    }
}
catch (Exception ex)
{
    Console.WriteLine($"[KnowledgeExport] Export failed: {ex.Message}");
}

app.MapControllers();
app.MapControllerRoute(
    name: "default",
    pattern: "{controller}/{action=Index}/{id?}");

// ğŸ”¹ Map SignalR Hub vá»›i CORS policy riÃªng
app.MapHub<SHN_Gear.Hubs.ChatHub>("/chatHub").RequireCors("SignalRPolicy");

app.MapFallbackToFile("index.html");

// ğŸ”¹ Seed database on startup if requested
if (args.Contains("--seed-data"))
{
    using (var scope = app.Services.CreateScope())
    {
        var seeder = scope.ServiceProvider.GetRequiredService<DatabaseSeeder>();
        await seeder.SeedAsync();
        Console.WriteLine("Database seeding completed!");
        return;
    }
}

app.Run();

```

### tailwind.config.js
```js
module.exports = {
    content: ["./src/**/*.{js,jsx,ts,tsx}"],
    theme: {
      extend: {},
    },
    plugins: [require("tailwindcss-animate")],
  };
  
```

### WeatherForecast.cs
```cs
namespace SHN_Gear;

public class WeatherForecast
{
    public DateOnly Date { get; set; }

    public int TemperatureC { get; set; }

    public int TemperatureF => 32 + (int)(TemperatureC / 0.5556);

    public string? Summary { get; set; }
}

```

### ClientApp\aspnetcore-https.js
```js
// This script sets up HTTPS for the application using the ASP.NET Core HTTPS certificate
const fs = require('fs');
const spawn = require('child_process').spawn;
const path = require('path');

const baseFolder =
  process.env.APPDATA !== undefined && process.env.APPDATA !== ''
    ? `${process.env.APPDATA}/ASP.NET/https`
    : `${process.env.HOME}/.aspnet/https`;

const certificateArg = process.argv.map(arg => arg.match(/--name=(?<value>.+)/i)).filter(Boolean)[0];
const certificateName = certificateArg ? certificateArg.groups.value : process.env.npm_package_name;

if (!certificateName) {
  console.error('Invalid certificate name. Run this script in the context of an npm/yarn script or pass --name=<<app>> explicitly.')
  process.exit(-1);
}

const certFilePath = path.join(baseFolder, `${certificateName}.pem`);
const keyFilePath = path.join(baseFolder, `${certificateName}.key`);

if (!fs.existsSync(certFilePath) || !fs.existsSync(keyFilePath)) {
  spawn('dotnet', [
    'dev-certs',
    'https',
    '--export-path',
    certFilePath,
    '--format',
    'Pem',
    '--no-password',
  ], { stdio: 'inherit', })
  .on('exit', (code) => process.exit(code));
}

```

### ClientApp\aspnetcore-react.js
```js
// This script configures the .env.development.local file with additional environment variables to configure HTTPS using the ASP.NET Core
// development certificate in the webpack development proxy.

const fs = require('fs');
const path = require('path');

const baseFolder =
  process.env.APPDATA !== undefined && process.env.APPDATA !== ''
    ? `${process.env.APPDATA}/ASP.NET/https`
    : `${process.env.HOME}/.aspnet/https`;

const certificateArg = process.argv.map(arg => arg.match(/--name=(?<value>.+)/i)).filter(Boolean)[0];
const certificateName = certificateArg ? certificateArg.groups.value : process.env.npm_package_name;

if (!certificateName) {
  console.error('Invalid certificate name. Run this script in the context of an npm/yarn script or pass --name=<<app>> explicitly.')
  process.exit(-1);
}

const certFilePath = path.join(baseFolder, `${certificateName}.pem`);
const keyFilePath = path.join(baseFolder, `${certificateName}.key`);

if (!fs.existsSync('.env.development.local')) {
  fs.writeFileSync(
    '.env.development.local',
`SSL_CRT_FILE=${certFilePath}
SSL_KEY_FILE=${keyFilePath}`
  );
} else {
  let lines = fs.readFileSync('.env.development.local')
    .toString()
    .split('\n');

  let hasCert, hasCertKey = false;
  for (const line of lines) {
    if (/SSL_CRT_FILE=.*/i.test(line)) {
      hasCert = true;
    }
    if (/SSL_KEY_FILE=.*/i.test(line)) {
      hasCertKey = true;
    }
  }
  if (!hasCert) {
    fs.appendFileSync(
      '.env.development.local',
      `\nSSL_CRT_FILE=${certFilePath}`
    );
  }
  if (!hasCertKey) {
    fs.appendFileSync(
      '.env.development.local',
      `\nSSL_KEY_FILE=${keyFilePath}`
    );
  }
}

```

### ClientApp\craco.config.js
```js
const path = require("path");

module.exports = {
  webpack: {
    alias: {
      "@": path.resolve(__dirname, "src"),
      "@/components": path.resolve(__dirname, "src/components"),
      "@/pages": path.resolve(__dirname, "src/pages"),
      "@/utils": path.resolve(__dirname, "src/utils"),
      "@/services": path.resolve(__dirname, "src/services"),
      "@/assets": path.resolve(__dirname, "src/assets"),
      "@/styles": path.resolve(__dirname, "src/assets/styles"),
      "@/contexts": path.resolve(__dirname, "src/contexts"),
      "@/hooks": path.resolve(__dirname, "src/hook"),
      "@/config": path.resolve(__dirname, "src/config"),
    },
  },
  jest: {
    configure: {
      moduleNameMapping: {
        "^@/(.*)$": "<rootDir>/src/$1",
        "^@/components/(.*)$": "<rootDir>/src/components/$1",
        "^@/pages/(.*)$": "<rootDir>/src/pages/$1",
        "^@/utils/(.*)$": "<rootDir>/src/utils/$1",
        "^@/services/(.*)$": "<rootDir>/src/services/$1",
        "^@/assets/(.*)$": "<rootDir>/src/assets/$1",
        "^@/styles/(.*)$": "<rootDir>/src/assets/styles/$1",
        "^@/contexts/(.*)$": "<rootDir>/src/contexts/$1",
        "^@/hooks/(.*)$": "<rootDir>/src/hook/$1",
        "^@/config/(.*)$": "<rootDir>/src/config/$1",
      },
    },
  },
};

```

### ClientApp\postcss.config.js
```js
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};

```

### ClientApp\tailwind.config.js
```js
const { fontFamily } = require('tailwindcss/defaultTheme');

module.exports = {
  content: [
    "./src/**/*.{html,js,jsx,ts,tsx}",
    "./public/index.html",
  ],
  theme: {
    extend: {
      colors: {
        'primary-dark': '#121212',
        'electric-blue': '#00BFFF',
        'neon-magenta': '#FF00FF',
        'light-gray': '#A0A0A0',
      },
      fontFamily: {
        sans: ['Inter', ...fontFamily.sans],
        display: ['"Monument Extended"', ...fontFamily.sans],
      },
      borderColor: {
        'white-20': 'rgba(255, 255, 255, 0.2)',
      },
      scale: {
        '102': '1.02',
        '105': '1.05',
      },
      boxShadow: {
        'neon-blue': '0 0 15px rgba(0, 191, 255, 0.6)',
        'neon-magenta': '0 0 15px rgba(255, 0, 255, 0.6)',
      },
    },
  },
  plugins: [require('flowbite/plugin')],
};

```

### ClientApp\scripts\convert-imports.js
```js
#!/usr/bin/env node

/**
 * Script Ä‘á»ƒ chuyá»ƒn Ä‘á»•i relative imports thÃ nh alias imports
 * Sá»­ dá»¥ng: node convert-imports.js [file-path]
 */

const fs = require("fs");
const path = require("path");

// Mapping cá»§a cÃ¡c alias
const ALIAS_MAPPINGS = {
  components: "@/components",
  pages: "@/pages",
  utils: "@/utils",
  services: "@/services",
  assets: "@/assets",
  contexts: "@/contexts",
  hook: "@/hooks",
  config: "@/config",
};

function convertImports(filePath) {
  if (!fs.existsSync(filePath)) {
    console.error(`File khÃ´ng tá»“n táº¡i: ${filePath}`);
    return;
  }

  let content = fs.readFileSync(filePath, "utf8");
  const originalContent = content;

  // Regex Ä‘á»ƒ tÃ¬m cÃ¡c import statements
  const importRegex = /import\s+(?:[\w\s{},*]+\s+from\s+)?['"]([^'"]+)['"]/g;

  content = content.replace(importRegex, (match, importPath) => {
    // Bá» qua náº¿u khÃ´ng pháº£i relative import
    if (!importPath.startsWith(".")) {
      return match;
    }

    // Chuyá»ƒn Ä‘á»•i relative path thÃ nh absolute path
    const currentDir = path.dirname(filePath);
    const resolvedPath = path.resolve(currentDir, importPath);
    const srcDir = path.resolve(
      path.dirname(filePath),
      "../".repeat(importPath.split("../").length - 1)
    );

    // TÃ­nh relative path tá»« src directory
    let relativePath = path.relative(srcDir, resolvedPath);

    // Chuáº©n hÃ³a path separators cho Windows
    relativePath = relativePath.replace(/\\/g, "/");

    // TÃ¬m alias phÃ¹ há»£p
    for (const [folder, alias] of Object.entries(ALIAS_MAPPINGS)) {
      if (relativePath.startsWith(folder + "/") || relativePath === folder) {
        const newPath = relativePath.replace(new RegExp(`^${folder}`), alias);
        return match.replace(importPath, newPath);
      }
    }

    // Náº¿u khÃ´ng tÃ¬m tháº¥y alias phÃ¹ há»£p, sá»­ dá»¥ng @ root
    if (!relativePath.startsWith("@")) {
      const newPath = "@/" + relativePath;
      return match.replace(importPath, newPath);
    }

    return match;
  });

  // Chá»‰ ghi file náº¿u cÃ³ thay Ä‘á»•i
  if (content !== originalContent) {
    fs.writeFileSync(filePath, content, "utf8");
    console.log(`âœ… ÄÃ£ cáº­p nháº­t: ${filePath}`);
  } else {
    console.log(`â­ï¸  KhÃ´ng cÃ³ thay Ä‘á»•i: ${filePath}`);
  }
}

function convertDirectory(dirPath) {
  if (!fs.existsSync(dirPath)) {
    console.error(`ThÆ° má»¥c khÃ´ng tá»“n táº¡i: ${dirPath}`);
    return;
  }

  const files = fs.readdirSync(dirPath);

  files.forEach((file) => {
    const fullPath = path.join(dirPath, file);
    const stat = fs.statSync(fullPath);

    if (
      stat.isDirectory() &&
      !file.startsWith(".") &&
      file !== "node_modules"
    ) {
      convertDirectory(fullPath);
    } else if (
      stat.isFile() &&
      (file.endsWith(".js") ||
        file.endsWith(".jsx") ||
        file.endsWith(".ts") ||
        file.endsWith(".tsx"))
    ) {
      convertImports(fullPath);
    }
  });
}

// Main execution
const targetPath = process.argv[2];

if (!targetPath) {
  console.log(
    "Sá»­ dá»¥ng: node convert-imports.js [file-path hoáº·c directory-path]"
  );
  process.exit(1);
}

const resolvedPath = path.resolve(targetPath);

if (fs.statSync(resolvedPath).isDirectory()) {
  console.log(`ğŸ”„ Chuyá»ƒn Ä‘á»•i táº¥t cáº£ files trong thÆ° má»¥c: ${resolvedPath}`);
  convertDirectory(resolvedPath);
} else {
  console.log(`ğŸ”„ Chuyá»ƒn Ä‘á»•i file: ${resolvedPath}`);
  convertImports(resolvedPath);
}

console.log("âœ¨ HoÃ n thÃ nh!");

```

### ClientApp\src\App.js
```js
import React, { Component, useEffect } from "react";
import { useAuthContext } from "@/hooks/auth/useAuth";
import SessionExpiredModal from "@/components/SessionExpiredModal";
import { Route, Routes, Navigate, useLocation } from "react-router-dom";
import AppRoutes from "./AppRoutes";
import AdminLayout from "@/components/layouts/AdminLayout"; // Add this line back
import DefaultLayout from "@/components/layouts/DefaultLayout";
import ProductPage from "@/pages/ProductPage/ProductPage";
import ProfilePage from "@/pages/ProfilePage/ProfilePage";
import ProfileInfo from "@/components/Profile/ProfileInfo";
import AddressBook from "@/components/Profile/AddressBook";
import UserOrders from "@/components/Profile/UserOrders";
import LoyaltyProgram from "@/components/Profile/LoyaltyProgram";
import ProductList from "@/pages/ProductList/ProductList";
import Shoppingcart from "@/pages/shoppingcart/shoppingcart";
import Checkout from "@/components/Checkout/Checkout";
import PaymentSuccess from "@/components/PaymentSuccess/PaymentSuccess";
// import OrderLookup from "@/components/Order/OrderLookup";
import ComparePage from "@/components/CompareProduct/ComparePage";
import Unauthorized from "@/pages/Unauthorized/Unauthorized";
import { jwtDecode } from "jwt-decode";

// Import Chat Components
import ChatWidget from "@/components/Chat/ChatWidget";
import AdminChatDashboard from "@/components/Chat/AdminChatDashboard";

// Protected Route Component - PhiÃªn báº£n tá»‘i Æ°u
const ProtectedRoute = ({ children, adminOnly = false }) => {
  const token = localStorage.getItem("token");

  if (!token) {
    return <Navigate to="/" replace />;
  }

  try {
    const decoded = jwtDecode(token);
    const isAdmin = decoded.roleId === "1"; // So sÃ¡nh trá»±c tiáº¿p vá»›i string "1"

    // Náº¿u route yÃªu cáº§u admin mÃ  user khÃ´ng pháº£i admin
    if (adminOnly && !isAdmin) {
      return <Navigate to="/unauthorized" replace />;
    }

    return children;
  } catch (error) {
    console.error("Token error:", error);
    localStorage.removeItem("token"); // Clear token invalid
    return <Navigate to="/" replace />;
  }
};

// Component to conditionally render ChatWidget
const ConditionalChatWidget = () => {
  const location = useLocation();
  const isAdminPage = location.pathname.startsWith("/admin");

  // Don't show ChatWidget on admin pages
  if (isAdminPage) {
    return null;
  }

  return <ChatWidget />;
};

// Functional App component Ä‘á»ƒ dÃ¹ng hook
const App = () => {
  const { sessionExpired, logout } = useAuthContext();
  const location = useLocation();

  useEffect(() => {
    if (sessionExpired) {
      logout();
    }
  }, [sessionExpired, logout]);

  const handleLoginRedirect = () => {
    window.location.href = "/"; // hoáº·c chuyá»ƒn hÆ°á»›ng Ä‘áº¿n trang Ä‘Äƒng nháº­p náº¿u cÃ³
  };

  return (
    <>
      <SessionExpiredModal open={sessionExpired} onLogin={handleLoginRedirect} />
      <Routes>
        {/* CÃ¡c route Ä‘áº·c biá»‡t khÃ´ng cáº§n báº£o vá»‡ */}
        <Route path="/checkout" element={<DefaultLayout><Checkout /></DefaultLayout>} />
        <Route path="/shoppingcart" element={<DefaultLayout><Shoppingcart /></DefaultLayout>} />
        <Route path="/productlist" element={<DefaultLayout><ProductList /></DefaultLayout>} />
        <Route path="/profile" element={<DefaultLayout><ProfilePage /></DefaultLayout>} />
        <Route path="/product/:id" element={<DefaultLayout><ProductPage /></DefaultLayout>} />
        <Route path="/unauthorized" element={<DefaultLayout><Unauthorized /></DefaultLayout>} />
        <Route path="/payment-success" element={<DefaultLayout><PaymentSuccess /></DefaultLayout>} />
        <Route path="/order-lookup" element={<DefaultLayout><React.Suspense fallback={<div>Äang táº£i trang tra cá»©u Ä‘Æ¡n hÃ ng...</div>}>
          {React.createElement(require("@/pages/OrderLookupPage/OrderLookupPage.jsx").default)}
        </React.Suspense></DefaultLayout>} />
        <Route path="/compare" element={<DefaultLayout><ComparePage /></DefaultLayout>} />

        {/* Admin Chat Dashboard Route */}
        <Route
          path="/admin/chat"
          element={
            <ProtectedRoute adminOnly={true}>
              <AdminLayout>
                <AdminChatDashboard />
              </AdminLayout>
            </ProtectedRoute>
          }
        />

        {/* Protected Profile routes */}
        <Route
          path="/profile"
          element={
            <ProtectedRoute>
              <ProfilePage />
            </ProtectedRoute>
          }
        >
          <Route index element={<ProfileInfo />} />
          <Route path="info" element={<ProfileInfo />} />
          <Route path="address" element={<AddressBook />} />
          <Route path="orders" element={<UserOrders />} />
          <Route path="loyalty" element={<LoyaltyProgram />} />
        </Route>
        {/* Xá»­ lÃ½ cÃ¡c route tá»« AppRoutes */}
        {AppRoutes.map((route) => {
          const isAdminRoute = route.path?.startsWith("/admin");

          return (
            <Route
              key={route.path}
              path={route.path}
              element={
                isAdminRoute ? (
                  <ProtectedRoute adminOnly={true}>
                    <AdminLayout>{route.element}</AdminLayout>
                  </ProtectedRoute>
                ) : (
                  <DefaultLayout>{route.element}</DefaultLayout>
                )
              }
            />
          );
        })}
      </Routes>

      {/* Chat Widget - áº©n trÃªn cÃ¡c trang admin */}
      <ConditionalChatWidget />
    </>
  );
};

export default App;

```

### ClientApp\src\App.test.js
```js
import React from 'react';
import { createRoot } from 'react-dom/client';
import { MemoryRouter } from 'react-router-dom';
import App from './App';

it('renders without crashing', async () => {
  const div = document.createElement('div');
  const root = createRoot(div);
  root.render(
    <MemoryRouter>
      <App />
    </MemoryRouter>);
  await new Promise(resolve => setTimeout(resolve, 1000));
});

```

### ClientApp\src\AppRoutes.js
```js
import HomePage from "@/pages/Home/HomePage";
import OverviewPage from "@/pages/Admin/OverviewPage";
import ProductsPage from "@/pages/Admin/ProductsPage";
import UsersPage from "@/pages/Admin/UsersPage";
import SalesPage from "@/pages/Admin/SalesPage";
import OrdersPage from "@/pages/Admin/OrdersPage";
import AnalyticsPage from "@/pages/Admin/AnalyticsPage";
import HomepageAdminPage from "@/pages/Admin/HomepageAdminPage";
import CategoryAdminPage from "@/pages/Admin/CategoryAdminPage";
import FlashSaleAdminPage from "@/pages/Admin/FlashSaleAdminPage";
import HomepageOverviewPage from "@/pages/Admin/HomepageOverviewPage";
import SettingsPage from "@/pages/Admin/SettingsPage";
import ProductPage from "@/pages/ProductPage/ProductPage";
import ProfilePage from "@/pages/ProfilePage/ProfilePage";
import ProductList from "@/pages/ProductList/ProductList";
import Shoppingcart from "@/pages/shoppingcart/shoppingcart";
import Unauthorized from "@/pages/Unauthorized/Unauthorized";
import BestSellerAdminPage from "@/pages/Admin/BestSellerAdminPage";
import ReviewManagementPage from "@/pages/Admin/ReviewManagementPage";
import BlogList from "@/pages/blog/BlogList";
import BlogPostDetail from "@/pages/blog/BlogPostDetail";
import BlogPostEditor from "@/pages/blog/BlogPostEditor";

const AppRoutes = [
  {
    path: "/admin/reviews",
    element: <ReviewManagementPage />,
    requiresAdmin: true,
  },
  // Blog routes
  {
    path: "/blog",
    element: <BlogList />,
  },
  {
    path: "/blog/:id",
    element: <BlogPostDetail />,
  },
  {
    path: "/admin/blog",
    element: <BlogList />,
    requiresAdmin: true,
  },
  {
    path: "/admin/blog/new",
    element: <BlogPostEditor />,
    requiresAdmin: true,
  },
  {
    path: "/admin/blog/edit/:id",
    element: <BlogPostEditor />,
    requiresAdmin: true,
  },
  {
    path: "/admin/best-sellers",
    element: <BestSellerAdminPage />,
    requiresAdmin: true,
  },
  {
    path: "/",
    element: <HomePage />,
  },
  // Admin routes - will be protected by ProtectedRoute
  {
    path: "/admin/overview",
    element: <OverviewPage />,
    requiresAdmin: true,
  },
  {
    path: "/admin/products",
    element: <ProductsPage />,
    requiresAdmin: true,
  },
  {
    path: "/admin/users",
    element: <UsersPage />,
    requiresAdmin: true,
  },
  {
    path: "/admin/sales",
    element: <SalesPage />,
    requiresAdmin: true,
  },
  {
    path: "/admin/orders",
    element: <OrdersPage />,
    requiresAdmin: true,
  },
  {
    path: "/admin/analytics",
    element: <AnalyticsPage />,
    requiresAdmin: true,
  },
  {
    path: "/admin/settings",
    element: <SettingsPage />,
    requiresAdmin: true,
  },
  {
    path: "/admin/homepage",
    element: <HomepageAdminPage />,
    requiresAdmin: true,
  },
  {
    path: "/admin/categories",
    element: <CategoryAdminPage />,
    requiresAdmin: true,
  },
  {
    path: "/admin/flash-sale",
    element: <FlashSaleAdminPage />,
    requiresAdmin: true,
  },
  {
    path: "/admin/homepage-dashboard",
    element: <HomepageOverviewPage />,
    requiresAdmin: true,
  },
  // Public routes
  {
    path: "/ProductPage/",
    element: <ProductPage />,
  },
  {
    path: "/Profile/",
    element: <ProfilePage />,
  },
  {
    path: "/productlist/",
    element: <ProductList />,
  },
  {
    path: "/shoppingcart/",
    element: <Shoppingcart />,
  },
  {
    path: "/unauthorized",
    element: <Unauthorized />,
  },
];

export default AppRoutes;

```

### ClientApp\src\index.js
```js
import "bootstrap/dist/css/bootstrap.css";
import React from "react";
import { createRoot } from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import App from "./App";
import { AuthProvider } from "@/hooks/auth/useAuth";
import * as serviceWorkerRegistration from "./serviceWorkerRegistration";
import reportWebVitals from "./reportWebVitals";
import "./assets/styles/base.css";
const baseUrl = document.getElementsByTagName("base")[0].getAttribute("href");
const rootElement = document.getElementById("root");
const root = createRoot(rootElement);

root.render(
  <BrowserRouter basename={baseUrl}>
    <AuthProvider>
      <App />
    </AuthProvider>
  </BrowserRouter>
);

// If you want your app to work offline and load faster, you can change
// unregister() to register() below. Note this comes with some pitfalls.
// Learn more about service workers: https://cra.link/PWA
serviceWorkerRegistration.unregister();

// If you want to start measuring performance in your app, pass a function
// to log results (for example: reportWebVitals(console.log))
// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals
reportWebVitals();

```

### ClientApp\src\reportWebVitals.js
```js
const reportWebVitals = (onPerfEntry) => {
  if (onPerfEntry && onPerfEntry instanceof Function) {
    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {
      getCLS(onPerfEntry);
      getFID(onPerfEntry);
      getFCP(onPerfEntry);
      getLCP(onPerfEntry);
      getTTFB(onPerfEntry);
    });
  }
};

export default reportWebVitals;

```

### ClientApp\src\service-worker.js
```js
/* eslint-disable no-restricted-globals */

// This service worker can be customized!
// See https://developers.google.com/web/tools/workbox/modules
// for the list of available Workbox modules, or add any other
// code you'd like.
// You can also remove this file if you'd prefer not to use a
// service worker, and the Workbox build step will be skipped.

import { clientsClaim } from 'workbox-core';
import { ExpirationPlugin } from 'workbox-expiration';
import { precacheAndRoute, createHandlerBoundToURL } from 'workbox-precaching';
import { registerRoute } from 'workbox-routing';
import { StaleWhileRevalidate } from 'workbox-strategies';

clientsClaim();

// Precache all of the assets generated by your build process.
// Their URLs are injected into the manifest variable below.
// This variable must be present somewhere in your service worker file,
// even if you decide not to use precaching. See https://cra.link/PWA
precacheAndRoute(self.__WB_MANIFEST);

// Set up App Shell-style routing, so that all navigation requests
// are fulfilled with your index.html shell. Learn more at
// https://developers.google.com/web/fundamentals/architecture/app-shell
const fileExtensionRegexp = new RegExp('/[^/?]+\\.[^/]+$');
registerRoute(
  // Return false to exempt requests from being fulfilled by index.html.
  ({ request, url }) => {
    // If this isn't a navigation, skip.
    if (request.mode !== 'navigate') {
      return false;
    } // If this is a URL that starts with /_, skip.

    if (url.pathname.startsWith('/_')) {
      return false;
    } // If this looks like a URL for a resource, because it contains // a file extension, skip.

    if (url.pathname.match(fileExtensionRegexp)) {
      return false;
    } // Return true to signal that we want to use the handler.

    return true;
  },
  createHandlerBoundToURL(process.env.PUBLIC_URL + '/index.html')
);

// An example runtime caching route for requests that aren't handled by the
// precache, in this case same-origin .png requests like those from in public/
registerRoute(
  // Add in any other file extensions or routing criteria as needed.
  ({ url }) => url.origin === self.location.origin && url.pathname.endsWith('.png'), // Customize this strategy as needed, e.g., by changing to CacheFirst.
  new StaleWhileRevalidate({
    cacheName: 'images',
    plugins: [
      // Ensure that once this runtime cache reaches a maximum size the
      // least-recently used images are removed.
      new ExpirationPlugin({ maxEntries: 50 }),
    ],
  })
);

// This allows the web app to trigger skipWaiting via
// registration.waiting.postMessage({type: 'SKIP_WAITING'})
self.addEventListener('message', (event) => {
  if (event.data && event.data.type === 'SKIP_WAITING') {
    self.skipWaiting();
  }
});

// Any other custom service worker logic can go here.

```

### ClientApp\src\serviceWorkerRegistration.js
```js
// This optional code is used to register a service worker.
// register() is not called by default.

// This lets the app load faster on subsequent visits in production, and gives
// it offline capabilities. However, it also means that developers (and users)
// will only see deployed updates on subsequent visits to a page, after all the
// existing tabs open on the page have been closed, since previously cached
// resources are updated in the background.

// To learn more about the benefits of this model and instructions on how to
// opt-in, read https://cra.link/PWA

const isLocalhost = Boolean(
  window.location.hostname === 'localhost' ||
    // [::1] is the IPv6 localhost address.
    window.location.hostname === '[::1]' ||
    // 127.0.0.0/8 are considered localhost for IPv4.
    window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/)
);

export function register(config) {
  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {
    // The URL constructor is available in all browsers that support SW.
    const publicUrl = new URL(process.env.PUBLIC_URL, window.location.href);
    if (publicUrl.origin !== window.location.origin) {
      // Our service worker won't work if PUBLIC_URL is on a different origin
      // from what our page is served on. This might happen if a CDN is used to
      // serve assets; see https://github.com/facebook/create-react-app/issues/2374
      return;
    }

    window.addEventListener('load', () => {
      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;

      if (isLocalhost) {
        // This is running on localhost. Let's check if a service worker still exists or not.
        checkValidServiceWorker(swUrl, config);

        // Add some additional logging to localhost, pointing developers to the
        // service worker/PWA documentation.
        navigator.serviceWorker.ready.then(() => {
          console.log(
            'This web app is being served cache-first by a service ' +
              'worker. To learn more, visit https://cra.link/PWA'
          );
        });
      } else {
        // Is not localhost. Just register service worker
        registerValidSW(swUrl, config);
      }
    });
  }
}

function registerValidSW(swUrl, config) {
  navigator.serviceWorker
    .register(swUrl)
    .then((registration) => {
      registration.onupdatefound = () => {
        const installingWorker = registration.installing;
        if (installingWorker == null) {
          return;
        }
        installingWorker.onstatechange = () => {
          if (installingWorker.state === 'installed') {
            if (navigator.serviceWorker.controller) {
              // At this point, the updated precached content has been fetched,
              // but the previous service worker will still serve the older
              // content until all client tabs are closed.
              console.log(
                'New content is available and will be used when all ' +
                  'tabs for this page are closed. See https://cra.link/PWA.'
              );

              // Execute callback
              if (config && config.onUpdate) {
                config.onUpdate(registration);
              }
            } else {
              // At this point, everything has been precached.
              // It's the perfect time to display a
              // "Content is cached for offline use." message.
              console.log('Content is cached for offline use.');

              // Execute callback
              if (config && config.onSuccess) {
                config.onSuccess(registration);
              }
            }
          }
        };
      };
    })
    .catch((error) => {
      console.error('Error during service worker registration:', error);
    });
}

function checkValidServiceWorker(swUrl, config) {
  // Check if the service worker can be found. If it can't reload the page.
  fetch(swUrl, {
    headers: { 'Service-Worker': 'script' },
  })
    .then((response) => {
      // Ensure service worker exists, and that we really are getting a JS file.
      const contentType = response.headers.get('content-type');
      if (
        response.status === 404 ||
        (contentType != null && contentType.indexOf('javascript') === -1)
      ) {
        // No service worker found. Probably a different app. Reload the page.
        navigator.serviceWorker.ready.then((registration) => {
          registration.unregister().then(() => {
            window.location.reload();
          });
        });
      } else {
        // Service worker found. Proceed as normal.
        registerValidSW(swUrl, config);
      }
    })
    .catch(() => {
      console.log('No internet connection found. App is running in offline mode.');
    });
}

export function unregister() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.ready
      .then((registration) => {
        registration.unregister();
      })
      .catch((error) => {
        console.error(error.message);
      });
  }
}

```

### ClientApp\src\setupProxy.js
```js
const { createProxyMiddleware } = require('http-proxy-middleware');
const { env } = require('process');

const target = env.ASPNETCORE_HTTPS_PORT ? `https://localhost:${env.ASPNETCORE_HTTPS_PORT}` :
  env.ASPNETCORE_URLS ? env.ASPNETCORE_URLS.split(';')[0] : 'https://localhost:7107';

const context = [
  "/weatherforecast",
  "/api/homepage-config",
  "/api/products",
];

const onError = (err, req, resp, target) => {
    console.error(`${err.message}`);
}

module.exports = function (app) {
  const appProxy = createProxyMiddleware(context, {
    proxyTimeout: 10000,
    target: target,
    // Handle errors to prevent the proxy middleware from crashing when
    // the ASP NET Core webserver is unavailable
    onError: onError,
    secure: false,
    // Uncomment this line to add support for proxying websockets
    //ws: true, 
    headers: {
      Connection: 'Keep-Alive'
    }
  });

  app.use(appProxy);
};

```

### ClientApp\src\components\ProtectedRoute.jsx
```jsx
// src/components/ProtectedRoute.jsx
import { jwtDecode } from "jwt-decode";
import { Navigate } from "react-router-dom";

const ProtectedRoute = ({ children }) => {
  const token = localStorage.getItem("token");
  
  if (!token) return <Navigate to="/" replace />;

  try {
    const decoded = jwtDecode(token);
    
    // Láº¥y role name tá»« standard claim hoáº·c Microsoft claim
    const roleName = (
      decoded['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'] || 
      decoded.role || 
      ''
    ).toString().toLowerCase(); // Chuáº©n hÃ³a vá» chá»¯ thÆ°á»ng
    
    const isAdmin = roleName === 'Admin'; // So sÃ¡nh khÃ´ng phÃ¢n biá»‡t hoa thÆ°á»ng
    
    if (!isAdmin) return <Navigate to="/unauthorized" replace />;
    
    return children;
  } catch (error) {
    console.error("Token error:", error);
    return <Navigate to="/" replace />;
  }
};
```

### ClientApp\src\components\SessionExpiredModal.jsx
```jsx
import React from "react";

const SessionExpiredModal = ({ open, onLogin }) => {
  if (!open) return null;
  return (
    <div style={{
      position: "fixed",
      top: 0,
      left: 0,
      width: "100vw",
      height: "100vh",
      background: "rgba(0,0,0,0.4)",
      zIndex: 9999,
      display: "flex",
      alignItems: "center",
      justifyContent: "center"
    }}>
      <div style={{
        background: "#fff",
        padding: 32,
        borderRadius: 8,
        boxShadow: "0 2px 16px rgba(0,0,0,0.2)",
        minWidth: 320,
        textAlign: "center"
      }}>
        <h2>PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n</h2>
        <p>Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i Ä‘á»ƒ tiáº¿p tá»¥c sá»­ dá»¥ng dá»‹ch vá»¥.</p>
        <button
          style={{
            marginTop: 16,
            padding: "8px 24px",
            background: "#007bff",
            color: "#fff",
            border: "none",
            borderRadius: 4,
            cursor: "pointer"
          }}
          onClick={onLogin}
        >
          ÄÄƒng nháº­p láº¡i
        </button>
      </div>
    </div>
  );
};

export default SessionExpiredModal;

```

### ClientApp\src\components\Admin\analytics\AIPoweredInsights.jsx
```jsx
import { motion } from "framer-motion";
import { TrendingUp, Users, ShoppingBag, DollarSign } from "lucide-react";

const INSIGHTS = [
	{
		icon: TrendingUp,
		color: "text-green-500",
		insight: "Revenue is up 15% compared to last month, driven primarily by a successful email campaign.",
	},
	{
		icon: Users,
		color: "text-blue-500",
		insight: "Customer retention has improved by 8% following the launch of the new loyalty program.",
	},
	{
		icon: ShoppingBag,
		color: "text-purple-500",
		insight: 'Product category "Electronics" shows the highest growth potential based on recent market trends.',
	},
	{
		icon: DollarSign,
		color: "text-yellow-500",
		insight: "Optimizing pricing strategy could potentially increase overall profit margins by 5-7%.",
	},
];

const AIPoweredInsights = () => {
	return (
		<motion.div
			className='bg-gray-800 bg-opacity-50 backdrop-filter backdrop-blur-lg shadow-lg rounded-xl p-6 border border-gray-700'
			initial={{ opacity: 0, y: 20 }}
			animate={{ opacity: 1, y: 0 }}
			transition={{ delay: 1.0 }}
		>
			<h2 className='text-xl font-semibold text-gray-100 mb-4'>AI-Powered Insights</h2>
			<div className='space-y-4'>
				{INSIGHTS.map((item, index) => (
					<div key={index} className='flex items-center space-x-3'>
						<div className={`p-2 rounded-full ${item.color} bg-opacity-20`}>
							<item.icon className={`size-6 ${item.color}`} />
						</div>
						<p className='text-gray-300'>{item.insight}</p>
					</div>
				))}
			</div>
		</motion.div>
	);
};
export default AIPoweredInsights;

```

### ClientApp\src\components\Admin\analytics\ChannelPerformance.jsx
```jsx
import { motion } from "framer-motion";
import { PieChart, Pie, Cell, Tooltip, Legend, ResponsiveContainer } from "recharts";

const channelData = [
	{ name: "Organic Search", value: 4000 },
	{ name: "Paid Search", value: 3000 },
	{ name: "Direct", value: 2000 },
	{ name: "Social Media", value: 2780 },
	{ name: "Referral", value: 1890 },
	{ name: "Email", value: 2390 },
];
const COLORS = ["#8884d8", "#82ca9d", "#ffc658", "#ff8042", "#0088FE", "#00C49F"];

const ChannelPerformance = () => {
	return (
		<motion.div
			className='bg-gray-800 bg-opacity-50 backdrop-filter backdrop-blur-lg shadow-lg rounded-xl p-6 border border-gray-700'
			initial={{ opacity: 0, y: 20 }}
			animate={{ opacity: 1, y: 0 }}
			transition={{ delay: 0.3 }}
		>
			<h2 className='text-xl font-semibold text-gray-100 mb-4'>Channel Performance</h2>
			<div style={{ width: "100%", height: 300 }}>
				<ResponsiveContainer>
					<PieChart>
						<Pie
							data={channelData}
							cx='50%'
							cy='50%'
							outerRadius={80}
							fill='#8884d8'
							dataKey='value'
							label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
						>
							{channelData.map((entry, index) => (
								<Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
							))}
						</Pie>
						<Tooltip
							contentStyle={{
								backgroundColor: "rgba(31, 41, 55, 0.8)",
								borderColor: "#4B5563",
							}}
							itemStyle={{ color: "#E5E7EB" }}
						/>
						<Legend />
					</PieChart>
				</ResponsiveContainer>
			</div>
		</motion.div>
	);
};
export default ChannelPerformance;

```

### ClientApp\src\components\Admin\analytics\CustomerSegmentation.jsx
```jsx
import { motion } from "framer-motion";
import {
	ResponsiveContainer,
	Radar,
	RadarChart,
	PolarGrid,
	PolarAngleAxis,
	PolarRadiusAxis,
	Legend,
	Tooltip,
} from "recharts";

const customerSegmentationData = [
	{ subject: "Engagement", A: 120, B: 110, fullMark: 150 },
	{ subject: "Loyalty", A: 98, B: 130, fullMark: 150 },
	{ subject: "Satisfaction", A: 86, B: 130, fullMark: 150 },
	{ subject: "Spend", A: 99, B: 100, fullMark: 150 },
	{ subject: "Frequency", A: 85, B: 90, fullMark: 150 },
	{ subject: "Recency", A: 65, B: 85, fullMark: 150 },
];

const CustomerSegmentation = () => {
	return (
		<motion.div
			className='bg-gray-800 bg-opacity-50 backdrop-filter backdrop-blur-lg shadow-lg rounded-xl p-6 border border-gray-700'
			initial={{ opacity: 0, y: 20 }}
			animate={{ opacity: 1, y: 0 }}
			transition={{ delay: 0.6 }}
		>
			<h2 className='text-xl font-semibold text-gray-100 mb-4'>Customer Segmentation</h2>
			<div style={{ width: "100%", height: 300 }}>
				<ResponsiveContainer>
					<RadarChart cx='50%' cy='50%' outerRadius='80%' data={customerSegmentationData}>
						<PolarGrid stroke='#374151' />
						<PolarAngleAxis dataKey='subject' stroke='#9CA3AF' />
						<PolarRadiusAxis angle={30} domain={[0, 150]} stroke='#9CA3AF' />
						<Radar name='Segment A' dataKey='A' stroke='#8B5CF6' fill='#8B5CF6' fillOpacity={0.6} />
						<Radar name='Segment B' dataKey='B' stroke='#10B981' fill='#10B981' fillOpacity={0.6} />
						<Legend />
						<Tooltip
							contentStyle={{
								backgroundColor: "rgba(31, 41, 55, 0.8)",
								borderColor: "#4B5563",
							}}
							itemStyle={{ color: "#E5E7EB" }}
						/>
					</RadarChart>
				</ResponsiveContainer>
			</div>
		</motion.div>
	);
};
export default CustomerSegmentation;

```

### ClientApp\src\components\Admin\analytics\OverviewCards.jsx
```jsx
import { motion } from "framer-motion";
import { DollarSign, Users, ShoppingBag, Eye, ArrowDownRight, ArrowUpRight } from "lucide-react";

const overviewData = [
	{ name: "Revenue", value: "$1,234,567", change: 12.5, icon: DollarSign },
	{ name: "Users", value: "45,678", change: 8.3, icon: Users },
	{ name: "Orders", value: "9,876", change: -3.2, icon: ShoppingBag },
	{ name: "Page Views", value: "1,234,567", change: 15.7, icon: Eye },
];

const OverviewCards = () => {
	return (
		<div className='grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8'>
			{overviewData.map((item, index) => (
				<motion.div
					key={item.name}
					className='bg-gray-800 bg-opacity-50 backdrop-filter backdrop-blur-lg shadow-lg
            rounded-xl p-6 border border-gray-700
          '
					initial={{ opacity: 0, y: 20 }}
					animate={{ opacity: 1, y: 0 }}
					transition={{ delay: index * 0.1 }}
				>
					<div className='flex items-center justify-between'>
						<div>
							<h3 className='text-sm font-medium text-gray-400'>{item.name}</h3>
							<p className='mt-1 text-xl font-semibold text-gray-100'>{item.value}</p>
						</div>

						<div
							className={`
              p-3 rounded-full bg-opacity-20 ${item.change >= 0 ? "bg-green-500" : "bg-red-500"}
              `}
						>
							<item.icon className={`size-6  ${item.change >= 0 ? "text-green-500" : "text-red-500"}`} />
						</div>
					</div>
					<div
						className={`
              mt-4 flex items-center ${item.change >= 0 ? "text-green-500" : "text-red-500"}
            `}
					>
						{item.change >= 0 ? <ArrowUpRight size='20' /> : <ArrowDownRight size='20' />}
						<span className='ml-1 text-sm font-medium'>{Math.abs(item.change)}%</span>
						<span className='ml-2 text-sm text-gray-400'>vs last period</span>
					</div>
				</motion.div>
			))}
		</div>
	);
};
export default OverviewCards;

```

### ClientApp\src\components\Admin\analytics\ProductPerformance.jsx
```jsx
import { Bar, BarChart, CartesianGrid, Legend, ResponsiveContainer, Tooltip, XAxis, YAxis } from "recharts";
import { motion } from "framer-motion";

const productPerformanceData = [
	{ name: "Product A", sales: 4000, revenue: 2400, profit: 2400 },
	{ name: "Product B", sales: 3000, revenue: 1398, profit: 2210 },
	{ name: "Product C", sales: 2000, revenue: 9800, profit: 2290 },
	{ name: "Product D", sales: 2780, revenue: 3908, profit: 2000 },
	{ name: "Product E", sales: 1890, revenue: 4800, profit: 2181 },
];

const ProductPerformance = () => {
	return (
		<motion.div
			className='bg-gray-800 bg-opacity-50 backdrop-filter backdrop-blur-lg shadow-lg rounded-xl p-6 border border-gray-700'
			initial={{ opacity: 0, y: 20 }}
			animate={{ opacity: 1, y: 0 }}
			transition={{ delay: 0.4 }}
		>
			<h2 className='text-xl font-semibold text-gray-100 mb-4'>Product Performance</h2>
			<div style={{ width: "100%", height: 300 }}>
				<ResponsiveContainer>
					<BarChart data={productPerformanceData}>
						<CartesianGrid strokeDasharray='3 3' stroke='#374151' />
						<XAxis dataKey='name' stroke='#9CA3AF' />
						<YAxis stroke='#9CA3AF' />
						<Tooltip
							contentStyle={{
								backgroundColor: "rgba(31, 41, 55, 0.8)",
								borderColor: "#4B5563",
							}}
							itemStyle={{ color: "#E5E7EB" }}
						/>
						<Legend />
						<Bar dataKey='sales' fill='#8B5CF6' />
						<Bar dataKey='revenue' fill='#10B981' />
						<Bar dataKey='profit' fill='#F59E0B' />
					</BarChart>
				</ResponsiveContainer>
			</div>
		</motion.div>
	);
};
export default ProductPerformance;

```

### ClientApp\src\components\Admin\analytics\RevenueChart.jsx
```jsx
import { useState } from "react";
import { motion } from "framer-motion";
import { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from "recharts";

const revenueData = [
	{ month: "Jan", revenue: 4000, target: 3800 },
	{ month: "Feb", revenue: 3000, target: 3200 },
	{ month: "Mar", revenue: 5000, target: 4500 },
	{ month: "Apr", revenue: 4500, target: 4200 },
	{ month: "May", revenue: 6000, target: 5500 },
	{ month: "Jun", revenue: 5500, target: 5800 },
	{ month: "Jul", revenue: 7000, target: 6500 },
];

const RevenueChart = () => {
	const [selectedTimeRange, setSelectedTimeRange] = useState("This Month");

	return (
		<motion.div
			className='bg-gray-800 bg-opacity-50 backdrop-filter backdrop-blur-lg shadow-lg rounded-xl p-6 border border-gray-700 mb-8'
			initial={{ opacity: 0, y: 20 }}
			animate={{ opacity: 1, y: 0 }}
			transition={{ delay: 0.2 }}
		>
			<div className='flex justify-between items-center mb-6'>
				<h2 className='text-xl font-semibold text-gray-100'>Revenue vs Target</h2>
				<select
					className='bg-gray-700 text-white rounded-md px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500'
					value={selectedTimeRange}
					onChange={(e) => setSelectedTimeRange(e.target.value)}
				>
					<option>This Week</option>
					<option>This Month</option>
					<option>This Quarter</option>
					<option>This Year</option>
				</select>
			</div>

			<div style={{ width: "100%", height: 400 }}>
				<ResponsiveContainer>
					<AreaChart data={revenueData}>
						<CartesianGrid strokeDasharray='3 3' stroke='#374151' />
						<XAxis dataKey='month' stroke='#9CA3AF' />
						<YAxis stroke='#9CA3AF' />
						<Tooltip
							contentStyle={{ backgroundColor: "rgba(31, 41, 55, 0.8)", borderColor: "#4B5563" }}
							itemStyle={{ color: "#E5E7EB" }}
						/>
						<Legend />
						<Area type='monotone' dataKey='revenue' stroke='#8B5CF6' fill='#8B5CF6' fillOpacity={0.3} />
						<Area type='monotone' dataKey='target' stroke='#10B981' fill='#10B981' fillOpacity={0.3} />
					</AreaChart>
				</ResponsiveContainer>
			</div>
		</motion.div>
	);
};
export default RevenueChart;

```

### ClientApp\src\components\Admin\analytics\UserRetention.jsx
```jsx
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from "recharts";
import { motion } from "framer-motion";

const userRetentionData = [
	{ name: "Week 1", retention: 100 },
	{ name: "Week 2", retention: 75 },
	{ name: "Week 3", retention: 60 },
	{ name: "Week 4", retention: 50 },
	{ name: "Week 5", retention: 45 },
	{ name: "Week 6", retention: 40 },
	{ name: "Week 7", retention: 38 },
	{ name: "Week 8", retention: 35 },
];

const UserRetention = () => {
	return (
		<motion.div
			className='bg-gray-800 bg-opacity-50 backdrop-filter backdrop-blur-lg shadow-lg rounded-xl p-6 border border-gray-700'
			initial={{ opacity: 0, y: 20 }}
			animate={{ opacity: 1, y: 0 }}
			transition={{ delay: 0.5 }}
		>
			<h2 className='text-xl font-semibold text-gray-100 mb-4'>User Retention</h2>
			<div style={{ width: "100%", height: 300 }}>
				<ResponsiveContainer>
					<LineChart data={userRetentionData}>
						<CartesianGrid strokeDasharray='3 3' stroke='#374151' />
						<XAxis dataKey='name' stroke='#9CA3AF' />
						<YAxis stroke='#9CA3AF' />
						<Tooltip
							contentStyle={{
								backgroundColor: "rgba(31, 41, 55, 0.8)",
								borderColor: "#4B5563",
							}}
							itemStyle={{ color: "#E5E7EB" }}
						/>
						<Legend />
						<Line type='monotone' dataKey='retention' stroke='#8B5CF6' strokeWidth={2} />
					</LineChart>
				</ResponsiveContainer>
			</div>
		</motion.div>
	);
};
export default UserRetention;

```

### ClientApp\src\components\Admin\common\CardProduct.jsx
```jsx
import { useState } from "react";
import { Select, MenuItem } from "@mui/material";
import { motion } from "framer-motion";

const CardProduct = ({ name, icon: Icon, value, color, options, onOptionChange }) => {
	const [selectedOption, setSelectedOption] = useState(options?.[0] || "");

	const handleOptionChange = (event) => {
		const newValue = event.target.value;
		setSelectedOption(newValue);
		onOptionChange(newValue);
	};

	return (
		<motion.div
			className="bg-gray-800 bg-opacity-50 backdrop-blur-md overflow-hidden shadow-lg rounded-xl border border-gray-700"
			whileHover={{ y: -5, boxShadow: "0 25px 50px -12px rgba(0, 0, 0, 0.5)" }}
		>
			<div className="px-4 py-5 sm:p-6">
				<div className="flex items-center justify-between">
					<span className="flex items-center text-sm font-medium text-gray-400">
						<Icon size={20} className="mr-2" style={{ color }} />
						{name}
					</span>
					{options && (
						<Select
							value={selectedOption}
							onChange={handleOptionChange}
							size="small"
							variant="outlined"
							sx={{
								color: "white",
								backgroundColor: "rgba(255, 255, 255, 0.1)",
								borderRadius: 1,
								"& .MuiOutlinedInput-notchedOutline": { borderColor: "rgba(255, 255, 255, 0.2)" },
								"&:hover .MuiOutlinedInput-notchedOutline": { borderColor: "white" },
								"&.Mui-focused .MuiOutlinedInput-notchedOutline": { borderColor: color },
							}}
						>
							{options.map((option) => (
								<MenuItem key={option} value={option}>
									{option}
								</MenuItem>
							))}
						</Select>
					)}
				</div>
				<p className="mt-1 text-3xl font-semibold text-gray-100">{value}</p>
			</div>
		</motion.div>
	);
};

export default CardProduct;

```

### ClientApp\src\components\Admin\common\Header.jsx
```jsx
const Header = ({ title }) => {
	return (
		<header className='bg-gray-800 bg-opacity-50 backdrop-blur-md shadow-lg border-b border-gray-700'>
			<div className='max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8'>
				<h1 className='text-2xl font-semibold text-gray-100'>{title}</h1>
			</div>
		</header>
	);
};
export default Header;

```

### ClientApp\src\components\Admin\common\Sidebar.jsx
```jsx
import { BarChart2, DollarSign, Menu, ShoppingBag, ShoppingCart, Users, Home, MessageCircle, LayoutDashboard, FileText } from "lucide-react";
import { useState } from "react";
import { AnimatePresence, motion } from "framer-motion";
import { Link } from "react-router-dom";
import { RateReview } from "@mui/icons-material";

const SIDEBAR_ITEMS = [
	{
		name: "Tá»•ng quan",
		icon: BarChart2,
		color: "#6366f1",
		href: "/admin/overview",
	},
	{
		name: "Quáº£n lÃ½ Trang chá»§",
		icon: LayoutDashboard,
		color: "#F97316",
		href: "/admin/homepage-dashboard",
	},
	{ name: "Sáº£n Pháº©m", icon: ShoppingBag, color: "#8B5CF6", href: "/admin/products" },
	{ name: "NgÆ°á»i DÃ¹ng", icon: Users, color: "#EC4899", href: "/admin/users" },
	{ name: "BÃ¡n HÃ ng", icon: DollarSign, color: "#10B981", href: "/admin/sales" },
	{ name: "ÄÆ¡n HÃ ng", icon: ShoppingCart, color: "#F59E0B", href: "/admin/orders" },
	{ name: "Quáº£n lÃ½ ÄÃ¡nh giÃ¡", icon: RateReview, color: "#FFD700", href: "/admin/reviews" },
	{ name: "Quáº£n lÃ½ Blog", icon: FileText, color: "#34D399", href: "/admin/blog" },
	{ name: "Chat AI", icon: MessageCircle, color: "#06B6D4", href: "/admin/chat" },
	// { name: "PhÃ¢n tÃ­ch", icon: TrendingUp, color: "#3B82F6", href: "/admin/analytics" },
	// { name: "Settings", icon: Settings, color: "#6EE7B7", href: "/admin/settings" },
];

const Sidebar = () => {
	const [isSidebarOpen, setIsSidebarOpen] = useState(true);

	return (
		<motion.div
			className={`relative z-10 transition-all duration-300 ease-in-out flex-shrink-0 ${
				isSidebarOpen ? "w-64" : "w-20"
			}`}
			animate={{ width: isSidebarOpen ? 256 : 80 }}
		>
			<div className='h-full bg-gray-800 bg-opacity-50 backdrop-blur-md p-4 flex flex-col border-r border-gray-700'>
				<motion.button
					whileHover={{ scale: 1.1 }}
					whileTap={{ scale: 0.9 }}
					onClick={() => setIsSidebarOpen(!isSidebarOpen)}
					className='p-2 rounded-full hover:bg-gray-700 transition-colors max-w-fit'
				>
					<Menu size={24} />
				</motion.button>
				
				<nav className='mt-8 flex-grow'>
					{/* Logo/Home Link */}
		<Link to="/" className="mb-6">
		  <motion.div 
			className="flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors"
			whileHover={{ scale: 1.05 }}
		  >
			<Home size={24} className="text-indigo-400" />
			<AnimatePresence>
			  {isSidebarOpen && (
				<motion.span
				  className="ml-3 text-xl font-bold text-white"
				  initial={{ opacity: 0, x: -10 }}
				  animate={{ opacity: 1, x: 0 }}
				  exit={{ opacity: 0, x: -10 }}
				  transition={{ duration: 0.2 }}
				>
				  SHN Gear
				</motion.span>
			  )}
			</AnimatePresence>
		  </motion.div>
		</Link>
					{SIDEBAR_ITEMS.map((item) => (
						<Link key={item.href} to={item.href}>
							<motion.div className='flex items-center p-4 text-sm font-medium rounded-lg hover:bg-gray-700 transition-colors mb-2'>
								<item.icon size={20} style={{ color: item.color, minWidth: "20px" }} />
								<AnimatePresence>
									{isSidebarOpen && (
										<motion.span
											className='ml-4 whitespace-nowrap'
											initial={{ opacity: 0, width: 0 }}
											animate={{ opacity: 1, width: "auto" }}
											exit={{ opacity: 0, width: 0 }}
											transition={{ duration: 0.2, delay: 0.3 }}
										>
											{item.name}
										</motion.span>
									)}
								</AnimatePresence>
							</motion.div>
						</Link>
					))}

					
				</nav>
			</div>
		</motion.div>
	);
};
export default Sidebar;

```

### ClientApp\src\components\Admin\common\StatCard.jsx
```jsx
import { motion } from "framer-motion";

const StatCard = ({ name, icon: Icon, value, color }) => {
	return (
		<motion.div
			className='bg-gray-800 bg-opacity-50 backdrop-blur-md overflow-hidden shadow-lg rounded-xl border border-gray-700'
			whileHover={{ y: -5, boxShadow: "0 25px 50px -12px rgba(0, 0, 0, 0.5)" }}
		>
			<div className='px-4 py-5 sm:p-6'>
				<span className='flex items-center text-sm font-medium text-gray-400'>
					<Icon size={20} className='mr-2' style={{ color }} />
					{name}
				</span>
				<p className='mt-1 text-3xl font-semibold text-gray-100'>{value}</p>
			</div>
		</motion.div>
	);
};
export default StatCard;

```

### ClientApp\src\components\Admin\orders\DailyOrders.jsx
```jsx
import { motion } from "framer-motion";
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from "recharts";

const dailyOrdersData = [
	{ date: "07/01", orders: 45 },
	{ date: "07/02", orders: 52 },
	{ date: "07/03", orders: 49 },
	{ date: "07/04", orders: 60 },
	{ date: "07/05", orders: 55 },
	{ date: "07/06", orders: 58 },
	{ date: "07/07", orders: 62 },
];

const DailyOrders = () => {
	return (
		<motion.div
			className='bg-gray-800 bg-opacity-50 backdrop-blur-md shadow-lg rounded-xl p-6 border border-gray-700'
			initial={{ opacity: 0, y: 20 }}
			animate={{ opacity: 1, y: 0 }}
			transition={{ delay: 0.2 }}
		>
			<h2 className='text-xl font-semibold text-gray-100 mb-4'>Daily Orders</h2>

			<div style={{ width: "100%", height: 300 }}>
				<ResponsiveContainer>
					<LineChart data={dailyOrdersData}>
						<CartesianGrid strokeDasharray='3 3' stroke='#374151' />
						<XAxis dataKey='date' stroke='#9CA3AF' />
						<YAxis stroke='#9CA3AF' />
						<Tooltip
							contentStyle={{
								backgroundColor: "rgba(31, 41, 55, 0.8)",
								borderColor: "#4B5563",
							}}
							itemStyle={{ color: "#E5E7EB" }}
						/>
						<Legend />
						<Line type='monotone' dataKey='orders' stroke='#8B5CF6' strokeWidth={2} />
					</LineChart>
				</ResponsiveContainer>
			</div>
		</motion.div>
	);
};
export default DailyOrders;

```

### ClientApp\src\components\Admin\orders\EditOrder.jsx
```jsx
import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { Drawer, Box, Typography, Button, Select, MenuItem, FormControl, InputLabel, CircularProgress, Alert } from '@mui/material';
import axios from 'axios';
import OrderItem from './OrderItem'; // Import component OrderItem

// HÃ m khá»Ÿi táº¡o state ban Ä‘áº§u an toÃ n hÆ¡n
const getInitialFormData = (order) => ({
    addressId: order?.addressId || '',
    voucherId: order?.voucherId || '',
    orderItems: order?.orderItems || [],
    paymentMethodId: order?.paymentMethodId || 1,
    orderStatus: order?.orderStatus || 'Pending'
});

const EditOrder = ({ open, onClose, order, onOrderUpdated }) => {
    const [formData, setFormData] = useState(() => getInitialFormData(order));
    const [addresses, setAddresses] = useState([]);
    const [vouchers, setVouchers] = useState([]);
    const [products, setProducts] = useState([]);
    const [loading, setLoading] = useState(false); // State cho viá»‡c táº£i dá»¯ liá»‡u
    const [fetchError, setFetchError] = useState(null); // State cho lá»—i fetch dá»¯ liá»‡u
    const [submitError, setSubmitError] = useState(null); // State cho lá»—i submit

    // Cáº­p nháº­t láº¡i form data khi prop `order` thay Ä‘á»•i
    useEffect(() => {
        setFormData(getInitialFormData(order));
    }, [order]);

    // Fetch dá»¯ liá»‡u khi component Ä‘Æ°á»£c má»Ÿ láº§n Ä‘áº§u hoáº·c khi `open` lÃ  true
    useEffect(() => {
        if (open) {
            const fetchData = async () => {
                setLoading(true);
                setFetchError(null); // Reset lá»—i trÆ°á»›c khi fetch
                try {
                    // DÃ¹ng Promise.all Ä‘á»ƒ fetch song song
                    const [addressesRes, vouchersRes, productsRes] = await Promise.all([
                        axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/addresses`),
                        axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/vouchers`),
                        axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/products`)
                    ]);

                    setAddresses(addressesRes.data);
                    // Lá»c voucher hiá»‡u lá»±c ngay khi nháº­n dá»¯ liá»‡u
                    setVouchers(vouchersRes.data.filter(v => v.isActive && new Date(v.expiryDate) > new Date()));
                    setProducts(productsRes.data);

                } catch (error) {
                    console.error('Error fetching data:', error);
                    setFetchError('KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u cáº§n thiáº¿t. Vui lÃ²ng thá»­ láº¡i.'); // ThÃ´ng bÃ¡o lá»—i thÃ¢n thiá»‡n
                } finally {
                    setLoading(false);
                }
            };
            fetchData();
        } else {
             // Reset state khi Ä‘Ã³ng Drawer Ä‘á»ƒ láº§n má»Ÿ sau khÃ´ng bá»‹ áº£nh hÆ°á»Ÿng
             setLoading(false);
             setFetchError(null);
             setSubmitError(null);
             // KhÃ´ng reset form data á»Ÿ Ä‘Ã¢y vÃ¬ cÃ³ thá»ƒ ngÆ°á»i dÃ¹ng muá»‘n giá»¯ láº¡i thay Ä‘á»•i chÆ°a lÆ°u
        }
    }, [open]); // Chá»‰ fetch khi `open` thay Ä‘á»•i (vÃ  lÃ  true)

    // Memoize cÃ¡c options cho Select Ä‘á»ƒ trÃ¡nh tÃ­nh toÃ¡n láº¡i khÃ´ng cáº§n thiáº¿t
    const addressOptions = useMemo(() => addresses.map(address => (
        <MenuItem key={address.id} value={address.id}>
            {address.fullName} - {address.addressLine1}
        </MenuItem>
    )), [addresses]);

    const voucherOptions = useMemo(() => vouchers.map(voucher => (
        <MenuItem key={voucher.id} value={voucher.id}>
            {voucher.code} (Giáº£m {voucher.discountAmount}Ä‘)
        </MenuItem>
    )), [vouchers]);

    const productVariantOptions = useMemo(() => products.flatMap(product =>
        product.variants.map(variant => (
            <MenuItem key={variant.id} value={variant.id}>
                {product.name} - {variant.color} - {variant.storage}
            </MenuItem>
        ))
    ), [products]);

    // Sá»­ dá»¥ng useCallback cho cÃ¡c handler Ä‘á»ƒ tá»‘i Æ°u (Ä‘áº·c biá»‡t khi truyá»n xuá»‘ng component con)
    const handleChange = useCallback((e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    }, []);

    const handleOrderItemChange = useCallback((index, field, value) => {
        setFormData(prev => {
            const updatedItems = [...prev.orderItems];
            updatedItems[index] = { ...updatedItems[index], [field]: value }; // Cáº­p nháº­t item Ä‘Ãºng cÃ¡ch
            return { ...prev, orderItems: updatedItems };
        });
    }, []);

    const addOrderItem = useCallback(() => {
        setFormData(prev => ({
            ...prev,
            orderItems: [...prev.orderItems, { productVariantId: '', quantity: 1, price: 0 }]
        }));
    }, []);

    const removeOrderItem = useCallback((index) => {
        setFormData(prev => ({
            ...prev,
            orderItems: prev.orderItems.filter((_, i) => i !== index)
        }));
    }, []);

    const handleSubmit = useCallback(async () => {
        setSubmitError(null); // Reset lá»—i trÆ°á»›c khi submit
        try {
            // CÃ³ thá»ƒ thÃªm validation cho formData á»Ÿ Ä‘Ã¢y trÆ°á»›c khi gá»­i
            const response = await axios.put(
                `${process.env.REACT_APP_API_BASE_URL}/api/orders/${order.id}`,
                formData
            );
            onOrderUpdated(response.data);
            onClose(); // ÄÃ³ng Drawer sau khi thÃ nh cÃ´ng
        } catch (error) {
            console.error('Error updating order:', error);
            // Hiá»ƒn thá»‹ lá»—i thÃ¢n thiá»‡n hÆ¡n alert
            setSubmitError(error.response?.data?.message || 'CÃ³ lá»—i xáº£y ra khi cáº­p nháº­t Ä‘Æ¡n hÃ ng. Vui lÃ²ng thá»­ láº¡i.');
        }
    }, [formData, order?.id, onOrderUpdated, onClose]); // ThÃªm dependencies cho useCallback

    return (
        <Drawer
            anchor="right"
            open={open}
            onClose={onClose}
            PaperProps={{ sx: { width: '50%', maxWidth: '600px' } }} // TÄƒng chiá»u rá»™ng má»™t chÃºt
        >
            <Box sx={{ p: 3, display: 'flex', flexDirection: 'column', height: '100%' }}>
                <Typography variant="h6" gutterBottom>
                    Chá»‰nh sá»­a Ä‘Æ¡n hÃ ng #{order?.id}
                </Typography>

                {/* Hiá»ƒn thá»‹ loading hoáº·c lá»—i fetch */}
                {loading && <Box sx={{ display: 'flex', justifyContent: 'center', my: 3 }}><CircularProgress /></Box>}
                {fetchError && <Alert severity="error" sx={{ mb: 2 }}>{fetchError}</Alert>}
                {submitError && <Alert severity="error" sx={{ mb: 2 }}>{submitError}</Alert>}

                {/* Chá»‰ hiá»ƒn thá»‹ form khi khÃ´ng loading vÃ  khÃ´ng cÃ³ lá»—i fetch */}
                {!loading && !fetchError && (
                    <Box sx={{ flexGrow: 1, overflowY: 'auto' }}> {/* Cho phÃ©p scroll ná»™i dung form */}
                        <FormControl fullWidth margin="normal">
                            <InputLabel>Äá»‹a chá»‰ giao hÃ ng</InputLabel>
                            <Select name="addressId" value={formData.addressId} onChange={handleChange} label="Äá»‹a chá»‰ giao hÃ ng">
                                {addressOptions}
                            </Select>
                        </FormControl>

                        <FormControl fullWidth margin="normal">
                            <InputLabel>Voucher</InputLabel>
                            <Select name="voucherId" value={formData.voucherId} onChange={handleChange} label="Voucher">
                                <MenuItem value=""><em>KhÃ´ng sá»­ dá»¥ng voucher</em></MenuItem>
                                {voucherOptions}
                            </Select>
                        </FormControl>

                         {/* ThÃªm cÃ¡c trÆ°á»ng khÃ¡c náº¿u cáº§n, vÃ­ dá»¥: Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng */}
                         <FormControl fullWidth margin="normal">
                             <InputLabel>Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng</InputLabel>
                             <Select name="orderStatus" value={formData.orderStatus} onChange={handleChange} label="Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng">
                                 <MenuItem value="Pending">Chá» xá»­ lÃ½</MenuItem>
                                 <MenuItem value="Processing">Äang xá»­ lÃ½</MenuItem>
                                 <MenuItem value="Shipped">ÄÃ£ giao hÃ ng</MenuItem>
                                 <MenuItem value="Delivered">ÄÃ£ nháº­n</MenuItem>
                                 <MenuItem value="Cancelled">ÄÃ£ há»§y</MenuItem>
                                 {/* ThÃªm cÃ¡c tráº¡ng thÃ¡i khÃ¡c náº¿u cÃ³ */}
                             </Select>
                         </FormControl>


                        <Typography variant="subtitle1" gutterBottom sx={{ mt: 2 }}>
                            Sáº£n pháº©m
                        </Typography>

                        {formData.orderItems.map((item, index) => (
                            // Sá»­ dá»¥ng component OrderItem
                            <OrderItem
                                key={index} // LÆ°u Ã½: dÃ¹ng index lÃ m key khÃ´ng lÃ½ tÆ°á»Ÿng náº¿u list cÃ³ thá»ƒ sáº¯p xáº¿p láº¡i/xÃ³a giá»¯a chá»«ng. Náº¿u item cÃ³ ID duy nháº¥t, nÃªn dÃ¹ng item.id
                                item={item}
                                index={index}
                                productVariantOptions={productVariantOptions}
                                onChange={handleOrderItemChange}
                                onRemove={removeOrderItem}
                            />
                        ))}

                        <Button variant="outlined" onClick={addOrderItem} sx={{ mt: 1, mb: 2 }}>
                            ThÃªm sáº£n pháº©m
                        </Button>
                    </Box>
                )}

                {/* Pháº§n footer cá»‘ Ä‘á»‹nh */}
                <Box sx={{ display: 'flex', justifyContent: 'flex-end', mt: 3, pt: 2, borderTop: '1px solid #eee' }}>
                    <Button variant="outlined" onClick={onClose} sx={{ mr: 2 }}>
                        Há»§y
                    </Button>
                    <Button variant="contained" onClick={handleSubmit} disabled={loading || !!fetchError}> {/* Disable nÃºt LÆ°u khi Ä‘ang load hoáº·c cÃ³ lá»—i fetch */}
                        LÆ°u thay Ä‘á»•i
                    </Button>
                </Box>
            </Box>
        </Drawer>
    );
};

export default EditOrder;
```

### ClientApp\src\components\Admin\orders\OrderDetailDrawer.jsx
```jsx
import React, { useState, useEffect, useCallback } from 'react';
import {
    Drawer, Box, Typography, Divider, List, IconButton, Chip, CircularProgress, Grid, Button, ButtonGroup, Alert, Snackbar
} from '@mui/material';
import { Close, PictureAsPdf, InsertDriveFile, Receipt } from '@mui/icons-material';
import axios from 'axios';
import { formatCurrency, formatDate, formatAddress, getStatusColor, getPaymentMethodName } from '../../../utils/FormatInfo'; // Äáº£m báº£o Ä‘Æ°á»ng dáº«n Ä‘Ãºng
import OrderDetailItem from './OrderDetailItem';

const OrderDetailDrawer = ({ orderId, open, onClose }) => {
    const [order, setOrder] = useState(null);
    const [variantDetails, setVariantDetails] = useState({}); // Sáº½ chá»©a chi tiáº¿t variant cho order hiá»‡n táº¡i
    const [loading, setLoading] = useState(false);
    const [fetchError, setFetchError] = useState(null);
    const [exporting, setExporting] = useState(false);
    const [exportStatus, setExportStatus] = useState({ open: false, message: '', severity: 'info' });

    useEffect(() => {
        // --- Äá»‹nh nghÄ©a cÃ¡c hÃ m fetch bÃªn trong useEffect ---
        const performFetchVariantDetails = async (items) => {
            if (!items || items.length === 0) {
                return {}; // Tráº£ vá» object rá»—ng náº¿u khÃ´ng cÃ³ items
            }
            // HÃ m nÃ y sáº½ fetch cÃ¡c variant chÆ°a cÃ³ trong cache Cá»¤C Bá»˜ cho láº§n fetch nÃ y
            // Äá»ƒ Ä‘Æ¡n giáº£n, chÃºng ta fetch táº¥t cáº£ variant cho order hiá»‡n táº¡i má»—i láº§n
            // Náº¿u muá»‘n cache toÃ n cá»¥c, logic sáº½ phá»©c táº¡p hÆ¡n.
            try {
                const variantIds = items.map((item) => item.variantId).filter(id => id); // Lá»c bá» ID null/undefined

                if (variantIds.length === 0) return {};

                const variantPromises = variantIds.map((id) =>
                    axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/products/by-variant/${id}`)
                );
                const variantResponses = await Promise.all(variantPromises);

                const newDetails = {};
                variantResponses.forEach((res, index) => {
                    if (res.data) { // Kiá»ƒm tra cÃ³ data tráº£ vá» khÃ´ng
                       newDetails[variantIds[index]] = res.data;
                    }
                });
                return newDetails;
            } catch (error) {
                console.error('Failed to fetch variant details:', error);
                // NÃ©m lá»—i Ä‘á»ƒ performFetchOrderDetails báº¯t Ä‘Æ°á»£c vÃ  set fetchError chung
                throw new Error('Lá»—i khi táº£i chi tiáº¿t sáº£n pháº©m.');
            }
        };

        const performFetchOrderDetails = async () => {
            if (!orderId) return; // KhÃ´ng cÃ³ orderId thÃ¬ khÃ´ng lÃ m gÃ¬

            setLoading(true);
            setFetchError(null);
            setOrder(null); // Reset order cÅ©
            setVariantDetails({}); // Reset variant details cÅ©

            try {
                const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/orders/${orderId}/details`);
                const fetchedOrderData = response.data;
                setOrder(fetchedOrderData); // Cáº­p nháº­t order

                if (fetchedOrderData?.items?.length > 0) {
                    const newVariantData = await performFetchVariantDetails(fetchedOrderData.items);
                    setVariantDetails(newVariantData); // Cáº­p nháº­t variant details cho order nÃ y
                }
                // Náº¿u khÃ´ng cÃ³ items, variantDetails váº«n lÃ  {} (Ä‘Ã£ reset á»Ÿ trÃªn)

            } catch (error) {
                console.error('Failed to fetch order details:', error);
                setFetchError(error.message || 'KhÃ´ng thá»ƒ táº£i chi tiáº¿t Ä‘Æ¡n hÃ ng. Vui lÃ²ng thá»­ láº¡i.');
                setOrder(null); // Äáº£m báº£o reset khi cÃ³ lá»—i
                setVariantDetails({});
            } finally {
                setLoading(false);
            }
        };

        // --- Logic chÃ­nh cá»§a useEffect ---
        if (open && orderId) {
            performFetchOrderDetails();
        } else if (!open) {
            // Reset state khi drawer Ä‘Ã³ng
            setOrder(null);
            setVariantDetails({});
            setFetchError(null);
            setExporting(false);
            // KhÃ´ng cáº§n gá»i setExportStatus á»Ÿ Ä‘Ã¢y vÃ¬ nÃ³ chá»‰ liÃªn quan Ä‘áº¿n thÃ´ng bÃ¡o export
        }

    // Máº£ng phá»¥ thuá»™c cá»§a useEffect nÃ y CHá»ˆ NÃŠN chá»©a `open` vÃ  `orderId`.
    // CÃ¡c hÃ m fetch Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a bÃªn trong nÃªn khÃ´ng cáº§n Ä‘Æ°a vÃ o Ä‘Ã¢y.
    }, [open, orderId]);


    // --- CÃ¡c handlers khÃ¡c cÃ³ thá»ƒ giá»¯ nguyÃªn useCallback vÃ¬ chÃºng khÃ´ng gÃ¢y ra vÃ²ng láº·p vá»›i useEffect chÃ­nh ---
    const handleExport = useCallback(async (exportType, endpoint, fileExtension, mimeType) => {
        if (!orderId || exporting || !order) { // ThÃªm kiá»ƒm tra !order
            setExportStatus({ open: true, message: 'KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘Æ¡n hÃ ng Ä‘á»ƒ xuáº¥t.', severity: 'warning' });
            return;
        }

        setExporting(true);
        setExportStatus({ open: false, message: '', severity: 'info' });

        try {
            const response = await axios.get(
                `${process.env.REACT_APP_API_BASE_URL}/api/orders/${orderId}/export/${endpoint}`,
                { responseType: 'blob' }
            );
            const blob = new Blob([response.data], { type: mimeType });
            if (blob.size === 0) {
                throw new Error(`Server tráº£ vá» file ${fileExtension} rá»—ng.`);
            }
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `HoaDon_${orderId}.${fileExtension}`);
            document.body.appendChild(link);
            link.click();
            link.remove();
            window.URL.revokeObjectURL(url);
            setExportStatus({ open: true, message: `Xuáº¥t file ${fileExtension.toUpperCase()} thÃ nh cÃ´ng!`, severity: 'success' });
        } catch (error) {
            console.error(`Failed to export ${fileExtension}:`, error);
            let errorMessage = `Xuáº¥t file ${fileExtension.toUpperCase()} tháº¥t báº¡i.`;
            if (error.response) {
                try {
                    const errorJson = JSON.parse(await error.response.data.text());
                    errorMessage = errorJson.message || errorMessage;
                } catch (parseError) { /* DÃ¹ng message máº·c Ä‘á»‹nh */ }
            } else if (error.message) {
                errorMessage = error.message;
            }
            setExportStatus({ open: true, message: errorMessage, severity: 'error' });
        } finally {
            setExporting(false);
        }
    }, [orderId, exporting, order]); // ThÃªm order vÃ o dependency Ä‘á»ƒ kiá»ƒm tra trÆ°á»›c khi export

    const handleCloseSnackbar = useCallback((event, reason) => {
        if (reason === 'clickaway') {
            return;
        }
        setExportStatus(prev => ({ ...prev, open: false }));
    }, []);


    // --- Pháº§n JSX giá»¯ nguyÃªn cáº¥u trÃºc cÅ© ---
    return (
        <>
            <Drawer
                anchor="right"
                open={open}
                onClose={onClose} // onClose nÃ y lÃ  prop tá»« OrdersTable, Ä‘Ã£ Ä‘Æ°á»£c useCallback
                PaperProps={{
                    sx: { width: { xs: '95%', sm: '70%', md: '50%' }, maxWidth: '700px' },
                }}
            >
                <Box sx={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
                    {/* Header */}
                    <Box sx={{ p: 2, display: 'flex', justifyContent: 'space-between', alignItems: 'center', borderBottom: '1px solid #eee' }}>
                        <Typography variant="h6" fontWeight="bold">
                            Chi tiáº¿t Ä‘Æ¡n hÃ ng #{order?.id || orderId}
                        </Typography>
                        <IconButton onClick={onClose} size="small">
                            <Close />
                        </IconButton>
                    </Box>

                    {/* NÃºt xuáº¥t hÃ³a Ä‘Æ¡n */}
                    <Box sx={{ p: 2 }}>
                        <Typography variant="subtitle2" gutterBottom fontWeight="medium">
                            Xuáº¥t hÃ³a Ä‘Æ¡n:
                        </Typography>
                        <ButtonGroup fullWidth variant="outlined" disabled={exporting || !order || loading}>
                            <Button
                                startIcon={exporting ? <CircularProgress size={20} color="inherit" /> : <InsertDriveFile />}
                                onClick={() => handleExport('excel', 'excel', 'xlsx', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')}
                                disabled={exporting || !order} // Kiá»ƒm tra order trÆ°á»›c khi export
                                color="success"
                            >
                                Excel
                            </Button>
                            <Button
                                startIcon={exporting ? <CircularProgress size={20} color="inherit" /> : <Receipt />}
                                onClick={() => handleExport('image', 'image', 'png', 'image/png')}
                                disabled={exporting || !order}
                                color="error"
                            >
                                áº¢nh
                            </Button>
                            <Button
                                startIcon={exporting ? <CircularProgress size={20} color="inherit" /> : <PictureAsPdf />}
                                onClick={() => handleExport('template', 'template', 'pdf', 'application/pdf')}
                                disabled={exporting || !order}
                                color="primary"
                            >
                                PDF
                            </Button>
                        </ButtonGroup>
                    </Box>
                    <Divider />

                    {/* Content Area */}
                    <Box sx={{ flexGrow: 1, overflowY: 'auto', p: 2 }}>
                        {loading && (
                            <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '200px' }}>
                                <CircularProgress />
                            </Box>
                        )}
                        {fetchError && !loading && (
                            <Alert severity="error" sx={{ m: 2 }}>{fetchError}</Alert>
                        )}
                        {!loading && !fetchError && order && (
                            <>
                                {/* ThÃ´ng tin chung */}
                                <Box sx={{ mb: 3 }}>
                                    <Typography variant="subtitle1" gutterBottom fontWeight="bold">
                                        ThÃ´ng tin Ä‘Æ¡n hÃ ng
                                    </Typography>
                                    <Grid container spacing={1.5}>
                                        <Grid item xs={12} sm={6}>
                                            <Typography variant="body2" color="text.secondary">MÃ£ Ä‘Æ¡n hÃ ng:</Typography>
                                            <Typography variant="body1" fontWeight="medium">{order.id}</Typography>
                                        </Grid>
                                        <Grid item xs={12} sm={6}>
                                            <Typography variant="body2" color="text.secondary">NgÃ y Ä‘áº·t:</Typography>
                                            <Typography variant="body1" fontWeight="medium">{formatDate(order.orderDate)}</Typography>
                                        </Grid>
                                        <Grid item xs={12} sm={6}>
                                            <Typography variant="body2" color="text.secondary">Tá»•ng tiá»n:</Typography>
                                            <Typography variant="body1" fontWeight="medium" color="error">
                                                {formatCurrency(order.totalAmount)}
                                            </Typography>
                                        </Grid>
                                        <Grid item xs={12} sm={6}>
                                            <Typography variant="body2" color="text.secondary">Thanh toÃ¡n:</Typography>
                                            <Typography variant="body1" fontWeight="medium">
                                                {getPaymentMethodName(order.paymentMethodId)}
                                            </Typography>
                                        </Grid>
                                        <Grid item xs={12} sm={6}>
                                            <Typography variant="body2" color="text.secondary">Tráº¡ng thÃ¡i:</Typography>
                                            <Chip
                                                label={order.orderStatus || 'Unknown'}
                                                color={getStatusColor(order.orderStatus)} // getStatusColor cáº§n Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a hoáº·c import
                                                size="small"
                                            />
                                        </Grid>
                                        <Grid item xs={12}>
                                            <Typography variant="body2" color="text.secondary">Äá»‹a chá»‰ giao hÃ ng:</Typography>
                                            <Box sx={{ pl: 1 }}>
                                                <Typography variant="body1" fontWeight="medium">
                                                    {order.address?.fullName || 'N/A'} - {order.address?.phoneNumber || 'N/A'}
                                                </Typography>
                                                <Typography variant="body2" color="text.secondary">
                                                    {formatAddress(order.address)}
                                                </Typography>
                                            </Box>
                                        </Grid>
                                    </Grid>
                                </Box>

                                {/* Danh sÃ¡ch sáº£n pháº©m */}
                                <Box>
                                    <Typography variant="subtitle1" gutterBottom fontWeight="bold">
                                        Sáº£n pháº©m ({order.items?.length || 0})
                                    </Typography>
                                    <Divider sx={{ mb: 1 }} />
                                    {order.items?.length > 0 ? (
                                        <List disablePadding>
                                            {order.items.map((item) => (
                                                <OrderDetailItem
                                                    key={item.id || item.variantId}
                                                    item={item}
                                                    variantDetail={variantDetails[item.variantId]}
                                                />
                                            ))}
                                        </List>
                                    ) : (
                                        <Typography variant="body2" color="text.secondary" sx={{ mt: 2 }}>
                                            KhÃ´ng cÃ³ sáº£n pháº©m trong Ä‘Æ¡n hÃ ng.
                                        </Typography>
                                    )}
                                </Box>
                            </>
                        )}
                        {!loading && !fetchError && !order && (
                            <Alert severity="warning" sx={{ m: 2 }}>KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin cho Ä‘Æ¡n hÃ ng nÃ y hoáº·c Ä‘Æ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c Ä‘Ã³ng.</Alert>
                        )}
                    </Box>
                </Box>
            </Drawer>

            <Snackbar
                open={exportStatus.open}
                autoHideDuration={6000}
                onClose={handleCloseSnackbar}
                anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}
            >
                <Alert onClose={handleCloseSnackbar} severity={exportStatus.severity} sx={{ width: '100%' }} variant="filled">
                    {exportStatus.message}
                </Alert>
            </Snackbar>
        </>
    );
};

export default OrderDetailDrawer;
```

### ClientApp\src\components\Admin\orders\OrderDetailItem.jsx
```jsx
import React from 'react';
import { Box, Typography, ListItem, ListItemText, ListItemAvatar, Avatar } from '@mui/material';
// Import cÃ¡c hÃ m tiá»‡n Ã­ch náº¿u cáº§n (vÃ­ dá»¥ formatCurrency)
import { formatCurrency } from '../../../utils/FormatInfo'; // Giáº£ sá»­ báº¡n táº¡o file utils.js

const OrderDetailItem = React.memo(({ item, variantDetail }) => {
  const product = variantDetail?.product || {};
  const variant = variantDetail?.variant || {};
  const images = variantDetail?.images || [];

  // TÃ¬m áº£nh chÃ­nh hoáº·c áº£nh Ä‘áº§u tiÃªn
  const primaryImage = images.find(img => img.isPrimary) || images[0];
  const imageUrl = primaryImage
    ? `${process.env.REACT_APP_API_BASE_URL}${primaryImage.imageUrl}`
    : 'https://via.placeholder.com/80?text=No+Image'; // Placeholder rÃµ rÃ ng hÆ¡n

  return (
    <ListItem
      sx={{ px: 0, py: 2, flexDirection: 'column', alignItems: 'flex-start', borderBottom: '1px dashed #eee' }}
    >
      <Box sx={{ display: 'flex', width: '100%', mb: 1 }}>
        <ListItemAvatar sx={{ mr: 1 }}>
          <Avatar
            src={imageUrl}
            alt={product.name || 'Sáº£n pháº©m'}
            variant="square"
            sx={{ width: 80, height: 80, borderRadius: '4px', backgroundColor: '#f5f5f5' }}
            imgProps={{ loading: 'lazy' }} // ThÃªm lazy loading cho áº£nh
            onError={(e) => { // Xá»­ lÃ½ lá»—i táº£i áº£nh tá»‘t hÆ¡n
              e.target.onerror = null;
              e.target.src = 'https://via.placeholder.com/80?text=Error';
            }}
          />
        </ListItemAvatar>
        <ListItemText
          primary={
            <Typography variant="body1" fontWeight="medium" sx={{ mb: 0.5 }}>
              {product.name || 'Sáº£n pháº©m khÃ´ng xÃ¡c Ä‘á»‹nh'}
            </Typography>
          }
          secondary={
            <>
              <Typography variant="body2" color="text.secondary">
                PhÃ¢n loáº¡i: {variant.color || 'N/A'} - {variant.storage || 'N/A'}
              </Typography>
              <Typography variant="body2" color="text.secondary">
                SKU: {variant.sku || 'N/A'}
              </Typography>
            </>
          }
        />
        <Box sx={{ textAlign: 'right', ml: 1, minWidth: '100px' }}>
          <Typography variant="body2" color="text.secondary">
            {item.quantity} Ã— {formatCurrency(item.price)}
          </Typography>
          <Typography variant="body1" fontWeight="bold">
            {formatCurrency(item.quantity * item.price)}
          </Typography>
        </Box>
      </Box>

      {/* CÃ³ thá»ƒ thÃªm thÃ´ng tin chi tiáº¿t khÃ¡c náº¿u cáº§n */}
      {/* <Box sx={{ pl: { xs: 0, sm: '96px' }, width: '100%', mt: 1 }}> // Äiá»u chá»‰nh padding left
          <Typography variant="caption" color="text.secondary">
              <strong>GiÃ¡ gá»‘c:</strong> {formatCurrency(variant.price)}
              {variant.discountPrice && ` | <strong>GiÃ¡ giáº£m:</strong> ${formatCurrency(variant.discountPrice)}`}
          </Typography>
      </Box> */}
    </ListItem>
  );
});

export default OrderDetailItem;
```

### ClientApp\src\components\Admin\orders\OrderDistribution.jsx
```jsx
import { motion } from "framer-motion";
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } from "recharts";

const orderStatusData = [
	{ name: "Pending", value: 30 },
	{ name: "Processing", value: 45 },
	{ name: "Shipped", value: 60 },
	{ name: "Delivered", value: 120 },
];
const COLORS = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#FED766", "#2AB7CA"];

const OrderDistribution = () => {
	return (
		<motion.div
			className='bg-gray-800 bg-opacity-50 backdrop-blur-md shadow-lg rounded-xl p-6 border border-gray-700'
			initial={{ opacity: 0, y: 20 }}
			animate={{ opacity: 1, y: 0 }}
			transition={{ delay: 0.3 }}
		>
			<h2 className='text-xl font-semibold text-gray-100 mb-4'>Order Status Distribution</h2>
			<div style={{ width: "100%", height: 300 }}>
				<ResponsiveContainer>
					<PieChart>
						<Pie
							data={orderStatusData}
							cx='50%'
							cy='50%'
							outerRadius={80}
							fill='#8884d8'
							dataKey='value'
							label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
						>
							{orderStatusData.map((entry, index) => (
								<Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
							))}
						</Pie>
						<Tooltip
							contentStyle={{
								backgroundColor: "rgba(31, 41, 55, 0.8)",
								borderColor: "#4B5563",
							}}
							itemStyle={{ color: "#E5E7EB" }}
						/>
						<Legend />
					</PieChart>
				</ResponsiveContainer>
			</div>
		</motion.div>
	);
};
export default OrderDistribution;

```

### ClientApp\src\components\Admin\orders\OrderItem.jsx
```jsx
import React from 'react';
import { Box, FormControl, InputLabel, Select, TextField, Button } from '@mui/material';

// Sá»­ dá»¥ng React.memo Ä‘á»ƒ trÃ¡nh render láº¡i khÃ´ng cáº§n thiáº¿t khi props khÃ´ng Ä‘á»•i
const OrderItem = React.memo(({ item, index, productVariantOptions, onChange, onRemove }) => {
    const handleFieldChange = (field, value) => {
        // Chuyá»ƒn Ä‘á»•i kiá»ƒu dá»¯ liá»‡u phÃ¹ há»£p
        const processedValue = field === 'quantity' ? parseInt(value, 10) || 0 :
                              field === 'price' ? parseFloat(value) || 0 :
                              value;
        onChange(index, field, processedValue);
    };

    return (
        <Box sx={{ mb: 2, p: 2, border: '1px solid #ddd', borderRadius: 1 }}>
            <FormControl fullWidth margin="normal">
                <InputLabel>Sáº£n pháº©m</InputLabel>
                <Select
                    value={item.productVariantId}
                    onChange={(e) => handleFieldChange('productVariantId', e.target.value)}
                    label="Sáº£n pháº©m"
                >
                    {/* Sá»­ dá»¥ng options Ä‘Ã£ Ä‘Æ°á»£c memoized */}
                    {productVariantOptions}
                </Select>
            </FormControl>

            <TextField
                fullWidth
                margin="normal"
                type="number"
                label="Sá»‘ lÆ°á»£ng"
                value={item.quantity}
                onChange={(e) => handleFieldChange('quantity', e.target.value)}
                inputProps={{ min: 0 }} // ThÃªm rÃ ng buá»™c sá»‘ lÆ°á»£ng khÃ´ng Ã¢m
            />

            <TextField
                fullWidth
                margin="normal"
                type="number"
                label="ÄÆ¡n giÃ¡"
                value={item.price}
                onChange={(e) => handleFieldChange('price', e.target.value)}
                 inputProps={{ min: 0 }} // ThÃªm rÃ ng buá»™c giÃ¡ khÃ´ng Ã¢m
            />

            <Button
                variant="outlined"
                color="error"
                onClick={() => onRemove(index)}
                sx={{ mt: 1 }}
            >
                XÃ³a sáº£n pháº©m
            </Button>
        </Box>
    );
});

export default OrderItem;
```

### ClientApp\src\components\Admin\orders\OrdersTable.jsx
```jsx
import { useState, useEffect, useMemo, useCallback } from "react";
import { motion } from "framer-motion";
import { Search, Eye, Edit, Trash2, Filter, X } from "lucide-react";
import axios from "axios";
import { Modal, Box, Typography, Button, Select, MenuItem } from "@mui/material";
import OrderDetailDrawer from './OrderDetailDrawer';
import EditOrder from './EditOrder'; 
import useDebounce from 'utils/useDebounce'; // Giáº£ sá»­ báº¡n Ä‘Ã£ táº¡o hook nÃ y
import { getDateNDaysAgo, getToday } from 'utils/FormatInfo'; // Giáº£ sá»­ báº¡n Ä‘Ã£ táº¡o cÃ¡c hÃ m nÃ y

const OrdersTable = () => {
    const [orders, setOrders] = useState([]);
    const [currentPage, setCurrentPage] = useState(1);
    const [selectedOrder, setSelectedOrder] = useState(null);
    const [newStatus, setNewStatus] = useState("");
    const [openModal, setOpenModal] = useState(false);
    const [selectedOrderId, setSelectedOrderId] = useState(null);
    const [drawerOpen, setDrawerOpen] = useState(false);
    const [showAdvancedFilters, setShowAdvancedFilters] = useState(false);
    const [isEditDrawerOpen, setIsEditDrawerOpen] = useState(false);
    const [orderToEdit, setOrderToEdit] = useState(null);

    // States cho viá»‡c tÃ¬m kiáº¿m vÃ  lá»c
    const [searchInput, setSearchInput] = useState(""); // GiÃ¡ trá»‹ input tá»©c thá»i
    const debouncedSearchTerm = useDebounce(searchInput, 500); // GiÃ¡ trá»‹ Ä‘Ã£ debounce
    const [statusFilter, setStatusFilter] = useState("All");
    const [startDate, setStartDate] = useState("");
    const [endDate, setEndDate] = useState("");
    const [minAmount, setMinAmount] = useState("");
    const [maxAmount, setMaxAmount] = useState("");

    const ordersPerPage = 5;

    // HÃ m tiá»‡n Ã­ch (khÃ´ng Ä‘á»•i, cÃ³ thá»ƒ Ä‘áº·t ngoÃ i component náº¿u khÃ´ng phá»¥ thuá»™c state/props)
    const getAllowedStatuses = useCallback((currentStatus) => {
        switch (currentStatus) {
            case "Pending": return ["Processing", "Cancelled"];
            case "Processing": return ["Shipped", "Cancelled"];
            case "Shipped": return ["Delivered"];
            case "WaitingForPayment": return ["Paid", "Cancelled"];
            case "Paid": return ["ShippedPayment"];
            case "ShippedPayment": return ["Delivered"];
            default: return [];
        }
    }, []);

    const getStatusDisplayName = useCallback((status) => {
        switch (status) {
            case "Pending": return "Chá» xÃ¡c nháº­n";
            case "Processing": return "ÄÃ£ xÃ¡c nháº­n";
            case "Shipped": return "Äang váº­n chuyá»ƒn";
            case "Delivered": return "ÄÃ£ xong";
            case "Cancelled": return "ÄÃ£ há»§y";
            case "WaitingForPayment": return "Chá» thanh toÃ¡n";
            case "Paid": return "ÄÃ£ thanh toÃ¡n";
            case "ShippedPayment": return "Äang váº­n chuyá»ƒn (Ä‘Ã£ thanh toÃ¡n)";
            default: return status;
        }
    }, []);

    // Fetch dá»¯ liá»‡u ban Ä‘áº§u
    useEffect(() => {
        const fetchOrders = async () => {
            try {
                const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/orders`);
                const ordersWithCustomerNames = await Promise.all(
                    response.data.map(async (order) => {
                        try {
                            const addressResponse = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/address/${order.addressId}`);
                            order.customer = addressResponse.data.fullName;
                        } catch (error) {
                            console.error(`Lá»—i khi láº¥y dá»¯ liá»‡u Ä‘á»‹a chá»‰ vá»›i ID ${order.addressId}:`, error);
                            order.customer = "Unknown";
                        }
                        return order;
                    })
                );
                setOrders(ordersWithCustomerNames);
            } catch (error) {
                console.error("Lá»—i khi láº¥y dá»¯ liá»‡u Ä‘Æ¡n hÃ ng:", error);
            }
        };
        fetchOrders();
    }, []); // Chá»‰ cháº¡y má»™t láº§n khi mount

    const handleOpenEditDrawer = useCallback((order) => {
        // console.log("Opening edit drawer for order:", order);
        setOrderToEdit(order); // LÆ°u Ä‘Æ¡n hÃ ng cáº§n sá»­a
        setIsEditDrawerOpen(true); // Má»Ÿ drawer
    }, []);

    const handleCloseEditDrawer = useCallback(() => {
        setIsEditDrawerOpen(false);
        setOrderToEdit(null); // XÃ³a Ä‘Æ¡n hÃ ng Ä‘ang sá»­a khi Ä‘Ã³ng drawer
    }, []);
    const handleOrderUpdated = useCallback((updatedOrder) => {
        // Cáº­p nháº­t láº¡i danh sÃ¡ch 'orders' vá»›i thÃ´ng tin Ä‘Æ¡n hÃ ng má»›i
        setOrders(prevOrders =>
            prevOrders.map(order =>
                order.id === updatedOrder.id ? { ...order, ...updatedOrder } : order
            )
        );
        // filteredOrders sáº½ tá»± Ä‘á»™ng cáº­p nháº­t nhá» useMemo
        // EditOrder sáº½ tá»± gá»i onClose cá»§a nÃ³ (chÃ­nh lÃ  handleCloseEditDrawer) sau khi cáº­p nháº­t thÃ nh cÃ´ng
        // nÃªn khÃ´ng cáº§n gá»i setIsEditDrawerOpen(false) á»Ÿ Ä‘Ã¢y ná»¯a.
        alert("ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t thÃ nh cÃ´ng trong báº£ng!"); // Optional: thÃ´ng bÃ¡o á»Ÿ OrdersTable
    }, [setOrders]); // setOrders lÃ  stable
    // Sá»­ dá»¥ng useMemo Ä‘á»ƒ tÃ­nh toÃ¡n danh sÃ¡ch Ä‘Æ¡n hÃ ng Ä‘Ã£ lá»c
    const filteredOrders = useMemo(() => {
        let filtered = [...orders];
        const term = debouncedSearchTerm.toLowerCase();

        if (term) {
            filtered = filtered.filter(
                (order) =>
                    order.id.toString().toLowerCase().includes(term) ||
                    order.customer.toLowerCase().includes(term)
            );
        }
        if (statusFilter !== "All") {
            filtered = filtered.filter((order) => order.orderStatus === statusFilter);
        }
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999); // Äá»ƒ bao gá»“m cáº£ ngÃ y káº¿t thÃºc
            filtered = filtered.filter(order => {
                const orderDate = new Date(order.orderDate);
                return orderDate >= start && orderDate <= end;
            });
        }
        if (minAmount || maxAmount) {
            const min = minAmount ? parseFloat(minAmount) : 0;
            const max = maxAmount ? parseFloat(maxAmount) : Infinity;
            filtered = filtered.filter(order => {
                const amount = order.totalAmount || 0;
                return amount >= min && amount <= max;
            });
        }
        return filtered;
    }, [orders, debouncedSearchTerm, statusFilter, startDate, endDate, minAmount, maxAmount]);

    // Reset vá» trang Ä‘áº§u tiÃªn khi bá»™ lá»c thay Ä‘á»•i
    useEffect(() => {
        setCurrentPage(1);
    }, [debouncedSearchTerm, statusFilter, startDate, endDate, minAmount, maxAmount]);


    const currentOrders = useMemo(() => {
        const indexOfLastOrder = currentPage * ordersPerPage;
        const indexOfFirstOrder = indexOfLastOrder - ordersPerPage;
        return filteredOrders.slice(indexOfFirstOrder, indexOfLastOrder);
    }, [filteredOrders, currentPage, ordersPerPage]);

    const totalPages = useMemo(() => {
        return Math.ceil(filteredOrders.length / ordersPerPage);
    }, [filteredOrders.length, ordersPerPage]);

    // Callbacks Ä‘Æ°á»£c memoize vá»›i useCallback
    const handleSearchChange = useCallback((e) => {
        setSearchInput(e.target.value);
    }, []);

    const handleStatusFilterChange = useCallback((e) => {
        setStatusFilter(e.target.value);
    }, []);
    
    const handleStartDateChange = useCallback((e) => {
        setStartDate(e.target.value);
    }, []);

    const handleEndDateChange = useCallback((e) => {
        setEndDate(e.target.value);
    }, []);

    const handleMinAmountChange = useCallback((e) => {
        setMinAmount(e.target.value);
    }, []);

    const handleMaxAmountChange = useCallback((e) => {
        setMaxAmount(e.target.value);
    }, []);
    
    // NÃºt "Ãp dá»¥ng bá»™ lá»c" khÃ´ng cÃ²n thá»±c sá»± cáº§n thiáº¿t náº¿u cÃ¡c filter Ã¡p dá»¥ng ngay,
    // nhÆ°ng náº¿u muá»‘n giá»¯ láº¡i Ä‘á»ƒ Ã¡p dá»¥ng Ä‘á»“ng thá»i cÃ¡c filter ngÃ y/giÃ¡ thÃ¬ cÃ³ thá»ƒ dÃ¹ng.
    // Hiá»‡n táº¡i, logic filter Ä‘Ã£ Ä‘Æ°á»£c useMemo xá»­ lÃ½ khi state thay Ä‘á»•i.
    // TÃ´i sáº½ Ä‘á»ƒ láº¡i hÃ m handleDateFilter trá»‘ng hoáº·c báº¡n cÃ³ thá»ƒ bá» nÃºt nÃ y.
    // const handleApplyAdvancedFilters = useCallback(() => {
    //     // CÃ¡c state Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t, useMemo sáº½ tá»± tÃ­nh toÃ¡n láº¡i filteredOrders
    //     // Chá»‰ cáº§n reset láº¡i trang náº¿u cáº§n
    //     setCurrentPage(1);
    //     console.log("Applying advanced filters (filters already applied by state changes)");
    // }, []);


    const handlePageChange = useCallback((pageNumber) => {
        setCurrentPage(pageNumber);
    }, []);

    const handleDeleteOrder = useCallback(async (orderId) => {
        if (window.confirm("Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a Ä‘Æ¡n hÃ ng nÃ y khÃ´ng?")) {
            try {
                await axios.delete(`${process.env.REACT_APP_API_BASE_URL}/api/orders/${orderId}`);
                setOrders(prevOrders => prevOrders.filter(order => order.id !== orderId));
                // filteredOrders sáº½ tá»± cáº­p nháº­t nhá» useMemo
                alert("ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c xÃ³a thÃ nh cÃ´ng!");
            } catch (error) {
                console.error("Lá»—i khi xÃ³a Ä‘Æ¡n hÃ ng:", error);
                alert("Lá»—i khi xÃ³a Ä‘Æ¡n hÃ ng, vui lÃ²ng thá»­ láº¡i.");
            }
        }
    }, []);

    const handleOpenModal = useCallback((order) => {
        setSelectedOrder(order);
        setNewStatus(order.orderStatus); // Khá»Ÿi táº¡o newStatus báº±ng tráº¡ng thÃ¡i hiá»‡n táº¡i
        setOpenModal(true);
    }, []);

    const handleCloseModal = useCallback(() => {
        setOpenModal(false);
        setSelectedOrder(null);
    }, []);

    const handleUpdateStatus = useCallback(async () => {
        if (selectedOrder && newStatus && newStatus !== selectedOrder.orderStatus) {
            try {
                await axios.put(`${process.env.REACT_APP_API_BASE_URL}/api/orders/${selectedOrder.id}/status`, { newStatus });
                setOrders(prevOrders =>
                    prevOrders.map(order =>
                        order.id === selectedOrder.id ? { ...order, orderStatus: newStatus } : order
                    )
                );
                alert("Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t thÃ nh cÃ´ng!");
                handleCloseModal();
            } catch (error) {
                console.error("Lá»—i khi cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng:", error);
                alert("Lá»—i khi cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng, vui lÃ²ng thá»­ láº¡i.");
            }
        }
    }, [selectedOrder, newStatus, handleCloseModal]);


    // === Bá»” SUNG HÃ€M Xá»¬ LÃ CHO CÃC Bá»˜ Lá»ŒC NGÃ€Y Má»šI ===
    const handleSetDateRangeAndResetFilters = useCallback((startDateStr, endDateStr) => {
        setStartDate(startDateStr);
        setEndDate(endDateStr);
        setSearchInput(""); // Reset cÃ¡c filter khÃ¡c Ä‘á»ƒ Æ°u tiÃªn filter ngÃ y
        setStatusFilter("All");
        setMinAmount("");
        setMaxAmount("");
        // setCurrentPage(1) sáº½ Ä‘Æ°á»£c xá»­ lÃ½ bá»Ÿi useEffect Ä‘Ã£ cÃ³
    }, [setStartDate, setEndDate, setSearchInput, setStatusFilter, setMinAmount, setMaxAmount]);


    const handleTodayOrders = useCallback(() => {
        const todayStr = getToday();
        handleSetDateRangeAndResetFilters(todayStr, todayStr);
    }, [handleSetDateRangeAndResetFilters]);

    const handleLast3DaysOrders = useCallback(() => {
        const todayStr = getToday();
        const threeDaysAgoStr = getDateNDaysAgo(2); // Bao gá»“m hÃ´m nay, nÃªn lÃ  (hÃ´m nay - 2 ngÃ y) Ä‘áº¿n hÃ´m nay
        handleSetDateRangeAndResetFilters(threeDaysAgoStr, todayStr);
    }, [handleSetDateRangeAndResetFilters]);

    const handleLast7DaysOrders = useCallback(() => {
        const todayStr = getToday();
        const sevenDaysAgoStr = getDateNDaysAgo(6); // Bao gá»“m hÃ´m nay, nÃªn lÃ  (hÃ´m nay - 6 ngÃ y) Ä‘áº¿n hÃ´m nay
        handleSetDateRangeAndResetFilters(sevenDaysAgoStr, todayStr);
    }, [handleSetDateRangeAndResetFilters])


    const handleResetFilters = useCallback(() => {
        setSearchInput("");
        setStatusFilter("All");
        setStartDate("");
        setEndDate("");
        setMinAmount("");
        setMaxAmount("");
        // filteredOrders sáº½ tá»± cáº­p nháº­t
    }, []);

    const handleViewOrder = useCallback((orderId) => {
        setSelectedOrderId(orderId);
        setDrawerOpen(true);
    }, []);

    const handleCloseDrawer = useCallback(() => {
        setDrawerOpen(false);
        setSelectedOrderId(null); // Reset selectedOrderId khi Ä‘Ã³ng drawer
    }, []);


    return (
        <motion.div
            className="bg-gray-800 bg-opacity-50 backdrop-blur-md shadow-lg rounded-xl p-6 border border-gray-700"
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.4 }}
        >
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-semibold text-gray-100">Danh sÃ¡ch Ä‘Æ¡n hÃ ng</h2>
                <div className="flex items-center space-x-4">
                    <div className="relative">
                        <input
                            type="text"
                            placeholder="TÃ¬m Ä‘Æ¡n hÃ ng (ID, KhÃ¡ch hÃ ng)..."
                            className="bg-gray-700 text-white placeholder-gray-400 rounded-lg pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            value={searchInput}
                            onChange={handleSearchChange}
                        />
                        <Search className="absolute left-3 top-2.5 text-gray-400" size={18} />
                    </div>
                    <button
                        className={`flex items-center space-x-1 px-3 py-2 rounded-lg ${showAdvancedFilters ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
                        onClick={() => setShowAdvancedFilters(!showAdvancedFilters)}
                    >
                        <Filter size={18} />
                        <span>Bá»™ lá»c</span>
                    </button>
                </div>
            </div>

            {showAdvancedFilters && (
                <motion.div
                    className="bg-gray-700 p-4 rounded-lg mb-6"
                    initial={{ opacity: 0, height: 0 }}
                    animate={{ opacity: 1, height: 'auto' }}
                    exit={{ opacity: 0, height: 0 }}
                    transition={{ duration: 0.3 }}
                >
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-medium text-gray-300">Bá»™ lá»c nÃ¢ng cao</h3>
                        <button
                            className="text-gray-400 hover:text-white"
                            onClick={() => setShowAdvancedFilters(false)}
                        >
                            <X size={20} />
                        </button>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-400 mb-1">Tráº¡ng thÃ¡i</label>
                            <select
                                className="w-full bg-gray-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                value={statusFilter}
                                onChange={handleStatusFilterChange}
                            >
                                <option value="All">Táº¥t cáº£ tráº¡ng thÃ¡i</option>
                                <option value="Pending">{getStatusDisplayName("Pending")}</option>
                                <option value="Processing">{getStatusDisplayName("Processing")}</option>
                                <option value="Shipped">{getStatusDisplayName("Shipped")}</option>
                                <option value="Delivered">{getStatusDisplayName("Delivered")}</option>
                                <option value="Cancelled">{getStatusDisplayName("Cancelled")}</option>
                                <option value="WaitingForPayment">{getStatusDisplayName("WaitingForPayment")}</option>
                                <option value="Paid">{getStatusDisplayName("Paid")}</option>
                                <option value="ShippedPayment">{getStatusDisplayName("ShippedPayment")}</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-400 mb-1">Tá»« ngÃ y</label>
                            <input
                                type="date"
                                className="w-full bg-gray-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                value={startDate}
                                onChange={handleStartDateChange}
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-400 mb-1">Äáº¿n ngÃ y</label>
                            <input
                                type="date"
                                className="w-full bg-gray-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                value={endDate}
                                onChange={handleEndDateChange}
                                min={startDate} // NgÄƒn chá»n ngÃ y káº¿t thÃºc trÆ°á»›c ngÃ y báº¯t Ä‘áº§u
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-400 mb-1">Khoáº£ng giÃ¡</label>
                            <div className="flex space-x-2">
                                <input
                                    type="number"
                                    placeholder="Tá»«"
                                    className="w-1/2 bg-gray-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    value={minAmount}
                                    onChange={handleMinAmountChange}
                                />
                                <input
                                    type="number"
                                    placeholder="Äáº¿n"
                                    className="w-1/2 bg-gray-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    value={maxAmount}
                                    onChange={handleMaxAmountChange}
                                />
                            </div>
                        </div>
                    </div>

                    <div className="flex justify-end space-x-3 mt-6">
                        {/* NÃºt nÃ y cÃ³ thá»ƒ khÃ´ng cáº§n thiáº¿t náº¿u filter Ä‘Ã£ tá»± Ã¡p dá»¥ng */}
                        {/* <button
                            className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg"
                            onClick={handleApplyAdvancedFilters} 
                        >
                            Ãp dá»¥ng bá»™ lá»c
                        </button> */}
                    
                        <button
                            className="bg-sky-500 hover:bg-sky-600 text-white px-4 py-2 rounded-lg text-sm"
                            onClick={handleTodayOrders}
                        >
                            ÄÆ¡n hÃ´m nay
                        </button>
                        <button
                            className="bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg text-sm"
                            onClick={handleLast3DaysOrders}
                        >
                            3 ngÃ y qua
                        </button>
                        <button
                            className="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm"
                            onClick={handleLast7DaysOrders}
                        >
                            7 ngÃ y qua
                        </button>

                        <button
                            className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg"
                            onClick={handleResetFilters}
                        >
                            XÃ³a bá»™ lá»c
                        </button>
                    </div>
                </motion.div>
            )}

            <div className="overflow-x-auto mt-6">
                <table className="min-w-full divide-y divide-gray-700">
                    <thead>
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">STT</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">KhÃ¡ch HÃ ng</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Tá»•ng tiá»n</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Tráº¡ng thÃ¡i</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">NgÃ y Ä‘áº·t</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">TÃ¹y Chá»‰nh</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-700">
                        {currentOrders.length > 0 ? (
                            currentOrders.map((order, index) => (
                                <motion.tr
                                    key={order.id}
                                    initial={{ opacity: 0 }}
                                    animate={{ opacity: 1 }}
                                    transition={{ duration: 0.2 }}
                                    className="hover:bg-gray-700"
                                >
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100">
                                        { (currentPage - 1) * ordersPerPage + index + 1}
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100">
                                        {order.customer}
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100">
                                        {order.totalAmount ? order.totalAmount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }) : "N/A"}
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                        <span
                                            className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full cursor-pointer ${
                                                order.orderStatus === "Delivered" || order.orderStatus === "Paid"
                                                ? "bg-green-200 text-green-800 hover:bg-green-300"
                                                : order.orderStatus === "Processing"
                                                ? "bg-yellow-200 text-yellow-800 hover:bg-yellow-300"
                                                : order.orderStatus === "Shipped" || order.orderStatus === "ShippedPayment"
                                                ? "bg-blue-200 text-blue-800 hover:bg-blue-300"
                                                : order.orderStatus === "Pending" || order.orderStatus === "WaitingForPayment"
                                                ? "bg-orange-200 text-orange-800 hover:bg-orange-300"
                                                : "bg-red-200 text-red-800 hover:bg-red-300" // Cancelled
                                            }`}
                                            onClick={() => handleOpenModal(order)}
                                        >
                                            {getStatusDisplayName(order.orderStatus)}
                                        </span>
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                        {new Date(order.orderDate).toLocaleDateString('vi-VN')}
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                        <button 
                                            className="text-indigo-400 hover:text-indigo-300 mr-3 p-1 rounded hover:bg-gray-600"
                                            title="Xem chi tiáº¿t"
                                            onClick={() => handleViewOrder(order.id)}
                                        >
                                            <Eye size={18} />
                                        </button>
                                        <button 
                                            className="text-yellow-400 hover:text-yellow-300 mr-3 p-1 rounded hover:bg-gray-600"
                                            title="Sá»­a Ä‘Æ¡n hÃ ng"
                                            onClick={() => handleOpenEditDrawer(order)} // Gá»i hÃ m má»Ÿ drawer sá»­a
                                        >
                                            <Edit size={18} />
                                        </button>
                                        <button 
                                            className="text-red-400 hover:text-red-300 p-1 rounded hover:bg-gray-600"
                                            title="XÃ³a Ä‘Æ¡n hÃ ng"
                                            onClick={() => handleDeleteOrder(order.id)}
                                        >
                                            <Trash2 size={18} />
                                        </button>
                                    </td>
                                </motion.tr>
                            ))
                        ) : (
                            <tr>
                                <td colSpan="6" className="px-6 py-10 text-center text-sm text-gray-400">
                                    KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng nÃ o phÃ¹ há»£p.
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>

            {filteredOrders.length > ordersPerPage && (
                 <div className="flex justify-between items-center mt-6">
                    <div className="text-sm text-gray-400">
                        Hiá»ƒn thá»‹ { (currentPage - 1) * ordersPerPage + 1} Ä‘áº¿n {Math.min(currentPage * ordersPerPage, filteredOrders.length)} trong tá»•ng sá»‘ {filteredOrders.length} Ä‘Æ¡n hÃ ng
                    </div>
                    <div className="flex space-x-2">
                        <button
                            className={`px-3 py-1 rounded-lg text-sm ${currentPage === 1 ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-gray-600 text-white hover:bg-gray-500'}`}
                            disabled={currentPage === 1}
                            onClick={() => handlePageChange(currentPage - 1)}
                        >
                            TrÆ°á»›c
                        </button>
                        {/* Logic render cÃ¡c nÃºt sá»‘ trang cÃ³ thá»ƒ phá»©c táº¡p hÆ¡n náº¿u cÃ³ nhiá»u trang */}
                        {Array.from({ length: totalPages }, (_, i) => i + 1).map(page => (
                            <button
                                key={page}
                                className={`px-3 py-1 rounded-lg text-sm ${currentPage === page ? 'bg-blue-500 text-white' : 'bg-gray-600 text-white hover:bg-gray-500'}`}
                                onClick={() => handlePageChange(page)}
                            >
                                {page}
                            </button>
                        ))}
                        <button
                            className={`px-3 py-1 rounded-lg text-sm ${currentPage === totalPages ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-gray-600 text-white hover:bg-gray-500'}`}
                            disabled={currentPage === totalPages || totalPages === 0}
                            onClick={() => handlePageChange(currentPage + 1)}
                        >
                            Sau
                        </button>
                    </div>
                </div>
            )}
           

            <Modal open={openModal} onClose={handleCloseModal}>
                <Box
                    sx={{
                        position: 'absolute', top: '50%', left: '50%',
                        transform: 'translate(-50%, -50%)', width: 400,
                        bgcolor: 'rgba(31, 41, 55, 0.95)', // bg-gray-800 with opacity
                        backdropFilter: 'blur(5px)',
                        border: '1px solid #4B5563', // border-gray-600
                        boxShadow: 24, p: 4, borderRadius: '8px', color: '#F3F4F6' // text-gray-100
                    }}
                >
                    <Typography variant="h6" component="h2" sx={{ color: '#D1D5DB' /* text-gray-300 */ }}>
                        Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng #{selectedOrder?.id}
                    </Typography>
                    <Typography variant="body2" sx={{ mt: 1, mb: 2, color: '#9CA3AF' /* text-gray-400 */ }}>
                        Tráº¡ng thÃ¡i hiá»‡n táº¡i: <strong style={{ color: '#F3F4F6' }}>{getStatusDisplayName(selectedOrder?.orderStatus)}</strong>
                    </Typography>
                    <Select
                        value={newStatus}
                        onChange={(e) => setNewStatus(e.target.value)}
                        fullWidth
                        sx={{ 
                            mt: 2, 
                            bgcolor: '#4B5563', // bg-gray-600
                            color: 'white',
                            '& .MuiSvgIcon-root': { color: 'white' },
                            '&:hover': { bgcolor: '#374151' /* bg-gray-700 */ },
                            '.MuiOutlinedInput-notchedOutline': { borderColor: '#6B7280' /* border-gray-500 */ },
                            '&.Mui-focused .MuiOutlinedInput-notchedOutline': { borderColor: '#3B82F6' /* ring-blue-500 */ },
                         }}
                        MenuProps={{
                            PaperProps: {
                                sx: {
                                    bgcolor: '#374151', // bg-gray-700 for dropdown
                                    color: 'white',
                                },
                            },
                        }}
                    >
                        {selectedOrder && getAllowedStatuses(selectedOrder.orderStatus).length > 0 ? (
                             getAllowedStatuses(selectedOrder.orderStatus).map(status => (
                                <MenuItem key={status} value={status} sx={{ '&:hover': { bgcolor: '#4B5563'} }}>
                                    {getStatusDisplayName(status)}
                                </MenuItem>
                            ))
                        ) : (
                            <MenuItem disabled sx={{ '&:hover': { bgcolor: '#4B5563'} }}>KhÃ´ng cÃ³ tráº¡ng thÃ¡i Ä‘á»ƒ chuyá»ƒn</MenuItem>
                        )}
                    </Select>
                    <Button
                        variant="contained"
                        color="primary"
                        onClick={handleUpdateStatus}
                        sx={{ 
                            mt: 3, 
                            bgcolor: '#3B82F6', /* bg-blue-500 */
                            '&:hover': { bgcolor: '#2563EB' /* hover:bg-blue-600 */},
                            '&.Mui-disabled': { bgcolor: '#4B5563', color: '#9CA3AF' }
                        }}
                        disabled={!newStatus || newStatus === selectedOrder?.orderStatus || getAllowedStatuses(selectedOrder?.orderStatus || "").length === 0}
                    >
                        Cáº­p nháº­t
                    </Button>
                </Box>
            </Modal>
            
            <OrderDetailDrawer 
                orderId={selectedOrderId}
                open={drawerOpen}
                onClose={handleCloseDrawer}
            />

<EditOrder
                    open={isEditDrawerOpen}
                    onClose={handleCloseEditDrawer}
                    order={orderToEdit} // Truyá»n Ä‘Æ¡n hÃ ng cáº§n sá»­a
                    onOrderUpdated={handleOrderUpdated} // Truyá»n callback Ä‘á»ƒ cáº­p nháº­t láº¡i báº£ng
                />
        </motion.div>
    );
};

export default OrdersTable;
```

### ClientApp\src\components\Admin\overview\CategoryDistributionChart.jsx
```jsx
import { useEffect, useState } from "react";
import { motion } from "framer-motion";
import { PieChart, Pie, Cell, Tooltip, ResponsiveContainer, Legend } from "recharts";
import axios from "axios";

const COLORS = ["#6366F1", "#8B5CF6", "#EC4899", "#10B981", "#F59E0B"];

const CategoryDistributionChart = () => {
	const [categoryData, setCategoryData] = useState([]);

	useEffect(() => {
		const fetchCategoryData = async () => {
			try {
				const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/categories/product-count`);
				setCategoryData(response.data);
			} catch (error) {
				console.error("Lá»—i khi láº¥y dá»¯ liá»‡u danh má»¥c:", error);
			}
		};

		fetchCategoryData();
	}, []);

	return (
		<motion.div
			className='bg-gray-800 bg-opacity-50 backdrop-blur-md shadow-lg rounded-xl p-6 border border-gray-700'
			initial={{ opacity: 0, y: 20 }}
			animate={{ opacity: 1, y: 0 }}
			transition={{ delay: 0.3 }}
		>
			<h2 className='text-lg font-medium mb-4 text-gray-100'>Thá»‘ng KÃª Danh Má»¥c</h2>
			<div className='h-80'>
				<ResponsiveContainer width={"100%"} height={"100%"}>
					<PieChart>
						<Pie
							data={categoryData}
							cx={"50%"}
							cy={"50%"}
							labelLine={false}
							outerRadius={80}
							fill='#8884d8'
							dataKey='value'
							label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
						>
							{categoryData.map((entry, index) => (
								<Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
							))}
						</Pie>
						<Tooltip
							contentStyle={{
								backgroundColor: "rgba(31, 41, 55, 0.8)",
								borderColor: "#4B5563",
							}}
							itemStyle={{ color: "#E5E7EB" }}
						/>
						<Legend />
					</PieChart>
				</ResponsiveContainer>
			</div>
		</motion.div>
	);
};

export default CategoryDistributionChart;

```

### ClientApp\src\components\Admin\overview\SalesChannelChart.jsx
```jsx
import { motion } from "framer-motion";
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend, Cell } from "recharts";

const COLORS = ["#6366F1", "#8B5CF6", "#EC4899", "#10B981", "#F59E0B"];

const SALES_CHANNEL_DATA = [
	{ name: "Website", value: 45600 },
	{ name: "Mobile App", value: 38200 },
	{ name: "Marketplace", value: 29800 },
	{ name: "Social Media", value: 18700 },
];

const SalesChannelChart = () => {
	return (
		<motion.div
			className='bg-gray-800 bg-opacity-50 backdrop-blur-md shadow-lg rounded-xl p-6 lg:col-span-2 border border-gray-700'
			initial={{ opacity: 0, y: 20 }}
			animate={{ opacity: 1, y: 0 }}
			transition={{ delay: 0.4 }}
		>
			<h2 className='text-lg font-medium mb-4 text-gray-100'>Sales by Channel</h2>

			<div className='h-80'>
				<ResponsiveContainer>
					<BarChart data={SALES_CHANNEL_DATA}>
						<CartesianGrid strokeDasharray='3 3' stroke='#4B5563' />
						<XAxis dataKey='name' stroke='#9CA3AF' />
						<YAxis stroke='#9CA3AF' />
						<Tooltip
							contentStyle={{
								backgroundColor: "rgba(31, 41, 55, 0.8)",
								borderColor: "#4B5563",
							}}
							itemStyle={{ color: "#E5E7EB" }}
						/>
						<Legend />
						<Bar dataKey={"value"} fill='#8884d8'>
							{SALES_CHANNEL_DATA.map((entry, index) => (
								<Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
							))}
						</Bar>
					</BarChart>
				</ResponsiveContainer>
			</div>
		</motion.div>
	);
};
export default SalesChannelChart;

```

### ClientApp\src\components\Admin\overview\SalesOverviewChart.jsx
```jsx
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from "recharts";
import { motion } from "framer-motion";
import { useEffect, useState } from "react";
import { formatCurrency } from "../../../utils/formatCurrency";

const SalesOverviewChart = () => {
  const [chartData, setChartData] = useState([]);

  useEffect(() => {
    const fetchSalesData = async () => {
      try {
        const response = await fetch(`${process.env.REACT_APP_API_BASE_URL}/api/orders/revenue-year`);
        const data = await response.json();
        
        // Chuyá»ƒn Ä‘á»•i dá»¯ liá»‡u tá»« API sang Ä‘á»‹nh dáº¡ng phÃ¹ há»£p
        const processedData = data.map(item => ({
          name: new Date(item.date).toLocaleString('default', { month: 'short' }),
          sales: item.revenue,
          fullDate: item.date,
          year: item.year
        })).sort((a, b) => new Date(a.fullDate) - new Date(b.fullDate));
        
        setChartData(processedData);
      } catch (error) {
        console.error("Error fetching sales data:", error);
      }
    };

    fetchSalesData();
  }, []);

  const formatCurrency = (value) => {
  if (value >= 1_000_000) {
    const millions = Math.floor(value / 1_000_000); // Láº¥y pháº§n triá»‡u
    const remainder = Math.floor((value % 1_000_000) / 100_000); // Láº¥y pháº§n trÄƒm ngÃ n (sau dáº¥u pháº©y)

    return remainder > 0 ? `${millions}tr${remainder}` : `${millions}tr`;
  } 
  if (value >= 1_000) {
    return `${(value / 1_000).toFixed(0)}k`; // Hiá»ƒn thá»‹ nghÃ¬n
  }
  return value.toLocaleString('vi-VN'); // Hiá»ƒn thá»‹ sá»‘ bÃ¬nh thÆ°á»ng
};


  return (
    <motion.div
      className='bg-gray-800 bg-opacity-50 backdrop-blur-md shadow-lg rounded-xl p-6 border border-gray-700'
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay: 0.2 }}
    >
      <h2 className='text-lg font-medium mb-4 text-gray-100'>Sales Overview</h2>

      <div className='h-80'>
        {chartData.length > 0 ? (
          <ResponsiveContainer width="100%" height="100%">
            <LineChart data={chartData}>
              <CartesianGrid strokeDasharray='3 3' stroke='#4B5563' opacity={0.5} />
              <XAxis 
                dataKey="name"
                stroke='#9ca3af'
                tick={{ fill: '#E5E7EB' }}
              />
              <YAxis 
  stroke='#9ca3af'
  tick={{ fill: '#E5E7EB' }}
  tickFormatter={(value) => formatCurrency(value)}
  width={80}
/>
<Tooltip
  contentStyle={{
    backgroundColor: "rgba(17, 24, 39, 0.9)",
    borderColor: "#4B5563",
    borderRadius: "0.5rem",
  }}
  itemStyle={{ color: "#E5E7EB" }}
  formatter={(value) => [formatCurrency(value), 'Revenue']}
  labelFormatter={(label) => {
    const monthData = chartData.find(item => item.name === label);
    return monthData ? `${label} ${monthData.year}` : label;
  }}
/>

              <Line
                type="monotone"
                dataKey="sales"
                stroke='#6366F1'
                strokeWidth={2}
                dot={{ fill: "#6366F1", strokeWidth: 2, r: 4 }}
                activeDot={{ r: 6, strokeWidth: 2, stroke: '#fff' }}
              />
            </LineChart>
          </ResponsiveContainer>
        ) : (
          <div className="h-full flex items-center justify-center text-gray-400">
            No sales data available
          </div>
        )}
      </div>
    </motion.div>
  );
};

export default SalesOverviewChart;
```

### ClientApp\src\components\Admin\products\AddProductDrawer.jsx
```jsx
// src/components/ProductDrawer.js
import { useEffect } from "react";
import {
  Drawer,
  IconButton,
  Select,
  MenuItem,
  Button,
  Box,
  CircularProgress,
  InputBase,
  Typography,
  Tabs,
  Tab,
  TextField,
} from "@mui/material";
import { Close } from "@mui/icons-material";
// import { useFieldArray } from "react-hook-form"; // Sáº½ Ä‘Æ°á»£c quáº£n lÃ½ trong useProductForm náº¿u cáº§n field array cho variants

// Import cÃ¡c custom hooks
import { useProductForm } from "@/hooks/api/useProductForm";
import { useProductImageManager } from "@/hooks/api/useProductImageManager";
import { useProductData } from "@/hooks/api/useProductData";

const ProductDrawer = ({ isOpen, onClose, onAddProduct }) => {
  const { categories, brands, loading: dataLoading, error: dataError } = useProductData();
  const imageManager = useProductImageManager();
  const productForm = useProductForm({
    onAddProduct,
    onClose: () => { // Khi form Ä‘Ã³ng (sau submit thÃ nh cÃ´ng hoáº·c há»§y)
      onClose(); // Gá»i prop onClose tá»« component cha
      imageManager.resetImageManager(); // Reset tráº¡ng thÃ¡i cá»§a image manager
      // productForm.resetForm() Ä‘Ã£ Ä‘Æ°á»£c gá»i bÃªn trong handleFormSubmit
    },
  });
  const { errors } = productForm.formState; 

  // Äá»“ng bá»™ láº¡i imageError tá»« imageManager lÃªn form náº¿u cáº§n thiáº¿t Ä‘á»ƒ hiá»ƒn thá»‹ táº­p trung
  // Hoáº·c báº¡n cÃ³ thá»ƒ hiá»ƒn thá»‹ imageError.message trá»±c tiáº¿p tá»« imageManager.imageError

  const handleMainSubmit = async (formData) => {
    imageManager.setImageError(""); // XÃ³a lá»—i áº£nh cÅ© trÆ°á»›c khi submit
    const { images: processedImages, error: imageProcessingError } = await imageManager.processImagesForSubmission();

    if (imageProcessingError) {
      // Hiá»ƒn thá»‹ lá»—i xá»­ lÃ½ áº£nh, productForm.setError cÃ³ thá»ƒ dÃ¹ng á»Ÿ Ä‘Ã¢y náº¿u báº¡n muá»‘n tÃ­ch há»£p vá»›i react-hook-form errors
      imageManager.setImageError(imageProcessingError);
      console.error("Image processing error:", imageProcessingError);
      return; // Dá»«ng submit náº¿u cÃ³ lá»—i áº£nh
    }

    if (processedImages.length === 0) {
        imageManager.setImageError("Vui lÃ²ng cung cáº¥p Ã­t nháº¥t má»™t áº£nh cho sáº£n pháº©m.");
        return;
    }

    try {
      await productForm.handleFormSubmit(formData, processedImages);
      // Sau khi submit thÃ nh cÃ´ng, reset image manager
      imageManager.resetImageManager();
    } catch (error) {
      // Lá»—i tá»« handleFormSubmit (vÃ­ dá»¥ API error) Ä‘Ã£ Ä‘Æ°á»£c log trong hook
      // Báº¡n cÃ³ thá»ƒ thÃªm logic hiá»ƒn thá»‹ lá»—i chung á»Ÿ Ä‘Ã¢y náº¿u muá»‘n
      console.error("Product submission failed:", error);
    }
  };
  
  // Khi drawer Ä‘Ã³ng (khÃ´ng pháº£i do submit thÃ nh cÃ´ng, vÃ­ dá»¥ báº¥m nÃºt X hoáº·c click ra ngoÃ i)
  const handleCloseDrawer = () => {
    productForm.resetForm(); // Reset cÃ¡c trÆ°á»ng cá»§a form
    imageManager.resetImageManager(); // Reset tráº¡ng thÃ¡i cá»§a image manager
    onClose(); // Gá»i prop onClose tá»« component cha
  };


  if (dataLoading) {
    return (
      <Drawer anchor="right" open={isOpen} onClose={handleCloseDrawer}>
        <Box sx={{ width: 400, p: 3, display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100%' }}>
          <CircularProgress />
        </Box>
      </Drawer>
    );
  }

  return (
    <Drawer anchor="right" open={isOpen} onClose={handleCloseDrawer} BackdropProps={{ invisible: false }}>
      <Box sx={{ width: 400, p: 3, bgcolor: "background.default", height: "100%", overflowY: "auto" }}>
        <Box display="flex" justifyContent="space-between" alignItems="center" mb={2}>
          <Typography variant="h6" fontWeight="bold">ThÃªm sáº£n pháº©m</Typography>
          <IconButton onClick={handleCloseDrawer}>
            <Close />
          </IconButton>
        </Box>

        {dataError && <Typography color="error" mb={2}>{dataError}</Typography>}

        <form onSubmit={productForm.handleSubmit(handleMainSubmit)}>
          <Box mt={2} p={2} border="1px solid #e0e0e0" borderRadius={2}>
            <Typography mb={1} fontWeight="medium">TÃªn sáº£n pháº©m</Typography>
            <InputBase {...productForm.register("name", { required: "TÃªn sáº£n pháº©m lÃ  báº¯t buá»™c" })} fullWidth required placeholder="Nháº­p tÃªn sáº£n pháº©m" sx={{ border: '1px solid #ccc', borderRadius: 1, p: '2px 8px' }}/>
            {/* {productForm.formState.errors.name && <Typography color="error" variant="caption">{productForm.formState.errors.name.message}</Typography>} */}
          </Box>

          <Box mt={2} p={2} border="1px solid #e0e0e0" borderRadius={2}>
            <Typography mb={1} fontWeight="medium">MÃ´ táº£</Typography>
            <InputBase {...productForm.register("description", { required: "MÃ´ táº£ lÃ  báº¯t buá»™c" })} fullWidth required multiline rows={3} placeholder="Nháº­p mÃ´ táº£ sáº£n pháº©m" sx={{ border: '1px solid #ccc', borderRadius: 1, p: '8px' }}/>
            {/* {productForm.formState.errors.description && <Typography color="error" variant="caption">{productForm.formState.errors.description.message}</Typography>} */}
          </Box>
          <Box mt={2} p={2} border="1px solid #e0e0e0" borderRadius={2}>
            <Typography mb={1} fontWeight="medium">Danh má»¥c</Typography>
            <Select 
              {...productForm.register("categoryId", { required: "Vui lÃ²ng chá»n danh má»¥c" })} 
              fullWidth 
              displayEmpty 
              defaultValue=""
              error={!!errors?.categoryId} // Sá»­ dá»¥ng optional chaining (?.), an toÃ n hÆ¡n náº¿u errors cÃ³ thá»ƒ undefined ban Ä‘áº§u
              sx={{borderColor: errors?.categoryId ? 'red' : undefined }}
            >
              <MenuItem value="" disabled>Chá»n danh má»¥c</MenuItem>
              {categories.map((cat) => (
                <MenuItem key={cat.id} value={cat.id}>{cat.name}</MenuItem>
              ))}
            </Select>
            {errors?.categoryId && <Typography color="error" variant="caption" sx={{mt: 0.5}}>{errors.categoryId.message}</Typography>}
          </Box>

          {/* VÃ­ dá»¥ vá»›i trÆ°á»ng ThÆ°Æ¡ng hiá»‡u */}
          <Box mt={2} p={2} border="1px solid #e0e0e0" borderRadius={2}>
            <Typography mb={1} fontWeight="medium">ThÆ°Æ¡ng hiá»‡u</Typography>
            <Select 
              {...productForm.register("brandId", { required: "Vui lÃ²ng chá»n thÆ°Æ¡ng hiá»‡u" })} 
              fullWidth 
              displayEmpty 
              defaultValue=""
              error={!!errors?.brandId}
              sx={{borderColor: errors?.brandId ? 'red' : undefined }}
            >
              <MenuItem value="" disabled>Chá»n thÆ°Æ¡ng hiá»‡u</MenuItem>
              {brands.map((brand) => (
                <MenuItem key={brand.id} value={brand.id}>{brand.name}</MenuItem>
              ))}
            </Select>
            {errors?.brandId && <Typography color="error" variant="caption" sx={{mt: 0.5}}>{errors.brandId.message}</Typography>}
          </Box>
          {/* Pháº§n chá»n áº£nh vá»›i Tab */}
          <Box mt={2} p={2} border="1px solid #e0e0e0" borderRadius={2}>
            <Typography mb={1} fontWeight="medium">áº¢nh sáº£n pháº©m</Typography>
            <Tabs value={imageManager.tabValue} onChange={(e, newValue) => imageManager.setTabValue(newValue)} indicatorColor="primary" textColor="primary">
              <Tab label="Táº£i áº£nh lÃªn" />
              <Tab label="Nháº­p URL" />
            </Tabs>

            {imageManager.tabValue === 0 ? (
              // Tab Upload áº£nh
              <Box mt={2}>
                <input
                  type="file"
                  multiple
                  accept="image/*"
                  onChange={imageManager.handleImageUploadFromDevice}
                  style={{ display: 'block', marginBottom: '16px' }}
                />
                {imageManager.uploadingImage && <CircularProgress size={24} sx={{my: 1}}/>}
                <Box mt={1} display="flex" flexWrap="wrap" gap={1}>
                  {imageManager.localImages.map((img, index) => (
                    <Box key={index} position="relative" border={img.isPrimary ? "2px solid blue" : "1px solid #ccc"} p={0.5} borderRadius={1}>
                      <img src={img.preview} alt={`Preview ${index}`} width={80} height={80} style={{ objectFit: 'cover', display: 'block' }} />
                      <Button
                        size="small"
                        color="error"
                        variant="contained"
                        onClick={() => imageManager.handleRemoveLocalImage(index)}
                        sx={{ position: 'absolute', top: -5, right: -5, minWidth: '20px', height: '20px', p:0, borderRadius: '50%' }}
                      >
                        X
                      </Button>
                      {!img.isPrimary && (
                        <Button
                            size="small"
                            onClick={() => imageManager.setPrimaryLocalImage(index)}
                            sx={{ fontSize: '0.6rem', p: '2px 4px', position: 'absolute', bottom: 0, left:0, right:0, backgroundColor: 'rgba(0,0,0,0.5)', color: 'white', '&:hover': {backgroundColor: 'rgba(0,0,0,0.7)'}}}
                        >
                            Äáº·t lÃ m chÃ­nh
                        </Button>
                      )}
                    </Box>
                  ))}
                </Box>
              </Box>
            ) : (
              // Tab URL áº£nh
              <Box mt={2}>
                {imageManager.imageUrls.map((url, index) => (
                  <Box key={index} display="flex" alignItems="center" mb={1}>
                    <TextField
                      fullWidth
                      variant="outlined"
                      size="small"
                      value={url}
                      onChange={(e) => imageManager.handleUrlInputChange(index, e.target.value)}
                      placeholder="Nháº­p URL áº£nh"
                    />
                    {imageManager.imageUrls.length > 1 && (
                      <IconButton onClick={() => imageManager.handleRemoveUrlInput(index)} size="small" sx={{ml: 0.5}}>
                        <Close fontSize="small" />
                      </IconButton>
                    )}
                  </Box>
                ))}
                 {imageManager.uploadingImage && <CircularProgress size={24} sx={{my: 1}}/>}
                <Button onClick={imageManager.handleAddUrlField} variant="outlined" size="small" sx={{ mt: 1 }}>
                  ThÃªm URL khÃ¡c
                </Button>
              </Box>
            )}
            {imageManager.imageError && (
              <Typography color="error" mt={1} variant="caption">{imageManager.imageError}</Typography>
            )}
          </Box>

          {/* TODO: ThÃªm FieldArray cho variants náº¿u cáº§n */}
          {/* VÃ­ dá»¥: <ProductVariantsControl control={productForm.control} register={productForm.register} /> */}

          <Box mt={3} display="flex" justifyContent="flex-end">
            <Button 
                type="button" 
                variant="outlined" 
                onClick={handleCloseDrawer} 
                sx={{ mr: 1, borderRadius: 2 }}
                disabled={imageManager.uploadingImage || productForm.formState?.isSubmitting}
            >
              Há»§y
            </Button>
            <Button
                type="submit"
                variant="contained"
                disabled={imageManager.uploadingImage || productForm.formState?.isSubmitting} // VÃ´ hiá»‡u hÃ³a khi Ä‘ang táº£i áº£nh hoáº·c submit form
                sx={{ bgcolor: "black", color: "white", borderRadius: 2, "&:hover": { bgcolor: "grey.800" }, "&:disabled": { bgcolor: "grey.400"} }}
            >
              { (imageManager.uploadingImage || productForm.formState?.isSubmitting) ? <CircularProgress size={24} color="inherit" /> : "ThÃªm Sáº£n pháº©m" }
            </Button>
          </Box>
        </form>
      </Box>
    </Drawer>
  );
};

export default ProductDrawer;
```

### ClientApp\src\components\Admin\products\AddSpecificationDrawer.jsx
```jsx
import React, { useState, useCallback, useEffect } from "react";
import {
  Drawer, Button, Box, Typography, IconButton,
  TextField, CircularProgress, Alert, Dialog,
  DialogActions, DialogContent, DialogContentText, DialogTitle,
  Snackbar, LinearProgress, Paper, InputAdornment
} from "@mui/material";
import {
  X, Trash, Check, Plus, Package as PackageIcon,
  LayoutGrid, Info, AlertTriangle, Edit, Save
} from "lucide-react";
import { useSpecificationForm } from "@/hooks/api/useProductSpecificationManager";

const ICON_SIZE_FIELD = 20;
const ICON_SIZE_BUTTON = 18;
const ICON_SIZE_CLOSE = 22;

const AddSpecificationDrawer = ({ open, onClose, product }) => {
  const { specifications, loadingState, snackbarState, deleteDialogOpen, specToDelete, anyLoading, showInitialLoadSpinner, showRefetchProgressBar, actions } = useSpecificationForm(product, open, onClose);

  const [newSpec, setNewSpec] = useState({
    name: '',
    value: '',
    unit: '',
    displayOrder: specifications.length > 0 ? Math.max(...specifications.map(s => s.displayOrder)) + 1 : 1,
  });
  const [editingSpecId, setEditingSpecId] = useState(null);
  const [editingSpecData, setEditingSpecData] = useState({});

  useEffect(() => {
    if (!open) {
      setNewSpec({
        name: '',
        value: '',
        unit: '',
        displayOrder: 1,
      });
      setEditingSpecId(null);
      setEditingSpecData({});
    } else if (specifications.length > 0) {
      setNewSpec(prev => ({ ...prev, displayOrder: Math.max(...specifications.map(s => s.displayOrder)) + 1 }));
    }
  }, [open, specifications]);

  const handleNewSpecChange = useCallback((e) => {
    const { name, value } = e.target;
    setNewSpec(prev => ({
      ...prev,
      [name]: name === 'displayOrder' ? (value === '' ? '' : Number(value)) : value
    }));
  }, []);

  const handleEditSpecChange = useCallback((e) => {
    const { name, value } = e.target;
    setEditingSpecData(prev => ({
      ...prev,
      [name]: name === 'displayOrder' ? (value === '' ? '' : Number(value)) : value
    }));
  }, []);

  const handleAddNewSpec = useCallback(async (e) => {
    e.preventDefault();
    if (!newSpec.name || !newSpec.value) {
      actions.showSnackbar("TÃªn vÃ  GiÃ¡ trá»‹ thÃ´ng sá»‘ khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.", "warning");
      return;
    }
    await actions.handleAddOrUpdateSpecification(newSpec);
    setNewSpec({
      name: '',
      value: '',
      unit: '',
      displayOrder: specifications.length > 0 ? Math.max(...specifications.map(s => s.displayOrder)) + 1 : 1,
    });
  }, [newSpec, actions, specifications]);

  const handleEditClick = useCallback((spec) => {
    setEditingSpecId(spec.id);
    setEditingSpecData({ ...spec });
  }, []);

  const handleSaveEdit = useCallback(async () => {
    if (!editingSpecData.name || !editingSpecData.value) {
      actions.showSnackbar("TÃªn vÃ  GiÃ¡ trá»‹ thÃ´ng sá»‘ khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.", "warning");
      return;
    }
    await actions.handleAddOrUpdateSpecification(editingSpecData);
    setEditingSpecId(null);
    setEditingSpecData({});
  }, [editingSpecData, actions]);

  const handleCancelEdit = useCallback(() => {
    setEditingSpecId(null);
    setEditingSpecData({});
  }, []);

  const renderProductInfo = useCallback(() => (
    product && (
      <Paper variant="outlined" sx={{ mb: 2.5, p: 1.5, bgcolor: 'action.hover' }}>
        <Typography variant="body2" component="div" gutterBottom sx={{ fontWeight: 'medium', display: 'flex', alignItems: 'center' }}>
          <PackageIcon size={ICON_SIZE_FIELD - 2} style={{ marginRight: '8px', opacity: 0.8 }} />
          Sáº£n pháº©m: <Typography component="span" variant="body2" color="text.secondary" sx={{ ml: 0.5 }}>{product.name || "KhÃ´ng cÃ³ tÃªn"}</Typography>
        </Typography>
        <Typography variant="body2" component="div" sx={{ display: 'flex', alignItems: 'center' }}>
          <LayoutGrid size={ICON_SIZE_FIELD - 2} style={{ marginRight: '8px', opacity: 0.8 }} />
          Danh má»¥c: <Typography component="span" variant="body2" color="text.secondary" sx={{ ml: 0.5 }}>{product.category?.name || 'ChÆ°a cÃ³ hoáº·c khÃ´ng há»£p lá»‡'}</Typography>
        </Typography>
      </Paper>
    )
  ), [product]);

  return (
    <Drawer
      anchor="right"
      open={open}
      onClose={onClose}
      PaperProps={{
        sx: {
          width: { xs: '100%', sm: 480, md: 520 },
          boxSizing: 'border-box',
        }
      }}
    >
      <Box
        sx={{
          p: { xs: 2, md: 2.5 },
          bgcolor: "background.paper",
          height: "100%",
          display: "flex",
          flexDirection: "column",
          position: 'relative',
        }}
      >
        {showRefetchProgressBar && <LinearProgress sx={{ position: 'absolute', top: 0, left: 0, right: 0, zIndex: 10, height: '3px' }} />}

        <Box
          display="flex"
          justifyContent="space-between"
          alignItems="center"
          mb={2}
          pb={1.5}
          borderBottom={1}
          borderColor="divider"
        >
          <Typography variant="h6" fontWeight={500}>
            Quáº£n lÃ½ ThÃ´ng sá»‘ Ká»¹ thuáº­t
          </Typography>
          <IconButton onClick={onClose} aria-label="ÄÃ³ng Drawer" size="small">
            <X size={ICON_SIZE_CLOSE} />
          </IconButton>
        </Box>

        {renderProductInfo()}

        {showInitialLoadSpinner ? (
          <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', flexGrow: 1, minHeight: '200px' }}>
            <CircularProgress />
          </Box>
        ) : (
          <Box sx={{ flexGrow: 1, overflowY: 'auto', pr: { xs: 0, sm: 0.5 }, pt: 0.5 }}>
            <Typography variant="h6" sx={{ mb: 2 }}>ThÃªm ThÃ´ng sá»‘ Má»›i</Typography>
            <form onSubmit={handleAddNewSpec} className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 border rounded-lg bg-gray-100">
              <TextField
                label="TÃªn thÃ´ng sá»‘"
                name="name"
                value={newSpec.name}
                onChange={handleNewSpecChange}
                fullWidth
                size="small"
                required
                disabled={anyLoading}
              />
              <TextField
                label="GiÃ¡ trá»‹"
                name="value"
                value={newSpec.value}
                onChange={handleNewSpecChange}
                fullWidth
                size="small"
                required
                disabled={anyLoading}
              />
              <TextField
                label="ÄÆ¡n vá»‹ (tÃ¹y chá»n)"
                name="unit"
                value={newSpec.unit}
                onChange={handleNewSpecChange}
                fullWidth
                size="small"
                disabled={anyLoading}
              />
              <TextField
                label="Thá»© tá»± hiá»ƒn thá»‹"
                name="displayOrder"
                type="number"
                value={newSpec.displayOrder}
                onChange={handleNewSpecChange}
                fullWidth
                size="small"
                disabled={anyLoading}
                inputProps={{ min: 1 }}
              />
              <Button
                type="submit"
                variant="contained"
                color="primary"
                startIcon={loadingState.submit ? <CircularProgress size={20} color="inherit" /> : <Plus size={ICON_SIZE_BUTTON} />}
                disabled={anyLoading || !newSpec.name || !newSpec.value}
                sx={{ mt: 1, gridColumn: 'span 2' }}
              >
                {loadingState.submit ? 'Äang thÃªm...' : 'ThÃªm ThÃ´ng sá»‘'}
              </Button>
            </form>

            <Typography variant="h6" sx={{ mb: 2, mt: 4 }}>ThÃ´ng sá»‘ Hiá»‡n cÃ³ ({specifications.length})</Typography>
            {specifications.length === 0 && !loadingState.fetch && (
              <Alert severity="info" variant="outlined" icon={<Info size={ICON_SIZE_FIELD} />} sx={{ mt: 1, mb: 2, fontSize: '0.875rem' }}>
                Sáº£n pháº©m nÃ y chÆ°a cÃ³ thÃ´ng sá»‘ ká»¹ thuáº­t nÃ o.
              </Alert>
            )}
            <Box>
              {specifications.map((spec) => (
                <Paper key={spec.id} variant="outlined" sx={{ p: 2, mb: 2, display: 'flex', flexDirection: 'column', gap: 1, bgcolor: 'background.paper' }}>
                  {editingSpecId === spec.id ? (
                    <form onSubmit={(e) => { e.preventDefault(); handleSaveEdit(); }} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <TextField
                        label="TÃªn thÃ´ng sá»‘"
                        name="name"
                        value={editingSpecData.name || ''}
                        onChange={handleEditSpecChange}
                        fullWidth
                        size="small"
                        required
                        disabled={anyLoading}
                      />
                      <TextField
                        label="GiÃ¡ trá»‹"
                        name="value"
                        value={editingSpecData.value || ''}
                        onChange={handleEditSpecChange}
                        fullWidth
                        size="small"
                        required
                        disabled={anyLoading}
                      />
                      <TextField
                        label="ÄÆ¡n vá»‹ (tÃ¹y chá»n)"
                        name="unit"
                        value={editingSpecData.unit || ''}
                        onChange={handleEditSpecChange}
                        fullWidth
                        size="small"
                        disabled={anyLoading}
                      />
                      <TextField
                        label="Thá»© tá»± hiá»ƒn thá»‹"
                        name="displayOrder"
                        type="number"
                        value={editingSpecData.displayOrder || ''}
                        onChange={handleEditSpecChange}
                        fullWidth
                        size="small"
                        disabled={anyLoading}
                        inputProps={{ min: 1 }}
                      />
                      <Box sx={{ gridColumn: 'span 2', display: 'flex', gap: 1, justifyContent: 'flex-end' }}>
                        <Button onClick={handleCancelEdit} variant="outlined" disabled={anyLoading}>Há»§y</Button>
                        <Button
                          type="submit"
                          variant="contained"
                          color="primary"
                          startIcon={loadingState.submit ? <CircularProgress size={20} color="inherit" /> : <Save size={ICON_SIZE_BUTTON} />}
                          disabled={anyLoading || !editingSpecData.name || !editingSpecData.value}
                        >
                          {loadingState.submit ? 'Äang lÆ°u...' : 'LÆ°u thay Ä‘á»•i'}
                        </Button>
                      </Box>
                    </form>
                  ) : (
                    <>
                      <Typography variant="body1" fontWeight="medium">{spec.name}: {spec.value} {spec.unit}</Typography>
                      <Typography variant="body2" color="text.secondary">Thá»© tá»± hiá»ƒn thá»‹: {spec.displayOrder}</Typography>
                      <Box sx={{ display: 'flex', gap: 1, mt: 1, justifyContent: 'flex-end' }}>
                        <Button
                          variant="outlined"
                          size="small"
                          startIcon={<Edit size={ICON_SIZE_BUTTON} />}
                          onClick={() => handleEditClick(spec)}
                          disabled={anyLoading}
                        >
                          Sá»­a
                        </Button>
                        <Button
                          variant="outlined"
                          size="small"
                          color="error"
                          startIcon={<Trash size={ICON_SIZE_BUTTON} />}
                          onClick={() => actions.handleDeleteClick(spec)}
                          disabled={anyLoading}
                        >
                          XÃ³a
                        </Button>
                      </Box>
                    </>
                  )}
                </Paper>
              ))}
            </Box>
          </Box>
        )}
      </Box>

      <Dialog
        open={deleteDialogOpen}
        onClose={actions.handleCloseDeleteDialog}
        maxWidth="xs"
        fullWidth
      >
        <DialogTitle sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
          <AlertTriangle color="orange" size={ICON_SIZE_CLOSE} /> XÃ¡c nháº­n xÃ³a
        </DialogTitle>
        <DialogContent>
          <DialogContentText>
            Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a thÃ´ng sá»‘ ká»¹ thuáº­t "{specToDelete?.name}: {specToDelete?.value}" nÃ y khÃ´ng? HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c.
          </DialogContentText>
        </DialogContent>
        <DialogActions sx={{ p: 2 }}>
          <Button onClick={actions.handleCloseDeleteDialog} color="inherit" variant="outlined" disabled={loadingState.delete}>
            Há»§y
          </Button>
          <Button
            onClick={actions.handleDeleteSpecification}
            color="error"
            variant="contained"
            disabled={loadingState.delete}
            startIcon={loadingState.delete ? <CircularProgress size={20} color="inherit" /> : <Trash size={ICON_SIZE_BUTTON} />}
            sx={{ minWidth: '100px' }}
          >
            {loadingState.delete ? 'Äang xÃ³a...' : 'XÃ¡c nháº­n xÃ³a'}
          </Button>
        </DialogActions>
      </Dialog>

      <Snackbar
        open={snackbarState.open}
        autoHideDuration={4000}
        onClose={actions.handleCloseSnackbar}
        anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}
      >
        <Alert
          onClose={actions.handleCloseSnackbar}
          severity={snackbarState.severity}
          variant="filled"
          sx={{ width: '100%' }}
        >
          {snackbarState.message}
        </Alert>
      </Snackbar>
    </Drawer>
  );
};

export default React.memo(AddSpecificationDrawer);

```

### ClientApp\src\components\Admin\products\BrandDrawer.jsx
```jsx
import React from "react";
import {
  Drawer, Button, Box, Typography, IconButton, Table,
  TableBody, TableCell, TableContainer, TableHead, TableRow, Paper,
  CircularProgress, Alert
} from "@mui/material";
import { Dialog, DialogActions, DialogContent, DialogContentText, DialogTitle } from "@mui/material";
import { X, Edit, Trash, AlertTriangle } from "lucide-react"; // ThÃªm AlertTriangle
import BrandModal from "./BrandModal"; // Äáº£m báº£o BrandModal nháº­n vÃ  sá»­ dá»¥ng `onClose(shouldRefresh)`
import { useBrands } from "@/hooks/api/useBrands"; // ÄÆ°á»ng dáº«n tá»›i hook

const BrandDrawer = ({ open, onClose }) => {
  const {
    brands,
    selectedBrand,
    modalOpen,
    deleteDialogOpen,
    brandToDelete,
    loading,
    error,
    actions
  } = useBrands(open); // Truyá»n `open` vÃ o hook Ä‘á»ƒ nÃ³ cÃ³ thá»ƒ quyáº¿t Ä‘á»‹nh khi nÃ o fetch dá»¯ liá»‡u

  const getLogoUrl = (logoPath) => {
    if (!logoPath) return "https://via.placeholder.com/50"; // áº¢nh máº·c Ä‘á»‹nh náº¿u khÃ´ng cÃ³ logo
    if (logoPath.startsWith("http")) {
      return logoPath; // Full external URL
    }
    return `${process.env.REACT_APP_API_BASE_URL}${logoPath}`;
  };

  return (
    <Drawer anchor="right" open={open} onClose={onClose}>
      <Box
        sx={{
          width: { xs: '100%', sm: 500, md: 600 }, // Responsive width
          p: { xs: 2, sm: 3 },
          bgcolor: "background.paper", // Sá»­ dá»¥ng theme background
          height: "100%",
          display: "flex",
          flexDirection: "column",
          boxSizing: 'border-box',
        }}
      >
        <Box display="flex" justifyContent="space-between" alignItems="center" mb={2} pb={1.5} borderBottom={1} borderColor="divider">
          <Typography variant="h6" fontWeight={500}> {/* Giáº£m fontWeight má»™t chÃºt */}
            Quáº£n lÃ½ ThÆ°Æ¡ng hiá»‡u
          </Typography>
          <IconButton onClick={onClose} aria-label="ÄÃ³ng Drawer">
            <X size={22} />
          </IconButton>
        </Box>

        {error && (
            <Alert severity="error" onClose={actions.clearError} sx={{ mb: 2 }}>
                {error}
            </Alert>
        )}

        <Button
          variant="contained"
          color="primary" // Sá»­ dá»¥ng mÃ u primary cá»§a theme
          sx={{ mb: 2, alignSelf: 'flex-start' }} // Canh nÃºt ThÃªm sang trÃ¡i
          onClick={() => actions.handleOpenModal()}
          disabled={loading} // Disable nÃºt khi Ä‘ang cÃ³ thao tÃ¡c
        >
          ThÃªm thÆ°Æ¡ng hiá»‡u
        </Button>

        {loading && brands.length === 0 && ( // Chá»‰ hiá»ƒn thá»‹ spinner toÃ n cá»¥c khi Ä‘ang load láº§n Ä‘áº§u
            <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', flexGrow: 1 }}>
                <CircularProgress />
            </Box>
        )}

        {!loading && !error && brands.length === 0 && (
             <Typography variant="body1" color="text.secondary" textAlign="center" sx={{mt: 3}}>
                KhÃ´ng cÃ³ thÆ°Æ¡ng hiá»‡u nÃ o.
            </Typography>
        )}

        {brands.length > 0 && (
          <TableContainer component={Paper} sx={{ flexGrow: 1, overflowY: 'auto' }}>
            <Table stickyHeader aria-label="sticky table">
              <TableHead>
                <TableRow>
                  <TableCell sx={{ fontWeight: 'bold' }}>ThÆ°Æ¡ng hiá»‡u</TableCell>
                  <TableCell sx={{ fontWeight: 'bold' }}>Logo</TableCell>
                  <TableCell sx={{ fontWeight: 'bold' }}>MÃ´ táº£</TableCell>
                  <TableCell sx={{ fontWeight: 'bold', textAlign: 'right' }}>HÃ nh Ä‘á»™ng</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {brands.map((brand) => (
                  <TableRow hover key={brand.id} sx={{ '&:last-child td, &:last-child th': { border: 0 } }}>
                    <TableCell>{brand.name}</TableCell>
                    <TableCell>
                      <img
                        src={getLogoUrl(brand.logo)}
                        alt={`${brand.name} logo`}
                        style={{ width: 50, height: 50, borderRadius: '50%', objectFit: 'contain' }} // CSS trá»±c tiáº¿p hoáº·c dÃ¹ng class
                        onError={(e) => {
                          e.target.onerror = null;
                          e.target.src = "https://via.placeholder.com/50"; // áº¢nh fallback
                        }}
                      />
                    </TableCell>
                    <TableCell sx={{maxWidth: 200, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                        {brand.description || "N/A"}
                    </TableCell>
                    <TableCell sx={{ textAlign: 'right' }}>
                      <IconButton onClick={() => actions.handleOpenModal(brand)} aria-label={`Sá»­a ${brand.name}`} disabled={loading}>
                        <Edit size={20} />
                      </IconButton>
                      <IconButton onClick={() => actions.handleOpenDeleteDialog(brand)} aria-label={`XÃ³a ${brand.name}`} disabled={loading}>
                        <Trash size={20} color="error" /> {/* DÃ¹ng mÃ u error cá»§a theme */}
                      </IconButton>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>
        )}
      </Box>

      {/* Modal ThÃªm/Sá»­a */}
      <BrandModal
        open={modalOpen}
        // Truyá»n hÃ m handleCloseModal tá»« actions, nÃ³ sáº½ gá»i fetchBrands náº¿u cáº§n
        onClose={(shouldRefresh) => actions.handleCloseModal(shouldRefresh)}
        brand={selectedBrand}
        // KhÃ´ng cáº§n truyá»n refreshBrands ná»¯a vÃ¬ onClose cá»§a BrandModal sáº½ xá»­ lÃ½
      />

      {/* Dialog XÃ¡c nháº­n XÃ³a */}
      <Dialog open={deleteDialogOpen} onClose={actions.handleCloseDeleteDialog} maxWidth="xs" fullWidth>
        <DialogTitle sx={{display: 'flex', alignItems: 'center', gap: 1}}>
            <AlertTriangle color="orange" size={22}/> XÃ¡c nháº­n xÃ³a
        </DialogTitle>
        <DialogContent>
          <DialogContentText>
            Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a thÆ°Æ¡ng hiá»‡u <b>{brandToDelete?.name}</b> khÃ´ng? HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c.
          </DialogContentText>
        </DialogContent>
        <DialogActions sx={{p: 2}}>
          <Button onClick={actions.handleCloseDeleteDialog} color="inherit" variant="outlined" disabled={loading}>
            Há»§y
          </Button>
          <Button onClick={actions.handleConfirmDelete} color="error" variant="contained" disabled={loading}
            startIcon={loading ? <CircularProgress size={20} color="inherit"/> : <Trash size={18}/>}
          >
            {loading ? "Äang xÃ³a..." : "XÃ³a"}
          </Button>
        </DialogActions>
      </Dialog>
    </Drawer>
  );
};

export default React.memo(BrandDrawer);
```

### ClientApp\src\components\Admin\products\BrandModal.jsx
```jsx
import React, { useState, useEffect } from "react";
import { 
  Modal, 
  Box, 
  Typography, 
  Button, 
  TextField, 
  IconButton,
  Tabs,
  Tab,
  CircularProgress
} from "@mui/material";
import { X, Upload } from "lucide-react";
import axios from "axios";

const BrandModal = ({ open, onClose, brand, refreshBrands }) => {
  const [brandData, setBrandData] = useState({ 
    name: "", 
    description: "", 
    logo: "" 
  });
  const [tabValue, setTabValue] = useState(0); // 0: URL, 1: Upload
  const [logoFile, setLogoFile] = useState(null);
  const [logoPreview, setLogoPreview] = useState("");
  const [uploading, setUploading] = useState(false);

  useEffect(() => {
    if (brand) {
      setBrandData(brand);
      // Náº¿u brand cÃ³ logo, máº·c Ä‘á»‹nh chá»n tab URL
      if (brand.logo) setTabValue(0);
    } else {
      setBrandData({ name: "", description: "", logo: "" });
      setLogoFile(null);
      setLogoPreview("");
    }
  }, [brand]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setBrandData({ ...brandData, [name]: value });
  };

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    setLogoFile(file);
    setLogoPreview(URL.createObjectURL(file));
    // Clear URL náº¿u Ä‘ang á»Ÿ tab upload
    if (tabValue === 1) {
      setBrandData({...brandData, logo: ""});
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setUploading(true);
    
    try {
      let finalLogoUrl = brandData.logo;

      // Náº¿u Ä‘ang á»Ÿ tab upload vÃ  cÃ³ file
      if (tabValue === 1 && logoFile) {
        const formData = new FormData();
        formData.append("file", logoFile);
        
        const response = await axios.post(
          `${process.env.REACT_APP_API_BASE_URL}/api/upload`, 
          formData, 
          { headers: { "Content-Type": "multipart/form-data" } }
        );
        
        finalLogoUrl = response.data.imageUrl;
      }

      const dataToSend = {
        ...brandData,
        logo: finalLogoUrl
      };

      if (brand) {
        await axios.put(`${process.env.REACT_APP_API_BASE_URL}/api/brands/${brand.id}`, dataToSend);
      } else {
        await axios.post(`${process.env.REACT_APP_API_BASE_URL}/api/brands`, dataToSend);
      }

      refreshBrands();
      onClose();
    } catch (error) {
      console.error("Failed to save brand:", error);
    } finally {
      setUploading(false);
    }
  };

  return (
    <Modal open={open} onClose={onClose}>
      <Box
        sx={{
          position: "absolute",
          top: "50%",
          left: "50%",
          transform: "translate(-50%, -50%)",
          width: 400,
          bgcolor: "white",
          p: 3,
          borderRadius: 2,
          boxShadow: 24,
        }}
      >
        <Box display="flex" justifyContent="space-between" alignItems="center" mb={2}>
          <Typography variant="h6" fontWeight="bold">
            {brand ? "Chá»‰nh sá»­a thÆ°Æ¡ng hiá»‡u" : "ThÃªm thÆ°Æ¡ng hiá»‡u"}
          </Typography>
          <IconButton onClick={onClose}>
            <X size={24} />
          </IconButton>
        </Box>
        
        <form onSubmit={handleSubmit}>
          <TextField
            fullWidth
            label="TÃªn thÆ°Æ¡ng hiá»‡u"
            name="name"
            value={brandData.name}
            onChange={handleChange}
            margin="normal"
            required
          />
          
          <TextField
            fullWidth
            label="MÃ´ táº£"
            name="description"
            value={brandData.description}
            onChange={handleChange}
            margin="normal"
            multiline
            rows={3}
          />

          <Box mt={2} mb={2}>
            <Typography variant="subtitle1" fontWeight="bold" gutterBottom>
              Logo thÆ°Æ¡ng hiá»‡u
            </Typography>
            
            <Tabs 
              value={tabValue} 
              onChange={(e, newValue) => setTabValue(newValue)}
              sx={{ mb: 2 }}
            >
              <Tab label="Nháº­p URL" />
              <Tab label="Táº£i lÃªn" />
            </Tabs>
            
            {tabValue === 0 ? (
              // Tab URL
              <TextField
                fullWidth
                label="Logo URL"
                name="logo"
                value={brandData.logo}
                onChange={handleChange}
                placeholder="https://example.com/logo.png"
              />
            ) : (
              // Tab Upload
              <Box>
                <Button
                  component="label"
                  variant="outlined"
                  startIcon={<Upload size={18} />}
                  sx={{ mb: 2 }}
                >
                  Chá»n áº£nh
                  <input 
                    type="file" 
                    hidden 
                    accept="image/*" 
                    onChange={handleFileChange} 
                  />
                </Button>
                
                {logoPreview && (
                  <Box mt={1} position="relative" width={100}>
                    <img 
                      src={logoPreview} 
                      alt="Logo preview" 
                      style={{ 
                        width: '100%', 
                        height: 'auto',
                        borderRadius: 4
                      }} 
                    />
                    <IconButton
                      size="small"
                      onClick={() => {
                        setLogoFile(null);
                        setLogoPreview("");
                      }}
                      sx={{
                        position: 'absolute',
                        top: -8,
                        right: -8,
                        backgroundColor: 'rgba(0,0,0,0.6)',
                        color: 'white',
                        '&:hover': {
                          backgroundColor: 'rgba(0,0,0,0.8)'
                        }
                      }}
                    >
                      <X size={16} />
                    </IconButton>
                  </Box>
                )}
              </Box>
            )}
          </Box>

          <Button 
            type="submit" 
            variant="contained" 
            fullWidth
            disabled={uploading}
            sx={{ 
              mt: 2, 
              bgcolor: "black", 
              color: "white", 
              borderRadius: 2,
              height: 42
            }}
          >
            {uploading ? (
              <CircularProgress size={24} color="inherit" />
            ) : (
              brand ? "Cáº­p nháº­t" : "ThÃªm"
            )}
          </Button>
        </form>
      </Box>
    </Modal>
  );
};

export default BrandModal;
```

### ClientApp\src\components\Admin\products\CategoryBrandDrawer.jsx
```jsx
import React, { useState, useEffect } from "react";
import { Drawer, Button, Box, Typography, IconButton, Table, TableBody, TableCell, TableContainer, TableHead, TableRow, Paper } from "@mui/material";
import { Dialog, DialogActions, DialogContent, DialogContentText, DialogTitle } from "@mui/material";
import { X, Edit, Trash } from "lucide-react";
import axios from "axios";
import CategoryModal from "./CategoryModal";

const CategoryBrandDrawer = ({ open, onClose }) => {
    const [categories, setCategories] = useState([]);
    const [selectedCategory, setSelectedCategory] = useState(null);
    const [modalOpen, setModalOpen] = useState(false);
    const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);
    const [categoryToDelete, setCategoryToDelete] = useState(null);

    useEffect(() => {
        fetchCategories();
    }, []);

    const fetchCategories = async () => {
        try {
            const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/categories`);
            setCategories(response.data);
        } catch (error) {
            console.error("Failed to fetch categories:", error);
        }
    };

    const handleConfirmDelete = async () => {
    if (!categoryToDelete) return;

    try {
        await axios.delete(`${process.env.REACT_APP_API_BASE_URL}/api/categories/${categoryToDelete.id}`);
        await fetchCategories();
        setDeleteDialogOpen(false);
        setCategoryToDelete(null);
    } catch (error) {
        console.error("Failed to delete category:", error);
    }
};


    const handleOpenModal = (category = null) => {
        setSelectedCategory(category);
        setModalOpen(true);
    };

    const handleOpenDeleteDialog = (category) => {
    setCategoryToDelete(category);
    setDeleteDialogOpen(true);
};

    return (
        <Drawer anchor="right" open={open} onClose={onClose}>
            <Box
                sx={{
                    width: 600,
                    p: 3,
                    bgcolor: "white",
                    border: "2px solid black",
                    borderRadius: 3,
                    boxShadow: 3,
                    height: "100%",
                    display: "flex",
                    flexDirection: "column",
                }}
            >
                <Box display="flex" justifyContent="space-between" alignItems="center" mb={2}>
                    <Typography variant="h6" fontWeight="bold">
                        Danh má»¥c
                    </Typography>
                    <IconButton onClick={onClose}>
                        <X size={24} />
                    </IconButton>
                </Box>
                <Button variant="contained" sx={{ mb: 2, bgcolor: "black", color: "white", borderRadius: 2 }} onClick={() => handleOpenModal()}>
                    ThÃªm danh má»¥c
                </Button>
                <TableContainer component={Paper}>
                    <Table>
                        <TableHead>
                            <TableRow>
                                <TableCell><b>TÃªn danh má»¥c</b></TableCell>
                                <TableCell><b>MÃ´ táº£</b></TableCell>
                                <TableCell><b>HÃ¬nh áº£nh</b></TableCell>
                                <TableCell><b>HÃ nh Ä‘á»™ng</b></TableCell>
                            </TableRow>
                        </TableHead>
                        <TableBody>
                            {categories.map((category) => (
                                <TableRow key={category.id}>
                                    <TableCell>{category.name}</TableCell>
                                    <TableCell>{category.description}</TableCell>
                                    <TableCell><img
    src={
        category.image?.startsWith("http")
            ? category.image // Full external URL
            : `${process.env.REACT_APP_API_BASE_URL}${category.image}`
    }
    alt={`${category.name} logo`}
    className="size-10 rounded-full"
    onError={(e) => {
        e.target.onerror = null;
        e.target.src = "https://via.placeholder.com/50";
    }}
/></TableCell>
                                    <TableCell>
                                        <IconButton onClick={() => handleOpenModal(category)}>
                                            <Edit size={20} />
                                        </IconButton>
                                       <IconButton onClick={() => handleOpenDeleteDialog(category)}>
                                            <Trash size={20} color="red" />
                                        </IconButton>

                                    </TableCell>
                                </TableRow>
                            ))}
                        </TableBody>
                    </Table>
                </TableContainer>
            </Box>
            <CategoryModal open={modalOpen} onClose={() => setModalOpen(false)} category={selectedCategory} refreshCategories={fetchCategories} />

                <Dialog open={deleteDialogOpen} onClose={() => setDeleteDialogOpen(false)}>
    <DialogTitle>XÃ¡c nháº­n xÃ³a</DialogTitle>
    <DialogContent>
        <DialogContentText>
            Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a danh má»¥c <b>{categoryToDelete?.name}</b> khÃ´ng? HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c.
        </DialogContentText>
    </DialogContent>
    <DialogActions>
        <Button onClick={() => setDeleteDialogOpen(false)} color="primary">
            Há»§y
        </Button>
        <Button onClick={handleConfirmDelete} color="error" variant="contained">
            XÃ³a
        </Button>
    </DialogActions>
</Dialog>
        </Drawer>
    );
};

export default CategoryBrandDrawer;

```

### ClientApp\src\components\Admin\products\CategoryModal.jsx
```jsx
import React, { useState, useEffect } from "react";
import { 
  Modal, 
  Box, 
  Typography, 
  TextField, 
  Button, 
  IconButton,
  Tabs,
  Tab,
  CircularProgress,
  Avatar
} from "@mui/material";
import { X, Upload, Image as ImageIcon } from "lucide-react";
import axios from "axios";

const CategoryModal = ({ open, onClose, category, refreshCategories }) => {
  const [formData, setFormData] = useState({ 
    name: "", 
    description: "", 
    image: "" 
  });
  const [tabValue, setTabValue] = useState(0); // 0: URL, 1: Upload
  const [imageFile, setImageFile] = useState(null);
  const [imagePreview, setImagePreview] = useState("");
  const [uploading, setUploading] = useState(false);
  const [imageError, setImageError] = useState("");

  useEffect(() => {
    if (category) {
      setFormData({
        name: category.name || "",
        description: category.description || "",
        image: category.image || ""
      });
      // Náº¿u cÃ³ áº£nh, máº·c Ä‘á»‹nh chá»n tab URL
      if (category.image) setTabValue(0);
    } else {
      setFormData({ name: "", description: "", image: "" });
      setImageFile(null);
      setImagePreview("");
    }
  }, [category]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData({ ...formData, [name]: value });
  };

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    // Validate file type
    if (!file.type.match('image.*')) {
      setImageError("Chá»‰ cháº¥p nháº­n file áº£nh");
      return;
    }

    // Validate file size (max 2MB)
    if (file.size > 2 * 1024 * 1024) {
      setImageError("KÃ­ch thÆ°á»›c áº£nh tá»‘i Ä‘a 2MB");
      return;
    }

    setImageError("");
    setImageFile(file);
    setImagePreview(URL.createObjectURL(file));
    // Clear URL náº¿u Ä‘ang á»Ÿ tab upload
    if (tabValue === 1) {
      setFormData({...formData, image: ""});
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setUploading(true);
    
    try {
      let finalImageUrl = formData.image;

      // Náº¿u Ä‘ang á»Ÿ tab upload vÃ  cÃ³ file
      if (tabValue === 1 && imageFile) {
        const formData = new FormData();
        formData.append("file", imageFile);
        
        const response = await axios.post(
          `${process.env.REACT_APP_API_BASE_URL}/api/upload`, 
          formData, 
          { headers: { "Content-Type": "multipart/form-data" } }
        );
        
        finalImageUrl = response.data.imageUrl;
      } else if (tabValue === 0 && !formData.image) {
        setImageError("Vui lÃ²ng nháº­p URL áº£nh hoáº·c táº£i áº£nh lÃªn");
        setUploading(false);
        return;
      }

      const dataToSend = {
        ...formData,
        image: finalImageUrl
      };

      if (category) {
        await axios.put(
          `${process.env.REACT_APP_API_BASE_URL}/api/categories/${category.id}`, 
          { ...dataToSend, id: category.id }
        );
      } else {
        await axios.post(
          `${process.env.REACT_APP_API_BASE_URL}/api/categories`, 
          dataToSend
        );
      }

      await refreshCategories();
      onClose();
    } catch (error) {
      console.error("Failed to save category:", error);
      setImageError("CÃ³ lá»—i xáº£y ra khi lÆ°u danh má»¥c");
    } finally {
      setUploading(false);
    }
  };

  return (
    <Modal open={open} onClose={onClose}>
      <Box
        sx={{
          position: "absolute",
          top: "50%",
          left: "50%",
          transform: "translate(-50%, -50%)",
          width: 400,
          bgcolor: "white",
          p: 3,
          borderRadius: 2,
          boxShadow: 24,
        }}
      >
        <Box display="flex" justifyContent="space-between" alignItems="center" mb={2}>
          <Typography variant="h6" fontWeight="bold">
            {category ? "Chá»‰nh sá»­a danh má»¥c" : "ThÃªm danh má»¥c"}
          </Typography>
          <IconButton onClick={onClose}>
            <X size={24} />
          </IconButton>
        </Box>
        
        <form onSubmit={handleSubmit}>
          <TextField
            fullWidth
            label="TÃªn danh má»¥c"
            name="name"
            value={formData.name}
            onChange={handleChange}
            margin="normal"
            required
          />
          
          <TextField
            fullWidth
            label="MÃ´ táº£"
            name="description"
            value={formData.description}
            onChange={handleChange}
            margin="normal"
            multiline
            rows={3}
          />

          <Box mt={2} mb={2}>
            <Typography variant="subtitle1" fontWeight="bold" gutterBottom>
              HÃ¬nh áº£nh danh má»¥c
            </Typography>
            
            <Tabs 
              value={tabValue} 
              onChange={(e, newValue) => setTabValue(newValue)}
              sx={{ mb: 2 }}
            >
              <Tab label="Nháº­p URL" icon={<ImageIcon size={16} />} />
              <Tab label="Táº£i lÃªn" icon={<Upload size={16} />} />
            </Tabs>
            
            {tabValue === 0 ? (
              // Tab URL
              <Box>
                <TextField
                  fullWidth
                  label="HÃ¬nh áº£nh URL"
                  name="image"
                  value={formData.image}
                  onChange={handleChange}
                  placeholder="https://example.com/image.jpg"
                />
                {formData.image && (
                  <Box mt={2} display="flex" justifyContent="center">
                    <Avatar
                      src={formData.image}
                      alt="Preview"
                      sx={{ 
                        width: 100, 
                        height: 100,
                        border: '1px solid #ddd'
                      }}
                      variant="rounded"
                    />
                  </Box>
                )}
              </Box>
            ) : (
              // Tab Upload
              <Box>
                <Button
                  component="label"
                  variant="outlined"
                  startIcon={<Upload size={18} />}
                  fullWidth
                  sx={{ mb: 2 }}
                >
                  Chá»n áº£nh
                  <input 
                    type="file" 
                    hidden 
                    accept="image/*" 
                    onChange={handleFileChange} 
                  />
                </Button>
                
                {imagePreview && (
                  <Box mt={1} display="flex" flexDirection="column" alignItems="center">
                    <Avatar
                      src={imagePreview}
                      alt="Preview"
                      sx={{ 
                        width: 100, 
                        height: 100,
                        border: '1px solid #ddd',
                        mb: 1
                      }}
                      variant="rounded"
                    />
                    <Button
                      size="small"
                      color="error"
                      variant="outlined"
                      onClick={() => {
                        setImageFile(null);
                        setImagePreview("");
                      }}
                    >
                      XÃ³a áº£nh
                    </Button>
                  </Box>
                )}
              </Box>
            )}
            
            {imageError && (
              <Typography color="error" variant="body2" mt={1}>
                {imageError}
              </Typography>
            )}
          </Box>

          <Button 
            type="submit" 
            variant="contained" 
            fullWidth
            disabled={uploading}
            sx={{ 
              mt: 2,
              height: 42,
              bgcolor: "black", 
              color: "white",
              '&:hover': {
                bgcolor: '#333'
              }
            }}
          >
            {uploading ? (
              <CircularProgress size={24} color="inherit" />
            ) : (
              category ? "Cáº­p nháº­t" : "ThÃªm"
            )}
          </Button>
        </form>
      </Box>
    </Modal>
  );
};

export default CategoryModal;
```

### ClientApp\src\components\Admin\products\EditProductDrawer.jsx
```jsx
import React, { useState, useEffect, useCallback, useMemo } from "react";
import Drawer from "@mui/material/Drawer";
import Button from "@mui/material/Button";
import TextField from "@mui/material/TextField";
import MenuItem from "@mui/material/MenuItem";
import IconButton from "@mui/material/IconButton";
import DeleteIcon from "@mui/icons-material/Delete";
import AddIcon from "@mui/icons-material/Add";
import CloseIcon from "@mui/icons-material/Close"; // ThÃªm icon Close
import axios from "axios";
import {
  Box,
  Typography,
  CircularProgress,
  Alert,
  Stack,
  Grid,
  Checkbox,
  FormControlLabel,
  Snackbar,
} from "@mui/material";

const API_BASE_URL = process.env.REACT_APP_API_BASE_URL;

// GiÃ¡ trá»‹ khá»Ÿi táº¡o cho má»™t biáº¿n thá»ƒ má»›i
const initialVariantState = {
  color: "",
  storage: "",
  price: "",
  discountPrice: "",
  stockQuantity: "",
  flashSaleStart: "",
  flashSaleEnd: "",
};

// GiÃ¡ trá»‹ khá»Ÿi táº¡o cho má»™t áº£nh má»›i
const initialImageState = { imageUrl: "", isPrimary: false };

// HÃ m Ä‘á»‹nh dáº¡ng ngÃ y giá» cho datetime-local input
const formatDateTimeForInput = (dateTimeString) => {
  if (!dateTimeString) return "";
  try {
    // Cá»‘ gáº¯ng táº¡o Ä‘á»‘i tÆ°á»£ng Date, náº¿u khÃ´ng há»£p lá»‡, tráº£ vá» chuá»—i rá»—ng
    const date = new Date(dateTimeString);
    if (isNaN(date.getTime())) return ""; // Kiá»ƒm tra náº¿u date khÃ´ng há»£p lá»‡
    return date.toISOString().slice(0, 16);
  } catch (e) {
    return ""; // Tráº£ vá» rá»—ng náº¿u cÃ³ lá»—i khi parse date
  }
};

const EditProductDrawer = ({ isOpen, onClose, product, onUpdateProduct }) => {
  const [formData, setFormData] = useState({
    name: "",
    description: "",
    categoryId: "",
    brandId: "",
    images: [initialImageState],
    variants: [initialVariantState],
  });
  const [categories, setCategories] = useState([]);
  const [brands, setBrands] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [successMessage, setSuccessMessage] = useState(null);

  // Khá»Ÿi táº¡o formData tá»« product prop khi product thay Ä‘á»•i hoáº·c drawer má»Ÿ láº§n Ä‘áº§u vá»›i product
  useEffect(() => {
    if (product) {
      setFormData({
        name: product.name || "",
        description: product.description || "",
        categoryId: product.categoryId || "",
        brandId: product.brandId || "",
        images:
          product.images?.length > 0
            ? product.images.map((img) => ({
                imageUrl: img.imageUrl || "",
                isPrimary: img.isPrimary || false,
              }))
            : [initialImageState],
        variants:
          product.variants?.length > 0
            ? product.variants.map((variant) => ({
                color: variant.color || "",
                storage: variant.storage || "",
                price: variant.price || "",
                discountPrice: variant.discountPrice || "",
                stockQuantity: variant.stockQuantity || "",
                flashSaleStart: formatDateTimeForInput(variant.flashSaleStart),
                flashSaleEnd: formatDateTimeForInput(variant.flashSaleEnd),
              }))
            : [initialVariantState],
      });
    } else {
      // Reset form náº¿u khÃ´ng cÃ³ product (trÆ°á»ng há»£p nÃ y Ã­t xáº£y ra vá»›i "Edit" drawer)
      setFormData({
        name: "",
        description: "",
        categoryId: "",
        brandId: "",
        images: [initialImageState],
        variants: [initialVariantState],
      });
    }
  }, [product]);

  // Láº¥y danh sÃ¡ch categories vÃ  brands khi drawer má»Ÿ
  useEffect(() => {
    const fetchDropdownData = async () => {
      // Chá»‰ fetch náº¿u chÆ°a cÃ³ dá»¯ liá»‡u hoáº·c muá»‘n refresh khi má»Ÿ
      if (isOpen && (categories.length === 0 || brands.length === 0)) {
        setLoading(true); // CÃ³ thá»ƒ thÃªm loading state riÃªng cho viá»‡c fetch nÃ y
        try {
          const [categoriesResponse, brandsResponse] = await Promise.all([
            axios.get(`${API_BASE_URL}/api/categories`),
            axios.get(`${API_BASE_URL}/api/brands`),
          ]);
          setCategories(categoriesResponse.data.$values || categoriesResponse.data || []);
          setBrands(brandsResponse.data.$values || brandsResponse.data || []);
        } catch (err) {
          console.error("Lá»—i khi láº¥y dá»¯ liá»‡u categories/brands:", err);
          setError("KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u danh má»¥c hoáº·c thÆ°Æ¡ng hiá»‡u.");
          // Giá»¯ láº¡i dá»¯ liá»‡u cÅ© náº¿u cÃ³, hoáº·c set rá»—ng náº¿u chÆ°a cÃ³
          if (categories.length === 0) setCategories([]);
          if (brands.length === 0) setBrands([]);
        } finally {
          setLoading(false); // Káº¿t thÃºc loading state riÃªng (náº¿u cÃ³)
        }
      }
    };
    fetchDropdownData();
  }, [isOpen]); // Phá»¥ thuá»™c vÃ o isOpen Ä‘á»ƒ fetch khi má»Ÿ

  // Xá»­ lÃ½ thay Ä‘á»•i giÃ¡ trá»‹ trong form
  const handleChange = useCallback((e, index, type) => {
    const { name, value, checked, type: inputType } = e.target;

    setFormData((prev) => {
      const newState = { ...prev };
      if (type === "variant" && index !== undefined) {
        const newVariants = [...newState.variants];
        newVariants[index] = {
          ...newVariants[index],
          [name]: inputType === "checkbox" ? checked : value,
        };
        newState.variants = newVariants;
      } else if (type === "image" && index !== undefined) {
        let newImages = newState.images.map((img, i) => {
          if (i === index) {
            return {
              ...img,
              [name]: inputType === "checkbox" ? checked : value,
            };
          }
          return img;
        });

        // Náº¿u chá»n áº£nh nÃ y lÃ m primary, bá» primary cá»§a cÃ¡c áº£nh khÃ¡c
        if (name === "isPrimary" && checked) {
          newImages = newImages.map((img, i) => ({
            ...img,
            isPrimary: i === index,
          }));
        }
        newState.images = newImages;
      } else {
        newState[name] = value;
      }
      return newState;
    });
  }, []);

  const addVariant = useCallback(() => {
    setFormData((prev) => ({
      ...prev,
      variants: [...prev.variants, { ...initialVariantState }],
    }));
  }, []);

  const removeVariant = useCallback((index) => {
    setFormData((prev) => ({
      ...prev,
      variants: prev.variants.filter((_, i) => i !== index),
    }));
  }, []);

  const addImage = useCallback(() => {
    setFormData((prev) => ({
      ...prev,
      images: [...prev.images, { ...initialImageState }],
    }));
  }, []);

  const removeImage = useCallback((index) => {
    setFormData((prev) => ({
      ...prev,
      images: prev.images.filter((_, i) => i !== index),
    }));
  }, []);

  // Gá»­i dá»¯ liá»‡u cáº­p nháº­t lÃªn API
  const handleSubmit = useCallback(async (e) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    setSuccessMessage(null);

    // Validate: Náº¿u cÃ³ áº£nh, Ã­t nháº¥t má»™t áº£nh pháº£i lÃ  primary
    const hasImages = formData.images.some(img => img.imageUrl && img.imageUrl.trim() !== "");
    if (hasImages && !formData.images.some(img => img.isPrimary)) {
      setError("Vui lÃ²ng chá»n má»™t áº£nh lÃ m áº£nh chÃ­nh (primary).");
      setLoading(false);
      return;
    }

    try {
      const updatedData = {
        name: formData.name,
        description: formData.description,
        categoryId: parseInt(formData.categoryId),
        brandId: parseInt(formData.brandId),
        images: formData.images
          .filter(img => img.imageUrl && img.imageUrl.trim() !== "") // Chá»‰ gá»­i nhá»¯ng áº£nh cÃ³ URL
          .map(img => ({
            imageUrl: img.imageUrl,
            isPrimary: img.isPrimary || false,
          })),
        variants: formData.variants.map(variant => ({
          ...variant, // Giá»¯ láº¡i cÃ¡c trÆ°á»ng khÃ´ng thay Ä‘á»•i nhÆ° color, storage
          price: parseFloat(variant.price) || 0,
          discountPrice: variant.discountPrice ? parseFloat(variant.discountPrice) : null,
          stockQuantity: parseInt(variant.stockQuantity) || 0,
          // API cÃ³ thá»ƒ mong muá»‘n null náº¿u khÃ´ng cÃ³ ngÃ y
          flashSaleStart: variant.flashSaleStart || null,
          flashSaleEnd: variant.flashSaleEnd || null,
        })),
      };

      console.log("Submitting data:", updatedData);

      const response = await axios.put(
        `${API_BASE_URL}/api/products/${product.id}`,
        updatedData,
        { headers: { "Content-Type": "application/json" } }
      );

      if (response.status === 204 || response.status === 200) {
        // Dá»¯ liá»‡u tráº£ vá» tá»« API cÃ³ thá»ƒ lÃ  sáº£n pháº©m Ä‘Ã£ cáº­p nháº­t Ä‘áº§y Ä‘á»§
        const updatedProductData = response.data && Object.keys(response.data).length > 0 ? response.data : { ...product, ...updatedData };
        onUpdateProduct(updatedProductData);
        setSuccessMessage("Sáº£n pháº©m Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t thÃ nh cÃ´ng!");
        // Tá»± Ä‘á»™ng Ä‘Ã³ng Drawer sau má»™t khoáº£ng thá»i gian hoáº·c Ä‘á»ƒ ngÆ°á»i dÃ¹ng tá»± Ä‘Ã³ng
        // setTimeout(() => {
        //   handleCloseDrawer();
        // }, 2000);
      } else {
        setError(`Cáº­p nháº­t tháº¥t báº¡i vá»›i status: ${response.status}`);
      }
    } catch (err) {
      const errorMessage =
        err.response?.data?.message ||
        err.response?.data?.title || // For ASP.NET Core ModelState errors
        (err.response?.data?.errors ? Object.values(err.response.data.errors).flat().join('; ') : null) || // For detailed validation errors
        err.message ||
        "ÄÃ£ xáº£y ra lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh.";
      setError(`Lá»—i khi cáº­p nháº­t sáº£n pháº©m: ${errorMessage}`);
      console.error("Lá»—i khi cáº­p nháº­t sáº£n pháº©m:", err.response || err);
    } finally {
      setLoading(false);
    }
  }, [formData, product, onUpdateProduct]); // KhÃ´ng cáº§n onClose á»Ÿ Ä‘Ã¢y ná»¯a, sáº½ xá»­ lÃ½ riÃªng

  const handleCloseDrawer = useCallback(() => {
    setError(null); // Reset lá»—i khi Ä‘Ã³ng
    setSuccessMessage(null); // Reset thÃ´ng bÃ¡o thÃ nh cÃ´ng
    onClose(); // Gá»i hÃ m onClose tá»« props
  }, [onClose]);

  const handleCloseSnackbar = useCallback((event, reason) => {
    if (reason === 'clickaway') {
      return;
    }
    if (successMessage) setSuccessMessage(null);
    if (error) setError(null); // CÃ³ thá»ƒ muá»‘n giá»¯ lá»—i hiá»ƒn thá»‹ trÃªn form
  }, [successMessage, error]);

  // Memoized MenuItems
  const categoryMenuItems = useMemo(() => (
    categories.length > 0 ? (
      categories.map(cat => (
        <MenuItem key={cat.id} value={cat.id}>
          {cat.name}
        </MenuItem>
      ))
    ) : (
      <MenuItem disabled>
        {isOpen && categories.length === 0 && !error ? "Äang táº£i danh má»¥c..." : "KhÃ´ng cÃ³ danh má»¥c"}
      </MenuItem>
    )
  ), [categories, isOpen, error]);

  const brandMenuItems = useMemo(() => (
    brands.length > 0 ? (
      brands.map(brand => (
        <MenuItem key={brand.id} value={brand.id}>
          {brand.name}
        </MenuItem>
      ))
    ) : (
      <MenuItem disabled>
        {isOpen && brands.length === 0 && !error ? "Äang táº£i thÆ°Æ¡ng hiá»‡u..." : "KhÃ´ng cÃ³ thÆ°Æ¡ng hiá»‡u"}
      </MenuItem>
    )
  ), [brands, isOpen, error]);


  return (
    <Drawer anchor="right" open={isOpen} onClose={handleCloseDrawer}>
      <Box sx={{ width: { xs: "100vw", sm: 500, md: 600 }, p: {xs: 2, md: 3} }}>
        <Stack direction="row" justifyContent="space-between" alignItems="center" mb={2}>
          <Typography variant="h5" component="h1">
            Chá»‰nh sá»­a thÃ´ng tin sáº£n pháº©m
          </Typography>
          <IconButton onClick={handleCloseDrawer} aria-label="ÄÃ³ng">
            <CloseIcon />
          </IconButton>
        </Stack>

        {/* ThÃ´ng bÃ¡o lá»—i Æ°u tiÃªn hiá»ƒn thá»‹ trÃªn form */}
        {error && !successMessage && ( // Chá»‰ hiá»ƒn thá»‹ Alert lá»—i náº¿u khÃ´ng cÃ³ thÃ´ng bÃ¡o thÃ nh cÃ´ng
          <Alert severity="error" sx={{ mb: 2 }} onClose={() => setError(null)}>
            {error}
          </Alert>
        )}

        <form onSubmit={handleSubmit}>
          <Stack spacing={2.5}> {/* TÄƒng khoáº£ng cÃ¡ch má»™t chÃºt */}
            <TextField
              label="TÃªn sáº£n pháº©m"
              name="name"
              value={formData.name}
              onChange={handleChange}
              fullWidth
              required
              disabled={loading}
              variant="outlined"
            />
            <TextField
              label="MÃ´ táº£"
              name="description"
              value={formData.description}
              onChange={handleChange}
              fullWidth
              multiline
              rows={3}
              required
              disabled={loading}
              variant="outlined"
            />
            <TextField
              label="Danh má»¥c"
              name="categoryId"
              select
              value={formData.categoryId}
              onChange={handleChange}
              fullWidth
              required
              disabled={loading || categories.length === 0}
              variant="outlined"
            >
              {categoryMenuItems}
            </TextField>
            <TextField
              label="ThÆ°Æ¡ng hiá»‡u"
              name="brandId"
              select
              value={formData.brandId}
              onChange={handleChange}
              fullWidth
              required
              disabled={loading || brands.length === 0}
              variant="outlined"
            >
              {brandMenuItems}
            </TextField>

            <Typography variant="h6" component="h2" mt={1} mb={0}> {/* Giáº£m margin top */}
              HÃ¬nh áº£nh
            </Typography>
            {formData.images.map((image, index) => (
              <Stack key={`image-${index}`} direction="row" spacing={1} alignItems="center" sx={{ mb: 1 }}>
                <TextField
                  label={`URL HÃ¬nh áº£nh ${index + 1}`}
                  name="imageUrl"
                  value={image.imageUrl}
                  onChange={(e) => handleChange(e, index, "image")}
                  fullWidth
                  // required={formData.images.length === 1 || !!image.imageUrl} // áº¢nh Ä‘áº§u tiÃªn hoáº·c cÃ³ URL thÃ¬ báº¯t buá»™c
                  disabled={loading}
                  variant="outlined"
                  size="small"
                />
                <FormControlLabel
                  control={
                    <Checkbox
                      name="isPrimary"
                      checked={!!image.isPrimary}
                      onChange={(e) => handleChange(e, index, "image")}
                      disabled={loading}
                      size="small"
                    />
                  }
                  label="áº¢nh chÃ­nh"
                  sx={{ whiteSpace: 'nowrap', mr: 'auto' }} // Äáº©y nÃºt xÃ³a sang pháº£i
                />
                {formData.images.length > 0 && ( // LuÃ´n cho phÃ©p xÃ³a náº¿u cÃ³ áº£nh, cÃ³ thá»ƒ Ä‘á»ƒ láº¡i 1 áº£nh trá»‘ng
                  <IconButton
                    onClick={() => removeImage(index)}
                    color="error"
                    disabled={loading}
                    aria-label={`XÃ³a hÃ¬nh áº£nh ${index + 1}`}
                    size="small"
                  >
                    <DeleteIcon />
                  </IconButton>
                )}
              </Stack>
            ))}
            <Button
              variant="outlined"
              startIcon={<AddIcon />}
              onClick={addImage}
              disabled={loading}
              size="small"
              sx={{ alignSelf: 'flex-start' }}
            >
              ThÃªm áº£nh
            </Button>

            <Typography variant="h6" component="h2" mt={1} mb={0}>
              Biáº¿n thá»ƒ sáº£n pháº©m
            </Typography>
            {formData.variants.map((variant, index) => (
              <Box key={`variant-${index}`} sx={{ border: "1px solid #e0e0e0", p: 2, mb: 1.5, borderRadius: 1 }}>
                <Stack direction="row" justifyContent="space-between" alignItems="center" mb={1.5}>
                    <Typography variant="subtitle1" component="h3">
                        Biáº¿n thá»ƒ {index + 1}
                    </Typography>
                    {formData.variants.length > 1 && (
                        <IconButton
                            onClick={() => removeVariant(index)}
                            color="error"
                            disabled={loading}
                            aria-label={`XÃ³a biáº¿n thá»ƒ ${index + 1}`}
                            size="small"
                        >
                        <DeleteIcon />
                        </IconButton>
                    )}
                </Stack>
                <Grid container spacing={2}>
                  <Grid item xs={12} sm={6}>
                    <TextField
                      label="MÃ u sáº¯c"
                      name="color"
                      value={variant.color}
                      onChange={(e) => handleChange(e, index, "variant")}
                      fullWidth
                      required
                      disabled={loading}
                      variant="outlined"
                      size="small"
                    />
                  </Grid>
                  <Grid item xs={12} sm={6}>
                    <TextField
                      label="Dung lÆ°á»£ng lÆ°u trá»¯"
                      name="storage"
                      value={variant.storage}
                      onChange={(e) => handleChange(e, index, "variant")}
                      fullWidth
                      required
                      disabled={loading}
                      variant="outlined"
                      size="small"
                    />
                  </Grid>
                  <Grid item xs={12} sm={6}>
                    <TextField
                      label="GiÃ¡"
                      name="price"
                      type="number"
                      value={variant.price}
                      onChange={(e) => handleChange(e, index, "variant")}
                      fullWidth
                      required
                      disabled={loading}
                      inputProps={{ min: 0, step: "any" }}
                      variant="outlined"
                      size="small"
                    />
                  </Grid>
                  <Grid item xs={12} sm={6}>
                    <TextField
                      label="GiÃ¡ giáº£m"
                      name="discountPrice"
                      type="number"
                      value={variant.discountPrice}
                      onChange={(e) => handleChange(e, index, "variant")}
                      fullWidth
                      disabled={loading}
                      inputProps={{ min: 0, step: "any" }}
                      variant="outlined"
                      size="small"
                    />
                  </Grid>
                  <Grid item xs={12} sm={6}>
                    <TextField
                      label="Sá»‘ lÆ°á»£ng tá»“n kho"
                      name="stockQuantity"
                      type="number"
                      value={variant.stockQuantity}
                      onChange={(e) => handleChange(e, index, "variant")}
                      fullWidth
                      required
                      disabled={loading}
                      inputProps={{ min: 0 }}
                      variant="outlined"
                      size="small"
                    />
                  </Grid>
                  <Grid item xs={12} sm={6}>
                    <TextField
                      label="Báº¯t Ä‘áº§u Flash Sale"
                      name="flashSaleStart"
                      type="datetime-local"
                      value={variant.flashSaleStart}
                      onChange={(e) => handleChange(e, index, "variant")}
                      fullWidth
                      disabled={loading}
                      InputLabelProps={{ shrink: true }}
                      variant="outlined"
                      size="small"
                    />
                  </Grid>
                  <Grid item xs={12} sm={6}>
                    <TextField
                      label="Káº¿t thÃºc Flash Sale"
                      name="flashSaleEnd"
                      type="datetime-local"
                      value={variant.flashSaleEnd}
                      onChange={(e) => handleChange(e, index, "variant")}
                      fullWidth
                      disabled={loading}
                      InputLabelProps={{ shrink: true }}
                      inputProps={{ min: variant.flashSaleStart || undefined }}
                      variant="outlined"
                      size="small"
                    />
                  </Grid>
                </Grid>
              </Box>
            ))}
            <Button
              variant="outlined"
              startIcon={<AddIcon />}
              onClick={addVariant}
              disabled={loading}
              size="small"
              sx={{ alignSelf: 'flex-start' }}
            >
              ThÃªm biáº¿n thá»ƒ
            </Button>

            <Stack direction={{xs: "column", sm: "row"}} spacing={2} mt={3}>
              <Button
                variant="outlined"
                onClick={handleCloseDrawer}
                disabled={loading}
                fullWidth
              >
                Há»§y
              </Button>
              <Button
                type="submit"
                variant="contained"
                color="primary"
                disabled={loading}
                fullWidth
                startIcon={loading ? <CircularProgress size={20} color="inherit" /> : null}
              >
                {loading ? "Äang lÆ°u..." : "LÆ°u thay Ä‘á»•i"}
              </Button>
            </Stack>
          </Stack>
        </form>
      </Box>
      <Snackbar
        open={!!successMessage}
        autoHideDuration={6000}
        onClose={handleCloseSnackbar}
        anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}
      >
        <Alert onClose={handleCloseSnackbar} severity="success" sx={{ width: '100%' }} variant="filled">
          {successMessage}
        </Alert>
      </Snackbar>
      {/* Snackbar cho lá»—i cÃ³ thá»ƒ khÃ´ng cáº§n thiáº¿t náº¿u lá»—i Ä‘Ã£ hiá»ƒn thá»‹ rÃµ trÃªn form */}
      {/* <Snackbar
        open={!!error && !successMessage}
        autoHideDuration={6000}
        onClose={handleCloseSnackbar}
        anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}
      >
        <Alert onClose={handleCloseSnackbar} severity="error" sx={{ width: '100%' }} variant="filled">
          {error}
        </Alert>
      </Snackbar> */}
    </Drawer>
  );
};

export default React.memo(EditProductDrawer);
```

### ClientApp\src\components\Admin\products\ProductsTable.jsx
```jsx
import { motion } from "framer-motion";
import { toast } from "react-toastify";
import 'react-toastify/dist/ReactToastify.css'; // Import CSS cho react-toastify
import { Edit, Search, Trash2, Settings, Filter, X, CirclePlus, ChartColumnStacked, Loader,Notebook    } from "lucide-react";
import { useState, useEffect, useMemo, useCallback } from "react";
import ProductDrawer from "./AddProductDrawer";
import EditProductDrawer from "./EditProductDrawer";
import AddSpecificationDrawer from "./AddSpecificationDrawer";
import Dialog from "@mui/material/Dialog";
import DialogActions from "@mui/material/DialogActions";
import DialogContent from "@mui/material/DialogContent";
import DialogContentText from "@mui/material/DialogContentText";
import DialogTitle from "@mui/material/DialogTitle";
import Button from "@mui/material/Button"; // MUI Button
import MuiPagination from "@mui/material/Pagination"; // Äá»•i tÃªn Ä‘á»ƒ trÃ¡nh trÃ¹ng láº·p náº¿u cÃ³
import { Select, MenuItem, TextField as MuiTextField, InputLabel, FormControl,Grid, Box, Typography } from "@mui/material"; // ThÃªm cÃ¡c component MUI cáº§n thiáº¿t

import CategoryBrandDrawer from "./CategoryBrandDrawer";
import BrandDrawer from "./BrandDrawer";
import VoucherDrawer from "./VoucherDrawer";
import useDebounce from "utils/useDebounce"; // Import hook debounce

const ProductsTable = () => {
    const [masterProducts, setMasterProducts] = useState([]); // Äá»•i tÃªn tá»« products Ä‘á»ƒ rÃµ rÃ ng hÆ¡n
    const [brands, setBrands] = useState([]);
    const [categories, setCategories] = useState([]);
    const [isLoading, setIsLoading] = useState(false); // DÃ¹ng cho cÃ¡c thao tÃ¡c loading cá»¥ thá»ƒ (vd: delete)
    const [isFetchingInitialData, setIsFetchingInitialData] = useState(true); // DÃ¹ng cho loading ban Ä‘áº§u

    const [searchInput, setSearchInput] = useState(""); // Input tÃ¬m kiáº¿m tá»©c thá»i
    const debouncedSearchTerm = useDebounce(searchInput, 500); // Debounce giÃ¡ trá»‹ tÃ¬m kiáº¿m

    const [filteredProducts, setFilteredProducts] = useState([]); // Danh sÃ¡ch sáº£n pháº©m sau khi tÃ¬m kiáº¿m hoáº·c lá»c
    
    const [isDrawerOpen, setIsDrawerOpen] = useState(false);
    const [isEditDrawerOpen, setIsEditDrawerOpen] = useState(false);
    const [selectedProduct, setSelectedProduct] = useState(null);
    const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);
    const [productToDelete, setProductToDelete] = useState(null);
    const [isCategoryBrandDrawerOpen, setIsCategoryBrandDrawerOpen] = useState(false);
    const [isBrandDrawerOpen, setIsBrandDrawerOpen] = useState(false);
    const [isVoucherDrawerOpen, setIsVoucherDrawerOpen] = useState(false);
    const [isSpecDrawerOpen, setIsSpecDrawerOpen] = useState(false);
    const [selectedProductForSpec, setSelectedProductForSpec] = useState(null);

    const [page, setPage] = useState(1);
    const productsPerPage = 11;

    const [isFilterOpen, setIsFilterOpen] = useState(false);
    const [filters, setFilters] = useState({
        brandId: '',
        categoryId: '',
        minPrice: '',
        maxPrice: ''
    });

    // Fetch dá»¯ liá»‡u ban Ä‘áº§u
    useEffect(() => {
        const fetchData = async () => {
            setIsFetchingInitialData(true);
            try {
                const [productsRes, brandsRes, categoriesRes] = await Promise.all([
                    fetch(`${process.env.REACT_APP_API_BASE_URL}/api/Products`),
                    fetch(`${process.env.REACT_APP_API_BASE_URL}/api/brands`),
                    fetch(`${process.env.REACT_APP_API_BASE_URL}/api/categories`)
                ]);

                if (!productsRes.ok || !brandsRes.ok || !categoriesRes.ok) {
                    throw new Error('Network response was not ok for one or more resources.');
                }

                const productsData = await productsRes.json();
                const brandsData = await brandsRes.json();
                const categoriesData = await categoriesRes.json();

                setMasterProducts(productsData);
                setFilteredProducts(productsData); // Ban Ä‘áº§u hiá»ƒn thá»‹ táº¥t cáº£ sáº£n pháº©m
                setBrands(brandsData.$values || brandsData || []);
                setCategories(categoriesData.$values || categoriesData || []);
            } catch (error) {
                console.error("Fetch error:", error);
                toast.error("Lá»—i khi táº£i dá»¯ liá»‡u ban Ä‘áº§u: " + error.message);
            } finally {
                setIsFetchingInitialData(false);
            }
        };
        fetchData();
    }, []);

    // Memoize maps Ä‘á»ƒ tra cá»©u nhanh
    const brandMap = useMemo(() => {
        const map = new Map();
        brands.forEach(brand => map.set(brand.id, brand.name));
        return map;
    }, [brands]);

    const categoryMap = useMemo(() => {
        const map = new Map();
        categories.forEach(category => map.set(category.id, category.name));
        return map;
    }, [categories]);

    const getBrandName = useCallback((brandId) => brandMap.get(brandId) || "KhÃ´ng rÃµ", [brandMap]);
    const getCategoryName = useCallback((categoryId) => categoryMap.get(categoryId) || "KhÃ´ng rÃµ", [categoryMap]);

    // TÃ¬m kiáº¿m sáº£n pháº©m (API call) - sá»­ dá»¥ng debouncedSearchTerm
    useEffect(() => {
        const searchProducts = async () => {
            if (debouncedSearchTerm.trim() === "") {
                // Náº¿u khÃ´ng cÃ³ search term, vÃ  khÃ´ng cÃ³ filter nÃ o Ä‘ang active (hoáº·c logic reset filter Ä‘Ã£ cháº¡y)
                // thÃ¬ nÃªn hiá»ƒn thá»‹ láº¡i danh sÃ¡ch dá»±a trÃªn filter hiá»‡n táº¡i hoáº·c danh sÃ¡ch gá»‘c
                // Táº¡m thá»i, náº¿u search trá»‘ng, apply láº¡i filter trÃªn master list.
                // Hoáº·c, náº¿u muá»‘n search ghi Ä‘Ã¨ filter, thÃ¬ pháº£i cÃ³ logic káº¿t há»£p.
                // Giá»¯ logic hiá»‡n táº¡i: search trá»‘ng -> vá» danh sÃ¡ch Ä‘Ã£ filter client-side (náº¿u cÃ³) hoáº·c master list.
                // Äá»ƒ Ä‘Æ¡n giáº£n, náº¿u search trá»‘ng, vÃ  filter cÅ©ng trá»‘ng, thÃ¬ vá» master list.
                // Náº¿u search trá»‘ng, nhÆ°ng filter cÃ³, thÃ¬ applyFilter sáº½ cháº¡y (náº¿u cÃ³ nÃºt Apply)
                // Trong logic nÃ y, search trá»‘ng thÃ¬ quay vá» danh sÃ¡ch gá»‘c (masterProducts) vÃ  filter sáº½ Ä‘Æ°á»£c apply sau náº¿u ngÆ°á»i dÃ¹ng nháº¥n nÃºt.
                // Hoáº·c, filteredProducts sáº½ tá»± cáº­p nháº­t náº¿u nÃ³ lÃ  useMemo.
                // VÃ¬ filteredProducts lÃ  state, khi search trá»‘ng, ta nÃªn Ä‘áº·t láº¡i filteredProducts dá»±a trÃªn masterProducts vÃ  filters hiá»‡n táº¡i.
                // CÃ¡ch Ä‘Æ¡n giáº£n nháº¥t lÃ  khi search trá»‘ng, reset filteredProducts vá» masterProducts, vÃ  user pháº£i tá»± apply filter láº¡i.
                 if (filters.brandId || filters.categoryId || filters.minPrice || filters.maxPrice) {
                    // Náº¿u cÃ³ filter Ä‘ang active, giá»¯ nguyÃªn filteredProducts (user cÃ³ thá»ƒ Ä‘ang muá»‘n search trong list Ä‘Ã£ filter)
                    // HOáº¶C: cháº¡y láº¡i applyFilters trÃªn masterProducts náº¿u muá»‘n search trá»‘ng lÃ  reset vá» filter trÃªn toÃ n bá»™.
                    // Hiá»‡n táº¡i, handleSearch lÃ  API call, nÃªn khi search trá»‘ng, nÃ³ sáº½ setFilteredProducts = masterProducts.
                    // Äiá»u nÃ y cÃ³ nghÄ©a lÃ  search sáº½ xÃ³a hiá»‡u lá»±c cá»§a client filter.
                    // => Cáº§n Ä‘iá»u chá»‰nh:
                    // 1. Search API -> results. Set filteredProducts = results.
                    // 2. Client filters -> operate on masterProducts. Set filteredProducts = filter_results.
                    // ÄÃ¢y lÃ  2 luá»“ng riÃªng biá»‡t cáº­p nháº­t filteredProducts.
                    // => Náº¿u search trá»‘ng, set filteredProducts vá» masterProducts (Ä‘á»ƒ filter cÃ³ thá»ƒ Ã¡p dá»¥ng láº¡i trÃªn masterProducts).
                    setFilteredProducts(masterProducts);
                } else {
                    setFilteredProducts(masterProducts);
                }
                setPage(1);
                return;
            }

            setIsLoading(true); // Loading cho tÃ¬m kiáº¿m
            try {
                const response = await fetch(`${process.env.REACT_APP_API_BASE_URL}/api/Products/search?keyword=${encodeURIComponent(debouncedSearchTerm)}`);
                if (!response.ok) {
                    const errorData = await response.text(); // Hoáº·c .json() náº¿u API tráº£ vá» JSON error
                    throw new Error(errorData || "KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m nÃ o khá»›p.");
                }
                const data = await response.json();
                setFilteredProducts(data);
                setPage(1);
            } catch (error) {
                console.error("Lá»—i khi tÃ¬m kiáº¿m sáº£n pháº©m:", error);
                toast.error(error.message || "Lá»—i tÃ¬m kiáº¿m.");
                setFilteredProducts([]); // Hiá»ƒn thá»‹ danh sÃ¡ch trá»‘ng náº¿u lá»—i
            } finally {
                setIsLoading(false);
            }
        };

        // Chá»‰ cháº¡y search náº¿u debouncedSearchTerm khÃ´ng pháº£i lÃ  giÃ¡ trá»‹ ban Ä‘áº§u (trÃ¡nh cháº¡y khi mount)
        // hoáº·c khi nÃ³ thá»±c sá»± thay Ä‘á»•i.
        if (debouncedSearchTerm !== undefined) { // Kiá»ƒm tra ká»¹ hÆ¡n, cÃ³ thá»ƒ khÃ´ng cáº§n náº¿u initial lÃ  ""
             searchProducts();
        }

    }, [debouncedSearchTerm, masterProducts]); // ThÃªm masterProducts Ä‘á»ƒ khi search trá»‘ng, nÃ³ biáº¿t láº¥y tá»« Ä‘Ã¢u

    const handleSearchInputChange = useCallback((e) => {
        setSearchInput(e.target.value);
    }, []);


    // HÃ m Ã¡p dá»¥ng bá»™ lá»c (client-side, hoáº¡t Ä‘á»™ng trÃªn masterProducts)
    const applyClientFilters = useCallback(() => {
        setIsLoading(true); // BÃ¡o hiá»‡u loading khi Ã¡p dá»¥ng filter
        let filtered = [...masterProducts]; // LuÃ´n lá»c tá»« danh sÃ¡ch gá»‘c
        
        if (filters.brandId) {
            filtered = filtered.filter(product => product.brandId == filters.brandId);
        }
        if (filters.categoryId) {
            filtered = filtered.filter(product => product.categoryId == filters.categoryId);
        }
        if (filters.minPrice) {
            filtered = filtered.filter(product => product.variants?.[0]?.price >= Number(filters.minPrice));
        }
        if (filters.maxPrice) {
            filtered = filtered.filter(product => product.variants?.[0]?.price <= Number(filters.maxPrice));
        }
        
        // Náº¿u cÃ³ search term Ä‘ang active, cÃ³ thá»ƒ muá»‘n káº¿t há»£p káº¿t quáº£ search vÃ  filter.
        // Tuy nhiÃªn, theo logic hiá»‡n táº¡i, search vÃ  filter Ä‘ang ghi Ä‘Ã¨ `filteredProducts`.
        // Äá»ƒ Ä‘Æ¡n giáº£n vÃ  giá»¯ logic cÅ©: Apply filter luÃ´n dá»±a trÃªn `masterProducts`.
        // Náº¿u muá»‘n filter trÃªn káº¿t quáº£ search, `sourceForFilter` pháº£i lÃ  káº¿t quáº£ search.
        // => Giáº£ Ä‘á»‹nh: Khi apply filter client, nÃ³ sáº½ ghi Ä‘Ã¨ káº¿t quáº£ search. Náº¿u muá»‘n search láº¡i, user pháº£i search.
        setSearchInput(""); // XÃ³a search term khi apply filter client-side Ä‘á»ƒ trÃ¡nh nháº§m láº«n
        setFilteredProducts(filtered);
        setPage(1);
        setIsFilterOpen(false); // ÄÃ³ng panel filter
        setIsLoading(false);
        toast.success("ÄÃ£ Ã¡p dá»¥ng bá»™ lá»c!");
    }, [masterProducts, filters]);

    // HÃ m reset bá»™ lá»c
    const resetClientFilters = useCallback(() => {
        setFilters({ brandId: '', categoryId: '', minPrice: '', maxPrice: '' });
        // Náº¿u cÃ³ search term Ä‘ang active, reset filter sáº½ quay vá» káº¿t quáº£ search Ä‘Ã³
        // Hoáº·c, reset filter sáº½ xÃ³a cáº£ search term. Chá»n cÃ¡ch thá»© 2 cho Ä‘Æ¡n giáº£n.
        if (searchInput) {
            // Náº¿u Ä‘ang cÃ³ search, viá»‡c reset filter nÃªn tráº£ vá» masterProducts vÃ  xÃ³a search
            setSearchInput(""); // Äiá»u nÃ y sáº½ trigger useEffect cá»§a debouncedSearchTerm vÃ  set láº¡i filteredProducts
        } else {
            setFilteredProducts(masterProducts); // Náº¿u khÃ´ng search, vá» master list
        }
        setPage(1);
        toast.info("ÄÃ£ xÃ³a bá»™ lá»c.");
    }, [masterProducts, searchInput]);

    const handleFilterChange = useCallback((e) => {
        const { name, value } = e.target;
        setFilters(prev => ({ ...prev, [name]: value }));
    }, []);


    // CRUD operations
    const handleAddProduct = useCallback((newProduct) => {
        const newMasterProducts = [newProduct, ...masterProducts];
        setMasterProducts(newMasterProducts);
        // Sau khi thÃªm, nÃªn reset cÃ¡c filter vÃ  search Ä‘á»ƒ user tháº¥y sáº£n pháº©m má»›i
        // Hoáº·c chá»‰ cáº­p nháº­t filteredProducts náº¿u sáº£n pháº©m má»›i khá»›p filter hiá»‡n táº¡i
        // ÄÆ¡n giáº£n nháº¥t: reset vá» master list Ä‘Ã£ cáº­p nháº­t, user tá»± filter/search láº¡i
        setSearchInput("");
        setFilters({ brandId: '', categoryId: '', minPrice: '', maxPrice: '' });
        setFilteredProducts(newMasterProducts); 
        setPage(1);
    }, [masterProducts]);

    const handleUpdateProduct = useCallback((updatedProduct) => {
        const updatedMasterProducts = masterProducts.map((product) =>
            product.id === updatedProduct.id ? { ...product, ...updatedProduct } : product
        );
        setMasterProducts(updatedMasterProducts);

        // Cáº­p nháº­t filteredProducts náº¿u item Ä‘Ã³ Ä‘ang hiá»ƒn thá»‹
        setFilteredProducts(prevFiltered => 
            prevFiltered.map(p => p.id === updatedProduct.id ? {...p, ...updatedProduct} : p)
        );
        // KhÃ´ng reset page á»Ÿ Ä‘Ã¢y Ä‘á»ƒ user tháº¥y item vá»«a sá»­a
    }, [masterProducts]);

    const confirmDeleteProduct = useCallback(async () => {
        // ... (giá»¯ nguyÃªn logic confirmDeleteProduct, nhÆ°ng cáº­p nháº­t masterProducts)
        if (!productToDelete) return;
        setIsLoading(true);
        try {
            const response = await fetch(`${process.env.REACT_APP_API_BASE_URL}/api/Products/${productToDelete.id}`, {
                method: "DELETE",
            });
            if (response.ok) {
                const updatedMaster = masterProducts.filter((p) => p.id !== productToDelete.id);
                setMasterProducts(updatedMaster);
                // Náº¿u sáº£n pháº©m bá»‹ xÃ³a náº±m trong filteredProducts, cÅ©ng xÃ³a nÃ³ Ä‘i
                setFilteredProducts(prevFiltered => prevFiltered.filter(p => p.id !== productToDelete.id));
                toast.success("Sáº£n pháº©m Ä‘Ã£ Ä‘Æ°á»£c xÃ³a thÃ nh cÃ´ng!");
            } else {
                // ... xá»­ lÃ½ lá»—i
            }
        } catch (error) { /* ... */ } finally {
            setIsLoading(false);
            setIsDeleteDialogOpen(false);
            setProductToDelete(null);
        }
    }, [productToDelete, masterProducts]);

    const handlePageChange = useCallback((event, value) => setPage(value), []);
    const handleEditProduct = useCallback((product) => { setSelectedProduct(product); setIsEditDrawerOpen(true); }, []);
    const handleDeleteProduct = useCallback((product) => { setProductToDelete(product); setIsDeleteDialogOpen(true); }, []);
    const handleAddSpecification = useCallback((product) => { setSelectedProductForSpec(product); setIsSpecDrawerOpen(true); }, []);


    // Pagination logic
    const currentProducts = useMemo(() => {
        const indexOfLastProduct = page * productsPerPage;
        const indexOfFirstProduct = indexOfLastProduct - productsPerPage;
        return filteredProducts.slice(indexOfFirstProduct, indexOfLastProduct);
    }, [filteredProducts, page, productsPerPage]);

    const totalPages = useMemo(() => Math.ceil(filteredProducts.length / productsPerPage), [filteredProducts.length, productsPerPage]);

    // Handlers cho cÃ¡c Drawer
    const toggleDrawer = useCallback((setter, value) => setter(value), []);


    if (isFetchingInitialData) {
        return (
            <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: 'calc(100vh - 200px)', color: 'white', flexDirection: 'column' }}>
                <Loader  color="inherit" size={50} />
                <Typography sx={{ mt: 2, fontSize: '1.1rem' }}>Äang táº£i dá»¯ liá»‡u sáº£n pháº©m...</Typography>
            </Box>
        );
    }


    return (
        <motion.div
            className="bg-gray-800 bg-opacity-70 backdrop-blur-xl shadow-2xl rounded-xl p-4 md:p-6 border border-gray-700 min-h-[calc(100vh-120px)] flex flex-col"
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.1, duration: 0.4 }}
        >
            {/* Header vÃ  cÃ¡c nÃºt actions */}
            <div className="flex flex-wrap justify-between items-center mb-6 gap-3">
                <h2 className="text-2xl font-bold text-gray-100 tracking-tight">
                    Danh sÃ¡ch sáº£n pháº©m
                </h2>
                <div className="flex flex-wrap gap-2">
                    <Button variant="contained" startIcon={<CirclePlus size={18}/>} onClick={() => toggleDrawer(setIsDrawerOpen, true)} sx={{bgcolor: '#2563EB', '&:hover': { bgcolor: '#1D4ED8' }}}>ThÃªm Sáº£n Pháº©m</Button>
                    <Button variant="outlined" startIcon={<ChartColumnStacked  size={18}/>} onClick={() => toggleDrawer(setIsCategoryBrandDrawerOpen, true)} sx={{color: '#A5B4FC', borderColor: '#4F46E5'}}>Danh Má»¥c</Button>
                    <Button variant="outlined" startIcon={<Notebook  size={18}/>} onClick={() => toggleDrawer(setIsBrandDrawerOpen, true)} sx={{color: '#A5B4FC', borderColor: '#4F46E5'}}>ThÆ°Æ¡ng hiá»‡u</Button>
                    <Button variant="outlined" startIcon={<Settings size={18}/>} onClick={() => toggleDrawer(setIsVoucherDrawerOpen, true)} sx={{color: '#A5B4FC', borderColor: '#4F46E5'}}>Voucher</Button>
                </div>
            </div>

            {/* Search vÃ  nÃºt Filter */}
            <div className="flex flex-wrap justify-between items-center mb-4 gap-3">
                <div className="relative flex-grow max-w-xs">
                    <MuiTextField
                        label="TÃ¬m kiáº¿m sáº£n pháº©m"
                        variant="outlined"
                        size="small"
                        fullWidth
                        value={searchInput}
                        onChange={handleSearchInputChange}
                        InputProps={{
                            startAdornment: <Search className="text-gray-400 mr-2" size={18} />,
                            sx: { borderRadius: '8px', bgcolor: 'rgba(30,41,59,0.7)', input: { color: 'white' }, '& .MuiOutlinedInput-notchedOutline': { borderColor: '#4B5563' } }
                        }}
                        InputLabelProps={{sx: {color: '#9CA3AF'}}}
                    />
                </div>
                <Button 
                    variant="outlined"
                    startIcon={isFilterOpen ? <X size={18} /> : <Filter size={18} />}
                    onClick={() => setIsFilterOpen(!isFilterOpen)}
                    sx={{color: '#A5B4FC', borderColor: '#4F46E5'}}
                >
                    {isFilterOpen ? 'ÄÃ³ng lá»c' : 'Lá»c sáº£n pháº©m'}
                </Button>
            </div>
            
            {/* Panel bá»™ lá»c (náº¿u isFilterOpen lÃ  true) */}
            {isFilterOpen && (
                <motion.div 
                    initial={{ opacity: 0, height: 0, marginBottom:0 }}
                    animate={{ opacity: 1, height: 'auto', marginBottom: '1rem' }}
                    exit={{ opacity: 0, height: 0, marginBottom:0 }}
                    className="bg-gray-700/50 p-4 rounded-lg border border-gray-600"
                >
                    <Grid container spacing={2} alignItems="center">
                        <Grid item xs={12} sm={6} md={3}>
                            <FormControl fullWidth size="small">
                                <InputLabel sx={{color: '#9CA3AF'}}>ThÆ°Æ¡ng hiá»‡u</InputLabel>
                                <Select name="brandId" value={filters.brandId} label="ThÆ°Æ¡ng hiá»‡u" onChange={handleFilterChange} sx={{color: filters.brandId ? 'white' : '#9CA3AF', bgcolor: 'rgba(30,41,59,0.7)', '.MuiOutlinedInput-notchedOutline': {borderColor: '#4B5563'}}}>
                                    <MenuItem value=""><em>Táº¥t cáº£ thÆ°Æ¡ng hiá»‡u</em></MenuItem>
                                    {brands.map(brand => (<MenuItem key={brand.id} value={brand.id}>{brand.name}</MenuItem>))}
                                </Select>
                            </FormControl>
                        </Grid>
                        <Grid item xs={12} sm={6} md={3}>
                             <FormControl fullWidth size="small">
                                <InputLabel sx={{color: '#9CA3AF'}}>Danh má»¥c</InputLabel>
                                <Select name="categoryId" value={filters.categoryId} label="Danh má»¥c" onChange={handleFilterChange} sx={{color: filters.categoryId ? 'white' : '#9CA3AF', bgcolor: 'rgba(30,41,59,0.7)', '.MuiOutlinedInput-notchedOutline': {borderColor: '#4B5563'}}}>
                                    <MenuItem value=""><em>Táº¥t cáº£ danh má»¥c</em></MenuItem>
                                    {categories.map(cat => (<MenuItem key={cat.id} value={cat.id}>{cat.name}</MenuItem>))}
                                </Select>
                            </FormControl>
                        </Grid>
                        <Grid item xs={12} sm={6} md={2.5}>
                            <MuiTextField type="number" name="minPrice" label="GiÃ¡ tá»« (VND)" value={filters.minPrice} onChange={handleFilterChange} fullWidth size="small" InputLabelProps={{sx:{color:"#9CA3AF"}}} InputProps={{sx:{color:"white", bgcolor: 'rgba(30,41,59,0.7)', '.MuiOutlinedInput-notchedOutline': {borderColor: '#4B5563'}}}} />
                        </Grid>
                        <Grid item xs={12} sm={6} md={2.5}>
                            <MuiTextField type="number" name="maxPrice" label="Äáº¿n (VND)" value={filters.maxPrice} onChange={handleFilterChange} fullWidth size="small" InputLabelProps={{sx:{color:"#9CA3AF"}}} InputProps={{sx:{color:"white", bgcolor: 'rgba(30,41,59,0.7)', '.MuiOutlinedInput-notchedOutline': {borderColor: '#4B5563'}}}} />
                        </Grid>
                        <Grid item xs={12} md={1} container spacing={1} justifyContent="flex-end">
                           <Button onClick={resetClientFilters} size="small" sx={{color: '#CBD5E1', minWidth: 'auto', padding: '6px'}}>XÃ³a</Button>
                           <Button onClick={applyClientFilters} variant="contained" size="small" sx={{bgcolor: '#4F46E5', minWidth: 'auto', padding: '6px'}}>Lá»c</Button>
                        </Grid>
                    </Grid>
                </motion.div>
            )}
            
            {/* Báº£ng hiá»ƒn thá»‹ sáº£n pháº©m */}
            <div className="overflow-x-auto custom-scrollbar flex-grow rounded-lg border border-gray-700/50">
                <table className="min-w-full divide-y divide-gray-600">
                    <thead className="bg-gray-700 bg-opacity-40 sticky top-0 z-10 backdrop-blur-sm">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Sáº£n pháº©m</th>
                            <th className="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">ThÆ°Æ¡ng hiá»‡u</th>
                            <th className="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Danh má»¥c</th>
                            <th className="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">GiÃ¡ gá»‘c</th>
                            <th className="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">GiÃ¡ bÃ¡n</th>
                            <th className="px-6 py-3 text-center text-xs font-semibold text-gray-300 uppercase tracking-wider">HÃ nh Ä‘á»™ng</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-600">
                        {isLoading && currentProducts.length === 0 && ( // Hiá»ƒn thá»‹ loading khi Ä‘ang tÃ¬m kiáº¿m vÃ  chÆ°a cÃ³ káº¿t quáº£ nÃ o
                             <tr><td colSpan={6} className="text-center py-10"><Loader  size={30} sx={{color: 'white'}} /></td></tr>
                        )}
                        {!isLoading && currentProducts.length === 0 && !isFetchingInitialData && (
                             <tr><td colSpan={6} className="text-center py-10 text-gray-400 italic">KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m nÃ o.</td></tr>
                        )}
                        {currentProducts.map((product) => (
                            <motion.tr
                                key={product.id}
                                layout
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                transition={{ duration: 0.3 }}
                                className="hover:bg-gray-700/60"
                            >
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100">
                                    <div className="flex items-center gap-3">
                                        <img
                                            src={product.images?.[0]?.imageUrl?.startsWith("http") ? product.images[0].imageUrl : `${process.env.REACT_APP_API_BASE_URL}/${product.images?.[0]?.imageUrl}`}
                                            alt={product.name || "product image"}
                                            className="w-12 h-12 rounded-md object-cover border border-gray-600"
                                            onError={(e) => { e.target.onerror = null; e.target.src = "https://via.placeholder.com/100?text=Error"; }}
                                        />
                                        <span className="truncate max-w-xs" title={product.name}>{product.name || "ChÆ°a cÃ³ tÃªn"}</span>
                                    </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{getBrandName(product.brandId)}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{getCategoryName(product.categoryId)}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                    {product.variants?.[0]?.price ? `${product.variants[0].price.toLocaleString()} VND` : "N/A"}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-indigo-400 font-semibold">
                                    {product.variants?.[0]?.discountPrice ? `${product.variants[0].discountPrice.toLocaleString()} VND` : (product.variants?.[0]?.price ? `${product.variants[0].price.toLocaleString()} VND` : "N/A")}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300 text-center">
                                    <button onClick={() => handleEditProduct(product)} className="text-sky-400 hover:text-sky-300 p-1.5 rounded-full hover:bg-gray-600/50" title="Sá»­a sáº£n pháº©m"><Edit size={18} /></button>
                                    <button onClick={() => handleAddSpecification(product)} className="text-teal-400 hover:text-teal-300 p-1.5 ml-1.5 rounded-full hover:bg-gray-600/50" title="Quáº£n lÃ½ thÃ´ng sá»‘"><Settings size={18} /></button>
                                    <button onClick={() => handleDeleteProduct(product)} className="text-rose-400 hover:text-rose-300 p-1.5 ml-1.5 rounded-full hover:bg-gray-600/50" title="XÃ³a sáº£n pháº©m"><Trash2 size={18} /></button>
                                </td>
                            </motion.tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* PhÃ¢n trang */}
            {totalPages > 0 && (
                <Box sx={{ display: 'flex', justifyContent: 'center', p: 2, mt: 'auto', borderTop:'1px solid rgba(75, 85, 99, 0.5)', paddingTop: '1rem' }}>
                    <MuiPagination
                        count={totalPages}
                        page={page}
                        onChange={handlePageChange}
                        color="primary"
                        size="small"
                        sx={{ '& .MuiPaginationItem-root': { color: '#9CA3AF', fontWeight:'medium' }, '& .MuiPaginationItem-root.Mui-selected': { backgroundColor: 'rgba(79, 70, 229, 0.9)', color: 'white', '&:hover': { backgroundColor: 'rgba(79, 70, 229, 1)'}}, '& .MuiPaginationItem-ellipsis': { color: '#9CA3AF' }, '& .MuiPaginationItem-icon': {color: '#A5B4FC'} }}
                    />
                </Box>
            )}

            {/* CÃ¡c Drawers vÃ  Dialogs */}
            <ProductDrawer isOpen={isDrawerOpen} onClose={() => toggleDrawer(setIsDrawerOpen, false)} onAddProduct={handleAddProduct} />
            <EditProductDrawer isOpen={isEditDrawerOpen} onClose={() => toggleDrawer(setIsEditDrawerOpen, false)} product={selectedProduct} onUpdateProduct={handleUpdateProduct} />
            <AddSpecificationDrawer open={isSpecDrawerOpen} onClose={() => toggleDrawer(setIsSpecDrawerOpen, false)} product={selectedProductForSpec} />
            <CategoryBrandDrawer open={isCategoryBrandDrawerOpen} onClose={() => toggleDrawer(setIsCategoryBrandDrawerOpen, false)} />
            <BrandDrawer open={isBrandDrawerOpen} onClose={() => toggleDrawer(setIsBrandDrawerOpen, false)} />
            <VoucherDrawer open={isVoucherDrawerOpen} onClose={() => toggleDrawer(setIsVoucherDrawerOpen, false)} />

            <Dialog open={isDeleteDialogOpen} onClose={() => toggleDrawer(setIsDeleteDialogOpen, false)}>
                <DialogTitle sx={{bgcolor: 'rgb(31,41,55)', color: 'white'}}>{"XÃ¡c nháº­n xÃ³a sáº£n pháº©m"}</DialogTitle>
                <DialogContent sx={{bgcolor: 'rgb(31,41,55)', color: 'rgb(209,213,219)'}}>
                    <DialogContentText sx={{color: 'rgb(209,213,219)'}}>
                        Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a sáº£n pháº©m "{productToDelete?.name}" khÃ´ng? HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c.
                    </DialogContentText>
                </DialogContent>
                <DialogActions sx={{bgcolor: 'rgb(31,41,55)'}}>
                    <Button onClick={() => toggleDrawer(setIsDeleteDialogOpen, false)} sx={{color: '#A5B4FC'}}>Há»§y</Button>
                    <Button onClick={confirmDeleteProduct} sx={{color: '#F87171'}} autoFocus disabled={isLoading}>
                        {isLoading ? <Loader  size={20} color="inherit"/> : "XÃ³a"}
                    </Button>
                </DialogActions>
            </Dialog>
        </motion.div>
    );
};

export default ProductsTable;
```

### ClientApp\src\components\Admin\products\SalesTrendChart.jsx
```jsx
import { motion } from "framer-motion";
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from "recharts";

const salesData = [
	{ month: "Jan", sales: 4000 },
	{ month: "Feb", sales: 3000 },
	{ month: "Mar", sales: 5000 },
	{ month: "Apr", sales: 4500 },
	{ month: "May", sales: 6000 },
	{ month: "Jun", sales: 5500 },
];

const SalesTrendChart = () => {
	return (
		<motion.div
			className='bg-gray-800 bg-opacity-50 backdrop-blur-md shadow-lg rounded-xl p-6 border border-gray-700'
			initial={{ opacity: 0, y: 20 }}
			animate={{ opacity: 1, y: 0 }}
			transition={{ delay: 0.3 }}
		>
			<h2 className='text-xl font-semibold text-gray-100 mb-4'>Sales Trend</h2>
			<div style={{ width: "100%", height: 300 }}>
				<ResponsiveContainer>
					<LineChart data={salesData}>
						<CartesianGrid strokeDasharray='3 3' stroke='#374151' />
						<XAxis dataKey='month' stroke='#9CA3AF' />
						<YAxis stroke='#9CA3AF' />
						<Tooltip
							contentStyle={{
								backgroundColor: "rgba(31, 41, 55, 0.8)",
								borderColor: "#4B5563",
							}}
							itemStyle={{ color: "#E5E7EB" }}
						/>
						<Legend />
						<Line type='monotone' dataKey='sales' stroke='#8B5CF6' strokeWidth={2} />
					</LineChart>
				</ResponsiveContainer>
			</div>
		</motion.div>
	);
};
export default SalesTrendChart;

```

### ClientApp\src\components\Admin\products\VoucherDrawer.jsx
```jsx
import React, { useState, useEffect } from "react";
import { Drawer,Chip, Button, Box, Typography, IconButton, Table, TableBody, TableCell, TableContainer, TableHead, TableRow, Paper, Modal, TextField, Switch } from "@mui/material";
import { X, Edit, Trash2, Plus } from "lucide-react";
import axios from "axios";

const VoucherDrawer = ({ open, onClose }) => {
    const [vouchers, setVouchers] = useState([]);
    const [modalOpen, setModalOpen] = useState(false);
    const [isEditing, setIsEditing] = useState(false);
    const [selectedVoucherId, setSelectedVoucherId] = useState(null);
    const [voucher, setVoucher] = useState({ code: "", discountAmount: "", expiryDate: "", isActive: true });

    useEffect(() => {
        fetchVouchers();
    }, []);

    const fetchVouchers = async () => {
        try {
            const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/vouchers`);
            setVouchers(response.data);
        } catch (error) {
            console.error("Failed to fetch vouchers:", error);
        }
    };

    const handleChange = (e) => {
        const { name, value } = e.target;
        setVoucher({ ...voucher, [name]: value });
    };

    const handleToggleActive = (e) => {
        setVoucher({ ...voucher, isActive: e.target.checked });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            if (isEditing) {
                await axios.put(`${process.env.REACT_APP_API_BASE_URL}/api/vouchers/${selectedVoucherId}`, voucher);
                setIsEditing(false);
                setSelectedVoucherId(null);
            } else {
                await axios.post(`${process.env.REACT_APP_API_BASE_URL}/api/vouchers`, voucher);
            }
            fetchVouchers();
            handleCloseModal();
        } catch (error) {
            console.error("Failed to save voucher:", error);
        }
    };

    const handleEdit = (voucher) => {
        setVoucher(voucher);
        setIsEditing(true);
        setSelectedVoucherId(voucher.id);
        setModalOpen(true);
    };

    const handleDelete = async (id) => {
        try {
            await axios.delete(`${process.env.REACT_APP_API_BASE_URL}/api/vouchers/${id}`);
            fetchVouchers();
        } catch (error) {
            console.error("Failed to delete voucher:", error);
        }
    };

    const handleOpenModal = () => {
        setIsEditing(false);
        setVoucher({ code: "", discountAmount: "", expiryDate: "", isActive: true });
        setModalOpen(true);
    };

    const handleCloseModal = () => {
        setModalOpen(false);
    };

    return (
        <Drawer anchor="right" open={open} onClose={onClose}>
            <Box sx={{ width: 600, p: 3, bgcolor: "white", height: "100%" }}>
                <Box display="flex" justifyContent="space-between" alignItems="center" mb={2}>
                    <Typography variant="h6" fontWeight="bold">Xem Voucher</Typography>
                    <IconButton onClick={onClose}><X size={24} /></IconButton>
                </Box>
                <Button onClick={handleOpenModal} variant="contained" sx={{ bgcolor: "black", color: "white", mb: 2 }}>
                    <Plus size={18} /> ThÃªm Voucher
                </Button>
                <TableContainer component={Paper}>
                    <Table>
                        <TableHead sx={{ bgcolor: "black" }}>
                            <TableRow>
                                <TableCell sx={{ color: "white" }}>MÃ£ Voucher</TableCell>
                                <TableCell sx={{ color: "white" }}>Giáº£m GiÃ¡</TableCell>
                                <TableCell sx={{ color: "white" }}>Háº¡n Sá»­ Dá»¥ng</TableCell>
                                <TableCell sx={{ color: "white" }}>Tráº¡ng ThÃ¡i</TableCell>
                                <TableCell sx={{ color: "white" }}>HÃ nh Äá»™ng</TableCell>
                            </TableRow>
                        </TableHead>
                        <TableBody>
                            {vouchers.map((voucher) => (
                                <TableRow key={voucher.id}>
                                    <TableCell>{voucher.code}</TableCell>
                                    <TableCell>{voucher.discountAmount}</TableCell>
                                    <TableCell>{voucher.expiryDate}</TableCell>
                        <TableCell>
                            <Chip
                                label={voucher.isActive ? "Äang hoáº¡t Ä‘á»™ng" : "Táº¯t"}
                                color={voucher.isActive ? "success" : "error"}
                                sx={{ fontWeight: "bold", color: "white" }}
                            />
                        </TableCell>
                                    <TableCell>
                                        <IconButton onClick={() => handleEdit(voucher)}><Edit size={18} color="blue" /></IconButton>
                                        <IconButton onClick={() => handleDelete(voucher.id)}><Trash2 size={18} color="red" /></IconButton>
                                    </TableCell>
                                </TableRow>
                            ))}
                        </TableBody>
                    </Table>
                </TableContainer>
            </Box>

            {/* Modal thÃªm & sá»­a Voucher */}
            <Modal open={modalOpen} onClose={handleCloseModal}>
                <Box sx={{
                    position: "absolute",
                    top: "50%",
                    left: "50%",
                    transform: "translate(-50%, -50%)",
                    bgcolor: "white",
                    border: "2px solid black",
                    borderRadius: 2,
                    boxShadow: 24,
                    p: 4,
                    width: 400
                }}>
                    <Typography variant="h6" fontWeight="bold" mb={2}>{isEditing ? "Chá»‰nh sá»­a Voucher" : "ThÃªm Voucher"}</Typography>
                    <TextField fullWidth label="MÃ£ Voucher" name="code" value={voucher.code} onChange={handleChange} sx={{ mb: 2 }} />
                    <TextField fullWidth label="Sá»‘ tiá»n giáº£m giÃ¡" name="discountAmount" type="number" value={voucher.discountAmount} onChange={handleChange} sx={{ mb: 2 }} />
                    <TextField
                        fullWidth
                        label="NgÃ y háº¿t háº¡n"
                        name="expiryDate"
                        type="date"
                        value={voucher.expiryDate}
                        onChange={handleChange}
                        sx={{ mb: 2 }}
                        InputLabelProps={{ shrink: true }} // Fix lá»—i chá»¯ bá»‹ Ä‘Ã¨
                    />
                    <Box display="flex" alignItems="center" mb={2}>
                        <Typography variant="body2">KÃ­ch hoáº¡t</Typography>
                        <Switch checked={voucher.isActive} onChange={handleToggleActive} />
                    </Box>
                    <Button fullWidth onClick={handleSubmit} variant="contained" sx={{ bgcolor: "black", color: "white" }}>
                        {isEditing ? "Cáº­p nháº­t Voucher" : "ThÃªm Voucher"}
                    </Button>
                </Box>
            </Modal>
        </Drawer>
    );
};

export default VoucherDrawer;

```

### ClientApp\src\components\Admin\sales\DailySalesTrend.jsx
```jsx
import { motion } from "framer-motion";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
} from "recharts";
import { useEffect, useState } from "react";
import axios from "axios";

const DailySalesTrend = () => {
  const [dailySalesData, setDailySalesData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [days, setDays] = useState(7); // Máº·c Ä‘á»‹nh 7 ngÃ y

  useEffect(() => {
    const fetchData = async () => {
      try {
        const response = await axios.get(
          `${process.env.REACT_APP_API_BASE_URL}/orders/dashboard/sales-overview?range=${days}`
        );
        setDailySalesData(response.data);
        setLoading(false);
      } catch (err) {
        setError(err.message);
        setLoading(false);
        console.error("Error fetching daily sales data:", err);
      }
    };

    fetchData();
  }, [days]);

  if (loading) return <div className="text-center py-8">Loading...</div>;
  if (error)
    return <div className="text-center py-8 text-red-500">Error: {error}</div>;

  return (
    <motion.div
      className="bg-gray-800 bg-opacity-50 backdrop-blur-md shadow-lg rounded-xl p-6 border border-gray-700"
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay: 0.4 }}
    >
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-semibold text-gray-100">
          Doanh sá»‘ hÃ ng ngÃ y
        </h2>
        <select
          value={days}
          onChange={(e) => setDays(Number(e.target.value))}
          className="bg-gray-700 text-white rounded px-3 py-1"
        >
          <option value={7}>7 ngÃ y gáº§n Ä‘Ã¢y</option>
          <option value={14}>14 ngÃ y gáº§n Ä‘Ã¢y</option>
          <option value={30}>30 ngÃ y gáº§n Ä‘Ã¢y</option>
        </select>
      </div>

      <div style={{ width: "100%", height: 300 }}>
        <ResponsiveContainer>
          <BarChart data={dailySalesData}>
            <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
            <XAxis
              dataKey="name"
              stroke="#9CA3AF"
              tickFormatter={(value, index) => {
                // Hiá»ƒn thá»‹ cáº£ ngÃ y vÃ  thÃ¡ng cho khoáº£ng thá»i gian dÃ i
                if (days > 7) return dailySalesData[index]?.fullDate || value;
                return value;
              }}
            />
            <YAxis stroke="#9CA3AF" />
            <Tooltip
              formatter={(value) => [
                `${Number(value).toLocaleString()} VNÄ`,
                "Sales",
              ]}
              labelFormatter={(label) => {
                const fullDate = dailySalesData.find(
                  (d) => d.name === label
                )?.fullDate;
                return fullDate ? `${label}, ${fullDate}` : label;
              }}
              contentStyle={{
                backgroundColor: "rgba(31, 41, 55, 0.8)",
                borderColor: "#4B5563",
                borderRadius: "0.5rem",
              }}
              itemStyle={{ color: "#E5E7EB" }}
            />
            <Bar
              dataKey="sales"
              fill="#10B981"
              radius={[4, 4, 0, 0]}
              animationDuration={2000}
            />
          </BarChart>
        </ResponsiveContainer>
      </div>
    </motion.div>
  );
};

export default DailySalesTrend;

```

### ClientApp\src\components\Admin\sales\SalesByCategoryChart.jsx
```jsx
import { motion } from "framer-motion";
import { PieChart, Pie, Cell, Tooltip, Legend, ResponsiveContainer } from "recharts";
import { useEffect, useState } from "react";
import axios from "axios";

const COLORS = ["#8884d8", "#82ca9d", "#ffc658", "#ff8042", "#0088FE"];

const SalesByCategoryChart = () => {
    const [salesByCategory, setSalesByCategory] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    useEffect(() => {
        const fetchData = async () => {
            try {
                const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/orders/sales-by-category`);
                setSalesByCategory(response.data);
                setLoading(false);
            } catch (err) {
                setError(err.message);
                setLoading(false);
                console.error("Error fetching sales data:", err);
            }
        };

        fetchData();
    }, []);

    if (loading) return <div className="text-center py-8">Loading...</div>;
    if (error) return <div className="text-center py-8 text-red-500">Error: {error}</div>;

    return (
        <motion.div
            className='bg-gray-800 bg-opacity-50 backdrop-blur-md shadow-lg rounded-xl p-6 border border-gray-700'
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.3 }}
        >
            <h2 className='text-xl font-semibold text-gray-100 mb-4'>Tá»‰ lá»‡ Ä‘Æ¡n hÃ ng theo danh má»¥c</h2>

            <div style={{ width: "100%", height: 300 }}>
                <ResponsiveContainer>
                    <PieChart>
                        <Pie
                            data={salesByCategory}
                            cx='50%'
                            cy='50%'
                            outerRadius={80}
                            fill='#8884d8'
                            dataKey='value'
                            label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                        >
                            {salesByCategory.map((entry, index) => (
                                <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                            ))}
                        </Pie>
                        <Tooltip
                            formatter={(value) => [`${Number(value).toLocaleString()} VNÄ`, "Total Sales"]}
                            contentStyle={{
                                backgroundColor: "rgba(31, 41, 55, 0.8)",
                                borderColor: "#4B5563",
                                borderRadius: "0.5rem",
                            }}
                            itemStyle={{ color: "#E5E7EB" }}
                        />
                        <Legend />
                    </PieChart>
                </ResponsiveContainer>
            </div>
        </motion.div>
    );
};

export default SalesByCategoryChart;
```

### ClientApp\src\components\Admin\sales\SalesOverviewChart.jsx
```jsx
import { motion } from "framer-motion";
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from "recharts";
import { useState, useEffect } from "react";
import axios from "axios";

const SalesOverviewChart = () => {
    const [selectedTimeRange, setSelectedTimeRange] = useState("month");
    const [chartData, setChartData] = useState([]);
    const [summary, setSummary] = useState(null);
    const [xAxisKey, setXAxisKey] = useState("day");
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(null);

    useEffect(() => {
        const fetchSalesData = async () => {
            setIsLoading(true);
            setError(null);
            try {
                const response = await axios.get(
                    `${process.env.REACT_APP_API_BASE_URL}/api/orders/dashboard/sales-overview`,
                    { params: { range: selectedTimeRange } }
                );
                console.log("Response Data:", response.data);
                if (!response.data || !response.data.data) { // Sá»­a thÃ nh response.data.data
                    throw new Error("Dá»¯ liá»‡u API khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng");
                }
                const { data, xAxisKey, summary } = response.data; // Sá»­a destructuring
                setChartData(data || []);
                setXAxisKey(xAxisKey || "day");
                setSummary(summary || null);
            } catch (error) {
                setError("KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u doanh thu: " + error.message);
                console.error("Error fetching sales data:", error);
                setChartData([]);
            } finally {
                setIsLoading(false);
            }
        };

        fetchSalesData();
    }, [selectedTimeRange]);

    const formatCurrency = (value) => {
  if (value >= 1000000) {
    // Chia sá»‘ tiá»n cho triá»‡u
    const millions = Math.floor(value / 1000000);  // Láº¥y pháº§n nguyÃªn (triá»‡u)
    const remainder = Math.floor((value % 1000000) / 100000);  // Láº¥y pháº§n tháº­p phÃ¢n, lÃ m trÃ²n Ä‘áº¿n 100 ngÃ n

    // Náº¿u cÃ³ pháº§n tháº­p phÃ¢n
    if (remainder > 0) {
      return `${millions}tr${remainder}`;
    } else {
      return `${millions}tr`;  // Náº¿u khÃ´ng cÃ³ pháº§n tháº­p phÃ¢n, chá»‰ hiá»ƒn thá»‹ triá»‡u
    }
  } else if (value >= 1000) {
    // Chuyá»ƒn thÃ nh nghÃ¬n (k) náº¿u cáº§n
    return `${(value / 1000).toFixed(0)}k`;
  } else {
    return value.toLocaleString('vi-VN');  // Náº¿u khÃ´ng pháº£i triá»‡u hoáº·c nghÃ¬n, giá»¯ nguyÃªn
  }
};

    const getTitle = () => {
        switch (selectedTimeRange) {
            case "week": return "Tá»•ng Quan Doanh Thu Tuáº§n";
            case "month": return "Tá»•ng Quan Doanh Thu ThÃ¡ng";
            case "year": return "Tá»•ng Quan Doanh Thu NÄƒm";
            default: return "Tá»•ng Quan Doanh Thu";
        }
    };

    const getXAxisLabel = () => {
        return xAxisKey === "month" ? "ThÃ¡ng" : "NgÃ y";
    };

    return (
        <motion.div
            className='bg-gray-800 bg-opacity-50 backdrop-blur-md shadow-lg rounded-xl p-6 border border-gray-700 mb-8'
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.2 }}
        >
            <div className='flex items-center justify-between mb-6'>
                <h2 className='text-xl font-semibold text-gray-100'>{getTitle()}</h2>
                <select
                    className='bg-gray-700 text-white rounded-md px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500'
                    value={selectedTimeRange}
                    onChange={(e) => setSelectedTimeRange(e.target.value)}
                    disabled={isLoading}
                >
                    <option value="week">Tuáº§n </option>
                    <option value="month">ThÃ¡ng trÆ°á»›c </option>
                    <option value="year">NÄƒm </option>
                </select>
            </div>

            {isLoading ? (
                <div className="flex justify-center items-center h-80">
                    <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
                </div>
            ) : error ? (
                <div className="text-red-500 text-center h-80 flex items-center justify-center">
                    {error}
                </div>
            ) : (
                <>
                    {console.log("Chart Data:", chartData)}
                    <div className='w-full h-80'>
                        <ResponsiveContainer>
                            <BarChart data={chartData}>
    <CartesianGrid strokeDasharray='3 3' stroke='#374151' />
    <XAxis 
        dataKey="shortPeriod"
        stroke='#9CA3AF'
        label={{ value: getXAxisLabel(), position: 'insideBottom', offset: -5 }}
    />
    <YAxis 
        stroke='#9CA3AF'
        tickFormatter={(value) => formatCurrency(value)}  // Sá»­ dá»¥ng hÃ m Ä‘á»‹nh dáº¡ng tiá»n
        label={{ value: 'Doanh thu (VND)', angle: -90, position: 'insideLeft' }}
    />
    <Tooltip
        contentStyle={{ backgroundColor: "rgba(31, 41, 55, 0.8)", borderColor: "#4B5563" }}
        itemStyle={{ color: "#E5E7EB" }}
        formatter={(value, name) => [formatCurrency(value), "Doanh thu"]}
        labelFormatter={(label) => chartData.find(d => d.shortPeriod === label)?.formattedPeriod || label}
    />
    <Bar 
        dataKey='sales'
        fill='#8B5CF6'
        name="Doanh thu"
    />
</BarChart>
                        </ResponsiveContainer>
                    </div>

                    {summary && (
                        <div className='mt-4 text-gray-100 grid grid-cols-1 md:grid-cols-2 gap-2'>
                            <p>Tá»•ng doanh thu: {formatCurrency(summary.totalSales)}</p>
                            {summary.averageDailySales && (
                                <p>Doanh thu trung bÃ¬nh ngÃ y: {formatCurrency(summary.averageDailySales)}</p>
                            )}
                            {summary.averageMonthlySales && (
                                <p>Doanh thu trung bÃ¬nh thÃ¡ng: {formatCurrency(summary.averageMonthlySales)}</p>
                            )}
                            {summary.bestMonth && <p>ThÃ¡ng tá»‘t nháº¥t: {summary.bestMonth}</p>}
                            {summary.worstMonth && <p>ThÃ¡ng tháº¥p nháº¥t: {summary.worstMonth}</p>}
                        </div>
                    )}
                </>
            )}
        </motion.div>
    );
};

export default SalesOverviewChart;
```

### ClientApp\src\components\Admin\settings\ConnectedAccounts.jsx
```jsx
import { useState } from "react";
import SettingSection from "./SettingSection";
import { HelpCircle, Plus } from "lucide-react";

const ConnectedAccounts = () => {
	const [connectedAccounts, setConnectedAccounts] = useState([
		{
			id: 1,
			name: "Google",
			connected: true,
			icon: "/google.png",
		},
		{
			id: 2,
			name: "Facebook",
			connected: false,
			icon: "/facebook.svg",
		},
		{
			id: 3,
			name: "Twitter",
			connected: true,
			icon: "/x.png",
		},
	]);
	return (
		<SettingSection icon={HelpCircle} title={"Connected Accounts"}>
			{connectedAccounts.map((account) => (
				<div key={account.id} className='flex items-center justify-between py-3'>
					<div className='flex gap-1'>
						<img src={account.icon} alt='Social img' className='size-6 object-cover rounded-full mr-2' />
						<span className='text-gray-300'>{account.name}</span>
					</div>
					<button
						className={`px-3 py-1 rounded ${
							account.connected ? "bg-green-600 hover:bg-green-700" : "bg-gray-600 hover:bg-gray-700"
						} transition duration-200`}
						onClick={() => {
							setConnectedAccounts(
								connectedAccounts.map((acc) => {
									if (acc.id === account.id) {
										return {
											...acc,
											connected: !acc.connected,
										};
									}
									return acc;
								})
							);
						}}
					>
						{account.connected ? "Connected" : "Connect"}
					</button>
				</div>
			))}
			<button className='mt-4 flex items-center text-indigo-400 hover:text-indigo-300 transition duration-200'>
				<Plus size={18} className='mr-2' /> Add Account
			</button>
		</SettingSection>
	);
};
export default ConnectedAccounts;

```

### ClientApp\src\components\Admin\settings\DangerZone.jsx
```jsx
import { motion } from "framer-motion";
import { Trash2 } from "lucide-react";

const DangerZone = () => {
	return (
		<motion.div
			className='bg-red-900 bg-opacity-50 backdrop-filter backdrop-blur-lg shadow-lg rounded-xl p-6 border border-red-700 mb-8'
			initial={{ opacity: 0, y: 20 }}
			animate={{ opacity: 1, y: 0 }}
			transition={{ duration: 0.5, delay: 0.2 }}
		>
			<div className='flex items-center mb-4'>
				<Trash2 className='text-red-400 mr-3' size={24} />
				<h2 className='text-xl font-semibold text-gray-100'>Danger Zone</h2>
			</div>
			<p className='text-gray-300 mb-4'>Permanently delete your account and all of your content.</p>
			<button
				className='bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded 
      transition duration-200'
			>
				Delete Account
			</button>
		</motion.div>
	);
};
export default DangerZone;

```

### ClientApp\src\components\Admin\settings\Notifications.jsx
```jsx
import { useState } from "react";
import SettingSection from "./SettingSection";
import { Bell } from "lucide-react";
import ToggleSwitch from "./ToggleSwitch";

const Notifications = () => {
	const [notifications, setNotifications] = useState({
		push: true,
		email: false,
		sms: true,
	});

	return (
		<SettingSection icon={Bell} title={"Notifications"}>
			<ToggleSwitch
				label={"Push Notifications"}
				isOn={notifications.push}
				onToggle={() => setNotifications({ ...notifications, push: !notifications.push })}
			/>
			<ToggleSwitch
				label={"Email Notifications"}
				isOn={notifications.email}
				onToggle={() => setNotifications({ ...notifications, email: !notifications.email })}
			/>
			<ToggleSwitch
				label={"SMS Notifications"}
				isOn={notifications.sms}
				onToggle={() => setNotifications({ ...notifications, sms: !notifications.sms })}
			/>
		</SettingSection>
	);
};
export default Notifications;

```

### ClientApp\src\components\Admin\settings\Profile.jsx
```jsx
import { User } from "lucide-react";
import SettingSection from "./SettingSection";

const Profile = () => {
	return (
		<SettingSection icon={User} title={"Profile"}>
			<div className='flex flex-col sm:flex-row items-center mb-6'>
				<img
					src='https://randomuser.me/api/portraits/men/3.jpg'
					alt='Profile'
					className='rounded-full w-20 h-20 object-cover mr-4'
				/>

				<div>
					<h3 className='text-lg font-semibold text-gray-100'>John Doe</h3>
					<p className='text-gray-400'>john.doe@example.com</p>
				</div>
			</div>

			<button className='bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition duration-200 w-full sm:w-auto'>
				Edit Profile
			</button>
		</SettingSection>
	);
};
export default Profile;

```

### ClientApp\src\components\Admin\settings\Security.jsx
```jsx
import { Lock } from "lucide-react";
import SettingSection from "./SettingSection";
import ToggleSwitch from "./ToggleSwitch";
import { useState } from "react";

const Security = () => {
	const [twoFactor, setTwoFactor] = useState(false);

	return (
		<SettingSection icon={Lock} title={"Security"}>
			<ToggleSwitch
				label={"Two-Factor Authentication"}
				isOn={twoFactor}
				onToggle={() => setTwoFactor(!twoFactor)}
			/>
			<div className='mt-4'>
				<button
					className='bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded 
        transition duration-200
        '
				>
					Change Password
				</button>
			</div>
		</SettingSection>
	);
};
export default Security;

```

### ClientApp\src\components\Admin\settings\SettingSection.jsx
```jsx
import { motion } from "framer-motion";

const SettingSection = ({ icon: Icon, title, children }) => {
	return (
		<motion.div
			className='bg-gray-800 bg-opacity-50 backdrop-filter backdrop-blur-lg shadow-lg rounded-xl p-6 border border-gray-700 mb-8'
			initial={{ opacity: 0, y: 20 }}
			animate={{ opacity: 1, y: 0 }}
			transition={{ duration: 0.5 }}
		>
			<div className='flex items-center mb-4'>
				<Icon className='text-indigo-400 mr-4' size='24' />
				<h2 className='text-xl font-semibold text-gray-100'>{title}</h2>
			</div>
			{children}
		</motion.div>
	);
};
export default SettingSection;

```

### ClientApp\src\components\Admin\settings\ToggleSwitch.jsx
```jsx
const ToggleSwitch = ({ label, isOn, onToggle }) => {
	return (
		<div className='flex items-center justify-between py-3'>
			<span className='text-gray-300'>{label}</span>
			<button
				className={`
        relative inline-flex items-center h-6 rounded-full w-11 transition-colors focus:outline-none
        ${isOn ? "bg-indigo-600" : "bg-gray-600"}
        `}
				onClick={onToggle}
			>
				<span
					className={`inline-block size-4 transform transition-transform bg-white rounded-full 
            ${isOn ? "translate-x-6" : "translate-x-1"}
            `}
				/>
			</button>
		</div>
	);
};
export default ToggleSwitch;

```

### ClientApp\src\components\Admin\users\RoleDrawer.jsx
```jsx
import React, { useState, useEffect } from "react";
import { Drawer, Button, Table, Space, Modal, Form, Input, message } from "antd";
import { Pencil, Trash, Plus } from "lucide-react";

const RoleDrawer = ({ visible, onClose }) => {
  const [roles, setRoles] = useState([]);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingRole, setEditingRole] = useState(null);
  const [form] = Form.useForm();

  useEffect(() => {
    if (visible) fetchRoles();
  }, [visible]);

  const fetchRoles = async () => {
    try {
      const res = await fetch(`${process.env.REACT_APP_API_BASE_URL}/api/roles`);
      const data = await res.json();
      setRoles(data);
    } catch (error) {
      message.error("Lá»—i khi táº£i dá»¯ liá»‡u");
    }
  };

  const handleAddOrEdit = async (values) => {
    try {
      if (editingRole) {
        // API cáº­p nháº­t
        await fetch(`${process.env.REACT_APP_API_BASE_URL}/api/roles/${editingRole.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(values),
        });
        message.success("Cáº­p nháº­t role thÃ nh cÃ´ng");
        setRoles((prev) => prev.map((r) => (r.id === editingRole.id ? { ...r, ...values } : r)));
      } else {
        // API thÃªm má»›i
        const res = await fetch(`${process.env.REACT_APP_API_BASE_URL}/api/roles`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(values),
        });
        const newRole = await res.json();
        message.success("ThÃªm role thÃ nh cÃ´ng");
        setRoles((prev) => [...prev, newRole]);
      }
      setIsModalOpen(false);
      form.resetFields();
      setEditingRole(null);
    } catch (error) {
      message.error("CÃ³ lá»—i xáº£y ra");
    }
  };

  const handleDelete = async (id) => {
    Modal.confirm({
      title: "XÃ³a Role",
      content: "Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a role nÃ y?",
      okText: "XÃ³a",
      okType: "danger",
      cancelText: "Há»§y",
      onOk: async () => {
        try {
          await fetch(`${process.env.REACT_APP_API_BASE_URL}/api/roles/${id}`, { method: "DELETE" });
          message.success("XÃ³a role thÃ nh cÃ´ng");
          setRoles((prev) => prev.filter((r) => r.id !== id));
        } catch (error) {
          message.error("KhÃ´ng thá»ƒ xÃ³a role vÃ¬ Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng.");
        }
      },
    });
  };

  const columns = [
    { title: "TÃªn Role", dataIndex: "name", key: "name" },
    {
      title: "HÃ nh Ä‘á»™ng",
      key: "action",
      render: (_, record) => (
        <Space>
          <Button
            icon={<Pencil size={18} />}
            onClick={() => {
              setEditingRole(record);
              form.setFieldsValue(record);
              setIsModalOpen(true);
            }}
          />
          <Button icon={<Trash size={18} />} danger onClick={() => handleDelete(record.id)} />
        </Space>
      ),
    },
  ];

  return (
    <Drawer title="Quáº£n lÃ½ Role" open={visible} onClose={onClose} width={500}>
      <Button type="primary" icon={<Plus size={18} />} onClick={() => setIsModalOpen(true)}>
        Quáº£n lÃ½ Role
      </Button>
      <Table columns={columns} dataSource={roles} rowKey="id" style={{ marginTop: 20 }} />
      
      <Modal
        title={editingRole ? "Chá»‰nh sá»­a Role" : "ThÃªm Role"}
        open={isModalOpen}
        onCancel={() => {
          setIsModalOpen(false);
          form.resetFields();
          setEditingRole(null);
        }}
        onOk={() => form.submit()}
      >
        <Form form={form} layout="vertical" onFinish={handleAddOrEdit}>
          <Form.Item name="name" label="TÃªn Role" rules={[{ required: true, message: "Nháº­p tÃªn role" }]}>
            <Input />
          </Form.Item>
        </Form>
      </Modal>
    </Drawer>
  );
};

export default RoleDrawer;

```

### ClientApp\src\components\Admin\users\UpdateUserDrawer.jsx
```jsx
import React, { useState, useEffect } from "react";
import { message } from "antd";
import { Drawer, TextField, Button, Select, MenuItem, FormControlLabel, Switch } from "@mui/material";
import axios from "axios";

const UpdateUserDrawer = ({ open, onClose, user, roles, onUpdate }) => {
  const [userData, setUserData] = useState({
    fullName: "",
    email: "",
    phoneNumber: "",
    roleId: "",
    isActive: false,
  });

  useEffect(() => {
    if (user) {
      setUserData({
        fullName: user.fullName || "",
        email: user.email || "",
        phoneNumber: user.phoneNumber || "",
        roleId: user.roleId || "",
        isActive: user.isActive || false,
      });
    }
  }, [user]);

  const handleChange = (e) => {
    setUserData({ ...userData, [e.target.name]: e.target.value });
  };

  const handleSwitchChange = (e) => {
    setUserData({ ...userData, isActive: e.target.checked });
  };

  const handleSave = async () => {
    if (!userData.fullName || !userData.email || !userData.phoneNumber || !userData.roleId) {
      message.warning("Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin!");
      return;
    }

    try {
      await axios.put(`${process.env.REACT_APP_API_BASE_URL}/api/users/${user.id}`, userData);
      message.success("Cáº­p nháº­t thÃ´ng tin thÃ nh cÃ´ng!");
      onUpdate(user.id, userData);
      onClose();
    } catch (error) {
      console.error("Lá»—i khi cáº­p nháº­t thÃ´ng tin ngÆ°á»i dÃ¹ng:", error);
      message.error("Lá»—i khi cáº­p nháº­t, vui lÃ²ng thá»­ láº¡i.");
    }
  };

  return (
    <Drawer anchor="right" open={open} onClose={onClose}>
      <div className="w-96 p-5">
        <h2 className="text-xl font-semibold mb-4">Cáº­p nháº­t ngÆ°á»i dÃ¹ng</h2>

        <TextField
          label="Há» vÃ  tÃªn"
          name="fullName"
          value={userData.fullName}
          onChange={handleChange}
          fullWidth
          margin="normal"
        />
        <TextField
          label="Email"
          name="email"
          value={userData.email}
          onChange={handleChange}
          fullWidth
          margin="normal"
        />
        <TextField
          label="Sá»‘ Ä‘iá»‡n thoáº¡i"
          name="phoneNumber"
          value={userData.phoneNumber}
          onChange={handleChange}
          fullWidth
          margin="normal"
        />
        <Select
          name="roleId"
          value={userData.roleId}
          onChange={handleChange}
          fullWidth
          displayEmpty
          sx={{ mt: 2 }}
        >
          <MenuItem value="" disabled>Chá»n vai trÃ²</MenuItem>
          {roles.map((role) => (
            <MenuItem key={role.id} value={role.id}>{role.name}</MenuItem>
          ))}
        </Select>

        <FormControlLabel
          control={<Switch checked={userData.isActive} onChange={handleSwitchChange} />}
          label="KÃ­ch hoáº¡t tÃ i khoáº£n"
          className="mt-4"
        />

        <div className="flex justify-end space-x-2 mt-4">
          <Button onClick={onClose} color="secondary">Há»§y</Button>
          <Button onClick={handleSave} variant="contained" color="primary">LÆ°u</Button>
        </div>
      </div>
    </Drawer>
  );
};

export default UpdateUserDrawer;

```

### ClientApp\src\components\Admin\users\UserActivityHeatmap.jsx
```jsx
import { Bar, BarChart, CartesianGrid, Legend, ResponsiveContainer, Tooltip, XAxis, YAxis } from "recharts";
import { motion } from "framer-motion";

const userActivityData = [
	{ name: "Mon", "0-4": 20, "4-8": 40, "8-12": 60, "12-16": 80, "16-20": 100, "20-24": 30 },
	{ name: "Tue", "0-4": 30, "4-8": 50, "8-12": 70, "12-16": 90, "16-20": 110, "20-24": 40 },
	{ name: "Wed", "0-4": 40, "4-8": 60, "8-12": 80, "12-16": 100, "16-20": 120, "20-24": 50 },
	{ name: "Thu", "0-4": 50, "4-8": 70, "8-12": 90, "12-16": 110, "16-20": 130, "20-24": 60 },
	{ name: "Fri", "0-4": 60, "4-8": 80, "8-12": 100, "12-16": 120, "16-20": 140, "20-24": 70 },
	{ name: "Sat", "0-4": 70, "4-8": 90, "8-12": 110, "12-16": 130, "16-20": 150, "20-24": 80 },
	{ name: "Sun", "0-4": 80, "4-8": 100, "8-12": 120, "12-16": 140, "16-20": 160, "20-24": 90 },
];

const UserActivityHeatmap = () => {
	return (
		<motion.div
			className='bg-gray-800 bg-opacity-50 backdrop-blur-md shadow-lg rounded-xl p-6 border border-gray-700'
			initial={{ opacity: 0, y: 20 }}
			animate={{ opacity: 1, y: 0 }}
			transition={{ delay: 0.4 }}
		>
			<h2 className='text-xl font-semibold text-gray-100 mb-4'>User Activity Heatmap</h2>
			<div style={{ width: "100%", height: 300 }}>
				<ResponsiveContainer>
					<BarChart data={userActivityData}>
						<CartesianGrid strokeDasharray='3 3' stroke='#374151' />
						<XAxis dataKey='name' stroke='#9CA3AF' />
						<YAxis stroke='#9CA3AF' />
						<Tooltip
							contentStyle={{
								backgroundColor: "rgba(31, 41, 55, 0.8)",
								borderColor: "#4B5563",
							}}
							itemStyle={{ color: "#E5E7EB" }}
						/>
						<Legend />
						<Bar dataKey='0-4' stackId='a' fill='#6366F1' />
						<Bar dataKey='4-8' stackId='a' fill='#8B5CF6' />
						<Bar dataKey='8-12' stackId='a' fill='#EC4899' />
						<Bar dataKey='12-16' stackId='a' fill='#10B981' />
						<Bar dataKey='16-20' stackId='a' fill='#F59E0B' />
						<Bar dataKey='20-24' stackId='a' fill='#3B82F6' />
					</BarChart>
				</ResponsiveContainer>
			</div>
		</motion.div>
	);
};
export default UserActivityHeatmap;

```

### ClientApp\src\components\Admin\users\UserDemographicsChart.jsx
```jsx
import { motion } from "framer-motion";
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } from "recharts";

const COLORS = ["#8884d8", "#82ca9d", "#ffc658", "#ff8042", "#0088FE"];

const userDemographicsData = [
	{ name: "18-24", value: 20 },
	{ name: "25-34", value: 30 },
	{ name: "35-44", value: 25 },
	{ name: "45-54", value: 15 },
	{ name: "55+", value: 10 },
];

const UserDemographicsChart = () => {
	return (
		<motion.div
			className='bg-gray-800 bg-opacity-50 backdrop-blur-md shadow-lg rounded-xl p-6 border border-gray-700 lg:col-span-2'
			initial={{ opacity: 0, y: 20 }}
			animate={{ opacity: 1, y: 0 }}
			transition={{ delay: 0.5 }}
		>
			<h2 className='text-xl font-semibold text-gray-100 mb-4'>User Demographics</h2>
			<div style={{ width: "100%", height: 300 }}>
				<ResponsiveContainer>
					<PieChart>
						<Pie
							data={userDemographicsData}
							cx='50%'
							cy='50%'
							outerRadius={100}
							fill='#8884d8'
							dataKey='value'
							label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
						>
							{userDemographicsData.map((entry, index) => (
								<Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
							))}
						</Pie>
						<Tooltip
							contentStyle={{
								backgroundColor: "rgba(31, 41, 55, 0.8)",
								borderColor: "#4B5563",
							}}
							itemStyle={{ color: "#E5E7EB" }}
						/>
						<Legend />
					</PieChart>
				</ResponsiveContainer>
			</div>
		</motion.div>
	);
};
export default UserDemographicsChart;

```

### ClientApp\src\components\Admin\users\UserGrowthChart.jsx
```jsx
import { useEffect, useState } from "react";
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from "recharts";
import { motion } from "framer-motion";
import axios from "axios";

const UserGrowthChart = () => {
	const [chartData, setChartData] = useState([]);

	useEffect(() => {
		const fetchUserGrowthData = async () => {
			try {
				const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/users/growth`);
				setChartData(response.data); // API tráº£ vá» dá»¯ liá»‡u dáº¡ng [{ month: "Jan", users: 1000 }, ...]
			} catch (error) {
				console.error("Lá»—i khi láº¥y dá»¯ liá»‡u ngÆ°á»i dÃ¹ng:", error);
			}
		};

		fetchUserGrowthData();
	}, []);

	return (
		<motion.div
			className='bg-gray-800 bg-opacity-50 backdrop-blur-md shadow-lg rounded-xl p-6 border border-gray-700'
			initial={{ opacity: 0, y: 20 }}
			animate={{ opacity: 1, y: 0 }}
			transition={{ delay: 0.3 }}
		>
			<h2 className='text-xl font-semibold text-gray-100 mb-4'>User Growth</h2>
			<div className='h-[320px]'>
				<ResponsiveContainer width='100%' height='100%'>
					<LineChart data={chartData}>
						<CartesianGrid strokeDasharray='3 3' stroke='#374151' />
						<XAxis dataKey='month' stroke='#9CA3AF' />
						<YAxis stroke='#9CA3AF' />
						<Tooltip
							contentStyle={{
								backgroundColor: "rgba(31, 41, 55, 0.8)",
								borderColor: "#4B5563",
							}}
							itemStyle={{ color: "#E5E7EB" }}
						/>
						<Line
							type='monotone'
							dataKey='users'
							stroke='#8B5CF6'
							strokeWidth={2}
							dot={{ fill: "#8B5CF6", strokeWidth: 2, r: 4 }}
							activeDot={{ r: 8 }}
						/>
					</LineChart>
				</ResponsiveContainer>
			</div>
		</motion.div>
	);
};

export default UserGrowthChart;

```

### ClientApp\src\components\Admin\users\UsersTable.jsx
```jsx
import { useState, useEffect, useMemo, useCallback } from "react";
import axios from "axios";
import { motion } from "framer-motion";
import {
  Search,
  PlusCircle,
  Pencil,
  Trash2,
  Users,
  // User, // CÃ³ thá»ƒ khÃ´ng cáº§n náº¿u CircleUserRound lÃ  default
  ShieldCheck,
  Sparkles,
  Star,
  Award,
  Crown,
  CircleUserRound,
  FilterX,
} from "lucide-react";
import {
  Modal,
  Box,
  Typography,
  TextField,
  Button,
  Select,
  MenuItem,
  FormControl,
  InputLabel,
  CircularProgress,
  Alert,
  Pagination,
  Grid,
} from "@mui/material";
import { message } from "antd"; // Äáº£m báº£o Ä‘Ã£ cÃ i Ä‘áº·t antd vÃ  import CSS cá»§a nÃ³

import RoleDrawer from "./RoleDrawer"; // Äiá»u chá»‰nh Ä‘Æ°á»ng dáº«n náº¿u cáº§n
import UpdateUserDrawer from "./UpdateUserDrawer"; // Äiá»u chá»‰nh Ä‘Æ°á»ng dáº«n náº¿u cáº§n
import useDebounce from "utils/useDebounce"; // Äiá»u chá»‰nh Ä‘Æ°á»ng dáº«n náº¿u cáº§n

// HÃ m láº¥y icon cho avatar dá»±a trÃªn vai trÃ²
const getRoleBasedAvatar = (roleName, isActive) => {
  const iconProps = {
    size: 22,
    className: "text-white",
    strokeWidth: isActive ? 2 : 1.5,
  };
  const normalizedRoleName = roleName?.toLowerCase();

  switch (normalizedRoleName) {
    case "admin":
      return <ShieldCheck {...iconProps} />;
    case "vip0":
      return <Sparkles {...iconProps} />;
    case "vip1":
      return <Star {...iconProps} />;
    case "vip2":
      return <Award {...iconProps} />;
    case "vip3":
      return <Crown {...iconProps} />;
    default:
      return <CircleUserRound {...iconProps} />;
  }
};

const UsersTable = () => {
  const [users, setUsers] = useState([]);
  const [roles, setRoles] = useState([]);
  const [searchInput, setSearchInput] = useState("");
  const debouncedSearchTerm = useDebounce(searchInput, 300);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [selectedUser, setSelectedUser] = useState(null);
  const [isRoleUpdateModalOpen, setIsRoleUpdateModalOpen] = useState(false);
  const [roleForSelectedUser, setRoleForSelectedUser] = useState("");
  const [updateDrawerVisible, setUpdateDrawerVisible] = useState(false);
  const [isAddUserModalOpen, setIsAddUserModalOpen] = useState(false);
  const [newUser, setNewUser] = useState({
    fullName: "",
    email: "",
    phoneNumber: "",
    password: "",
    roleId: "",
  });
  const [roleDrawerVisible, setRoleDrawerVisible] = useState(false);

  // State cho PhÃ¢n trang vÃ  Bá»™ lá»c má»›i
  const [currentPage, setCurrentPage] = useState(1);
  const [usersPerPage, setUsersPerPage] = useState(10);
  const [roleFilter, setRoleFilter] = useState("All");
  const [statusFilter, setStatusFilter] = useState("All");

  useEffect(() => {
    const fetchData = async () => {
      setLoading(true);
      setError(null);
      try {
        const [usersRes, rolesRes] = await Promise.all([
          axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/users`),
          axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/roles`),
        ]);
        setUsers(usersRes.data);
        setRoles(rolesRes.data);
      } catch (err) {
        console.error("Error fetching data:", err);
        const errorMessage = err.response?.data?.message || err.message || "KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u.";
        setError(errorMessage);
        message.error(`Lá»—i táº£i dá»¯ liá»‡u: ${errorMessage}`);
      } finally {
        setLoading(false);
      }
    };
    fetchData();
  }, []);

  const filteredUsers = useMemo(() => {
    let tempUsers = [...users];
    const term = debouncedSearchTerm.toLowerCase();
    if (term) {
      tempUsers = tempUsers.filter(
        (user) =>
          user.fullName.toLowerCase().includes(term) ||
          user.email.toLowerCase().includes(term)
      );
    }
    if (roleFilter !== "All") {
      tempUsers = tempUsers.filter(user => user.roleId === roleFilter);
    }
    if (statusFilter !== "All") {
      const isActiveFilter = statusFilter === "Active";
      tempUsers = tempUsers.filter(user => user.isActive === isActiveFilter);
    }
    return tempUsers;
  }, [users, debouncedSearchTerm, roleFilter, statusFilter]);

  const currentUsers = useMemo(() => {
    const indexOfLastUser = currentPage * usersPerPage;
    const indexOfFirstUser = indexOfLastUser - usersPerPage;
    return filteredUsers.slice(indexOfFirstUser, indexOfLastUser);
  }, [filteredUsers, currentPage, usersPerPage]);

  const totalPages = useMemo(() => {
    return Math.ceil(filteredUsers.length / usersPerPage);
  }, [filteredUsers.length, usersPerPage]);

  useEffect(() => {
    setCurrentPage(1);
  }, [debouncedSearchTerm, roleFilter, statusFilter, usersPerPage]);

  const handleSearchChange = useCallback((e) => setSearchInput(e.target.value), []);
  const handleRoleFilterChange = useCallback((event) => setRoleFilter(event.target.value), []);
  const handleStatusFilterChange = useCallback((event) => setStatusFilter(event.target.value), []);
  const handlePageChange = useCallback((event, newPage) => setCurrentPage(newPage), []);
  const handleUsersPerPageChange = useCallback((event) => {
    setUsersPerPage(parseInt(event.target.value, 10));
  }, []);
  const handleResetFilters = useCallback(() => {
    setSearchInput("");
    setRoleFilter("All");
    setStatusFilter("All");
    // usersPerPage cÃ³ thá»ƒ giá»¯ nguyÃªn hoáº·c reset vá» giÃ¡ trá»‹ máº·c Ä‘á»‹nh náº¿u muá»‘n
    // setCurrentPage(1); // ÄÃ£ Ä‘Æ°á»£c xá»­ lÃ½ bá»Ÿi useEffect theo dÃµi cÃ¡c state filter
    message.info("ÄÃ£ xÃ³a táº¥t cáº£ bá»™ lá»c.");

}, [setSearchInput, setRoleFilter, setStatusFilter]); // CÃ¡c setter lÃ  stable, cÃ³ thá»ƒ dÃ¹ng máº£ng rá»—ng []
  const handleOpenRoleUpdateModal = useCallback((user) => {
    if (!user.isActive && user.roleId !== roles.find(r => r.name.toLowerCase() === 'admin')?.id) { // Admin cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­a role ngay cáº£ khi inactive
        message.warning("KhÃ´ng thá»ƒ cáº­p nháº­t vai trÃ² cho ngÆ°á»i dÃ¹ng khÃ´ng hoáº¡t Ä‘á»™ng (trá»« Admin).");
        // return; // Bá» comment náº¿u muá»‘n cháº·n hoÃ n toÃ n
    }
    setSelectedUser(user);
    setRoleForSelectedUser(user.roleId);
    setIsRoleUpdateModalOpen(true);
  }, [roles]);

  const handleCloseRoleUpdateModal = useCallback(() => {
    setIsRoleUpdateModalOpen(false);
    setSelectedUser(null);
    setRoleForSelectedUser("");
  }, []);

  const handleUpdateUserRole = useCallback(async () => {
    if (selectedUser && roleForSelectedUser) {
      try {
        await axios.put(
          `${process.env.REACT_APP_API_BASE_URL}/api/users/${selectedUser.id}/role`,
          { roleId: roleForSelectedUser }
        );
        setUsers((prevUsers) =>
          prevUsers.map((user) =>
            user.id === selectedUser.id
              ? { ...user, roleId: roleForSelectedUser }
              : user
          )
        );
        message.success(`Vai trÃ² cá»§a ${selectedUser.fullName} Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t!`);
        handleCloseRoleUpdateModal();
      } catch (err) {
        console.error("Error updating user role:", err);
        message.error(`Lá»—i cáº­p nháº­t vai trÃ²: ${err.response?.data?.message || err.message}`);
      }
    }
  }, [selectedUser, roleForSelectedUser, handleCloseRoleUpdateModal]);

  const handleOpenUpdateDrawer = useCallback((user) => {
    setSelectedUser(user);
    setUpdateDrawerVisible(true);
  }, []);

  const handleCloseUpdateDrawer = useCallback(() => {
    setUpdateDrawerVisible(false);
    setSelectedUser(null);
  }, []);

  const handleUserUpdated = useCallback((updatedUserData) => {
    setUsers(prevUsers => prevUsers.map(user => user.id === updatedUserData.id ? { ...user, ...updatedUserData } : user));
    message.success(`ThÃ´ng tin ngÆ°á»i dÃ¹ng ${updatedUserData.fullName} Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t!`);
  }, []);

  const handleOpenAddUserModal = useCallback(() => {
    setNewUser({ fullName: "", email: "", phoneNumber: "", password: "", roleId: "" });
    setIsAddUserModalOpen(true);
  }, []);

  const handleCloseAddUserModal = useCallback(() => {
    setIsAddUserModalOpen(false);
  }, []);

  const handleNewUserInputChange = useCallback((e) => {
    const { name, value } = e.target;
    setNewUser(prev => ({ ...prev, [name]: value }));
  }, []);

  const handleAddNewUser = useCallback(async () => {
    if (!newUser.fullName || !newUser.email || !newUser.phoneNumber || !newUser.password || !newUser.roleId) {
      message.warning("Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin ngÆ°á»i dÃ¹ng.");
      return;
    }
    try {
      const response = await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/users`,
        newUser
      );
      setUsers((prevUsers) => [response.data, ...prevUsers]);
      message.success("NgÆ°á»i dÃ¹ng má»›i Ä‘Ã£ Ä‘Æ°á»£c thÃªm thÃ nh cÃ´ng!");
      handleCloseAddUserModal();
    } catch (err) {
      console.error("Lá»—i khi thÃªm ngÆ°á»i dÃ¹ng má»›i:", err);
      message.error(`Lá»—i thÃªm ngÆ°á»i dÃ¹ng: ${err.response?.data?.message || err.message}`);
    }
  }, [newUser, handleCloseAddUserModal]);

  const handleOpenRoleDrawer = useCallback(() => setRoleDrawerVisible(true), []);
  const handleCloseRoleDrawer = useCallback(() => setRoleDrawerVisible(false), []);

  const handleDeleteUser = useCallback(async (userId, userName) => {
    message.info(`Chá»©c nÄƒng xÃ³a ngÆ°á»i dÃ¹ng ID: ${userId} (${userName}) Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn.`);
  }, []);

  if (loading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: 'calc(100vh - 200px)', color: 'white', flexDirection: 'column' }}>
        <CircularProgress color="inherit" size={50} />
        <Typography sx={{ mt: 2, fontSize: '1.1rem' }}>Äang táº£i danh sÃ¡ch ngÆ°á»i dÃ¹ng...</Typography>
      </Box>
    );
  }

  if (error && users.length === 0) {
    return (
        <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: 'calc(100vh - 200px)', color: 'white', flexDirection: 'column', p:3 }}>
            <Alert severity="error" sx={{width: '100%', maxWidth: '600px', '.MuiAlert-message': {fontSize: '1rem'}}}>
                Lá»—i táº£i dá»¯ liá»‡u: {error}. Vui lÃ²ng thá»­ láº¡i sau.
            </Alert>
        </Box>
    );
  }

  return (
    <motion.div
      className='bg-gray-800 bg-opacity-70 backdrop-blur-xl shadow-2xl rounded-xl p-4 md:p-6 border border-gray-700 min-h-[calc(100vh-120px)] flex flex-col'
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay: 0.1, duration: 0.4 }}
    >
      <div className='flex flex-wrap justify-between items-center mb-6 gap-4'>
        <h2 className='text-2xl font-bold text-gray-100 tracking-tight'>Quáº£n lÃ½ NgÆ°á»i DÃ¹ng</h2>
        <div className='flex flex-wrap gap-3'>
          <Button
            variant="contained"
            color="primary"
            startIcon={<PlusCircle size={18} />}
            onClick={handleOpenAddUserModal}
            sx={{ bgcolor: '#2563EB', '&:hover': { bgcolor: '#1D4ED8' }, textTransform: 'none', fontWeight: 'medium', boxShadow: '0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06)' }}
          >
            ThÃªm ngÆ°á»i dÃ¹ng
          </Button>
          <Button
            variant="outlined"
            startIcon={<Users size={18} />}
            onClick={handleOpenRoleDrawer}
            sx={{ color: '#A5B4FC', borderColor: '#4F46E5', '&:hover': { borderColor: '#A5B4FC', bgcolor: 'rgba(79, 70, 229, 0.1)'}, textTransform: 'none', fontWeight: 'medium'  }}
          >
            Quáº£n lÃ½ Role
          </Button>
        </div>
      </div>

      <Grid container spacing={{xs: 1.5, md: 2}} alignItems="flex-end" sx={{ mb: 3 }}>
        <Grid item xs={12} md={4} lg={4}>
          <TextField
            label="TÃ¬m kiáº¿m"
            placeholder='TÃªn hoáº·c email...'
            value={searchInput}
            onChange={handleSearchChange}
            variant="outlined"
            fullWidth
            InputLabelProps={{ sx: { color: '#9CA3AF', '&.Mui-focused': {color: '#A5B4FC'} } }}
            InputProps={{
              startAdornment: <Search className='text-gray-400 mr-2' size={20} />,
              sx: { borderRadius: '8px', bgcolor: 'rgba(30,41,59,0.7)', input: { color: 'white' }, '& .MuiOutlinedInput-notchedOutline': { borderColor: '#4B5563' }, '&:hover .MuiOutlinedInput-notchedOutline': { borderColor: '#4F46E5' }, '&.Mui-focused .MuiOutlinedInput-notchedOutline': { borderColor: '#A5B4FC', borderWidth: '2px'} }
            }}
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3} lg={3}>
          <FormControl fullWidth variant="outlined">
            <InputLabel sx={{color: '#9CA3AF', '&.Mui-focused': {color: '#A5B4FC'}}}>Vai trÃ²</InputLabel>
            <Select
              value={roleFilter}
              onChange={handleRoleFilterChange}
              label="Vai trÃ²"
              sx={{color: roleFilter === "All" ? '#9CA3AF' : 'white', borderRadius:'8px', bgcolor: 'rgba(30,41,59,0.7)', '& .MuiOutlinedInput-notchedOutline': { borderColor: '#4B5563' }, '&:hover .MuiOutlinedInput-notchedOutline': { borderColor: '#4F46E5' }, '&.Mui-focused .MuiOutlinedInput-notchedOutline': { borderColor: '#A5B4FC', borderWidth: '2px'}, '& .MuiSvgIcon-root': { color: '#9CA3AF' }}}
              MenuProps={{ PaperProps: { sx: { bgcolor: '#1F2937', color: 'white', borderRadius: '8px', border:'1px solid #374151' }}}}
            >
              <MenuItem value="All" sx={{color: '#9CA3AF', fontStyle:'italic'}}><em>Táº¥t cáº£ vai trÃ²</em></MenuItem>
              {roles.map((role) => (
                <MenuItem key={role.id} value={role.id} sx={{ '&:hover': { bgcolor: '#374151'}, '&.Mui-selected': {bgcolor: '#4F46E5!important', fontWeight:'bold'}, '&.Mui-selected:hover':{bgcolor: '#4338CA!important'} }}>{role.name}</MenuItem>
              ))}
            </Select>
          </FormControl>
        </Grid>
        <Grid item xs={12} sm={6} md={3} lg={3}>
           <FormControl fullWidth variant="outlined">
            <InputLabel sx={{color: '#9CA3AF', '&.Mui-focused': {color: '#A5B4FC'}}}>Tráº¡ng thÃ¡i</InputLabel>
            <Select
              value={statusFilter}
              onChange={handleStatusFilterChange}
              label="Tráº¡ng thÃ¡i"
              sx={{color: statusFilter === "All" ? '#9CA3AF' : 'white', borderRadius:'8px', bgcolor: 'rgba(30,41,59,0.7)', '& .MuiOutlinedInput-notchedOutline': { borderColor: '#4B5563' }, '&:hover .MuiOutlinedInput-notchedOutline': { borderColor: '#4F46E5' }, '&.Mui-focused .MuiOutlinedInput-notchedOutline': { borderColor: '#A5B4FC', borderWidth: '2px'}, '& .MuiSvgIcon-root': { color: '#9CA3AF' }}}
              MenuProps={{ PaperProps: { sx: { bgcolor: '#1F2937', color: 'white', borderRadius: '8px', border:'1px solid #374151' }}}}
            >
              <MenuItem value="All" sx={{color: '#9CA3AF', fontStyle:'italic'}}><em>Táº¥t cáº£ tráº¡ng thÃ¡i</em></MenuItem>
              <MenuItem value="Active" sx={{ '&:hover': { bgcolor: '#374151'}, '&.Mui-selected': {bgcolor: 'rgba(16, 185, 129, 0.3)!important', color: '#10B981', fontWeight:'bold'}, '&.Mui-selected:hover':{bgcolor: 'rgba(5, 150, 105, 0.4)!important'} }}>Hoáº¡t Ä‘á»™ng</MenuItem>
              <MenuItem value="Inactive" sx={{ '&:hover': { bgcolor: '#374151'}, '&.Mui-selected': {bgcolor: 'rgba(239, 68, 68, 0.3)!important', color: '#EF4444', fontWeight:'bold'}, '&.Mui-selected:hover':{bgcolor: 'rgba(220, 38, 38, 0.4)!important'} }}>VÃ´ hiá»‡u</MenuItem>
            </Select>
          </FormControl>
        </Grid>
        <Grid item xs={12} md="auto"> {/* NÃºt XÃ³a bá»™ lá»c - tá»± Ä‘á»™ng co chiá»u rá»™ng */}
        <Button
            variant="text"
            startIcon={<FilterX size={18} />}
            onClick={handleResetFilters}
            sx={{ 
                color: '#CBD5E1', // text-slate-300
                textTransform: 'none', 
                fontWeight: 'medium',
                padding: {xs: '6px 12px', md:'8px 16px'}, // Äiá»u chá»‰nh padding cho há»£p lÃ½
                height: {md: '56px'}, // CÄƒn chiá»u cao vá»›i TextField vÃ  Select
                '&:hover': { bgcolor: 'rgba(79, 70, 229, 0.15)'} 
            }}
        >
            XÃ³a lá»c
        </Button>
    </Grid>
      </Grid>

      <div className='overflow-x-auto custom-scrollbar flex-grow rounded-lg border border-gray-700/50'>
        <table className='min-w-full divide-y divide-gray-600'>
          <thead className="bg-gray-700 bg-opacity-40 sticky top-0 z-10 backdrop-blur-sm">
            <tr>
              <th className='px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider'>NgÆ°á»i dÃ¹ng</th>
              <th className='px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider'>Email & SÄT</th>
              <th className='px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider'>Vai trÃ²</th>
              <th className='px-6 py-3 text-center text-xs font-semibold text-gray-300 uppercase tracking-wider'>Tráº¡ng thÃ¡i</th>
              <th className='px-6 py-3 text-center text-xs font-semibold text-gray-300 uppercase tracking-wider'>HÃ nh Ä‘á»™ng</th>
            </tr>
          </thead>
          <tbody className='divide-y divide-gray-600'>
            {currentUsers.map((user) => {
              const userRoleName = roles.find(r => r.id === user.roleId)?.name;
              return (
                <motion.tr
                  key={user.id}
                  layout // ThÃªm layout prop cho AnimatePresence (náº¿u dÃ¹ng) hoáº·c hiá»‡u á»©ng mÆ°á»£t hÆ¡n
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: -10}}
                  transition={{ duration: 0.3, delay: Math.random() * 0.05 }}
                  className="hover:bg-gray-700/60 transition-colors duration-150"
                >
                  <td className='px-6 py-4 whitespace-nowrap'>
                    <div className='flex items-center'>
                      <div className='flex-shrink-0 h-11 w-11'>
                        <div
                          className={`h-full w-full rounded-full bg-gradient-to-br ${
                            user.isActive
                              ? 'from-sky-500 to-indigo-600'
                              : 'from-gray-600 to-gray-700'
                          } flex items-center justify-center shadow-lg border-2 ${user.isActive ? 'border-sky-400/40' : 'border-gray-500/40'}`}
                          title={userRoleName || "ChÆ°a cÃ³ vai trÃ²"}
                        >
                          {getRoleBasedAvatar(userRoleName, user.isActive)}
                        </div>
                      </div>
                      <div className='ml-4'>
                        <div className={`text-sm font-semibold ${user.isActive ? 'text-gray-100' : 'text-gray-500'}`}>
                          {user.fullName}
                        </div>
                         <div className={`text-xs ${user.isActive ? 'text-gray-400' : 'text-gray-600'}`}>ID: {user.id}</div>
                      </div>
                    </div>
                  </td>
                  <td className='px-6 py-4 whitespace-nowrap'>
                    <div className={`text-sm ${user.isActive ? 'text-gray-300' : 'text-gray-500'}`}>{user.email}</div>
                    <div className={`text-xs mt-1 ${user.isActive ? 'text-gray-400' : 'text-gray-600'}`}>{user.phoneNumber}</div>
                  </td>
                  <td className='px-6 py-4 whitespace-nowrap'>
                    <span
                      className={`px-3 py-1.5 inline-flex text-xs leading-5 font-semibold rounded-md cursor-pointer transition-all duration-150 ease-in-out transform hover:brightness-125
                        ${user.isActive ? (userRoleName?.toLowerCase() === 'admin' ? 'bg-red-600 text-red-100 shadow-md shadow-red-500/30' : 'bg-cyan-600 text-cyan-100 shadow-md shadow-cyan-500/30') 
                                       : 'bg-gray-600 text-gray-400 cursor-not-allowed'}`}
                      onClick={() => handleOpenRoleUpdateModal(user)}
                      title={user.isActive ? `Äá»•i vai trÃ²: ${userRoleName || "N/A"}` : "NgÆ°á»i dÃ¹ng khÃ´ng hoáº¡t Ä‘á»™ng"}
                    >
                      {userRoleName || "ChÆ°a cÃ³"}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-center">
                    <span
                      className={`px-3 py-1.5 inline-flex text-xs leading-5 font-semibold rounded-md shadow-sm ${
                        user.isActive
                          ? "bg-green-600 text-green-100 shadow-green-500/30"
                          : "bg-rose-600 text-rose-100 shadow-rose-500/30"
                      }`}
                      title={user.isActive ? "Äang hoáº¡t Ä‘á»™ng" : "ÄÃ£ vÃ´ hiá»‡u hÃ³a"}
                    >
                      {user.isActive ? "Hoáº¡t Ä‘á»™ng" : "VÃ´ hiá»‡u"}
                    </span>
                  </td>
                  <td className='px-6 py-4 whitespace-nowrap text-sm text-gray-300 text-center'>
                    <button
                      className='text-indigo-400 hover:text-indigo-300 p-2 rounded-full hover:bg-gray-600/40 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-indigo-500'
                      title="Chá»‰nh sá»­a chi tiáº¿t ngÆ°á»i dÃ¹ng"
                      onClick={() => handleOpenUpdateDrawer(user)}
                    >
                      <Pencil size={18} />
                    </button>
                    <button
                      className='text-red-400 hover:text-red-300 p-2 ml-1.5 rounded-full hover:bg-gray-600/40 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-red-500'
                      title="XÃ³a ngÆ°á»i dÃ¹ng"
                      onClick={() => handleDeleteUser(user.id, user.fullName)}
                    >
                      <Trash2 size={18} />
                    </button>
                  </td>
                </motion.tr>
              );
            })}
          </tbody>
        </table>
        {filteredUsers.length === 0 && !loading && (
          <Typography sx={{ textAlign: 'center', p: 5, color: 'rgb(156 163 175)', fontStyle: 'italic', mt:2 }}>
            KhÃ´ng tÃ¬m tháº¥y ngÆ°á»i dÃ¹ng nÃ o phÃ¹ há»£p vá»›i bá»™ lá»c hoáº·c tÃ¬m kiáº¿m cá»§a báº¡n.
          </Typography>
        )}
      </div>

      {totalPages > 0 && ( // Chá»‰ hiá»ƒn thá»‹ pagination náº¿u cÃ³ dá»¯ liá»‡u sau khi lá»c
        <Box sx={{ 
        display: 'flex', 
        flexDirection: { xs: 'column', sm: 'row' }, // Stack trÃªn mobile
        justifyContent: 'space-between', 
        alignItems: 'center', 
        p: 2, 
        mt: 'auto', 
        borderTop:'1px solid rgba(75, 85, 99, 0.5)', 
        paddingTop: {xs: '1rem', sm: '0.5rem'}, // Äiá»u chá»‰nh padding
        gap: { xs: 2, sm: 0 } // Khoáº£ng cÃ¡ch giá»¯a cÃ¡c item trÃªn mobile
    }}>
        <Box display="flex" alignItems="center" gap={2} sx={{ flexDirection: { xs: 'column', sm: 'row' }, alignItems: 'center' }}>
            <Typography sx={{fontSize: '0.875rem', color: '#9CA3AF', whiteSpace: 'nowrap'}}>
                Hiá»ƒn thá»‹ {Math.min((currentPage - 1) * usersPerPage + 1, filteredUsers.length)} - {Math.min(currentPage * usersPerPage, filteredUsers.length)} cá»§a {filteredUsers.length}
            </Typography>
            <FormControl size="small" variant="outlined" sx={{ 
                minWidth: 130, 
                '& .MuiOutlinedInput-root': { borderRadius:'8px', bgcolor: 'rgba(30,41,59,0.7)', '& fieldset': { borderColor: '#4B5563' }, '&:hover fieldset': { borderColor: '#4F46E5' }}, 
                '& .MuiSvgIcon-root': { color: '#9CA3AF' },
                '.MuiInputLabel-root': {color: '#9CA3AF'} // Äáº£m báº£o label cÃ³ mÃ u Ä‘Ãºng
            }}>
                <InputLabel id="users-per-page-label">Sá»‘ má»¥c</InputLabel>
                <Select
                    labelId="users-per-page-label"
                    value={usersPerPage}
                    onChange={handleUsersPerPageChange}
                    label="Sá»‘ má»¥c"
                    sx={{color: 'white', borderRadius:'8px'}}
                    MenuProps={{ PaperProps: { sx: { bgcolor: '#1F2937', color: 'white', borderRadius: '8px', border:'1px solid #374151' }}}}
                >
                    {[5, 10, 20, 50, 100].map(size => (
                        <MenuItem key={size} value={size} sx={{ '&:hover': { bgcolor: '#374151'}, '&.Mui-selected': {bgcolor: '#4F46E5!important', fontWeight:'bold'}, '&.Mui-selected:hover':{bgcolor: '#4338CA!important'} }}>{size} / trang</MenuItem>
                    ))}
                </Select>
            </FormControl>
        </Box>
        <Pagination
            count={totalPages}
            page={currentPage}
            onChange={handlePageChange}
            color="primary"
            size="small" // Giá»¯ size small cho gá»n
            sx={{ /* ... style pagination giá»¯ nguyÃªn ... */ }}
        />
    </Box>
      )}

      {/* Modal cáº­p nháº­t vai trÃ² (Ä‘Æ¡n giáº£n) */}
      {selectedUser && (
        <Modal open={isRoleUpdateModalOpen} onClose={handleCloseRoleUpdateModal} aria-labelledby="update-role-modal-title">
          <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: {xs: '90%', sm: 400}, bgcolor: 'rgba(30, 41, 59, 0.98)', backdropFilter: 'blur(8px)', border: '1px solid #374151', boxShadow: '0 20px 25px -5px rgba(0,0,0,0.3), 0 10px 10px -5px rgba(0,0,0,0.2)', p: {xs:2.5, sm:3.5}, borderRadius: '12px', color: '#E5E7EB' }}>
            <Typography id="update-role-modal-title" variant="h6" component="h2" sx={{ color: '#D1D5DB', mb: 2.5, fontWeight:'bold' }}>
              Cáº­p nháº­t vai trÃ² cho: <span className="text-indigo-400">{selectedUser.fullName}</span>
            </Typography>
            <FormControl fullWidth>
              <InputLabel id="role-select-label" sx={{ color: '#9CA3AF', '&.Mui-focused': {color: '#A5B4FC'} }}>Vai trÃ² má»›i</InputLabel>
              <Select
                labelId="role-select-label"
                label="Vai trÃ² má»›i"
                value={roleForSelectedUser}
                onChange={(e) => setRoleForSelectedUser(e.target.value)}
                sx={{ bgcolor: 'rgba(55, 65, 81, 0.7)', color: 'white', '& .MuiSvgIcon-root': { color: '#9CA3AF' }, '&:hover .MuiOutlinedInput-notchedOutline': { borderColor: '#4F46E5' }, '.MuiOutlinedInput-notchedOutline': { borderColor: '#4B5563' }, '&.Mui-focused .MuiOutlinedInput-notchedOutline': { borderColor: '#A5B4FC', borderWidth: '2px' }, borderRadius:'8px' }}
                MenuProps={{ PaperProps: { sx: { bgcolor: '#1F2937', color: 'white', borderRadius: '8px', border:'1px solid #374151' }}}}
              >
                {roles.map((role) => (
                  <MenuItem key={role.id} value={role.id} sx={{ '&:hover': { bgcolor: '#374151'}, '&.Mui-selected': {bgcolor: '#4F46E5!important', fontWeight:'bold'}, '&.Mui-selected:hover':{bgcolor: '#4338CA!important'} }}>
                    {role.name}
                  </MenuItem>
                ))}
              </Select>
            </FormControl>
            <Button variant="contained" onClick={handleUpdateUserRole} sx={{ mt: 3, bgcolor: '#4F46E5', '&:hover': { bgcolor: '#4338CA' }, textTransform:'none', fontWeight:'bold', py:1.2, borderRadius:'8px' }} fullWidth>
              LÆ°u thay Ä‘á»•i vai trÃ²
            </Button>
          </Box>
        </Modal>
      )}

      {/* Modal thÃªm ngÆ°á»i dÃ¹ng má»›i */}
      <Modal open={isAddUserModalOpen} onClose={handleCloseAddUserModal} aria-labelledby="add-user-modal-title">
        <Box sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: {xs: '90%', sm: 450}, bgcolor: 'rgba(30, 41, 59, 0.98)', backdropFilter: 'blur(8px)', border: '1px solid #374151', boxShadow: '0 20px 25px -5px rgba(0,0,0,0.3), 0 10px 10px -5px rgba(0,0,0,0.2)', p: {xs:2.5, sm:3.5}, borderRadius: '12px', color: '#E5E7EB', display: 'flex', flexDirection: 'column', gap: 2.5 }}>
          <Typography id="add-user-modal-title" variant="h6" component="h2" textAlign="center" sx={{ color: '#D1D5DB', mb: 1, fontWeight:'bold' }}>
            ThÃªm NgÆ°á»i DÃ¹ng Má»›i
          </Typography>
          {[
            { label: "Há» vÃ  tÃªn", name: "fullName", type: "text" },
            { label: "Email", name: "email", type: "email" },
            { label: "Sá»‘ Ä‘iá»‡n thoáº¡i", name: "phoneNumber", type: "tel" },
            { label: "Máº­t kháº©u", name: "password", type: "password" },
          ].map(field => (
            <TextField key={field.name} label={field.label} name={field.name} type={field.type} value={newUser[field.name]} onChange={handleNewUserInputChange} variant="outlined" fullWidth 
                       InputLabelProps={{ sx: { color: '#9CA3AF', '&.Mui-focused': {color: '#A5B4FC'} } }} 
                       sx={{ '.MuiInputBase-input': { color: 'white' }, '& .MuiOutlinedInput-root': { borderRadius:'8px', bgcolor: 'rgba(55, 65, 81, 0.7)', '& fieldset': { borderColor: '#4B5563' }, '&:hover fieldset': { borderColor: '#4F46E5' }, '&.Mui-focused fieldset': { borderColor: '#A5B4FC', borderWidth: '2px' }}}} />
          ))}
          <FormControl fullWidth variant="outlined" sx={{ '& .MuiOutlinedInput-root': { borderRadius:'8px', bgcolor: 'rgba(55, 65, 81, 0.7)', '& fieldset': { borderColor: '#4B5563' }, '&:hover fieldset': { borderColor: '#4F46E5' }, '&.Mui-focused fieldset': { borderColor: '#A5B4FC', borderWidth: '2px'}}, '& .MuiSvgIcon-root': { color: '#9CA3AF' }}}>
            <InputLabel id="add-user-role-label" sx={{ color: '#9CA3AF', '&.Mui-focused': {color: '#A5B4FC'} }}>Vai trÃ²</InputLabel>
            <Select labelId="add-user-role-label" label="Vai trÃ²" name="roleId" value={newUser.roleId} onChange={handleNewUserInputChange} displayEmpty sx={{ color: newUser.roleId ? 'white' : '#9CA3AF', borderRadius:'8px' }} MenuProps={{ PaperProps: { sx: { bgcolor: '#1F2937', color: 'white', borderRadius: '8px', border:'1px solid #374151' }}}}>
              <MenuItem value="" disabled sx={{ color: '#9CA3AF', fontStyle:'italic' }}><em>--- Chá»n vai trÃ² ---</em></MenuItem>
              {roles.map((role) => (
                <MenuItem key={role.id} value={role.id} sx={{ '&:hover': { bgcolor: '#374151'}, '&.Mui-selected': {bgcolor: '#4F46E5!important', fontWeight:'bold'}, '&.Mui-selected:hover':{bgcolor: '#4338CA!important'} }}>{role.name}</MenuItem>
              ))}
            </Select>
          </FormControl>
          <Button variant="contained" onClick={handleAddNewUser} fullWidth sx={{ textTransform: 'none', fontWeight: 'bold', py: 1.5, borderRadius: '8px', bgcolor: '#4F46E5', '&:hover': { bgcolor: '#4338CA' }}}>
            ThÃªm NgÆ°á»i DÃ¹ng
          </Button>
        </Box>
      </Modal>

      <RoleDrawer visible={roleDrawerVisible} onClose={handleCloseRoleDrawer} roles={roles} setRoles={setRoles} />

      <UpdateUserDrawer
        open={updateDrawerVisible}
        onClose={handleCloseUpdateDrawer}
        user={selectedUser}
        roles={roles}
        onUserUpdated={handleUserUpdated}
      />
    </motion.div>
  );
};

export default UsersTable;
```

### ClientApp\src\components\Auth\AuthModal.jsx
```jsx
import React, { useState } from "react";
import { Modal, Button } from "flowbite-react";
import axios from "axios";
import "./AuthModal.css";

const AuthModal = ({ isOpen, onClose }) => {
  const [email, setEmail] = useState("");
  const [fullName, setFullName] = useState("");
  const [phoneNumber, setPhone] = useState("");
  const [password, setPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [step, setStep] = useState(0);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState("");

  const isValidEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  const isValidPassword = (password) => /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/.test(password);

  const handleCheckEmail = async () => {
    if (!email) return setError("Email khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng!");
    if (!isValidEmail(email)) return setError("Email khÃ´ng há»£p lá»‡!");

    setError("");
    setIsLoading(true);
    try {
      const response = await axios.post(`${process.env.REACT_APP_API_BASE_URL}/api/Auth/check-email`, { email });
      setStep(response.data.exists ? 1 : 2);
    } catch (error) {
      setError("Lá»—i khi kiá»ƒm tra email! Vui lÃ²ng thá»­ láº¡i.");
    }
    setIsLoading(false);
  };

  const handleLogin = async () => {
    if (!password) return setError("Máº­t kháº©u khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng!");

    setError("");
    setIsLoading(true);
    try {
      const response = await axios.post(`${process.env.REACT_APP_API_BASE_URL}/api/Auth/login`, { email, password });
      localStorage.setItem("token", response.data.token);
      onClose();
      setTimeout(() => window.location.reload(), 300);
    } catch (error) {
      setError("Sai tÃ i khoáº£n hoáº·c máº­t kháº©u!");
    }
    setIsLoading(false);
  };

  const handleRegister = async () => {
    if (!isValidPassword(password)) return setError("Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 8 kÃ½ tá»±, bao gá»“m chá»¯ hoa, chá»¯ thÆ°á»ng, sá»‘ vÃ  kÃ½ tá»± Ä‘áº·c biá»‡t!");
    if (password !== confirmPassword) return setError("Máº­t kháº©u xÃ¡c nháº­n khÃ´ng khá»›p!");

    setError("");
    setIsLoading(true);
    try {
      await axios.post(`${process.env.REACT_APP_API_BASE_URL}/api/Auth/register`, { email, fullName, phoneNumber, password });
      setStep(1);
    } catch (error) {
      setError("ÄÄƒng kÃ½ tháº¥t báº¡i! HÃ£y thá»­ láº¡i.");
    }
    setIsLoading(false);
  };

  return (
    <Modal show={isOpen} onClose={onClose}>
      <div className="modal-overlay">
        <div className="relative bg-white rounded-xl shadow-lg text-black w-full max-w-md max-h-full">
          <div className="flex items-center justify-between p-4 md:p-5 border-b border-gray-200">
            {step !== 0 && (
              <button className="text-gray-400 hover:bg-gray-200 rounded-lg text-sm w-8 h-8" onClick={() => setStep(0)}>â—€</button>
            )}
            <button className="text-gray-400 hover:bg-gray-200 rounded-lg text-sm w-8 h-8" onClick={onClose}>âœ–</button>
          </div>
          <h3 className="text-2xl font-bold text-black text-center">
            {step === 0 ? "ÄÄƒng nháº­p/ÄÄƒng kÃ½" : step === 1 ? "ÄÄƒng nháº­p" : step === 2 ? "ThÃ´ng tin cÃ¡ nhÃ¢n" : "ÄÄƒng kÃ½"}
          </h3>
          {error && <p className="text-red-500 text-sm text-center">{error}</p>}
          <div className="p-4 space-y-4 flex flex-col items-center">
            {step === 0 && (
              <>
                <input type="email" placeholder="Nháº­p email cá»§a báº¡n" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full border-gray-300 focus:ring-black focus:border-black h-12 px-3" />
                <Button onClick={handleCheckEmail} className="mt-4 bg-red-700 hover:bg-red-800 text-white font-medium rounded-lg px-5 py-2.5" disabled={isLoading}>{isLoading ? "Äang kiá»ƒm tra..." : "Tiáº¿p tá»¥c"}</Button>
              </>
            )}
            {step === 1 && (
              <>
                <input type="password" placeholder="Nháº­p máº­t kháº©u" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full border-gray-300 focus:ring-black focus:border-black h-12 px-3" />
                <Button onClick={handleLogin} className="mt-4 bg-red-700 hover:bg-red-800 text-white font-medium rounded-lg px-5 py-2.5" disabled={isLoading}>{isLoading ? "Äang Ä‘Äƒng nháº­p..." : "ÄÄƒng nháº­p"}</Button>
              </>
            )}
            {step === 2 && (
              <>
                <input type="text" placeholder="Há» vÃ  tÃªn" value={fullName} onChange={(e) => setFullName(e.target.value)} className="w-full border-gray-300 focus:ring-black focus:border-black h-12 px-3" />
                <input type="text" placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i" value={phoneNumber} onChange={(e) => setPhone(e.target.value)} className="w-full border-gray-300 focus:ring-black focus:border-black h-12 px-3" />
                <Button onClick={() => setStep(3)} className="mt-4 bg-red-700 hover:bg-red-800 text-white font-medium rounded-lg px-5 py-2.5">Tiáº¿p tá»¥c</Button>
              </>
            )}
            {step === 3 && (
              <>
                <input type="password" placeholder="Nháº­p máº­t kháº©u" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full border-gray-300 focus:ring-black focus:border-black h-12 px-3" />
                <input type="password" placeholder="XÃ¡c nháº­n máº­t kháº©u" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} className="w-full border-gray-300 focus:ring-black focus:border-black h-12 px-3" />
                <Button onClick={handleRegister} className="mt-4 bg-red-700 hover:bg-red-800 text-white font-medium rounded-lg px-5 py-2.5" disabled={isLoading}>{isLoading ? "Äang Ä‘Äƒng kÃ½..." : "ÄÄƒng kÃ½"}</Button>
              </>
            )}
          </div>
        </div>
      </div>
    </Modal>
  );
};

export default AuthModal;

```

### ClientApp\src\components\BestSellerManager\BestSellerManager.js
```js
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { AutoComplete, Button, Table, InputNumber, message, Popconfirm, Space } from 'antd';
import { SearchOutlined, DeleteOutlined } from '@ant-design/icons';

const API_BASE_URL = process.env.REACT_APP_API_BASE_URL;

const BestSellerManager = ({ sectionData, onContentChange }) => {
    const [searchText, setSearchText] = useState('');
    const [searchedProducts, setSearchedProducts] = useState([]);
    const [bestSellerItems, setBestSellerItems] = useState(sectionData.items || []);

    useEffect(() => {
        setBestSellerItems(sectionData.items || []);
    }, [sectionData.items]);

    const fetchProductDetails = async (productIds) => {
        if (productIds.length === 0) return [];
        try {
            const { data } = await axios.get(`${API_BASE_URL}/api/Products/by-ids?ids=${productIds.join(',')}`);
            return data || [];
        } catch (error) {
            message.error('Failed to fetch product details.');
            return [];
        }
    };

    const handleSearch = async (value) => {
        if (!value) {
            setSearchedProducts([]);
            return;
        }
        try {
            const { data } = await axios.get(`${API_BASE_URL}/api/Products/search?keyword=${value}`);
            const options = (data.$values || data).map(p => ({ value: p.name, key: p.id, product: p }));
            setSearchedProducts(options);
        } catch (error) {
            setSearchedProducts([]);
        }
    };

    const onSelect = (value, option) => {
        const product = option.product;
        if (bestSellerItems.some(item => item.productId === product.id)) {
            message.warning('Product is already in the best seller list.');
            return;
        }
        const newItem = { productId: product.id, overridePrice: null };
        const updatedItems = [...bestSellerItems, newItem];
        setBestSellerItems(updatedItems);
        onContentChange('best_seller', null, { ...sectionData, items: updatedItems });
        setSearchText(''); // Clear search input
    };

    const handleUpdate = (productId, field, value) => {
        const updatedItems = bestSellerItems.map(item =>
            item.productId === productId ? { ...item, [field]: value } : item
        );
        setBestSellerItems(updatedItems);
        onContentChange('best_seller', null, { ...sectionData, items: updatedItems });
    };

    const handleRemove = (productId) => {
        const updatedItems = bestSellerItems.filter(item => item.productId !== productId);
        setBestSellerItems(updatedItems);
        onContentChange('best_seller', null, { ...sectionData, items: updatedItems });
    };

    const columns = [
        { title: 'Product ID', dataIndex: 'productId', key: 'productId' },
        {
            title: 'Product Name',
            key: 'productName',
            render: (text, record) => {
                // This will require fetching product details, which is done in BestSellers.jsx
                // For admin, we might need a separate lookup or pass product details from parent
                return `Product ${record.productId}`;
            }
        },
        {
            title: 'Override Price',
            dataIndex: 'overridePrice',
            key: 'overridePrice',
            render: (price, record) => (
                <InputNumber
                    defaultValue={price}
                    formatter={value => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                    parser={value => value.replace(/\s?|(,*)/g, '')}
                    onBlur={(e) => handleUpdate(record.productId, 'overridePrice', parseFloat(e.target.value.replace(/,/g, '')))}
                    style={{ width: 150 }}
                />
            )
        },
        {
            title: 'Action',
            key: 'action',
            render: (_, record) => (
                <Popconfirm title="Are you sure?" onConfirm={() => handleRemove(record.productId)}>
                    <Button danger icon={<DeleteOutlined />} />
                </Popconfirm>
            )
        }
    ];

    return (
        <div>
            <AutoComplete
                style={{ width: '100%', marginBottom: 16 }}
                onSearch={handleSearch}
                onSelect={onSelect}
                placeholder="Search and add a product..."
                options={searchedProducts}
                value={searchText}
                onChange={setSearchText}
            >
                <InputNumber addonAfter={<SearchOutlined />} />
            </AutoComplete>

            <Table
                columns={columns}
                dataSource={bestSellerItems}
                rowKey="productId"
                pagination={false}
            />
        </div>
    );
};

export default BestSellerManager;

```

### ClientApp\src\components\BestSellers\BestSellers.js
```js
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import ProductCard from '@/components/shared/ProductCard';
// File removed. Migrated to BestSellers.jsx
// Import Swiper React components
import { Swiper, SwiperSlide } from 'swiper/react';
import { Navigation } from 'swiper/modules';

// Import Swiper styles
import 'swiper/css';
import 'swiper/css/navigation';

const BestSellerSection = ({ data }) => {
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchProducts = async () => {
      if (!data.productIds || data.productIds.length === 0) {
        setLoading(false);
        return;
      }
      try {
        setLoading(true);
        // Assuming an API endpoint to fetch products by a list of IDs
        const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/products/by-ids?ids=${data.productIds.join(',')}`);
        setProducts(response.data);
      } catch (error) {
        console.error('Failed to fetch best seller products:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchProducts();
  }, [data.productIds]);

  if (!data.enabled) {
    return null; // Don't render if section is not enabled
  }

  if (loading) {
    return <div>Loading best sellers...</div>; // Or a proper skeleton loader
  }

  if (products.length === 0) {
    return null; // Don't render if no products are found
  }

  return (
    <section className="py-16 md:py-24 bg-primary-dark">
      <div className="container mx-auto px-4">
        <h2 className="font-display text-3xl md:text-4xl font-bold text-center text-white mb-12">
          {data.title}
        </h2>
        <Swiper
          modules={[Navigation]}
          spaceBetween={30}
          slidesPerView={1}
          navigation
          breakpoints={{
            640: {
              slidesPerView: 2,
            },
            768: {
              slidesPerView: 3,
            },
            1024: {
              slidesPerView: 4,
            },
          }}
          className="!pb-10"
        >
          {products.map((product) => (
            <SwiperSlide key={product.id}>
              <ProductCard product={product} />
            </SwiperSlide>
          ))}
        </Swiper>
      </div>
    </section>
  );
};

export default BestSellerSection;
```

### ClientApp\src\components\BestSellers\BestSellers.jsx
```jsx
import React, { useState, useEffect } from "react";
import { Swiper, SwiperSlide } from "swiper/react";
import { Navigation, Autoplay } from "swiper/modules";
import { useNavigate } from "react-router-dom";
import axios from "axios";
import "swiper/css";
import "swiper/css/navigation";
import "swiper/css/autoplay";

const API_BASE_URL = process.env.REACT_APP_API_BASE_URL;

const BestSellers = ({ data }) => {
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const navigate = useNavigate();

  useEffect(() => {
    const fetchBestSellerProducts = async () => {
      if (!data || !data.items || data.items.length === 0) {
        setLoading(false);
        return;
      }

      const productIds = data.items.map(item => item.productId);
      try {
        setLoading(true);
        const response = await axios.get(`${API_BASE_URL}/api/Products/by-ids?ids=${productIds.join(',')}`);
        const fetchedProducts = response.data.$values || response.data || [];

        // Map fetched products with override prices from config
        const combinedProducts = fetchedProducts.map(product => {
          const configItem = data.items.find(item => item.productId === product.id);
          const primaryImage = product.images?.find(img => img.isPrimary) || product.images?.[0];
          const imageUrl = primaryImage ? (primaryImage.imageUrl.startsWith("http") ? primaryImage.imageUrl : `${API_BASE_URL}/${primaryImage.imageUrl}`) : "https://via.placeholder.com/300";

          // Determine prices
          const originalVariantPrice = product.variants?.[0]?.price || 0;
          const displayPrice = configItem?.overridePrice ?? originalVariantPrice;
          const oldPrice = (configItem?.overridePrice && configItem.overridePrice < originalVariantPrice) ? originalVariantPrice : null;
          const discountAmount = oldPrice ? oldPrice - displayPrice : 0;

          return {
            ...product,
            image: imageUrl,
            oldPrice: oldPrice,
            newPrice: displayPrice,
            discountAmount: discountAmount,
            // You might want to calculate discount percentage here if needed
          };
        });
        setProducts(combinedProducts);
      } catch (err) {
        setError("KhÃ´ng thá»ƒ táº£i sáº£n pháº©m bÃ¡n cháº¡y: " + err.message);
        console.error(err);
      } finally {
        setLoading(false);
      }
    };

    fetchBestSellerProducts();
  }, [data]);

  if (!data || !data.enabled || products.length === 0) {
    return null; // Don't render if section is not enabled or no products
  }

  if (loading) {
    return (
      <div className="flex justify-center items-center py-12 space-x-2">
        <div className="animate-bounce w-4 h-4 bg-red-500 rounded-full"></div>
        <div className="animate-bounce w-4 h-4 bg-red-500 rounded-full" style={{ animationDelay: '0.1s' }}></div>
        <div className="animate-bounce w-4 h-4 bg-red-500 rounded-full" style={{ animationDelay: '0.2s' }}></div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mx-auto max-w-md my-6 rounded-lg shadow-md">
        <p className="font-bold">Lá»—i!</p>
        <p>{error}</p>
      </div>
    );
  }

  return (
    <div className="w-full flex justify-center py-6">
      <div className="max-w-[1200px] w-full px-4 bg-white bg-opacity-90 rounded-xl shadow-xl p-6 backdrop-blur-sm">
        <h2 className="text-2xl font-bold text-gray-900 mb-6 text-center relative">
          <span className="relative z-10 px-4 bg-white bg-opacity-90 rounded-full">
            {data.title || "Sáº£n pháº©m bÃ¡n cháº¡y"}
          </span>
          <span className="absolute left-0 right-0 top-1/2 h-0.5 bg-gradient-to-r from-transparent via-red-400 to-transparent z-0"></span>
        </h2>
        
        <Swiper
          modules={[Navigation, Autoplay]}
          navigation
          autoplay={{
            delay: 3000,
            disableOnInteraction: false,
          }}
          spaceBetween={20}
          slidesPerView={1}
          breakpoints={{
            640: { slidesPerView: 2 },
            768: { slidesPerView: 3 },
            1024: { slidesPerView: 4 },
          }}
          className="pb-6"
        >
          {products.map((product) => (
            <SwiperSlide key={product.id} className="flex justify-center">
              <div
                className="bg-white bg-opacity-95 p-4 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl hover:border-red-300 transition-all duration-300 relative overflow-hidden group"
                onClick={() => navigate(`/product/${product.id}`)}
              >
                {/* Discount ribbon - only show if there's a discount amount */}
                {product.discountAmount > 0 && (
                  <div className="absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-1 transform rotate-12 translate-x-2 -translate-y-1 z-10">
                    -{((product.discountAmount / product.oldPrice) * 100).toFixed(0)}%
                  </div>
                )}
                
                <div className="relative h-40 mb-3 overflow-hidden rounded-lg">
                  <img
                    src={product.image}
                    alt={product.name}
                    className="w-full h-full object-contain transition-transform duration-500 group-hover:scale-110"
                    onError={(e) => { 
                      e.target.onerror = null; 
                      e.target.src = "https://via.placeholder.com/150"; 
                    }}
                  />
                </div>

                <div className="text-gray-700 text-sm space-y-2">
                  <div className="flex justify-between items-center">
                    {product.oldPrice && (
                      <span className="text-gray-500 line-through">
                        {product.oldPrice.toLocaleString('vi-VN')}Ä‘
                      </span>
                    )}
                    <span className="text-red-500 font-semibold ml-auto">
                      {product.newPrice.toLocaleString('vi-VN')}Ä‘
                    </span>
                  </div>
                  
                  {product.discountAmount > 0 && (
                    <p className="text-green-600 text-sm font-medium bg-green-50 px-2 py-1 rounded-full inline-block">
                      Tiáº¿t kiá»‡m {product.discountAmount.toLocaleString('vi-VN')}Ä‘
                    </p>
                  )}
                  
                  <h3 className="text-gray-800 font-medium text-base truncate group-hover:text-red-600 transition-colors">
                    {product.name}
                  </h3>
                  
                  {/* Features are not directly available from product DTO, remove or adapt */}
                  {/* <ul className="text-xs text-gray-600 space-y-1">
                    {product.features.map((feature, index) => (
                      <li key={index} className="flex items-center">
                        <span className="w-1.5 h-1.5 bg-red-400 rounded-full mr-2"></span>
                        <span>{feature}</span>
                      </li>
                    ))}
                  </ul> */}
                </div>
              </div>
            </SwiperSlide>
          ))}
        </Swiper>
      </div>
    </div>
  );
};

export default BestSellers;

```

### ClientApp\src\components\Chat\AdminChatDashboard.jsx
```jsx
import React, { useState, useEffect, useRef } from "react";
import {
  MessageSquare,
  Send,
  User,
  Bot,
  AlertCircle,
  Clock,
  CheckCircle,
  Search,
  Filter,
  RefreshCw,
} from "lucide-react";
import { HubConnectionBuilder, LogLevel } from "@microsoft/signalr";

// Import timezone test utilities for debugging
import {
  testTimezoneFormatting,
  compareTimezones,
} from "../../utils/timezoneTest";

// Utility functions for formatting time to Vietnam timezone (UTC+7)
const formatVietnamTime = (dateString) => {
  if (!dateString) return "";
  try {
    const date = new Date(dateString);
    // Format with Vietnam timezone
    return date.toLocaleTimeString("vi-VN", {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      timeZone: "Asia/Ho_Chi_Minh",
      hour12: false,
    });
  } catch (error) {
    console.error("Error formatting time:", error);
    return "";
  }
};

const formatVietnamDate = (dateString) => {
  if (!dateString) return "";
  try {
    const date = new Date(dateString);
    const now = new Date();

    // Convert to Vietnam timezone for comparison
    const vietnamDate = new Date(
      date.toLocaleString("en-US", { timeZone: "Asia/Ho_Chi_Minh" })
    );
    const vietnamNow = new Date(
      now.toLocaleString("en-US", { timeZone: "Asia/Ho_Chi_Minh" })
    );

    // Check if it's today
    if (vietnamDate.toDateString() === vietnamNow.toDateString()) {
      return formatVietnamTime(dateString);
    }

    // Check if it's yesterday
    const yesterday = new Date(vietnamNow);
    yesterday.setDate(yesterday.getDate() - 1);
    if (vietnamDate.toDateString() === yesterday.toDateString()) {
      return `HÃ´m qua ${formatVietnamTime(dateString)}`;
    }

    // Format as date with time
    return date.toLocaleDateString("vi-VN", {
      month: "2-digit",
      day: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      timeZone: "Asia/Ho_Chi_Minh",
      hour12: false,
    });
  } catch (error) {
    console.error("Error formatting date:", error);
    return "";
  }
};

// Format for session list (shorter format)
const formatSessionTime = (dateString) => {
  if (!dateString) return "";
  try {
    const date = new Date(dateString);
    const now = new Date();

    // Convert to Vietnam timezone
    const vietnamDate = new Date(
      date.toLocaleString("en-US", { timeZone: "Asia/Ho_Chi_Minh" })
    );
    const vietnamNow = new Date(
      now.toLocaleString("en-US", { timeZone: "Asia/Ho_Chi_Minh" })
    );

    // If today, show only time
    if (vietnamDate.toDateString() === vietnamNow.toDateString()) {
      return date.toLocaleTimeString("vi-VN", {
        hour: "2-digit",
        minute: "2-digit",
        timeZone: "Asia/Ho_Chi_Minh",
        hour12: false,
      });
    }

    // If this week, show day and time
    const diffTime = vietnamNow - vietnamDate;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays < 7) {
      return date.toLocaleDateString("vi-VN", {
        weekday: "short",
        hour: "2-digit",
        minute: "2-digit",
        timeZone: "Asia/Ho_Chi_Minh",
        hour12: false,
      });
    }

    // Older than a week, show date
    return date.toLocaleDateString("vi-VN", {
      month: "2-digit",
      day: "2-digit",
      timeZone: "Asia/Ho_Chi_Minh",
    });
  } catch (error) {
    console.error("Error formatting session time:", error);
    return "";
  }
};

const AdminChatDashboard = () => {
  const [sessions, setSessions] = useState([]);
  const [selectedSession, setSelectedSession] = useState(null);
  const [messages, setMessages] = useState([]);
  const [newMessage, setNewMessage] = useState("");
  const [connection, setConnection] = useState(null);
  const [connectionReady, setConnectionReady] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [filterStatus, setFilterStatus] = useState("all");
  const [notification, setNotification] = useState(null);
  const messagesEndRef = useRef(null);
  const selectedSessionRef = useRef(null);

  const API_BASE_URL =
    process.env.REACT_APP_API_BASE_URL || "https://localhost:7107";

  useEffect(() => {
    initializeConnection();
    fetchSessions();

    // Auto refresh every 30 seconds
    const interval = setInterval(fetchSessions, 30000);
    return () => {
      clearInterval(interval);
      // Cleanup SignalR connection
      if (connection) {
        connection.stop().catch(console.error);
      }
    };
  }, []); // eslint-disable-line react-hooks/exhaustive-deps

  // Cleanup connection when component unmounts
  useEffect(() => {
    return () => {
      if (connection && connection.state !== "Disconnected") {
        connection.stop().catch(console.error);
      }
    };
  }, [connection]);

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  // Ensure connection is ready before using it
  useEffect(() => {
    if (connection && connection.state === "Connected") {
      console.log("ğŸ”¥ ADMIN: Connection is ready for use");
    }
  }, [connection]);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  const initializeConnection = async () => {
    try {
      // Cleanup existing connection first
      if (connection) {
        console.log("ğŸ”¥ ADMIN: Cleaning up existing connection");
        await connection.stop();
        setConnection(null);
        setConnectionReady(false);
      }

      const token = localStorage.getItem("token");

      const newConnection = new HubConnectionBuilder()
        .withUrl(`${API_BASE_URL}/chatHub?access_token=${token}`, {
          skipNegotiation: false,
          accessTokenFactory: () => token,
          headers: {}
        })
        .withAutomaticReconnect([0, 2000, 10000, 30000])
        .configureLogging(LogLevel.Information)
        .build();

      // Handle connection errors
      newConnection.onclose((error) => {
        console.log("ğŸ”¥ ADMIN: SignalR connection closed:", error);
        if (error) {
          console.error("ğŸ”¥ ADMIN: Connection closed with error:", error);
        }
      });

      newConnection.onreconnecting((error) => {
        console.log("ğŸ”¥ ADMIN: SignalR reconnecting:", error);
      });

      newConnection.onreconnected((connectionId) => {
        console.log("ğŸ”¥ ADMIN: SignalR reconnected:", connectionId);
        // Rejoin admin group after reconnection
        newConnection.invoke("JoinAdminGroup").catch(console.error);
        // Rejoin session group if session is selected
        if (selectedSessionRef.current) {
          const sessionIdentifier =
            selectedSessionRef.current.sessionId ||
            selectedSessionRef.current.id;
          newConnection
            .invoke("JoinSession", sessionIdentifier)
            .catch(console.error);
        }
      });

      // Set up event handlers
      newConnection.on("NewMessage", (message) => {
        console.log("ğŸ”¥ ADMIN: Received new message:", message); // Enhanced debug log
        const currentSession = selectedSessionRef.current;
        console.log("ğŸ”¥ ADMIN: Current selected session:", currentSession?.id);
        console.log("ğŸ”¥ ADMIN: Message session ID:", message.chatSessionId);

        // If this message is for the currently selected session, add it to messages
        if (currentSession && message.chatSessionId === currentSession.id) {
          console.log("ğŸ”¥ ADMIN: Adding message to current session");
          setMessages((prev) => {
            // Check for duplicates
            const messageExists = prev.some((m) => m.id === message.id);
            if (messageExists) {
              console.log("ğŸ”¥ ADMIN: Message already exists, skipping");
              return prev;
            }
            console.log("ğŸ”¥ ADMIN: Adding new message to state");
            const newMessages = [...prev, message];
            // Auto-scroll to bottom when new message arrives
            setTimeout(() => {
              const messagesContainer = document.querySelector(
                ".messages-container"
              );
              if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
              }
            }, 100);
            return newMessages;
          });
        } else {
          console.log(
            "ğŸ”¥ ADMIN: Message not for current session or no session selected"
          );
        }

        // Always show notification for new user messages to admin
        if (message.sender === "User") {
          const senderName = message.senderUser?.fullName || "Guest User";
          const notificationMsg = `New message from ${senderName}: ${message.content.substring(
            0,
            50
          )}${message.content.length > 50 ? "..." : ""}`;
          console.log("ğŸ”¥ ADMIN: Showing notification:", notificationMsg);
          showNotification(notificationMsg);
        }

        // Update session list to reflect new activity (but don't fetch if message added to current session)
        if (!currentSession || message.chatSessionId !== currentSession.id) {
          console.log("ğŸ”¥ ADMIN: Refreshing sessions list");
          fetchSessions();
        }
      });

      newConnection.on("NewChatSession", (session) => {
        // Show notification for new chat session
        showNotification(
          `New chat session from ${
            session.user?.fullName || session.guestName || "Guest"
          }`
        );
        fetchSessions();
      });

      newConnection.on("ChatEscalated", (session) => {
        // Show notification for new escalated chat
        showNotification(
          `New chat escalated from ${
            session.user?.fullName || session.guestName || "Guest"
          }`
        );
        fetchSessions();
      });

      await newConnection.start();
      console.log("ğŸ”¥ ADMIN: SignalR connection started successfully");

      // Join admin group
      try {
        await newConnection.invoke("JoinAdminGroup");
        console.log("ğŸ”¥ ADMIN: Successfully joined admin group");
      } catch (joinError) {
        console.error("ğŸ”¥ ADMIN: Failed to join admin group:", joinError);
        // Continue anyway, might be an auth issue
      }

      setConnection(newConnection);
      setConnectionReady(true);
      console.log("ğŸ”¥ ADMIN: SignalR setup complete");
    } catch (error) {
      console.error("ğŸ”¥ ADMIN: SignalR connection failed:", error);
      setConnectionReady(false);
      // Retry connection after 5 seconds
      setTimeout(() => {
        console.log("ğŸ”¥ ADMIN: Retrying SignalR connection...");
        initializeConnection();
      }, 5000);
    }
  };

  const fetchSessions = async () => {
    try {
      const token = localStorage.getItem("token");
      if (!token) {
        console.error("No token found for admin authentication");
        return;
      }

      console.log(
        "Fetching sessions with token:",
        token.substring(0, 20) + "..."
      );

      const response = await fetch(`${API_BASE_URL}/api/chat/admin/sessions`, {
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
      });

      console.log("Sessions response status:", response.status);

      if (response.ok) {
        const data = await response.json();
        console.log("Sessions fetched successfully:", data);
        setSessions(data);
      } else {
        const errorText = await response.text();
        console.error(
          "Failed to fetch sessions:",
          response.status,
          response.statusText,
          errorText
        );
        if (response.status === 401) {
          console.error("Unauthorized - check admin token and role");
        }
      }
    } catch (error) {
      console.error("Error fetching sessions:", error);
    } finally {
      setIsLoading(false);
    }
  };

  const selectSession = async (session) => {
    console.log("Selecting session:", session);
    setSelectedSession(session);
    selectedSessionRef.current = session; // Update ref for real-time message handling

    try {
      const token = localStorage.getItem("token");
      // Use sessionId or fallback to id
      const sessionIdentifier = session.sessionId || session.id;
      console.log("Fetching messages for session:", sessionIdentifier);

      const response = await fetch(
        `${API_BASE_URL}/api/chat/session/${sessionIdentifier}`,
        {
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
        }
      );

      console.log("Session messages response status:", response.status);

      if (response.ok) {
        const sessionData = await response.json();
        console.log("Session data received:", sessionData);
        console.log("Messages count:", sessionData.messages?.length || 0);
        setMessages(sessionData.messages || []);

        // Join session group for real-time updates
        if (connection && connection.state === "Connected") {
          try {
            await connection.invoke("JoinSession", sessionIdentifier);
            console.log("Joined session group:", sessionIdentifier);
          } catch (joinError) {
            console.error("Failed to join session group:", joinError);
          }
        } else {
          console.warn("Cannot join session group - connection not ready");
        }
      } else {
        const errorText = await response.text();
        console.error(
          "Failed to fetch session messages:",
          response.status,
          response.statusText,
          errorText
        );
      }
    } catch (error) {
      console.error("Error fetching session messages:", error);
    }
  };

  const sendMessage = async () => {
    if (!newMessage.trim() || !selectedSession) return;

    const messageText = newMessage.trim();
    setNewMessage("");

    try {
      const token = localStorage.getItem("token");
      const sessionIdentifier = selectedSession.sessionId || selectedSession.id;
      const response = await fetch(
        `${API_BASE_URL}/api/chat/${sessionIdentifier}/admin-message`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            content: messageText,
          }),
        }
      );

      if (!response.ok) {
        throw new Error("Failed to send message");
      }

      // Don't add message here - let SignalR handle it to avoid duplicates
    } catch (error) {
      console.error("Error sending admin message:", error);
      // Add error handling
      setMessages((prev) => [
        ...prev,
        {
          id: Date.now(),
          content: "Lá»—i khi gá»­i tin nháº¯n. Vui lÃ²ng thá»­ láº¡i.",
          type: "Text",
          sender: "System",
          sentAt: new Date().toISOString(),
        },
      ]);
    }
  };

  const showNotification = (message) => {
    // Fallback notification if browser notifications fail
    try {
      if (
        typeof window !== "undefined" &&
        window.Notification &&
        Notification.permission === "granted"
      ) {
        new Notification("SHN-Gear Chat", {
          body: message,
          icon: "/favicon.ico",
        });
      } else {
        // Fallback to console notification
        console.log("ğŸ“¢ NOTIFICATION:", message);
      }
    } catch (error) {
      console.warn("Browser notification failed:", error);
      console.log("ğŸ“¢ NOTIFICATION (fallback):", message);
    }

    // Always show in-app notification
    setNotification(message);
    setTimeout(() => setNotification(null), 5000);
  };

  // Debug function to test connection
  const debugConnection = () => {
    console.log("ğŸ” DEBUG CONNECTION STATUS:");
    console.log("Connection:", connection);
    console.log("Connection state:", connection?.state);
    console.log("Connection ready:", connectionReady);
    console.log("Selected session:", selectedSessionRef.current);

    // Test timezone formatting
    console.log("ğŸ• TESTING TIMEZONE FORMATTING:");
    testTimezoneFormatting();

    // Test with sample message timestamp
    if (messages.length > 0) {
      const sampleMessage = messages[0];
      console.log("Sample message timestamp:", sampleMessage.sentAt);
      compareTimezones(sampleMessage.sentAt);
    }

    if (connection && connection.state === "Connected") {
      console.log("âœ… Connection is active");
      // Test sending a ping to admin group
      connection
        .invoke("JoinAdminGroup")
        .then(() => console.log("âœ… Successfully rejoined admin group"))
        .catch((err) => console.error("âŒ Failed to rejoin admin group:", err));
    } else {
      console.log("âŒ Connection not ready");
    }
  };

  const getSessionStatus = (session) => {
    if (session.status === "Escalated") return "escalated";
    if (session.requiresHumanSupport) return "needs-attention";
    return "active";
  };

  const getStatusColor = (status) => {
    switch (status) {
      case "escalated":
        return "text-red-500";
      case "needs-attention":
        return "text-orange-500";
      default:
        return "text-green-500";
    }
  };

  const getStatusIcon = (status) => {
    switch (status) {
      case "escalated":
        return <AlertCircle size={16} />;
      case "needs-attention":
        return <Clock size={16} />;
      default:
        return <CheckCircle size={16} />;
    }
  };

  const filteredSessions = sessions.filter((session) => {
    const matchesSearch =
      searchTerm === "" ||
      (session.user?.fullName || session.guestName || "Guest")
        .toLowerCase()
        .includes(searchTerm.toLowerCase());

    const matchesFilter =
      filterStatus === "all" || getSessionStatus(session) === filterStatus;

    return matchesSearch && matchesFilter;
  });

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-full min-h-[400px] bg-transparent">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
        <span className="ml-3 text-gray-100 font-medium">Äang táº£i...</span>
      </div>
    );
  }

  return (
    <div className="flex h-full bg-gray-900 text-gray-100 flex-col md:flex-row">
      {/* Sessions List */}
      <div className="w-full md:w-1/3 bg-gray-800 border-r border-gray-700 flex flex-col">
        {/* Header */}
        <div className="p-4 border-b border-gray-700 bg-gray-800 flex-shrink-0">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-semibold text-gray-100">
              Chat Dashboard
            </h2>
            <div className="flex space-x-2">
              <button
                onClick={debugConnection}
                className="p-2 text-gray-400 hover:text-gray-200 rounded-md hover:bg-gray-700 transition-colors"
                title="Debug Connection"
              >
                ğŸ”
              </button>
              <button
                onClick={fetchSessions}
                className="p-2 text-gray-400 hover:text-gray-200 rounded-md hover:bg-gray-700 transition-colors"
              >
                <RefreshCw size={18} />
              </button>
            </div>
          </div>

          {/* Search */}
          <div className="relative mb-3">
            <Search
              size={18}
              className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
            />
            <input
              type="text"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              placeholder="TÃ¬m kiáº¿m khÃ¡ch hÃ ng..."
              className="w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          {/* Filter */}
          <div className="flex items-center space-x-2">
            <Filter size={16} className="text-gray-400" />
            <select
              value={filterStatus}
              onChange={(e) => setFilterStatus(e.target.value)}
              className="text-sm bg-gray-700 border border-gray-600 text-gray-100 rounded-md px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">Táº¥t cáº£</option>
              <option value="escalated">ÄÃ£ chuyá»ƒn</option>
              <option value="needs-attention">Cáº§n chÃº Ã½</option>
              <option value="active">Hoáº¡t Ä‘á»™ng</option>
            </select>
          </div>
        </div>

        {/* Sessions */}
        <div className="flex-1 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-gray-800">
          {isLoading ? (
            <div className="text-center text-gray-400 mt-8">
              <RefreshCw
                size={24}
                className="mx-auto mb-4 text-gray-600 animate-spin"
              />
              <p>Äang táº£i...</p>
            </div>
          ) : filteredSessions.length === 0 ? (
            <div className="text-center text-gray-400 mt-8">
              <MessageSquare size={48} className="mx-auto mb-4 text-gray-600" />
              <p>KhÃ´ng cÃ³ cuá»™c trÃ² chuyá»‡n nÃ o</p>
              <button
                onClick={fetchSessions}
                className="mt-2 text-blue-400 hover:text-blue-300 text-sm"
              >
                Táº£i láº¡i
              </button>
            </div>
          ) : (
            filteredSessions.map((session) => {
              const status = getSessionStatus(session);
              const lastMessage =
                session.messages && session.messages.length > 0
                  ? session.messages[session.messages.length - 1]
                  : null;

              return (
                <div
                  key={session.id}
                  onClick={() => selectSession(session)}
                  className={`p-4 border-b border-gray-700 cursor-pointer hover:bg-gray-700 transition-colors ${
                    selectedSession?.id === session.id
                      ? "bg-blue-800 border-blue-600"
                      : ""
                  }`}
                >
                  <div className="flex items-start justify-between">
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center space-x-2">
                        <User
                          size={16}
                          className="text-gray-400 flex-shrink-0"
                        />
                        <span className="font-medium text-gray-100 truncate">
                          {session.user?.fullName ||
                            session.guestName ||
                            "Guest"}
                        </span>
                        <div
                          className={`flex items-center space-x-1 ${getStatusColor(
                            status
                          )}`}
                        >
                          {getStatusIcon(status)}
                        </div>
                      </div>

                      {lastMessage && (
                        <p className="text-sm text-gray-400 truncate mt-1">
                          {lastMessage.sender === "AI" && (
                            <Bot size={12} className="inline mr-1" />
                          )}
                          {lastMessage.content}
                        </p>
                      )}

                      <div className="flex items-center justify-between mt-2">
                        <span className="text-xs text-gray-400">
                          {formatSessionTime(session.lastActivityAt)}
                        </span>
                        <span
                          className={`text-xs px-2 py-1 rounded-full font-medium ${
                            session.type === "AI"
                              ? "bg-green-800 text-green-200 border border-green-600"
                              : "bg-blue-800 text-blue-200 border border-blue-600"
                          }`}
                        >
                          {session.type}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>

      {/* Chat Area */}
      <div className="flex-1 flex flex-col bg-gray-900">
        {selectedSession ? (
          <>
            {/* Chat Header */}
            <div className="bg-gray-800 border-b border-gray-700 p-4 flex-shrink-0">
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="font-semibold text-gray-100">
                    {selectedSession.user?.fullName ||
                      selectedSession.guestName ||
                      "Guest"}
                  </h3>
                  <p className="text-sm text-gray-400">
                    {(selectedSession.user?.email ||
                      selectedSession.guestEmail) && (
                      <>
                        Email:{" "}
                        {selectedSession.user?.email ||
                          selectedSession.guestEmail}{" "}
                        â€¢{" "}
                      </>
                    )}
                    Session: {selectedSession.sessionId} â€¢ Type:{" "}
                    {selectedSession.type} â€¢ Started:{" "}
                    {formatVietnamDate(selectedSession.createdAt)} (UTC+7)
                  </p>
                </div>
                <div
                  className={`flex items-center space-x-2 ${getStatusColor(
                    getSessionStatus(selectedSession)
                  )}`}
                >
                  {getStatusIcon(getSessionStatus(selectedSession))}
                  <span className="text-sm font-medium text-gray-100">
                    {getSessionStatus(selectedSession)
                      .replace("-", " ")
                      .toUpperCase()}
                  </span>
                </div>
              </div>
            </div>

            {/* Messages */}
            <div className="flex-1 overflow-y-auto p-4 bg-gray-900 scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-gray-800">
              {messages.length === 0 ? (
                <div className="flex items-center justify-center h-full">
                  <div className="text-center text-gray-400">
                    <MessageSquare
                      size={48}
                      className="mx-auto mb-4 text-gray-600"
                    />
                    <p>ChÆ°a cÃ³ tin nháº¯n nÃ o</p>
                  </div>
                </div>
              ) : (
                messages.map((message) => {
                  const isAdmin = message.sender === "Admin";
                  const isUser = message.sender === "User";
                  const isAI = message.sender === "AI";
                  const isSystem = message.sender === "System";

                  return (
                    <div
                      key={message.id}
                      className={`mb-4 flex ${
                        isAdmin ? "justify-end" : "justify-start"
                      }`}
                    >
                      <div
                        className={`flex items-start space-x-2 max-w-sm md:max-w-md lg:max-w-lg xl:max-w-xl ${
                          isAdmin ? "flex-row-reverse space-x-reverse" : ""
                        }`}
                      >
                        {/* Avatar */}
                        <div
                          className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${
                            isAdmin
                              ? "bg-purple-500"
                              : isUser
                              ? "bg-blue-500"
                              : isAI
                              ? "bg-green-500"
                              : "bg-gray-500"
                          }`}
                        >
                          {isAdmin ? (
                            "ğŸ‘¨â€ğŸ’¼"
                          ) : isUser ? (
                            <User size={16} color="white" />
                          ) : isAI ? (
                            <Bot size={16} color="white" />
                          ) : (
                            "ğŸ””"
                          )}
                        </div>

                        {/* Message bubble */}
                        <div
                          className={`rounded-lg px-4 py-3 shadow-lg border ${
                            isAdmin
                              ? "bg-purple-600 text-white border-purple-500"
                              : isUser
                              ? "bg-blue-600 text-white border-blue-500"
                              : isSystem
                              ? "bg-gray-700 text-white border-gray-600"
                              : "bg-green-600 text-white border-green-500"
                          }`}
                        >
                          <div className="whitespace-pre-wrap text-sm font-semibold leading-relaxed">
                            {message.content}
                          </div>

                          {/* AI info */}
                          {message.aiConfidenceScore && (
                            <div
                              className={`text-xs mt-2 font-medium ${
                                isAdmin
                                  ? "text-purple-200"
                                  : isUser
                                  ? "text-blue-200"
                                  : isSystem
                                  ? "text-gray-300"
                                  : "text-green-200"
                              }`}
                            >
                              Confidence:{" "}
                              {(message.aiConfidenceScore * 100).toFixed(0)}%
                              {message.aiIntent &&
                                ` â€¢ Intent: ${message.aiIntent}`}
                            </div>
                          )}

                          <div
                            className={`text-xs mt-2 font-medium ${
                              isAdmin
                                ? "text-purple-200"
                                : isUser
                                ? "text-blue-200"
                                : isSystem
                                ? "text-gray-300"
                                : "text-green-200"
                            }`}
                          >
                            {formatVietnamTime(message.sentAt)} (UTC+7)
                            {message.senderUser &&
                              ` â€¢ ${message.senderUser.fullName}`}
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })
              )}
              <div ref={messagesEndRef} />
            </div>

            {/* Message Input */}
            <div className="bg-gray-800 border-t border-gray-700 p-4 flex-shrink-0">
              <div className="flex items-center space-x-2">
                <input
                  type="text"
                  value={newMessage}
                  onChange={(e) => setNewMessage(e.target.value)}
                  onKeyPress={(e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                      e.preventDefault();
                      sendMessage();
                    }
                  }}
                  placeholder="Nháº­p tin nháº¯n..."
                  className="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
                <button
                  onClick={sendMessage}
                  disabled={!newMessage.trim()}
                  className="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 disabled:bg-gray-600 disabled:text-gray-400 transition-colors"
                >
                  <Send size={16} />
                </button>
              </div>
            </div>
          </>
        ) : (
          <div className="flex-1 flex items-center justify-center bg-gray-900">
            <div className="text-center text-gray-300">
              <MessageSquare size={64} className="mx-auto mb-4 text-gray-500" />
              <h3 className="text-lg font-medium mb-2 text-gray-200">
                Chá»n cuá»™c trÃ² chuyá»‡n
              </h3>
              <p className="text-gray-400">
                Chá»n má»™t cuá»™c trÃ² chuyá»‡n tá»« danh sÃ¡ch Ä‘á»ƒ báº¯t Ä‘áº§u há»— trá»£ khÃ¡ch
                hÃ ng
              </p>
            </div>
          </div>
        )}
      </div>

      {/* Notification Toast */}
      {notification && (
        <div className="fixed top-4 right-4 bg-blue-500 text-white p-4 rounded-md shadow-lg z-50 max-w-sm">
          <p className="text-sm">{notification}</p>
        </div>
      )}
    </div>
  );
};

export default AdminChatDashboard;

```

### ClientApp\src\components\Chat\ChatWidget.jsx
```jsx
import React, { useState, useEffect, useRef } from 'react';
import { 
  MessageCircle, 
  Send, 
  X, 
  Minimize2, 
  Maximize2, 
  Bot, 
  User, 
  ShoppingCart,
  ExternalLink,
  Phone
} from 'lucide-react';
import { HubConnectionBuilder, LogLevel } from '@microsoft/signalr';

// Utility function for formatting time to Vietnam timezone
const formatVietnamTime = (dateString) => {
  if (!dateString) return '';
  try {
    return new Date(dateString).toLocaleTimeString('vi-VN', { 
      hour: '2-digit', 
      minute: '2-digit',
      timeZone: 'Asia/Ho_Chi_Minh'
    });
  } catch (error) {
    console.error('Error formatting date:', error);
    return '';
  }
};

const ChatWidget = () => {
  const [isOpen, setIsOpen] = useState(false);
  const [isMinimized, setIsMinimized] = useState(false);
  const [messages, setMessages] = useState([]);
  const [inputMessage, setInputMessage] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [sessionId, setSessionId] = useState(null);
  const [connection, setConnection] = useState(null);
  const [isConnecting, setIsConnecting] = useState(false);
  const [guestName, setGuestName] = useState('');
  const [guestEmail, setGuestEmail] = useState('');
  const [showNamePrompt, setShowNamePrompt] = useState(true);
  const messagesEndRef = useRef(null);
  const inputRef = useRef(null);

  const API_BASE_URL = process.env.REACT_APP_API_BASE_URL || 'https://localhost:7107';

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  useEffect(() => {
    if (isOpen && !connection && !isConnecting) {
      initializeConnection();
    }
  }, [isOpen]);

  // Cleanup connection on unmount
  useEffect(() => {
    return () => {
      if (connection) {
        connection.stop().catch(console.error);
      }
    };
  }, [connection]);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  const initializeConnection = async () => {
    try {
      setIsConnecting(true);
      
      const token = localStorage.getItem('token');
      const connectionUrl = token 
        ? `${API_BASE_URL}/chatHub?access_token=${token}`
        : `${API_BASE_URL}/chatHub`;
      
      const newConnection = new HubConnectionBuilder()
        .withUrl(connectionUrl, {
          skipNegotiation: false,
          accessTokenFactory: () => token
        })
        .withAutomaticReconnect([0, 2000, 10000, 30000])
        .configureLogging(LogLevel.Information)
        .build();

      // Set up event handlers
      newConnection.on('NewMessage', (message) => {
        setMessages(prev => {
          // Remove any temporary messages with same content
          const filteredMessages = prev.filter(m => 
            !(m.isTemporary && m.content === message.content && m.sender === message.sender)
          );
          
          // Check if message already exists to prevent duplicates
          const messageExists = filteredMessages.some(m => m.id === message.id || 
            (m.content === message.content && 
             m.sender === message.sender && 
             m.sentAt && message.sentAt &&
             Math.abs(new Date(m.sentAt) - new Date(message.sentAt)) < 1000)
          );
          
          if (messageExists) {
            return filteredMessages;
          }
          
          return [...filteredMessages, message];
        });
        setIsLoading(false);
      });

      newConnection.on('TypingIndicator', (data) => {
        if (data.isTyping && data.userId !== getCurrentUserId()) {
          setIsTyping(true);
          setTimeout(() => setIsTyping(false), 3000);
        }
      });

      newConnection.on('ChatEscalated', (session) => {
        setMessages(prev => [...prev, {
          id: Date.now(),
          content: 'Báº¡n Ä‘Ã£ Ä‘Æ°á»£c káº¿t ná»‘i vá»›i nhÃ¢n viÃªn tÆ° váº¥n. Vui lÃ²ng chá» trong giÃ¢y lÃ¡t...',
          type: 'Text',
          sender: 'System',
          sentAt: new Date().toISOString()
        }]);
      });

      await newConnection.start();
      setConnection(newConnection);
      console.log('SignalR connected successfully');
    } catch (error) {
      console.error('SignalR connection failed:', error);
    } finally {
      setIsConnecting(false);
    }
  };

  const createSession = async () => {
    try {
      const token = localStorage.getItem('token');
      const headers = {
        'Content-Type': 'application/json'
      };

      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }

      const response = await fetch(`${API_BASE_URL}/api/chat/session`, {
        method: 'POST',
        headers,
        body: JSON.stringify({
          sessionId: sessionId,
          guestName: !token ? guestName : undefined,
          guestEmail: !token ? guestEmail : undefined
        })
      });

      if (!response.ok) {
        throw new Error('Failed to create chat session');
      }

      const session = await response.json();
      setSessionId(session.sessionId);
      setMessages(session.messages || []);

      // Join SignalR group
      if (connection) {
        await connection.invoke('JoinSession', session.sessionId);
      }

      return session;
    } catch (error) {
      console.error('Error creating session:', error);
      throw error;
    }
  };

  const sendMessage = async () => {
    if (!inputMessage.trim()) return;

    const messageText = inputMessage.trim();
    setInputMessage('');
    setIsLoading(true);

    try {
      let currentSessionId = sessionId;
      
      // Create session if not exists
      if (!currentSessionId) {
        const session = await createSession();
        currentSessionId = session.sessionId;
      }

      const token = localStorage.getItem('token');
      const headers = {
        'Content-Type': 'application/json'
      };

      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }

      // Add user message to UI immediately with temporary ID
      const tempId = `temp_${Date.now()}`;
      const userMessage = {
        id: tempId,
        content: messageText,
        type: 'Text',
        sender: 'User',
        sentAt: new Date().toISOString(),
        isTemporary: true
      };
      setMessages(prev => [...prev, userMessage]);

      // Send typing indicator
      if (connection) {
        await connection.invoke('SendTypingIndicator', currentSessionId, true);
      }

      const response = await fetch(`${API_BASE_URL}/api/chat/message`, {
        method: 'POST',
        headers,
        body: JSON.stringify({
          content: messageText,
          sessionId: currentSessionId,
          guestName: !token ? guestName : undefined,
          guestEmail: !token ? guestEmail : undefined
        })
      });

      if (!response.ok) {
        throw new Error('Failed to send message');
      }

      // Stop typing indicator
      if (connection) {
        await connection.invoke('SendTypingIndicator', currentSessionId, false);
      }

    } catch (error) {
      console.error('Error sending message:', error);
      setIsLoading(false);
      
      // Remove temporary message and add error message
      setMessages(prev => {
        const filteredMessages = prev.filter(m => !m.isTemporary);
        return [...filteredMessages, {
          id: Date.now(),
          content: 'Xin lá»—i, cÃ³ lá»—i xáº£y ra khi gá»­i tin nháº¯n. Vui lÃ²ng thá»­ láº¡i.',
          type: 'Text',
          sender: 'System',
          sentAt: new Date().toISOString()
        }];
      });
    }
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  };

  const handleSuggestedAction = async (action, data) => {
    switch (action) {
      case 'search_phones':
        setInputMessage('TÃ´i muá»‘n tÃ¬m Ä‘iá»‡n thoáº¡i');
        break;
      case 'search_laptops':
        setInputMessage('TÃ´i muá»‘n tÃ¬m laptop');
        break;
      case 'search_headphones':
        setInputMessage('TÃ´i muá»‘n tÃ¬m tai nghe');
        break;
      case 'view_promotions':
        setInputMessage('CÃ³ khuyáº¿n mÃ£i gÃ¬ khÃ´ng?');
        break;
      case 'contact_admin':
        await escalateToAdmin();
        return;
      case 'add_to_cart':
        if (data?.productId) {
          // Add to cart logic
          console.log('Add to cart:', data.productId);
        }
        return;
      case 'view_product':
        if (data?.productId) {
          window.open(`/products/${data.productId}`, '_blank');
        }
        return;
      default:
        return;
    }
    
    // Auto send the message
    setTimeout(() => sendMessage(), 100);
  };

  const escalateToAdmin = async () => {
    try {
      const response = await fetch(`${API_BASE_URL}/api/chat/${sessionId}/escalate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          reason: 'User requested human support'
        })
      });

      if (response.ok) {
        setMessages(prev => [...prev, {
          id: Date.now(),
          content: 'Äang káº¿t ná»‘i báº¡n vá»›i nhÃ¢n viÃªn tÆ° váº¥n...',
          type: 'Text',
          sender: 'System',
          sentAt: new Date().toISOString()
        }]);
      }
    } catch (error) {
      console.error('Error escalating to admin:', error);
    }
  };

  const getCurrentUserId = () => {
    const token = localStorage.getItem('token');
    if (!token) return null;
    
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      return parseInt(payload.sub);
    } catch {
      return null;
    }
  };

  const renderMessage = (message) => {
    const isUser = message.sender === 'User';
    const isAI = message.sender === 'AI';
    const isSystem = message.sender === 'System';

    return (
      <div key={message.id} className={`mb-4 flex ${isUser ? 'justify-end' : 'justify-start'}`}>
        <div className={`flex items-start space-x-2 max-w-xs lg:max-w-md ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`}>
          {/* Avatar */}
          <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${
            isUser ? 'bg-blue-500' : isAI ? 'bg-green-500' : 'bg-gray-400'
          }`}>
            {isUser ? <User size={16} color="white" /> : 
             isAI ? <Bot size={16} color="white" /> : 
             <MessageCircle size={16} color="white" />}
          </div>

          {/* Message bubble */}
          <div className={`rounded-lg px-3 py-2 ${
            isUser 
              ? 'bg-blue-500 text-white' 
              : isSystem 
                ? 'bg-gray-100 text-gray-800 border border-gray-200'
                : 'bg-white text-gray-800 border border-gray-200'
          }`}>
            <div className="whitespace-pre-wrap text-sm">{message.content}</div>
            
            {/* Product recommendations */}
            {message.metadata?.ProductRecommendations && (
              <div className="mt-2 space-y-2">
                {message.metadata.ProductRecommendations.map((product, index) => (
                  <div key={index} className="bg-gray-50 rounded p-2 text-xs">
                    <div className="flex items-center justify-between">
                      <div>
                        <div className="font-medium text-gray-900">{product.name}</div>
                        <div className="text-gray-600">{product.brand} - {product.category}</div>
                        <div className="text-blue-600 font-medium">
                          {product.discountPrice ? (
                            <>
                              {(product.discountPrice || 0).toLocaleString()}Ä‘ 
                              <span className="line-through text-gray-400 ml-1">
                                {(product.price || 0).toLocaleString()}Ä‘
                              </span>
                            </>
                          ) : (
                            `${(product.price || 0).toLocaleString()}Ä‘`
                          )}
                        </div>
                      </div>
                      <button
                        onClick={() => handleSuggestedAction('view_product', { productId: product.productId })}
                        className="text-blue-500 hover:text-blue-700"
                      >
                        <ExternalLink size={14} />
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* Suggested actions */}
            {message.suggestedActions && message.suggestedActions.length > 0 && (
              <div className="mt-2 flex flex-wrap gap-1">
                {message.suggestedActions.map((action, index) => (
                  <button
                    key={index}
                    onClick={() => handleSuggestedAction(action.action, action.data)}
                    className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 transition-colors"
                  >
                    {action.text}
                  </button>
                ))}
              </div>
            )}

            <div className={`text-xs mt-1 ${isUser ? 'text-blue-100' : 'text-gray-500'}`}>
              {formatVietnamTime(message.sentAt)}
            </div>
          </div>
        </div>
      </div>
    );
  };

  // Guest name prompt
  if (isOpen && !sessionId && showNamePrompt && !localStorage.getItem('token')) {
    return (
      <div className="fixed bottom-6 right-6 w-80 bg-white rounded-xl shadow-2xl border z-[9999]">
        <div className="p-4">
          <div className="flex items-center justify-between mb-4">
            <h3 className="font-semibold text-gray-800">ChÃ o má»«ng Ä‘áº¿n SHN-Gear!</h3>
            <button
              onClick={() => setIsOpen(false)}
              className="text-gray-500 hover:text-gray-700 p-1 rounded hover:bg-gray-100 transition-colors"
            >
              <X size={20} />
            </button>
          </div>
          <p className="text-sm text-gray-600 mb-3">
            Äá»ƒ chÃºng tÃ´i há»— trá»£ báº¡n tá»‘t hÆ¡n, vui lÃ²ng cho biáº¿t thÃ´ng tin cá»§a báº¡n:
          </p>
          <input
            type="text"
            value={guestName}
            onChange={(e) => setGuestName(e.target.value)}
            placeholder="Nháº­p tÃªn cá»§a báº¡n..."
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-2"
          />
          <input
            type="email"
            value={guestEmail}
            onChange={(e) => setGuestEmail(e.target.value)}
            placeholder="Email cá»§a báº¡n (tÃ¹y chá»n)..."
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-3"
            onKeyPress={(e) => {
              if (e.key === 'Enter' && guestName.trim()) {
                setShowNamePrompt(false);
                createSession();
              }
            }}
          />
          <div className="flex space-x-2">
            <button
              onClick={() => {
                if (guestName.trim()) {
                  setShowNamePrompt(false);
                  createSession();
                }
              }}
              disabled={!guestName.trim()}
              className="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm font-medium transition-colors"
            >
              Báº¯t Ä‘áº§u chat
            </button>
            <button
              onClick={() => {
                setGuestName('KhÃ¡ch');
                setShowNamePrompt(false);
                createSession();
              }}
              className="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 text-sm font-medium transition-colors"
            >
              Bá» qua
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Main chat widget
  return (
    <>
      {/* Chat button */}
      {!isOpen && (
        <button
          onClick={() => setIsOpen(true)}
          className="fixed bottom-6 right-6 w-14 h-14 bg-blue-500 hover:bg-blue-600 text-white rounded-full shadow-xl flex items-center justify-center transition-all duration-300 z-[9999] hover:scale-110"
        >
          <MessageCircle size={24} />
        </button>
      )}

      {/* Chat window */}
      {isOpen && (
        <div className={`fixed bottom-6 right-6 bg-white rounded-xl shadow-2xl border z-[9999] transition-all duration-300 flex flex-col ${
          isMinimized ? 'w-80 h-14' : 'w-80 h-[500px]'
        } max-h-[80vh]`}>
          {/* Header */}
          <div className="bg-blue-500 text-white p-4 rounded-t-xl flex items-center justify-between flex-shrink-0">
            <div className="flex items-center space-x-2">
              <Bot size={20} />
              <div>
                <div className="font-semibold text-sm">SHN-Gear Assistant</div>
                <div className="text-xs text-blue-100">
                  {isConnecting ? 'Äang káº¿t ná»‘i...' : 'Online â€¢ Pháº£n há»“i ngay'}
                </div>
              </div>
            </div>
            <div className="flex items-center space-x-1">
              <button
                onClick={() => setIsMinimized(!isMinimized)}
                className="text-blue-100 hover:text-white p-1 rounded hover:bg-blue-600 transition-colors"
              >
                {isMinimized ? <Maximize2 size={16} /> : <Minimize2 size={16} />}
              </button>
              <button
                onClick={() => setIsOpen(false)}
                className="text-blue-100 hover:text-white p-1 rounded hover:bg-blue-600 transition-colors"
              >
                <X size={16} />
              </button>
            </div>
          </div>

          {!isMinimized && (
            <>
              {/* Messages */}
              <div className="flex-1 overflow-y-auto p-4 bg-gray-50 min-h-0">
                {messages.length === 0 && (
                  <div className="text-center text-gray-500 text-sm mt-8">
                    <Bot size={32} className="mx-auto mb-2 text-gray-400" />
                    <p>Xin chÃ o! TÃ´i cÃ³ thá»ƒ giÃºp gÃ¬ cho báº¡n?</p>
                  </div>
                )}
                
                {messages.map(renderMessage)}
                
                {isTyping && (
                  <div className="flex items-center space-x-2 text-gray-500 text-sm mb-2">
                    <Bot size={16} />
                    <div className="flex space-x-1">
                      <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                      <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                      <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                    </div>
                  </div>
                )}
                
                <div ref={messagesEndRef} />
              </div>

              {/* Input */}
              <div className="p-4 border-t bg-white rounded-b-xl flex-shrink-0">
                <div className="flex items-center space-x-2">
                  <input
                    ref={inputRef}
                    type="text"
                    value={inputMessage}
                    onChange={(e) => setInputMessage(e.target.value)}
                    onKeyPress={handleKeyPress}
                    placeholder="Nháº­p tin nháº¯n..."
                    className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                    disabled={isLoading}
                  />
                  <button
                    onClick={sendMessage}
                    disabled={!inputMessage.trim() || isLoading}
                    className="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 disabled:bg-gray-300 transition-colors flex-shrink-0"
                  >
                    <Send size={16} />
                  </button>
                </div>
                
                {/* Quick actions */}
                {messages.length === 0 && (
                  <div className="mt-3 flex flex-wrap gap-2">
                    <button
                      onClick={() => handleSuggestedAction('search_phones')}
                      className="text-xs bg-gray-100 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-200 transition-colors"
                    >
                      ğŸ“± Äiá»‡n thoáº¡i
                    </button>
                    <button
                      onClick={() => handleSuggestedAction('search_laptops')}
                      className="text-xs bg-gray-100 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-200 transition-colors"
                    >
                      ğŸ’» Laptop
                    </button>
                    <button
                      onClick={() => handleSuggestedAction('view_promotions')}
                      className="text-xs bg-gray-100 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-200 transition-colors"
                    >
                      ğŸ‰ Khuyáº¿n mÃ£i
                    </button>
                  </div>
                )}
                
                <div className="text-xs text-gray-400 mt-2 text-center">
                  Powered by SHN-Gear AI
                </div>
              </div>
            </>
          )}
        </div>
      )}
    </>
  );
};

export default ChatWidget;

```

### ClientApp\src\components\Checkout\Checkout.jsx
```jsx
import React, { useEffect, useState } from "react";
import {
  Box,
  Typography,
  TextField,
  Button,
  List,
  ListItem,
  ListItemText,
  ListItemAvatar,
  Avatar,
  Radio,
  RadioGroup,
  FormControlLabel,
  CircularProgress,
  Divider,
  Alert,
} from "@mui/material";
import { useLocation, useNavigate } from "react-router-dom";
import axios from "axios";
import { jwtDecode } from "jwt-decode";

const Checkout = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const {
    selectedItems = [],
    totalAmount = 0,
    voucherCode = "",
    discountAmount = 0,
  } = location.state || {};

  const [userId, setUserId] = useState(null);
  const [addresses, setAddresses] = useState([]);
  const [selectedAddress, setSelectedAddress] = useState(null);
  const [guestAddress, setGuestAddress] = useState({
    fullName: "",
    phoneNumber: "",
    addressLine1: "",
    addressLine2: "",
    city: "",
    state: "",
    zipCode: "",
    country: "",
  });
  const [voucherId, setVoucherId] = useState(null);
  const [paymentMethod, setPaymentMethod] = useState("1"); // 1 = Tiá»n máº·t, 2 = MoMo, 3 = PayPal
  const [momoPaymentType, setMomoPaymentType] = useState("qr");
  const [isLoading, setIsLoading] = useState(false);
  const [paymentMethods, setPaymentMethods] = useState([]);
  const [error, setError] = useState(null);
  const [finalAmount, setFinalAmount] = useState(totalAmount);

  useEffect(() => {
    const token = localStorage.getItem("token");
    if (token) {
      try {
        const decoded = jwtDecode(token);
        const id = parseInt(decoded.sub, 10);
        if (!Number.isInteger(id)) return;
        setUserId(id);
        fetchAddresses(id);
      } catch (error) {
        console.error("Lá»—i khi giáº£i mÃ£ token:", error);
      }
    }

    if (voucherCode) {
      fetchVoucherId(voucherCode);
    }

    fetchPaymentMethods();
  }, [voucherCode]);

  const fetchAddresses = async (userId) => {
    try {
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/address/user/${userId}`
      );
      setAddresses(response.data);
      if (response.data.length > 0) {
        setSelectedAddress(response.data[0]);
      }
    } catch (error) {
      console.error("Lá»—i khi láº¥y Ä‘á»‹a chá»‰:", error);
      setError("Lá»—i khi táº£i Ä‘á»‹a chá»‰ giao hÃ ng");
    }
  };

  const fetchVoucherId = async (code) => {
    try {
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/vouchers/code/${code}`
      );
      setVoucherId(response.data.id);
    } catch (error) {
      console.error("Lá»—i khi láº¥y voucher:", error);
      setError("MÃ£ giáº£m giÃ¡ khÃ´ng há»£p lá»‡ hoáº·c Ä‘Ã£ háº¿t háº¡n");
    }
  };

  const fetchPaymentMethods = async () => {
    try {
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/PaymentMethod`
      );
      setPaymentMethods(response.data);
    } catch (error) {
      console.error("Lá»—i khi láº¥y phÆ°Æ¡ng thá»©c thanh toÃ¡n:", error);
      setError("Lá»—i khi táº£i phÆ°Æ¡ng thá»©c thanh toÃ¡n");
    }
  };

  const removePaidItemsFromCart = async () => {
    if (!userId) return;

    try {
      await axios.delete(
        `${process.env.REACT_APP_API_BASE_URL}/api/cart/remove-paid-items?userId=${userId}`
      );
    } catch (error) {
      console.error("Lá»—i khi xÃ³a sáº£n pháº©m Ä‘Ã£ thanh toÃ¡n:", error);
    }
  };

  const removeGuestCartItems = () => {
    const sessionCart = sessionStorage.getItem("Cart");
    if (!sessionCart) return;

    const cartItems = JSON.parse(sessionCart) || [];
    const paidProductVariantIds = selectedItems.map(
      (item) => item.productVariantId
    );
    const remainingItems = cartItems.filter(
      (item) => !paidProductVariantIds.includes(item.productVariantId)
    );

    sessionStorage.setItem("Cart", JSON.stringify(remainingItems));
  };
  const handlePlaceOrder = async () => {
    setError(null);

    // Xá»­ lÃ½ giá» hÃ ng cho cáº£ khÃ¡ch vÃ  ngÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p
    if (!userId) {
      removeGuestCartItems();
    } else {
      await removePaidItemsFromCart();
    }

    if (userId && !selectedAddress) {
      setError("Vui lÃ²ng chá»n Ä‘á»‹a chá»‰ giao hÃ ng.");
      return;
    }

    let addressId = selectedAddress ? selectedAddress.id : null;

    if (!userId && !addressId) {
      if (
        !guestAddress.fullName ||
        !guestAddress.phoneNumber ||
        !guestAddress.addressLine1 ||
        !guestAddress.city ||
        !guestAddress.state ||
        !guestAddress.country
      ) {
        setError("Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin Ä‘á»‹a chá»‰ giao hÃ ng.");
        return;
      }

      try {
        setIsLoading(true);
        const response = await axios.post(
          `${process.env.REACT_APP_API_BASE_URL}/api/address/add`,
          {
            userId: null,
            ...guestAddress,
          }
        );
        addressId = response.data.addressId;
      } catch (error) {
        console.error("Lá»—i khi thÃªm Ä‘á»‹a chá»‰:", error);
        setError("Lá»—i khi thÃªm Ä‘á»‹a chá»‰, vui lÃ²ng thá»­ láº¡i.");
        setIsLoading(false);
        return;
      }
    }

    const orderDto = {
      userId: userId || null,
      orderDate: new Date().toISOString(),
      totalAmount: finalAmount,
      orderStatus: "Pending",
      addressId: addressId,
      paymentMethodId: parseInt(paymentMethod),
      orderItems: selectedItems.map((item) => ({
        productVariantId: item.productVariantId,
        quantity: item.quantity,
        price: item.productDiscountPrice || item.productPrice,
      })),
      voucherId: voucherId || null,
    };

    try {
      setIsLoading(true);

      const headers = { "Content-Type": "application/json" };

      if (paymentMethod === "2" && momoPaymentType === "card") {
        headers["Payment-Method"] = "card";
      }

      // Handle PayPal payment
      if (paymentMethod === "3") {
        const response = await axios.post(
          `${process.env.REACT_APP_API_BASE_URL}/api/paypal/create-order`,
          orderDto,
          { headers }
        );

        if (response.data.approvalUrl) {
          // LÆ°u thÃ´ng tin Ä‘Æ¡n hÃ ng Ä‘á»ƒ sá»­ dá»¥ng sau khi thanh toÃ¡n thÃ nh cÃ´ng
          localStorage.setItem(
            "currentOrder",
            JSON.stringify({
              orderId: response.data.orderId,
              paymentMethod: paymentMethod,
              orderItems: selectedItems,
              totalAmount: totalAmount,
              discountAmount: discountAmount,
              voucherCode: voucherCode,
              finalAmount: finalAmount,
              paymentMethodName: "PayPal",
            })
          );
          window.location.href = response.data.approvalUrl;
          return;
        }
      }

      // Handle MoMo payment
      else if (paymentMethod === "2") {
        const response = await axios.post(
          `${process.env.REACT_APP_API_BASE_URL}/api/orders`,
          orderDto,
          { headers }
        );

        if (response.data.paymentUrl) {
          localStorage.setItem(
            "currentOrder",
            JSON.stringify({
              orderId: response.data.orderId,
              paymentMethod: paymentMethod,
              orderItems: selectedItems,
              totalAmount: totalAmount,
              discountAmount: discountAmount,
              voucherCode: voucherCode,
              finalAmount: finalAmount,
              paymentMethodName:
                momoPaymentType === "card"
                  ? "MoMo - Tháº» Visa/MasterCard"
                  : "MoMo - QR Code",
            })
          );

          window.location.href = response.data.paymentUrl;
          return;
        }
      }
      // Handle cash payment
      else {
        const response = await axios.post(
          `${process.env.REACT_APP_API_BASE_URL}/api/orders`,
          orderDto,
          { headers }
        );
        navigate("/payment-success", {
          state: {
            orderId: response.data.orderId,
            orderItems: selectedItems,
            totalAmount: totalAmount,
            discountAmount: discountAmount,
            voucherCode: voucherCode,
            finalAmount: finalAmount,
            paymentMethodName:
              paymentMethods.find((pm) => pm.id.toString() === paymentMethod)
                ?.name || "Tiá»n máº·t",
          },
        });
      }
    } catch (error) {
      console.error("Lá»—i khi táº¡o Ä‘Æ¡n hÃ ng:", error);
      setError(
        error.response?.data?.message ||
          "Lá»—i khi táº¡o Ä‘Æ¡n hÃ ng, vui lÃ²ng thá»­ láº¡i."
      );
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Box sx={{ p: 4, maxWidth: 1200, margin: "0 auto" }}>
      <Typography variant="h4" mb={4} sx={{ fontWeight: "bold" }}>
        Thanh toÃ¡n
      </Typography>

      {error && (
        <Alert severity="error" sx={{ mb: 3 }}>
          {error}
        </Alert>
      )}

      <Box sx={{ display: "flex", gap: 4 }}>
        <Box sx={{ flex: 2 }}>
          <Box
            sx={{ mb: 4, p: 3, border: "1px solid #e0e0e0", borderRadius: 2 }}
          >
            <Typography variant="h6" sx={{ mb: 2, fontWeight: "bold" }}>
              ThÃ´ng tin giao hÃ ng
            </Typography>

            {userId ? (
              <>
                <Typography variant="subtitle1" sx={{ mb: 2 }}>
                  Chá»n Ä‘á»‹a chá»‰ giao hÃ ng
                </Typography>
                <RadioGroup
                  value={selectedAddress?.id || ""}
                  onChange={(e) => {
                    const address = addresses.find(
                      (a) => a.id === parseInt(e.target.value)
                    );
                    setSelectedAddress(address);
                  }}
                >
                  {addresses.map((address) => (
                    <Box
                      key={address.id}
                      sx={{
                        mb: 2,
                        p: 2,
                        border: "1px solid #e0e0e0",
                        borderRadius: 1,
                      }}
                    >
                      <FormControlLabel
                        value={address.id.toString()}
                        control={<Radio />}
                        label={
                          <Box>
                            <Typography>
                              <strong>{address.fullName}</strong> -{" "}
                              {address.phoneNumber}
                            </Typography>
                            <Typography variant="body2">
                              {address.addressLine1},{" "}
                              {address.addressLine2 &&
                                `${address.addressLine2}, `}
                              {address.city}, {address.state}, {address.country}
                            </Typography>
                          </Box>
                        }
                      />
                    </Box>
                  ))}
                </RadioGroup>
              </>
            ) : (
              <>
                <TextField
                  label="Há» vÃ  tÃªn"
                  variant="outlined"
                  fullWidth
                  required
                  value={guestAddress.fullName}
                  onChange={(e) =>
                    setGuestAddress({
                      ...guestAddress,
                      fullName: e.target.value,
                    })
                  }
                  sx={{ mb: 2 }}
                />
                <TextField
                  label="Sá»‘ Ä‘iá»‡n thoáº¡i"
                  variant="outlined"
                  fullWidth
                  required
                  value={guestAddress.phoneNumber}
                  onChange={(e) =>
                    setGuestAddress({
                      ...guestAddress,
                      phoneNumber: e.target.value,
                    })
                  }
                  sx={{ mb: 2 }}
                />
                <TextField
                  label="Äá»‹a chá»‰"
                  variant="outlined"
                  fullWidth
                  required
                  value={guestAddress.addressLine1}
                  onChange={(e) =>
                    setGuestAddress({
                      ...guestAddress,
                      addressLine1: e.target.value,
                    })
                  }
                  sx={{ mb: 2 }}
                />
                <TextField
                  label="Äá»‹a chá»‰ bá»• sung (tÃ¹y chá»n)"
                  variant="outlined"
                  fullWidth
                  value={guestAddress.addressLine2}
                  onChange={(e) =>
                    setGuestAddress({
                      ...guestAddress,
                      addressLine2: e.target.value,
                    })
                  }
                  sx={{ mb: 2 }}
                />
                <Box sx={{ display: "flex", gap: 2 }}>
                  <TextField
                    label="ThÃ nh phá»‘"
                    variant="outlined"
                    fullWidth
                    required
                    value={guestAddress.city}
                    onChange={(e) =>
                      setGuestAddress({ ...guestAddress, city: e.target.value })
                    }
                    sx={{ mb: 2 }}
                  />
                  <TextField
                    label="Tá»‰nh/ThÃ nh"
                    variant="outlined"
                    fullWidth
                    required
                    value={guestAddress.state}
                    onChange={(e) =>
                      setGuestAddress({
                        ...guestAddress,
                        state: e.target.value,
                      })
                    }
                    sx={{ mb: 2 }}
                  />
                </Box>
                <Box sx={{ display: "flex", gap: 2 }}>
                  <TextField
                    label="MÃ£ bÆ°u Ä‘iá»‡n"
                    variant="outlined"
                    fullWidth
                    value={guestAddress.zipCode}
                    onChange={(e) =>
                      setGuestAddress({
                        ...guestAddress,
                        zipCode: e.target.value,
                      })
                    }
                    sx={{ mb: 2 }}
                  />
                  <TextField
                    label="Quá»‘c gia"
                    variant="outlined"
                    fullWidth
                    required
                    value={guestAddress.country}
                    onChange={(e) =>
                      setGuestAddress({
                        ...guestAddress,
                        country: e.target.value,
                      })
                    }
                    sx={{ mb: 2 }}
                  />
                </Box>
              </>
            )}
          </Box>

          <Box
            sx={{ mb: 4, p: 3, border: "1px solid #e0e0e0", borderRadius: 2 }}
          >
            <Typography variant="h6" sx={{ mb: 2, fontWeight: "bold" }}>
              PhÆ°Æ¡ng thá»©c thanh toÃ¡n
            </Typography>
            <RadioGroup
              value={paymentMethod}
              onChange={(e) => setPaymentMethod(e.target.value)}
            >
              {paymentMethods.map((method) => (
                <Box
                  key={method.id}
                  sx={{
                    mb: 1,
                    p: 2,
                    border: "1px solid #e0e0e0",
                    borderRadius: 1,
                  }}
                >
                  <FormControlLabel
                    value={method.id.toString()}
                    control={<Radio />}
                    label={<Typography>{method.name}</Typography>}
                    sx={{ marginLeft: 0 }}
                  />

                  {method.id === 2 && paymentMethod === "2" && (
                    <Box sx={{ mt: 1, pl: 4 }}>
                      <RadioGroup
                        value={momoPaymentType}
                        onChange={(e) => setMomoPaymentType(e.target.value)}
                        row
                      >
                        <FormControlLabel
                          value="qr"
                          control={<Radio size="small" />}
                          label="QuÃ©t QR Code"
                        />
                        <FormControlLabel
                          value="card"
                          control={<Radio size="small" />}
                          label="Tháº» Visa/MasterCard"
                        />
                      </RadioGroup>
                    </Box>
                  )}
                </Box>
              ))}
            </RadioGroup>

            {paymentMethod === "2" && (
              <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
                {momoPaymentType === "card"
                  ? "Báº¡n sáº½ Ä‘Æ°á»£c chuyá»ƒn hÆ°á»›ng Ä‘áº¿n trang thanh toÃ¡n báº±ng tháº» Visa/MasterCard"
                  : "Báº¡n sáº½ Ä‘Æ°á»£c chuyá»ƒn hÆ°á»›ng Ä‘áº¿n trang thanh toÃ¡n QR MoMo"}
              </Typography>
            )}

            {paymentMethod === "3" && (
              <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
                Báº¡n sáº½ Ä‘Æ°á»£c chuyá»ƒn hÆ°á»›ng Ä‘áº¿n trang thanh toÃ¡n PayPal
              </Typography>
            )}
          </Box>
        </Box>

        <Box sx={{ flex: 1 }}>
          <Box sx={{ p: 3, border: "1px solid #e0e0e0", borderRadius: 2 }}>
            <Typography variant="h6" sx={{ mb: 2, fontWeight: "bold" }}>
              ÄÆ¡n hÃ ng cá»§a báº¡n
            </Typography>

            <List sx={{ mb: 2 }}>
              {selectedItems.map((item) => (
                <ListItem key={item.productVariantId} sx={{ px: 0 }}>
                  <ListItemAvatar>
                    <img
                      src={
                        item.productImage.startsWith("http")
                          ? item.productImage
                          : `${process.env.REACT_APP_API_BASE_URL}/${item.productImage}`
                      }
                      alt="Product img"
                      className="size-10"
                      onError={(e) => {
                        e.target.onerror = null;
                        e.target.src = "https://via.placeholder.com/50";
                      }}
                    />
                  </ListItemAvatar>
                  <ListItemText
                    primary={`${item.productName}`}
                    secondary={`${item.variantColor} - ${item.variantStorage}`}
                  />
                  <Typography variant="body2">
                    {item.quantity} Ã—{" "}
                    {(
                      item.productDiscountPrice || item.productPrice
                    ).toLocaleString()}
                    â‚«
                  </Typography>
                </ListItem>
              ))}
            </List>

            <Divider sx={{ my: 2 }} />

            {voucherCode && (
              <Box sx={{ mb: 2 }}>
                <Typography variant="body1">
                  MÃ£ giáº£m giÃ¡: {voucherCode}
                </Typography>
                <Typography variant="body1" color="success.main">
                  -{discountAmount.toLocaleString()}â‚«
                </Typography>
              </Box>
            )}

            <Box sx={{ mb: 2 }}>
              <Box
                sx={{ display: "flex", justifyContent: "space-between", mb: 1 }}
              >
                <Typography>Táº¡m tÃ­nh:</Typography>
                <Typography>
                  {(totalAmount + discountAmount).toLocaleString()}â‚«
                </Typography>
              </Box>
              {discountAmount > 0 && (
                <Box
                  sx={{
                    display: "flex",
                    justifyContent: "space-between",
                    mb: 1,
                  }}
                >
                  <Typography>Giáº£m giÃ¡:</Typography>
                  <Typography color="success.main">
                    -{discountAmount.toLocaleString()}â‚«
                  </Typography>
                </Box>
              )}
              <Divider sx={{ my: 1 }} />
              <Box
                sx={{ display: "flex", justifyContent: "space-between", mb: 1 }}
              >
                <Typography variant="h6">Tá»•ng cá»™ng:</Typography>
                <Typography variant="h6" color="error">
                  {totalAmount.toLocaleString()}â‚«
                </Typography>
              </Box>
            </Box>

            <Button
              variant="contained"
              color="error"
              fullWidth
              size="large"
              onClick={handlePlaceOrder}
              disabled={isLoading || selectedItems.length === 0}
              sx={{ mt: 2 }}
            >
              {isLoading ? (
                <CircularProgress size={24} color="inherit" />
              ) : paymentMethod === "2" ? (
                momoPaymentType === "card" ? (
                  "Thanh toÃ¡n báº±ng tháº» Visa/MasterCard"
                ) : (
                  "Thanh toÃ¡n báº±ng QR MoMo"
                )
              ) : paymentMethod === "3" ? (
                "Thanh toÃ¡n báº±ng PayPal"
              ) : (
                "Thanh toÃ¡n vá»›i Tiá»n Máº·t"
              )}
            </Button>
          </Box>
        </Box>
      </Box>
    </Box>
  );
};

export default Checkout;

```

### ClientApp\src\components\Commitment\Commitment.js
```js
import React from 'react';
import { useBrands } from '@/hooks/api/useBrands';

const BrandTrustSection = ({ data }) => {
  // Fetch brands from API
  const { brands, loading, error } = useBrands(true);

  return (
    <section className="py-16 md:py-24 bg-gray-900/50">
      <div className="container mx-auto px-4">
        {/* Brand Logos */}
        <div className="flex justify-center items-center flex-wrap gap-x-12 gap-y-8 mb-16">
          {loading ? (
            <div className="text-white">Äang táº£i thÆ°Æ¡ng hiá»‡u...</div>
          ) : error ? (
            <div className="text-red-500">{error}</div>
          ) : (
            brands.map((brand) => (
              <div key={brand.id} className="flex-shrink-0">
                <img 
                  src={brand.logo || '/placeholder-logo.png'} 
                  alt={brand.name} 
                  className="h-12 md:h-16 object-contain filter grayscale hover:filter-none transition-all duration-300"
                  onError={(e) => {
                    e.target.style.display = 'none';
                  }}
                />
              </div>
            ))
          )}
        </div>

        {/* Commitments */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
          {(data?.commitments || []).map((commitment) => (
            <div key={commitment.id} className="p-4">
              {/* You can use a proper icon library here */}
              <div className="flex items-center justify-center h-16 w-16 mx-auto mb-4 bg-white/5 rounded-full border border-white-20">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-electric-blue h-6 w-6"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
              </div>
              <h3 className="font-display text-xl font-bold text-white">{commitment.title}</h3>
              <p className="text-light-gray mt-1">{commitment.description}</p>
            </div>
          ))}
        </div>
      </div>
    </section>
  );
};

export default BrandTrustSection;

```

### ClientApp\src\components\Commitment\Commitment.jsx
```jsx
import React from "react";

const policies = [
  {
    icon: "https://fptshop.com.vn/img/icons/policy3.svg?w=128&q=100",
    title: "ThÆ°Æ¡ng hiá»‡u Ä‘áº£m báº£o",
    description: "Nháº­p kháº©u, báº£o hÃ nh chÃ­nh hÃ£ng",
  },
  {
    icon: "https://fptshop.com.vn/img/icons/policy1.svg?w=128&q=100",
    title: "Äá»•i tráº£ dá»… dÃ ng",
    description: "Theo chÃ­nh sÃ¡ch Ä‘á»•i tráº£ táº¡i SHN Gear",
  },
  {
    icon: "https://fptshop.com.vn/img/icons/policy4.svg?w=128&q=100",
    title: "Sáº£n pháº©m cháº¥t lÆ°á»£ng",
    description: "Äáº£m báº£o tÆ°Æ¡ng thÃ­ch vÃ  Ä‘á»™ bá»n cao",
  },
  {
    icon: "https://fptshop.com.vn/img/icons/policy2.svg?w=128&q=100",
    title: "Giao hÃ ng táº­n nÆ¡i",
    description: "Táº¡i 63 tá»‰nh thÃ nh",
  },
];

const Commitment = () => {
  return (
    <div className="bg-gray-50 py-10 px-4 sm:px-6 lg:px-8">
      <div className="max-w-7xl mx-auto">
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          {policies.map((policy, index) => (
            <div 
              key={index}
              className="bg-white rounded-lg shadow-sm p-4 flex items-start sm:items-center space-x-3 sm:space-x-4"
            >
              <img 
                src={policy.icon} 
                alt={policy.title} 
                className="w-10 h-10 sm:w-12 sm:h-12 flex-shrink-0"
              />
              <div className="flex-1">
                <h3 className="font-bold text-sm sm:text-base mb-1 text-gray-800">
                  {policy.title}
                </h3>
                <p className="text-xs sm:text-sm text-gray-600">
                  {policy.description}
                </p>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

export default Commitment;
```

### ClientApp\src\components\CompareProduct\CompareModal.jsx
```jsx
import React, { useState, useEffect, useCallback, useMemo } from "react";
import { X, ShoppingCart, Eye, Star, Zap, CheckCircle2, AlertCircle } from "lucide-react";
import SpecificationComparison from "./SpecificationComparison";
import "./CompareModal.css";

const CompareModal = ({ isOpen, onClose }) => {
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  // Memoized API base URL
  const apiBaseUrl = useMemo(() => process.env.REACT_APP_API_BASE_URL, []);

  // Optimized fetchCompareProducts with useCallback
  const fetchCompareProducts = useCallback(async () => {
    const ids = JSON.parse(localStorage.getItem("compareList") || "[]");
    
    if (ids.length === 0) {
      setProducts([]);
      return;
    }

    setLoading(true);
    setError(null);
    
    try {
      const response = await fetch(`${apiBaseUrl}/api/Products/compare`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(ids),
      });

      if (!response.ok) {
        throw new Error(`KhÃ´ng thá»ƒ láº¥y dá»¯ liá»‡u so sÃ¡nh: ${response.status}`);
      }
      
      const data = await response.json();
      setProducts(data);
    } catch (error) {
      console.error("Lá»—i khi táº£i dá»¯ liá»‡u so sÃ¡nh:", error);
      setError(error.message);
    } finally {
      setLoading(false);
    }
  }, [apiBaseUrl]);

  // Optimized removeFromCompare
  const removeFromCompare = useCallback((productId) => {
    const currentList = JSON.parse(localStorage.getItem("compareList") || "[]");
    const updatedList = currentList.filter((id) => id !== productId);
    localStorage.setItem("compareList", JSON.stringify(updatedList));
    
    // Trigger custom event
    window.dispatchEvent(new Event('compareListChanged'));
    
    // Update products immediately for better UX
    setProducts(prev => prev.filter(p => p.id !== productId));
  }, []);

  // Optimized clearAll
  const clearAll = useCallback(() => {
    localStorage.removeItem("compareList");
    window.dispatchEvent(new Event('compareListChanged'));
    setProducts([]);
    onClose();
  }, [onClose]);

  // Optimized close handler
  const handleBackgroundClick = useCallback((e) => {
    if (e.target === e.currentTarget) {
      onClose();
    }
  }, [onClose]);

  // Effect to fetch data when modal opens
  useEffect(() => {
    if (isOpen) {
      fetchCompareProducts();
    }
  }, [isOpen, fetchCompareProducts]);

  // Loading spinner component
  const LoadingSpinner = () => (
    <div className="flex flex-col items-center justify-center py-16">
      <div className="relative">
        <div className="w-16 h-16 border-4 border-indigo-200 rounded-full animate-spin"></div>
        <div className="absolute top-0 left-0 w-16 h-16 border-4 border-transparent border-t-indigo-600 rounded-full animate-spin"></div>
      </div>
      <p className="mt-4 text-gray-600 font-medium">Äang táº£i dá»¯ liá»‡u so sÃ¡nh...</p>
    </div>
  );

  // Error component
  const ErrorDisplay = () => (
    <div className="text-center py-16">
      <div className="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
        <AlertCircle className="w-8 h-8 text-red-600" />
      </div>
      <h3 className="text-xl font-bold text-gray-900 mb-2">CÃ³ lá»—i xáº£y ra</h3>
      <p className="text-gray-600 mb-6">{error}</p>
      <button
        onClick={fetchCompareProducts}
        className="inline-flex items-center px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl"
      >
        <Zap className="w-4 h-4 mr-2" />
        Thá»­ láº¡i
      </button>
    </div>
  );

  // Empty state component
  const EmptyState = () => (
    <div className="text-center py-16">
      <div className="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-2xl flex items-center justify-center">
        <ShoppingCart className="w-12 h-12 text-indigo-600" />
      </div>
      <h3 className="text-2xl font-bold text-gray-900 mb-3">
        ChÆ°a cÃ³ sáº£n pháº©m nÃ o Ä‘á»ƒ so sÃ¡nh
      </h3>
      <p className="text-gray-600 text-lg">
        ThÃªm Ã­t nháº¥t 2 sáº£n pháº©m vÃ o danh sÃ¡ch Ä‘á»ƒ báº¯t Ä‘áº§u so sÃ¡nh
      </p>
    </div>
  );

  if (!isOpen) return null;
  return (    <div 
      className={`fixed inset-0 bg-black/60 backdrop-blur-sm z-[9999] flex items-center justify-center p-4 transition-all duration-300 compare-modal-container ${
        isOpen ? 'animate-fadeIn' : 'opacity-0 pointer-events-none'
      }`}
      onClick={handleBackgroundClick}
    ><div className={`bg-white rounded-2xl shadow-2xl w-full max-h-[95vh] overflow-hidden transform transition-all duration-300 ${
        products.length <= 2 ? 'max-w-5xl' : 
        products.length === 3 ? 'max-w-6xl' : 
        'max-w-7xl'
      } ${
        isOpen ? 'animate-scaleIn' : 'scale-95 opacity-0'
      }`}>
        {/* Enhanced Modern Header */}
        <div className="relative bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 text-white overflow-hidden">
          {/* Animated background pattern */}
          <div className="absolute inset-0 bg-black/10">
            <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent transform -skew-x-12 animate-float"></div>
          </div>
          
          <div className="relative p-6 flex justify-between items-center backdrop-blur-custom">
            <div className="flex items-center space-x-4">
              <div className="p-3 bg-white/20 rounded-xl backdrop-blur-sm shadow-glow animate-bounceIn">
                <ShoppingCart className="w-8 h-8" />
              </div>
              <div>
                <h2 className="text-2xl font-bold text-gradient">So sÃ¡nh sáº£n pháº©m</h2>
                <p className="text-white/80 text-sm mt-1 flex items-center animate-slideUp">
                  <span className="inline-block w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse shadow-glow"></span>
                  {products.length} sáº£n pháº©m Ä‘ang Ä‘Æ°á»£c so sÃ¡nh
                </p>
              </div>
            </div>
            
            <div className="flex items-center gap-3">
              {products.length > 0 && (
                <button
                  onClick={clearAll}
                  className="group flex items-center gap-2 bg-red-500/90 hover:bg-red-600 backdrop-blur-sm px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 hover:scale-105 hover:shadow-lg"
                >
                  <svg className="w-4 h-4 group-hover:rotate-12 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                  XÃ³a táº¥t cáº£
                </button>
              )}
              <button
                onClick={onClose}
                className="group p-2.5 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-xl transition-all duration-200 hover:scale-110 hover:rotate-90"
              >
                <X className="w-6 h-6" />
              </button>
            </div>
          </div>
        </div>

        {/* Content */}
        <div className="p-6 overflow-y-auto max-h-[calc(95vh-120px)] bg-gradient-to-br from-gray-50 to-white">
          {loading ? (
            <LoadingSpinner />
          ) : error ? (
            <ErrorDisplay />
          ) : products.length === 0 ? (
            <EmptyState />          ) : (            <div className="overflow-x-auto">
              <div className={`grid gap-6 pb-4 compare-product-grid ${
                products.length === 1 ? 'grid-cols-1 max-w-md mx-auto' :
                products.length === 2 ? 'grid-cols-1 lg:grid-cols-2' :
                products.length === 3 ? 'grid-cols-1 md:grid-cols-2 xl:grid-cols-3' :
                'grid-cols-1 md:grid-cols-2 xl:grid-cols-2 2xl:grid-cols-4'
              }`}>
                {products.map((product, index) => (                  <div 
                    key={product.id}
                    className="bg-white border border-gray-200 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 relative overflow-hidden group hover:-translate-y-1 compare-product-card"
                  >
                    {/* Product Badge */}
                    <div className="absolute top-4 left-4 z-20">
                      <div className="bg-gradient-to-r from-indigo-500 to-purple-600 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg flex items-center">
                        <Star className="w-3 h-3 mr-1 fill-current" />
                        #{index + 1}
                      </div>
                    </div>

                    {/* Remove button */}
                    <button
                      onClick={() => removeFromCompare(product.id)}
                      className="absolute top-4 right-4 z-20 bg-red-500/90 hover:bg-red-600 backdrop-blur-sm text-white p-2 rounded-full shadow-lg transition-all duration-200 hover:scale-110 group/btn"
                      aria-label="XÃ³a khá»i so sÃ¡nh"
                    >
                      <X className="w-4 h-4 group-hover/btn:rotate-90 transition-transform" />
                    </button>                    {/* Product Image */}
                    <div className="relative h-48 bg-gradient-to-br from-gray-50 to-gray-100 overflow-hidden">
                      <img
                        src={
                          product.images && product.images.length > 0
                            ? product.images[0].imageUrl?.startsWith("http")
                              ? product.images[0].imageUrl
                              : `${apiBaseUrl}/${product.images[0].imageUrl}`
                            : "https://via.placeholder.com/300"
                        }
                        alt={product.name}
                        className="w-full h-full object-contain p-4 group-hover:scale-110 transition-transform duration-500"
                        loading="lazy"
                        onError={(e) => {
                          e.target.onerror = null;
                          e.target.src = "https://via.placeholder.com/300";
                        }}
                      />
                      <div className="absolute inset-0 bg-gradient-to-t from-black/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    </div>                    {/* Product Info */}
                    <div className="p-4">
                      <h3 className="text-lg font-bold text-gray-900 mb-2 line-clamp-2 group-hover:text-indigo-600 transition-colors">
                        {product.name}
                      </h3>
                      
                      {/* Brand and Category */}
                      <div className="flex gap-2 mb-3">
                        <div className="flex-1 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-2 border border-indigo-100">
                          <p className="text-xs text-gray-600 mb-1">ThÆ°Æ¡ng hiá»‡u</p>
                          <p className="font-semibold text-indigo-700 text-sm">{product.brand}</p>
                        </div>
                        <div className="flex-1 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-2 border border-purple-100">
                          <p className="text-xs text-gray-600 mb-1">Danh má»¥c</p>
                          <p className="font-semibold text-purple-700 text-sm">{product.category}</p>
                        </div>
                      </div>

                      {/* Description */}
                      {product.description && (
                        <div className="mb-3 p-2 bg-gray-50 rounded-lg border border-gray-100">
                          <p className="text-xs text-gray-700 line-clamp-2">{product.description}</p>
                        </div>
                      )}{/* Variants */}
                      <div className="border-t border-gray-200 pt-4">
                        <h4 className="font-bold text-gray-900 mb-3 flex items-center">
                          <div className="w-2 h-2 bg-indigo-500 rounded-full mr-2"></div>
                          Biáº¿n thá»ƒ ({product.variants.length})
                        </h4>
                        <div className="space-y-2 max-h-32 overflow-y-auto">
                          {product.variants.slice(0, 2).map((variant, i) => (
                            <div key={i} className="bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg p-3 border border-gray-200 hover:shadow-sm transition-shadow">
                              <div className="flex justify-between items-start mb-2">
                                <div className="flex-1">
                                  <p className="font-semibold text-gray-900 text-sm">
                                    {variant.color} - {variant.storage}
                                  </p>
                                </div>
                                <div className="flex items-center ml-2">
                                  {variant.stockQuantity > 0 ? (
                                    <CheckCircle2 className="w-3 h-3 text-green-500 mr-1" />
                                  ) : (
                                    <AlertCircle className="w-3 h-3 text-red-500 mr-1" />
                                  )}
                                  <span className={`text-xs font-medium px-2 py-0.5 rounded-full ${
                                    variant.stockQuantity > 10 
                                      ? 'bg-green-100 text-green-800' 
                                      : variant.stockQuantity > 0 
                                      ? 'bg-yellow-100 text-yellow-800'
                                      : 'bg-red-100 text-red-800'
                                  }`}>
                                    {variant.stockQuantity > 0 ? `${variant.stockQuantity}` : 'Háº¿t'}
                                  </span>
                                </div>
                              </div>
                              <div className="flex items-center justify-between">
                                {variant.discountPrice ? (
                                  <div className="flex items-center gap-1 flex-1">
                                    <span className="text-sm font-bold text-red-600">
                                      {variant.discountPrice.toLocaleString()}Ä‘
                                    </span>
                                    <span className="text-xs text-gray-500 line-through">
                                      {variant.price.toLocaleString()}Ä‘
                                    </span>
                                  </div>
                                ) : (
                                  <span className="text-sm font-bold text-gray-900 flex-1">
                                    {variant.price.toLocaleString()}Ä‘
                                  </span>
                                )}
                                
                                {/* Add to Cart Button for Variant */}
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    alert(`ÄÃ£ thÃªm "${product.name} - ${variant.color} ${variant.storage}" vÃ o giá» hÃ ng!`);
                                  }}
                                  className="ml-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-2 py-1 rounded-md text-xs font-semibold transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                  disabled={variant.stockQuantity === 0}
                                  title={variant.stockQuantity === 0 ? "Háº¿t hÃ ng" : "ThÃªm vÃ o giá» hÃ ng"}
                                >
                                  <ShoppingCart className="w-3 h-3" />
                                </button>
                              </div>
                            </div>
                          ))}
                          {product.variants.length > 2 && (
                            <div className="text-center py-1">
                              <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
                                +{product.variants.length - 2} biáº¿n thá»ƒ khÃ¡c
                              </span>
                            </div>
                          )}
                        </div>
                      </div>                      {/* Action buttons */}
                      <div className="mt-4 pt-3 border-t border-gray-200">
                        <button
                          onClick={() => window.location.href = `/product/${product.id}`}
                          className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white py-2.5 px-4 rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 hover:shadow-lg flex items-center justify-center group"
                        >
                          <Eye className="w-4 h-4 mr-2 group-hover:scale-110 transition-transform" />
                          Xem chi tiáº¿t
                        </button>
                      </div>
                    </div>

                    {/* Hover overlay */}
                    <div className="absolute inset-0 bg-gradient-to-br from-indigo-500/5 via-purple-500/5 to-pink-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none rounded-2xl"></div>
                  </div>
                ))}
              </div>

              {/* Specification Comparison Table */}
              <SpecificationComparison products={products} />
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default CompareModal;

```

### ClientApp\src\components\CompareProduct\ComparePage.jsx
```jsx
import React, { useState, useEffect } from "react";
import Navbar from "../Navbar/Navbar";
import Footer from "../Footer/Footer";

const ComparePage = () => {
  const [products, setProducts] = useState([]);

  // Load danh sÃ¡ch sáº£n pháº©m cáº§n so sÃ¡nh
  const fetchCompareProducts = () => {
    const ids = JSON.parse(localStorage.getItem("compareList") || "[]");
    if (ids.length < 2) {
      setProducts([]);
      return;
    }

    fetch(`${process.env.REACT_APP_API_BASE_URL}/api/Products/compare`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(ids),
    })
      .then((res) => {
        if (!res.ok) throw new Error("KhÃ´ng thá»ƒ láº¥y dá»¯ liá»‡u so sÃ¡nh");
        return res.json();
      })
      .then((data) => {
        setProducts(data);
      })
      .catch((error) => {
        console.error("Lá»—i khi táº£i dá»¯ liá»‡u so sÃ¡nh:", error);
      });
  };

  useEffect(() => {
    fetchCompareProducts();
  }, []);

  // HÃ m xoÃ¡ sáº£n pháº©m khá»i localStorage vÃ  cáº­p nháº­t giao diá»‡n
  const removeFromCompare = (productId) => {
    const currentList = JSON.parse(localStorage.getItem("compareList") || "[]");
    const updatedList = currentList.filter((id) => id !== productId);
    localStorage.setItem("compareList", JSON.stringify(updatedList));
    fetchCompareProducts();
  };

    return (
    <>
      <Navbar />
      <div className="min-h-[600px] max-w-7xl mx-auto px-4 py-6">
        <h2 className="text-2xl font-bold text-center mb-6">So sÃ¡nh sáº£n pháº©m</h2>

        {products.length < 2 ? (
          <div className="text-center text-gray-500 text-lg mt-12">
            Vui lÃ²ng chá»n Ã­t nháº¥t 2 sáº£n pháº©m Ä‘á»ƒ so sÃ¡nh.
          </div>
        ) : (
          <div className="flex gap-6 overflow-x-auto pb-6">
            {products.map((product) => (
              <div
                key={product.id}
                className="min-w-[250px] border rounded-lg shadow p-4 bg-white relative"
              >
                <button
                  onClick={() => removeFromCompare(product.id)}
                  className="absolute top-2 right-2 text-sm bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600"
                >
                  X
                </button>

                <h3 className="text-lg font-semibold mb-2">{product.name}</h3>
                {/* <img
                  src={
                      product.image?.startsWith("http")
                      ? product.image // áº¢nh tá»« API (URL Ä‘áº§y Ä‘á»§)
                      : `${process.env.REACT_APP_API_BASE_URL}/${product.image}` // áº¢nh local tá»« wwwroot
                  }
                  alt={product.name}
                  className="w-full h-40 object-contain mb-3 hover:scale-110"
                  onError={(e) => { e.target.onerror = null; e.target.src = "https://via.placeholder.com/150"; }}
                /> */}
                <img
                  src={product.images?.[0]?.imageUrl?.startsWith("http") ? product.images[0].imageUrl : `${process.env.REACT_APP_API_BASE_URL}/${product.images?.[0]?.imageUrl}`}
                  alt={product.name || "product image"}
                  className="w-12 h-12 rounded-md object-cover border border-gray-600"
                  onError={(e) => { e.target.onerror = null; e.target.src = "https://via.placeholder.com/100?text=Error"; }}
                  />
                
                <p><strong>ThÆ°Æ¡ng hiá»‡u:</strong> {product.brand}</p>
                <p><strong>Danh má»¥c:</strong> {product.category}</p>
                <p className="text-sm mt-2">{product.description}</p>

                <h4 className="font-semibold mt-4">Biáº¿n thá»ƒ:</h4>
                {product.variants.map((variant, i) => (
                  <div key={i} className="mt-2 text-sm border-t pt-2">
                    <p>MÃ u: {variant.color} - Dung lÆ°á»£ng: {variant.storage}</p>
                    <p>GiÃ¡: {variant.price.toLocaleString()}Ä‘</p>
                    {variant.discountPrice && (
                      <p>GiÃ¡ KM: {variant.discountPrice.toLocaleString()}Ä‘</p>
                    )}
                    <p>CÃ²n láº¡i: {variant.stockQuantity} sáº£n pháº©m</p>
                  </div>
                ))}
              </div>
            ))}
          </div>
        )}
      </div>
      <Footer />
    </>
  );
};

export default ComparePage;
```

### ClientApp\src\components\CompareProduct\SpecificationComparison.jsx
```jsx
import React, { useState } from 'react';
import { Monitor, Cpu, MemoryStick, HardDrive, Battery, Camera, Weight } from 'lucide-react';
import SpecificationFilter from './SpecificationFilter';

const SpecificationComparison = ({ products }) => {
  // Chuáº©n hÃ³a specifications thÃ nh máº£ng (há»— trá»£ unified object tá»« API)
  const normalizedProducts = products.map(product => {
    let specs = [];
    if (product.specifications) {
      // Náº¿u lÃ  unified object (cÃ³ type/specifications)
      if (
        typeof product.specifications === 'object' &&
        product.specifications.type === 'unified' &&
        typeof product.specifications.specifications === 'object'
      ) {
        specs = Object.entries(product.specifications.specifications).map(([name, detail]) => ({
          name,
          value: detail.value,
          unit: detail.unit
        }));
      } else if (Array.isArray(product.specifications)) {
        specs = product.specifications;
      } else if (product.specifications.name && product.specifications.value !== undefined) {
        specs = [product.specifications];
      }
    }
    return { ...product, specifications: specs };
  });

  const [filters, setFilters] = useState({
    showBasicOnly: false,
    showDifferencesOnly: false,
    categoryFilter: 'all'
  });

  // Láº¥y táº¥t cáº£ key thÃ´ng sá»‘, há»— trá»£ lá»c chá»‰ sá»‘ cÆ¡ báº£n vÃ  khÃ¡c biá»‡t
  const getAllSpecKeys = () => {
    let allKeys = new Set();
    // Náº¿u lá»c chá»‰ sá»‘ cÆ¡ báº£n: láº¥y 3 displayOrder Ä‘áº§u tiÃªn cá»§a tá»«ng sáº£n pháº©m
    if (filters.showBasicOnly) {
      normalizedProducts.forEach(product => {
        if (Array.isArray(product.specifications)) {
          product.specifications
            .sort((a, b) => (a.displayOrder ?? 0) - (b.displayOrder ?? 0))
            .slice(0, 3)
            .forEach(spec => {
              if (spec.name) allKeys.add(spec.name.trim());
            });
        }
      });
    } else {
      normalizedProducts.forEach(product => {
        if (Array.isArray(product.specifications)) {
          product.specifications.forEach(spec => {
            if (spec.name) allKeys.add(spec.name.trim());
          });
        }
      });
    }
    // Náº¿u lá»c chá»‰ sá»‘ khÃ¡c biá»‡t: chá»‰ láº¥y cÃ¡c key cÃ³ giÃ¡ trá»‹ khÃ¡c nhau giá»¯a cÃ¡c sáº£n pháº©m
    if (filters.showDifferencesOnly) {
      allKeys = new Set(Array.from(allKeys).filter(key => hasSpecDifferences(key)));
    }
    return Array.from(allKeys);
  };

  // Kiá»ƒm tra thÃ´ng sá»‘ cÃ³ khÃ¡c biá»‡t khÃ´ng
  const hasSpecDifferences = (key) => {
    const values = normalizedProducts.map(p => {
      if (Array.isArray(p.specifications)) {
        const spec = p.specifications.find(s => s.name.trim().toLowerCase() === key.trim().toLowerCase());
        return spec ? spec.value : undefined;
      }
      return undefined;
    });
    return new Set(values).size > 1;
  };

  // Äá»‹nh dáº¡ng giÃ¡ trá»‹ thÃ´ng sá»‘
  const formatSpecValue = (key, value, unit) => {
    if (value === null || value === undefined) return 'N/A';
    if (typeof value === 'boolean') return value ? 'CÃ³' : 'KhÃ´ng';
    if (unit) return `${value} ${unit}`;
    return value.toString();
  };

  // Láº¥y icon cho tá»«ng thÃ´ng sá»‘
  const getSpecIcon = (key) => {
    const map = {
      ram: MemoryStick,
      cpu: Cpu,
      weight: Weight,
      battery: Battery,
      camera: Camera,
      storage: HardDrive,
      screen: Monitor,
    };
    // TÃ¬m icon phÃ¹ há»£p
    for (const k in map) {
      if (key.toLowerCase().includes(k)) return map[k];
    }
    return Monitor;
  };

  // Láº¥y tÃªn hiá»ƒn thá»‹
  const getSpecDisplayName = (key) => {
    const nameMap = {
      ram: 'RAM',
      cpu: 'CPU',
      weight: 'Trá»ng lÆ°á»£ng',
      battery: 'Pin',
      camera: 'Camera',
      storage: 'Bá»™ nhá»›',
      screen: 'MÃ n hÃ¬nh',
    };
    for (const k in nameMap) {
      if (key.toLowerCase().includes(k)) return nameMap[k];
    }
    return key;
  };

  const specKeys = getAllSpecKeys();

  return (
    <div className="mt-8">
      <SpecificationFilter products={products} onFilterChange={setFilters} />
      <div className="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-t-xl p-4 border border-gray-200">
        <h3 className="text-xl font-bold text-gray-900 flex items-center">
          <div className="w-2 h-2 bg-indigo-500 rounded-full mr-3"></div>
          So sÃ¡nh thÃ´ng sá»‘ ká»¹ thuáº­t
        </h3>
      </div>
      <div className="bg-white border border-t-0 border-gray-200 rounded-b-xl overflow-x-auto">
        <table className="w-full">
          <thead>
            <tr className="bg-gray-50 border-b border-gray-200">
              <th className="text-left p-4 font-semibold text-gray-700 min-w-[180px] sticky left-0 bg-gray-50 z-10">ThÃ´ng sá»‘</th>
              {normalizedProducts.map((product, idx) => (
                <th key={product.id} className="text-center p-4 font-semibold text-gray-700 min-w-[220px]">
                  <div className="flex flex-col items-center">
                    {product.image && <img src={product.image} alt={product.name} className="w-12 h-12 object-contain mb-2" />}
                    <span className="text-base font-medium">{product.name}</span>
                  </div>
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {specKeys.map((key, rowIdx) => {
              const Icon = getSpecIcon(key);
              const isDiff = hasSpecDifferences(key);
              return (
                <tr key={key} className={isDiff ? "bg-yellow-50" : rowIdx % 2 === 0 ? "bg-white" : "bg-gray-50"}>
                  <td className="p-4 font-medium text-gray-700 sticky left-0 bg-inherit z-10">
                    <div className="flex items-center">
                      <Icon className="w-4 h-4 text-indigo-500 mr-2" />
                      <span>{getSpecDisplayName(key)}</span>
                      {isDiff && <span className="ml-2 px-2 py-0.5 rounded bg-yellow-200 text-yellow-800 text-xs">KhÃ¡c biá»‡t</span>}
                    </div>
                  </td>
                  {normalizedProducts.map(product => {
                    let value = 'N/A', unit = '';
                    if (Array.isArray(product.specifications)) {
                      const spec = product.specifications.find(s => s.name.trim().toLowerCase() === key.trim().toLowerCase());
                      if (spec) { value = spec.value; unit = spec.unit; }
                    }
                    return (
                      <td key={product.id + key} className="p-4 text-center">
                        <span className={`inline-block px-3 py-1 rounded-full text-sm ${value === 'N/A' ? 'bg-gray-100 text-gray-400' : 'bg-indigo-50 text-indigo-700 font-semibold'}`}>
                          {formatSpecValue(key, value, unit)}
                        </span>
                      </td>
                    );
                  })}
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
      <div className="p-4 bg-gray-50 border-t border-gray-200 flex justify-center gap-8 text-xs text-gray-500">
        {normalizedProducts.map((product, idx) => (
          <div key={product.id} className="flex items-center">
            <div className={`w-2 h-2 rounded-full mr-1 ${idx === 0 ? 'bg-blue-500' : idx === 1 ? 'bg-green-500' : 'bg-orange-500'}`}></div>
            <span>{product.name}</span>
          </div>
        ))}
      </div>
    </div>
  );
};

export default SpecificationComparison;

```

### ClientApp\src\components\CompareProduct\SpecificationFilter.jsx
```jsx
import React, { useState } from 'react';
import { Filter, Smartphone, Laptop, Headphones, ChevronDown } from 'lucide-react';

const SpecificationFilter = ({ products, onFilterChange }) => {
  const [activeFilters, setActiveFilters] = useState({
    showBasicOnly: false,
    showDifferencesOnly: false,
    categoryFilter: 'all'
  });
  const [isExpanded, setIsExpanded] = useState(false);

  // Get available product categories
  const getCategories = () => {
    const categories = new Set();
    products.forEach(product => {
      if (product.specifications?.type) {
        categories.add(product.specifications.type);
      }
    });
    return Array.from(categories);
  };

  const handleFilterChange = (filterType, value) => {
    const newFilters = {
      ...activeFilters,
      [filterType]: value
    };
    setActiveFilters(newFilters);
    onFilterChange(newFilters);
  };

  const getCategoryIcon = (category) => {
    switch (category) {
      case 'phone': return Smartphone;
      case 'laptop': return Laptop;
      case 'headphone': return Headphones;
      default: return Filter;
    }
  };

  const getCategoryName = (category) => {
    switch (category) {
      case 'phone': return 'Äiá»‡n thoáº¡i';
      case 'laptop': return 'Laptop';
      case 'headphone': return 'Tai nghe';
      default: return category;
    }
  };

  const categories = getCategories();
  const hasMultipleCategories = categories.length > 1;

  return (
    <div className="mb-6 bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
      <button
        onClick={() => setIsExpanded(!isExpanded)}
        className="w-full p-4 flex items-center justify-between text-left hover:bg-gray-50 transition-colors"
      >
        <div className="flex items-center space-x-3">
          <div className="p-2 bg-indigo-100 rounded-lg">
            <Filter className="w-4 h-4 text-indigo-600" />
          </div>
          <div>
            <h3 className="font-semibold text-gray-900">Bá»™ lá»c thÃ´ng sá»‘</h3>
            <p className="text-sm text-gray-500">
              TÃ¹y chá»‰nh hiá»ƒn thá»‹ so sÃ¡nh thÃ´ng sá»‘ ká»¹ thuáº­t
            </p>
          </div>
        </div>
        <ChevronDown className={`w-5 h-5 text-gray-400 transition-transform ${
          isExpanded ? 'rotate-180' : ''
        }`} />
      </button>

      {isExpanded && (
        <div className="px-4 pb-4 space-y-4 border-t border-gray-100">
          {/* Basic filters */}
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <label className="flex items-center space-x-2 cursor-pointer">
                <input
                  type="checkbox"
                  checked={activeFilters.showBasicOnly}
                  onChange={(e) => handleFilterChange('showBasicOnly', e.target.checked)}
                  className="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                />
                <span className="text-sm font-medium text-gray-700">
                  Chá»‰ hiá»‡n thÃ´ng sá»‘ cÆ¡ báº£n
                </span>
              </label>
            </div>

            <div className="flex items-center justify-between">
              <label className="flex items-center space-x-2 cursor-pointer">
                <input
                  type="checkbox"
                  checked={activeFilters.showDifferencesOnly}
                  onChange={(e) => handleFilterChange('showDifferencesOnly', e.target.checked)}
                  className="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                />
                <span className="text-sm font-medium text-gray-700">
                  Chá»‰ hiá»‡n thÃ´ng sá»‘ khÃ¡c biá»‡t
                </span>
              </label>
            </div>
          </div>

          {/* Category filter - only show if there are multiple categories */}
          {hasMultipleCategories && (
            <div className="pt-3 border-t border-gray-100">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Lá»c theo loáº¡i sáº£n pháº©m
              </label>
              <div className="flex flex-wrap gap-2">
                <button
                  onClick={() => handleFilterChange('categoryFilter', 'all')}
                  className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ${
                    activeFilters.categoryFilter === 'all'
                      ? 'bg-indigo-100 text-indigo-700 border border-indigo-200'
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  Táº¥t cáº£
                </button>
                {categories.map(category => {
                  const Icon = getCategoryIcon(category);
                  return (
                    <button
                      key={category}
                      onClick={() => handleFilterChange('categoryFilter', category)}
                      className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-colors flex items-center space-x-1 ${
                        activeFilters.categoryFilter === category
                          ? 'bg-indigo-100 text-indigo-700 border border-indigo-200'
                          : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                      }`}
                    >
                      <Icon className="w-3 h-3" />
                      <span>{getCategoryName(category)}</span>
                    </button>
                  );
                })}
              </div>
            </div>
          )}

          {/* Active filters summary */}
          {(activeFilters.showBasicOnly || activeFilters.showDifferencesOnly || activeFilters.categoryFilter !== 'all') && (
            <div className="pt-3 border-t border-gray-100">
              <div className="flex items-center justify-between">
                <div className="flex flex-wrap gap-1">
                  {activeFilters.showBasicOnly && (
                    <span className="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">
                      CÆ¡ báº£n
                    </span>
                  )}
                  {activeFilters.showDifferencesOnly && (
                    <span className="px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full">
                      KhÃ¡c biá»‡t
                    </span>
                  )}
                  {activeFilters.categoryFilter !== 'all' && (
                    <span className="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full">
                      {getCategoryName(activeFilters.categoryFilter)}
                    </span>
                  )}
                </div>
                <button
                  onClick={() => {
                    const resetFilters = {
                      showBasicOnly: false,
                      showDifferencesOnly: false,
                      categoryFilter: 'all'
                    };
                    setActiveFilters(resetFilters);
                    onFilterChange(resetFilters);
                  }}
                  className="text-xs text-gray-500 hover:text-gray-700 underline"
                >
                  XÃ³a bá»™ lá»c
                </button>
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
};

export default SpecificationFilter;

```

### ClientApp\src\components\FeaturedBrands\FeaturedBrands.js
```js
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { Spin, Alert, Typography } from 'antd';
import Slider from 'react-slick';
import './FeaturedBrands.css';

const { Title } = Typography;

const FeaturedBrands = () => {
    const [brands, setBrands] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    useEffect(() => {
        const fetchBrands = async () => {
            try {
                const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/Brand`);
                // Assuming the API returns an array of brand objects with `id`, `name`, and `logoUrl`
                setBrands(response.data);
            } catch (err) {
                setError('Failed to load brands.');
                console.error(err);
            } finally {
                setLoading(false);
            }
        };

        fetchBrands();
    }, []);

    const sliderSettings = {
        dots: false,
        infinite: true,
        speed: 500,
        slidesToShow: 5,
        slidesToScroll: 1,
        autoplay: true,
        autoplaySpeed: 3000,
        responsive: [
            {
                breakpoint: 1024,
                settings: {
                    slidesToShow: 4,
                }
            },
            {
                breakpoint: 600,
                settings: {
                    slidesToShow: 3,
                }
            },
            {
                breakpoint: 480,
                settings: {
                    slidesToShow: 2,
                }
            }
        ]
    };

    if (loading) {
        return <div className="text-center p-4"><Spin /></div>;
    }

    if (error) {
        return <div className="p-4"><Alert message={error} type="error" /></div>;
    }

    return (
        <div className="featured-brands-section">
            <Title level={3} className="text-center section-title">Trusted by the Best</Title>
            <Slider {...sliderSettings}>
                {brands.map(brand => (
                    <div key={brand.id} className="brand-logo-container">
                        <img src={brand.logoUrl} alt={brand.name} className="brand-logo" />
                    </div>
                ))}
            </Slider>
        </div>
    );
};

export default FeaturedBrands;

```

### ClientApp\src\components\FeaturedCategories\CategoryLarge.jsx
```jsx
import React from "react";
import { useNavigate } from "react-router-dom";

const CategoryLarge = ({ id, name, image }) => {
  const navigate = useNavigate();

  const handleClick = () => {
    navigate(`/ProductList?categoryId=${id}`);
  };

  return (
    <div
      className="relative w-[420px] h-[180px] sm:w-[350px] sm:h-[160px] xs:w-[300px] bg-gradient-to-br from-gray-50 to-gray-200 rounded-xl shadow-lg overflow-hidden p-4 transition-all duration-300 hover:shadow-xl hover:-translate-y-1 mt-4 cursor-pointer"
      onClick={handleClick}
    >
      <span className="absolute top-3 left-4 text-lg font-semibold text-gray-800 px-2 py-1 z-10">
        {name}
      </span>
      <div className="absolute right-4 top-1/2 transform -translate-y-1/2 h-full flex items-center">
        <img
    src={
        image?.startsWith("http")
            ? image // Full external URL
            : `${process.env.REACT_APP_API_BASE_URL}${image}`
    }
    alt={`logo`}
          className="max-h-[130px] sm:max-h-[110px] xs:max-h-[100px] object-contain transition-transform duration-300 hover:scale-115 hover:rotate-2"
    onError={(e) => {
        e.target.onerror = null;
        e.target.src = "https://via.placeholder.com/50";
    }}
/>
      </div>
      <div className="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-red-400 to-purple-500 opacity-75"></div>
    </div>
  );
};

export default CategoryLarge;

```

### ClientApp\src\components\FeaturedCategories\FeaturedCategories.js
```js
import React, { useState, useEffect } from 'react';
import axios from 'axios';

const FeaturedCategories = ({ data }) => {
  const [categories, setCategories] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchCategories = async () => {
      try {
        setLoading(true);
        // Fetch categories from the new API endpoint
        const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/categories`);
        // Filter for active categories if the API doesn't do it by default
        // (Our new API does, but keeping this for robustness)
        setCategories(response.data);
      } catch (err) {
        setError('Failed to load categories.');
        console.error(err);
      } finally {
        setLoading(false);
      }
    };

    fetchCategories();
  }, []);

  if (loading) {
    return <div className="text-white">Loading categories...</div>;
  }

  if (error) {
    return <div className="text-red-500">{error}</div>;
  }

  return (
    <section className="py-16 md:py-24 bg-primary-dark">
      <div className="container mx-auto px-4">
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
          {categories.map((category) => (
            <a
              key={category.id}
              href={`/ProductList?categoryId=${category.id}`}
              className="group block bg-white/5 p-6 rounded-lg border border-white-20 backdrop-blur-sm transition-all duration-300 hover:scale-105 hover:border-electric-blue"
            >
              <div className="flex flex-col items-center text-center">
                <img src={category.image} alt={category.name} className="h-24 w-24 object-contain mb-4 filter grayscale group-hover:filter-none transition-all duration-300" />
                <h3 className="font-display text-xl font-bold text-white transition-colors duration-300 group-hover:text-electric-blue">
                  {category.name}
                </h3>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  );
};

export default FeaturedCategories;
```

### ClientApp\src\components\FeaturedCategories\FeaturedCategories.jsx
```jsx
import React from "react";
import { Swiper, SwiperSlide } from "swiper/react";
import { Navigation, Pagination } from "swiper/modules";
import { useNavigate } from "react-router-dom";
import "swiper/css";
import "swiper/css/navigation";
import "swiper/css/pagination";
import "aos/dist/aos.css";
import AOS from "aos";
import CategoryLarge from "./CategoryLarge";
import { useCategories } from "@/hooks/api/useCategories";

const FeaturedCategories = () => {
  const { categories, loading, error } = useCategories();
  const navigate = useNavigate();

  React.useEffect(() => {
    AOS.init({ duration: 1000 });
  }, []);

  if (loading) {
    return <div className="text-center py-6">Äang táº£i danh má»¥c...</div>;
  }

  if (error) {
    return <div className="text-center py-6 text-red-500">{error}</div>;
  }

  return (
    <div className="w-full flex justify-center py-6">
      <div className="max-w-[1200px] w-full px-4">
        <Swiper
          modules={[Navigation, Pagination]}
          navigation
          pagination={{ clickable: true }}
          spaceBetween={20}
          slidesPerView={1}
          breakpoints={{
            640: { slidesPerView: 2 },
            768: { slidesPerView: 3 },
            1024: { slidesPerView: 4 },
          }}
          className="pb-6 transition-transform duration-500 ease-in-out"
        >
          {categories.map((category) => (
            <SwiperSlide
              key={category.id}
              className="flex justify-center transform hover:scale-105 transition-all duration-300"
            >
              <CategoryLarge
                id={category.id}
                name={category.name}
                image={category.image}
              />
            </SwiperSlide>
          ))}
        </Swiper>
      </div>
    </div>
  );
};

export default FeaturedCategories;

```

### ClientApp\src\components\FlashSale\FlashSale.js
```js
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import ProductCard from '@/components/shared/ProductCard';
// File removed. Migrated to FlashSale.jsx
// Import Swiper React components
import { Swiper, SwiperSlide } from 'swiper/react';
import { Navigation } from 'swiper/modules';

// Import Swiper styles
import 'swiper/css';
import 'swiper/css/navigation';

const CountdownTimer = ({ endDate }) => {
    const calculateTimeLeft = () => {
        const difference = +new Date(endDate) - +new Date();
        let timeLeft = {};

        if (difference > 0) {
            timeLeft = {
                days: Math.floor(difference / (1000 * 60 * 60 * 24)),
                hours: Math.floor((difference / (1000 * 60 * 60)) % 24),
                minutes: Math.floor((difference / 1000 / 60) % 60),
                seconds: Math.floor((difference / 1000) % 60),
            };
        }

        return timeLeft;
    };

    const [timeLeft, setTimeLeft] = useState(calculateTimeLeft());

    useEffect(() => {
        const timer = setTimeout(() => {
            setTimeLeft(calculateTimeLeft());
        }, 1000);

        return () => clearTimeout(timer);
    });

    const timerComponents = [];

    Object.keys(timeLeft).forEach((interval) => {
        if (!timeLeft[interval] && timeLeft[interval] !== 0) {
            return;
        }

        timerComponents.push(
            <div key={interval} className="text-center">
                <div className="font-display text-xl md:text-2xl font-bold text-neon-magenta">
                    {String(timeLeft[interval]).padStart(2, '0')}
                </div>
                <div className="text-xs uppercase text-light-gray">{interval.charAt(0).toUpperCase() + interval.slice(1)}</div>
            </div>
        );
    });

    return (
        <div className="flex space-x-2 md:space-x-4 justify-center">
            {timerComponents.length ? timerComponents : <span className="text-light-gray">Sale Ended!</span>}
        </div>
    );
};

const FlashSale = ({ data }) => {
  const [flashSaleProducts, setFlashSaleProducts] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchFlashSaleProducts = async () => {
      try {
        setLoading(true);
        const response = await axios.get('/api/products/flash-sale');
        setFlashSaleProducts(response.data);
      } catch (error) {
        console.error('Failed to fetch flash sale products:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchFlashSaleProducts();
  }, []);

  if (loading) {
    return <div className="text-white">Loading flash sales...</div>;
  }

  if (flashSaleProducts.length === 0) {
    return null; // Don't render section if no flash sale products
  }

  return (
    <section className="py-16 md:py-24 bg-primary-dark">
      <div className="container mx-auto px-4">
        <h2 className="font-display text-3xl md:text-4xl font-bold text-center text-white mb-12">
          {data.headline || "Flash Sale!"} {/* Use data.headline for section title */}
        </h2>
        
        <Swiper
          modules={[Navigation]}
          spaceBetween={30}
          slidesPerView={1}
          navigation
          breakpoints={{
            640: {
              slidesPerView: 2,
            },
            768: {
              slidesPerView: 3,
            },
            1024: {
              slidesPerView: 4,
            },
          }}
          className="!pb-10"
        >
          {flashSaleProducts.map((product) => (
            <SwiperSlide key={product.id}>
              <ProductCard product={product} isFlashSale={true} />
              {product.flashSaleEndDate && (
                <div className="mt-4">
                  <CountdownTimer endDate={product.flashSaleEndDate} />
                </div>
              )}
            </SwiperSlide>
          ))}
        </Swiper>
      </div>
    </section>
  );
};

export default FlashSale;
```

### ClientApp\src\components\FlashSale\FlashSale.jsx
```jsx
import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import Flaslsalebanner from "../../assets/img/anhcuanghia/hot-sale-cuoi-tuan.gif";
import { useFlashSaleProducts } from "@/hooks/api/useFlashSaleProducts";

const INITIAL_PRODUCTS_TO_SHOW = 10;

const FlashSale = () => {
  const { products, loading, error } = useFlashSaleProducts();
  const [visibleCount, setVisibleCount] = useState(INITIAL_PRODUCTS_TO_SHOW);
  const [timeLeft, setTimeLeft] = useState({ hours: 0, minutes: 0, seconds: 0 });
  const navigate = useNavigate();

  useEffect(() => {
    if (products.length > 0 && products[0].flashSaleEndDate) {
      const timer = setInterval(() => {
        const now = new Date().getTime();
        const endDate = new Date(products[0].flashSaleEndDate).getTime();
        const diff = endDate - now;

        if (diff <= 0) {
          setTimeLeft({ hours: 0, minutes: 0, seconds: 0 });
          clearInterval(timer);
          return;
        }

        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        setTimeLeft({ hours, minutes, seconds });
      }, 1000);

      return () => clearInterval(timer);
    }
  }, [products]);

  const handleLoadMore = () => {
    setVisibleCount(prevCount => prevCount + INITIAL_PRODUCTS_TO_SHOW);
  };

  const getPrimaryImage = (images) => {
    if (!images || images.length === 0) return "https://via.placeholder.com/300";
    const primaryImage = images.find(img => img.isPrimary);
    const imageUrl = primaryImage?.imageUrl || images[0]?.imageUrl;
    return imageUrl?.startsWith("http") ? imageUrl : `${process.env.REACT_APP_API_BASE_URL}/${imageUrl}`;
  };

  const getDisplayPrice = (variants, flashSalePrice) => {
    const originalPrice = variants?.[0]?.price || 0;
    const displayPrice = flashSalePrice ?? originalPrice;
    const oldPrice = flashSalePrice ? originalPrice : null;
    const discountAmount = oldPrice ? oldPrice - displayPrice : 0;

    return { displayPrice, oldPrice, discountAmount };
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center py-12">
        <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-500"></div>
        <span className="ml-3 text-gray-600">Äang táº£i sáº£n pháº©m...</span>
      </div>
    );
  }

  if (error) {
    return (
      <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mx-auto max-w-3xl my-6">
        <p className="font-bold">Lá»—i</p>
        <p>{error}</p>
      </div>
    );
  }

  if (products.length === 0) {
    return null; // Don't render the component if there are no flash sale products
  }

  return (
    <div className="w-full bg-gradient-to-b from-red-50 to-white py-10 px-4 sm:px-6 lg:px-8 relative overflow-hidden">
      <div className="max-w-7xl mx-auto relative z-10">
        <div className="text-center mb-10">
          <img
            src={Flaslsalebanner}
            alt="Flash Sale Banner"
            className="max-w-full h-auto mx-auto"
            style={{ maxHeight: '150px' }}
          />
          <div className="mt-6 flex justify-center">
            <div className="bg-white shadow-lg rounded-lg p-4 inline-flex items-center space-x-4 border-2 border-red-200">
              <span className="text-sm font-medium text-gray-600">Káº¿t thÃºc sau:</span>
              <div className="flex items-center space-x-2">
                <div className="bg-red-600 text-white rounded p-2 min-w-[50px] text-center">
                  <span className="block text-xl font-bold">{timeLeft.hours.toString().padStart(2, '0')}</span>
                  <span className="text-xs">Giá»</span>
                </div>
                <span className="text-red-600 font-bold">:</span>
                <div className="bg-red-600 text-white rounded p-2 min-w-[50px] text-center">
                  <span className="block text-xl font-bold">{timeLeft.minutes.toString().padStart(2, '0')}</span>
                  <span className="text-xs">PhÃºt</span>
                </div>
                <span className="text-red-600 font-bold">:</span>
                <div className="bg-red-600 text-white rounded p-2 min-w-[50px] text-center">
                  <span className="block text-xl font-bold">{timeLeft.seconds.toString().padStart(2, '0')}</span>
                  <span className="text-xs">GiÃ¢y</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 pb-12">
          {products.slice(0, visibleCount).map((product) => {
            const { displayPrice, oldPrice, discountAmount } = getDisplayPrice(product.variants, product.flashSalePrice);
            return (
              <div key={product.id} className="h-full flex flex-col">
                <div
                  className="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-300 cursor-pointer group relative border-2 border-transparent hover:border-red-500 flex flex-col h-full"
                  onClick={() => navigate(`/product/${product.id}`)}
                >
                  <div className="absolute top-0 left-0 bg-red-600 text-white text-xs font-bold px-3 py-1 z-10 clip-path-ribbon">
                    HOT SALE
                  </div>
                  <div className="relative aspect-square bg-gray-50 flex-shrink-0">
                    <img
                      src={getPrimaryImage(product.images)}
                      alt={product.name}
                      className="absolute top-0 left-0 w-full h-full object-contain p-4 group-hover:scale-105 transition-transform duration-300"
                      onError={(e) => { e.target.onerror = null; e.target.src = "https://via.placeholder.com/300"; }}
                    />
                  </div>
                  <div className="p-5 flex flex-col flex-grow" style={{ minHeight: '280px' }}>
                    <div className="flex justify-between items-start mb-2">
                      {oldPrice && (
                        <span className="text-gray-500 text-sm line-through">
                          {oldPrice.toLocaleString('vi-VN')}Ä‘
                        </span>
                      )}
                      <span className="text-red-600 font-bold text-lg ml-auto">
                        {displayPrice.toLocaleString('vi-VN')}Ä‘
                      </span>
                    </div>
                    <h3 className="text-lg font-bold text-gray-900 mb-2 line-clamp-2" style={{ height: '3.5rem' }}>
                      {product.name}
                    </h3>
                    <div className="mb-3 min-h-[28px]">
                      {discountAmount > 0 && (
                        <span className="inline-block bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded">
                          Tiáº¿t kiá»‡m {discountAmount.toLocaleString('vi-VN')}Ä‘
                        </span>
                      )}
                    </div>
                    <button className="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-bold transition-all duration-300 transform hover:scale-105 shadow-md mt-auto">
                      MUA NGAY
                    </button>
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        {products.length > visibleCount && (
          <div className="text-center mt-8">
            <button
              onClick={handleLoadMore}
              className="bg-white text-red-600 border-2 border-red-600 hover:bg-red-600 hover:text-white font-bold py-3 px-8 rounded-full transition-all duration-300 shadow-md hover:shadow-lg"
            >
              Xem thÃªm sáº£n pháº©m
            </button>
          </div>
        )}
      </div>

      <style jsx>{`
        .clip-path-ribbon {
          clip-path: polygon(0 0, 100% 0, 95% 50%, 100% 100%, 0 100%);
          width: 80px;
        }
      `}</style>
    </div>
  );
};

export default FlashSale;


```

### ClientApp\src\components\FlashSaleManager\FlashSaleManager.js
```js
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { AutoComplete, Button, Table, InputNumber, DatePicker, message, Popconfirm, Space, Input, Card, Typography } from 'antd';
import { SearchOutlined, DeleteOutlined } from '@ant-design/icons';
import dayjs from 'dayjs';

const { Text } = Typography;
const API_BASE_URL = process.env.REACT_APP_API_BASE_URL;

const FlashSaleManager = () => {
    const [searchText, setSearchText] = useState('');
    const [searchedProducts, setSearchedProducts] = useState([]);
    const [flashSaleProducts, setFlashSaleProducts] = useState([]);
    const [loading, setLoading] = useState(false);

    const fetchFlashSaleProducts = async () => {
        setLoading(true);
        try {
            const { data } = await axios.get(`${API_BASE_URL}/api/Products/flash-sale`);
            // Fetch full product details for each flash sale item
            const productIds = (data.$values || data).map(p => p.id);
            if (productIds.length > 0) {
                const productsDetailResponse = await axios.get(`${API_BASE_URL}/api/Products/by-ids?ids=${productIds.join(',')}`);
                const detailedProducts = productsDetailResponse.data.$values || productsDetailResponse.data || [];

                const combinedProducts = (data.$values || data).map(flashSaleProduct => {
                    const detail = detailedProducts.find(dp => dp.id === flashSaleProduct.id);
                    const primaryImage = detail?.images?.find(img => img.isPrimary) || detail?.images?.[0];
                    const imageUrl = primaryImage ? (primaryImage.imageUrl.startsWith("http") ? primaryImage.imageUrl : `${API_BASE_URL}/${primaryImage.imageUrl}`) : "https://via.placeholder.com/50";

                    return {
                        ...flashSaleProduct,
                        name: detail?.name || `Product ${flashSaleProduct.id}`,
                        imageUrl: imageUrl,
                        originalPrice: detail?.variants?.[0]?.price || 0, // Assuming first variant price as original
                    };
                });
                setFlashSaleProducts(combinedProducts);
            } else {
                setFlashSaleProducts([]);
            }
        } catch (error) {
            message.error('Failed to load flash sale products.');
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchFlashSaleProducts();
    }, []);

    const handleSearch = async (value) => {
        if (!value) {
            setSearchedProducts([]);
            return;
        }
        try {
            const { data } = await axios.get(`${API_BASE_URL}/api/Products/search?keyword=${value}`);
            const options = (data.$values || data).map(p => ({
                value: p.name,
                key: p.id,
                product: p,
                label: (
                    <Space>
                        <img src={p.images?.[0]?.imageUrl?.startsWith("http") ? p.images[0].imageUrl : `${API_BASE_URL}/${p.images?.[0]?.imageUrl}`} alt={p.name} style={{ width: 30, height: 30, objectFit: 'contain' }} onError={(e) => { e.target.onerror = null; e.target.src = "https://via.placeholder.com/30"; }} />
                        {p.name}
                    </Space>
                )
            }));
            setSearchedProducts(options);
        } catch (error) {
            setSearchedProducts([]);
        }
    };

    const onSelect = (value, option) => {
        const product = option.product;
        if (flashSaleProducts.some(p => p.id === product.id)) {
            message.warning('Product is already in the flash sale list.');
            return;
        }
        // Add to list with default values and fetched details
        const primaryImage = product.images?.find(img => img.isPrimary) || product.images?.[0];
        const imageUrl = primaryImage ? (primaryImage.imageUrl.startsWith("http") ? primaryImage.imageUrl : `${API_BASE_URL}/${primaryImage.imageUrl}`) : "https://via.placeholder.com/50";

        setFlashSaleProducts(prev => [...prev, {
            id: product.id,
            name: product.name,
            imageUrl: imageUrl,
            originalPrice: product.variants?.[0]?.price || 0,
            flashSalePrice: 0,
            flashSaleStartDate: null,
            flashSaleEndDate: null
        }]);
        setSearchText(''); // Clear search input
    };

    const handleUpdate = async (productId, field, value) => {
        const product = flashSaleProducts.find(p => p.id === productId);
        if (!product) return;

        const updatedProduct = { ...product, [field]: value };

        // Optimistic update
        setFlashSaleProducts(prev => prev.map(p => p.id === productId ? updatedProduct : p));

        const dto = {
            FlashSalePrice: updatedProduct.flashSalePrice,
            FlashSaleStartDate: updatedProduct.flashSaleStartDate,
            FlashSaleEndDate: updatedProduct.flashSaleEndDate,
        };

        try {
            await axios.put(`${API_BASE_URL}/api/Products/${productId}/set-flash-sale`, dto);
            message.success('Flash sale updated!');
        } catch (error) {
            message.error('Failed to update flash sale.');
            // Revert on failure
            setFlashSaleProducts(prev => prev.map(p => p.id === productId ? product : p));
        }
    };

    const handleRemove = async (productId) => {
        const originalList = [...flashSaleProducts];
        setFlashSaleProducts(prev => prev.filter(p => p.id !== productId));
        try {
            await axios.put(`${API_BASE_URL}/api/Products/${productId}/clear-flash-sale`);
            message.success('Product removed from flash sale.');
        } catch (error) {
            message.error('Failed to remove product from flash sale.');
            setFlashSaleProducts(originalList);
        }
    };

    const columns = [
        {
            title: 'Product',
            key: 'productInfo',
            render: (_, record) => (
                <Space>
                    <img src={record.imageUrl} alt={record.name} style={{ width: 50, height: 50, objectFit: 'contain' }} />
                    <Text>{record.name}</Text>
                </Space>
            )
        },
        {
            title: 'Original Price',
            key: 'originalPrice',
            render: (_, record) => (
                <Text delete={record.flashSalePrice !== null && record.flashSalePrice < record.originalPrice}>
                    {record.originalPrice.toLocaleString('vi-VN')}Ä‘
                </Text>
            )
        },
        {
            title: 'Flash Sale Price',
            dataIndex: 'flashSalePrice',
            key: 'flashSalePrice',
            render: (price, record) => (
                <InputNumber
                    defaultValue={price}
                    formatter={value => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',') + 'Ä‘'}
                    parser={value => value.replace(/\s?Ä‘|(,*)/g, '')}
                    onBlur={(e) => handleUpdate(record.id, 'flashSalePrice', parseFloat(e.target.value.replace(/Ä‘|,/g, '')))}
                    style={{ width: 150 }}
                    min={0}
                />
            )
        },
        {
            title: 'Start Date',
            dataIndex: 'flashSaleStartDate',
            key: 'flashSaleStartDate',
            render: (date, record) => (
                <DatePicker
                    showTime
                    format="YYYY-MM-DD HH:mm:ss"
                    value={date ? dayjs(date) : null}
                    onChange={(value) => handleUpdate(record.id, 'flashSaleStartDate', value ? value.toISOString() : null)}
                    style={{ width: 180 }}
                />
            )
        },
        {
            title: 'End Date',
            dataIndex: 'flashSaleEndDate',
            key: 'flashSaleEndDate',
            render: (date, record) => (
                <DatePicker
                    showTime
                    format="YYYY-MM-DD HH:mm:ss"
                    value={date ? dayjs(date) : null}
                    onChange={(value) => handleUpdate(record.id, 'flashSaleEndDate', value ? value.toISOString() : null)}
                    style={{ width: 180 }}
                />
            )
        },
        {
            title: 'Action',
            key: 'action',
            render: (_, record) => (
                <Popconfirm title="Are you sure you want to remove this product from flash sale?" onConfirm={() => handleRemove(record.id)} okText="Yes" cancelText="No">
                    <Button danger icon={<DeleteOutlined />} />
                </Popconfirm>
            )
        }
    ];

    return (
        <Card title="Flash Sale Management" bordered={false} style={{ marginBottom: 24 }}>
            <Space direction="vertical" style={{ width: '100%' }}>
                <AutoComplete
                    style={{ width: '100%' }}
                    onSearch={handleSearch}
                    onSelect={onSelect}
                    placeholder="Search and add a product to flash sale..."
                    options={searchedProducts}
                    value={searchText}
                    onChange={setSearchText}
                >
                    <Input prefix={<SearchOutlined />} />
                </AutoComplete>

                <Table
                    columns={columns}
                    dataSource={flashSaleProducts}
                    rowKey="id"
                    loading={loading}
                    pagination={false}
                    bordered
                />
            </Space>
        </Card>
    );
};

export default FlashSaleManager;

```

### ClientApp\src\components\Footer\Footer.jsx
```jsx
import React from "react";
import "./Footer.css";
import { useNavigate } from "react-router-dom";
const Footer = () => {
  const navigate = useNavigate();
  const handleOrderLookup = () => {
    navigate("/order-lookup");
  };
  return (
    <footer className="footer-container">
      <div className="footer-top-container">
        <div className="footer-title">
          <h3>Há»‡ thá»‘ng SHN Gear trÃªn toÃ n quá»‘c</h3>
          <p>
            Bao gá»“m Cá»­a hÃ ng SHN Gear, Trung tÃ¢m Laptop, F.Studio, S.Studio,
            Garmin Brand Store
          </p>
        </div>
        <button className="store-button" onClick={handleOrderLookup}>Tra cá»©u Ä‘Æ¡n </button>
      </div>

      <div className="footer-content">
        {/* Káº¿t ná»‘i máº¡ng xÃ£ há»™i */}
        <div className="footer-section">
          <h4>Káº¾T Ná»I Vá»šI SHN Gear</h4>
          <div className="social-icons">
            <img
              src="https://img.icons8.com/?size=96&id=118497&format=png"
              alt="Facebook"
            />
            <img
              src="https://img.icons8.com/?size=96&id=0m71tmRjlxEe&format=png"
              alt="Zalo"
            />
            <img
              src="https://img.icons8.com/?size=96&id=9a46bTk3awwI&format=png"
              alt="YouTube"
            />
            <img
              src="https://img.icons8.com/?size=100&id=118638&format=png"
              alt="TikTok"
            />
          </div>

          <h4>Tá»”NG ÄÃ€I MIá»„N PHÃ</h4>
          <p>
            <strong>TÆ° váº¥n mua hÃ ng (Miá»…n phÃ­)</strong>
          </p>
          <p>
            <strong>0338397638 (NhÃ¡nh 1)</strong>
          </p>
          <p>
            <strong>GÃ³p Ã½, khiáº¿u náº¡i</strong>
          </p>
          <p>
            <strong>0797841166 (8h00 - 22h00)</strong>
          </p>
          <p>
            <strong>Há»— trá»£ ká»¹ thuáº­t</strong>
          </p>
          <p>
            <strong>Gáº·p chuyÃªn gia ngay!</strong>
          </p>
        </div>

        {/* Vá» chÃºng tÃ´i */}
        <div className="footer-section">
          <h4>Vá»€ CHÃšNG TÃ”I</h4>
          <ul>
            <li>Giá»›i thiá»‡u vá» cÃ´ng ty</li>
            <li>Quy cháº¿ hoáº¡t Ä‘á»™ng</li>
            <li>Dá»± Ã¡n Doanh nghiá»‡p</li>
            <li>Tin tá»©c khuyáº¿n máº¡i</li>
            <li>Giá»›i thiá»‡u mÃ¡y Ä‘á»•i tráº£</li>
            <li>HÆ°á»›ng dáº«n mua hÃ ng & thanh toÃ¡n online</li>
            <li>Tra cá»©u hÃ³a Ä‘Æ¡n Ä‘iá»‡n tá»­</li>
            <li>CÃ¢u há»i thÆ°á»ng gáº·p</li>
          </ul>
        </div>

        {/* ChÃ­nh sÃ¡ch */}
        <div className="footer-section">
          <h4>CHÃNH SÃCH</h4>
          <ul>
            <li>ChÃ­nh sÃ¡ch báº£o hÃ nh</li>
            <li>ChÃ­nh sÃ¡ch Ä‘á»•i tráº£</li>
            <li>ChÃ­nh sÃ¡ch báº£o máº­t</li>
            <li>ChÃ­nh sÃ¡ch tráº£ gÃ³p</li>
            <li>ChÃ­nh sÃ¡ch giao hÃ ng & láº¯p Ä‘áº·t</li>
            <li>ChÃ­nh sÃ¡ch thu tháº­p & xá»­ lÃ½ dá»¯ liá»‡u cÃ¡ nhÃ¢n</li>
          </ul>
        </div>

        {/* Há»— trá»£ thanh toÃ¡n */}
        <div className="footer-section">
          <h4>Há»– TRá»¢ THANH TOÃN</h4>
          <div className="payment-icons">
            <img
              src="https://img.icons8.com/?size=96&id=13608&format=png"
              alt="Visa"
            />
            <img
              src="https://img.icons8.com/?size=96&id=Sq0VNi1Afgmj&format=png"
              alt="Mastercard"
            />
            <img
              src="https://img.icons8.com/?size=160&id=ikCy0r3I68vX&format=png"
              alt="Momo"
            />
            <img
              src="https://img.icons8.com/?size=96&id=0m71tmRjlxEe&format=png"
              alt="ZaloPay"
            />
            <img
              src="https://img.icons8.com/?size=160&id=cFdvD3H13wdO&format=png"
              alt="Apple Pay"
            />
            <img
              src="https://img.icons8.com/?size=160&id=PjkFdGXiQbvY&format=png"
              alt="Samsung Pay"
            />
          </div>

          <h4>CHá»¨NG NHáº¬N</h4>
          <div className="certification-icons">
            <img
              src="https://th.bing.com/th?id=OIP.vZ2cjkL0u4w45jFKiHnkyQHaHa&w=104&h=104&c=7&bgcl=552c98&r=0&o=6&dpr=1.3&pid=13.1"
              alt="DMCA"
            />
            <img
              src="https://th.bing.com/th?id=OIP.JWsl39NXvjcGkxk3H3aB8wHaCz&w=349&h=132&c=8&rs=1&qlt=90&o=6&dpr=1.3&pid=3.1&rm=2"
              alt="Bá»™ CÃ´ng ThÆ°Æ¡ng"
            />
          </div>
        </div>
      </div>
    </footer>
  );
};

export default Footer;

```

### ClientApp\src\components\HeroBanner\HeroBanner.js
```js
import React from 'react';

const HeroBanner = ({ data }) => {
  return (
    <section className="relative h-screen flex items-center justify-center text-center text-white overflow-hidden">
      {data.background_type === 'video' ? (
        <video
          autoPlay
          loop
          muted
          playsInline
          className="absolute top-0 left-0 w-full h-full object-cover z-0"
          src={data.background_url}
        >
          Your browser does not support the video tag.
        </video>
      ) : (
        <div
          className="absolute top-0 left-0 w-full h-full bg-cover bg-center z-0"
          style={{ backgroundImage: `url(${data.background_url})` }}
        ></div>
      )}

      <div className="absolute top-0 left-0 w-full h-full bg-black opacity-50 z-10"></div>

      <div className="relative z-20 flex flex-col items-center px-4">
        <h1 className="font-display text-4xl md:text-6xl lg:text-7xl uppercase font-bold tracking-wider mb-4">
          {data.headline}
        </h1>
        <p className="font-sans text-lg md:text-xl text-light-gray mb-8 max-w-2xl">
          {data.slogan}
        </p>
        <a
          href={data.cta_link}
          className="font-sans uppercase font-semibold tracking-widest px-8 py-3 border-2 border-electric-blue text-white transition-all duration-300 hover:bg-electric-blue hover:text-primary-dark focus:outline-none focus:ring-2 focus:ring-electric-blue focus:ring-opacity-50"
        >
          {data.cta_text}
        </a>
      </div>
    </section>
  );
};

export default HeroBanner;

```

### ClientApp\src\components\HeroBanner\HeroBanner.jsx
```jsx
import { useState, useEffect } from "react";
import Banner1 from "../../assets/img/anhcuanghia/banner1.png";
import Banner2 from "../../assets/img/anhcuanghia/bannervip.png";
import Banner3 from "../../assets/img/anhcuanghia/hieuthuhai.png";

const Slider = () => {
  const slides = [
    { img: Banner1 },
    { img: Banner2 },
    { img: Banner3 },
  ];

  const [currentIndex, setCurrentIndex] = useState(0);
  const [isTransitioning, setIsTransitioning] = useState(false);

  // Auto-rotate slides
  useEffect(() => {
    const interval = setInterval(() => {
      nextSlide();
    }, 5000);
    return () => clearInterval(interval);
  }, [currentIndex]);

  const nextSlide = () => {
    setIsTransitioning(true);
    setCurrentIndex((prevIndex) => (prevIndex + 1) % slides.length);
  };

  const prevSlide = () => {
    setIsTransitioning(true);
    setCurrentIndex((prevIndex) => (prevIndex - 1 + slides.length) % slides.length);
  };

  const goToSlide = (index) => {
    setIsTransitioning(true);
    setCurrentIndex(index);
  };

  // Reset transitioning state after animation completes
  useEffect(() => {
    const timer = setTimeout(() => {
      setIsTransitioning(false);
    }, 500);
    return () => clearTimeout(timer);
  }, [currentIndex]);

  return (
    <div className="relative w-full overflow-hidden">
      {/* Slider container */}
      <div className="relative">
        {/* Slider */}
        <div className={`flex relative ${isTransitioning ? "transition-opacity duration-500 ease-in-out" : ""}`}>
          {slides.map((slide, index) => (
            <div
              key={index}
              className={`flex-shrink-0 w-full transition-opacity duration-500 ${index === currentIndex ? "opacity-100" : "opacity-0 absolute"}`}
            >
              <div className="relative">
                <img
                  src={slide.img}
                  alt={`Slide ${index + 1}`}
                  className="w-full h-auto object-cover"
                  loading="lazy"
                />
                {/* Gradient overlay Ä‘á»ƒ táº¡o hiá»‡u á»©ng trong suá»‘t dáº§n vá» phÃ­a dÆ°á»›i */}
                <div
                  className="absolute inset-0 bg-gradient-to-t from-transparent via-transparent to-black/20 pointer-events-none"
                  style={{
                    maskImage: "linear-gradient(to bottom, black 50%, transparent 100%)",
                    WebkitMaskImage: "linear-gradient(to bottom, black 50%, transparent 100%)"
                  }}
                ></div>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Navigation buttons */}
      <button
        className="absolute top-1/2 left-5 -translate-y-1/2 w-12 h-12 bg-white/70 rounded-full flex items-center justify-center z-10 transition-all hover:bg-white/90 hover:scale-105 shadow-md"
        onClick={prevSlide}
      >
        <svg className="w-6 h-6 text-gray-800" viewBox="0 0 24 24">
          <path fill="currentColor" d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z" />
        </svg>
      </button>
      <button
        className="absolute top-1/2 right-5 -translate-y-1/2 w-12 h-12 bg-white/70 rounded-full flex items-center justify-center z-10 transition-all hover:bg-white/90 hover:scale-105 shadow-md"
        onClick={nextSlide}
      >
        <svg className="w-6 h-6 text-gray-800" viewBox="0 0 24 24">
          <path fill="currentColor" d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
        </svg>
      </button>

      {/* Indicators - PhiÃªn báº£n cao cáº¥p gá»n nháº¹ */}
      <div className="absolute bottom-6 left-1/2 -translate-x-1/2 flex space-x-1.5 z-20">
        {slides.map((_, index) => (
          <button
            key={index}
            onClick={() => goToSlide(index)}
            className={`relative w-2 h-2 rounded-full transition-all duration-300 ease-out ${index === currentIndex
                ? "bg-white scale-[1.8] shadow-[0_0_8px_rgba(255,255,255,0.8)]"
                : "bg-white/40 hover:bg-white/60 scale-100"
              }`}
          >
            {index === currentIndex && (
              <span className="absolute inset-0 rounded-full bg-white/20 animate-ping" />
            )}
          </button>
        ))}
      </div>
    </div>
  );
};

export default Slider;
```

### ClientApp\src\components\HeroSlider\HeroSlider.jsx
```jsx
import React from "react";
import { Swiper, SwiperSlide } from "swiper/react";
import { Navigation, Autoplay } from "swiper/modules";
import "swiper/css";
import "swiper/css/navigation";
import "swiper/css/pagination";
import slider1 from "..//..//assets/img/HeadPhone/banner_headphone.jpg";
import slider2 from "..//..//assets/img/Laptop/banner_laptop.jpg";
import slider3 from "..//..//assets/img/Phone/banner_iphone.jpg";
import "./HeroSlider.css";

const HeroSlider = () => {
  return (
    <div className="hero-slider">
      <Swiper
        modules={[Navigation, Autoplay]}
        spaceBetween={20} // Khoáº£ng cÃ¡ch giá»¯a cÃ¡c slide
        slidesPerView={2} // Hiá»ƒn thá»‹ 2 slide cÃ¹ng lÃºc
        autoplay={{ delay: 3000, disableOnInteraction: false }} // Tá»± Ä‘á»™ng chuyá»ƒn slide
        loop={true} // Láº·p vÃ´ háº¡n
        pagination={{ clickable: true }} // Hiá»ƒn thá»‹ dots Ä‘iá»u hÆ°á»›ng
        // navigation // Hiá»ƒn thá»‹ nÃºt Ä‘iá»u hÆ°á»›ng
        className="custom-swiper"
      >
        <SwiperSlide>
          <img src={slider1} alt="Slide 1" className="slide-image" />
        </SwiperSlide>
        <SwiperSlide>
          <img src={slider2} alt="Slide 2" className="slide-image" />
        </SwiperSlide>
        <SwiperSlide>
          <img src={slider3} alt="Slide 3" className="slide-image" />
        </SwiperSlide>
      </Swiper>
    </div>
  );
};

export default HeroSlider;

```

### ClientApp\src\components\Homepage\BannerSlider.js
```js
import React, { useState, useEffect } from 'react';
import axios from 'axios';
// File removed. Migrated to BannerSlider.jsx
// Import Swiper React components
import { Swiper, SwiperSlide } from 'swiper/react';
import { Navigation, Pagination, Autoplay } from 'swiper/modules';

// Import Swiper styles
import 'swiper/css';
import 'swiper/css/navigation';
import 'swiper/css/pagination';

const BannerSlider = () => {
  const [banners, setBanners] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchBanners = async () => {
      try {
        setLoading(true);
        const response = await axios.get('/api/banners');
        setBanners(response.data);
      } catch (err) {
        setError('Failed to load banners.');
        console.error(err);
      } finally {
        setLoading(false);
      }
    };

    fetchBanners();
  }, []);

  if (loading) {
    return <div className="text-white">Loading banners...</div>;
  }

  if (error) {
    return <div className="text-red-500">{error}</div>;
  }

  if (banners.length === 0) {
    return null; // Don't render if no banners
  }

  return (
    <section className="w-full h-auto overflow-hidden">
      <Swiper
        modules={[Navigation, Pagination, Autoplay]}
        spaceBetween={0}
        slidesPerView={1}
        navigation
        pagination={{ clickable: true }}
        autoplay={{
          delay: 5000,
          disableOnInteraction: false,
        }}
        loop={true}
        className="w-full h-full"
      >
        {banners.map((banner) => (
          <SwiperSlide key={banner.id}>
            <a href={banner.linkUrl || '#'} className="block w-full h-full">
              <img 
                src={banner.imageUrl}
                alt="Banner"
                className="w-full h-full object-cover"
              />
            </a>
          </SwiperSlide>
        ))}
      </Swiper>
    </section>
  );
};

export default BannerSlider;

```

### ClientApp\src\components\Homepage\BannerSlider.jsx
```jsx
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { Swiper, SwiperSlide } from 'swiper/react';
import { Navigation, Pagination, Autoplay } from 'swiper/modules';
import 'swiper/css';
import 'swiper/css/navigation';
import 'swiper/css/pagination';

const BannerSlider = () => {
  const [banners, setBanners] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  useEffect(() => {
    const fetchBanners = async () => {
      try {
        setLoading(true);
        const response = await axios.get('/api/banners');
        setBanners(response.data);
      } catch (err) {
        setError('Failed to load banners.');
        console.error(err);
      } finally {
        setLoading(false);
      }
    };
    fetchBanners();
  }, []);
  if (loading) return <div className="text-white">Loading banners...</div>;
  if (error) return <div className="text-red-500">{error}</div>;
  if (banners.length === 0) return null;
  return (
    <section className="w-full h-auto overflow-hidden">
      <Swiper
        modules={[Navigation, Pagination, Autoplay]}
        spaceBetween={0}
        slidesPerView={1}
        navigation
        pagination={{ clickable: true }}
        autoplay={{ delay: 5000, disableOnInteraction: false }}
        loop={true}
        className="w-full h-full"
      >
        {banners.map((banner) => (
          <SwiperSlide key={banner.id}>
            <img src={banner.imageUrl} alt={banner.title} className="w-full h-64 md:h-96 object-cover rounded-xl shadow-lg" />
          </SwiperSlide>
        ))}
      </Swiper>
    </section>
  );
};

export default BannerSlider;

```

### ClientApp\src\components\Homepage\BrandTrustSection.js
```js
import React from 'react';

const BrandTrustSection = ({ data }) => {
  return (
    <section className="py-16 md:py-24 bg-gray-900/50">
      <div className="container mx-auto px-4">
        {/* Brand Logos */}
        <div className="flex justify-center items-center flex-wrap gap-x-12 gap-y-8 mb-16">
          {(data?.logos || []).map((brand) => (
            <div key={brand.id} className="flex-shrink-0">
              <img 
                src={brand.logo_url} 
                alt={brand.name} 
                className="h-8 md:h-10 object-contain filter grayscale hover:filter-none transition-all duration-300"
              />
            </div>
          ))}
        </div>

        {/* Commitments */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
          {(data?.commitments || []).map((commitment) => (
            <div key={commitment.id} className="p-4">
              {/* You can use a proper icon library here */}
              <div className="flex items-center justify-center h-16 w-16 mx-auto mb-4 bg-white/5 rounded-full border border-white-20">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-electric-blue h-6 w-6"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
              </div>
              <h3 className="font-display text-xl font-bold text-white">{commitment.title}</h3>
              <p className="text-light-gray mt-1">{commitment.description}</p>
            </div>
          ))}
        </div>
      </div>
    </section>
  );
};

export default BrandTrustSection;

```

### ClientApp\src\components\Homepage\CategoriesSection.js
```js
import React from 'react';

const CategoriesSection = ({ data }) => {
  return (
    <section className="py-16 md:py-24 bg-primary-dark">
      <div className="container mx-auto px-4">
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
          {data.items.map((category) => (
            <a
              key={category.id}
              href={category.link}
              className="group block bg-white/5 p-6 rounded-lg border border-white-20 backdrop-blur-sm transition-all duration-300 hover:scale-105 hover:border-electric-blue"
            >
              <div className="flex flex-col items-center text-center">
                <img src={category.image_url} alt={category.name} className="h-24 w-24 object-contain mb-4 filter grayscale group-hover:filter-none transition-all duration-300" />
                <h3 className="font-display text-xl font-bold text-white transition-colors duration-300 group-hover:text-electric-blue">
                  {category.name}
                </h3>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  );
};

export default CategoriesSection;

```

### ClientApp\src\components\Homepage\FeaturedProductsSection.js
```js
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import ProductCard from '@/components/shared/ProductCard';

// Import Swiper React components
import { Swiper, SwiperSlide } from 'swiper/react';
import { Navigation } from 'swiper/modules';

// Import Swiper styles
import 'swiper/css';
import 'swiper/css/navigation';

const FeaturedProductsSection = ({ data }) => {
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchProducts = async () => {
      if (!data.collection_id) return;
      try {
        setLoading(true);
        const response = await axios.get(`/api/products?collectionId=${data.collection_id}`);
        setProducts(response.data);
      } catch (error) {
        console.error('Failed to fetch featured products:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchProducts();
  }, [data.collection_id]);

  if (loading) {
    return <div>Loading products...</div>; // Or a proper skeleton loader
  }

  return (
    <section className="py-16 md:py-24 bg-primary-dark">
      <div className="container mx-auto px-4">
        <h2 className="font-display text-3xl md:text-4xl font-bold text-center text-white mb-12">
          {data.title}
        </h2>
        <Swiper
          modules={[Navigation]}
          spaceBetween={30}
          slidesPerView={1}
          navigation
          breakpoints={{
            640: {
              slidesPerView: 2,
            },
            768: {
              slidesPerView: 3,
            },
            1024: {
              slidesPerView: 4,
            },
          }}
          className="!pb-10"
        >
          {products.map((product) => (
            <SwiperSlide key={product.id}>
              <ProductCard product={product} />
            </SwiperSlide>
          ))}
        </Swiper>
      </div>
    </section>
  );
};

export default FeaturedProductsSection;

```

### ClientApp\src\components\Homepage\HeroSection.js
```js
import React from 'react';

const HeroSection = ({ data }) => {
  return (
    <section className="relative h-screen flex items-center justify-center text-center text-white overflow-hidden">
      {data.background_type === 'video' ? (
        <video
          autoPlay
          loop
          muted
          playsInline
          className="absolute top-0 left-0 w-full h-full object-cover z-0"
          src={data.background_url}
        >
          Your browser does not support the video tag.
        </video>
      ) : (
        <div
          className="absolute top-0 left-0 w-full h-full bg-cover bg-center z-0"
          style={{ backgroundImage: `url(${data.background_url})` }}
        ></div>
      )}

      <div className="absolute top-0 left-0 w-full h-full bg-black opacity-50 z-10"></div>

      <div className="relative z-20 flex flex-col items-center px-4">
        <h1 className="font-display text-4xl md:text-6xl lg:text-7xl uppercase font-bold tracking-wider mb-4">
          {data.headline}
        </h1>
        <p className="font-sans text-lg md:text-xl text-light-gray mb-8 max-w-2xl">
          {data.slogan}
        </p>
        <a
          href={data.cta_link}
          className="font-sans uppercase font-semibold tracking-widest px-8 py-3 border-2 border-electric-blue text-white transition-all duration-300 hover:bg-electric-blue hover:text-primary-dark focus:outline-none focus:ring-2 focus:ring-electric-blue focus:ring-opacity-50"
        >
          {data.cta_text}
        </a>
      </div>
    </section>
  );
};

export default HeroSection;

```

### ClientApp\src\components\Homepage\SpecialOfferSection.js
```js
import React, { useState, useEffect } from 'react';

const CountdownTimer = ({ endDate }) => {
    const calculateTimeLeft = () => {
        const difference = +new Date(endDate) - +new Date();
        let timeLeft = {};

        if (difference > 0) {
            timeLeft = {
                days: Math.floor(difference / (1000 * 60 * 60 * 24)),
                hours: Math.floor((difference / (1000 * 60 * 60)) % 24),
                minutes: Math.floor((difference / 1000 / 60) % 60),
                seconds: Math.floor((difference / 1000) % 60),
            };
        }

        return timeLeft;
    };

    const [timeLeft, setTimeLeft] = useState(calculateTimeLeft());

    useEffect(() => {
        const timer = setTimeout(() => {
            setTimeLeft(calculateTimeLeft());
        }, 1000);

        return () => clearTimeout(timer);
    });

    const timerComponents = [];

    Object.keys(timeLeft).forEach((interval) => {
        if (!timeLeft[interval] && timeLeft[interval] !== 0) {
            return;
        }

        timerComponents.push(
            <div key={interval} className="text-center">
                <div className="font-display text-3xl md:text-4xl font-bold text-neon-magenta">
                    {String(timeLeft[interval]).padStart(2, '0')}
                </div>
                <div className="text-xs uppercase text-light-gray">{interval}</div>
            </div>
        );
    });

    return (
        <div className="flex space-x-4">
            {timerComponents.length ? timerComponents : <span>Time's up!</span>}
        </div>
    );
};

const SpecialOfferSection = ({ data }) => {
    const imageUrl = data.image_url?.startsWith("http") 
        ? data.image_url 
        : `${process.env.REACT_APP_API_BASE_URL}/${data.image_url}`;

    return (
        <section className="py-16 md:py-24 bg-primary-dark">
            <div className="container mx-auto px-4">
                <div className="relative rounded-lg overflow-hidden bg-gray-900">
                    <img src={imageUrl} alt="Special Offer" className="absolute w-full h-full object-cover opacity-30" />
                    <div className="relative p-8 md:p-16 flex flex-col lg:flex-row items-center justify-between">
                        <div className="text-center lg:text-left mb-8 lg:mb-0">
                            <h2 className="font-display text-3xl md:text-4xl font-bold text-white uppercase">{data.headline}</h2>
                            <p className="mt-2 text-lg text-light-gray max-w-lg">{data.sub_text}</p>
                            <div className="mt-4 flex items-center justify-center lg:justify-start space-x-4">
                                {data.originalPrice && (
                                    <span className="text-2xl text-gray-500 line-through">
                                        {data.originalPrice.toLocaleString('vi-VN')}Ä‘
                                    </span>
                                )}
                                {data.discountPrice && (
                                    <span className="text-4xl font-bold text-neon-magenta">
                                        {data.discountPrice.toLocaleString('vi-VN')}Ä‘
                                    </span>
                                )}
                            </div>
                        </div>
                        <div className="flex flex-col items-center">
                            {data.countdown_enabled && <CountdownTimer endDate={data.countdown_end_date} />}
                            <a href={data.cta_link} className="mt-6 font-sans uppercase font-semibold tracking-widest px-8 py-3 bg-neon-magenta text-primary-dark transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-neon-magenta focus:ring-opacity-50 rounded-md">
                                {data.cta_text}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    );
};

export default SpecialOfferSection;

```

### ClientApp\src\components\layouts\AdminLayout.js
```js
import React from "react";
import Sidebar from "@/components/Admin/common/Sidebar.jsx";

const AdminLayout = ({ children }) => {
  return (
    <div className="flex h-screen bg-gray-900 text-gray-100">
      {/* BG */}
      <div className="fixed inset-0 z-0">
        <div className="absolute inset-0 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900" />
      </div>

      <Sidebar />
      <div className="flex-1 flex flex-col relative z-10 min-h-0">
        {children}
      </div>
    </div>
  );
};

export default AdminLayout;

```

### ClientApp\src\components\layouts\DefaultLayout.js
```js
import React from 'react';
import Navbar from '@/components/Navbar/Navbar';
import Footer from '@/components/Footer/Footer';

const DefaultLayout = ({ children }) => {
  return (
    <div className="flex flex-col min-h-screen bg-primary-dark">
      <Navbar />
      <main className="flex-grow">
        {children}
      </main>
      <Footer />
    </div>
  );
};

export default DefaultLayout;

```

### ClientApp\src\components\List\CategoryMenu.jsx
```jsx
import React from "react";
import {
  Box,
  Container,
  Grid,
  Typography,
  Skeleton,
  Paper,
  Fade,
  Chip,
} from "@mui/material";
import { motion } from "framer-motion";
import { useCategories } from "@/hooks/api/useCategories";

const CategoryMenu = () => {
  const { categories, loading } = useCategories();
  const [hoveredCategory, setHoveredCategory] = React.useState(null);

  const container = {
    hidden: { opacity: 0 },
    show: {
      opacity: 1,
      transition: {
        staggerChildren: 0.1,
      },
    },
  };

  const item = {
    hidden: { opacity: 0, y: 20 },
    show: { opacity: 1, y: 0 },
  };

  if (loading) {
    return (
      <Box p={3}>
        <Grid container spacing={3}>
          {[1, 2, 3, 4, 5, 6].map((item) => (
            <Grid item xs={6} sm={4} md={2} key={item}>
              <Skeleton
                variant="rounded"
                height={160}
                sx={{
                  borderRadius: 4,
                  transform: "none",
                  backgroundColor: "rgba(0,0,0,0.04)",
                }}
              />
            </Grid>
          ))}
        </Grid>
      </Box>
    );
  }

  return (
    <Box p={3}>
      <motion.div variants={container} initial="hidden" animate="show">
        <Grid container spacing={3}>
          {categories
            .filter((cat) => !cat.parentId)
            .map((category) => (
              <Grid item xs={6} sm={4} md={2} key={category.id}>
                <motion.div variants={item}>
                  <Paper
                    elevation={0}
                    component={motion.div}
                    whileHover={{ y: -8 }}
                    onMouseEnter={() => setHoveredCategory(category.id)}
                    onMouseLeave={() => setHoveredCategory(null)}
                    onClick={() =>
                      (window.location.href = `/ProductList?categoryId=${category.id}`)
                    }
                    sx={{
                      p: 2,
                      height: "100%",
                      borderRadius: 4,
                      cursor: "pointer",
                      overflow: "hidden",
                      position: "relative",
                      border: "1px solid",
                      borderColor: "divider",
                      transition: "all 0.3s ease",
                      background:
                        "linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9))",
                      backdropFilter: "blur(10px)",
                      "&:hover": {
                        borderColor: "primary.main",
                        boxShadow:
                          "0 10px 20px -10px rgba(0,0,0,0.1), 0 0 0 1px rgba(0,0,0,0.02)",
                      },
                    }}
                  >
                    {/* Background Pattern */}
                    <Box
                      sx={{
                        position: "absolute",
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        opacity: 0.03,
                        background:
                          "repeating-linear-gradient(45deg, #000 0, #000 1px, transparent 0, transparent 50%)",
                        backgroundSize: "10px 10px",
                        zIndex: 0,
                      }}
                    />

                    <Box
                      sx={{
                        position: "relative",
                        zIndex: 1,
                        height: "100%",
                        display: "flex",
                        flexDirection: "column",
                        alignItems: "center",
                        textAlign: "center",
                      }}
                    >
                      {/* Category Image */}
                      <Box
                        sx={{
                          mb: 2,
                          width: "100%",
                          aspectRatio: "1",
                          position: "relative",
                          overflow: "hidden",
                          borderRadius: 3,
                        }}
                      >
                        <Box
                          component="img"
                          src={
                            category.image?.startsWith("http")
                              ? category.image
                              : `${process.env.REACT_APP_API_BASE_URL}/${category.image}`
                          }
                          alt={category.name}
                          onError={(e) => {
                            e.target.onerror = null;
                            e.target.src = "https://via.placeholder.com/150";
                          }}
                          sx={{
                            width: "100%",
                            height: "100%",
                            objectFit: "contain",
                            transition: "transform 0.6s ease",
                            transform:
                              hoveredCategory === category.id
                                ? "scale(1.1)"
                                : "scale(1)",
                          }}
                        />
                      </Box>

                      {/* Category Name */}
                      <Typography
                        variant="subtitle2"
                        sx={{
                          fontWeight: 600,
                          color: "text.primary",
                          transition: "color 0.3s ease",
                          position: "relative",
                          "&::after": {
                            content: '""',
                            position: "absolute",
                            bottom: -4,
                            left: "50%",
                            width:
                              hoveredCategory === category.id ? "100%" : "0%",
                            height: 2,
                            bgcolor: "primary.main",
                            transition: "all 0.3s ease",
                            transform: "translateX(-50%)",
                          },
                        }}
                      >
                        {category.name}
                      </Typography>

                      {/* Product Count */}
                      <Fade in={hoveredCategory === category.id}>
                        <Chip
                          label="Xem ngay"
                          size="small"
                          color="primary"
                          sx={{
                            mt: 1,
                            fontSize: "0.75rem",
                            height: 24,
                          }}
                        />
                      </Fade>
                    </Box>
                  </Paper>
                </motion.div>
              </Grid>
            ))}
        </Grid>
      </motion.div>
    </Box>
  );
};

export default CategoryMenu;

```

### ClientApp\src\components\List\FilterSection.jsx
```jsx
import React, { useState, useEffect } from "react";
import {
  Box,
  Typography,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Slider,
  FormGroup,
  FormControlLabel,
  Checkbox,
  Chip,
  Button,
  Skeleton,
  Avatar,
  Divider,
  Collapse,
  IconButton,
} from "@mui/material";
import { ChevronDown, Filter, X, CheckCircle2, Circle } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";
import { useBrands } from "@/hooks/api/useBrands";

const priceRanges = [
  { value: "all", min: 0, max: Infinity, label: "Táº¥t cáº£" },
  { value: "0-2000000", min: 0, max: 2000000, label: "DÆ°á»›i 2 triá»‡u" },
  {
    value: "2000000-4000000",
    min: 2000000,
    max: 4000000,
    label: "2 - 4 triá»‡u",
  },
  {
    value: "4000000-7000000",
    min: 4000000,
    max: 7000000,
    label: "4 - 7 triá»‡u",
  },
  {
    value: "7000000-13000000",
    min: 7000000,
    max: 13000000,
    label: "7 - 13 triá»‡u",
  },
  {
    value: "13000000-20000000",
    min: 13000000,
    max: 20000000,
    label: "13 - 20 triá»‡u",
  },
  {
    value: "20000000-99999999",
    min: 20000000,
    max: 99999999,
    label: "TrÃªn 20 triá»‡u",
  },
];

const FilterSection = ({ onPriceChange, onBrandChange }) => {
  const [expanded, setExpanded] = useState(["price", "brand"]);
  const [selectedBrands, setSelectedBrands] = useState([]);
  const [selectedPrice, setSelectedPrice] = useState("all");
  const [showAllBrands, setShowAllBrands] = useState(false);
  const { brands, loading } = useBrands(true);

  const handleAccordionChange = (panel) => (_, isExpanded) => {
    setExpanded(
      isExpanded
        ? [...expanded, panel]
        : expanded.filter((item) => item !== panel)
    );
  };

  const handlePriceChange = (range) => {
    setSelectedPrice(range);
    onPriceChange(range);
  };

  const handleBrandChange = (brandId) => {
    const newSelectedBrands = selectedBrands.includes(brandId)
      ? selectedBrands.filter((id) => id !== brandId)
      : [...selectedBrands, brandId];

    setSelectedBrands(newSelectedBrands);
    onBrandChange(newSelectedBrands.length > 0 ? newSelectedBrands : null);
  };

  const clearFilters = () => {
    setSelectedPrice("all");
    setSelectedBrands([]);
    onPriceChange("all");
    onBrandChange(null);
  };

  const hasActiveFilters = selectedPrice !== "all" || selectedBrands.length > 0;

  return (
    <Box>
      {/* Header */}
      <Box
        sx={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
          mb: 3,
        }}
      >
        <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
          <Filter size={20} />
          <Typography variant="subtitle1" fontWeight={600}>
            Bá»™ lá»c tÃ¬m kiáº¿m
          </Typography>
        </Box>
        {hasActiveFilters && (
          <IconButton
            size="small"
            onClick={clearFilters}
            sx={{
              color: "text.secondary",
              "&:hover": {
                color: "error.main",
                bgcolor: "error.lighter",
              },
            }}
          >
            <X size={18} />
          </IconButton>
        )}
      </Box>

      {/* Active Filters */}
      <AnimatePresence>
        {hasActiveFilters && (
          <motion.div
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: "auto" }}
            exit={{ opacity: 0, height: 0 }}
            transition={{ duration: 0.2 }}
          >
            <Box sx={{ display: "flex", flexWrap: "wrap", gap: 1, mb: 3 }}>
              {selectedPrice !== "all" && (
                <Chip
                  label={
                    priceRanges.find((r) => r.value === selectedPrice)?.label
                  }
                  onDelete={() => handlePriceChange("all")}
                  size="small"
                  color="primary"
                  variant="outlined"
                />
              )}
              {selectedBrands.map((brandId) => {
                const brand = brands.find((b) => b.id === brandId);
                return (
                  brand && (
                    <Chip
                      key={brandId}
                      label={brand.name}
                      onDelete={() => handleBrandChange(brandId)}
                      size="small"
                      color="primary"
                      variant="outlined"
                      avatar={
                        brand.logo ? (
                          <Avatar
                            src={
                              brand.logo?.startsWith("http")
                                ? brand.logo
                                : `${process.env.REACT_APP_API_BASE_URL}/${brand.logo}`
                            }
                            sx={{ width: 20, height: 20 }}
                          />
                        ) : null
                      }
                    />
                  )
                );
              })}
            </Box>
          </motion.div>
        )}
      </AnimatePresence>

      <Divider sx={{ mb: 3 }} />

      {/* Price Filter */}
      <Accordion
        expanded={expanded.includes("price")}
        onChange={handleAccordionChange("price")}
        elevation={0}
        disableGutters
        sx={{
          "&:before": { display: "none" },
          mb: 2,
          bgcolor: "transparent",
        }}
      >
        <AccordionSummary
          expandIcon={<ChevronDown size={20} />}
          sx={{
            px: 0,
            "&.Mui-expanded": {
              minHeight: 48,
            },
          }}
        >
          <Typography variant="subtitle2" fontWeight={600}>
            Khoáº£ng giÃ¡
          </Typography>
        </AccordionSummary>
        <AccordionDetails sx={{ px: 0, py: 1 }}>
          <FormGroup>
            {priceRanges.map((range) => (
              <motion.div
                key={range.value}
                whileHover={{ x: 4 }}
                transition={{ duration: 0.2 }}
              >
                <FormControlLabel
                  control={
                    <Checkbox
                      icon={<Circle size={18} />}
                      checkedIcon={<CheckCircle2 size={18} />}
                      checked={selectedPrice === range.value}
                      onChange={() => handlePriceChange(range.value)}
                      size="small"
                    />
                  }
                  label={
                    <Typography
                      variant="body2"
                      sx={{
                        color:
                          selectedPrice === range.value
                            ? "primary.main"
                            : "text.primary",
                        fontWeight: selectedPrice === range.value ? 500 : 400,
                      }}
                    >
                      {range.label}
                    </Typography>
                  }
                  sx={{
                    py: 0.5,
                    transition: "all 0.2s",
                    "&:hover": {
                      color: "primary.main",
                    },
                  }}
                />
              </motion.div>
            ))}
          </FormGroup>
        </AccordionDetails>
      </Accordion>

      {/* Brand Filter */}
      <Accordion
        expanded={expanded.includes("brand")}
        onChange={handleAccordionChange("brand")}
        elevation={0}
        disableGutters
        sx={{
          "&:before": { display: "none" },
          bgcolor: "transparent",
        }}
      >
        <AccordionSummary
          expandIcon={<ChevronDown size={20} />}
          sx={{
            px: 0,
            "&.Mui-expanded": {
              minHeight: 48,
            },
          }}
        >
          <Typography variant="subtitle2" fontWeight={600}>
            ThÆ°Æ¡ng hiá»‡u
          </Typography>
        </AccordionSummary>
        <AccordionDetails sx={{ px: 0, py: 1 }}>
          {loading ? (
            <Box sx={{ py: 2 }}>
              <Skeleton height={32} sx={{ mb: 1 }} />
              <Skeleton height={32} sx={{ mb: 1 }} />
              <Skeleton height={32} />
            </Box>
          ) : (
            <FormGroup>
              <AnimatePresence>
                {brands
                  .slice(0, showAllBrands ? undefined : 6)
                  .map((brand, index) => (
                    <motion.div
                      key={brand.id}
                      initial={{ opacity: 0, y: 10 }}
                      animate={{ opacity: 1, y: 0 }}
                      exit={{ opacity: 0, y: -10 }}
                      transition={{ duration: 0.2, delay: index * 0.05 }}
                    >
                      <FormControlLabel
                        control={
                          <Checkbox
                            icon={<Circle size={18} />}
                            checkedIcon={<CheckCircle2 size={18} />}
                            checked={selectedBrands.includes(brand.id)}
                            onChange={() => handleBrandChange(brand.id)}
                            size="small"
                          />
                        }
                        label={
                          <Box
                            sx={{
                              display: "flex",
                              alignItems: "center",
                              gap: 1,
                            }}
                          >
                            {brand.logo && (
                              <Avatar
                                src={
                                  brand.logo?.startsWith("http")
                                    ? brand.logo
                                    : `${process.env.REACT_APP_API_BASE_URL}/${brand.logo}`
                                }
                                sx={{ width: 24, height: 24 }}
                                variant="rounded"
                              />
                            )}
                            <Typography
                              variant="body2"
                              sx={{
                                color: selectedBrands.includes(brand.id)
                                  ? "primary.main"
                                  : "text.primary",
                                fontWeight: selectedBrands.includes(brand.id)
                                  ? 500
                                  : 400,
                              }}
                            >
                              {brand.name}
                            </Typography>
                          </Box>
                        }
                        sx={{
                          py: 0.5,
                          transition: "all 0.2s",
                          "&:hover": {
                            color: "primary.main",
                          },
                        }}
                      />
                    </motion.div>
                  ))}
              </AnimatePresence>

              {brands.length > 6 && (
                <Box sx={{ mt: 1 }}>
                  <Button
                    size="small"
                    onClick={() => setShowAllBrands(!showAllBrands)}
                    sx={{
                      textTransform: "none",
                      color: "primary.main",
                      "&:hover": {
                        bgcolor: "primary.lighter",
                      },
                    }}
                  >
                    {showAllBrands
                      ? "Thu gá»n"
                      : `Xem thÃªm ${brands.length - 6} thÆ°Æ¡ng hiá»‡u`}
                  </Button>
                </Box>
              )}
            </FormGroup>
          )}
        </AccordionDetails>
      </Accordion>
    </Box>
  );
};

export default FilterSection;

```

### ClientApp\src\components\List\ProductGrid.jsx
```jsx
import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import ProductHoverPreview from "./ProductHoverPreview";
import ProductPagination from "./ProductPagination";
import { motion } from "framer-motion";
import { Typography, Rating } from "@mui/material";
import CompareModal from "../CompareProduct/CompareModal";
import "./ProductCard.css";
import "./ProductActions.css";

const container = {
  hidden: { opacity: 0 },
  show: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      delayChildren: 0.3,
    },
  },
};

const item = {
  hidden: { opacity: 0, y: 20 },
  show: {
    opacity: 1,
    y: 0,
    transition: {
      duration: 0.5,
      ease: [0.43, 0.13, 0.23, 0.96],
    },
  },
};

const ProductGrid = ({
  selectedCategory,
  selectedPriceRange,
  selectedBrand,
  viewMode,
}) => {
  const [products, setProducts] = useState([]);
  const [allProducts, setAllProducts] = useState([]); // LÆ°u táº¥t cáº£ sáº£n pháº©m
  const [currentPage, setCurrentPage] = useState(1);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [hoveredProduct, setHoveredProduct] = useState(null);
  const [mousePosition, setMousePosition] = useState({ x: 0, y: 0 });
  const [productSpecs, setProductSpecs] = useState({});
  const [compareModalOpen, setCompareModalOpen] = useState(false);
  const [compareCount, setCompareCount] = useState(0);
  const [toastNotification, setToastNotification] = useState(null);
  const [loadingStates, setLoadingStates] = useState({});
  const navigate = useNavigate();

  const PRODUCTS_PER_PAGE = 9;

  // Handle mouse interaction
  const handleMouseEnter = async (product, event) => {
    setHoveredProduct(product);
    setMousePosition({ x: event.clientX, y: event.clientY });

    if (!productSpecs[product.id]) {
      try {
        const productType = product.category?.name
          ?.toLowerCase()
          .includes("phone")
          ? "PhoneSpecifications"
          : product.category?.name?.toLowerCase().includes("laptop")
          ? "LaptopSpecifications"
          : product.category?.name?.toLowerCase().includes("headphone")
          ? "HeadphoneSpecifications"
          : null;

        if (productType) {
          const response = await fetch(
            `${process.env.REACT_APP_API_BASE_URL}/api/Specifications/${productType}/product/${product.id}`
          );
          if (response.ok) {
            const specs = await response.json();
            setProductSpecs((prev) => ({
              ...prev,
              [product.id]: {
                ...specs,
                type: productType.replace("Specifications", "").toLowerCase(),
              },
            }));
          }
        }
      } catch (err) {
        console.error("Error fetching specifications:", err);
      }
    }
  };
  const handleMouseLeave = () => setHoveredProduct(null);
  const handleMouseMove = (event) => {
    if (hoveredProduct) {
      setMousePosition({ x: event.clientX, y: event.clientY });
    }
  };

  // Toast notification functions
  const showToast = (message, type = "success", title = "") => {
    setToastNotification({ message, type, title });
    setTimeout(() => setToastNotification(null), 3000);
  };

  // Set loading state for specific button
  const setButtonLoading = (productId, buttonType, isLoading) => {
    setLoadingStates((prev) => ({
      ...prev,
      [`${productId}-${buttonType}`]: isLoading,
    }));
  };
  useEffect(() => {
    const fetchProductsAndBrands = async () => {
      setLoading(true);
      try {
        const [productsRes, brandsRes] = await Promise.all([
          fetch(`${process.env.REACT_APP_API_BASE_URL}/api/Products`),
          fetch(`${process.env.REACT_APP_API_BASE_URL}/api/brands`),
        ]);

        if (!productsRes.ok || !brandsRes.ok) {
          throw new Error("KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u");
        }

        const productsData = await productsRes.json();
        const brandsData = await brandsRes.json();

        const brandsMap = (brandsData.$values || brandsData || []).reduce(
          (acc, brand) => {
            acc[brand.id] = brand;
            return acc;
          },
          {}
        );

        let filteredProducts = productsData.$values || productsData || [];

        if (selectedCategory) {
          filteredProducts = filteredProducts.filter(
            (product) => product.categoryId === selectedCategory
          );
        }

        if (selectedBrand) {
          filteredProducts = filteredProducts.filter(
            (product) => product.brandId === selectedBrand
          );
        }

        if (selectedPriceRange && selectedPriceRange !== "all") {
          const [minPrice, maxPrice] = selectedPriceRange
            .split("-")
            .map(Number);
          filteredProducts = filteredProducts.filter((product) => {
            const price =
              product.variants?.[0]?.discountPrice ||
              product.variants?.[0]?.price ||
              0;
            return price >= minPrice && price <= maxPrice;
          });
        }

        const processedProducts = filteredProducts.map((product) => {
          const variant = product.variants?.[0] || {};
          const image =
            product.images?.[0]?.imageUrl ||
            "https://via.placeholder.com/300?text=No+Image";
          const oldPrice = variant.price || 0;
          const newPrice = variant.discountPrice || oldPrice;
          const discountAmount = oldPrice - newPrice;
          const discount =
            oldPrice > 0 ? Math.round((discountAmount / oldPrice) * 100) : 0;

          const brand = brandsMap[product.brandId];

          return {
            id: product.id,
            name: product.name,
            oldPrice,
            newPrice,
            discount,
            discountAmount,
            image,
            brand,
            rating: 4.5,
            ratingCount: Math.floor(Math.random() * 100) + 50,
            variant,
            category: product.category,
          };
        });

        setAllProducts(processedProducts);
        setCurrentPage(1); // Reset vá» trang Ä‘áº§u khi filter thay Ä‘á»•i
      } catch (err) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    };

    fetchProductsAndBrands();
  }, [selectedCategory, selectedPriceRange, selectedBrand]);

  // Effect Ä‘á»ƒ cáº­p nháº­t sáº£n pháº©m hiá»ƒn thá»‹ dá»±a trÃªn trang hiá»‡n táº¡i
  useEffect(() => {
    const startIndex = (currentPage - 1) * PRODUCTS_PER_PAGE;
    const endIndex = startIndex + PRODUCTS_PER_PAGE;
    setProducts(allProducts.slice(startIndex, endIndex));
  }, [allProducts, currentPage]);

  // HÃ m xá»­ lÃ½ thay Ä‘á»•i trang
  const handlePageChange = (page) => {
    setCurrentPage(page);
    // Scroll to top when page changes
    window.scrollTo({
      top: 0,
      behavior: "smooth",
    });
  };

  // TÃ­nh tá»•ng sá»‘ trang
  const totalPages = Math.ceil(allProducts.length / PRODUCTS_PER_PAGE);

  // Theo dÃµi sá»‘ lÆ°á»£ng sáº£n pháº©m trong compareList
  useEffect(() => {
    const updateCompareCount = () => {
      const compareList = JSON.parse(
        localStorage.getItem("compareList") || "[]"
      );
      setCompareCount(compareList.length);
    };

    updateCompareCount();

    window.addEventListener("storage", updateCompareCount);
    window.addEventListener("compareListChanged", updateCompareCount);

    return () => {
      window.removeEventListener("storage", updateCompareCount);
      window.removeEventListener("compareListChanged", updateCompareCount);
    };
  }, []);
  // Function Ä‘á»ƒ thÃªm/xÃ³a sáº£n pháº©m khá»i compare list
  const toggleCompare = async (productId, productName) => {
    setButtonLoading(productId, "compare", true);

    try {
      // Simulate API delay
      await new Promise((resolve) => setTimeout(resolve, 500));

      const compareList = JSON.parse(
        localStorage.getItem("compareList") || "[]"
      );

      if (compareList.includes(productId)) {
        const updatedList = compareList.filter((id) => id !== productId);
        localStorage.setItem("compareList", JSON.stringify(updatedList));
        setCompareCount(updatedList.length);
        window.dispatchEvent(new Event("compareListChanged"));
        showToast(
          `ÄÃ£ xÃ³a "${productName}" khá»i danh sÃ¡ch so sÃ¡nh!`,
          "success",
          "XÃ³a thÃ nh cÃ´ng"
        );
      } else {
        if (compareList.length >= 4) {
          showToast(
            "Chá»‰ cÃ³ thá»ƒ so sÃ¡nh tá»‘i Ä‘a 4 sáº£n pháº©m cÃ¹ng lÃºc!",
            "warning",
            "Giá»›i háº¡n so sÃ¡nh"
          );
          return;
        }

        compareList.push(productId);
        localStorage.setItem("compareList", JSON.stringify(compareList));
        setCompareCount(compareList.length);
        window.dispatchEvent(new Event("compareListChanged"));
        showToast(
          `ÄÃ£ thÃªm "${productName}" vÃ o danh sÃ¡ch so sÃ¡nh!`,
          "success",
          "ThÃªm thÃ nh cÃ´ng"
        );
      }

      setProducts((prevProducts) => [...prevProducts]);
    } finally {
      setButtonLoading(productId, "compare", false);
    }
  };

  // Function Ä‘á»ƒ thÃªm sáº£n pháº©m vÃ o giá» hÃ ng
  const addToCart = async (product) => {
    setButtonLoading(product.id, "cart", true);

    try {
      // Simulate API call to add to cart
      await new Promise((resolve) => setTimeout(resolve, 800));

      // Get existing cart from localStorage or create new one
      const existingCart = JSON.parse(localStorage.getItem("cart") || "[]");

      // Check if product already exists in cart
      const existingItemIndex = existingCart.findIndex(
        (item) => item.id === product.id
      );

      if (existingItemIndex > -1) {
        // Update quantity if product already exists
        existingCart[existingItemIndex].quantity += 1;
        showToast(
          `ÄÃ£ cáº­p nháº­t sá»‘ lÆ°á»£ng "${product.name}" trong giá» hÃ ng!`,
          "success",
          "Cáº­p nháº­t giá» hÃ ng"
        );
      } else {
        // Add new product to cart
        const cartItem = {
          id: product.id,
          name: product.name,
          price: product.newPrice,
          image: product.image,
          brand: product.brand?.name || "",
          quantity: 1,
          variant: product.variant,
        };
        existingCart.push(cartItem);
        showToast(
          `ÄÃ£ thÃªm "${product.name}" vÃ o giá» hÃ ng!`,
          "success",
          "ThÃªm thÃ nh cÃ´ng"
        );
      }

      // Save updated cart to localStorage
      localStorage.setItem("cart", JSON.stringify(existingCart));

      // Dispatch event to update cart count in other components
      window.dispatchEvent(new Event("cartChanged"));

      // Temporarily add success class to button
      const buttonElement = document.querySelector(
        `[data-product-id="${product.id}"] .add-to-cart-btn`
      );
      if (buttonElement) {
        buttonElement.classList.add("btn-success");
        setTimeout(() => {
          buttonElement.classList.remove("btn-success");
        }, 600);
      }
    } catch (error) {
      console.error("Error adding to cart:", error);
      showToast("CÃ³ lá»—i xáº£y ra khi thÃªm vÃ o giá» hÃ ng!", "error", "Lá»—i");
    } finally {
      setButtonLoading(product.id, "cart", false);
    }
  };

  // Function Ä‘á»ƒ má»Ÿ modal so sÃ¡nh
  const openCompareModal = () => {
    const compareList = JSON.parse(localStorage.getItem("compareList") || "[]");

    if (compareList.length < 1) {
      alert("Cáº§n Ã­t nháº¥t 1 sáº£n pháº©m Ä‘á»ƒ so sÃ¡nh!");
      return;
    }

    setCompareModalOpen(true);
  };

  if (loading) {
    return (
      <div className="products-grid">
        {[...Array(8)].map((_, index) => (
          <motion.div key={index} variants={item}>
            <div className="skeleton-card">
              <div className="skeleton-image" />
              <div className="skeleton-content">
                <div className="skeleton-text title" />
                <div className="skeleton-text" />
                <div className="skeleton-text price" />
              </div>
            </div>
          </motion.div>
        ))}
      </div>
    );
  }

  if (error) {
    return <div className="text-red-500 text-center p-4">{error}</div>;
  }

  return (
    <div className="w-full py-8 bg-gradient-to-br from-gray-50 to-white min-h-screen">
      <div className="max-w-7xl mx-auto px-4">
        {" "}
        {allProducts.length === 0 ? (
          <div className="text-center py-16">
            <div className="text-6xl mb-4">ğŸ“±</div>
            <h3 className="text-xl font-semibold text-gray-800 mb-2">
              KhÃ´ng cÃ³ sáº£n pháº©m phÃ¹ há»£p
            </h3>
            <p className="text-gray-500">
              HÃ£y thá»­ thay Ä‘á»•i bá»™ lá»c hoáº·c tá»« khÃ³a tÃ¬m kiáº¿m
            </p>
          </div>
        ) : (
          <motion.div variants={container} initial="hidden" animate="show">
            <div className="products-grid">
              {products.map((product) => {
                const isInCompare = JSON.parse(
                  localStorage.getItem("compareList") || "[]"
                ).includes(product.id);

                return (
                  <motion.div
                    key={product.id}
                    variants={item}
                    onMouseEnter={(e) => handleMouseEnter(product, e)}
                    onMouseLeave={handleMouseLeave}
                    onMouseMove={handleMouseMove}
                  >
                    <div
                      className="product-card"
                      onClick={() => navigate(`/product/${product.id}`)}
                    >
                      {/* Product Image */}
                      <div className="product-image">
                        {/* Discount Badge */}
                        {product.discount > 0 && (
                          <div className="absolute top-2 left-2 z-10">
                            <span className="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">
                              -{product.discount}%
                            </span>
                          </div>
                        )}

                        {/* Compare Badge */}
                        {isInCompare && (
                          <div className="absolute top-2 right-2 z-10">
                            <span className="bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">
                              âœ“ ÄÃ£ chá»n
                            </span>
                          </div>
                        )}

                        <img
                          src={
                            product.image.startsWith("http")
                              ? product.image
                              : `${process.env.REACT_APP_API_BASE_URL}/${product.image}`
                          }
                          alt={product.name}
                          onError={(e) => {
                            e.target.onerror = null;
                            e.target.src =
                              "https://via.placeholder.com/300?text=Error";
                          }}
                        />
                      </div>

                      {/* Product Content */}
                      <div className="product-content">
                        {/* Brand */}
                        {product.brand && (
                          <div className="product-brand">
                            {product.brand.logo && (
                              <img
                                src={
                                  product.brand.logo.startsWith("http")
                                    ? product.brand.logo
                                    : `${process.env.REACT_APP_API_BASE_URL}/${product.brand.logo}`
                                }
                                alt={product.brand.name}
                                className="brand-logo"
                                onError={(e) => {
                                  e.target.onerror = null;
                                  e.target.style.display = "none";
                                }}
                              />
                            )}
                            <Typography
                              variant="caption"
                              sx={{
                                color: "text.secondary",
                                fontWeight: 500,
                              }}
                            >
                              {product.brand.name}
                            </Typography>
                          </div>
                        )}
                        {/* Product Name */}
                        <h3 className="product-name">{product.name}</h3>
                        {/* Rating */}
                        <div className="product-rating">
                          <Rating
                            value={product.rating}
                            precision={0.5}
                            size="small"
                            readOnly
                          />
                          <Typography variant="body2" color="text.secondary">
                            ({product.ratingCount})
                          </Typography>
                        </div>
                        {/* Price */}
                        <div className="product-price">
                          {product.oldPrice > product.newPrice && (
                            <div className="old-price">
                              {product.oldPrice.toLocaleString()}Ä‘
                            </div>
                          )}
                          <div className="current-price">
                            {product.newPrice.toLocaleString()}Ä‘
                          </div>
                        </div>{" "}
                        {/* Action Buttons */}
                        <div
                          className="product-actions"
                          data-product-id={product.id}
                        >
                          <button
                            className={`compare-btn ${
                              isInCompare ? "active" : ""
                            } ${
                              loadingStates[`${product.id}-compare`]
                                ? "btn-loading"
                                : ""
                            }`}
                            onClick={(e) => {
                              e.stopPropagation();
                              toggleCompare(product.id, product.name);
                            }}
                            disabled={loadingStates[`${product.id}-compare`]}
                          >
                            {loadingStates[`${product.id}-compare`]
                              ? ""
                              : isInCompare
                              ? "âœ“ ÄÃ£ chá»n"
                              : "So sÃ¡nh"}
                          </button>

                          <button
                            className={`add-to-cart-btn ${
                              loadingStates[`${product.id}-cart`]
                                ? "btn-loading"
                                : ""
                            }`}
                            onClick={(e) => {
                              e.stopPropagation();
                              addToCart(product);
                            }}
                            disabled={loadingStates[`${product.id}-cart`]}
                          >
                            {loadingStates[`${product.id}-cart`]
                              ? ""
                              : "ThÃªm vÃ o giá»"}
                          </button>
                        </div>
                      </div>
                    </div>
                  </motion.div>
                );
              })}
            </div>

            {/* Pagination */}
            <ProductPagination
              currentPage={currentPage}
              totalPages={totalPages}
              onPageChange={handlePageChange}
              totalProducts={allProducts.length}
              productsPerPage={PRODUCTS_PER_PAGE}
              loading={loading}
            />
          </motion.div>
        )}
        {/* Floating Compare Button */}
        {compareCount > 0 && (
          <div className="fixed bottom-8 left-8 z-[9998]">
            <button
              onClick={openCompareModal}
              className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-full shadow-2xl transition-all duration-300 flex items-center space-x-3 transform hover:scale-105"
            >
              <div className="relative">
                <svg
                  className="w-6 h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                  />
                </svg>
                <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">
                  {compareCount}
                </span>
              </div>
              <span className="font-semibold">So sÃ¡nh</span>
            </button>
          </div>
        )}
        {/* Product Hover Preview */}
        <ProductHoverPreview
          product={{
            ...hoveredProduct,
            specifications: hoveredProduct
              ? productSpecs[hoveredProduct.id]
              : null,
          }}
          isVisible={Boolean(hoveredProduct)}
          position={mousePosition}
        />{" "}
        {/* Compare Modal */}
        <CompareModal
          isOpen={compareModalOpen}
          onClose={() => setCompareModalOpen(false)}
        />
        {/* Toast Notification */}
        {toastNotification && (
          <div className={`toast-notification ${toastNotification.type}`}>
            <div className={`toast-icon ${toastNotification.type}`}>
              {toastNotification.type === "success"
                ? "âœ“"
                : toastNotification.type === "error"
                ? "âœ—"
                : toastNotification.type === "warning"
                ? "âš "
                : "â„¹"}
            </div>
            <div className="toast-content">
              {toastNotification.title && (
                <div className="toast-title">{toastNotification.title}</div>
              )}
              <div className="toast-message">{toastNotification.message}</div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default ProductGrid;

```

### ClientApp\src\components\List\ProductHoverPreview.jsx
```jsx
import React from "react";
import {
  Smartphone,
  Laptop,
  Headphones,
  Monitor,
  Cpu,
  MemoryStick,
  Battery,
  Bluetooth,
  Weight,
  HardDrive,
  Camera,
  Wifi,
  Settings,
  Radio,
} from "lucide-react";
import "./ProductHoverPreview.css";

const ProductHoverPreview = ({ product, isVisible, position }) => {
  if (!isVisible || !product) return null;

  const getSpecIcon = (key) => {
    const icons = {
      cpu: Cpu,
      ram: MemoryStick,
      storage: HardDrive,
      battery: Battery,
      screen: Monitor,
      camera: Camera,
      weight: Weight,
      bluetooth: Bluetooth,
      wifi: Wifi,
      type: Headphones,
      connectionType: Radio,
      port: Settings,
    };
    return icons[key.toLowerCase()] || Settings;
  };

  const formatSpecKey = (key) => {
    const keyMap = {
      cpu: "CPU",
      ram: "RAM",
      storage: "Bá»™ nhá»›",
      battery: "Pin",
      screen: "MÃ n hÃ¬nh",
      camera: "Camera",
      weight: "Trá»ng lÆ°á»£ng",
      bluetooth: "Bluetooth",
      wifi: "Wifi",
      type: "Loáº¡i",
      connectionType: "Káº¿t ná»‘i",
      port: "Cá»•ng káº¿t ná»‘i",
    };
    return keyMap[key.toLowerCase()] || key;
  };

  const renderSpecs = () => {
    if (!product.specifications) return null;

    const specs = { ...product.specifications };
    delete specs.id;
    delete specs.productId;
    delete specs.product;
    delete specs.type;

    return Object.entries(specs)
      .filter(([_, value]) => value)
      .slice(0, 6)
      .map(([key, value]) => {
        const Icon = getSpecIcon(key);
        return (
          <div key={key} className="spec-item">
            <div className="spec-icon">
              <Icon size={16} />
            </div>
            <div className="spec-content">
              <div className="spec-label">{formatSpecKey(key)}</div>
              <div className="spec-value">{value}</div>
            </div>
          </div>
        );
      });
  };

  const previewStyle = {
    transform: `translate(${position.x + 20}px, ${position.y + 20}px)`,
  };

  return (
    <div className="preview-card" style={previewStyle}>
      <div className="preview-header">
        <img
          src={
            product.image?.startsWith("http")
              ? product.image
              : `${process.env.REACT_APP_API_BASE_URL}/${product.image}`
          }
          alt={product.name}
          className="preview-image"
          onError={(e) => {
            e.target.onerror = null;
            e.target.src = "https://via.placeholder.com/200?text=No+Image";
          }}
        />
        <div className="preview-title">
          <div className="preview-name">{product.name}</div>
          {product.brand && (
            <div className="preview-brand">
              {product.brand.logo && (
                <img
                  src={
                    product.brand.logo.startsWith("http")
                      ? product.brand.logo
                      : `${process.env.REACT_APP_API_BASE_URL}/${product.brand.logo}`
                  }
                  alt={product.brand.name}
                  onError={(e) => {
                    e.target.onerror = null;
                    e.target.style.display = "none";
                  }}
                />
              )}
              <span>{product.brand.name}</span>
            </div>
          )}
          <div className="preview-price">
            <span className="preview-current-price">
              {product.newPrice.toLocaleString()}Ä‘
            </span>
            {product.oldPrice > product.newPrice && (
              <>
                <span className="preview-old-price">
                  {product.oldPrice.toLocaleString()}Ä‘
                </span>
                <span className="preview-discount">-{product.discount}%</span>
              </>
            )}
          </div>
        </div>
      </div>

      {product.specifications && (
        <div className="preview-specs">
          <div className="preview-specs-title">
            <Settings size={16} />
            ThÃ´ng sá»‘ ká»¹ thuáº­t
          </div>
          <div className="specs-grid">{renderSpecs()}</div>
        </div>
      )}
    </div>
  );
};

export default ProductHoverPreview;

```

### ClientApp\src\components\List\ProductPagination.jsx
```jsx
import React from "react";
import { Pagination, Box, Typography } from "@mui/material";
import { styled } from "@mui/material/styles";

const StyledPagination = styled(Pagination)(({ theme }) => ({
  "& .MuiPaginationItem-root": {
    borderRadius: "12px",
    margin: "0 4px",
    border: "1px solid transparent",
    transition: "all 0.3s ease",
    fontWeight: 500,
    minWidth: "40px",
    height: "40px",

    "&:hover": {
      backgroundColor: theme.palette.primary.main,
      color: "white",
      transform: "translateY(-2px)",
      boxShadow: "0 4px 12px rgba(99, 102, 241, 0.3)",
    },

    "&.Mui-selected": {
      backgroundColor: theme.palette.primary.main,
      color: "white",
      fontWeight: 600,
      boxShadow: "0 4px 12px rgba(99, 102, 241, 0.4)",

      "&:hover": {
        backgroundColor: theme.palette.primary.dark,
      },
    },
  },

  "& .MuiPaginationItem-ellipsis": {
    color: theme.palette.text.secondary,
  },
}));

const PaginationInfo = styled(Typography)(({ theme }) => ({
  color: theme.palette.text.secondary,
  fontSize: "0.875rem",
  fontWeight: 500,
  display: "flex",
  alignItems: "center",
  gap: "4px",
}));

const ProductPagination = ({
  currentPage,
  totalPages,
  onPageChange,
  totalProducts,
  productsPerPage = 9,
  loading = false,
}) => {
  if (loading || totalPages <= 1) {
    return null;
  }

  const startProduct = (currentPage - 1) * productsPerPage + 1;
  const endProduct = Math.min(currentPage * productsPerPage, totalProducts);

  return (
    <Box
      sx={{
        display: "flex",
        justifyContent: "space-between",
        alignItems: "center",
        flexWrap: "wrap",
        gap: 2,
        mt: 6,
        mb: 4,
        p: 3,
        bgcolor: "background.paper",
        borderRadius: 3,
        border: "1px solid",
        borderColor: "divider",
        backdropFilter: "blur(20px)",
        backgroundColor: "rgba(255, 255, 255, 0.9)",
        boxShadow: "0 4px 20px rgba(0, 0, 0, 0.05)",
      }}
    >
      {/* ThÃ´ng tin hiá»ƒn thá»‹ */}
      <PaginationInfo>
        Hiá»ƒn thá»‹ <strong>{startProduct}</strong>-<strong>{endProduct}</strong>{" "}
        trong tá»•ng sá»‘ <strong>{totalProducts}</strong> sáº£n pháº©m
      </PaginationInfo>

      {/* Pagination Controls */}
      <StyledPagination
        count={totalPages}
        page={currentPage}
        onChange={(event, page) => onPageChange(page)}
        color="primary"
        size="large"
        siblingCount={1}
        boundaryCount={1}
        showFirstButton
        showLastButton
        sx={{
          "& .MuiPaginationItem-root": {
            fontSize: "0.875rem",
          },
        }}
      />
    </Box>
  );
};

export default ProductPagination;

```

### ClientApp\src\components\Navbar\Navbar.jsx
```jsx
import React, { useState, useEffect, useRef } from "react";
import {
  ShoppingCart,
  User,
  Search,
  Scale,
  Star,
  MapPin,
  LogOut,
  ShoppingBag,
  Settings,
} from "lucide-react";
import { useNavigate, NavLink } from "react-router-dom";
import "./Navbar.css";
import { useUserProfile } from "@/hooks/api/useUserProfile";
import { useCategories } from "@/hooks/api/useCategories";
import { useBrands } from "@/hooks/api/useBrands";
import { useSearch } from "@/hooks/api/useSearch";
import menuIcon from "@/assets/icon/menu.svg";
import logo from "@/assets/img/Phone/logo.png";
import AuthModal from "@/components/Auth/AuthModal";
import CartDrawer from "@/components/shoppingcart/CartDrawer"; // Import Drawer

const Navbar = () => {
  const [searchTerm, setSearchTerm] = useState("");
  const [isDropdownProfileOpen, setIsDropdownProfileOpen] = useState(false);
  const [isDropdownOpen, setIsDropdownOpen] = useState(false);
  const [isAuthModalOpen, setIsAuthModalOpen] = useState(false);
  const [isLoggedIn, setIsLoggedIn] = useState(!!localStorage.getItem("token"));
  const [anchorEl, setAnchorEl] = useState(null);
  const searchRef = useRef(null);
  const dropdownRef = useRef(null);
  const navigate = useNavigate();
  const [isCartOpen, setIsCartOpen] = useState(false);

  // Custom hooks
  const { user, initUserId, fetchUserProfile } = useUserProfile();
  const { categories } = useCategories();
  const { brands } = useBrands();
  const { results: searchResults, loading: searchLoading, search } = useSearch();

  // Khá»Ÿi táº¡o user profile
  useEffect(() => {
    const id = initUserId();
    if (id) fetchUserProfile(id);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Debounce search
  useEffect(() => {
    const timer = setTimeout(() => {
      if (searchTerm.trim().length > 0) {
        search(searchTerm);
      }
    }, 300);
    return () => clearTimeout(timer);
  }, [searchTerm, search]);

  // ÄÃ³ng dropdown khi click bÃªn ngoÃ i
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
        setIsDropdownOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // ÄÃ³ng dropdown khi click bÃªn ngoÃ i
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (searchRef.current && !searchRef.current.contains(event.target)) {
        // setSearchResults(null); // ÄÃ£ loáº¡i bá» state nÃ y, khÃ´ng cáº§n lÃ m gÃ¬
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const handleLogout = () => {
    localStorage.removeItem("token");
    localStorage.removeItem("AvatarUrl");
    setIsLoggedIn(false);
    setAnchorEl(null);
  };
  // thanh tÃ¬m kiáº¿m
  // Gá»i API tÃ¬m kiáº¿m vá»›i debounce
  useEffect(() => {
    const timer = setTimeout(() => {
      if (searchTerm.trim().length > 0) {
        search(searchTerm);
      }
    }, 300);
    return () => clearTimeout(timer);
  }, [searchTerm, search]);

  const handleSearchSubmit = (e) => {
    e.preventDefault();
    if (searchTerm.trim()) {
      navigate(`/search?q=${encodeURIComponent(searchTerm)}`);
    }
  };

  const handleItemClick = (type, id) => {
    navigate(
      type === "product"
        ? `/product/${id}`
        : type === "category"
        ? `/ProductList?categoryId=${id}`
        : `/ProductList?brandIds=${id}`
    );
    setSearchTerm("");
  };
  return (
    <div className="navbar-wrapper">
      <nav className="navbar">
        <div className="navbar-container">
          {/* Logo */}
          <img
            src={logo}
            alt="SHN Gear"
            className="navbar-logo"
            onClick={() => navigate("/")}
            style={{ cursor: "pointer" }}
          />

          {/* Menu Premium - Giá»¯ nguyÃªn nÃºt gá»‘c */}
          <div className="menu-container relative font-sans" ref={dropdownRef}>
            {/* NÃºt menu giá»¯ nguyÃªn 100% nhÆ° thiáº¿t káº¿ cá»§a báº¡n */}
            <button
              className="menu-button"
              onClick={() => setIsDropdownOpen(!isDropdownOpen)}
            >
              <img src={menuIcon} alt="Menu" />
              Danh má»¥c
            </button>

            {isDropdownOpen && (
              <div className="dropdown-menu absolute left-0 mt-1 w-[320px] bg-white shadow-2xl rounded-lg border border-gray-100 z-50 overflow-hidden animate-fadeIn">
                {/* Header */}
                <div className="bg-gradient-to-r from-blue-50 to-purple-50 p-3 border-b border-gray-100">
                  <h3 className="text-sm font-semibold text-gray-700 flex items-center">
                    <svg
                      className="w-4 h-4 mr-2 text-purple-500"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fillRule="evenodd"
                        d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                        clipRule="evenodd"
                      />
                    </svg>
                    DANH Má»¤C Sáº¢N PHáº¨M
                  </h3>
                </div>

                {/* Content with scroll */}
                <div className="max-h-[65vh] overflow-y-auto custom-scrollbar">
                  {/* Categories Section */}
                  <div className="p-2">
                    {categories
                      .filter((c) => !c.parentId)
                      .map((category) => (
                        <div key={category.id} className="mb-1 group">
                          {/* Parent Category */}
                          <div
                            className="flex items-center justify-between px-3 py-2.5 rounded-lg hover:bg-purple-50 transition-colors cursor-pointer"
                            onClick={() =>
                              navigate(`/ProductList?categoryId=${category.id}`)
                            }
                          >
                            <div className="flex items-center">
                              <div className="w-8 h-8 flex items-center justify-center bg-blue-100 rounded-lg mr-3 text-blue-600">
                                {category.icon || (
                                  <svg
                                    className="w-4 h-4"
                                    fill="currentColor"
                                    viewBox="0 0 20 20"
                                  >
                                    <path
                                      fillRule="evenodd"
                                      d="M10 2a8 8 0 100 16 8 8 0 000-16zm0 14a6 6 0 110-12 6 6 0 010 12z"
                                      clipRule="evenodd"
                                    />
                                  </svg>
                                )}
                              </div>
                              <span className="font-medium text-gray-800">
                                {category.name}
                              </span>
                            </div>
                            {categories.some(
                              (c) => c.parentId === category.id
                            ) && (
                              <svg
                                className="w-4 h-4 text-gray-400 group-hover:text-purple-500 transition-colors"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                              >
                                <path
                                  fillRule="evenodd"
                                  d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                  clipRule="evenodd"
                                />
                              </svg>
                            )}
                          </div>

                          {/* Subcategories */}
                          {categories.some(
                            (c) => c.parentId === category.id
                          ) && (
                            <div className="ml-12 mt-1 space-y-1">
                              {categories
                                .filter((c) => c.parentId === category.id)
                                .map((subCategory) => (
                                  <div
                                    key={subCategory.id}
                                    className="px-3 py-1.5 text-sm rounded-lg hover:bg-blue-50 cursor-pointer flex items-center transition-colors"
                                    onClick={() =>
                                      navigate(
                                        `/ProductList?categoryId=${subCategory.id}`
                                      )
                                    }
                                  >
                                    <div className="w-2 h-2 bg-blue-300 rounded-full mr-2"></div>
                                    <span className="text-gray-700">
                                      {subCategory.name}
                                    </span>
                                  </div>
                                ))}
                            </div>
                          )}
                        </div>
                      ))}
                  </div>

                  {/* Brands Section */}
                  <div className="border-t border-gray-100 mx-3"></div>
                  <div className="p-3">
                    <div className="flex justify-between items-center mb-3">
                      <h4 className="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                        THÆ¯Æ NG HIá»†U
                      </h4>
                      <button
                        className="text-xs text-blue-600 hover:text-blue-800 transition-colors"
                        onClick={() => navigate("/Productlist")}
                      >
                        Xem táº¥t cáº£ â†’
                      </button>
                    </div>

                    <div className="grid grid-cols-3 gap-3">
                      {brands.slice(0, 6).map((brand) => (
                        <div
                          key={brand.id}
                          className="text-center cursor-pointer group"
                          onClick={() =>
                            navigate(`/ProductList?brandId=${brand.id}`)
                          }
                        >
                          <div className="w-full aspect-square bg-white border border-gray-200 rounded-lg flex items-center justify-center p-2 group-hover:border-blue-300 transition-all shadow-sm">
                            {brand.logo ? (
                              <img
                                src={brand.logo}
                                alt={brand.name}
                                className="w-full h-full object-contain"
                              />
                            ) : (
                              <span className="text-lg font-bold text-gray-400">
                                {brand.name.charAt(0)}
                              </span>
                            )}
                          </div>
                          <span className="block mt-2 text-xs font-medium text-gray-700 truncate px-1">
                            {brand.name}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>

                {/* Footer */}
                <div className="bg-gray-50 px-3 py-2 border-t border-gray-100 text-center">
                  <button
                    className="text-xs text-blue-600 hover:text-blue-800 font-medium transition-colors"
                    onClick={() => navigate("/productlist")}
                  >
                    Xem táº¥t cáº£ sáº£n pháº©m â†’
                  </button>
                </div>
              </div>
            )}
          </div>

          {/* ThÃªm vÃ o file CSS */}
          <style>{`
            .animate-fadeIn {
              animation: fadeIn 0.2s ease-out forwards;
            }
            @keyframes fadeIn {
              from {
                opacity: 0;
                transform: translateY(-5px);
              }
              to {
                opacity: 1;
                transform: translateY(0);
              }
            }
            .custom-scrollbar::-webkit-scrollbar {
              width: 6px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb {
              background: rgba(0, 0, 0, 0.1);
              border-radius: 3px;
            }
          `}</style>

          {/* Thanh tÃ¬m kiáº¿m (giá»¯ nguyÃªn) */}
          <div className="search-bar" ref={searchRef}>
            <form
              onSubmit={handleSearchSubmit}
              className="relative flex items-center justify-between w-full"
            >
              <input
                type="text"
                placeholder="TÃ¬m kiáº¿m sáº£n pháº©m..."
                className="search-input flex-1 px-4 py-2"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                onFocus={() => searchTerm && search(searchTerm)}
              />
              <button type="submit" className="search-button">
                <Search className="h-5 w-5" />
              </button>
            </form>

            {/* Dropdown káº¿t quáº£ - PhiÃªn báº£n tinh chá»‰nh */}
            {searchResults && (
              <div className="absolute top-full left-1/2 transform -translate-x-1/2 mt-1 bg-white shadow-lg rounded-lg border border-gray-200 z-50 w-[28rem] max-h-[70vh] overflow-y-auto">
                {searchLoading ? (
                  <div className="p-4 flex items-center justify-center text-sm text-gray-500">
                    <svg
                      className="animate-spin h-5 w-5 mr-3 text-blue-500"
                      viewBox="0 0 24 24"
                    >
                      <circle
                        className="opacity-25"
                        cx="12"
                        cy="12"
                        r="10"
                        stroke="currentColor"
                        strokeWidth="4"
                      ></circle>
                      <path
                        className="opacity-75"
                        fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                      ></path>
                    </svg>
                    Äang tÃ¬m kiáº¿m...
                  </div>
                ) : (
                  <div className="divide-y divide-gray-100">
                    {/* Sáº£n pháº©m */}
                    {searchResults.products.length > 0 && (
                      <div className="py-2">
                        <div className="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                          Sáº£n pháº©m
                        </div>
                        {searchResults.products.slice(0, 3).map((product) => (
                          <div
                            key={product.id}
                            className="px-4 py-3 hover:bg-blue-50 cursor-pointer flex items-center transition-colors duration-150"
                            onClick={() =>
                              handleItemClick("product", product.id)
                            }
                          >
                            <div className="flex-shrink-0 w-10 h-10 bg-gray-100 rounded-md overflow-hidden">
                              <img
                                src={
                                  product.imageUrl?.startsWith("http")
                                    ? product.imageUrl
                                    : `${process.env.REACT_APP_API_BASE_URL}${
                                        product.imageUrl?.startsWith("/")
                                          ? ""
                                          : "/"
                                      }${product.imageUrl}`
                                }
                                alt={product.name}
                                className="w-full h-full object-contain"
                                onError={(e) => {
                                  e.target.onerror = null;
                                  e.target.src = "/images/default-product.png";
                                }}
                              />
                            </div>
                            <div className="ml-3 min-w-0">
                              <p className="text-sm font-medium text-gray-800 truncate">
                                {product.name}
                              </p>
                              <div className="flex items-center mt-1">
                                <span className="text-sm font-semibold text-blue-600">
                                  {product.price.toLocaleString("vi-VN")}Ä‘
                                </span>
                                {product.discountedPrice && (
                                  <span className="ml-2 text-xs text-gray-400 line-through">
                                    {product.discountedPrice.toLocaleString(
                                      "vi-VN"
                                    )}
                                    Ä‘
                                  </span>
                                )}
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}

                    {/* Danh má»¥c */}
                    {searchResults.categories.length > 0 && (
                      <div className="py-2">
                        <div className="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                          Danh má»¥c
                        </div>
                        {searchResults.categories
                          .slice(0, 3)
                          .map((category) => (
                            <div
                              key={category.id}
                              className="px-4 py-3 hover:bg-blue-50 cursor-pointer flex items-center transition-colors duration-150"
                              onClick={() =>
                                handleItemClick("category", category.id)
                              }
                            >
                              <div className="flex-shrink-0 w-10 h-10 bg-blue-50 rounded-md flex items-center justify-center">
                                <svg
                                  className="w-5 h-5 text-blue-500"
                                  fill="none"
                                  stroke="currentColor"
                                  viewBox="0 0 24 24"
                                >
                                  <path
                                    strokeLinecap="round"
                                    strokeWidth="2"
                                    d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                                  ></path>
                                </svg>
                              </div>
                              <div className="ml-3">
                                <p className="text-sm font-medium text-gray-800">
                                  {category.name}
                                </p>
                              </div>
                            </div>
                          ))}
                      </div>
                    )}

                    {/* ThÆ°Æ¡ng hiá»‡u */}
                    {searchResults.brands.length > 0 && (
                      <div className="py-2">
                        <div className="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                          ThÆ°Æ¡ng hiá»‡u
                        </div>
                        {searchResults.brands.slice(0, 3).map((brand) => (
                          <div
                            key={brand.id}
                            className="px-4 py-3 hover:bg-blue-50 cursor-pointer flex items-center transition-colors duration-150"
                            onClick={() => handleItemClick("brand", brand.id)}
                          >
                            <div className="flex-shrink-0 w-10 h-10 bg-gray-100 rounded-md overflow-hidden flex items-center justify-center">
                              {brand.logoUrl ? (
                                <img
                                  src={brand.logoUrl}
                                  alt={brand.name}
                                  className="w-full h-full object-contain"
                                />
                              ) : (
                                <span className="text-lg font-bold text-gray-400">
                                  {brand.name.charAt(0)}
                                </span>
                              )}
                            </div>
                            <div className="ml-3">
                              <p className="text-sm font-medium text-gray-800">
                                {brand.name}
                              </p>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}

                    {/* Footer */}
                    {searchResults.products.length > 0 ||
                    searchResults.categories.length > 0 ||
                    searchResults.brands.length > 0 ? (
                      <div className="p-3 text-center bg-gray-50">
                        <button
                          className="text-sm text-blue-600 hover:text-blue-800 font-medium"
                          onClick={() => {
                            navigate(`/productlist`);
                          }}
                        >
                          Xem táº¥t cáº£ {searchResults.totalResults} káº¿t quáº£ â†’
                        </button>
                      </div>
                    ) : (
                      <div className="p-6 text-center">
                        <svg
                          className="mx-auto h-12 w-12 text-gray-400"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeWidth="1.5"
                            d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                          ></path>
                        </svg>
                        <h3 className="mt-2 text-sm font-medium text-gray-700">
                          KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£
                        </h3>
                        <p className="mt-1 text-sm text-gray-500">
                          Thá»­ vá»›i tá»« khÃ³a tÃ¬m kiáº¿m khÃ¡c
                        </p>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}
          </div>
          {/* Avatar vÃ  Giá» hÃ ng */}
          <div className="avatarandcart">
            {/* Avatar vÃ  Giá» hÃ ng */}
            <div className="flex items-center gap-4">
              {isLoggedIn ? (
                <div className="relative">
                  <button
                    onClick={() =>
                      setIsDropdownProfileOpen(!isDropdownProfileOpen)
                    }
                    className="p-1 rounded-full hover:bg-white hover:bg-opacity-20 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50"
                    aria-label="Menu ngÆ°á»i dÃ¹ng"
                    aria-haspopup="true"
                    aria-expanded={!!anchorEl}
                  >
                    <User className="w-8 h-8 text-white" />
                  </button>

                  {isDropdownProfileOpen && (
                    <div className="absolute right-0 mt-2 w-56 origin-top-right bg-white rounded-lg shadow-xl z-50 overflow-hidden transition-all duration-200 ease-out">
                      <div className="py-1 flex flex-col">
                        <div className="px-4 py-3 border-b border-gray-100">
                          <p className="text-sm font-medium text-gray-900">
                            Xin chÃ o, {user?.fullName || "KhÃ¡ch"}
                          </p>
                          <p className="text-xs text-gray-500 truncate">
                            {user?.email || "user@example.com"}
                          </p>
                        </div>
                        {/* ThÃªm Ä‘iá»u kiá»‡n hiá»ƒn thá»‹ cho admin */}
                        {user?.role?.id === 1 && (
                          <NavLink
                            to="/admin/overview"
                            className={({ isActive }) =>
                              `px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors flex items-center${isActive ? ' bg-blue-50 text-blue-600' : ''}`
                            }
                          >
                            <Settings className="w-4 h-4 mr-3" />
                            Trang quáº£n trá»‹
                          </NavLink>
                        )}
                        <NavLink
                          to="/profile/info"
                          className={({ isActive }) =>
                            `px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors flex items-center${isActive ? ' bg-blue-50 text-blue-600' : ''}`
                          }
                        >
                          <User className="w-4 h-4 mr-3" />
                          ThÃ´ng tin cÃ¡ nhÃ¢n
                        </NavLink>

                        <NavLink
                          to="/profile/orders"
                          className={({ isActive }) =>
                            `px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors flex items-center${isActive ? ' bg-blue-50 text-blue-600' : ''}`
                          }
                        >
                          <ShoppingBag className="w-4 h-4 mr-3" />
                          ÄÆ¡n hÃ ng cá»§a tÃ´i
                        </NavLink>

                        <NavLink
                          to="/profile/loyalty"
                          className={({ isActive }) =>
                            `px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors flex items-center${isActive ? ' bg-blue-50 text-blue-600' : ''}`
                          }
                        >
                          <Star className="w-4 h-4 mr-3" />
                          KhÃ¡ch hÃ ng thÃ¢n thiáº¿t
                        </NavLink>

                        <NavLink
                          to="/profile/address"
                          className={({ isActive }) =>
                            `px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors flex items-center${isActive ? ' bg-blue-50 text-blue-600' : ''}`
                          }
                        >
                          <MapPin className="w-4 h-4 mr-3" />
                          Sá»• Ä‘á»‹a chá»‰
                        </NavLink>

                        <NavLink
                          to="/"
                          onClick={() => {
                            handleLogout();
                          }}
                          className="px-4 py-3 text-sm text-red-600 hover:bg-red-50 transition-colors flex items-center mt-1 border-t border-gray-100"
                        >
                          <LogOut className="w-4 h-4 mr-3" />
                          ÄÄƒng xuáº¥t
                        </NavLink>
                      </div>
                    </div>
                  )}
                </div>
              ) : (
                <button
                  onClick={() => setIsAuthModalOpen(true)}
                  className="p-1 rounded-full hover:bg-white hover:bg-opacity-20 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50"
                  aria-label="ÄÄƒng nháº­p"
                >
                  <User className="w-8 h-8 text-white" />
                </button>
              )}
            </div>
            <button className="cart-button" onClick={() => setIsCartOpen(true)}>
              <ShoppingCart size={22} />
              Giá» HÃ ng
            </button>
          </div>
        </div>

        {/* Modal Ä‘Äƒng nháº­p */}
        <AuthModal
          isOpen={isAuthModalOpen}
          onClose={() => setIsAuthModalOpen(false)}
        />
        <CartDrawer isOpen={isCartOpen} onClose={() => setIsCartOpen(false)} />
      </nav>
    </div>
  );
};

export default Navbar;

```

### ClientApp\src\components\NotificationBar\notification.jsx
```jsx
import React from 'react';
import './notification.css'; // Äáº£m báº£o báº¡n import file CSS náº¿u chÆ°a

const Notification = () => {
  return (
    <div className="notification-container">
      <nav>
        <ul className="items-center pc:flex">
          <li className="pr-4">
            <div className="flex cursor-pointer items-center b2-medium">
              <img 
                alt="Deal chá»›p nhoÃ¡ng" 
                loading="lazy" 
                width="32" 
                height="32" 
                decoding="async" 
                data-nimg="1" 
                className="mr-2" 
                srcSet="https://cdn2.fptshop.com.vn/unsafe/32x0/filters:quality(100)/7_Deal_Chong_Deal_652fe1f961.png 1x, https://cdn2.fptshop.com.vn/unsafe/64x0/filters:quality(100)/7_Deal_Chong_Deal_652fe1f961.png 2x" 
                src="https://cdn2.fptshop.com.vn/unsafe/64x0/filters:quality(100)/7_Deal_Chong_Deal_652fe1f961.png"
              />
              Deal chá»›p nhoÃ¡ng
            </div>
          </li>
          <li className="pr-4">
            <a className="flex items-center b2-medium" href="https://localhost:44479/ProductList?brandId=1">
              <img 
                alt="Xáº£ kho giÃ¡ sá»‘c, sá»‘ lÆ°á»£ng cÃ³ háº¡n!" 
                loading="lazy" 
                width="32" 
                height="32" 
                decoding="async" 
                data-nimg="1" 
                className="mr-2" 
                srcSet="https://cdn2.fptshop.com.vn/unsafe/32x0/filters:quality(100)/soc_2f6cbf28ff.png 1x, https://cdn2.fptshop.com.vn/unsafe/64x0/filters:quality(100)/soc_2f6cbf28ff.png 2x" 
                src="https://cdn2.fptshop.com.vn/unsafe/64x0/filters:quality(100)/soc_2f6cbf28ff.png"
              />
              Xáº£ kho giÃ¡ sá»‘c, sá»‘ lÆ°á»£ng cÃ³ háº¡n!
            </a>
          </li>
        </ul>
      </nav>
    </div>
  );
}

export default Notification;

```

### ClientApp\src\components\Order\OrderLookup.jsx
```jsx
import React, { useState } from "react";
import { useNavigate } from "react-router-dom";
import {
  Box,
  TextField,
  Button,
  Typography,
  Paper,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  CircularProgress,
  Alert,
  Card,
  CardContent,
  Divider,
  Stack,
  Chip,
} from "@mui/material";
import SearchIcon from "@mui/icons-material/Search";
import PrintIcon from "@mui/icons-material/Print";
import VisibilityIcon from "@mui/icons-material/Visibility";
import { useOrderLookup } from "@/hooks/api/useOrderLookup";
import { motion } from "framer-motion";

const OrderLookup = () => {
  const [phoneNumber, setPhoneNumber] = useState("");
  const { orders, loading, error, searchOrdersByPhone } = useOrderLookup();
  const navigate = useNavigate();

  const handleSearch = () => {
    searchOrdersByPhone(phoneNumber);
  };

  const getStatusLabel = (status) => {
    switch (status) {
      case "Pending":
        return "Chá» xÃ¡c nháº­n";
      case "Processing":
        return "ÄÃ£ xÃ¡c nháº­n";
      case "Shipped":
        return "Äang váº­n chuyá»ƒn";
      case "Delivered":
        return "ÄÃ£ giao hÃ ng";
      case "Cancelled":
        return "ÄÃ£ há»§y";
      case "Paid":
        return "ÄÃ£ thanh toÃ¡n";
      default:
        return status;
    }
  };

  const getStatusColor = (status) => {
    switch (status) {
      case "Delivered":
        return "success";
      case "Shipped":
        return "info";
      case "Processing":
        return "warning";
      case "Cancelled":
        return "error";
      case "Paid":
        return "success";
      default:
        return "default";
    }
  };

  const formatPrice = (price) => {
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
    }).format(price);
  };

  return (
    <Box sx={{ maxWidth: 1200, mx: "auto", p: 3 }}>
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.3 }}
      >
        <Paper elevation={3} sx={{ p: 4, mb: 4, borderRadius: 2 }}>
          <Typography
            variant="h5"
            gutterBottom
            sx={{ fontWeight: "bold", mb: 3 }}
          >
            Tra cá»©u Ä‘Æ¡n hÃ ng
          </Typography>

          <Stack
            direction={{ xs: "column", sm: "row" }}
            spacing={2}
            alignItems="center"
            mb={3}
          >
            <TextField
              fullWidth
              label="Nháº­p sá»‘ Ä‘iá»‡n thoáº¡i"
              variant="outlined"
              value={phoneNumber}
              onChange={(e) => setPhoneNumber(e.target.value)}
              placeholder="VÃ­ dá»¥: 0778706084"
              InputProps={{
                startAdornment: (
                  <SearchIcon sx={{ color: "action.active", mr: 1 }} />
                ),
              }}
              sx={{ flex: 1 }}
            />
            <Button
              variant="contained"
              onClick={handleSearch}
              disabled={loading}
              sx={{ height: 56, px: 4, minWidth: 150 }}
              startIcon={
                loading ? <CircularProgress size={20} color="inherit" /> : null
              }
            >
              {loading ? "Äang tÃ¬m..." : "Tra cá»©u"}
            </Button>
          </Stack>

          {error && (
            <Alert severity="error" sx={{ mb: 3 }}>
              {error}
            </Alert>
          )}
        </Paper>

        {orders.length > 0 && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ duration: 0.5 }}
          >
            <Typography variant="h6" sx={{ mb: 2, fontWeight: "bold" }}>
              Káº¿t quáº£ tra cá»©u ({orders.length} Ä‘Æ¡n hÃ ng)
            </Typography>

            {orders.map((order) => (
              <Card key={order.orderId} sx={{ mb: 4, boxShadow: 3 }}>
                <CardContent>
                  <Box
                    sx={{
                      display: "flex",
                      justifyContent: "space-between",
                      alignItems: "center",
                      mb: 2,
                    }}
                  >
                    <Typography variant="h6" sx={{ fontWeight: "bold" }}>
                      ÄÆ¡n hÃ ng #{order.orderId}
                    </Typography>
                    <Chip
                      label={getStatusLabel(order.orderStatus)}
                      color={getStatusColor(order.orderStatus)}
                      sx={{ fontWeight: "bold" }}
                    />
                  </Box>

                  <Divider sx={{ my: 2 }} />

                  <Box
                    sx={{ display: "flex", flexWrap: "wrap", gap: 3, mb: 3 }}
                  >
                    <Box>
                      <Typography variant="body2" color="text.secondary">
                        NgÃ y Ä‘áº·t:
                      </Typography>
                      <Typography>{order.orderDate}</Typography>
                    </Box>
                    <Box>
                      <Typography variant="body2" color="text.secondary">
                        Dá»± kiáº¿n giao:
                      </Typography>
                      <Typography>{order.estimatedDelivery}</Typography>
                    </Box>
                    <Box>
                      <Typography variant="body2" color="text.secondary">
                        Tá»•ng tiá»n:
                      </Typography>
                      <Typography sx={{ fontWeight: "bold" }}>
                        {order.formattedTotal}
                      </Typography>
                    </Box>
                    <Box>
                      <Typography variant="body2" color="text.secondary">
                        PhÆ°Æ¡ng thá»©c:
                      </Typography>
                      <Typography>{order.paymentMethod}</Typography>
                    </Box>
                  </Box>

                  <Box sx={{ mb: 3 }}>
                    <Typography
                      variant="subtitle2"
                      color="text.secondary"
                      gutterBottom
                    >
                      ThÃ´ng tin giao hÃ ng:
                    </Typography>
                    <Box sx={{ pl: 2 }}>
                      <Typography>
                        <strong>{order.shippingInfo.fullName}</strong> |{" "}
                        {order.shippingInfo.phone}
                      </Typography>
                      <Typography sx={{ mb: 1 }}>
                        {order.shippingInfo.address}
                      </Typography>
                      <Typography>Email: {order.shippingInfo.email}</Typography>
                    </Box>
                  </Box>

                  <Typography
                    variant="subtitle2"
                    color="text.secondary"
                    gutterBottom
                  >
                    Sáº£n pháº©m Ä‘Ã£ Ä‘áº·t:
                  </Typography>
                  <TableContainer>
                    <Table size="small">
                      <TableHead>
                        <TableRow>
                          <TableCell>Sáº£n pháº©m</TableCell>
                          <TableCell align="center">Biáº¿n thá»ƒ</TableCell>
                          <TableCell align="right">Sá»‘ lÆ°á»£ng</TableCell>
                          <TableCell align="right">ÄÆ¡n giÃ¡</TableCell>
                          <TableCell align="right">ThÃ nh tiá»n</TableCell>
                        </TableRow>
                      </TableHead>
                      <TableBody>
                        {order.products.map((product, index) => (
                          <TableRow key={index}>
                            <TableCell>
                              <Box
                                sx={{ display: "flex", alignItems: "center" }}
                              >
                                <Box
                                  component="img"
                                  src={
                                    product.image.startsWith("http")
                                      ? product.image // áº¢nh tá»« API (URL Ä‘áº§y Ä‘á»§)
                                      : `${process.env.REACT_APP_API_BASE_URL}/${product.image}` // áº¢nh local trong wwwroot
                                  }
                                  alt={product.name || "áº¢nh sáº£n pháº©m"}
                                  sx={{
                                    width: 60,
                                    height: 60,
                                    objectFit: "contain",
                                    mr: 2,
                                    borderRadius: 1,
                                    backgroundColor: "grey.100",
                                  }}
                                />
                                <Typography>{product.name}</Typography>
                              </Box>
                            </TableCell>
                            <TableCell align="center">
                              <Chip label={product.variant} size="small" />
                            </TableCell>
                            <TableCell align="right">
                              {product.quantity}
                            </TableCell>
                            <TableCell align="right">
                              {formatPrice(product.price)}
                            </TableCell>
                            <TableCell align="right">
                              <Typography fontWeight="bold">
                                {formatPrice(product.total)}
                              </Typography>
                            </TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </TableContainer>

                  <Box
                    sx={{ display: "flex", justifyContent: "flex-end", mt: 3 }}
                  >
                    <Button
                      variant="outlined"
                      startIcon={<VisibilityIcon />}
                      onClick={() => navigate(`/orders/${order.orderId}`)}
                      sx={{ mr: 2 }}
                    >
                      Xem chi tiáº¿t
                    </Button>
                    <Button
                      variant="contained"
                      startIcon={<PrintIcon />}
                      onClick={() => window.print()}
                    >
                      In hÃ³a Ä‘Æ¡n
                    </Button>
                  </Box>
                </CardContent>
              </Card>
            ))}
          </motion.div>
        )}
      </motion.div>
    </Box>
  );
};

export default OrderLookup;

```

### ClientApp\src\components\Order\PaymentSuccess.jsx
```jsx
import React, { useEffect, useState } from "react";
import { Box, Typography, Button, Container, Stack } from "@mui/material";
import { motion } from "framer-motion";
import CheckCircleOutlineIcon from "@mui/icons-material/CheckCircleOutline";
import SearchIcon from "@mui/icons-material/Search";
import { useNavigate, useLocation } from "react-router-dom";

const PaymentSuccess = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const [orderDetails, setOrderDetails] = useState(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const fetchOrderDetails = async () => {
      try {
        const searchParams = new URLSearchParams(location.search);
        const orderId = searchParams.get("orderId");

        if (!orderId) {
          console.error("No order ID provided");
          return;
        }

        const response = await fetch(`/api/Order/${orderId}`);
        if (!response.ok) throw new Error("Failed to fetch order details");

        const data = await response.json();
        setOrderDetails(data);
      } catch (error) {
        console.error("Error fetching order details:", error);
      } finally {
        setIsLoading(false);
      }
    };

    fetchOrderDetails();
  }, [location]);

  // Loading state
  if (isLoading) {
    return (
      <Container maxWidth="sm" sx={{ mt: 8, textAlign: "center" }}>
        <Typography>Äang táº£i thÃ´ng tin Ä‘Æ¡n hÃ ng...</Typography>
      </Container>
    );
  }

  return (
    <Container maxWidth="sm" sx={{ mt: 8 }}>
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.5 }}
      >
        <Box
          sx={{
            display: "flex",
            flexDirection: "column",
            alignItems: "center",
            textAlign: "center",
            p: 4,
            borderRadius: 2,
            boxShadow: 3,
            backgroundColor: "background.paper",
          }}
        >
          {/* Icon thÃ nh cÃ´ng */}
          <motion.div
            animate={{ scale: [1, 1.1, 1] }}
            transition={{ duration: 0.5 }}
          >
            <CheckCircleOutlineIcon
              sx={{ fontSize: 80, color: "success.main", mb: 2 }}
            />
          </motion.div>

          {/* TiÃªu Ä‘á» */}
          <Typography
            variant="h4"
            component="h1"
            gutterBottom
            sx={{ fontWeight: "bold" }}
          >
            Thanh toÃ¡n thÃ nh cÃ´ng!
          </Typography>

          {/* ThÃ´ng bÃ¡o */}
          <Typography variant="body1" color="text.secondary" sx={{ mb: 3 }}>
            Cáº£m Æ¡n báº¡n Ä‘Ã£ mua hÃ ng. ÄÆ¡n hÃ ng cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c nháº­n vÃ  sáº½ Ä‘Æ°á»£c
            xá»­ lÃ½ trong thá»i gian sá»›m nháº¥t.
          </Typography>

          {/* Chi tiáº¿t Ä‘Æ¡n hÃ ng giáº£ láº­p */}
          <Box
            sx={{
              width: "100%",
              p: 2,
              mb: 3,
              borderRadius: 1,
              backgroundColor: "grey.100",
              textAlign: "left",
            }}
          >
            <Typography variant="subtitle1" sx={{ mb: 1 }}>
              ThÃ´ng tin Ä‘Æ¡n hÃ ng:
            </Typography>
            {orderDetails && (
              <>
                <Typography variant="body2" sx={{ mb: 1 }}>
                  MÃ£ Ä‘Æ¡n hÃ ng: #{orderDetails.id}
                </Typography>
                <Typography variant="body2" sx={{ mb: 1 }}>
                  Tá»•ng tiá»n:{" "}
                  {new Intl.NumberFormat("vi-VN", {
                    style: "currency",
                    currency: "VND",
                  }).format(orderDetails.totalAmount)}
                </Typography>
                <Typography variant="body2">
                  Tráº¡ng thÃ¡i:{" "}
                  {orderDetails.orderStatus === "Paid"
                    ? "ÄÃ£ thanh toÃ¡n"
                    : orderDetails.orderStatus}
                </Typography>
              </>
            )}
          </Box>

          {/* NÃºt hÃ nh Ä‘á»™ng */}
          <Stack
            direction="row"
            spacing={2}
            sx={{ width: "100%", justifyContent: "center" }}
          >
            <motion.div whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>
              <Button
                variant="outlined"
                size="large"
                startIcon={<SearchIcon />}
                onClick={() => navigate("/order-lookup")}
                sx={{
                  px: 4,
                  py: 1.5,
                  borderRadius: 2,
                  fontWeight: "bold",
                  textTransform: "none",
                }}
              >
                Tra cá»©u Ä‘Æ¡n hÃ ng
              </Button>
            </motion.div>

            <motion.div whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>
              <Button
                variant="contained"
                size="large"
                onClick={() => navigate("/")}
                sx={{
                  px: 4,
                  py: 1.5,
                  borderRadius: 2,
                  fontWeight: "bold",
                  textTransform: "none",
                }}
              >
                Vá» trang chá»§
              </Button>
            </motion.div>
          </Stack>

          {/* ThÃ´ng bÃ¡o phá»¥ */}
          <Typography variant="caption" color="text.secondary" sx={{ mt: 3 }}>
            Báº¡n sáº½ nháº­n Ä‘Æ°á»£c email xÃ¡c nháº­n Ä‘Æ¡n hÃ ng trong Ã­t phÃºt.
          </Typography>
        </Box>
      </motion.div>
    </Container>
  );
};

export default PaymentSuccess;

```

### ClientApp\src\components\PaymentSuccess\PaymentSuccess.jsx
```jsx
import React, { useEffect, useState } from "react";
import {
  Box,
  Typography,
  Button,
  List,
  ListItem,
  ListItemText,
  ListItemAvatar,
  Divider,
  Paper,
  Grid,
  Alert,
} from "@mui/material";
import { CheckCircle, Search, Home } from "@mui/icons-material";
import { useLocation, useNavigate } from "react-router-dom";

const PaymentSuccess = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const [orderData, setOrderData] = useState(null);

  useEffect(() => {
    // Láº¥y dá»¯ liá»‡u tá»« state hoáº·c localStorage
    const stateData = location.state;
    const localStorageData = localStorage.getItem("currentOrder");

    if (stateData) {
      setOrderData(stateData);
    } else if (localStorageData) {
      try {
        const parsedData = JSON.parse(localStorageData);
        setOrderData(parsedData);
        // XÃ³a dá»¯ liá»‡u khá»i localStorage sau khi sá»­ dá»¥ng
        localStorage.removeItem("currentOrder");
      } catch (error) {
        console.error("Lá»—i khi parse dá»¯ liá»‡u localStorage:", error);
      }
    }
  }, [location.state]);

  const handleTrackOrder = () => {
    if (orderData?.orderId) {
      navigate(`/order-tracking/${orderData.orderId}`);
    }
  };

  const handleGoHome = () => {
    navigate("/");
  };

  if (!orderData) {
    return (
      <Box sx={{ p: 4, textAlign: "center" }}>
        <Alert severity="warning">KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin Ä‘Æ¡n hÃ ng</Alert>
        <Button variant="contained" onClick={handleGoHome} sx={{ mt: 2 }}>
          Vá» trang chá»§
        </Button>
      </Box>
    );
  }

  return (
    <Box sx={{ p: 4, maxWidth: 800, margin: "0 auto" }}>
      <Paper sx={{ p: 4, textAlign: "center" }}>
        <CheckCircle sx={{ fontSize: 80, color: "success.main", mb: 2 }} />

        <Typography variant="h4" sx={{ fontWeight: "bold", mb: 2 }}>
          Äáº·t HÃ ng thÃ nh cÃ´ng!
        </Typography>

        <Typography variant="body1" color="text.secondary" sx={{ mb: 4 }}>
          Cáº£m Æ¡n báº¡n Ä‘Ã£ mua hÃ ng. ÄÆ¡n hÃ ng cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c nháº­n vÃ  sáº½ Ä‘Æ°á»£c
          xá»­ lÃ½ trong thá»i gian sá»›m nháº¥t.
        </Typography>

        <Box sx={{ mb: 4, textAlign: "left" }}>
          <Typography variant="h6" sx={{ fontWeight: "bold", mb: 2 }}>
            ThÃ´ng tin Ä‘Æ¡n hÃ ng:
          </Typography>

          <Grid container spacing={2} sx={{ mb: 3 }}>
            <Grid item xs={6}>
              <Typography variant="body2" color="text.secondary">
                MÃ£ Ä‘Æ¡n hÃ ng:
              </Typography>
              <Typography variant="body1" sx={{ fontWeight: "bold" }}>
                #{orderData.orderId}
              </Typography>
            </Grid>
            <Grid item xs={6}>
              <Typography variant="body2" color="text.secondary">
                PhÆ°Æ¡ng thá»©c thanh toÃ¡n:
              </Typography>
              <Typography variant="body1" sx={{ fontWeight: "bold" }}>
                {orderData.paymentMethodName}
              </Typography>
            </Grid>
          </Grid>

          {/* Danh sÃ¡ch sáº£n pháº©m */}
          <Typography variant="h6" sx={{ fontWeight: "bold", mb: 2 }}>
            Sáº£n pháº©m Ä‘Ã£ mua:
          </Typography>

          <List sx={{ mb: 3 }}>
            {orderData.orderItems?.map((item, index) => (
              <ListItem key={index} sx={{ px: 0, py: 1 }}>
                <ListItemAvatar>
                  <img
                    src={
                      item.productImage?.startsWith("http")
                        ? item.productImage
                        : `${process.env.REACT_APP_API_BASE_URL}/${item.productImage}`
                    }
                    alt={item.productName}
                    style={{
                      width: 60,
                      height: 60,
                      objectFit: "cover",
                      borderRadius: 8,
                    }}
                    onError={(e) => {
                      e.target.onerror = null;
                      e.target.src = "https://via.placeholder.com/60";
                    }}
                  />
                </ListItemAvatar>
                <ListItemText
                  primary={
                    <Typography variant="body1" sx={{ fontWeight: "bold" }}>
                      {item.productName}
                    </Typography>
                  }
                  secondary={
                    <Box>
                      <Typography variant="body2" color="text.secondary">
                        {item.variantColor} - {item.variantStorage}
                      </Typography>
                      <Typography variant="body2" color="text.secondary">
                        Sá»‘ lÆ°á»£ng: {item.quantity}
                      </Typography>
                    </Box>
                  }
                />
                <Typography variant="body1" sx={{ fontWeight: "bold" }}>
                  {(
                    item.productDiscountPrice || item.productPrice
                  )?.toLocaleString()}
                  â‚«
                </Typography>
              </ListItem>
            ))}
          </List>

          <Divider sx={{ my: 2 }} />

          {/* Tá»•ng káº¿t thanh toÃ¡n */}
          <Box sx={{ mb: 2 }}>
            <Box
              sx={{ display: "flex", justifyContent: "space-between", mb: 1 }}
            >
              <Typography>Táº¡m tÃ­nh:</Typography>
              <Typography>
                {(
                  (orderData.totalAmount || 0) + (orderData.discountAmount || 0)
                ).toLocaleString()}
                â‚«
              </Typography>
            </Box>

            {orderData.discountAmount > 0 && (
              <>
                <Box
                  sx={{
                    display: "flex",
                    justifyContent: "space-between",
                    mb: 1,
                  }}
                >
                  <Typography>
                    MÃ£ giáº£m giÃ¡ ({orderData.voucherCode}):
                  </Typography>
                  <Typography color="success.main">
                    -{orderData.discountAmount.toLocaleString()}â‚«
                  </Typography>
                </Box>
              </>
            )}

            <Divider sx={{ my: 1 }} />

            <Box sx={{ display: "flex", justifyContent: "space-between" }}>
              <Typography variant="h6" sx={{ fontWeight: "bold" }}>
                Tá»•ng cá»™ng:
              </Typography>
              <Typography
                variant="h6"
                sx={{ fontWeight: "bold", color: "error.main" }}
              >
                {(
                  orderData.finalAmount ||
                  orderData.totalAmount ||
                  0
                ).toLocaleString()}
                â‚«
              </Typography>
            </Box>
          </Box>
        </Box>

        <Box sx={{ display: "flex", gap: 2, justifyContent: "center" }}>
          <Button
            variant="outlined"
            startIcon={<Search />}
            onClick={handleTrackOrder}
            size="large"
          >
            Tra cá»©u Ä‘Æ¡n hÃ ng
          </Button>
          <Button
            variant="contained"
            startIcon={<Home />}
            onClick={handleGoHome}
            size="large"
          >
            Vá» trang chá»§
          </Button>
        </Box>

        <Typography variant="body2" color="text.secondary" sx={{ mt: 3 }}>
          Báº¡n sáº½ nháº­n Ä‘Æ°á»£c email xÃ¡c nháº­n Ä‘Æ¡n hÃ ng trong Ã­t phÃºt.
        </Typography>
      </Paper>
    </Box>
  );
};

export default PaymentSuccess;

```

### ClientApp\src\components\ProductInfoPage\ProductImage.jsx
```jsx
import React, { useState } from "react";
import {
  Box,
  IconButton,
  Dialog,
  Fade,
  Typography,
  Paper,
} from "@mui/material";
import { Swiper, SwiperSlide } from "swiper/react";
import { Navigation, Thumbs, Zoom, EffectFade } from "swiper/modules";
import { ChevronLeft, ChevronRight, Maximize2, X } from "lucide-react";
import "swiper/css";
import "swiper/css/navigation";
import "swiper/css/thumbs";
import "swiper/css/zoom";
import "swiper/css/effect-fade";

const ProductImage = ({ images, name }) => {
  const [thumbsSwiper, setThumbsSwiper] = useState(null);
  const [isFullscreen, setIsFullscreen] = useState(false);
  const [activeIndex, setActiveIndex] = useState(0);
  const [showControls, setShowControls] = useState(false);

  const handleFullscreen = () => setIsFullscreen(true);
  const closeFullscreen = () => setIsFullscreen(false);

  return (
    <Box
      sx={{
        position: "relative",
        "&:hover .image-controls": {
          opacity: 1,
        },
      }}
      onMouseEnter={() => setShowControls(true)}
      onMouseLeave={() => setShowControls(false)}
    >
      {/* Main Image Slider */}
      <Paper
        elevation={0}
        sx={{
          borderRadius: 3,
          overflow: "hidden",
          bgcolor: "white",
          position: "relative",
          border: "1px solid #e0e0e0", // Subtle border
        }}
      >
        <Swiper
          modules={[Navigation, Thumbs, Zoom, EffectFade]}
          effect="fade"
          navigation={{
            prevEl: ".swiper-button-prev",
            nextEl: ".swiper-button-next",
          }}
          thumbs={{ swiper: thumbsSwiper }}
          zoom={true}
          onSlideChange={(swiper) => setActiveIndex(swiper.activeIndex)}
          className="product-main-slider"
        >
          {images.map((image, index) => (
            <SwiperSlide key={index}>
              <Box
                sx={{
                  position: "relative",
                  paddingTop: "100%",
                  cursor: "zoom-in",
                  bgcolor: "#f8f8f8",
                }}
              >
                <Fade in timeout={500}>
                  <Box
                    component="img"
                    src={
                      image?.imageUrl?.startsWith("http")
                        ? image.imageUrl
                        : `${process.env.REACT_APP_API_BASE_URL}/${image.imageUrl}`
                    }
                    alt={`${name} - HÃ¬nh ${index + 1}`}
                    sx={{
                      position: "absolute",
                      top: 0,
                      left: 0,
                      width: "100%",
                      height: "100%",
                      objectFit: "contain",
                      padding: 2,
                      transition: "transform 0.3s ease",
                      "&:hover": {
                        transform: "scale(1.05)",
                      },
                    }}
                    onError={(e) => {
                      e.target.onerror = null;
                      e.target.src =
                        "https://via.placeholder.com/400?text=No+Image";
                    }}
                    onClick={handleFullscreen}
                  />
                </Fade>
              </Box>
            </SwiperSlide>
          ))}
        </Swiper>

        {/* Image Controls */}
        <Fade in={showControls}>
          <Box
            className="image-controls"
            sx={{ opacity: 0, transition: "opacity 0.3s ease" }}
          >
            <IconButton
              className="swiper-button-prev"
              sx={{
                position: "absolute",
                left: 16,
                top: "50%",
                transform: "translateY(-50%)",
                zIndex: 2,
                bgcolor: "rgba(255,255,255,0.9)",
                boxShadow: "0 2px 8px rgba(0,0,0,0.1)",
                "&:hover": {
                  bgcolor: "rgba(255,255,255,1)",
                  transform: "translateY(-50%) scale(1.1)",
                },
                transition: "all 0.3s ease",
                color: "#d32f2f", // Added color
              }}
            >
              <ChevronLeft />
            </IconButton>
            <IconButton
              className="swiper-button-next"
              sx={{
                position: "absolute",
                right: 16,
                top: "50%",
                transform: "translateY(-50%)",
                zIndex: 2,
                bgcolor: "rgba(255,255,255,0.9)",
                boxShadow: "0 2px 8px rgba(0,0,0,0.1)",
                "&:hover": {
                  bgcolor: "rgba(255,255,255,1)",
                  transform: "translateY(-50%) scale(1.1)",
                },
                transition: "all 0.3s ease",
                color: "#d32f2f", // Added color
              }}
            >
              <ChevronRight />
            </IconButton>
            <IconButton
              onClick={handleFullscreen}
              sx={{
                position: "absolute",
                right: 16,
                top: 16,
                zIndex: 2,
                bgcolor: "rgba(255,255,255,0.9)",
                boxShadow: "0 2px 8px rgba(0,0,0,0.1)",
                "&:hover": {
                  bgcolor: "rgba(255,255,255,1)",
                  transform: "scale(1.1)",
                },
                transition: "all 0.3s ease",
                color: "#d32f2f", // Added color
              }}
            >
              <Maximize2 size={20} />
            </IconButton>
          </Box>
        </Fade>

        {/* Image Counter */}
        <Box
          sx={{
            position: "absolute",
            bottom: 16,
            right: 16,
            zIndex: 2,
            bgcolor: "rgba(0,0,0,0.6)",
            color: "white",
            px: 1.5,
            py: 0.5,
            borderRadius: 2,
            fontSize: "0.875rem",
          }}
        >
          {activeIndex + 1}/{images.length}
        </Box>
      </Paper>

      {/* Thumbnail Slider */}
      <Box sx={{ mt: 2 }}>
        <Swiper
          onSwiper={setThumbsSwiper}
          spaceBetween={8}
          slidesPerView={4.5}
          freeMode={true}
          watchSlidesProgress={true}
          modules={[Navigation, Thumbs]}
          className="product-thumb-slider"
        >
          {images.map((image, index) => (
            <SwiperSlide key={index}>
              <Paper
                elevation={0}
                sx={{
                  position: "relative",
                  paddingTop: "100%",
                  borderRadius: 2,
                  overflow: "hidden",
                  border:
                    activeIndex === index
                      ? "2px solid #d32f2f"
                      : "2px solid transparent",
                  cursor: "pointer",
                  transition: "all 0.3s ease",
                  "&:hover": {
                    transform: "translateY(-2px)",
                    borderColor: "#d32f2f", // Added hover border
                  },
                }}
              >
                <Box
                  component="img"
                  src={
                    image?.imageUrl?.startsWith("http")
                      ? image.imageUrl
                      : `${process.env.REACT_APP_API_BASE_URL}/${image.imageUrl}`
                  }
                  alt={`${name} - Thumbnail ${index + 1}`}
                  sx={{
                    position: "absolute",
                    top: 0,
                    left: 0,
                    width: "100%",
                    height: "100%",
                    objectFit: "contain",
                    p: 1,
                  }}
                  onError={(e) => {
                    e.target.onerror = null;
                    e.target.src =
                      "https://via.placeholder.com/100?text=No+Image";
                  }}
                />
              </Paper>
            </SwiperSlide>
          ))}
        </Swiper>
      </Box>

      {/* Fullscreen Dialog */}
      <Dialog
        fullScreen
        open={isFullscreen}
        onClose={closeFullscreen}
        TransitionComponent={Fade}
        sx={{
          "& .MuiDialog-paper": {
            bgcolor: "rgba(0,0,0,0.95)",
          },
        }}
      >
        <Box sx={{ position: "relative", height: "100%" }}>
          <IconButton
            onClick={closeFullscreen}
            sx={{
              position: "absolute",
              right: 24,
              top: 24,
              zIndex: 2,
              color: "white",
              bgcolor: "rgba(255,255,255,0.1)",
              "&:hover": {
                bgcolor: "rgba(255,255,255,0.2)",
              },
            }}
          >
            <X />
          </IconButton>

          <Box
            sx={{
              height: "100%",
              display: "flex",
              flexDirection: "column",
              alignItems: "center",
              justifyContent: "center",
              p: 4,
            }}
          >
            <Typography
              variant="h6"
              sx={{
                color: "rgba(255,255,255,0.7)",
                mb: 2,
                textAlign: "center",
              }}
            >
              {name}
            </Typography>
            <Swiper
              modules={[Navigation, Zoom]}
              navigation
              zoom={{
                maxRatio: 3,
                minRatio: 1,
              }}
              initialSlide={activeIndex}
              className="fullscreen-slider"
            >
              {images.map((image, index) => (
                <SwiperSlide key={index}>
                  <Box
                    className="swiper-zoom-container"
                    sx={{
                      height: "80vh",
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "center",
                    }}
                  >
                    <Box
                      component="img"
                      src={
                        image?.imageUrl?.startsWith("http")
                          ? image.imageUrl
                          : `${process.env.REACT_APP_API_BASE_URL}/${image.imageUrl}`
                      }
                      alt={`${name} - Fullscreen ${index + 1}`}
                      sx={{
                        maxHeight: "90vh",
                        maxWidth: "90vw",
                        objectFit: "contain",
                      }}
                      onError={(e) => {
                        e.target.onerror = null;
                        e.target.src =
                          "https://via.placeholder.com/800?text=No+Image";
                      }}
                    />
                  </Box>
                </SwiperSlide>
              ))}
            </Swiper>
            <Typography
              variant="caption"
              sx={{
                color: "rgba(255,255,255,0.5)",
                mt: 2,
              }}
            >
              Cuá»™n Ä‘á»ƒ phÃ³ng to â€¢ Click Ä‘á»ƒ xem chi tiáº¿t
            </Typography>
          </Box>
        </Box>
      </Dialog>
    </Box>
  );
};

export default ProductImage;

```

### ClientApp\src\components\ProductInfoPage\ProductInfo.jsx
```jsx
import React from "react";
import { Box, Typography, Divider, Paper, Rating } from "@mui/material";
import { Award, Shield, Truck, Gift } from "lucide-react";

const ProductInfo = ({ product }) => {
  return (
    <Paper
      elevation={0}
      sx={{
        bgcolor: "white",
        borderRadius: 3,
        overflow: "hidden",
        transition: "all 0.3s ease",
      }}
    >
      {/* Hero Section vá»›i Gradient Background */}
      <Box
        sx={{
          background: "linear-gradient(135deg, #d32f2f 0%, #f44336 100%)",
          py: 4,
          px: 3,
          color: "white",
          position: "relative",
          overflow: "hidden",
        }}
      >
        {/* Animated Background Pattern */}
        <Box
          sx={{
            position: "absolute",
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            opacity: 0.1,
            background:
              'url(\'data:image/svg+xml,%3Csvg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="%23ffffff" fill-opacity="0.4" fill-rule="evenodd"%3E%3Ccircle cx="3" cy="3" r="3"/%3E%3Ccircle cx="13" cy="13" r="3"/%3E%3C/g%3E%3C/svg%3E\')',
          }}
        />

        {/* Product Name vá»›i Typography Hierarchy */}
        <Typography
          variant="h3"
          component="h1"
          sx={{
            fontWeight: 800,
            mb: 2,
            position: "relative",
            textShadow: "2px 2px 4px rgba(0,0,0,0.2)",
            "&::after": {
              content: '""',
              position: "absolute",
              bottom: -8,
              left: 0,
              width: 60,
              height: 4,
              bgcolor: "white",
              borderRadius: 2,
            },
          }}
        >
          {product?.name}
        </Typography>

        {/* Price and Rating Section */}
        <Box
          sx={{
            display: "flex",
            alignItems: "center",
            justifyContent: "space-between",
            mt: 2,
            mb: 3,
          }}
        >
          <Typography
            variant="h4"
            sx={{
              fontWeight: 700,
              color: "#FFEB3B", // A vibrant yellow for price
              textShadow: "1px 1px 3px rgba(0,0,0,0.3)",
            }}
          >
            {product?.price?.toLocaleString("vi-VN")} VNÄ
          </Typography>
          <Box sx={{ display: "flex", alignItems: "center" }}>
            <Rating
              value={product?.averageRating || 0}
              precision={0.5}
              readOnly
              sx={{ color: "#FFEB3B" }}
            />
            <Typography variant="caption" sx={{ color: "white", ml: 1 }}>
              ({product?.reviewCount || 0} Ä‘Ã¡nh giÃ¡)
            </Typography>
          </Box>
        </Box>

        {/* Brand Section */}
        <Box
          sx={{
            display: "flex",
            alignItems: "center",
            gap: 2,
            mt: 3,
            position: "relative",
          }}
        >
          <Box
            sx={{
              bgcolor: "white",
              p: 1.5,
              borderRadius: 2,
              boxShadow: "0 4px 12px rgba(0,0,0,0.1)",
              display: "flex",
              alignItems: "center",
              gap: 2,
            }}
          >
            {product?.brand?.logo && (
              <Box
                component="img"
                src={
                  product.brand.logo?.startsWith("http")
                    ? product.brand.logo
                    : `${process.env.REACT_APP_API_BASE_URL}/${product.brand.logo}`
                }
                alt={product?.brand?.name || "Brand Logo"}
                sx={{
                  width: 40,
                  height: 40,
                  objectFit: "contain",
                }}
                onError={(e) => {
                  e.target.onerror = null;
                  e.target.src = "https://via.placeholder.com/40?text=No+Logo";
                }}
              />
            )}
            <Box>
              <Typography
                variant="overline"
                sx={{
                  color: "text.secondary",
                  letterSpacing: 2,
                }}
              >
                ThÆ°Æ¡ng hiá»‡u
              </Typography>
              <Typography
                variant="subtitle1"
                sx={{
                  fontWeight: 700,
                  color: "text.primary",
                }}
              >
                {product?.brand?.name}
              </Typography>
            </Box>
          </Box>

          {/* Stock Status */}
          <Box sx={{ ml: "auto" }}>
            <Typography
              variant="subtitle1"
              sx={{
                fontWeight: 700,
                color: product?.stock > 0 ? "#4CAF50" : "#F44336", // Green for in stock, Red for out of stock
                bgcolor: "white",
                p: 1,
                borderRadius: 1,
                boxShadow: "0 2px 8px rgba(0,0,0,0.1)",
              }}
            >
              {product?.stock > 0 ? "CÃ²n hÃ ng" : "Háº¿t hÃ ng"}
            </Typography>
          </Box>
        </Box>
      </Box>

      {/* Main Content Section */}
      <Box sx={{ p: 3 }}>
        {/* Benefits Grid */}
        <Box
          sx={{
            display: "grid",
            gridTemplateColumns: "repeat(auto-fit, minmax(250px, 1fr))",
            gap: 2,
            mb: 4,
          }}
        >
          {[
            {
              icon: Shield,
              label: "ChÃ­nh hÃ£ng",
              desc: "100% sáº£n pháº©m chÃ­nh hÃ£ng",
            },
            {
              icon: Award,
              label: "Báº£o hÃ nh 24 thÃ¡ng",
              desc: "Há»— trá»£ Ä‘á»•i tráº£ miá»…n phÃ­",
            },
            {
              icon: Truck,
              label: "Giao hÃ ng trong 2h",
              desc: "Vá»›i Ä‘Æ¡n hÃ ng ná»™i thÃ nh",
            },
            {
              icon: Gift,
              label: "QuÃ  táº·ng háº¥p dáº«n",
              desc: "Nhiá»u pháº§n quÃ  giÃ¡ trá»‹",
            },
          ].map((item, index) => (
            <Paper
              key={index}
              elevation={0}
              sx={{
                p: 2,
                borderRadius: 2,
                border: "1px solid",
                borderColor: "divider",
                display: "flex",
                alignItems: "center",
                gap: 2,
                transition: "all 0.3s ease",
                "&:hover": {
                  transform: "translateY(-2px)",
                  boxShadow: "0 4px 12px rgba(0,0,0,0.1)",
                },
              }}
            >
              <Box
                sx={{
                  width: 40,
                  height: 40,
                  borderRadius: 2,
                  bgcolor: "primary.main",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  color: "white",
                }}
              >
                <item.icon size={24} />
              </Box>
              <Box>
                <Typography variant="subtitle2" fontWeight="bold">
                  {item.label}
                </Typography>
                <Typography variant="caption" color="text.secondary">
                  {item.desc}
                </Typography>
              </Box>
            </Paper>
          ))}
        </Box>

        <Divider sx={{ my: 3 }} />

        {/* Product Description */}
        <Paper
          elevation={0}
          sx={{
            position: "relative",
            p: 3,
            borderRadius: 2,
            bgcolor: "#f8f9fa",
            border: "1px solid",
            borderColor: "divider",
          }}
        >
          <Typography
            variant="h6"
            sx={{
              mb: 3,
              fontWeight: 600,
              display: "flex",
              alignItems: "center",
              gap: 1,
              color: "#1a1a1a",
              position: "relative",
              "&::before": {
                content: '""',
                width: 4,
                height: 24,
                bgcolor: "primary.main",
                borderRadius: 1,
              },
            }}
          >
            MÃ´ táº£ sáº£n pháº©m
          </Typography>
          <Typography
            variant="body1"
            sx={{
              color: "#2c3e50",
              lineHeight: 2,
              textAlign: "justify",
              letterSpacing: "0.3px",
              maxHeight: 300,
              overflowY: "auto",
              pr: 2,
              "& strong": {
                color: "#1a1a1a",
                fontWeight: 700,
                backgroundColor: "rgba(211, 47, 47, 0.1)",
                padding: "0 4px",
                borderRadius: 1,
              },
              "&::-webkit-scrollbar": {
                width: "8px",
              },
              "&::-webkit-scrollbar-track": {
                background: "#f1f1f1",
                borderRadius: "4px",
              },
              "&::-webkit-scrollbar-thumb": {
                background: "#d32f2f",
                borderRadius: "4px",
                "&:hover": {
                  background: "#b71c1c",
                },
              },
            }}
          >
            {product?.description}
          </Typography>
        </Paper>
      </Box>
    </Paper>
  );
};

export default ProductInfo;

```

### ClientApp\src\components\ProductInfoPage\ProductReviews.jsx
```jsx
import React, { useState, useEffect, useCallback } from "react";
import { 
  Snackbar, 
  Alert, 
  CircularProgress, 
  Box, 
  Typography, 
  Card, 
  CardContent, 
  Button, 
  TextField, 
  Rating, 
  Avatar, 
  Chip,
  Divider,
  LinearProgress
} from "@mui/material";
import { 
  Star, 
  CheckCircle, // For verified purchase
  Person, 
  RateReview, 
  Send,
  Close 
} from "@mui/icons-material";
import { useReviews, useSubmitReview, useUserReview } from "@/hooks/api/useReviews";
import { jwtDecode } from "jwt-decode";

const ProductReviews = ({ productId }) => {
  const [showForm, setShowForm] = useState(false);
  const [rating, setRating] = useState(5);
  const [comment, setComment] = useState("");
  const [snackbar, setSnackbar] = useState({ open: false, message: "", severity: "success" });
  const token = localStorage.getItem("token");
  let currentUserId = null;
  if (token) {
    try {
      const decoded = jwtDecode(token);
      currentUserId = decoded.nameid || decoded.sub || decoded.UserId || null;
    } catch (err) {
      console.error("Token decode error:", err);
    }
  }

  const { reviews, loading, error, averageRating, fetchReviews, fetchAverageRating } = useReviews(productId);
  const { userReview, refetchUserReview } = useUserReview(currentUserId, productId);
  const { submitReview } = useSubmitReview(productId, () => {
    fetchReviews();
    fetchAverageRating();
    refetchUserReview(); // Refetch user's specific review after submission
  });

  // Xá»­ lÃ½ khi khÃ´ng cÃ³ dá»¯ liá»‡u hoáº·c API tráº£ vá» rá»—ng
  const safeReviews = Array.isArray(reviews) ? reviews : [];
  const safeAverageRating = typeof averageRating === 'number' && !isNaN(averageRating) ? averageRating : 0;

  const handleSubmitReview = async (e) => {
    e.preventDefault();

    if (!token || !currentUserId) {
      setSnackbar({ open: true, message: "Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ Ä‘Ã¡nh giÃ¡", severity: "warning" });
      return;
    }

    if (!comment.trim() || rating < 1 || rating > 5) {
      setSnackbar({ open: true, message: "Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin Ä‘Ã¡nh giÃ¡", severity: "warning" });
      return;
    }

    try {
      await submitReview({ rating, comment });
      setShowForm(false);
      setComment("");
      setRating(5);
      setSnackbar({ open: true, message: "ÄÃ¡nh giÃ¡ cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c gá»­i vÃ  Ä‘ang chá» kiá»ƒm duyá»‡t!", severity: "success" });
    } catch (err) {
      // Hiá»ƒn thá»‹ thÃ´ng bÃ¡o chi tiáº¿t tá»« backend náº¿u cÃ³
      const errorMsg = err?.response?.data?.message || err?.message || "Gá»­i Ä‘Ã¡nh giÃ¡ tháº¥t báº¡i";
      setSnackbar({ open: true, message: errorMsg, severity: "error" });
    }
  };
  
  // Check if user has reviewed, considering both general reviews and their specific review
  const hasReviewed = safeReviews.some((r) => r.userId === Number(currentUserId)) || !!userReview;

  const getRatingDistribution = () => {
    const distribution = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
    safeReviews.forEach(review => {
      distribution[review.rating] = (distribution[review.rating] || 0) + 1;
    });
    return distribution;
  };

  const ratingDistribution = getRatingDistribution();
  const totalReviews = safeReviews.length;

  return (
    <Box sx={{ p: 0 }}>
      {/* Header Section */}
      <Box sx={{ textAlign: 'center', mb: 4 }}>
        <Typography variant="h5" sx={{ fontWeight: 'bold', mb: 2, color: '#1976d2' }}>
          <RateReview sx={{ mr: 1, verticalAlign: 'middle' }} />
          ÄÃ¡nh giÃ¡ & BÃ¬nh luáº­n
        </Typography>
        
        {/* Average Rating Display */}
        <Card sx={{ maxWidth: 400, mx: 'auto', mb: 3 }}>
          <CardContent sx={{ textAlign: 'center', py: 3 }}>
            <Typography variant="h3" sx={{ fontWeight: 'bold', color: '#ff9800', mb: 1 }}>
              {safeAverageRating.toFixed(1)}
            </Typography>
            <Rating value={safeAverageRating} readOnly precision={0.1} size="large" sx={{ mb: 1 }} />
            <Typography variant="body2" color="text.secondary">
              Dá»±a trÃªn {totalReviews} Ä‘Ã¡nh giÃ¡
            </Typography>
          </CardContent>
        </Card>

        {/* Rating Distribution */}
        {totalReviews > 0 && (
          <Card sx={{ maxWidth: 500, mx: 'auto', mb: 3 }}>
            <CardContent>
              <Typography variant="h6" sx={{ mb: 2, textAlign: 'center' }}>
                PhÃ¢n bá»‘ Ä‘Ã¡nh giÃ¡
              </Typography>
              {[5, 4, 3, 2, 1].map((star) => (
                <Box key={star} sx={{ display: 'flex', alignItems: 'center', mb: 1 }}>
                  <Typography sx={{ minWidth: 20 }}>{star}</Typography>
                  <Star sx={{ color: '#ff9800', fontSize: 16, mx: 0.5 }} />
                  <LinearProgress 
                    variant="determinate" 
                    value={totalReviews > 0 ? (ratingDistribution[star] / totalReviews) * 100 : 0}
                    sx={{ 
                      flexGrow: 1, 
                      mx: 1, 
                      height: 8, 
                      borderRadius: 4,
                      bgcolor: '#f5f5f5',
                      '& .MuiLinearProgress-bar': { bgcolor: '#ff9800' }
                    }} 
                  />
                  <Typography sx={{ minWidth: 30, fontSize: '0.875rem', color: 'text.secondary' }}>
                    {ratingDistribution[star]}
                  </Typography>
                </Box>
              ))}
            </CardContent>
          </Card>
        )}
      </Box>

      {/* Loading State */}
      {loading && (
        <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', py: 4 }}>
          <CircularProgress size={24} sx={{ mr: 2 }} />
          <Typography color="text.secondary">Äang táº£i Ä‘Ã¡nh giÃ¡...</Typography>
        </Box>
      )}

      {/* Error State */}
      {error && (
        <Alert severity="warning" sx={{ mb: 3 }}>
          <Typography variant="body2">
            {error.includes('404') || error.includes('Not Found') 
              ? 'Chá»©c nÄƒng Ä‘Ã¡nh giÃ¡ Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn. Vui lÃ²ng quay láº¡i sau!'
              : `Lá»—i khi táº£i Ä‘Ã¡nh giÃ¡: ${error}`
            }
          </Typography>
        </Alert>
      )}

      {/* User's Own Review (if exists) */}
      {userReview && (
        <Card sx={{ mb: 2, boxShadow: 3, borderRadius: 2, border: '2px solid #1976d2', bgcolor: '#e3f2fd' }}>
          <CardContent>
            <Box sx={{ display: 'flex', alignItems: 'flex-start', mb: 2 }}>
              <Avatar sx={{ bgcolor: '#1976d2', mr: 2, width: 48, height: 48, fontSize: '1.5rem' }}>
                {userReview.userName ? userReview.userName[0].toUpperCase() : '?'}
              </Avatar>
              <Box sx={{ flexGrow: 1 }}>
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 1 }}>
                  <Typography variant="subtitle1" sx={{ fontWeight: 'bold', color: '#1976d2' }}>
                    ÄÃ¡nh giÃ¡ cá»§a báº¡n
                  </Typography>
                  <Chip 
                    icon={<Star sx={{ fontSize: 16 }} />}
                    label={`${userReview.rating}`}
                    size="small"
                    sx={{
                      bgcolor: '#ffeb3b',
                      color: '#333',
                      fontWeight: 'bold',
                      px: 1,
                    }}
                  />
                </Box>
                <Rating value={userReview.rating} readOnly size="small" sx={{ mb: 1 }} />
                <Typography variant="body1" sx={{ mb: 2, lineHeight: 1.6, color: '#333' }}>
                  {userReview.comment}
                </Typography>
                <Typography variant="caption" color="text.secondary">
                  {new Date(userReview.createdAt).toLocaleDateString('vi-VN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  })}
                  {userReview.hasPurchased && (
                    <Chip
                      icon={<CheckCircle />}
                      label="ÄÃ£ xÃ¡c minh mua hÃ ng"
                      size="small"
                      color="success"
                      sx={{ ml: 1, height: 20, fontSize: '0.75rem' }}
                    />
                  )}
                  {!userReview.isApproved && (
                    <Chip
                      label="Äang chá» duyá»‡t"
                      size="small"
                      color="info"
                      sx={{ ml: 1, height: 20, fontSize: '0.75rem' }}
                    />
                  )}
                </Typography>
              </Box>
            </Box>
          </CardContent>
        </Card>
      )}

      {/* Reviews List */}
      {!loading && !error && (
        <Box sx={{ mb: 4 }}>
          {safeReviews.length > 0 ? (
            <Box>
              {safeReviews.map((review, index) => (
                <Card key={review.id} sx={{ mb: 2, boxShadow: 2, borderRadius: 2, transition: 'all 0.3s ease', '&:hover': { boxShadow: 4 } }}>
                  <CardContent>
                    <Box sx={{ display: 'flex', alignItems: 'flex-start', mb: 2 }}>
                      <Avatar sx={{ bgcolor: '#d32f2f', mr: 2, width: 48, height: 48, fontSize: '1.5rem' }}>
                        {review.userName ? review.userName[0].toUpperCase() : '?'}
                      </Avatar>
                      <Box sx={{ flexGrow: 1 }}>
                        <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 1 }}>
                          <Typography variant="subtitle1" sx={{ fontWeight: 'bold', color: '#333' }}>
                            {review.userName}
                          </Typography>
                          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                            <Chip 
                              icon={<Star sx={{ fontSize: 16 }} />}
                              label={`${review.rating}`}
                              size="small"
                              sx={{
                                bgcolor: '#ffeb3b',
                                color: '#333',
                                fontWeight: 'bold',
                                px: 1,
                              }}
                            />
                            {review.hasPurchased && (
                              <Chip
                                icon={<CheckCircle />}
                                label="ÄÃ£ xÃ¡c minh mua hÃ ng"
                                size="small"
                                color="success"
                                sx={{ height: 20, fontSize: '0.75rem' }}
                              />
                            )}
                          </Box>
                        </Box>
                        <Rating value={review.rating} readOnly size="small" sx={{ mb: 1 }} />
                        <Typography variant="body1" sx={{ mb: 2, lineHeight: 1.6, color: '#555' }}>
                          {review.comment}
                        </Typography>
                        <Typography variant="caption" color="text.secondary">
                          {new Date(review.createdAt).toLocaleDateString('vi-VN', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                          })}
                        </Typography>
                      </Box>
                    </Box>
                  </CardContent>
                </Card>
              ))}
            </Box>
          ) : (
            <Card sx={{ textAlign: 'center', py: 6, boxShadow: 2, borderRadius: 2 }}>
              <CardContent>
                <RateReview sx={{ fontSize: 60, color: '#bdbdbd', mb: 2 }} />
                <Typography variant="h6" color="text.secondary" sx={{ mb: 1 }}>
                  {error ? 'KhÃ´ng thá»ƒ táº£i Ä‘Ã¡nh giÃ¡' : 'ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡ nÃ o'}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  {error 
                    ? 'Há»‡ thá»‘ng Ä‘ang báº£o trÃ¬, vui lÃ²ng thá»­ láº¡i sau'
                    : 'HÃ£y lÃ  ngÆ°á»i Ä‘áº§u tiÃªn Ä‘Ã¡nh giÃ¡ sáº£n pháº©m nÃ y'
                  }
                </Typography>
              </CardContent>
            </Card>
          )}
        </Box>
      )}

      <Snackbar
        open={snackbar.open}
        autoHideDuration={4000}
        onClose={() => setSnackbar({ ...snackbar, open: false })}
        anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}
        TransitionProps={{ appear: true }}
      >
        <Alert 
          severity={snackbar.severity} 
          variant="filled" 
          sx={{ width: '100%', fontWeight: 500, fontSize: '1rem', display: 'flex', alignItems: 'center' }}
          iconMapping={{
            success: <CheckCircle fontSize="inherit" sx={{ color: '#43a047' }} />,
            error: <Close fontSize="inherit" sx={{ color: '#d32f2f' }} />,
            warning: <RateReview fontSize="inherit" sx={{ color: '#ffa726' }} />,
            info: <Person fontSize="inherit" sx={{ color: '#1976d2' }} />,
          }}
        >
          {snackbar.message}
        </Alert>
      </Snackbar>

      {/* Add Review Button */}
      {!hasReviewed && currentUserId && !error && (
        <Box sx={{ display: 'flex', justifyContent: 'center', mb: 3 }}>
          <Button
            variant="contained"
            size="large"
            startIcon={showForm ? <Close /> : <RateReview />}
            onClick={() => setShowForm(!showForm)}
            sx={{
              borderRadius: 3,
              px: 4,
              py: 1.5,
              textTransform: 'none',
              fontSize: '1rem',
              boxShadow: 3,
              bgcolor: '#d32f2f',
              position: 'relative',
              zIndex: 2,
              transition: 'all 0.2s',
              '&:hover': { boxShadow: 5, bgcolor: '#b71c1c' }
            }}
            title={showForm ? "ÄÃ³ng form Ä‘Ã¡nh giÃ¡" : "Viáº¿t Ä‘Ã¡nh giÃ¡ vá» sáº£n pháº©m nÃ y"}
          >
            {showForm ? "ÄÃ³ng form Ä‘Ã¡nh giÃ¡" : "Viáº¿t Ä‘Ã¡nh giÃ¡"}
          </Button>
        </Box>
      )}

      {/* Review Form */}
      {showForm && (
        <Card sx={{ mb: 3, boxShadow: 3, borderRadius: 2, animation: 'fadeInUp 0.3s' }}>
          <CardContent sx={{ p: { xs: 2, sm: 4 } }}>
            <Typography variant="h6" sx={{ mb: 3, textAlign: 'center', color: '#d32f2f', fontWeight: 'bold' }}>
              Chia sáº» Ä‘Ã¡nh giÃ¡ cá»§a báº¡n
            </Typography>
            <Box component="form" onSubmit={handleSubmitReview} sx={{ display: 'flex', flexDirection: 'column', gap: 3 }}>
              <Box sx={{ textAlign: 'center' }}>
                <Typography component="legend" sx={{ mb: 1, fontWeight: 'medium', color: '#555' }}>
                  ÄÃ¡nh giÃ¡ cá»§a báº¡n:
                </Typography>
                <Rating
                  value={rating}
                  onChange={(event, newValue) => setRating(newValue || 1)}
                  size="large"
                  sx={{ fontSize: { xs: '2rem', sm: '2.5rem' }, color: '#ffeb3b' }}
                />
                <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
                  {rating === 5 && "Tuyá»‡t vá»i! ğŸŒŸ"}
                  {rating === 4 && "Ráº¥t tá»‘t! ğŸ‘"}
                  {rating === 3 && "BÃ¬nh thÆ°á»ng ğŸ˜"}
                  {rating === 2 && "KhÃ´ng tá»‘t ğŸ‘"}
                  {rating === 1 && "Ráº¥t tá»‡ ğŸ˜"}
                </Typography>
              </Box>
              <TextField
                fullWidth
                multiline
                rows={4}
                variant="outlined"
                label="Nháº­n xÃ©t cá»§a báº¡n"
                placeholder="Chia sáº» tráº£i nghiá»‡m cá»§a báº¡n vá» sáº£n pháº©m nÃ y..."
                value={comment}
                onChange={(e) => setComment(e.target.value)}
                required
                sx={{
                  '& .MuiOutlinedInput-root': {
                    borderRadius: 2,
                  },
                }}
              />
              <Box sx={{ display: 'flex', gap: 2, justifyContent: 'center' }}>
                <Button
                  type="button"
                  variant="outlined"
                  size="large"
                  onClick={() => setShowForm(false)}
                  sx={{ px: 4, borderRadius: 2, borderColor: '#d32f2f', color: '#d32f2f', '&:hover': { borderColor: '#b71c1c', bgcolor: 'rgba(211, 47, 47, 0.04)' } }}
                  title="Há»§y Ä‘Ã¡nh giÃ¡"
                >
                  Há»§y
                </Button>
                <Button
                  type="submit"
                  variant="contained"
                  size="large"
                  startIcon={<Send />}
                  sx={{
                    px: 4,
                    borderRadius: 2,
                    boxShadow: 3,
                    bgcolor: '#d32f2f',
                    position: 'relative',
                    '&:hover': { boxShadow: 5, bgcolor: '#b71c1c' }
                  }}
                  title="Gá»­i Ä‘Ã¡nh giÃ¡"
                  disabled={snackbar.severity === 'success' && snackbar.open}
                >
                  Gá»­i Ä‘Ã¡nh giÃ¡
                </Button>
              </Box>
            </Box>
          </CardContent>
        </Card>
      )}

      {/* Hiá»‡u á»©ng chuyá»ƒn Ä‘á»™ng cho form Ä‘Ã¡nh giÃ¡ */}
      <style>{`
        @keyframes fadeInUp {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
      `}</style>

      {/* Login prompt for non-logged in users */}
      {!currentUserId && (
        <Card sx={{ textAlign: 'center', bgcolor: '#f5f5f5', borderRadius: 2, boxShadow: 1 }}>
          <CardContent sx={{ py: 3 }}>
            <Typography variant="body1" color="text.secondary">
              ÄÄƒng nháº­p Ä‘á»ƒ cÃ³ thá»ƒ Ä‘Ã¡nh giÃ¡ vÃ  bÃ¬nh luáº­n sáº£n pháº©m
            </Typography>
          </CardContent>
        </Card>
      )}

      {/* Already reviewed message */}
      {hasReviewed && !userReview && (
        <Alert severity="info" sx={{ textAlign: 'center', borderRadius: 2, boxShadow: 1 }}>
          Báº¡n Ä‘Ã£ Ä‘Ã¡nh giÃ¡ sáº£n pháº©m nÃ y rá»“i. Cáº£m Æ¡n pháº£n há»“i cá»§a báº¡n!
        </Alert>
      )}
    </Box>
  );
};

export default ProductReviews;


```

### ClientApp\src\components\ProductInfoPage\ProductSpecifications.jsx
```jsx
import React, { useState, useEffect } from 'react';
import {
  Box,
  Typography,
  List,
  ListItem,
  ListItemText,
  Collapse,
  CircularProgress,
  Alert,
  Button,
  Divider,
} from '@mui/material';
import {
  ChevronDown,
  ChevronUp,
  Maximize2,
  Minimize2,
} from 'lucide-react';

const SpecificationDisplay = ({ productId }) => {
  const [specs, setSpecs] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [expanded, setExpanded] = useState(true);
  const [showAllSpecs, setShowAllSpecs] = useState(false);

  useEffect(() => {
    const fetchSpecifications = async () => {
      try {
        setLoading(true);
        setError(null);


        const response = await fetch(
          `${process.env.REACT_APP_API_BASE_URL}/api/Specifications/by-product/${productId}`
        );

        if (!response.ok) {
          throw new Error('KhÃ´ng tÃ¬m tháº¥y thÃ´ng sá»‘ ká»¹ thuáº­t');
        }

        const data = await response.json();
        setSpecs(data);
      } catch (err) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    };

    if (productId ) {
      fetchSpecifications();
    }
  }, [productId]);



  // Render specs from API array
  const renderSpecs = () => {
    if (!Array.isArray(specs)) return null;
    // Sort by displayOrder
    const sortedSpecs = [...specs].sort((a, b) => a.displayOrder - b.displayOrder);
    const basicSpecs = sortedSpecs.slice(0, 4);
    const displaySpecs = showAllSpecs ? sortedSpecs : basicSpecs;

    return (
      <List sx={{ width: '100%', bgcolor: 'background.paper', p: 0 }}>
        {displaySpecs.map((spec, index) => (
          <ListItem
            key={spec.id || index}
            sx={{
              py: 1.5,
              px: { xs: 1, sm: 2 },
              display: 'flex',
              alignItems: 'center',
              gap: 2,
              borderRadius: 2,
              transition: 'background 0.2s',
              '&:hover': { bgcolor: 'action.hover' },
            }}
          >
            {/* Icon for spec (example: use Maximize2 for demo, can customize per spec type) */}
            <Box sx={{ minWidth: 32, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
              <Maximize2 size={20} color="#1976d2" />
            </Box>
            <ListItemText
              primary={
                <Typography variant="body2" color="text.secondary" fontWeight={600}>
                  {spec.name}
                </Typography>
              }
              secondary={
                spec.value ? (
                  <Typography variant="body1" fontWeight="medium" color="text.primary">
                    {spec.value}{spec.unit ? ` ${spec.unit}` : ''}
                  </Typography>
                ) : (
                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                    <Typography variant="body1" color="warning.main" fontWeight="medium">
                      Äang cáº­p nháº­t
                    </Typography>
                    {/* Tooltip for updating */}
                    <Box component="span" sx={{ cursor: 'pointer' }} title="ThÃ´ng sá»‘ nÃ y sáº½ Ä‘Æ°á»£c cáº­p nháº­t sá»›m.">
                      <Minimize2 size={16} color="#ffa726" />
                    </Box>
                  </Box>
                )
              }
            />
          </ListItem>
        ))}
        {sortedSpecs.length > basicSpecs.length && (
          <ListItem sx={{ justifyContent: 'center', pt: 2, bgcolor: 'transparent' }}>
            <Button
              variant="outlined"
              onClick={() => setShowAllSpecs(!showAllSpecs)}
              endIcon={showAllSpecs ? <Minimize2 size={20} /> : <Maximize2 size={20} />}
              sx={{
                borderRadius: 2,
                px: 3,
                py: 1,
                fontWeight: 600,
                bgcolor: 'white',
                boxShadow: 1,
                textTransform: 'none',
                '&:hover': { bgcolor: 'action.hover' },
              }}
            >
              {showAllSpecs ? 'Thu gá»n' : 'Xem thÃªm thÃ´ng sá»‘'}
            </Button>
          </ListItem>
        )}
      </List>
    );
  };


  if (loading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', my: 4, py: 4 }}>
        <CircularProgress size={40} />
      </Box>
    );
  }

  if (error) {
    return (
      <Alert severity="error" sx={{ my: 4 }}>
        {error}
      </Alert>
    );
  }

  if (!specs) {
    return null;
  }

  return (
    <Box
      sx={{
        bgcolor: 'white',
        borderRadius: 3,
        overflow: 'hidden',
        boxShadow: 2,
        maxWidth: 600,
        mx: 'auto',
        my: { xs: 2, sm: 4 },
        p: 0,
      }}
    >
      <Button
        onClick={() => setExpanded(!expanded)}
        sx={{
          width: '100%',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          p: { xs: 1.5, sm: 2 },
          textTransform: 'none',
          bgcolor: 'white',
          borderBottom: '1px solid #eee',
          borderRadius: 0,
          fontWeight: 700,
          fontSize: { xs: 16, sm: 20 },
          '&:hover': {
            bgcolor: 'action.hover',
          },
        }}
      >
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
          <Typography variant="h6" fontWeight="bold" color="text.primary">
            ThÃ´ng sá»‘ ká»¹ thuáº­t
          </Typography>
        </Box>
        {expanded ? <ChevronUp size={22} /> : <ChevronDown size={22} />}
      </Button>
      <Collapse in={expanded}>
        <Divider />
        <Box sx={{ p: { xs: 1, sm: 2 } }}>
          {renderSpecs()}
        </Box>
      </Collapse>
    </Box>
  );
};

export default SpecificationDisplay;
```

### ClientApp\src\components\ProductInfoPage\ProductVariants.jsx
```jsx
import React, { useState, useEffect } from "react";
import {
  Box,
  Typography,
  Grid,
  Card,
  CardActionArea,
  Button,
  Snackbar,
  Alert,
  Chip,
  Fade,
  Tooltip,
  IconButton,
  Divider,
} from "@mui/material";
import {
  CheckCircle,
  ShoppingCart,
  LocalOffer,
  Info,
  AddCircle,
  RemoveCircle,
} from "@mui/icons-material";
import { jwtDecode } from "jwt-decode";
import axios from "axios";

const ProductVariants = ({ variants, onAddToCart }) => {
  const [selectedColor, setSelectedColor] = useState(variants[0].color);
  const availableStorages = variants
    .filter((v) => v.color === selectedColor)
    .map((v) => v.storage);
  const [selectedStorage, setSelectedStorage] = useState(availableStorages[0]);
  const [snackbarOpen, setSnackbarOpen] = useState(false);
  const [snackbarMessage, setSnackbarMessage] = useState("");
  const [snackbarSeverity, setSnackbarSeverity] = useState("success");
  const [quantity, setQuantity] = useState(1);
  const [showDiscount, setShowDiscount] = useState(false);

  useEffect(() => {
    const timer = setInterval(() => {
      setShowDiscount((prev) => !prev);
    }, 3000);
    return () => clearInterval(timer);
  }, []);

  const handleSelectColor = (color) => {
    setSelectedColor(color);
    const newStorages = variants
      .filter((v) => v.color === color)
      .map((v) => v.storage);
    setSelectedStorage(newStorages[0]);
  };

  const handleSelectStorage = (storage) => {
    if (availableStorages.includes(storage)) {
      setSelectedStorage(storage);
    }
  };

  const selectedVariant = variants.find(
    (v) => v.storage === selectedStorage && v.color === selectedColor
  );

  const formatCurrency = (price) => {
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
    }).format(price);
  };

  const calculateDiscount = (original, discounted) => {
    if (!original || !discounted) return 0;
    return Math.round(((original - discounted) / original) * 100);
  };

  const handleQuantityChange = (delta) => {
    const newQuantity = quantity + delta;
    if (
      newQuantity >= 1 &&
      newQuantity <= (selectedVariant?.stockQuantity || 1)
    ) {
      setQuantity(newQuantity);
    }
  };

  const handleAddToCart = async () => {
    try {
      if (!selectedVariant) {
        showSnackbar(
          "âš ï¸ Vui lÃ²ng chá»n biáº¿n thá»ƒ sáº£n pháº©m trÆ°á»›c khi thÃªm vÃ o giá» hÃ ng!",
          "warning"
        );
        return;
      }

      if (selectedVariant.stockQuantity <= 0) {
        showSnackbar("âŒ Sáº£n pháº©m nÃ y Ä‘Ã£ háº¿t hÃ ng!", "error");
        return;
      }

      const token = localStorage.getItem("token");

      const primaryImage =
        selectedVariant.product?.images?.find((img) => img.isPrimary)
          ?.imageUrl || "";
      const productName = selectedVariant.product?.name || "Sáº£n pháº©m khÃ´ng tÃªn";
      const variantColor = selectedColor;
      const variantStorage = selectedStorage;
      const price = selectedVariant.price || 0;
      const discountPrice = selectedVariant.discountPrice || 0;

      if (token) {
        const decoded = jwtDecode(token);
        const userId = parseInt(decoded.sub, 10);
        await axios.post(
          `${process.env.REACT_APP_API_BASE_URL}/api/Cart`,
          {
            productVariantId: selectedVariant.id,
            quantity: 1,
            userId: userId,
          },
          { headers: { Authorization: `Bearer ${token}` } }
        );
      } else {
        const sessionCart = JSON.parse(sessionStorage.getItem("cart")) || [];
        const existingItemIndex = sessionCart.findIndex(
          (item) => item.productVariantId === selectedVariant.id
        );

        if (existingItemIndex >= 0) {
          sessionCart[existingItemIndex].quantity += 1;
        } else {
          sessionCart.push({
            productVariantId: selectedVariant.id,
            quantity: 1,
            productImage: primaryImage,
            productName: productName,
            variantColor: variantColor,
            variantStorage: variantStorage,
            productPrice: price,
            productDiscountPrice: discountPrice,
            addedAt: new Date().toISOString(),
          });
        }

        sessionStorage.setItem("cart", JSON.stringify(sessionCart));
      }

      showSnackbar("ğŸ›’ Sáº£n pháº©m Ä‘Ã£ Ä‘Æ°á»£c thÃªm vÃ o giá» hÃ ng!", "success");
      if (onAddToCart) onAddToCart();
    } catch (error) {
      console.error("âŒ Lá»—i khi thÃªm vÃ o giá» hÃ ng:", error);
      showSnackbar(`âŒ KhÃ´ng thá»ƒ thÃªm vÃ o giá» hÃ ng: ${error.message}`, "error");
    }
  };

  const showSnackbar = (message, severity) => {
    setSnackbarMessage(message);
    setSnackbarSeverity(severity);
    setSnackbarOpen(true);
  };

  const handleCloseSnackbar = () => {
    setSnackbarOpen(false);
  };

  return (
    <Box
      sx={{
        backgroundColor: "white",
        borderRadius: 2,
        p: 3,
        boxShadow: "0 4px 6px -1px rgba(0,0,0,0.1)",
      }}
    >
      {/* MÃ u sáº¯c */}
      <Typography variant="h6" fontWeight="bold" gutterBottom>
        MÃ u sáº¯c
      </Typography>
      <Grid container spacing={2} sx={{ mb: 4 }}>
        {[...new Set(variants.map((v) => v.color))].map((color) => (
          <Grid item key={color}>
            <Card
              elevation={selectedColor === color ? 8 : 1}
              sx={{
                borderRadius: 2,
                transform: selectedColor === color ? "scale(1.05)" : "scale(1)",
                transition: "all 0.3s ease-in-out",
                border: selectedColor === color ? "2px solid #d32f2f" : "2px solid transparent",
                "&:hover": {
                  transform: "scale(1.05)",
                  borderColor: "#d32f2f",
                },
              }}
            >
              <CardActionArea
                onClick={() => handleSelectColor(color)}
                sx={{
                  position: "relative",
                  width: 120,
                  height: 120,
                }}
              >
                <Box
                  component="img"
                  src={
                    variants.find((v) => v.color === color)?.product
                      ?.images?.[0]?.imageUrl
                  }
                  alt={color}
                  sx={{
                    width: "100%",
                    height: "100%",
                    objectFit: "cover",
                  }}
                />
                <Box
                  sx={{
                    position: "absolute",
                    bottom: 0,
                    left: 0,
                    right: 0,
                    bgcolor: "rgba(255,255,255,0.9)",
                    p: 1,
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center",
                    gap: 0.5,
                  }}
                >
                  <Typography variant="subtitle2" fontWeight="bold">
                    {color}
                  </Typography>
                  {selectedColor === color && (
                    <CheckCircle
                      sx={{ color: "#d32f2f", width: 16, height: 16 }}
                    />
                  )}
                </Box>
              </CardActionArea>
            </Card>
          </Grid>
        ))}
      </Grid>

      {/* Dung lÆ°á»£ng */}
      <Typography variant="h6" fontWeight="bold" gutterBottom>
        Dung lÆ°á»£ng
      </Typography>
      <Grid container spacing={2} sx={{ mb: 4 }}>
        {[...new Set(variants.map((v) => v.storage))].map((storage) => (
          <Grid item key={storage}>
            <Tooltip
              title={
                !availableStorages.includes(storage)
                  ? "KhÃ´ng cÃ³ sáºµn vá»›i mÃ u Ä‘Ã£ chá»n"
                  : ""
              }
              arrow
            >
              <Card
                elevation={selectedStorage === storage ? 4 : 1}
                sx={{
                  minWidth: 120,
                  opacity: availableStorages.includes(storage) ? 1 : 0.5,
                  transition: "all 0.2s ease",
                  transform:
                    selectedStorage === storage ? "translateY(-4px)" : "none",
                  border:
                    selectedStorage === storage
                      ? "2px solid #d32f2f"
                      : "1px solid #ddd",
                  "&:hover": {
                    borderColor: availableStorages.includes(storage) ? "#d32f2f" : "#ddd",
                  },
                }}
              >
                <CardActionArea
                  onClick={() => handleSelectStorage(storage)}
                  disabled={!availableStorages.includes(storage)}
                  sx={{ p: 2 }}
                >
                  <Typography
                    variant="h6"
                    align="center"
                    sx={{
                      fontWeight: "bold",
                      color: selectedStorage === storage ? "#d32f2f" : "#333",
                    }}
                  >
                    {storage}
                  </Typography>
                </CardActionArea>
              </Card>
            </Tooltip>
          </Grid>
        ))}
      </Grid>

      {/* GiÃ¡ vÃ  thÃ´ng tin */}
      {selectedVariant && (
        <Box
          sx={{
            mt: 4,
            p: 3,
            borderRadius: 2,
            bgcolor: "#f5f5f5",
            display: "flex",
            flexDirection: "column",
            alignItems: "center",
            gap: 2,
          }}
        >
          <Box sx={{ display: "flex", alignItems: "center", gap: 2 }}>
            <Chip
              icon={<LocalOffer />}
              label={`-${calculateDiscount(
                selectedVariant.price,
                selectedVariant.discountPrice
              )}%`}
              color="error"
              sx={{ fontSize: "1.1rem" }}
            />
            <Box sx={{ textAlign: "center" }}>
              <Fade in={showDiscount}>
                <Typography
                  variant="h4"
                  component="div"
                  sx={{
                    fontWeight: "bold",
                    color: "#d32f2f",
                    textShadow: "0px 2px 4px rgba(0,0,0,0.1)",
                  }}
                >
                  {formatCurrency(selectedVariant.discountPrice)}
                </Typography>
              </Fade>
              <Typography
                variant="body1"
                sx={{
                  textDecoration: "line-through",
                  color: "text.secondary",
                  mt: 0.5,
                }}
              >
                {formatCurrency(selectedVariant.price)}
              </Typography>
            </Box>
          </Box>

          <Divider flexItem sx={{ my: 2 }} />

          {/* Sá»‘ lÆ°á»£ng */}
          <Box sx={{ display: "flex", alignItems: "center", gap: 2 }}>
            <Typography variant="subtitle1">Sá»‘ lÆ°á»£ng:</Typography>
            <Box sx={{ display: "flex", alignItems: "center" }}>
              <IconButton
                onClick={() => handleQuantityChange(-1)}
                disabled={quantity <= 1}
                size="small"
              >
                <RemoveCircle />
              </IconButton>
              <Typography sx={{ mx: 2, minWidth: 30, textAlign: "center" }}>
                {quantity}
              </Typography>
              <IconButton
                onClick={() => handleQuantityChange(1)}
                disabled={quantity >= selectedVariant.stockQuantity}
                size="small"
              >
                <AddCircle />
              </IconButton>
            </Box>
            <Tooltip title="Sá»‘ lÆ°á»£ng cÃ²n láº¡i" arrow>
              <Chip
                icon={<Info />}
                label={`CÃ²n ${selectedVariant.stockQuantity} sáº£n pháº©m`}
                variant="outlined"
                size="small"
              />
            </Tooltip>
          </Box>

          {/* NÃºt thao tÃ¡c */}
          <Box sx={{ display: "flex", gap: 2, width: "100%", mt: 3 }}>
            <Button
              onClick={handleAddToCart}
              variant="outlined"
              startIcon={<ShoppingCart />}
              sx={{
                flex: 1,
                height: 56,
                borderColor: "#d32f2f",
                color: "#d32f2f",
                borderWidth: 2,
                "&:hover": {
                  borderWidth: 2,
                  borderColor: "#b71c1c",
                  bgcolor: "rgba(211, 47, 47, 0.08)",
                },
              }}
            >
              ThÃªm vÃ o giá»
            </Button>
            <Button
              variant="contained"
              sx={{
                flex: 2,
                height: 56,
                bgcolor: "#d32f2f",
                fontSize: "1.1rem",
                fontWeight: "bold",
                "&:hover": {
                  bgcolor: "#b71c1c",
                },
              }}
            >
              Mua ngay
            </Button>
          </Box>
        </Box>
      )}

      {/* Snackbar thÃ´ng bÃ¡o */}
      <Snackbar
        open={snackbarOpen}
        autoHideDuration={3000}
        onClose={handleCloseSnackbar}
        anchorOrigin={{ vertical: "top", horizontal: "center" }}
      >
        <Alert
          onClose={handleCloseSnackbar}
          severity={snackbarSeverity}
          elevation={6}
          variant="filled"
        >
          {snackbarMessage}
        </Alert>
      </Snackbar>
    </Box>
  );
};

export default ProductVariants;

```

### ClientApp\src\components\ProductInfoPage\RelatedProducts.jsx
```jsx
import React, { useMemo } from "react";
import { useNavigate } from "react-router-dom";
import { Swiper, SwiperSlide } from "swiper/react";
import { Navigation } from "swiper/modules";
import "swiper/css";
import "swiper/css/navigation";
import { useProducts } from "@/hooks/api/useProducts";
import { useBrands } from "@/hooks/api/useBrands";
import {
  Box,
  Typography,
  Card,
  CardContent,
  CardMedia,
  Button,
  CircularProgress,
  Alert,
  Chip,
  IconButton,
} from "@mui/material";
import { ChevronLeft, ChevronRight } from "@mui/icons-material";

const RelatedProducts = ({ productId, brandId, categoryId }) => {
  const { products: productsArray, loading: loadingProducts, error: errorProducts } = useProducts();
  const { brands: brandsArray, loading: loadingBrands, error: errorBrands } = useBrands(true);
  const [error, setError] = React.useState("");
  const navigate = useNavigate();

  const relatedProducts = useMemo(() => {
    if (loadingProducts || loadingBrands) return [];
    if (errorProducts || errorBrands) {
      setError(errorProducts || errorBrands);
      return [];
    }
    if (!productsArray.length || !brandsArray.length) return [];

    return productsArray
      .filter(
        (product) =>
          product.id !== productId &&
          (product.brandId === brandId || product.categoryId === categoryId)
      )
      .map((product) => {
        const variant = product.variants?.[0] || {};
        const image = product.images?.[0]?.imageUrl || "/images/placeholder.jpg";
        const oldPrice = variant.price || 0;
        const newPrice = variant.discountPrice || oldPrice;
        const discountAmount = oldPrice - newPrice;
        const discount =
          oldPrice > 0
            ? `-${Math.round((discountAmount / oldPrice) * 100)}%`
            : "0%";

        const brand = brandsArray.find((b) => b.id === product.brandId);

        return {
          id: product.id,
          name: product.name,
          oldPrice,
          newPrice,
          discount,
          discountAmount,
          image,
          features: [
            variant.storage || "KhÃ´ng xÃ¡c Ä‘á»‹nh",
            brand?.name || "KhÃ´ng cÃ³ thÆ°Æ¡ng hiá»‡u",
          ],
        };
      });
  }, [productsArray, brandsArray, loadingProducts, loadingBrands, errorProducts, errorBrands, productId, brandId, categoryId]);

  if (loadingProducts || loadingBrands) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', py: 4 }}>
        <CircularProgress />
      </Box>
    );
  }
  if (error) {
    return (
      <Alert severity="error" sx={{ my: 4 }}>
        {error}
      </Alert>
    );
  }

  if (relatedProducts.length === 0) {
    return null; // Or a message indicating no related products
  }

  return (
    <Box sx={{ width: '100%', display: 'flex', justifyContent: 'center', py: 3 }}>
      <Box sx={{ maxWidth: 1200, width: '100%', px: 2, bgcolor: 'white', borderRadius: 2, boxShadow: 3, p: 3 }}>
        <Typography variant="h5" sx={{ fontWeight: 'bold', mb: 3, color: '#333' }}>
          Sáº£n pháº©m liÃªn quan
        </Typography>
        <Box sx={{ position: 'relative' }}>
          <Swiper
            modules={[Navigation]}
            navigation={{
              prevEl: '.swiper-button-prev-related',
              nextEl: '.swiper-button-next-related',
            }}
            spaceBetween={20}
            slidesPerView={1}
            breakpoints={{
              640: { slidesPerView: 2 },
              768: { slidesPerView: 3 },
              1024: { slidesPerView: 4 },
            }}
            className="pb-6"
          >
            {relatedProducts.map((product) => (
              <SwiperSlide key={product.id}>
                <Card
                  sx={{
                    maxWidth: 280,
                    mx: 'auto',
                    borderRadius: 2,
                    boxShadow: 2,
                    transition: 'all 0.3s ease',
                    '&:hover': { boxShadow: 6, transform: 'translateY(-5px)' },
                    cursor: 'pointer',
                  }}
                  onClick={() => navigate(`/product/${product.id}`)}
                >
                  <CardMedia
                    component="img"
                    height="180"
                    image={
                      product.image?.startsWith("http")
                        ? product.image
                        : `${process.env.REACT_APP_API_BASE_URL}/${product.image}`
                    }
                    alt={product.name}
                    sx={{ objectFit: 'contain', p: 2 }}
                    onError={(e) => { e.target.onerror = null; e.target.src = "https://via.placeholder.com/180"; }}
                  />
                  <CardContent sx={{ p: 2 }}>
                    <Typography variant="subtitle1" sx={{ fontWeight: 'bold', mb: 1, minHeight: 50 }}>
                      {product.name}
                    </Typography>
                    <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 1 }}>
                      <Typography variant="body2" color="text.secondary" sx={{ textDecoration: 'line-through' }}>
                        {product.oldPrice.toLocaleString('vi-VN')} Ä‘
                      </Typography>
                      {product.discount !== "0%" && (
                        <Chip label={product.discount} color="error" size="small" sx={{ fontWeight: 'bold' }} />
                      )}
                    </Box>
                    <Typography variant="h6" color="primary.main" sx={{ fontWeight: 'bold', mb: 1 }}>
                      {product.newPrice.toLocaleString('vi-VN')} Ä‘
                    </Typography>
                    {product.discountAmount > 0 && (
                      <Typography variant="caption" color="success.main" sx={{ fontWeight: 'medium' }}>
                        Giáº£m {product.discountAmount.toLocaleString('vi-VN')} Ä‘
                      </Typography>
                    )}
                    <Box sx={{ mt: 1 }}>
                      {product.features.map((feature, index) => (
                        <Typography key={index} variant="caption" color="text.secondary" display="block">
                          â€¢ {feature}
                        </Typography>
                      ))}
                    </Box>
                  </CardContent>
                </Card>
              </SwiperSlide>
            ))}
          </Swiper>
          <IconButton
            className="swiper-button-prev-related"
            sx={{
              position: 'absolute',
              left: -10,
              top: '50%',
              transform: 'translateY(-50%)',
              zIndex: 10,
              bgcolor: 'rgba(255,255,255,0.8)',
              boxShadow: 1,
              '&:hover': { bgcolor: 'rgba(255,255,255,1)', boxShadow: 3 },
            }}
          >
            <ChevronLeft />
          </IconButton>
          <IconButton
            className="swiper-button-next-related"
            sx={{
              position: 'absolute',
              right: -10,
              top: '50%',
              transform: 'translateY(-50%)',
              zIndex: 10,
              bgcolor: 'rgba(255,255,255,0.8)',
              boxShadow: 1,
              '&:hover': { bgcolor: 'rgba(255,255,255,1)', boxShadow: 3 },
            }}
          >
            <ChevronRight />
          </IconButton>
        </Box>
      </Box>
    </Box>
  );
};

export default RelatedProducts;

```

### ClientApp\src\components\Profile\AddPaymentMethod.jsx
```jsx
import React, { useState } from "react";
import { usePaymentMethod } from "@/hooks/api/usePaymentMethod";

const AddPaymentMethod = () => {
  const [name, setName] = useState("");
  const [description, setDescription] = useState("");
  const { addPaymentMethod, loading, message, setMessage } = usePaymentMethod();

  const handleSubmit = async (e) => {
    e.preventDefault();
    const result = await addPaymentMethod(name, description);
    if (result) {
      setName("");
      setDescription("");
    }
  };

  return (
    <div className="max-w-md mx-auto mt-12 p-6 bg-white rounded-xl shadow-lg border-t-4 border-[#cb1c22]">
      <h2 className="text-2xl font-bold mb-6 text-[#cb1c22] text-center">
        ThÃªm phÆ°Æ¡ng thá»©c thanh toÃ¡n
      </h2>
      <form onSubmit={handleSubmit}>
        <div className="mb-5">
          <label className="block text-gray-700 font-semibold mb-2">
            TÃªn phÆ°Æ¡ng thá»©c
          </label>
          <input
            type="text"
            value={name}
            onChange={(e) => setName(e.target.value)}
            className="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#cb1c22] focus:border-transparent transition-all duration-200"
            required
          />
        </div>
        <div className="mb-5">
          <label className="block text-gray-700 font-semibold mb-2">
            MÃ´ táº£
          </label>
          <textarea
            value={description}
            onChange={(e) => setDescription(e.target.value)}
            className="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#cb1c22] focus:border-transparent transition-all duration-200"
            rows={3}
          />
        </div>
        {message && (
          <div className="mb-4 text-center text-green-600 font-semibold">
            {message}
            <button type="button" className="ml-2 text-red-500" onClick={() => setMessage("")}>x</button>
          </div>
        )}
        <button
          type="submit"
          className="w-full bg-[#cb1c22] text-white font-bold py-3 rounded-md hover:bg-[#a3151a] transition-all duration-200"
          disabled={loading}
        >
          {loading ? "Äang thÃªm..." : "ThÃªm phÆ°Æ¡ng thá»©c"}
        </button>
      </form>
    </div>
  );
};

export default AddPaymentMethod;
```

### ClientApp\src\components\Profile\AddressBook.jsx
```jsx
import { useEffect, useState } from "react";
import { jwtDecode } from "jwt-decode";
import {
  Card,
  CardContent,
  CardHeader,
  Button,
  Typography,
  Modal,
  Box,
  TextField,
  IconButton,
  Dialog,
  DialogActions,
  DialogContent,
  DialogContentText,
  DialogTitle,
  Divider,
  Stack,
  Paper,
} from "@mui/material";
import { Delete, Edit, Add, Close } from "@mui/icons-material";
import { styled } from "@mui/material/styles";
import { useAddresses } from "@/hooks/api/useAddresses";

const StyledCard = styled(Card)(({ theme }) => ({
  maxWidth: "800px",
  margin: "2rem auto",
  borderRadius: "12px",
  backgroundColor: "#ffffff",
  boxShadow: "0 2px 8px rgba(0,0,0,0.1)",
  border: "1px solid #e5e7eb",
  overflow: "hidden",
}));

const AddressItem = styled(Paper)(({ theme }) => ({
  padding: theme.spacing(3),
  marginBottom: theme.spacing(2),
  borderRadius: "8px",
  backgroundColor: "#ffffff",
  border: "1px solid #e5e7eb",
  transition: "all 0.2s ease",
  "&:hover": {
    borderColor: "#cb1c22",
    boxShadow: "0 4px 12px rgba(203,28,34,0.15)",
    transform: "translateY(-1px)",
  },
}));

const AddressComponent = () => {
  const [openModal, setOpenModal] = useState(false);
  const [editMode, setEditMode] = useState(false);
  const [selectedAddress, setSelectedAddress] = useState(null);
  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);
  const [addressToDelete, setAddressToDelete] = useState(null);
  const [newAddress, setNewAddress] = useState({
    fullName: "",
    addressLine1: "",
    addressLine2: "",
    city: "",
    state: "",
    zipCode: "",
    country: "",
    phoneNumber: "",
  });
  const { addresses, loading, error, fetchAddresses, addAddress, updateAddress, deleteAddress } = useAddresses();

  useEffect(() => {
    fetchAddresses();
  }, [fetchAddresses]);

  const handleOpenModal = (address = null) => {
    setEditMode(!!address);
    setSelectedAddress(address);
    setNewAddress(
      address || {
        fullName: "",
        addressLine1: "",
        addressLine2: "",
        city: "",
        state: "",
        zipCode: "",
        country: "",
        phoneNumber: "",
      }
    );
    setOpenModal(true);
  };

  const handleCloseModal = () => {
    setOpenModal(false);
    setEditMode(false);
    setSelectedAddress(null);
  };

  const handleInputChange = (e) => {
    setNewAddress({ ...newAddress, [e.target.name]: e.target.value });
  };

  const handleSaveAddress = async () => {
    try {
      if (editMode && selectedAddress) {
        const response = await updateAddress(selectedAddress.id, newAddress);
        // setAddresses(
        //   addresses.map((addr) =>
        //     addr.id === selectedAddress.id ? response.data : addr
        //   )
        // );
      } else {
        const response = await addAddress(newAddress);
        // setAddresses([...addresses, response.data]);
      }
      handleCloseModal();
    } catch (error) {
      console.error("Lá»—i khi lÆ°u Ä‘á»‹a chá»‰:", error);
    }
  };

  const handleOpenDeleteDialog = (address) => {
    setAddressToDelete(address);
    setDeleteDialogOpen(true);
  };

  const handleCloseDeleteDialog = () => {
    setAddressToDelete(null);
    setDeleteDialogOpen(false);
  };

  const handleDeleteAddress = async () => {
    if (!addressToDelete) return;
    try {
      await deleteAddress(addressToDelete.id);
      // setAddresses(addresses.filter((addr) => addr.id !== addressToDelete.id));
    } catch (error) {
      console.error("Lá»—i khi xÃ³a Ä‘á»‹a chá»‰:", error);
    }
    handleCloseDeleteDialog();
  };

  const fieldLabels = {
    fullName: "Há» vÃ  tÃªn",
    addressLine1: "Äá»‹a chá»‰ dÃ²ng 1",
    addressLine2: "Äá»‹a chá»‰ dÃ²ng 2 (tÃ¹y chá»n)",
    city: "ThÃ nh phá»‘",
    state: "Tá»‰nh/ThÃ nh phá»‘",
    zipCode: "MÃ£ bÆ°u Ä‘iá»‡n",
    country: "Quá»‘c gia",
    phoneNumber: "Sá»‘ Ä‘iá»‡n thoáº¡i",
  };
  const hiddenFieldsInEditMode = ["id", "userId", "user"];

  return (
    <Box sx={{ p: 3 }}>
      <StyledCard>
        <CardHeader
          title={
            <Typography variant="h5" fontWeight="600" color="#1f2937">
              Sá»• Ä‘á»‹a chá»‰
            </Typography>
          }
          action={
            <Button
              variant="contained"
              startIcon={<Add />}
              onClick={() => handleOpenModal()}
              sx={{
                backgroundColor: "#cb1c22",
                color: "white",
                fontWeight: "500",
                px: 3,
                py: 1,
                borderRadius: "6px",
                textTransform: "none",
                boxShadow: "0 1px 3px rgba(0,0,0,0.1)",
                "&:hover": {
                  backgroundColor: "#a11520",
                  boxShadow: "0 2px 6px rgba(0,0,0,0.15)",
                },
              }}
            >
              ThÃªm Ä‘á»‹a chá»‰
            </Button>
          }
          sx={{
            borderBottom: "1px solid #e5e7eb",
            pb: 2,
          }}
        />
        <CardContent>
          {loading ? (
            <Box textAlign="center" py={4}>
              <Typography color="text.secondary">
                Äang táº£i Ä‘á»‹a chá»‰...
              </Typography>
            </Box>
          ) : addresses.length === 0 ? (
            <Box
              textAlign="center"
              py={8}
              sx={{
                backgroundColor: "#f9fafb",
                borderRadius: "8px",
                border: "1px dashed #d1d5db",
              }}
            >
              <Typography variant="h6" fontWeight="500" mb={1} color="#6b7280">
                ChÆ°a cÃ³ Ä‘á»‹a chá»‰ nÃ o
              </Typography>
              <Typography variant="body2" color="#9ca3af" mb={3}>
                ThÃªm Ä‘á»‹a chá»‰ Ä‘á»ƒ thuáº­n tiá»‡n cho viá»‡c giao hÃ ng
              </Typography>
              <Button
                variant="outlined"
                startIcon={<Add />}
                onClick={() => handleOpenModal()}
                sx={{
                  borderColor: "#cb1c22",
                  color: "#cb1c22",
                  fontWeight: "500",
                  px: 3,
                  py: 1,
                  textTransform: "none",
                  "&:hover": {
                    backgroundColor: "#cb1c22",
                    color: "white",
                    borderColor: "#cb1c22",
                  },
                }}
              >
                ThÃªm Ä‘á»‹a chá»‰ Ä‘áº§u tiÃªn
              </Button>
            </Box>
          ) : (
            <Stack spacing={3}>
              {addresses.map((address) => (
                <AddressItem key={address.id}>
                  <Stack
                    direction="row"
                    justifyContent="space-between"
                    alignItems="flex-start"
                  >
                    <Box>
                      <Typography
                        variant="h6"
                        fontWeight="600"
                        mb={1}
                        color="#1f2937"
                      >
                        {address.fullName}
                      </Typography>

                      <Typography variant="body1" mb={0.5} color="#374151">
                        {address.addressLine1}
                      </Typography>

                      {address.addressLine2 && (
                        <Typography variant="body2" mb={1} color="#6b7280">
                          {address.addressLine2}
                        </Typography>
                      )}

                      <Typography variant="body2" mb={1} color="#6b7280">
                        {address.city}, {address.state} {address.zipCode}
                      </Typography>

                      <Typography variant="body2" mb={2} color="#6b7280">
                        {address.country}
                      </Typography>

                      <Box
                        sx={{
                          display: "inline-flex",
                          alignItems: "center",
                          px: 2,
                          py: 0.5,
                          backgroundColor: "#f3f4f6",
                          borderRadius: "4px",
                          border: "1px solid #e5e7eb",
                        }}
                      >
                        <Typography
                          variant="body2"
                          fontWeight="500"
                          color="#374151"
                        >
                          ğŸ“ {address.phoneNumber}
                        </Typography>
                      </Box>
                    </Box>
                    <Stack direction="row" spacing={1}>
                      <IconButton
                        onClick={() => handleOpenModal(address)}
                        sx={{
                          color: "#3b82f6",
                          backgroundColor: "#eff6ff",
                          border: "1px solid #dbeafe",
                          width: 36,
                          height: 36,
                          "&:hover": {
                            backgroundColor: "#3b82f6",
                            color: "white",
                            borderColor: "#3b82f6",
                          },
                        }}
                      >
                        <Edit fontSize="small" />
                      </IconButton>
                      <IconButton
                        onClick={() => handleOpenDeleteDialog(address)}
                        sx={{
                          color: "#ef4444",
                          backgroundColor: "#fef2f2",
                          border: "1px solid #fecaca",
                          width: 36,
                          height: 36,
                          "&:hover": {
                            backgroundColor: "#ef4444",
                            color: "white",
                            borderColor: "#ef4444",
                          },
                        }}
                      >
                        <Delete fontSize="small" />
                      </IconButton>
                    </Stack>
                  </Stack>
                </AddressItem>
              ))}
            </Stack>
          )}
        </CardContent>
      </StyledCard>

      {/* Modal thÃªm/sá»­a Ä‘á»‹a chá»‰ */}
      <Modal open={openModal} onClose={handleCloseModal}>
        <Box
          sx={{
            position: "absolute",
            top: "50%",
            left: "50%",
            transform: "translate(-50%, -50%)",
            width: { xs: "90%", sm: "500px" },
            bgcolor: "background.paper",
            boxShadow: 24,
            borderRadius: "12px",
            maxHeight: "90vh",
            overflowY: "auto",
          }}
        >
          <Box sx={{ p: 3 }}>
            <Stack
              direction="row"
              justifyContent="space-between"
              alignItems="center"
              mb={3}
            >
              <Typography variant="h6" fontWeight="600">
                {editMode ? "Chá»‰nh sá»­a Ä‘á»‹a chá»‰" : "ThÃªm Ä‘á»‹a chá»‰ má»›i"}
              </Typography>
              <IconButton onClick={handleCloseModal}>
                <Close />
              </IconButton>
            </Stack>

            <Divider sx={{ mb: 3 }} />

            <Stack spacing={2}>
              {Object.keys(newAddress)
                .filter(
                  (key) => !editMode || !hiddenFieldsInEditMode.includes(key)
                )
                .map((key) => (
                  <TextField
                    key={key}
                    fullWidth
                    label={fieldLabels[key] || key}
                    name={key}
                    value={newAddress[key]}
                    onChange={handleInputChange}
                    size="small"
                    variant="outlined"
                    required={key !== "addressLine2"} // Chá»‰ addressLine2 lÃ  khÃ´ng báº¯t buá»™c
                  />
                ))}
            </Stack>

            <Stack direction="row" spacing={2} justifyContent="flex-end" mt={4}>
              <Button
                variant="outlined"
                onClick={handleCloseModal}
                sx={{
                  color: "text.primary",
                  borderColor: "rgba(0,0,0,0.23)",
                }}
              >
                Há»§y
              </Button>
              <Button
                variant="contained"
                onClick={handleSaveAddress}
                sx={{
                  backgroundColor: "primary.main",
                  "&:hover": {
                    backgroundColor: "primary.dark",
                  },
                }}
              >
                {editMode ? "Cáº­p nháº­t" : "LÆ°u Ä‘á»‹a chá»‰"}
              </Button>
            </Stack>
          </Box>
        </Box>
      </Modal>

      {/* Dialog xÃ¡c nháº­n xÃ³a */}
      <Dialog
        open={deleteDialogOpen}
        onClose={handleCloseDeleteDialog}
        PaperProps={{
          sx: {
            borderRadius: "12px",
            padding: "16px",
          },
        }}
      >
        <DialogTitle fontWeight="600">XÃ¡c nháº­n xÃ³a Ä‘á»‹a chá»‰</DialogTitle>
        <DialogContent>
          <DialogContentText>
            Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a Ä‘á»‹a chá»‰ nÃ y? Thao tÃ¡c nÃ y khÃ´ng thá»ƒ hoÃ n
            tÃ¡c.
          </DialogContentText>
        </DialogContent>
        <DialogActions sx={{ p: 2 }}>
          <Button
            onClick={handleCloseDeleteDialog}
            sx={{
              color: "text.primary",
              "&:hover": {
                backgroundColor: "rgba(0,0,0,0.04)",
              },
            }}
          >
            Há»§y
          </Button>
          <Button
            onClick={handleDeleteAddress}
            color="error"
            variant="contained"
            sx={{
              "&:hover": {
                backgroundColor: "error.dark",
              },
            }}
          >
            XÃ³a
          </Button>
        </DialogActions>
      </Dialog>
    </Box>
  );
};

export default AddressComponent;

```

### ClientApp\src\components\Profile\LoyaltyProgram.jsx
```jsx
import React, { useState } from 'react';
import { useLoyaltyStatus, useSpinWheel } from "@/hooks/api/useLoyalty";
import { motion } from 'framer-motion';
import {
  Box,
  Typography,
  LinearProgress,
  Button,
  Card,
  CardContent,
  Grid,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogContentText,
  DialogActions,
  CircularProgress,
  Snackbar,
  Alert,
  Paper,
  IconButton,
} from '@mui/material';
import { Casino, EmojiEvents, Celebration, InfoOutlined } from '@mui/icons-material';


const SpinWheel = ({ onSpin, spinning, disabled, spinCost }) => {
  const [rotation, setRotation] = useState(0);
  const rewards = [
    'Giáº£i nháº¥t',
    'Giáº£i nhÃ¬',
    'Giáº£i ba',
    'Khuyáº¿n khÃ­ch',
    'Giáº£i May máº¯n',
    'Giáº£i ba',
  ];

  const handleSpin = () => {
    if (!spinning && !disabled) {
      // Quay 5 vÃ²ng + random gÃ³c
      const nextRotation = rotation + 360 * 5 + Math.floor(Math.random() * 360);
      setRotation(nextRotation);
      onSpin();
    }
  };

  return (
    <Box sx={{ position: 'relative', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
      <motion.div
        animate={{ rotate: rotation }}
        transition={{ duration: spinning ? 3 : 0.5, ease: 'easeOut' }}
        style={{
          width: 450,
          height: 450,
          borderRadius: '50%',
          background: 'conic-gradient(#ff4d4d, #ffeb3b, #4caf50, #2196f3, #9c27b0, #ff9800, #ff4d4d)',
          position: 'relative',
          border: '10px solid #fff',
          boxShadow: '0 0 25px rgba(0,0,0,0.5)',
        }}
      >
        <Box
          sx={{
            position: 'absolute',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            bgcolor: 'white',
            borderRadius: '50%',
            width: 100,
            height: 100,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            boxShadow: '0 0 20px rgba(0,0,0,0.3)',
          }}
        >
          <Casino sx={{ fontSize: 60, color: '#1976d2' }} />
        </Box>

        {rewards.map((reward, index) => {
          const angle = (360 / rewards.length) * index;
          return (
            <Box
              key={index}
              sx={{
                position: 'absolute',
                width: '100%',
                height: '100%',
                transform: `rotate(${angle}deg)`,
                pointerEvents: 'none',
              }}
            >
              <Typography
                sx={{
                  position: 'absolute',
                  top: '15%',
                  left: '50%',
                  transform: 'translateX(-50%) rotate(0deg)',
                  color: 'white',
                  fontWeight: 'bold',
                  fontSize: '20px',
                  textShadow: '2px 2px 5px rgba(0,0,0,0.6)',
                  whiteSpace: 'nowrap',
                }}
              >
                {reward}
              </Typography>
            </Box>
          );
        })}
      </motion.div>

      <Box
        sx={{
          position: 'absolute',
          top: -30,
          width: 50,
          height: 50,
          bgcolor: 'red',
          clipPath: 'polygon(50% 100%, 0 0, 100% 0)',
          zIndex: 1,
          boxShadow: '0 5px 15px rgba(0,0,0,0.3)',
        }}
      />

      <Button
        variant="contained"
        color="primary"
        onClick={handleSpin}
        disabled={spinning || disabled}
        sx={{
          mt: 4,
          fontWeight: 'bold',
          padding: '15px 40px',
          fontSize: '18px',
          borderRadius: '30px',
          boxShadow: '0 5px 15px rgba(0,0,0,0.2)',
          '&:hover': { boxShadow: '0 8px 25px rgba(0,0,0,0.3)' },
        }}
      >
        {spinning ? (
          <>
            <CircularProgress size={24} sx={{ mr: 1, color: 'white' }} />
            Äang quay...
          </>
        ) : (
          `Quay ngay (${spinCost.toLocaleString()} Ä‘iá»ƒm)`
        )}
      </Button>
    </Box>
  );
};





const LoyaltyProgram = () => {
  const [openDialog, setOpenDialog] = useState(false);
  const [snackbar, setSnackbar] = useState({
    open: false,
    message: '',
    severity: 'success',
  });
  const [openRulesDialog, setOpenRulesDialog] = useState(false);

  // Custom hook láº¥y loyalty
  const { loyaltyData, loading, error, userId, refetch } = useLoyaltyStatus();
  // Custom hook quay vÃ²ng quay
  const { spin, spinning, spinResult } = useSpinWheel(userId, () => {
    setTimeout(() => {
      setOpenDialog(true);
      setSnackbar({ open: true, message: 'Quay thÃ nh cÃ´ng!', severity: 'success' });
      refetch();
    }, 3000);
  });

  const handleSpinWheel = () => {
    spin();
  };

  const handleCloseSnackbar = () => {
    setSnackbar((prev) => ({ ...prev, open: false }));
  };

  const getProgressValue = (currentPoints, rank) => {
    switch (rank) {
      case 'Admin':
        return 100;
      case 'VIP 1':
        return (currentPoints / 50000) * 100;
      case 'VIP 2':
        return (currentPoints / 125000) * 100;
      case 'VIP 3':
        return (currentPoints / 225000) * 100;
      default:
        return (currentPoints / 50000) * 100;
    }
  };

  if (loading) {
    return (
      <Box display="flex" justifyContent="center" alignItems="center" minHeight="100vh" bgcolor="#f5f5f5">
        <CircularProgress size={60} thickness={5} />
      </Box>
    );
  }

  if (error) {
    return (
      <Box display="flex" justifyContent="center" alignItems="center" minHeight="100vh" bgcolor="#f5f5f5">
        <Paper elevation={3} sx={{ p: 4, borderRadius: 2 }}>
          <Typography color="error" variant="h6">
            {error}
          </Typography>
          <Button variant="outlined" color="primary" sx={{ mt: 2 }} onClick={() => window.location.reload()}>
            Thá»­ láº¡i
          </Button>
        </Paper>
      </Box>
    );
  }

  return (
    <Box sx={{ minHeight: '100vh', bgcolor: '#f5f5f5', py: 4 }}>
      <Snackbar open={snackbar.open} autoHideDuration={6000} onClose={handleCloseSnackbar}>
        <Alert severity={snackbar.severity} sx={{ width: '100%' }}>
          {snackbar.message}
        </Alert>
      </Snackbar>

      <Box sx={{ maxWidth: '1000px', margin: '0 auto', px: 2, position: 'relative' }}>
        {/* NÃºt dáº¥u ! á»Ÿ gÃ³c trÃªn bÃªn pháº£i */}
        <IconButton
          onClick={() => setOpenRulesDialog(true)}
          sx={{
            position: 'absolute',
            top: 10,
            right: 10,
            color: '#1976d2',
            bgcolor: 'white',
            boxShadow: '0 2px 10px rgba(0,0,0,0.2)',
            '&:hover': { bgcolor: '#e3f2fd' },
          }}
        >
          <InfoOutlined sx={{ fontSize: 30 }} />
        </IconButton>

        <Paper
          elevation={4}
          sx={{
            p: 4,
            borderRadius: 3,
            background: 'linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%)',
            mb: 4,
          }}
        >
          <Typography
            variant="h3"
            align="center"
            gutterBottom
            sx={{
              fontWeight: 'bold',
              color: '#1976d2',
              textShadow: '1px 1px 3px rgba(0,0,0,0.1)',
            }}
          >
            <EmojiEvents sx={{ verticalAlign: 'middle', mr: 1, fontSize: 40 }} />
            ChÆ°Æ¡ng trÃ¬nh KhÃ¡ch hÃ ng ThÃ¢n thiáº¿t
          </Typography>

          {loyaltyData && (
            <Card sx={{ boxShadow: '0 8px 20px rgba(0,0,0,0.1)', borderRadius: 3 }}>
              <CardContent>
                <Grid container spacing={4} alignItems="center">
                  <Grid item xs={12}>
                    <Typography variant="h4" sx={{ fontWeight: 'bold', color: '#333', mb: 2, textAlign: 'center' }}>
                      Háº¡ng hiá»‡n táº¡i: <span style={{ color: '#1976d2' }}>{loyaltyData.currentRank}</span>
                    </Typography>
                    <Typography variant="h6" sx={{ color: '#555', mb: 2, textAlign: 'center' }}>
                      Äiá»ƒm tÃ­ch lÅ©y:{' '}
                      <span style={{ fontWeight: 'bold', color: '#4caf50' }}>
                        {loyaltyData.currentPoints.toLocaleString()}
                      </span>
                    </Typography>
                    {loyaltyData.currentRank !== 'Admin' && (
                      <Box sx={{ mb: 4, maxWidth: 600, mx: 'auto' }}>
                        <Typography variant="body1" color="text.secondary" sx={{ textAlign: 'center' }}>
                          Cáº§n thÃªm{' '}
                          <strong style={{ color: '#ff9800' }}>
                            {(loyaltyData.pointsNeededForNextRank || 0).toLocaleString()}
                          </strong>{' '}
                          Ä‘iá»ƒm Ä‘á»ƒ lÃªn háº¡ng tiáº¿p theo
                        </Typography>
                        <LinearProgress
                          variant="determinate"
                          value={getProgressValue(loyaltyData.currentPoints, loyaltyData.currentRank)}
                          sx={{
                            height: 12,
                            borderRadius: 6,
                            mt: 1,
                            backgroundColor: 'grey.200',
                            '& .MuiLinearProgress-bar': {
                              borderRadius: 6,
                              background: 'linear-gradient(to right, #4caf50, #81c784)',
                            },
                          }}
                        />
                      </Box>
                    )}
                    <Box sx={{ display: 'flex', justifyContent: 'center', marginTop: 6 }}>
                      <SpinWheel
                        onSpin={handleSpinWheel}
                        spinning={spinning}
                        disabled={!loyaltyData.canSpin}
                        spinCost={loyaltyData.spinCost || 0}
                      />
                    </Box>
                  </Grid>
                </Grid>
              </CardContent>
            </Card>
          )}
        </Paper>

        {/* Dialog káº¿t quáº£ vÃ²ng quay */}
        <Dialog
          open={openDialog}
          onClose={() => setOpenDialog(false)}
          PaperProps={{ sx: { borderRadius: 3, overflow: 'hidden' } }}
        >
          <DialogTitle
            sx={{
              bgcolor: 'primary.main',
              color: 'white',
              fontWeight: 'bold',
              display: 'flex',
              alignItems: 'center',
              py: 2,
            }}
          >
            <Celebration sx={{ mr: 1 }} />
            Káº¿t quáº£ vÃ²ng quay
          </DialogTitle>
          <DialogContent sx={{ pt: 3, pb: 2 }}>
            <DialogContentText sx={{ fontSize: '1.1rem', color: '#333' }}>
              {spinResult?.prizeType === 'Voucher' ? (
                <>
                  ChÃºc má»«ng! Báº¡n Ä‘Ã£ nháº­n Ä‘Æ°á»£c voucher trá»‹ giÃ¡{' '}
                  <strong style={{ color: '#4caf50' }}>
                    {(spinResult.voucher?.discountAmount || 0).toLocaleString()}â‚«
                  </strong>
                </>
              ) : (
                'Ráº¥t tiáº¿c! Báº¡n khÃ´ng trÃºng pháº§n thÆ°á»Ÿng láº§n nÃ y.'
              )}
            </DialogContentText>
            {spinResult?.prizeType === 'Voucher' && (
              <Paper
                elevation={2}
                sx={{
                  mt: 2,
                  p: 2,
                  background: 'linear-gradient(to right, #e8f5e9, #c8e6c9)',
                  borderRadius: 2,
                  textAlign: 'center',
                }}
              >
                <Typography variant="h5" sx={{ fontWeight: 'bold', color: '#2e7d32' }}>
                  {spinResult.voucher?.code || 'N/A'}
                </Typography>
                <Typography variant="body1" sx={{ mt: 1, color: '#555' }}>
                  Háº¡n sá»­ dá»¥ng:{' '}
                  {spinResult.voucher?.expiryDate
                    ? new Date(spinResult.voucher.expiryDate).toLocaleDateString('vi-VN')
                    : 'N/A'}
                </Typography>
              </Paper>
            )}
            <DialogContentText sx={{ mt: 2, fontSize: '1.1rem', color: '#333' }}>
              Äiá»ƒm cÃ²n láº¡i:{' '}
              <strong style={{ color: '#1976d2' }}>
                {(spinResult?.remainingPoints || 0).toLocaleString()}
              </strong>
            </DialogContentText>
          </DialogContent>
          <DialogActions sx={{ p: 2 }}>
            <Button
              onClick={() => setOpenDialog(false)}
              variant="contained"
              color="primary"
              sx={{ borderRadius: 20, px: 4 }}
            >
              ÄÃ³ng
            </Button>
          </DialogActions>
        </Dialog>

        {/* Dialog thá»ƒ lá»‡ */}
        <Dialog
          open={openRulesDialog}
          onClose={() => setOpenRulesDialog(false)}
          PaperProps={{ sx: { borderRadius: 3, overflow: 'hidden', minWidth: '500px' } }}
        >
          <DialogTitle
            sx={{
              bgcolor: 'primary.main',
              color: 'white',
              fontWeight: 'bold',
              display: 'flex',
              alignItems: 'center',
              py: 2,
            }}
          >
            <InfoOutlined sx={{ mr: 1 }} />
            Thá»ƒ lá»‡ chÆ°Æ¡ng trÃ¬nh
          </DialogTitle>
          <DialogContent sx={{ pt: 3 }}>
            <Typography variant="h6" sx={{ fontWeight: 'bold', mb: 2 }}>
              Quy Ä‘á»‹nh quay vÃ²ng quay may máº¯n
            </Typography>
            <Typography variant="body1" sx={{ mb: 1 }}>
              - Má»—i láº§n quay sáº½ tiÃªu tá»‘n sá»‘ Ä‘iá»ƒm tÆ°Æ¡ng á»©ng vá»›i háº¡ng thÃ nh viÃªn:
            </Typography>
            <Typography variant="body2" sx={{ ml: 2 }}>
              â€¢ VIP 0: 5000 Ä‘iá»ƒm<br />
              â€¢ VIP 1: 5000 Ä‘iá»ƒm<br />
              â€¢ VIP 2: 5000 Ä‘iá»ƒm<br />
              â€¢ VIP 3: 5000 Ä‘iá»ƒm
            </Typography>
            <Typography variant="h6" sx={{ fontWeight: 'bold', mt: 3, mb: 2 }}>
              Pháº§n thÆ°á»Ÿng theo háº¡ng thÃ nh viÃªn
            </Typography>
            <Typography variant="body1" sx={{ mb: 1 }}>
              - <strong>VIP 0</strong>:<br />
              â€¢ 50% cÆ¡ há»™i nháº­n voucher 50,000â‚«<br />
              â€¢ 30% cÆ¡ há»™i nháº­n voucher 20,000â‚«<br />
              â€¢ 20% khÃ´ng nháº­n Ä‘Æ°á»£c gÃ¬
            </Typography>
            <Typography variant="body1" sx={{ mb: 1 }}>
              - <strong>VIP 1</strong>:<br />
              â€¢ 40% cÆ¡ há»™i nháº­n voucher 100,000â‚«<br />
              â€¢ 30% cÆ¡ há»™i nháº­n voucher 50,000â‚«<br />
              â€¢ 30% cÆ¡ há»™i nháº­n voucher 20,000â‚«
            </Typography>
            <Typography variant="body1" sx={{ mb: 1 }}>
              - <strong>VIP 2</strong>:<br />
              â€¢ 30% cÆ¡ há»™i nháº­n voucher 200,000â‚«<br />
              â€¢ 30% cÆ¡ há»™i nháº­n voucher 100,000â‚«<br />
              â€¢ 40% cÆ¡ há»™i nháº­n voucher 50,000â‚«
            </Typography>
            <Typography variant="body1" sx={{ mb: 1 }}>
              - <strong>VIP 3</strong>:<br />
              â€¢ 20% cÆ¡ há»™i nháº­n voucher 350,000â‚«<br />
              â€¢ 30% cÆ¡ há»™i nháº­n voucher 200,000â‚«<br />
              â€¢ 50% cÆ¡ há»™i nháº­n voucher 100,000â‚«
            </Typography>
            <Typography variant="body2" sx={{ mt: 2, color: '#555' }}>
              LÆ°u Ã½: Voucher cÃ³ háº¡n sá»­ dá»¥ng 30 ngÃ y ká»ƒ tá»« ngÃ y nháº­n.
            </Typography>
          </DialogContent>
          <DialogActions sx={{ p: 2 }}>
            <Button
              onClick={() => setOpenRulesDialog(false)}
              variant="contained"
              color="primary"
              sx={{ borderRadius: 20, px: 4 }}
            >
              ÄÃ³ng
            </Button>
          </DialogActions>
        </Dialog>
      </Box>
    </Box>
  );
};

export default LoyaltyProgram;
```

### ClientApp\src\components\Profile\ProfileInfo.jsx
```jsx
import React, { useState, useEffect } from "react";
import { User } from "lucide-react";
import {
  Modal,
  TextField,
  Button,
  Typography,
  CircularProgress,
  Snackbar,
  Avatar,
  Alert,
  Box,
} from "@mui/material";
import { LocalizationProvider } from "@mui/x-date-pickers";
import { AdapterDateFns } from "@mui/x-date-pickers/AdapterDateFns";
import { DatePicker } from "@mui/x-date-pickers/DatePicker";
import EditIcon from "@mui/icons-material/Edit";
import { useUserProfile } from "@/hooks/api/useUserProfile";

const ProfileInfo = () => {
  // ÄÃ£ khai bÃ¡o openModal á»Ÿ dÆ°á»›i, xÃ³a dÃ²ng nÃ y Ä‘á»ƒ trÃ¡nh trÃ¹ng láº·p
  const [updatedUser, setUpdatedUser] = useState({
    fullName: "",
    email: "",
    role: "",
    phoneNumber: "",
    gender: "",
    dateOfBirth: "",
  });
  // ÄÃ£ khai bÃ¡o birthDate á»Ÿ dÆ°á»›i, xÃ³a dÃ²ng nÃ y Ä‘á»ƒ trÃ¡nh trÃ¹ng láº·p
  // ÄÃ£ khai bÃ¡o snackbar á»Ÿ dÆ°á»›i, xÃ³a dÃ²ng nÃ y Ä‘á»ƒ trÃ¡nh trÃ¹ng láº·p

  const {
    user,
    setUser,
    loading,
    error,
    userId,
    setUserId,
    initUserId,
    fetchUserProfile,
    updateUserProfile,
  } = useUserProfile();
  const [openModal, setOpenModal] = useState(false);
  // ÄÃ£ khai bÃ¡o updatedUser á»Ÿ dÆ°á»›i, xÃ³a dÃ²ng nÃ y Ä‘á»ƒ trÃ¡nh trÃ¹ng láº·p
  // ÄÃ£ khai bÃ¡o userId á»Ÿ dÆ°á»›i, xÃ³a dÃ²ng nÃ y Ä‘á»ƒ trÃ¡nh trÃ¹ng láº·p
  const [birthDate, setBirthDate] = useState(null);
  const [snackbar, setSnackbar] = useState({
    open: false,
    message: "",
    severity: "success",
  });

  // Add custom styles for VIP animations
  React.useEffect(() => {
    const style = document.createElement("style");
    style.textContent = `
      @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }
      .animate-spin-slow {
        animation: spin 3s linear infinite;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(style);
    return () => document.head.removeChild(style);
  }, []);

  useEffect(() => {
    const id = initUserId();
    if (id) {
      setUserId(id);
      fetchUserProfile(id).then((data) => {
        setUpdatedUser(data);
        if (data?.dateOfBirth) setBirthDate(new Date(data.dateOfBirth));
      });
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // fetchUserProfile Ä‘Ã£ Ä‘Æ°á»£c chuyá»ƒn vÃ o hook

  const handleOpenModal = () => setOpenModal(true);
  const handleCloseModal = () => setOpenModal(false);

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setUpdatedUser((prev) => ({ ...prev, [name]: value }));
  };

  const handleDateChange = (newValue) => {
    setBirthDate(newValue);
    setUpdatedUser((prev) => ({
      ...prev,
      dateOfBirth: newValue ? newValue.toISOString().split("T")[0] : "",
    }));
  };

  const handleSaveProfile = async () => {
    try {
      await updateUserProfile(updatedUser);
      showSnackbar("Cáº­p nháº­t thÃ´ng tin thÃ nh cÃ´ng", "success");
      handleCloseModal();
    } catch (error) {
      console.error("Failed to update profile:", error);
      showSnackbar(
        error?.response?.data?.message || "Cáº­p nháº­t tháº¥t báº¡i",
        "error"
      );
    }
  };

  const showSnackbar = (message, severity) => {
    setSnackbar({ open: true, message, severity });
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center h-64">
        <CircularProgress />
      </div>
    );
  }

  return (
    <div className="max-w-4xl mx-auto p-6">
      <Snackbar
        open={snackbar.open}
        autoHideDuration={6000}
        onClose={() => setSnackbar((prev) => ({ ...prev, open: false }))}
      >
        <Alert severity={snackbar.severity}>{snackbar.message}</Alert>
      </Snackbar>

      <div className="bg-gradient-to-br from-white via-gray-50 to-gray-100 rounded-3xl shadow-2xl overflow-hidden border border-gray-100 transform hover:scale-[1.01] transition-all duration-300">
        {/* Premium Header with Gradient */}
        <div
          className="relative p-8 overflow-hidden"
          style={{
            background: "linear-gradient(135deg, #cb1c22 0%, #8B0000 100%)",
          }}
        >
          {/* Decorative Elements */}
          <div className="absolute top-0 left-0 w-full h-full">
            <div className="absolute top-0 left-0 w-full h-full bg-black opacity-10"></div>
            <div className="absolute -top-24 -right-24 w-48 h-48 bg-white opacity-10 rounded-full"></div>
            <div className="absolute -bottom-24 -left-24 w-64 h-64 bg-white opacity-10 rounded-full"></div>
          </div>

          <div className="relative flex justify-between items-center">
            <div>
              <h1 className="text-3xl font-bold text-white mb-2">
                ThÃ´ng tin cÃ¡ nhÃ¢n
              </h1>
              <div className="w-20 h-1 bg-white opacity-50 rounded-full"></div>
            </div>
            <Button
              variant="contained"
              startIcon={<EditIcon />}
              onClick={handleOpenModal}
              sx={{
                bgcolor: "rgba(255,255,255,0.95)",
                color: "#cb1c22",
                fontWeight: "bold",
                backdropFilter: "blur(10px)",
                "&:hover": {
                  bgcolor: "#fff",
                  transform: "translateY(-2px)",
                  boxShadow: "0 10px 20px -10px rgba(0,0,0,0.3)",
                },
                transition: "all 0.3s ease",
              }}
            >
              Chá»‰nh sá»­a
            </Button>
          </div>
        </div>

        {/* Content with Premium Styling */}
        <div className="p-8 grid md:grid-cols-3 gap-8">
          {/* Avatar Section with Enhanced Design */}
          <div className="md:col-span-1">
            <div className="flex flex-col items-center p-6 bg-white rounded-2xl shadow-lg transform hover:translateY(-5px) transition-all duration-300">
              <div className="relative">
                <Avatar
                  sx={{
                    width: 140,
                    height: 140,
                    bgcolor: "#f8f9fa",
                    fontSize: "3.5rem",
                    border: "4px solid white",
                    boxShadow: "0 8px 16px -4px rgba(203,28,34,0.2)",
                  }}
                >
                  <User className="w-20 h-20 text-gray-700" />
                </Avatar>
                <div className="absolute bottom-0 right-0 w-8 h-8 bg-green-500 rounded-full border-4 border-white"></div>
              </div>{" "}
              <Typography variant="h5" className="font-bold mt-4 mb-1">
                {user.fullName || "KhÃ¡ch hÃ ng"}
              </Typography>{" "}
              <Typography
                variant="body2"
                className={`px-4 py-1.5 rounded-full font-semibold text-sm ${
                  user.role?.name?.toLowerCase().includes("vip")
                    ? "bg-gradient-to-r from-yellow-400 to-amber-400 text-amber-900 shadow-lg shadow-yellow-400/30"
                    : user.role?.name?.toLowerCase().includes("admin")
                    ? "bg-gradient-to-r from-purple-500 to-indigo-500 text-white shadow-lg shadow-purple-500/30"
                    : "bg-gray-100 text-gray-600"
                } transform hover:scale-105 transition-all duration-300`}
                sx={{
                  display: "flex",
                  alignItems: "center",
                  gap: "4px",
                }}
              >
                {user.role?.name?.toLowerCase().includes("vip") && (
                  <span className="text-amber-800">ğŸ‘‘</span>
                )}
                {user.role?.name?.toLowerCase().includes("admin") && (
                  <span className="text-purple-200">âš¡</span>
                )}
                <span
                  className={
                    user.role?.name?.toLowerCase().includes("vip") ||
                    user.role?.name?.toLowerCase().includes("admin")
                      ? "font-bold uppercase tracking-wide"
                      : ""
                  }
                >
                  {user.role?.name || "ThÃ nh viÃªn"}
                </span>
              </Typography>
            </div>
          </div>{" "}
          {/* Info Section with Premium Design */}
          <div className="md:col-span-2 bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-xl p-8 border border-gray-100 transform hover:shadow-2xl transition-all duration-300">
            <div className="mb-6">
              <h2 className="text-xl font-bold text-gray-800 mb-2 flex items-center">
                <span className="bg-gradient-to-r from-red-500 to-red-600 text-white p-2 rounded-lg mr-3">
                  â„¹ï¸
                </span>
                Chi tiáº¿t thÃ´ng tin
              </h2>
              <div className="h-1 w-16 bg-gradient-to-r from-red-500 to-red-600 rounded-full"></div>
            </div>
            <div className="grid gap-6">
              <InfoField icon="ğŸ‘¤" label="Há» vÃ  tÃªn" value={user.fullName} />
              <InfoField icon="ğŸ“§" label="Email" value={user.email} />
              <InfoField
                icon="ğŸ“±"
                label="Sá»‘ Ä‘iá»‡n thoáº¡i"
                value={user.phoneNumber || "ChÆ°a cáº­p nháº­t"}
              />
              <InfoField
                icon="âš§"
                label="Giá»›i tÃ­nh"
                value={user.gender || "ChÆ°a cáº­p nháº­t"}
              />
              <InfoField
                icon="ğŸ‚"
                label="NgÃ y sinh"
                value={
                  user.dateOfBirth
                    ? new Date(user.dateOfBirth).toLocaleDateString("vi-VN")
                    : "ChÆ°a cáº­p nháº­t"
                }
              />
            </div>
          </div>
        </div>
      </div>

      {/* Enhanced Modal */}
      <Modal
        open={openModal}
        onClose={handleCloseModal}
        aria-labelledby="modal-modal-title"
        BackdropProps={{
          sx: {
            backgroundColor: "rgba(0, 0, 0, 0.3)",
            backdropFilter: "blur(8px)",
          },
        }}
      >
        <Box
          sx={{
            position: "absolute",
            top: "50%",
            left: "50%",
            transform: "translate(-50%, -50%)",
            width: "100%",
            maxWidth: "32rem",
            bgcolor: "background.paper",
            borderRadius: "16px",
            boxShadow: "0 24px 48px -12px rgba(0,0,0,0.18)",
            p: 4,
            border: "1px solid",
            borderColor: "divider",
            outline: "none",
          }}
        >
          {/* Modal Header */}
          <div className="relative mb-6 pb-6 border-b border-gray-200">
            <Typography
              id="modal-title"
              variant="h5"
              className="font-bold text-center"
              sx={{
                color: "#cb1c22",
                position: "relative",
              }}
            >
              Chá»‰nh sá»­a thÃ´ng tin
            </Typography>
          </div>

          <LocalizationProvider dateAdapter={AdapterDateFns}>
            <div className="space-y-4">
              <TextField
                fullWidth
                label="Há» vÃ  tÃªn"
                name="fullName"
                value={updatedUser?.fullName || ""}
                onChange={handleInputChange}
                variant="outlined"
                size="small"
                sx={{
                  "& .MuiOutlinedInput-root": {
                    "&:hover fieldset": {
                      borderColor: "#cb1c22",
                    },
                    "&.Mui-focused fieldset": {
                      borderColor: "#cb1c22",
                    },
                  },
                }}
              />

              <TextField
                fullWidth
                label="Email"
                name="email"
                value={updatedUser?.email || ""}
                onChange={handleInputChange}
                variant="outlined"
                size="small"
                sx={{
                  "& .MuiOutlinedInput-root": {
                    "&:hover fieldset": {
                      borderColor: "#cb1c22",
                    },
                    "&.Mui-focused fieldset": {
                      borderColor: "#cb1c22",
                    },
                  },
                }}
              />

              <TextField
                fullWidth
                label="Sá»‘ Ä‘iá»‡n thoáº¡i"
                name="phoneNumber"
                value={updatedUser?.phoneNumber || ""}
                onChange={handleInputChange}
                variant="outlined"
                size="small"
                sx={{
                  "& .MuiOutlinedInput-root": {
                    "&:hover fieldset": {
                      borderColor: "#cb1c22",
                    },
                    "&.Mui-focused fieldset": {
                      borderColor: "#cb1c22",
                    },
                  },
                }}
              />

              <TextField
                fullWidth
                label="Giá»›i tÃ­nh"
                name="gender"
                value={updatedUser?.gender || ""}
                onChange={handleInputChange}
                variant="outlined"
                size="small"
                select
                SelectProps={{
                  native: true,
                  sx: {
                    "&:focus": {
                      backgroundColor: "transparent",
                    },
                  },
                }}
                sx={{
                  "& .MuiOutlinedInput-root": {
                    "&:hover fieldset": {
                      borderColor: "#cb1c22",
                    },
                    "&.Mui-focused fieldset": {
                      borderColor: "#cb1c22",
                    },
                  },
                }}
              >
                <option value=""></option>
                <option value="Nam">Nam</option>
                <option value="Ná»¯">Ná»¯</option>
                <option value="KhÃ¡c">KhÃ¡c</option>
              </TextField>

              <DatePicker
                label="NgÃ y sinh"
                value={birthDate}
                onChange={handleDateChange}
                renderInput={(params) => (
                  <TextField
                    {...params}
                    fullWidth
                    size="small"
                    sx={{
                      "& .MuiOutlinedInput-root": {
                        "&:hover fieldset": {
                          borderColor: "#cb1c22",
                        },
                        "&.Mui-focused fieldset": {
                          borderColor: "#cb1c22",
                        },
                      },
                    }}
                  />
                )}
                inputFormat="dd/MM/yyyy"
              />

              {/* Action Buttons */}
              <div className="flex justify-end space-x-3 pt-6">
                <Button
                  variant="outlined"
                  onClick={handleCloseModal}
                  sx={{
                    borderColor: "rgba(0, 0, 0, 0.2)",
                    color: "rgb(107, 114, 128)",
                    "&:hover": {
                      borderColor: "rgb(107, 114, 128)",
                      backgroundColor: "rgba(0, 0, 0, 0.04)",
                    },
                  }}
                >
                  Há»§y
                </Button>
                <Button
                  variant="contained"
                  onClick={handleSaveProfile}
                  sx={{
                    bgcolor: "#cb1c22",
                    color: "white",
                    boxShadow: "0 4px 10px -3px rgba(203,28,34,0.5)",
                    "&:hover": {
                      bgcolor: "#e62128",
                      transform: "translateY(-1px)",
                      boxShadow: "0 6px 15px -3px rgba(203,28,34,0.5)",
                    },
                  }}
                >
                  LÆ°u thay Ä‘á»•i
                </Button>
              </div>
            </div>
          </LocalizationProvider>
        </Box>
      </Modal>
    </div>
  );
};

// Reusable Info Field Component
const InfoField = ({ icon, label, value }) => (
  <div className="bg-white rounded-xl p-4 border border-gray-100 hover:border-red-200 hover:bg-red-50/30 transition-all duration-300 transform hover:scale-[1.02] hover:shadow-md group">
    <div className="flex items-start space-x-4">
      <div className="text-2xl bg-gradient-to-br from-gray-100 to-gray-200 p-2 rounded-lg group-hover:from-red-100 group-hover:to-red-200 transition-all duration-300">
        {icon}
      </div>
      <div className="flex-1">
        <Typography
          variant="subtitle2"
          className="text-gray-500 font-medium mb-2 uppercase tracking-wide text-xs"
        >
          {label}
        </Typography>
        <Typography
          variant="body1"
          className="font-semibold text-gray-800 leading-relaxed"
          sx={{
            transition: "all 0.3s ease",
            "&:hover": {
              color: "#cb1c22",
            },
          }}
        >
          {value || "ChÆ°a cáº­p nháº­t"}
        </Typography>
      </div>
      <div className="opacity-0 group-hover:opacity-100 transition-opacity duration-300">
        <div className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
      </div>
    </div>
  </div>
);

export default ProfileInfo;

```

### ClientApp\src\components\Profile\ProfileSidebar.jsx
```jsx
import React from "react";
import "./ProfileSidebar.css"; // Náº¿u cÃ³ file CSS riÃªng

const ProfileSidebar = ({ setActiveTab }) => {

  return (
    <div className="profile-sidebar m-24">
      <ul>
        <li onClick={() => setActiveTab("profile")}>ThÃ´ng tin cÃ¡ nhÃ¢n</li>
        <li onClick={() => setActiveTab("orders")}>ÄÆ¡n hÃ ng cá»§a tÃ´i</li>
        <li onClick={() => setActiveTab("loyalty")}>KhÃ¡ch hÃ ng thÃ¢n thiáº¿t</li>
        <li onClick={() => setActiveTab("address")}> Sá»• Ä‘á»‹a chá»‰ nháº­n hÃ ng</li>
      </ul>
    </div>
  );
};

export default ProfileSidebar;

```

### ClientApp\src\components\Profile\UserOrders.jsx
```jsx
import React, { useEffect, useState } from "react";
import { useOrders } from "@/hooks/api/useOrders";
import { useNavigate } from "react-router-dom";
import {
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  Typography,
  CircularProgress,
  Avatar,
  Collapse,
  IconButton,
  Box,
  Chip,
} from "@mui/material";
import { KeyboardArrowDown, KeyboardArrowUp } from "@mui/icons-material";

const UserOrders = () => {
  // ÄÃ£ khai bÃ¡o expandedOrder á»Ÿ dÆ°á»›i, xÃ³a dÃ²ng nÃ y Ä‘á»ƒ trÃ¡nh trÃ¹ng láº·p
  const { orders, loading, error, userId, setUserId, initUserId, fetchOrders } = useOrders();
  const [expandedOrder, setExpandedOrder] = useState(null);
  const navigate = useNavigate();

  useEffect(() => {
    const id = initUserId();
    if (id) {
      setUserId(id);
      fetchOrders(id, 1, 10);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const toggleOrderExpand = (orderId) => {
    setExpandedOrder(expandedOrder === orderId ? null : orderId);
  };

  const getStatusColor = (status) => {
    switch (status) {
      case "Delivered":
        return "success";
      case "Pending":
        return "warning";
      case "Cancelled":
        return "error";
      case "Paid":
        return "primary";
      default:
        return "default";
    }
  };

  const handleProductClick = (productId) => {
    console.log("Product ID clicked:", productId);
    console.log("Navigating to:", `/product/${productId}`);

    if (productId) {
      navigate(`/product/${productId}`);
    } else {
      console.error("Product ID is undefined or null");
    }
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <CircularProgress />
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <Typography color="error">{error}</Typography>
      </div>
    );
  }

  return (
    <div style={{ maxWidth: "1200px", margin: "6rem auto", padding: "0 1rem" }}>
      <Typography variant="h4" gutterBottom align="center">
        Danh sÃ¡ch Ä‘Æ¡n hÃ ng cá»§a báº¡n
      </Typography>

      {orders.length === 0 ? (
        <Box sx={{ textAlign: "center", p: 4 }}>
          <Typography variant="h6">Báº¡n chÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o</Typography>
          <Typography variant="body1" sx={{ mt: 2 }}>
            HÃ£y báº¯t Ä‘áº§u mua sáº¯m ngay Ä‘á»ƒ tráº£i nghiá»‡m dá»‹ch vá»¥ cá»§a chÃºng tÃ´i!
          </Typography>
        </Box>
      ) : (
        <TableContainer
          component={Paper}
          sx={{ border: "1px solid #e0e0e0", borderRadius: "8px" }}
        >
          <Table>
            <TableHead sx={{ backgroundColor: "#f5f5f5" }}>
              <TableRow>
                <TableCell />
                <TableCell sx={{ fontWeight: "bold" }}>MÃ£ Ä‘Æ¡n hÃ ng</TableCell>
                <TableCell sx={{ fontWeight: "bold" }} align="right">
                  NgÃ y Ä‘áº·t
                </TableCell>
                <TableCell sx={{ fontWeight: "bold" }} align="right">
                  Tá»•ng tiá»n
                </TableCell>
                <TableCell sx={{ fontWeight: "bold" }} align="center">
                  Tráº¡ng thÃ¡i
                </TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {orders.map((order) => (
                <React.Fragment key={order.id}>
                  <TableRow hover>
                    <TableCell>
                      <IconButton
                        aria-label="expand row"
                        size="small"
                        onClick={() => toggleOrderExpand(order.id)}
                      >
                        {expandedOrder === order.id ? (
                          <KeyboardArrowUp />
                        ) : (
                          <KeyboardArrowDown />
                        )}
                      </IconButton>
                    </TableCell>
                    <TableCell component="th" scope="row">
                      #{order.id}
                    </TableCell>
                    <TableCell align="right">
                      {new Date(order.orderDate).toLocaleDateString("vi-VN")}
                    </TableCell>
                    <TableCell align="right">
                      {order.totalAmount.toLocaleString("vi-VN")}â‚«
                    </TableCell>
                    <TableCell align="center">
                      <Chip
                        label={order.orderStatus}
                        color={getStatusColor(order.orderStatus)}
                        variant="outlined"
                      />
                    </TableCell>
                  </TableRow>
                  <TableRow>
                    <TableCell
                      style={{ paddingBottom: 0, paddingTop: 0 }}
                      colSpan={6}
                    >
                      <Collapse
                        in={expandedOrder === order.id}
                        timeout="auto"
                        unmountOnExit
                      >
                        <Box sx={{ margin: 2 }}>
                          <Typography variant="h6" gutterBottom>
                            Chi tiáº¿t Ä‘Æ¡n hÃ ng
                          </Typography>
                          <Table size="small">
                            <TableHead>
                              <TableRow>
                                <TableCell>Sáº£n pháº©m</TableCell>
                                <TableCell align="right">ÄÆ¡n giÃ¡</TableCell>
                                <TableCell align="center">Sá»‘ lÆ°á»£ng</TableCell>
                                <TableCell align="right">ThÃ nh tiá»n</TableCell>
                              </TableRow>
                            </TableHead>
                            <TableBody>
                              {order.items.map((item) => {
                                console.log("Item data:", item); // Debug: xem cáº¥u trÃºc item
                                return (
                                  <TableRow
                                    key={`${order.id}-${item.productVariantId}`}
                                  >
                                    <TableCell>
                                      <Box
                                        sx={{
                                          display: "flex",
                                          alignItems: "center",
                                          gap: 2,
                                        }}
                                      >
                                        <Avatar
                                          src={
                                            item.productImage?.startsWith(
                                              "http"
                                            )
                                              ? item.productImage // áº¢nh tá»« API (URL Ä‘áº§y Ä‘á»§)
                                              : `${process.env.REACT_APP_API_BASE_URL}/${item.productImage}` // áº¢nh local trong wwwroot
                                          }
                                          sx={{ width: 56, height: 56 }}
                                          variant="rounded"
                                          alt="Product img"
                                          className="size-10"
                                          onError={(e) => {
                                            e.target.onerror = null;
                                          }}
                                        />
                                        <Box>
                                          <Typography
                                            variant="subtitle1"
                                            sx={{
                                              cursor: "pointer",
                                              color: "primary.main",
                                              "&:hover": {
                                                textDecoration: "underline",
                                                color: "primary.dark",
                                              },
                                            }}
                                            onClick={() =>
                                              handleProductClick(item.productId)
                                            }
                                          >
                                            {item.productName}
                                          </Typography>
                                          <Typography
                                            variant="body2"
                                            color="text.secondary"
                                          >
                                            {item.variantColor} -{" "}
                                            {item.variantStorage}
                                          </Typography>
                                        </Box>
                                      </Box>
                                    </TableCell>
                                    <TableCell align="right">
                                      {item.price.toLocaleString("vi-VN")}â‚«
                                    </TableCell>
                                    <TableCell align="center">
                                      {item.quantity}
                                    </TableCell>
                                    <TableCell align="right">
                                      {(
                                        item.price * item.quantity
                                      ).toLocaleString("vi-VN")}
                                      â‚«
                                    </TableCell>
                                  </TableRow>
                                );
                              })}
                            </TableBody>
                          </Table>
                          <Box
                            sx={{
                              mt: 2,
                              display: "flex",
                              justifyContent: "space-between",
                            }}
                          >
                            <Typography variant="body2">
                              PhÆ°Æ¡ng thá»©c thanh toÃ¡n:{" "}
                              {order.paymentMethodId === 1
                                ? "Tiá»n máº·t"
                                : "Thanh toÃ¡n online"}
                            </Typography>
                            <Box sx={{ textAlign: "right" }}>
                              <Typography variant="body1">
                                <strong>Tá»•ng cá»™ng:</strong>{" "}
                                {order.totalAmount.toLocaleString("vi-VN")}â‚«
                              </Typography>
                              {order.orderStatus === "Pending" && (
                                <Typography
                                  variant="body2"
                                  color="text.secondary"
                                >
                                  ÄÆ¡n hÃ ng Ä‘ang chá» xá»­ lÃ½
                                </Typography>
                              )}
                            </Box>
                          </Box>
                        </Box>
                      </Collapse>
                    </TableCell>
                  </TableRow>
                </React.Fragment>
              ))}
            </TableBody>
          </Table>
        </TableContainer>
      )}
    </div>
  );
};

export default UserOrders;

```

### ClientApp\src\components\Profile\ViewedProducts.jsx
```jsx
import React from "react";

const products = [
  {
    id: 1,
    name: "Samsung Galaxy S25 Ultra 5G",
    price: "31.990.000 â‚«",
    oldPrice: "33.990.000 â‚«",
    discount: "-6%",
    img: "https://cdn2.cellphones.com.vn/358x/media/catalog/product/x/i/xiaomi-14-ultra.png",
  },
  {
    id: 2,
    name: "iPhone 15 Pro Max 256GB",
    price: "29.090.000 â‚«",
    oldPrice: "35.000.000 â‚«",
    discount: "-17%",
    img: "https://cdn2.cellphones.com.vn/358x/media/catalog/product/x/i/xiaomi-14-ultra.png",
  },
  {
    id: 3,
    name: "Xiaomi 14 Ultra 512GB",
    price: "26.990.000 â‚«",
    oldPrice: "29.300.000 â‚«",
    discount: "-8%",
    img: "https://cdn2.cellphones.com.vn/358x/media/catalog/product/x/i/xiaomi-14-ultra.png",
  },
  {
    id: 4,
    name: "OPPO Find X7 Ultra 1TB",
    price: "27.990.000 â‚«",
    oldPrice: "31.100.000 â‚«",
    discount: "-10%",
    img: "https://cdn2.cellphones.com.vn/358x/media/catalog/product/x/i/xiaomi-14-ultra.png",
  },
];

const ViewedProducts = () => {
  return (
    <div className="viewed-products">
      <h2>Sáº£n pháº©m Ä‘Ã£ xem</h2>
      <div className="products-row">
        {products.map((product) => (
          <div key={product.id} className="product-item">
            <img src={product.img} alt={product.name} />
            <p>{product.name}</p>
            <div className="price-container">
              <s className="old-price">{product.oldPrice}</s>
              <span className="discount">{product.discount}</span>
            </div>
            <p className="price">{product.price}</p>
          </div>
        ))}
      </div>
    </div>
  );
};

export default ViewedProducts;

```

### ClientApp\src\components\ServiceSlider\ServiceSlider.jsx
```jsx
import React from "react";
import "./ServiceSlider.css"; // Import file CSS

const services = [
  {
    href: "dich-vu/the-game",
    imgSrc: "https://cdn2.fptshop.com.vn/svg/the_game_a74fbf07e8_32a77df1b0.svg?w=128&q=100",
    title: "Tháº» game",
  },
  {
    href: "dich-vu/thanh-toan-hoa-don-internet",
    imgSrc: "https://cdn2.fptshop.com.vn/svg/tien_internet_bd9a355225_03e954c658.svg?w=128&q=100",
    title: "ÄÃ³ng phÃ­ Internet",
  },
  {
    href: "dich-vu/thanh-toan-tra-gop",
    imgSrc: "https://cdn2.fptshop.com.vn/svg/tra_gop_d424d9683f_a8e4090e13.svg?w=128&q=100",
    title: "Thanh toÃ¡n tráº£ gÃ³p",
  },
  {
    href: "dich-vu/thanh-toan-tien-nuoc",
    imgSrc: "https://cdn2.fptshop.com.vn/svg/tien_nuoc_7f2b577ea8_fc7c4fe67e.svg?w=128&q=100",
    title: "Tiá»n nÆ°á»›c",
  },
  {
    href: "dich-vu/thanh-toan-tien-dien",
    imgSrc: "https://cdn2.fptshop.com.vn/svg/tien_dien_522ab38b64_fc4ab62614.svg?w=128&q=100",
    title: "Tiá»n Ä‘iá»‡n",
  },
  {
    href: "dich-vu",
    imgSrc: "https://cdn2.fptshop.com.vn/svg/Khac_a756550960.svg?w=128&q=100",
    title: "Dá»‹ch vá»¥ khÃ¡c",
  },
];

const ServiceSlider = () => {
  return (
    <div className="service-container">
      <div className="service-wrapper">
        {services.map((service, index) => (
          <a key={index} href={service.href} className="service-item">
            <img src={service.imgSrc} alt={service.title} className="service-icon" />
            <p className="service-title">{service.title}</p>
          </a>
        ))}
      </div>
    </div>
  );
};

export default ServiceSlider;

```

### ClientApp\src\components\shared\ProductCard.js
```js
import React from 'react';

const ProductCard = ({ product }) => {

  // Xá»­ lÃ½ áº£nh chÃ­nh xÃ¡c, há»— trá»£ cáº£ link tuyá»‡t Ä‘á»‘i vÃ  tÆ°Æ¡ng Ä‘á»‘i
  let primaryImage = '/images/default-product.png';
  if (product.images && product.images.length > 0) {
    const imgObj = product.images.find(img => img.isPrimary) || product.images[0];
    if (imgObj?.imageUrl) {
      primaryImage = imgObj.imageUrl.startsWith('http')
        ? imgObj.imageUrl
        : `${process.env.REACT_APP_API_BASE_URL ? process.env.REACT_APP_API_BASE_URL.replace(/\/$/, '') : ''}/${imgObj.imageUrl.replace(/^\//, '')}`;
    }
  }

  const isFlashSaleActive = product.isFlashSale && product.flashSalePrice && 
                            new Date(product.flashSaleStartDate) <= new Date() && 
                            new Date(product.flashSaleEndDate) >= new Date();

  return (
    <div className="group relative bg-primary-dark border border-white-20 rounded-lg overflow-hidden transition-all duration-300 hover:border-electric-blue">
      <div className="aspect-w-1 aspect-h-1 w-full overflow-hidden">
        <img
          src={primaryImage}
          alt={product.name}
          className="w-full h-full object-cover object-center transition-transform duration-300 group-hover:scale-105"
          onError={e => { e.target.onerror = null; e.target.src = '/images/default-product.png'; }}
        />
      </div>
      <div className="p-4 text-left">
        <h3 className="font-sans text-base font-semibold text-white">
          <a href={`/product/${product.id}`}>
            <span aria-hidden="true" className="absolute inset-0" />
            {product.name}
          </a>
        </h3>
        <div className="mt-1 flex items-baseline">
          {isFlashSaleActive ? (
            <>
              <p className="text-lg font-bold text-neon-magenta mr-2">
                {product.flashSalePrice?.toLocaleString('vi-VN')}â‚«
              </p>
              <p className="text-sm text-light-gray line-through">
                {product.variants[0]?.price?.toLocaleString('vi-VN')}â‚«
              </p>
            </>
          ) : (
            <p className="text-lg font-bold text-electric-blue">
              {product.variants[0]?.price?.toLocaleString('vi-VN')}â‚«
            </p>
          )}
        </div>
      </div>
      <div className="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
        <button className="p-2 rounded-full bg-electric-blue text-primary-dark">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 19a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H6Z"/><path d="M12 15V9"/><path d="M9 12h6"/></svg>
        </button>
      </div>
    </div>
  );
};

export default ProductCard;
```

### ClientApp\src\components\shoppingcart\CartDrawer.jsx
```jsx
import React, { useEffect, useState } from "react";
import { 
  Drawer, 
  IconButton, 
  List, 
  ListItemText, 
  Avatar, 
  Typography, 
  Button, 
  Box, 
  TextField, 
  Modal, 
  Checkbox,
  Chip,
  Divider,
  CircularProgress
} from "@mui/material";
import { X, Delete, Plus, Minus, Gift } from "lucide-react";
import { useNavigate } from "react-router-dom";
import axios from "axios";
import { jwtDecode } from "jwt-decode";

const CartDrawer = ({ isOpen, onClose }) => {
  const [cartItems, setCartItems] = useState([]);
  const [selectedItems, setSelectedItems] = useState([]);
  const [userId, setUserId] = useState(null);
  const [voucherCode, setVoucherCode] = useState("");
  const [discountAmount, setDiscountAmount] = useState(0);
  const [totalAmount, setTotalAmount] = useState(0);
  const [originalTotal, setOriginalTotal] = useState(0);
  const [selectedItem, setSelectedItem] = useState(null);
  const [quantityModalOpen, setQuantityModalOpen] = useState(false);
  const [voucherApplied, setVoucherApplied] = useState(false);
  const [loading, setLoading] = useState(false);
  const [voucherLoading, setVoucherLoading] = useState(false);
  const navigate = useNavigate();

  useEffect(() => {
    const fetchCart = async () => {
      const token = localStorage.getItem("token");
      setLoading(true);
      
      try {
        let items = [];
        let id = null;
        
        if (token) {
          const decoded = jwtDecode(token);
          id = parseInt(decoded.sub, 10);
          setUserId(id);
          
          // Láº¥y cáº£ giá» hÃ ng tá»« API vÃ  session storage náº¿u cÃ³
          const [apiResponse, sessionCart] = await Promise.all([
            axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/Cart?userId=${id}`, {
              headers: { Authorization: `Bearer ${token}` },
            }),
            sessionStorage.getItem("cart")
          ]);

          items = apiResponse.data;

          // Merge vá»›i giá» hÃ ng tá»« session náº¿u cÃ³
          if (sessionCart) {
            const sessionItems = JSON.parse(sessionCart);
            const mergedItems = await mergeCartItems(items, sessionItems);
            items = mergedItems;
            sessionStorage.removeItem("cart");
          }
        } else {
          // ChÆ°a Ä‘Äƒng nháº­p: láº¥y tá»« session storage
          const sessionCart = sessionStorage.getItem("cart");
          if (sessionCart) {
            const sessionItems = JSON.parse(sessionCart);
            items = await Promise.all(
              sessionItems.map(async (item) => {
                try {
                  const response = await axios.get(
                    `${process.env.REACT_APP_API_BASE_URL}/api/Cart/variant-info/${item.productVariantId}`
                  );
                  return {
                    ...item,
                    productName: response.data.productName,
                    productImage: response.data.productImage,
                    variantColor: response.data.variantColor,
                    variantStorage: response.data.variantStorage,
                    productPrice: response.data.price,
                    productDiscountPrice: response.data.discountPrice
                  };
                } catch (error) {
                  console.error("Error fetching variant info:", error);
                  return {
                    ...item,
                    productName: "Sáº£n pháº©m khÃ´ng tÃªn",
                    productImage: "https://via.placeholder.com/100",
                    variantColor: "KhÃ´ng xÃ¡c Ä‘á»‹nh",
                    variantStorage: "KhÃ´ng xÃ¡c Ä‘á»‹nh",
                    productPrice: 0,
                    productDiscountPrice: 0
                  };
                }
              })
            );
          }
        }

        setCartItems(items);
        setSelectedItems(items);
        calculateTotalAmount(items, discountAmount);
      } catch (error) {
        console.error("Error fetching cart:", error);
      } finally {
        setLoading(false);
      }
    };

    const mergeCartItems = async (apiItems, sessionItems) => {
      // Gá»™p cÃ¡c sáº£n pháº©m trÃ¹ng nhau
      const merged = [...apiItems];
      
      for (const sessionItem of sessionItems) {
        const existingItem = merged.find(item => 
          item.productVariantId === sessionItem.productVariantId);
        
        if (existingItem) {
          existingItem.quantity += sessionItem.quantity;
        } else {
          try {
            const response = await axios.get(
              `${process.env.REACT_APP_API_BASE_URL}/api/Cart/variant-info/${sessionItem.productVariantId}`
            );
            merged.push({
              ...sessionItem,
              productName: response.data.productName,
              productImage: response.data.productImage,
              variantColor: response.data.variantColor,
              variantStorage: response.data.variantStorage,
              productPrice: response.data.price,
              productDiscountPrice: response.data.discountPrice
            });
          } catch (error) {
            console.error("Error fetching variant info:", error);
          }
        }
      }
      
      return merged;
    };

    if (isOpen) {
      fetchCart();
    }
  }, [isOpen]);

  // Sá»­a lá»—i: Cáº­p nháº­t hÃ m calculateTotalAmount Ä‘á»ƒ nháº­n discountAmount nhÆ° má»™t tham sá»‘
  const calculateTotalAmount = (items, discount = discountAmount) => {
    const total = items.reduce((sum, item) => {
      const price = item.productDiscountPrice || item.productPrice;
      return sum + price * item.quantity;
    }, 0);
    
    setOriginalTotal(total);
    setTotalAmount(total - discount); // Ãp dá»¥ng giáº£m giÃ¡ vÃ o tá»•ng tiá»n
  };

  const handleRemoveItem = async (id) => {
    try {
      const token = localStorage.getItem("token");
      const numericId = Number(id);

      if (token && userId) {
        await axios.delete(`${process.env.REACT_APP_API_BASE_URL}/api/Cart/remove/${numericId}?userId=${userId}`, {
          headers: { Authorization: `Bearer ${token}` },
        });
      } else {
        const sessionCart = sessionStorage.getItem("cart");
        if (sessionCart) {
          const updatedCart = JSON.parse(sessionCart).filter(item => item.productVariantId !== numericId);
          sessionStorage.setItem("cart", JSON.stringify(updatedCart));
        }
      }

      const updatedItems = cartItems.filter((item) => item.productVariantId !== numericId);
      setCartItems(updatedItems);
      setSelectedItems(updatedItems);
      calculateTotalAmount(updatedItems);
    } catch (error) {
      console.error("Error removing item:", error);
    }
  };

  // Sá»­a lá»—i: Cáº­p nháº­t hÃ m handleApplyVoucher Ä‘á»ƒ tÃ­nh láº¡i totalAmount
  const handleApplyVoucher = async () => {
    if (!userId) {
      alert("Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ táº­n hÆ°á»Ÿng Æ°u Ä‘Ã£i.");
      return;
    }

    if (voucherApplied) {
      alert("Voucher Ä‘Ã£ Ä‘Æ°á»£c Ã¡p dá»¥ng.");
      return;
    }

    setVoucherLoading(true);
    try {
      const response = await axios.post(`${process.env.REACT_APP_API_BASE_URL}/api/vouchers/apply`, { 
        code: voucherCode, 
        userId 
      });
      
      const newDiscountAmount = response.data.discountAmount;
      setDiscountAmount(newDiscountAmount);
      setVoucherApplied(true);
      
      // TÃ­nh toÃ¡n láº¡i tá»•ng tiá»n vá»›i giÃ¡ trá»‹ giáº£m giÃ¡ má»›i
      calculateTotalAmount(selectedItems, newDiscountAmount);
    } catch (error) {
      console.error("Error applying voucher:", error);
      alert(error.response?.data?.message || "Voucher khÃ´ng há»£p lá»‡ hoáº·c Ä‘Ã£ háº¿t háº¡n.");
    } finally {
      setVoucherLoading(false);
    }
  };

  // Sá»­a lá»—i: Cáº­p nháº­t hÃ m handleRemoveVoucher Ä‘á»ƒ tÃ­nh láº¡i totalAmount
  const handleRemoveVoucher = () => {
    setVoucherCode("");
    setDiscountAmount(0);
    setVoucherApplied(false);
    calculateTotalAmount(selectedItems, 0); // Äáº·t discount = 0
  };

  const handlePlaceOrder = () => {
    if (selectedItems.length === 0) {
      alert("Vui lÃ²ng chá»n Ã­t nháº¥t má»™t sáº£n pháº©m!");
      return;
    }
    navigate("/checkout", { 
      state: { 
        selectedItems, 
        totalAmount, 
        originalTotal,
        discountAmount,
        voucherCode: voucherApplied ? voucherCode : null 
      } 
    });
  };

  const handleQuantityChange = (item) => {
    setSelectedItem(item);
    setQuantityModalOpen(true);
  };

  const updateQuantity = async (newQuantity) => {
    if (!selectedItem) return;

    const updatedItems = cartItems.map((item) =>
      item.productVariantId === selectedItem.productVariantId
        ? { ...item, quantity: newQuantity }
        : item
    ).filter(item => item.quantity > 0);

    try {
      const token = localStorage.getItem("token");
      if (token && userId) {
        await axios.put(`${process.env.REACT_APP_API_BASE_URL}/api/Cart/update`, {
          userId,
          productVariantId: selectedItem.productVariantId,
          quantity: newQuantity
        }, {
          headers: { Authorization: `Bearer ${token}` }
        });
      } else {
        sessionStorage.setItem("cart", JSON.stringify(updatedItems));
      }

      setCartItems(updatedItems);
      setSelectedItems(updatedItems);
      calculateTotalAmount(updatedItems);
    } catch (error) {
      console.error("Error updating quantity:", error);
    }
  };

  const handleIncreaseQuantity = () => {
    if (!selectedItem) return;
    const newQuantity = selectedItem.quantity + 1;
    updateQuantity(newQuantity);
  };

  const handleDecreaseQuantity = () => {
    if (!selectedItem) return;
    const newQuantity = Math.max(1, selectedItem.quantity - 1);
    updateQuantity(newQuantity);
  };

  // Sá»­a lá»—i: Cáº­p nháº­t hÃ m handleSelectItem Ä‘á»ƒ tÃ­nh láº¡i totalAmount vá»›i discountAmount hiá»‡n táº¡i
  const handleSelectItem = (item) => {
    const isSelected = selectedItems.some(
      (selectedItem) => selectedItem.productVariantId === item.productVariantId
    );
    const updatedSelectedItems = isSelected
      ? selectedItems.filter((selectedItem) => selectedItem.productVariantId !== item.productVariantId)
      : [...selectedItems, item];
    
    setSelectedItems(updatedSelectedItems);
    calculateTotalAmount(updatedSelectedItems, discountAmount);
  };

  return (
    <Drawer 
      anchor="right" 
      open={isOpen} 
      onClose={onClose} 
      PaperProps={{ 
        sx: { 
          width: { xs: '100%', sm: 500 }, 
          p: 2,
          display: 'flex',
          flexDirection: 'column'
        } 
      }}
    >
      <Box className="flex items-center justify-between p-4 border-b">
        <Typography variant="h6" fontWeight="bold">Giá» HÃ ng Cá»§a Báº¡n</Typography>
        <IconButton onClick={onClose}>
          <X />
        </IconButton>
      </Box>

      {loading ? (
        <Box display="flex" justifyContent="center" alignItems="center" flexGrow={1}>
          <CircularProgress />
        </Box>
      ) : cartItems.length > 0 ? (
        <>
          <List sx={{ flexGrow: 1, overflowY: 'auto', px: 1 }}>
            {cartItems.map((item) => (
              <Box
                key={item.productVariantId}
                sx={{
                  p: 2,
                  border: "1px solid #e0e0e0",
                  borderRadius: 2,
                  mb: 2,
                  display: "flex",
                  alignItems: "center",
                  gap: 2,
                  backgroundColor: "#fff",
                  '&:hover': {
                    boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                  }
                }}
              >
                <Checkbox
                  checked={selectedItems.some(
                    (selectedItem) => selectedItem.productVariantId === item.productVariantId
                  )}
                  onChange={() => handleSelectItem(item)}
                  color="primary"
                />
                <img
  src={item.productImage?.startsWith("http") 
    ? item.productImage 
    : `${process.env.REACT_APP_API_BASE_URL}/${item.productImage}`}
  alt={item.productName}
  className="w-full h-full object-contain transition-transform duration-500 group-hover:scale-110"
  onError={(e) => { 
    e.target.onerror = null; 
    e.target.src = "https://via.placeholder.com/150"; 
  }}
  style={{
    width: '80px',
    height: '80px',
    objectFit: 'contain'
  }}
/>
                <Box sx={{ flexGrow: 1 }}>
                  <Typography fontWeight="medium" sx={{ mb: 0.5 }}>
                    {item.productName}
                  </Typography>
                  <Typography variant="body2" color="text.secondary" sx={{ mb: 0.5 }}>
                    {item.variantColor} - {item.variantStorage}
                  </Typography>
                  {item.productDiscountPrice ? (
                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                      <Typography variant="body2" sx={{ textDecoration: 'line-through', color: 'text.secondary' }}>
                        {(item.productPrice * item.quantity).toLocaleString()}â‚«
                      </Typography>
                      <Typography variant="body2" fontWeight="bold" color="error">
                        {(item.productDiscountPrice * item.quantity).toLocaleString()}â‚«
                      </Typography>
                    </Box>
                  ) : (
                    <Typography variant="body2" fontWeight="medium">
                      {(item.productPrice * item.quantity).toLocaleString()}â‚«
                    </Typography>
                  )}
                  <Box 
                    sx={{ 
                      display: 'flex', 
                      alignItems: 'center', 
                      gap: 1,
                      mt: 0.5 
                    }}
                    onClick={() => handleQuantityChange(item)}
                  >
                    <Typography 
                      variant="body2" 
                      color="text.secondary"
                      sx={{ cursor: 'pointer' }}
                    >
                      Sá»‘ lÆ°á»£ng: 
                    </Typography>
                    <Chip 
                      label={item.quantity} 
                      size="small"
                      sx={{ cursor: 'pointer' }}
                    />
                  </Box>
                </Box>
                <IconButton 
                  onClick={() => handleRemoveItem(item.productVariantId)}
                  sx={{ color: 'error.main' }}
                >
                  <Delete size={20} />
                </IconButton>
              </Box>
            ))}
          </List>

          <Box sx={{ p: 2, borderTop: '1px solid #e0e0e0', bgcolor: '#fafafa' }}>
            {userId && (
              <>
                <Box sx={{ display: 'flex', alignItems: 'center', mb: 2 }}>
                  <Gift size={20} color="#ff6b6b" style={{ marginRight: 8 }} />
                  <Typography variant="subtitle1" fontWeight="medium">
                    MÃ£ giáº£m giÃ¡
                  </Typography>
                </Box>
                <Box sx={{ display: 'flex', gap: 1, mb: 2 }}>
                  <TextField
                    fullWidth
                    size="small"
                    variant="outlined"
                    placeholder="Nháº­p mÃ£ giáº£m giÃ¡"
                    value={voucherCode}
                    onChange={(e) => setVoucherCode(e.target.value)}
                    disabled={voucherApplied}
                    sx={{
                      '& .MuiOutlinedInput-root': {
                        borderRadius: '4px',
                      }
                    }}
                  />
                  {voucherApplied ? (
                    <Button 
                      variant="outlined" 
                      color="error"
                      onClick={handleRemoveVoucher}
                      sx={{ minWidth: '100px' }}
                    >
                      Há»§y
                    </Button>
                  ) : (
                    <Button 
                      variant="contained" 
                      color="primary"
                      onClick={handleApplyVoucher}
                      disabled={!voucherCode || voucherLoading}
                      sx={{ minWidth: '100px' }}
                    >
                      {voucherLoading ? <CircularProgress size={20} /> : 'Ãp dá»¥ng'}
                    </Button>
                  )}
                </Box>
                {discountAmount > 0 && (
                  <Box sx={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    mb: 1 
                  }}>
                    <Typography variant="body2">Giáº£m giÃ¡:</Typography>
                    <Typography variant="body2" color="error" fontWeight="medium">
                      -{discountAmount.toLocaleString()}â‚«
                    </Typography>
                  </Box>
                )}
                <Divider sx={{ my: 1 }} />
              </>
            )}
            
            <Box sx={{ 
              display: 'flex', 
              justifyContent: 'space-between', 
              mb: 1 
            }}>
              <Typography variant="body1">Táº¡m tÃ­nh:</Typography>
              <Typography variant="body1" fontWeight="medium">
                {originalTotal.toLocaleString()}â‚«
              </Typography>
            </Box>
            
            <Box sx={{ 
              display: 'flex', 
              justifyContent: 'space-between', 
              mb: 2 
            }}>
              <Typography variant="h6">Tá»•ng cá»™ng:</Typography>
              <Typography variant="h6" fontWeight="bold" color="error">
                {totalAmount.toLocaleString()}â‚«
              </Typography>
            </Box>
            
            <Button
              fullWidth
              variant="contained"
              color="error"
              size="large"
              onClick={handlePlaceOrder}
              disabled={selectedItems.length === 0}
              sx={{
                py: 1.5,
                borderRadius: '4px',
                fontWeight: 'bold',
                fontSize: '1rem'
              }}
            >
              Tiáº¿n hÃ nh Ä‘áº·t hÃ ng
            </Button>
          </Box>
        </>
      ) : (
        <Box 
          display="flex" 
          flexDirection="column" 
          justifyContent="center" 
          alignItems="center" 
          flexGrow={1}
          textAlign="center"
          p={4}
        >
          <Typography variant="h6" gutterBottom>
            Giá» hÃ ng cá»§a báº¡n Ä‘ang trá»‘ng
          </Typography>
          <Typography variant="body2" color="text.secondary" sx={{ mb: 3 }}>
            HÃ£y thÃªm sáº£n pháº©m vÃ o giá» hÃ ng Ä‘á»ƒ báº¯t Ä‘áº§u mua sáº¯m
          </Typography>
          <Button 
            variant="outlined" 
            color="primary"
            onClick={onClose}
          >
            Tiáº¿p tá»¥c mua sáº¯m
          </Button>
        </Box>
      )}

      <Modal open={quantityModalOpen} onClose={() => setQuantityModalOpen(false)}>
      <Box
        sx={{
          position: "absolute",
          top: "50%",
          left: "50%",
          transform: "translate(-50%, -50%)",
          width: 300,
          bgcolor: "background.paper",
          boxShadow: 24,
          p: 3,
          borderRadius: 2,
          display: "flex",
          flexDirection: "column",
          alignItems: "center",
          gap: 2,
        }}
      >
        <Typography variant="h6" fontWeight="medium">
          Äiá»u chá»‰nh sá»‘ lÆ°á»£ng
        </Typography>
        <Box display="flex" alignItems="center" gap={3}>
          <IconButton 
            onClick={() => {
              const newQuantity = Math.max(1, selectedItem.quantity - 1);
              setSelectedItem({...selectedItem, quantity: newQuantity});
            }}
            disabled={selectedItem?.quantity <= 1}
            sx={{ 
              border: '1px solid #e0e0e0',
              '&:hover': { bgcolor: '#f5f5f5' }
            }}
          >
            <Minus size={20} />
          </IconButton>
          <Typography variant="h5" sx={{ minWidth: 40, textAlign: 'center' }}>
            {selectedItem?.quantity}
          </Typography>
          <IconButton 
            onClick={() => {
              const newQuantity = selectedItem.quantity + 1;
              setSelectedItem({...selectedItem, quantity: newQuantity});
            }}
            sx={{ 
              border: '1px solid #e0e0e0',
              '&:hover': { bgcolor: '#f5f5f5' }
            }}
          >
            <Plus size={20} />
          </IconButton>
        </Box>
        <Box display="flex" gap={2} width="100%">
          <Button 
            variant="outlined" 
            fullWidth
            onClick={() => setQuantityModalOpen(false)}
            sx={{ py: 1 }}
          >
            Há»§y
          </Button>
          <Button 
            variant="contained" 
            fullWidth
            onClick={() => {
              updateQuantity(selectedItem.quantity);
              setQuantityModalOpen(false);
            }}
            sx={{ py: 1 }}
          >
            XÃ¡c nháº­n
          </Button>
        </Box>
      </Box>
    </Modal>
    </Drawer>
  );
};

export default CartDrawer;
```

### ClientApp\src\components\shoppingcart\CartItem.jsx
```jsx
import React, { useState } from "react";
import { FaTrash } from "react-icons/fa";
import { useCart } from "@/hooks/api/useCart";

const CartItem = ({ item }) => {
  const [quantity, setQuantity] = useState(item.quantity || 1);
  const { addToCart } = useCart();

  const handleIncrease = async () => {
    const newQuantity = quantity + 1;
    setQuantity(newQuantity);
    await addToCart(item.id, 1);
  };

  return (
    <div className="border p-4 rounded-lg bg-white shadow-md">
      <div className="flex items-center justify-between">
        <input type="checkbox" className="mr-2" />
        {item.image && (
          <img
            src={item.image}
            alt={item.name || "Sáº£n pháº©m"}
            className="w-16 h-16 rounded"
          />
        )}
        <div className="ml-4 flex-1">
          <h2 className="font-bold text-lg">
            {item.name || "Sáº£n pháº©m khÃ´ng cÃ³ tÃªn"}
          </h2>
          <span className="text-gray-600">
            MÃ u: {item.color || "KhÃ´ng xÃ¡c Ä‘á»‹nh"}
          </span>
        </div>
        <span className="text-red-500 font-bold text-lg">
          {item.price ? item.price.toLocaleString() : "0"} Ä‘
        </span>
        <div className="flex items-center">
          <button
            onClick={() => setQuantity(quantity > 1 ? quantity - 1 : 1)}
            className="px-2 border bg-gray-200"
          >
            -
          </button>
          <span className="px-4">{quantity}</span>
          <button onClick={handleIncrease} className="px-2 border bg-gray-200">
            +
          </button>
        </div>
        <button className="ml-4 text-gray-500 hover:text-red-500">
          <FaTrash size={18} />
        </button>
      </div>
    </div>
  );
};

export default CartItem;

```

### ClientApp\src\components\shoppingcart\OrderSummary.jsx
```jsx
import React from "react";

const OrderSummary = ({ total = 0, payable = 0 }) => {
  return (
    <div className="border p-4 rounded-lg bg-white shadow-md">
      <h2 className="font-bold text-lg mb-4">ThÃ´ng tin Ä‘Æ¡n hÃ ng</h2>

      <div className="flex justify-between mb-2">
        <span>Tá»•ng tiá»n</span>
        <span className="font-bold">{(total ?? 0).toLocaleString()} Ä‘</span>
      </div>

      <div className="flex justify-between mb-2 border-t pt-2">
        <span>Cáº§n thanh toÃ¡n</span>
        <span className="font-bold text-red-500">
          {(payable ?? 0).toLocaleString()} Ä‘
        </span>
      </div>

      <button className="w-full bg-red-500 text-white py-2 rounded-lg font-bold text-lg">
        XÃ¡c nháº­n Ä‘Æ¡n
      </button>
    </div>
  );
};

export default OrderSummary;

```

### ClientApp\src\hooks\index.js
```js
// Main hooks index file - exports all custom hooks for easy importing
// Organized by category for better developer experience

// API Hooks
export {
  useApi,
  useApiData,
  useApiMutation,
  usePaginatedApi,
  useSearchApi,
} from "./api/useApi";

export {
  useProducts,
  useProduct,
  useProductSearch,
  useProductFilters,
  useProductCategories,
  useProductBrands,
  useProductComparison,
  useRelatedProducts,
  useProductRecommendations,
} from "./api/useProducts";

export {
  useCart,
  useCartItems,
  useCartActions,
  useGuestCart,
  useCartSync,
  useCartPersistence,
} from "./api/useCart";

export {
  useOrders,
  useOrder,
  useOrderHistory,
  useOrderTracking,
  useOrderActions,
  useOrderStatistics,
} from "./api/useOrders";

export {
  useReviews,
  useProductReviews,
  useUserReviews,
  useReviewActions,
  useReviewModeration,
  useReviewStatistics,
} from "./api/useReviews";

export {
  useAddresses,
  useUserAddresses,
  useAddressValidation,
  useShippingZones,
  useAddressActions,
} from "./api/useAddresses";

export {
  useAdmin,
  useAdminUsers,
  useAdminProducts,
  useAdminOrders,
  useAdminAnalytics,
  useAdminSettings,
  useAdminReports,
} from "./api/useAdmin";

export {
  useChat,
  useChatConnection,
  useChatHistory,
  useChatActions,
  useAdminChat,
  useChatNotifications,
} from "./api/useChat";

export {
  useFeatures,
  useFlashSales,
  useLoyaltyProgram,
  useVouchers,
  useWishlist,
  useNotifications,
  useRecentlyViewed,
} from "./api/useFeatures";

// Authentication Hooks
export {
  useAuth,
  useAuthState,
  useAuthActions,
  useProfile,
  useProfileActions,
  usePasswordReset,
  useEmailVerification,
  useRoleManagement,
} from "./auth/useAuth";

// UI Hooks
export {
  useDebounce,
  usePagination,
  useForm,
  useModal,
  useToast,
  useLocalStorage,
  useSessionStorage,
  useToggle,
  useClickOutside,
  useKeyPress,
  useWindowSize,
  useScrollPosition,
  useIntersectionObserver,
  useImageLazyLoad,
  useInfiniteScroll,
  useTabManager,
  useConfirmDialog,
  useFileUpload,
  useClipboard,
} from "./ui/useUI";

// Utility function to check if all hooks are properly exported
export const getAvailableHooks = () => {
  return {
    api: [
      "useApi",
      "useApiData",
      "useApiMutation",
      "usePaginatedApi",
      "useSearchApi",
      "useProducts",
      "useProduct",
      "useProductSearch",
      "useProductFilters",
      "useCart",
      "useCartItems",
      "useCartActions",
      "useOrders",
      "useOrder",
      "useOrderHistory",
      "useReviews",
      "useProductReviews",
      "useUserReviews",
      "useAddresses",
      "useUserAddresses",
      "useAddressValidation",
      "useAdmin",
      "useAdminUsers",
      "useAdminProducts",
      "useChat",
      "useChatConnection",
      "useChatHistory",
      "useFeatures",
      "useFlashSales",
      "useLoyaltyProgram",
    ],
    auth: ["useAuth", "useAuthState", "useAuthActions", "useProfile"],
    ui: [
      "useDebounce",
      "usePagination",
      "useForm",
      "useModal",
      "useToast",
      "useLocalStorage",
      "useToggle",
      "useClickOutside",
      "useKeyPress",
    ],
  };
};

// Hook categories for documentation and discovery
export const HOOK_CATEGORIES = {
  API: "api",
  AUTH: "auth",
  UI: "ui",
};

// Common hook patterns and utilities
export const HOOK_PATTERNS = {
  LOADING_STATES: ["loading", "error", "data"],
  CRUD_OPERATIONS: ["create", "read", "update", "delete"],
  FORM_STATES: ["values", "errors", "touched", "isValid"],
};

```

### ClientApp\src\hooks\api\useAddresses.js
```js
import { useState, useEffect, useCallback } from "react";
import axios from "axios";
import { jwtDecode } from "jwt-decode";

/**
 * Hook for managing user addresses
 */
export const useAddresses = () => {
  const [addresses, setAddresses] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [userId, setUserId] = useState(null);

  // Get user ID from token
  useEffect(() => {
    const token = localStorage.getItem("token");
    if (token) {
      try {
        const decoded = jwtDecode(token);
        const id = parseInt(decoded.sub, 10);
        if (Number.isInteger(id)) {
          setUserId(id);
        }
      } catch (error) {
        console.error("Error decoding token:", error);
      }
    }
  }, []);

  const fetchAddresses = useCallback(async () => {
    if (!userId) return;
    try {
      setLoading(true);
      setError(null);
      const token = localStorage.getItem("token");
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/address/user/${userId}`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );
      const addressData = response.data.$values || response.data || [];
      setAddresses(addressData);
    } catch (err) {
      setError(err.response?.data?.message || "Failed to fetch addresses");
      console.error("Error fetching addresses:", err);
    } finally {
      setLoading(false);
    }
  }, [userId]);

  const addAddress = useCallback(
    async (addressData) => {
      if (!userId) throw new Error("User not authenticated");
      try {
        setLoading(true);
        setError(null);
        const token = localStorage.getItem("token");
        const response = await axios.post(
          `${process.env.REACT_APP_API_BASE_URL}/api/address/add`,
          {
            ...addressData,
            userId,
          },
          {
            headers: { Authorization: `Bearer ${token}` },
          }
        );
        const newAddress = response.data;
        setAddresses((prev) => [...prev, newAddress]);
        return newAddress;
      } catch (err) {
        const errorMessage =
          err.response?.data?.message || "Failed to add address";
        setError(errorMessage);
        throw new Error(errorMessage);
      } finally {
        setLoading(false);
      }
    },
    [userId]
  );

  const updateAddress = useCallback(async (addressId, addressData) => {
    try {
      setLoading(true);
      setError(null);
      const token = localStorage.getItem("token");
      const response = await axios.put(
        `${process.env.REACT_APP_API_BASE_URL}/api/address/update/${addressId}`,
        addressData,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );
      const updatedAddress = response.data;
      setAddresses((prev) =>
        prev.map((addr) => (addr.id === addressId ? updatedAddress : addr))
      );
      return updatedAddress;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to update address";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  const deleteAddress = useCallback(async (addressId) => {
    try {
      setLoading(true);
      setError(null);
      const token = localStorage.getItem("token");
      await axios.delete(
        `${process.env.REACT_APP_API_BASE_URL}/api/address/delete/${addressId}`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );
      setAddresses((prev) => prev.filter((addr) => addr.id !== addressId));
      return true;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to delete address";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  const setDefaultAddress = useCallback(async (addressId) => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      await axios.put(
        `${process.env.REACT_APP_API_BASE_URL}/api/address/${addressId}/set-default`,
        {},
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      // Update local state to reflect the change
      setAddresses((prev) =>
        prev.map((addr) => ({
          ...addr,
          isDefault: addr.id === addressId,
        }))
      );
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to set default address";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  // Initialize addresses on mount
  useEffect(() => {
    if (userId) {
      fetchAddresses();
    }
  }, [userId, fetchAddresses]);

  // Get default address
  const defaultAddress =
    addresses.find((addr) => addr.isDefault) || addresses[0] || null;

  return {
    addresses,
    defaultAddress,
    loading,
    error,
    addAddress,
    updateAddress,
    deleteAddress,
    setDefaultAddress,
    fetchAddresses,
  };
};

/**
 * Hook for address validation
 */
export const useAddressValidation = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const validateAddress = useCallback(async (address) => {
    try {
      setLoading(true);
      setError(null);

      // Basic validation
      const errors = {};

      if (!address.fullName?.trim()) {
        errors.fullName = "Full name is required";
      }

      if (!address.phoneNumber?.trim()) {
        errors.phoneNumber = "Phone number is required";
      } else if (!/^[0-9+\-\s()]+$/.test(address.phoneNumber)) {
        errors.phoneNumber = "Invalid phone number format";
      }

      if (!address.addressLine1?.trim()) {
        errors.addressLine1 = "Address line 1 is required";
      }

      if (!address.city?.trim()) {
        errors.city = "City is required";
      }

      if (!address.state?.trim()) {
        errors.state = "State/Province is required";
      }

      if (!address.postalCode?.trim()) {
        errors.postalCode = "Postal code is required";
      }

      if (!address.country?.trim()) {
        errors.country = "Country is required";
      }

      if (Object.keys(errors).length > 0) {
        return { isValid: false, errors };
      }

      // Additional validation can be added here (e.g., API calls to validate postal codes)

      return { isValid: true, errors: {} };
    } catch (err) {
      setError("Address validation failed");
      return { isValid: false, errors: { general: "Validation failed" } };
    } finally {
      setLoading(false);
    }
  }, []);

  return {
    validateAddress,
    loading,
    error,
  };
};

/**
 * Hook for address autocomplete/suggestions
 */
export const useAddressSuggestions = () => {
  const [suggestions, setSuggestions] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const getSuggestions = useCallback(async (query) => {
    if (!query || query.length < 3) {
      setSuggestions([]);
      return;
    }

    try {
      setLoading(true);
      setError(null);

      // This would typically call a geocoding service like Google Maps API
      // For now, we'll return a mock response
      const mockSuggestions = [
        {
          id: 1,
          description: `${query} Street, Example City, Example State`,
          addressLine1: `${query} Street`,
          city: "Example City",
          state: "Example State",
          postalCode: "12345",
          country: "Vietnam",
        },
        {
          id: 2,
          description: `${query} Avenue, Another City, Example State`,
          addressLine1: `${query} Avenue`,
          city: "Another City",
          state: "Example State",
          postalCode: "67890",
          country: "Vietnam",
        },
      ];

      setSuggestions(mockSuggestions);
    } catch (err) {
      setError("Failed to fetch address suggestions");
      setSuggestions([]);
    } finally {
      setLoading(false);
    }
  }, []);

  const clearSuggestions = useCallback(() => {
    setSuggestions([]);
  }, []);

  return {
    suggestions,
    loading,
    error,
    getSuggestions,
    clearSuggestions,
  };
};

/**
 * Hook for shipping calculations
 */
export const useShipping = () => {
  const [shippingOptions, setShippingOptions] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const calculateShipping = useCallback(async (address, items) => {
    try {
      setLoading(true);
      setError(null);

      const response = await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/shipping/calculate`,
        {
          address,
          items,
        }
      );

      const options = response.data || [];
      setShippingOptions(options);
      return options;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to calculate shipping";
      setError(errorMessage);
      setShippingOptions([]);
      return [];
    } finally {
      setLoading(false);
    }
  }, []);

  return {
    shippingOptions,
    loading,
    error,
    calculateShipping,
  };
};

```

### ClientApp\src\hooks\api\useAdmin.js
```js
import { useState, useEffect, useCallback } from "react";
import axios from "axios";

/**
 * Hook for admin dashboard statistics
 */
export const useAdminStats = () => {
  const [stats, setStats] = useState({
    totalUsers: 0,
    totalProducts: 0,
    totalOrders: 0,
    totalRevenue: 0,
    newUsersToday: 0,
    pendingOrders: 0,
    lowStockProducts: 0,
    averageOrderValue: 0,
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchStats = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/admin/dashboard/stats`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      setStats(response.data);
    } catch (err) {
      setError(
        err.response?.data?.message || "Failed to fetch admin statistics"
      );
      console.error("Error fetching admin stats:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchStats();
  }, [fetchStats]);

  return {
    stats,
    loading,
    error,
    refetch: fetchStats,
  };
};

/**
 * Hook for managing users (Admin)
 */
export const useAdminUsers = () => {
  const [users, setUsers] = useState([]);
  const [roles, setRoles] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchUsers = useCallback(async (filters = {}) => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const params = new URLSearchParams();

      Object.entries(filters).forEach(([key, value]) => {
        if (value !== null && value !== undefined && value !== "") {
          params.append(key, value);
        }
      });

      let url = `${process.env.REACT_APP_API_BASE_URL}/api/admin/users`;
      if (params.toString()) {
        url += `?${params.toString()}`;
      }

      const response = await axios.get(url, {
        headers: { Authorization: `Bearer ${token}` },
      });

      const userData = response.data.$values || response.data || [];
      setUsers(userData);
    } catch (err) {
      setError(err.response?.data?.message || "Failed to fetch users");
      console.error("Error fetching users:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  const fetchRoles = useCallback(async () => {
    try {
      const token = localStorage.getItem("token");
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/roles`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      const rolesData = response.data.$values || response.data || [];
      setRoles(rolesData);
    } catch (err) {
      console.error("Error fetching roles:", err);
    }
  }, []);

  const updateUser = useCallback(async (userId, userData) => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await axios.put(
        `${process.env.REACT_APP_API_BASE_URL}/api/admin/users/${userId}`,
        userData,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      const updatedUser = response.data;
      setUsers((prev) =>
        prev.map((user) => (user.id === userId ? updatedUser : user))
      );

      return updatedUser;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to update user";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  const deleteUser = useCallback(async (userId) => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      await axios.delete(
        `${process.env.REACT_APP_API_BASE_URL}/api/admin/users/${userId}`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      setUsers((prev) => prev.filter((user) => user.id !== userId));
      return true;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to delete user";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  const createUser = useCallback(async (userData) => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/admin/users`,
        userData,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      const newUser = response.data;
      setUsers((prev) => [...prev, newUser]);
      return newUser;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to create user";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchUsers();
    fetchRoles();
  }, [fetchUsers, fetchRoles]);

  return {
    users,
    roles,
    loading,
    error,
    fetchUsers,
    updateUser,
    deleteUser,
    createUser,
  };
};

/**
 * Hook for managing products (Admin)
 */
export const useAdminProducts = () => {
  const [products, setProducts] = useState([]);
  const [categories, setCategories] = useState([]);
  const [brands, setBrands] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchProducts = useCallback(async (filters = {}) => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const params = new URLSearchParams();

      Object.entries(filters).forEach(([key, value]) => {
        if (value !== null && value !== undefined && value !== "") {
          params.append(key, value);
        }
      });

      let url = `${process.env.REACT_APP_API_BASE_URL}/api/admin/products`;
      if (params.toString()) {
        url += `?${params.toString()}`;
      }

      const response = await axios.get(url, {
        headers: { Authorization: `Bearer ${token}` },
      });

      const productsData = response.data.$values || response.data || [];
      setProducts(productsData);
    } catch (err) {
      setError(err.response?.data?.message || "Failed to fetch products");
      console.error("Error fetching products:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  const fetchProductData = useCallback(async () => {
    try {
      const token = localStorage.getItem("token");
      const [categoriesRes, brandsRes] = await Promise.all([
        axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/categories`, {
          headers: { Authorization: `Bearer ${token}` },
        }),
        axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/brands`, {
          headers: { Authorization: `Bearer ${token}` },
        }),
      ]);

      setCategories(categoriesRes.data.$values || categoriesRes.data || []);
      setBrands(brandsRes.data.$values || brandsRes.data || []);
    } catch (err) {
      console.error("Error fetching product data:", err);
    }
  }, []);

  const createProduct = useCallback(async (productData) => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/admin/products`,
        productData,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      const newProduct = response.data;
      setProducts((prev) => [...prev, newProduct]);
      return newProduct;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to create product";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  const updateProduct = useCallback(async (productId, productData) => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await axios.put(
        `${process.env.REACT_APP_API_BASE_URL}/api/admin/products/${productId}`,
        productData,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      const updatedProduct = response.data;
      setProducts((prev) =>
        prev.map((product) =>
          product.id === productId ? updatedProduct : product
        )
      );

      return updatedProduct;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to update product";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  const deleteProduct = useCallback(async (productId) => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      await axios.delete(
        `${process.env.REACT_APP_API_BASE_URL}/api/admin/products/${productId}`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      setProducts((prev) => prev.filter((product) => product.id !== productId));
      return true;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to delete product";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchProducts();
    fetchProductData();
  }, [fetchProducts, fetchProductData]);

  return {
    products,
    categories,
    brands,
    loading,
    error,
    fetchProducts,
    createProduct,
    updateProduct,
    deleteProduct,
  };
};

/**
 * Hook for managing categories (Admin)
 */
export const useAdminCategories = () => {
  const [categories, setCategories] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchCategories = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/admin/categories`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      const categoriesData = response.data.$values || response.data || [];
      setCategories(categoriesData);
    } catch (err) {
      setError(err.response?.data?.message || "Failed to fetch categories");
      console.error("Error fetching categories:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  const createCategory = useCallback(async (categoryData) => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/admin/categories`,
        categoryData,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      const newCategory = response.data;
      setCategories((prev) => [...prev, newCategory]);
      return newCategory;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to create category";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  const updateCategory = useCallback(async (categoryId, categoryData) => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await axios.put(
        `${process.env.REACT_APP_API_BASE_URL}/api/admin/categories/${categoryId}`,
        categoryData,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      const updatedCategory = response.data;
      setCategories((prev) =>
        prev.map((category) =>
          category.id === categoryId ? updatedCategory : category
        )
      );

      return updatedCategory;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to update category";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  const deleteCategory = useCallback(async (categoryId) => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      await axios.delete(
        `${process.env.REACT_APP_API_BASE_URL}/api/admin/categories/${categoryId}`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      setCategories((prev) =>
        prev.filter((category) => category.id !== categoryId)
      );
      return true;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to delete category";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchCategories();
  }, [fetchCategories]);

  return {
    categories,
    loading,
    error,
    fetchCategories,
    createCategory,
    updateCategory,
    deleteCategory,
  };
};

/**
 * Hook for admin analytics
 */
export const useAdminAnalytics = (timeRange = "month") => {
  const [analyticsData, setAnalyticsData] = useState({
    revenue: [],
    orders: [],
    users: [],
    products: [],
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchAnalytics = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/admin/analytics`,
        {
          params: { range: timeRange },
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      setAnalyticsData(response.data);
    } catch (err) {
      setError(err.response?.data?.message || "Failed to fetch analytics data");
      console.error("Error fetching analytics:", err);
    } finally {
      setLoading(false);
    }
  }, [timeRange]);

  useEffect(() => {
    fetchAnalytics();
  }, [fetchAnalytics]);

  return {
    analyticsData,
    loading,
    error,
    refetch: fetchAnalytics,
  };
};

```

### ClientApp\src\hooks\api\useApi.js
```js
import { useState, useEffect, useCallback } from "react";
import axios from "axios";

const API_BASE_URL = process.env.REACT_APP_API_BASE_URL;

/**
 * Base API hook for common API operations
 * @param {string} endpoint - API endpoint
 * @param {Object} options - Configuration options
 * @returns {Object} - API state and functions
 */
export const useApi = (endpoint, options = {}) => {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const {
    immediate = true,
    defaultValue = null,
    transform = (data) => data,
    onSuccess,
    onError,
  } = options;

  const execute = useCallback(
    async (config = {}) => {
      try {
        setLoading(true);
        setError(null);

        const response = await axios({
          url: `${API_BASE_URL}${endpoint}`,
          method: "GET",
          ...config,
        });

        const transformedData = transform(response.data);
        setData(transformedData);

        if (onSuccess) onSuccess(transformedData);

        return transformedData;
      } catch (err) {
        const errorMessage =
          err.response?.data?.message || err.message || "An error occurred";
        setError(errorMessage);

        if (onError) onError(err);

        throw err;
      } finally {
        setLoading(false);
      }
    },
    [endpoint, transform, onSuccess, onError]
  );

  const reset = useCallback(() => {
    setData(defaultValue);
    setError(null);
    setLoading(false);
  }, [defaultValue]);

  useEffect(() => {
    if (immediate && endpoint) {
      execute();
    }
  }, [execute, immediate, endpoint]);

  return {
    data,
    loading,
    error,
    execute,
    reset,
    setData,
  };
};

/**
 * Hook for POST requests
 */
export const usePost = (endpoint, options = {}) => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const execute = useCallback(
    async (data, config = {}) => {
      try {
        setLoading(true);
        setError(null);

        const response = await axios.post(
          `${API_BASE_URL}${endpoint}`,
          data,
          config
        );

        if (options.onSuccess) options.onSuccess(response.data);

        return response.data;
      } catch (err) {
        const errorMessage =
          err.response?.data?.message || err.message || "An error occurred";
        setError(errorMessage);

        if (options.onError) options.onError(err);

        throw err;
      } finally {
        setLoading(false);
      }
    },
    [endpoint, options]
  );

  return {
    execute,
    loading,
    error,
    setError,
  };
};

/**
 * Hook for PUT requests
 */
export const usePut = (endpoint, options = {}) => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const execute = useCallback(
    async (data, config = {}) => {
      try {
        setLoading(true);
        setError(null);

        const response = await axios.put(
          `${API_BASE_URL}${endpoint}`,
          data,
          config
        );

        if (options.onSuccess) options.onSuccess(response.data);

        return response.data;
      } catch (err) {
        const errorMessage =
          err.response?.data?.message || err.message || "An error occurred";
        setError(errorMessage);

        if (options.onError) options.onError(err);

        throw err;
      } finally {
        setLoading(false);
      }
    },
    [endpoint, options]
  );

  return {
    execute,
    loading,
    error,
    setError,
  };
};

/**
 * Hook for DELETE requests
 */
export const useDelete = (options = {}) => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const execute = useCallback(
    async (endpoint, config = {}) => {
      try {
        setLoading(true);
        setError(null);

        const response = await axios.delete(
          `${API_BASE_URL}${endpoint}`,
          config
        );

        if (options.onSuccess) options.onSuccess(response.data);

        return response.data;
      } catch (err) {
        const errorMessage =
          err.response?.data?.message || err.message || "An error occurred";
        setError(errorMessage);

        if (options.onError) options.onError(err);

        throw err;
      } finally {
        setLoading(false);
      }
    },
    [options]
  );

  return {
    execute,
    loading,
    error,
    setError,
  };
};

export default useApi;

```

### ClientApp\src\hooks\api\useBrands.js
```js
import { useState, useEffect, useCallback } from "react";
import axios from "axios";

const API_URL = `${process.env.REACT_APP_API_BASE_URL}/api/brands`;

export const useBrands = (drawerOpen) => {
  const [brands, setBrands] = useState([]);
  const [selectedBrand, setSelectedBrand] = useState(null);
  const [modalOpen, setModalOpen] = useState(false);
  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);
  const [brandToDelete, setBrandToDelete] = useState(null);
  const [loading, setLoading] = useState(false); // ThÃªm state loading
  const [error, setError] = useState(null); // ThÃªm state error

  const fetchBrands = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const response = await axios.get(API_URL);
      setBrands(response.data);
    } catch (err) {
      console.error("Failed to fetch brands:", err);
      setError("KhÃ´ng thá»ƒ táº£i danh sÃ¡ch thÆ°Æ¡ng hiá»‡u. Vui lÃ²ng thá»­ láº¡i.");
      // CÃ³ thá»ƒ setBrands([]) á»Ÿ Ä‘Ã¢y náº¿u muá»‘n clear data cÅ© khi lá»—i
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    if (drawerOpen === undefined || drawerOpen) {
      fetchBrands();
    }
  }, [drawerOpen, fetchBrands]);

  const handleConfirmDelete = async () => {
    if (!brandToDelete) return;
    setLoading(true);
    try {
      await axios.delete(`${API_URL}/${brandToDelete.id}`);
      await fetchBrands();
      setDeleteDialogOpen(false);
      setBrandToDelete(null);
    } catch (err) {
      console.error("Failed to delete brand:", err);
      setError("XÃ³a thÆ°Æ¡ng hiá»‡u tháº¥t báº¡i. Vui lÃ²ng thá»­ láº¡i.");
    } finally {
      setLoading(false);
    }
  };

  const handleOpenModal = (brand = null) => {
    setSelectedBrand(brand);
    setModalOpen(true);
  };

  const handleCloseModal = (shouldRefresh = false) => {
    setModalOpen(false);
    setSelectedBrand(null);
    if (shouldRefresh) {
      fetchBrands();
    }
  };

  const handleOpenDeleteDialog = (brand) => {
    setBrandToDelete(brand);
    setDeleteDialogOpen(true);
  };

  const handleCloseDeleteDialog = () => {
    setDeleteDialogOpen(false);
  };

  return {
    brands,
    selectedBrand,
    modalOpen,
    deleteDialogOpen,
    brandToDelete,
    loading,
    error,
    actions: {
      fetchBrands,
      handleOpenModal,
      handleCloseModal,
      handleOpenDeleteDialog,
      handleCloseDeleteDialog,
      handleConfirmDelete,
      clearError: () => setError(null)
    }
  };
};

```

### ClientApp\src\hooks\api\useCart.js
```js
import { useState, useEffect, useCallback } from "react";
import axios from "axios";
import { jwtDecode } from "jwt-decode";

/**
 * Hook for managing shopping cart
 */
export const useCart = () => {
  const [cartItems, setCartItems] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [userId, setUserId] = useState(null);

  // Get user ID from token
  useEffect(() => {
    const token = localStorage.getItem("token");
    if (token) {
      try {
        const decoded = jwtDecode(token);
        const id = parseInt(decoded.sub, 10);
        if (Number.isInteger(id)) {
          setUserId(id);
        }
      } catch (error) {
        console.error("Error decoding token:", error);
      }
    }
  }, []);

  // Fetch cart items
  const fetchCart = useCallback(async () => {
    const token = localStorage.getItem("token");
    setLoading(true);
    setError(null);

    try {
      let items = [];

      if (token && userId) {
        // Fetch from API for logged-in users
        const [apiResponse, sessionCart] = await Promise.all([
          axios.get(
            `${process.env.REACT_APP_API_BASE_URL}/api/Cart?userId=${userId}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          ),
          sessionStorage.getItem("cart"),
        ]);

        const apiItems = apiResponse.data?.$values || apiResponse.data || [];
        const sessionItems = sessionCart ? JSON.parse(sessionCart) : [];

        // Merge API items with session items
        const merged = [...apiItems];
        sessionItems.forEach((sessionItem) => {
          if (
            !merged.find(
              (item) => item.productVariantId === sessionItem.productVariantId
            )
          ) {
            merged.push(sessionItem);
          }
        });

        // Sync session items to database
        if (sessionItems.length > 0) {
          await Promise.all(
            sessionItems.map((item) =>
              axios.post(
                `${process.env.REACT_APP_API_BASE_URL}/api/Cart`,
                {
                  userId,
                  productVariantId: item.productVariantId,
                  quantity: item.quantity,
                },
                {
                  headers: { Authorization: `Bearer ${token}` },
                }
              )
            )
          );
          sessionStorage.removeItem("cart");
        }

        items = merged;
      } else {
        // Get from session storage for guests
        const sessionCart = sessionStorage.getItem("cart");
        items = sessionCart ? JSON.parse(sessionCart) : [];
      }

      setCartItems(items);
    } catch (err) {
      setError(err.message);
      console.error("Error fetching cart:", err);
    } finally {
      setLoading(false);
    }
  }, [userId]);

  // Add item to cart
  const addToCart = useCallback(
    async (productVariantId, quantity = 1) => {
      const token = localStorage.getItem("token");
      setLoading(true);
      setError(null);

      try {
        if (token && userId) {
          // Add to database for logged-in users
          await axios.post(
            `${process.env.REACT_APP_API_BASE_URL}/api/Cart`,
            {
              userId,
              productVariantId,
              quantity,
            },
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
        } else {
          // Add to session storage for guests
          const sessionCart = JSON.parse(
            sessionStorage.getItem("cart") || "[]"
          );
          const existingItem = sessionCart.find(
            (item) => item.productVariantId === productVariantId
          );

          if (existingItem) {
            existingItem.quantity += quantity;
          } else {
            sessionCart.push({ productVariantId, quantity });
          }

          sessionStorage.setItem("cart", JSON.stringify(sessionCart));
        }

        // Refresh cart
        await fetchCart();
      } catch (err) {
        setError(err.message);
        throw err;
      } finally {
        setLoading(false);
      }
    },
    [userId, fetchCart]
  );

  // Update item quantity
  const updateQuantity = useCallback(
    async (productVariantId, quantity) => {
      const token = localStorage.getItem("token");
      setLoading(true);
      setError(null);

      try {
        if (quantity <= 0) {
          // Remove item if quantity is 0
          await removeFromCart(productVariantId);
          return;
        }

        if (token && userId) {
          // Update in database for logged-in users
          await axios.put(
            `${process.env.REACT_APP_API_BASE_URL}/api/Cart/update`,
            {
              userId,
              productVariantId,
              quantity,
            },
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
        } else {
          // Update in session storage for guests
          const sessionCart = JSON.parse(
            sessionStorage.getItem("cart") || "[]"
          );
          const itemIndex = sessionCart.findIndex(
            (item) => item.productVariantId === productVariantId
          );

          if (itemIndex !== -1) {
            sessionCart[itemIndex].quantity = quantity;
            sessionStorage.setItem("cart", JSON.stringify(sessionCart));
          }
        }

        // Refresh cart
        await fetchCart();
      } catch (err) {
        setError(err.message);
        throw err;
      } finally {
        setLoading(false);
      }
    },
    [userId, fetchCart]
  );

  // Remove item from cart
  const removeFromCart = useCallback(
    async (productVariantId) => {
      const token = localStorage.getItem("token");
      setLoading(true);
      setError(null);

      try {
        if (token && userId) {
          // Remove from database for logged-in users
          await axios.delete(
            `${process.env.REACT_APP_API_BASE_URL}/api/Cart/${userId}/${productVariantId}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
        } else {
          // Remove from session storage for guests
          const sessionCart = JSON.parse(
            sessionStorage.getItem("cart") || "[]"
          );
          const updatedCart = sessionCart.filter(
            (item) => item.productVariantId !== productVariantId
          );
          sessionStorage.setItem("cart", JSON.stringify(updatedCart));
        }

        // Refresh cart
        await fetchCart();
      } catch (err) {
        setError(err.message);
        throw err;
      } finally {
        setLoading(false);
      }
    },
    [userId, fetchCart]
  );

  // Clear entire cart
  const clearCart = useCallback(async () => {
    const token = localStorage.getItem("token");
    setLoading(true);
    setError(null);

    try {
      if (token && userId) {
        // Clear from database for logged-in users
        await axios.delete(
          `${process.env.REACT_APP_API_BASE_URL}/api/Cart/clear/${userId}`,
          {
            headers: { Authorization: `Bearer ${token}` },
          }
        );
      } else {
        // Clear session storage for guests
        sessionStorage.removeItem("cart");
      }

      setCartItems([]);
    } catch (err) {
      setError(err.message);
      throw err;
    } finally {
      setLoading(false);
    }
  }, [userId]);

  // Calculate cart totals
  const getCartTotals = useCallback(() => {
    const subtotal = cartItems.reduce((total, item) => {
      const price = item.discountPrice || item.price || 0;
      return total + price * item.quantity;
    }, 0);

    const tax = subtotal * 0.1; // 10% tax
    const total = subtotal + tax;

    return {
      subtotal,
      tax,
      total,
      itemCount: cartItems.reduce((count, item) => count + item.quantity, 0),
    };
  }, [cartItems]);

  // Initialize cart on mount
  useEffect(() => {
    if (userId !== null) {
      fetchCart();
    }
  }, [userId, fetchCart]);

  return {
    cartItems,
    loading,
    error,
    addToCart,
    updateQuantity,
    removeFromCart,
    clearCart,
    fetchCart,
    ...getCartTotals(),
  };
};

/**
 * Hook for managing vouchers
 */
export const useVoucher = () => {
  const [appliedVoucher, setAppliedVoucher] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const applyVoucher = useCallback(async (voucherCode) => {
    if (!voucherCode.trim()) return;

    setLoading(true);
    setError(null);

    try {
      const response = await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/vouchers/apply`,
        { code: voucherCode }
      );

      const voucher = response.data;
      setAppliedVoucher(voucher);
      return voucher;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Invalid voucher code";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  const removeVoucher = useCallback(() => {
    setAppliedVoucher(null);
    setError(null);
  }, []);

  const calculateDiscount = useCallback(
    (subtotal) => {
      if (!appliedVoucher) return 0;

      if (appliedVoucher.discountType === "percentage") {
        return (subtotal * appliedVoucher.discountAmount) / 100;
      } else {
        return Math.min(appliedVoucher.discountAmount, subtotal);
      }
    },
    [appliedVoucher]
  );

  return {
    appliedVoucher,
    loading,
    error,
    applyVoucher,
    removeVoucher,
    calculateDiscount,
  };
};

```

### ClientApp\src\hooks\api\useCategories.js
```js
import { useState, useEffect } from "react";
import axios from "axios";

export const useCategories = () => {
  const [categories, setCategories] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchCategories = async () => {
      try {
        setLoading(true);
        const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/categories`);
        const data = response.data;
        const categoriesArray = Array.isArray(data.$values)
          ? data.$values
          : Array.isArray(data)
          ? data
          : [];
        setCategories(categoriesArray);
      } catch (error) {
        setError("KhÃ´ng thá»ƒ táº£i danh má»¥c: " + error.message);
        setCategories([]);
      } finally {
        setLoading(false);
      }
    };
    fetchCategories();
  }, []);

  return { categories, loading, error };
};

```

### ClientApp\src\hooks\api\useChat.js
```js
import { useState, useEffect, useCallback, useRef } from "react";
import { HubConnectionBuilder, LogLevel } from "@microsoft/signalr";

/**
 * Hook for managing chat functionality
 */
export const useChat = (isAdmin = false) => {
  const [connection, setConnection] = useState(null);
  const [messages, setMessages] = useState([]);
  const [isConnected, setIsConnected] = useState(false);
  const [isConnecting, setIsConnecting] = useState(false);
  const [error, setError] = useState(null);
  const [sessionId, setSessionId] = useState(null);

  const API_BASE_URL =
    process.env.REACT_APP_API_BASE_URL || "https://localhost:7107";

  const initializeConnection = useCallback(async () => {
    if (isConnecting || connection) return;

    try {
      setIsConnecting(true);
      setError(null);

      const token = localStorage.getItem("token");
      const hubUrl = isAdmin
        ? `${API_BASE_URL}/chathub?isAdmin=true`
        : `${API_BASE_URL}/chathub`;

      const newConnection = new HubConnectionBuilder()
        .withUrl(hubUrl, {
          accessTokenFactory: () => token,
          transport: 1, // WebSockets
        })
        .withAutomaticReconnect()
        .configureLogging(LogLevel.Information)
        .build();

      // Set up event handlers
      newConnection.on("ReceiveMessage", (sessionId, message) => {
        setMessages((prev) => [...prev, { ...message, sessionId }]);
      });

      newConnection.on("UserJoined", (sessionId, userName) => {
        console.log(`User ${userName} joined session ${sessionId}`);
      });

      newConnection.on("UserLeft", (sessionId, userName) => {
        console.log(`User ${userName} left session ${sessionId}`);
      });

      newConnection.on("SessionCreated", (newSessionId) => {
        setSessionId(newSessionId);
      });

      if (isAdmin) {
        newConnection.on("NewSession", (session) => {
          // Handle new session notification for admin
          console.log("New chat session created:", session);
        });

        newConnection.on("SessionEnded", (sessionId) => {
          console.log("Session ended:", sessionId);
        });
      }

      // Start connection
      await newConnection.start();

      setConnection(newConnection);
      setIsConnected(true);
      console.log("Chat connection established");
    } catch (err) {
      console.error("Error connecting to chat:", err);
      setError("Failed to connect to chat");
    } finally {
      setIsConnecting(false);
    }
  }, [isConnecting, connection, isAdmin, API_BASE_URL]);

  const sendMessage = useCallback(
    async (messageText, targetSessionId = null) => {
      if (!connection || !isConnected || !messageText.trim()) return;

      try {
        const currentSessionId = targetSessionId || sessionId;

        if (isAdmin && targetSessionId) {
          await connection.invoke(
            "SendMessageToSession",
            targetSessionId,
            messageText
          );
        } else {
          await connection.invoke("SendMessage", currentSessionId, messageText);
        }
      } catch (err) {
        console.error("Error sending message:", err);
        setError("Failed to send message");
      }
    },
    [connection, isConnected, sessionId, isAdmin]
  );

  const joinSession = useCallback(
    async (sessionIdToJoin) => {
      if (!connection || !isConnected) return;

      try {
        await connection.invoke("JoinSession", sessionIdToJoin);
        setSessionId(sessionIdToJoin);
      } catch (err) {
        console.error("Error joining session:", err);
        setError("Failed to join session");
      }
    },
    [connection, isConnected]
  );

  const leaveSession = useCallback(async () => {
    if (!connection || !isConnected || !sessionId) return;

    try {
      await connection.invoke("LeaveSession", sessionId);
      setSessionId(null);
      setMessages([]);
    } catch (err) {
      console.error("Error leaving session:", err);
      setError("Failed to leave session");
    }
  }, [connection, isConnected, sessionId]);

  const endSession = useCallback(
    async (sessionIdToEnd = sessionId) => {
      if (!connection || !isConnected || !sessionIdToEnd) return;

      try {
        await connection.invoke("EndSession", sessionIdToEnd);
        if (sessionIdToEnd === sessionId) {
          setSessionId(null);
          setMessages([]);
        }
      } catch (err) {
        console.error("Error ending session:", err);
        setError("Failed to end session");
      }
    },
    [connection, isConnected, sessionId]
  );

  const disconnect = useCallback(async () => {
    if (connection) {
      try {
        await connection.stop();
        setConnection(null);
        setIsConnected(false);
        setMessages([]);
        setSessionId(null);
      } catch (err) {
        console.error("Error disconnecting:", err);
      }
    }
  }, [connection]);

  // Cleanup on unmount
  useEffect(() => {
    return () => {
      if (connection && connection.state !== "Disconnected") {
        connection.stop().catch(console.error);
      }
    };
  }, [connection]);

  return {
    connection,
    messages,
    isConnected,
    isConnecting,
    error,
    sessionId,
    initializeConnection,
    sendMessage,
    joinSession,
    leaveSession,
    endSession,
    disconnect,
    setError,
  };
};

/**
 * Hook for admin chat sessions management
 */
export const useAdminChatSessions = () => {
  const [sessions, setSessions] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const API_BASE_URL =
    process.env.REACT_APP_API_BASE_URL || "https://localhost:7107";

  const fetchSessions = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await fetch(`${API_BASE_URL}/api/chat/admin/sessions`, {
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
      });

      if (!response.ok) {
        throw new Error(`Failed to fetch sessions: ${response.status}`);
      }

      const data = await response.json();
      setSessions(data);
    } catch (err) {
      console.error("Error fetching sessions:", err);
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }, [API_BASE_URL]);

  const getSessionMessages = useCallback(
    async (sessionId) => {
      try {
        const token = localStorage.getItem("token");
        const response = await fetch(
          `${API_BASE_URL}/api/chat/admin/sessions/${sessionId}/messages`,
          {
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          }
        );

        if (!response.ok) {
          throw new Error(`Failed to fetch messages: ${response.status}`);
        }

        const data = await response.json();
        return data;
      } catch (err) {
        console.error("Error fetching session messages:", err);
        throw err;
      }
    },
    [API_BASE_URL]
  );

  const updateSessionStatus = useCallback(
    async (sessionId, status) => {
      try {
        const token = localStorage.getItem("token");
        const response = await fetch(
          `${API_BASE_URL}/api/chat/admin/sessions/${sessionId}/status`,
          {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ status }),
          }
        );

        if (!response.ok) {
          throw new Error(
            `Failed to update session status: ${response.status}`
          );
        }

        // Update local state
        setSessions((prev) =>
          prev.map((session) =>
            session.id === sessionId ? { ...session, status } : session
          )
        );
      } catch (err) {
        console.error("Error updating session status:", err);
        throw err;
      }
    },
    [API_BASE_URL]
  );

  useEffect(() => {
    fetchSessions();

    // Auto refresh every 30 seconds
    const interval = setInterval(fetchSessions, 30000);
    return () => clearInterval(interval);
  }, [fetchSessions]);

  return {
    sessions,
    loading,
    error,
    fetchSessions,
    getSessionMessages,
    updateSessionStatus,
  };
};

/**
 * Hook for chat message formatting and utilities
 */
export const useChatUtils = () => {
  const formatTime = useCallback((timestamp) => {
    try {
      const date = new Date(timestamp);
      return date.toLocaleTimeString("vi-VN", {
        hour: "2-digit",
        minute: "2-digit",
        timeZone: "Asia/Ho_Chi_Minh",
        hour12: false,
      });
    } catch (error) {
      console.error("Error formatting time:", error);
      return "";
    }
  }, []);

  const formatDate = useCallback((timestamp) => {
    try {
      const date = new Date(timestamp);
      return date.toLocaleDateString("vi-VN", {
        year: "numeric",
        month: "short",
        day: "numeric",
        timeZone: "Asia/Ho_Chi_Minh",
      });
    } catch (error) {
      console.error("Error formatting date:", error);
      return "";
    }
  }, []);

  const isToday = useCallback((timestamp) => {
    try {
      const messageDate = new Date(timestamp);
      const today = new Date();
      return messageDate.toDateString() === today.toDateString();
    } catch (error) {
      return false;
    }
  }, []);

  const groupMessagesByDate = useCallback(
    (messages) => {
      const grouped = {};

      messages.forEach((message) => {
        const date = formatDate(message.timestamp);
        if (!grouped[date]) {
          grouped[date] = [];
        }
        grouped[date].push(message);
      });

      return grouped;
    },
    [formatDate]
  );

  const generateSessionId = useCallback(() => {
    return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }, []);

  return {
    formatTime,
    formatDate,
    isToday,
    groupMessagesByDate,
    generateSessionId,
  };
};

/**
 * Hook for chat typing indicators
 */
export const useTypingIndicator = (connection, sessionId) => {
  const [typingUsers, setTypingUsers] = useState([]);
  const [isTyping, setIsTyping] = useState(false);
  const typingTimeoutRef = useRef(null);

  // Set up typing event listeners
  useEffect(() => {
    if (!connection) return;

    const handleUserTyping = (userId, userName, sessionId) => {
      setTypingUsers((prev) => {
        const existing = prev.find((user) => user.userId === userId);
        if (!existing) {
          return [...prev, { userId, userName, sessionId }];
        }
        return prev;
      });

      // Remove typing indicator after 3 seconds
      setTimeout(() => {
        setTypingUsers((prev) => prev.filter((user) => user.userId !== userId));
      }, 3000);
    };

    const handleUserStoppedTyping = (userId) => {
      setTypingUsers((prev) => prev.filter((user) => user.userId !== userId));
    };

    connection.on("UserTyping", handleUserTyping);
    connection.on("UserStoppedTyping", handleUserStoppedTyping);

    return () => {
      connection.off("UserTyping", handleUserTyping);
      connection.off("UserStoppedTyping", handleUserStoppedTyping);
    };
  }, [connection]);

  const startTyping = useCallback(() => {
    if (!connection || !sessionId) return;

    if (!isTyping) {
      setIsTyping(true);
      connection.invoke("StartTyping", sessionId).catch(console.error);
    }

    // Clear existing timeout
    if (typingTimeoutRef.current) {
      clearTimeout(typingTimeoutRef.current);
    }

    // Stop typing after 2 seconds of inactivity
    typingTimeoutRef.current = setTimeout(() => {
      stopTyping();
    }, 2000);
  }, [connection, sessionId, isTyping]);

  const stopTyping = useCallback(() => {
    if (!connection || !sessionId || !isTyping) return;

    setIsTyping(false);
    connection.invoke("StopTyping", sessionId).catch(console.error);

    if (typingTimeoutRef.current) {
      clearTimeout(typingTimeoutRef.current);
      typingTimeoutRef.current = null;
    }
  }, [connection, sessionId, isTyping]);

  // Cleanup on unmount
  useEffect(() => {
    return () => {
      if (typingTimeoutRef.current) {
        clearTimeout(typingTimeoutRef.current);
      }
    };
  }, []);

  return {
    typingUsers: typingUsers.filter((user) => user.sessionId === sessionId),
    startTyping,
    stopTyping,
  };
};

```

### ClientApp\src\hooks\api\useFeatures.js
```js
import { useState, useEffect, useCallback } from "react";
import axios from "axios";

/**
 * Hook for managing flash sales
 */
export const useFlashSale = () => {
  const [flashSaleProducts, setFlashSaleProducts] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [timeLeft, setTimeLeft] = useState({
    hours: 0,
    minutes: 0,
    seconds: 0,
  });

  const fetchFlashSaleProducts = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      const response = await fetch(
        `${process.env.REACT_APP_API_BASE_URL}/api/Products/lowest-price`
      );

      if (!response.ok) {
        throw new Error("Failed to fetch flash sale products");
      }

      const productsData = await response.json();

      const formattedProducts = productsData.map((product) => {
        const variant = product.variants?.[0] || {};
        const image =
          product.images?.[0]?.imageUrl || "/images/placeholder.jpg";

        const oldPrice = variant.price || 0;
        const newPrice = variant.discountPrice || oldPrice;
        const discountAmount = oldPrice - newPrice;
        const discount =
          oldPrice > 0
            ? `-${Math.round((discountAmount / oldPrice) * 100)}%`
            : "0%";

        return {
          id: product.id,
          name: product.name,
          oldPrice,
          newPrice,
          discount,
          discountAmount,
          image,
          features: product.features || [],
          brand: product.brand,
          rating: product.rating || 0,
          reviewCount: product.reviewCount || 0,
        };
      });

      setFlashSaleProducts(formattedProducts);
    } catch (err) {
      setError(err.message);
      console.error("Error fetching flash sale products:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  // Countdown timer calculation
  useEffect(() => {
    const calculateTimeLeft = () => {
      const now = new Date();
      const currentDay = now.getDay(); // 0 = Sunday, 1-6 = Monday-Saturday
      const endOfWeek = new Date(now);

      // Set to next Sunday (end of week)
      const daysUntilSunday = currentDay === 0 ? 7 : 7 - currentDay;
      endOfWeek.setDate(now.getDate() + daysUntilSunday);
      endOfWeek.setHours(23, 59, 59, 999);

      const timeDiff = endOfWeek.getTime() - now.getTime();

      if (timeDiff > 0) {
        const hours = Math.floor(timeDiff / (1000 * 60 * 60));
        const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);

        setTimeLeft({ hours, minutes, seconds });
      } else {
        setTimeLeft({ hours: 0, minutes: 0, seconds: 0 });
      }
    };

    calculateTimeLeft();
    const interval = setInterval(calculateTimeLeft, 1000);

    return () => clearInterval(interval);
  }, []);

  useEffect(() => {
    fetchFlashSaleProducts();
  }, [fetchFlashSaleProducts]);

  const isFlashSaleActive =
    timeLeft.hours > 0 || timeLeft.minutes > 0 || timeLeft.seconds > 0;

  return {
    flashSaleProducts,
    loading,
    error,
    timeLeft,
    isFlashSaleActive,
    refetch: fetchFlashSaleProducts,
  };
};

/**
 * Hook for managing best sellers
 */
export const useBestSellers = () => {
  const [bestSellers, setBestSellers] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchBestSellers = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      const [productsResponse, categoriesResponse, brandsResponse] =
        await Promise.all([
          fetch(`${process.env.REACT_APP_API_BASE_URL}/api/Products`),
          fetch(`${process.env.REACT_APP_API_BASE_URL}/api/categories`),
          fetch(`${process.env.REACT_APP_API_BASE_URL}/api/brands`),
        ]);

      if (
        !productsResponse.ok ||
        !categoriesResponse.ok ||
        !brandsResponse.ok
      ) {
        throw new Error("Failed to fetch data");
      }

      const [products, categories, brands] = await Promise.all([
        productsResponse.json(),
        categoriesResponse.json(),
        brandsResponse.json(),
      ]);

      const productsData = products.$values || products || [];
      const categoriesData = categories.$values || categories || [];
      const brandsData = brands.$values || brands || [];

      // Filter and sort products by sales/popularity (mock implementation)
      const bestSellingProducts = productsData
        .filter((product) => product.variants && product.variants.length > 0)
        .sort((a, b) => (b.salesCount || 0) - (a.salesCount || 0))
        .slice(0, 12)
        .map((product) => {
          const category = categoriesData.find(
            (cat) => cat.id === product.categoryId
          );
          const brand = brandsData.find((br) => br.id === product.brandId);

          return {
            ...product,
            category: category || { name: "Unknown" },
            brand: brand || { name: "Unknown", logo: null },
          };
        });

      setBestSellers(bestSellingProducts);
    } catch (err) {
      setError(err.message);
      console.error("Error fetching best sellers:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchBestSellers();
  }, [fetchBestSellers]);

  return {
    bestSellers,
    loading,
    error,
    refetch: fetchBestSellers,
  };
};

/**
 * Hook for managing featured categories
 */
export const useFeaturedCategories = () => {
  const [featuredCategories, setFeaturedCategories] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchFeaturedCategories = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      const response = await fetch(
        `${process.env.REACT_APP_API_BASE_URL}/api/categories`
      );

      if (!response.ok) {
        throw new Error("Failed to fetch categories");
      }

      const data = await response.json();
      const categoriesData = data.$values || data || [];

      // Filter featured categories (first 6 for display)
      const featured = categoriesData.slice(0, 6);
      setFeaturedCategories(featured);
    } catch (err) {
      setError(err.message);
      console.error("Error fetching featured categories:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchFeaturedCategories();
  }, [fetchFeaturedCategories]);

  return {
    featuredCategories,
    loading,
    error,
    refetch: fetchFeaturedCategories,
  };
};

/**
 * Hook for managing hero banner slider
 */
export const useHeroBanner = (slides, autoPlayInterval = 5000) => {
  const [currentIndex, setCurrentIndex] = useState(0);
  const [isTransitioning, setIsTransitioning] = useState(false);
  const [isPaused, setIsPaused] = useState(false);

  const nextSlide = useCallback(() => {
    if (isTransitioning) return;

    setIsTransitioning(true);
    setCurrentIndex((prevIndex) => (prevIndex + 1) % slides.length);

    setTimeout(() => setIsTransitioning(false), 300);
  }, [isTransitioning, slides.length]);

  const prevSlide = useCallback(() => {
    if (isTransitioning) return;

    setIsTransitioning(true);
    setCurrentIndex(
      (prevIndex) => (prevIndex - 1 + slides.length) % slides.length
    );

    setTimeout(() => setIsTransitioning(false), 300);
  }, [isTransitioning, slides.length]);

  const goToSlide = useCallback(
    (index) => {
      if (isTransitioning || index === currentIndex) return;

      setIsTransitioning(true);
      setCurrentIndex(index);

      setTimeout(() => setIsTransitioning(false), 300);
    },
    [isTransitioning, currentIndex]
  );

  const pauseAutoPlay = useCallback(() => {
    setIsPaused(true);
  }, []);

  const resumeAutoPlay = useCallback(() => {
    setIsPaused(false);
  }, []);

  // Auto-play functionality
  useEffect(() => {
    if (isPaused || slides.length <= 1) return;

    const interval = setInterval(() => {
      nextSlide();
    }, autoPlayInterval);

    return () => clearInterval(interval);
  }, [nextSlide, isPaused, autoPlayInterval, slides.length]);

  return {
    currentIndex,
    isTransitioning,
    isPaused,
    nextSlide,
    prevSlide,
    goToSlide,
    pauseAutoPlay,
    resumeAutoPlay,
  };
};

/**
 * Hook for managing loyalty program data
 */
export const useLoyalty = () => {
  const [loyaltyData, setLoyaltyData] = useState({
    currentTier: null,
    points: 0,
    nextTierPoints: 0,
    benefits: [],
    history: [],
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchLoyaltyData = useCallback(async () => {
    const token = localStorage.getItem("token");
    if (!token) return;

    try {
      setLoading(true);
      setError(null);

      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/loyalty/status`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      setLoyaltyData(response.data);
    } catch (err) {
      setError(err.response?.data?.message || "Failed to fetch loyalty data");
      console.error("Error fetching loyalty data:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  const redeemPoints = useCallback(async (pointsToRedeem, rewardId) => {
    const token = localStorage.getItem("token");
    if (!token) throw new Error("Authentication required");

    try {
      setLoading(true);
      setError(null);

      const response = await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/loyalty/redeem`,
        {
          points: pointsToRedeem,
          rewardId,
        },
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      // Update local data
      setLoyaltyData((prev) => ({
        ...prev,
        points: prev.points - pointsToRedeem,
      }));

      return response.data;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to redeem points";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchLoyaltyData();
  }, [fetchLoyaltyData]);

  return {
    loyaltyData,
    loading,
    error,
    fetchLoyaltyData,
    redeemPoints,
  };
};

/**
 * Hook for managing vouchers
 */
export const useVouchers = () => {
  const [vouchers, setVouchers] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchVouchers = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/vouchers/available`
      );

      const vouchersData = response.data.$values || response.data || [];
      setVouchers(vouchersData);
    } catch (err) {
      setError(err.response?.data?.message || "Failed to fetch vouchers");
      console.error("Error fetching vouchers:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  const validateVoucher = useCallback(async (voucherCode) => {
    try {
      setError(null);

      const response = await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/vouchers/validate`,
        { code: voucherCode }
      );

      return response.data;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Invalid voucher code";
      setError(errorMessage);
      throw new Error(errorMessage);
    }
  }, []);

  useEffect(() => {
    fetchVouchers();
  }, [fetchVouchers]);

  return {
    vouchers,
    loading,
    error,
    fetchVouchers,
    validateVoucher,
  };
};

```

### ClientApp\src\hooks\api\useFlashSaleProducts.js
```js
import { useState, useEffect } from "react";
import axios from "axios";

const API_BASE_URL = process.env.REACT_APP_API_BASE_URL;

export const useFlashSaleProducts = () => {
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchProducts = async () => {
      try {
        setLoading(true);
        // Corrected endpoint to fetch actual flash sale products
        const response = await axios.get(`${API_BASE_URL}/api/Products/flash-sale`);
        // The response from this endpoint is a simple array of ProductDto
        setProducts(response.data || []);
      } catch (error) {
        setError("KhÃ´ng thá»ƒ táº£i sáº£n pháº©m: " + error.message);
        setProducts([]);
      } finally {
        setLoading(false);
      }
    };
    fetchProducts();
  }, []);

  return { products, loading, error };
};

```

### ClientApp\src\hooks\api\useLoyalty.js
```js
import { useState, useCallback } from "react";
import axios from "axios";
import { jwtDecode } from "jwt-decode";

// Hook láº¥y tráº¡ng thÃ¡i loyalty cá»§a user
export function useLoyaltyStatus() {
  const [loyaltyData, setLoyaltyData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [userId, setUserId] = useState(null);

  const fetchLoyaltyData = useCallback(async () => {
    setLoading(true);
    setError("");
    try {
      const token = localStorage.getItem("token");
      if (!token) {
        setError("Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ xem tráº¡ng thÃ¡i thÃ nh viÃªn");
        setLoading(false);
        return;
      }
      const decoded = jwtDecode(token);
      const id = parseInt(decoded.sub, 10);
      if (!Number.isInteger(id)) {
        setError("Token khÃ´ng há»£p lá»‡");
        setLoading(false);
        return;
      }
      setUserId(id);
      const currentTime = Date.now() / 1000;
      if (decoded.exp < currentTime) {
        setError("Token Ä‘Ã£ háº¿t háº¡n, vui lÃ²ng Ä‘Äƒng nháº­p láº¡i");
        setLoading(false);
        return;
      }
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/loyalty/my-status?userId=${id}`,
        { headers: { Authorization: `Bearer ${token}` } }
      );
      setLoyaltyData(response.data);
    } catch (err) {
      setError("KhÃ´ng thá»ƒ táº£i thÃ´ng tin chÆ°Æ¡ng trÃ¬nh khÃ¡ch hÃ ng thÃ¢n thiáº¿t");
    } finally {
      setLoading(false);
    }
  }, []);

  // fetch on mount
  useState(() => {
    fetchLoyaltyData();
  }, [fetchLoyaltyData]);

  return { loyaltyData, loading, error, userId, refetch: fetchLoyaltyData };
}

// Hook quay vÃ²ng quay may máº¯n
export function useSpinWheel(userId, onSuccess) {
  const [spinning, setSpinning] = useState(false);
  const [spinResult, setSpinResult] = useState(null);
  const [error, setError] = useState("");

  const spin = useCallback(async () => {
    setSpinning(true);
    setError("");
    try {
      const token = localStorage.getItem("token");
      const response = await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/loyalty/spin-wheel?userId=${userId}`,
        {},
        { headers: { Authorization: `Bearer ${token}` } }
      );
      setSpinResult(response.data);
      if (onSuccess) onSuccess();
    } catch (err) {
      setError(err.response?.data || "KhÃ´ng thá»ƒ quay vÃ²ng quay");
    } finally {
      setSpinning(false);
    }
  }, [userId, onSuccess]);

  return { spin, spinning, spinResult, error };
}

```

### ClientApp\src\hooks\api\useOrderLookup.js
```js
import { useState, useCallback } from "react";
import axios from "axios";

export const useOrderLookup = () => {
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const searchOrdersByPhone = useCallback(async (phoneNumber) => {
    if (!phoneNumber.trim()) {
      setError("Vui lÃ²ng nháº­p sá»‘ Ä‘iá»‡n thoáº¡i");
      setOrders([]);
      return;
    }
    setLoading(true);
    setError(null);
    setOrders([]);
    try {
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/orders/by-phone/${phoneNumber}`
      );
      if (response.data && Array.isArray(response.data)) {
        if (response.data.length > 0) {
          setOrders(response.data);
        } else {
          setError("KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng nÃ o vá»›i sá»‘ Ä‘iá»‡n thoáº¡i nÃ y");
        }
      } else {
        setError("Dá»¯ liá»‡u tráº£ vá» khÃ´ng há»£p lá»‡");
      }
    } catch (err) {
      setError(
        err.response?.data?.message || "Lá»—i khi tra cá»©u Ä‘Æ¡n hÃ ng. Vui lÃ²ng thá»­ láº¡i."
      );
    } finally {
      setLoading(false);
    }
  }, []);

  return { orders, loading, error, searchOrdersByPhone };
};

```

### ClientApp\src\hooks\api\useOrders.js
```js
import { useState, useEffect, useCallback } from "react";
import axios from "axios";
import { jwtDecode } from "jwt-decode";

/**
 * Hook for managing orders
 */
export const useOrders = () => {
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [userId, setUserId] = useState(null);

  // Láº¥y userId tá»« token khi khá»Ÿi táº¡o
  const initUserId = useCallback(() => {
    const token = localStorage.getItem("token");
    if (token) {
      try {
        const decoded = jwtDecode(token);
        const id = decoded.sub;
        if (id) {
          setUserId(id);
          return id;
        }
      } catch (err) {
        setError("Lá»—i khi giáº£i mÃ£ token");
      }
    }
    return null;
  }, []);

  const fetchOrders = useCallback(
    async (id, page = 1, pageSize = 10) => {
      setLoading(true);
      setError(null);
      try {
        const token = localStorage.getItem("token");
        const response = await axios.get(
          `${process.env.REACT_APP_API_BASE_URL}/api/orders/user/${id}/paged`,
          {
            headers: { Authorization: `Bearer ${token}` },
            params: { page, pageSize },
          }
        );
        setOrders(response.data.orders);
        return response.data.orders;
      } catch (err) {
        setError(err.response?.data?.message || "KhÃ´ng thá»ƒ táº£i danh sÃ¡ch Ä‘Æ¡n hÃ ng.");
      } finally {
        setLoading(false);
      }
    },
    []
  );

  return {
    orders,
    loading,
    error,
    userId,
    setUserId,
    initUserId,
    fetchOrders,
  };
};

/**
 * Hook for fetching a single order
 */
export const useOrder = (orderId) => {
  const [order, setOrder] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchOrder = useCallback(async () => {
    if (!orderId) return;

    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/orders/${orderId}`,
        {
          headers: token ? { Authorization: `Bearer ${token}` } : {},
        }
      );

      setOrder(response.data);
    } catch (err) {
      setError(err.response?.data?.message || "Failed to fetch order");
      console.error("Error fetching order:", err);
    } finally {
      setLoading(false);
    }
  }, [orderId]);

  useEffect(() => {
    fetchOrder();
  }, [fetchOrder]);

  return {
    order,
    loading,
    error,
    refetch: fetchOrder,
  };
};

/**
 * Hook for creating orders
 */
export const useCreateOrder = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const createOrder = useCallback(async (orderData) => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/orders`,
        orderData,
        {
          headers: token ? { Authorization: `Bearer ${token}` } : {},
        }
      );

      return response.data;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to create order";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  return {
    createOrder,
    loading,
    error,
  };
};

/**
 * Hook for updating order status
 */
export const useUpdateOrderStatus = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const updateStatus = useCallback(async (orderId, status) => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await axios.put(
        `${process.env.REACT_APP_API_BASE_URL}/api/orders/${orderId}/status`,
        { status },
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      return response.data;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to update order status";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  return {
    updateStatus,
    loading,
    error,
  };
};

/**
 * Hook for order lookup by phone number
 */
export const useOrderLookup = () => {
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const lookupOrders = useCallback(async (phoneNumber) => {
    if (!phoneNumber.trim()) {
      setError("Please enter a phone number");
      return;
    }

    try {
      setLoading(true);
      setError(null);

      const response = await axios.get(
        `${
          process.env.REACT_APP_API_BASE_URL
        }/api/orders/lookup?phoneNumber=${encodeURIComponent(phoneNumber)}`
      );

      const ordersData = response.data.$values || response.data || [];
      setOrders(ordersData);
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "No orders found for this phone number";
      setError(errorMessage);
      setOrders([]);
    } finally {
      setLoading(false);
    }
  }, []);

  const clearResults = useCallback(() => {
    setOrders([]);
    setError(null);
  }, []);

  return {
    orders,
    loading,
    error,
    lookupOrders,
    clearResults,
  };
};

/**
 * Hook for order statistics (Admin)
 */
export const useOrderStats = () => {
  const [stats, setStats] = useState({
    totalOrders: 0,
    pendingOrders: 0,
    completedOrders: 0,
    totalRevenue: 0,
    averageOrderValue: 0,
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchStats = useCallback(async (timeRange = "all") => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/orders/stats?range=${timeRange}`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      setStats(response.data);
    } catch (err) {
      setError(
        err.response?.data?.message || "Failed to fetch order statistics"
      );
      console.error("Error fetching order stats:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchStats();
  }, [fetchStats]);

  return {
    stats,
    loading,
    error,
    refetch: fetchStats,
  };
};

/**
 * Hook for sales data (Admin)
 */
export const useSalesData = (timeRange = "month") => {
  const [salesData, setSalesData] = useState([]);
  const [summary, setSummary] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchSalesData = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/orders/dashboard/sales-overview`,
        {
          params: { range: timeRange },
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      setSalesData(response.data.chartData || []);
      setSummary(response.data.summary || null);
    } catch (err) {
      setError(err.response?.data?.message || "Failed to fetch sales data");
      console.error("Error fetching sales data:", err);
    } finally {
      setLoading(false);
    }
  }, [timeRange]);

  useEffect(() => {
    fetchSalesData();
  }, [fetchSalesData]);

  return {
    salesData,
    summary,
    loading,
    error,
    refetch: fetchSalesData,
  };
};

/**
 * Hook for sales by category data (Admin)
 */
export const useSalesByCategory = () => {
  const [categoryData, setCategoryData] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchCategoryData = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/orders/sales-by-category`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      setCategoryData(response.data);
    } catch (err) {
      setError(
        err.response?.data?.message || "Failed to fetch category sales data"
      );
      console.error("Error fetching category sales data:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchCategoryData();
  }, [fetchCategoryData]);

  return {
    categoryData,
    loading,
    error,
    refetch: fetchCategoryData,
  };
};

/**
 * Hook for payment processing
 */
export const usePayment = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const processPayment = useCallback(async (paymentData) => {
    try {
      setLoading(true);
      setError(null);

      const response = await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/payment/process`,
        paymentData
      );

      return response.data;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Payment processing failed";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  const createPayPalOrder = useCallback(async (orderData) => {
    try {
      setLoading(true);
      setError(null);

      const response = await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/paypal/create-order`,
        orderData
      );

      return response.data;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to create PayPal order";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  const capturePayPalOrder = useCallback(async (orderId) => {
    try {
      setLoading(true);
      setError(null);

      const response = await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/paypal/capture-order`,
        { orderId }
      );

      return response.data;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to capture PayPal order";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  return {
    loading,
    error,
    processPayment,
    createPayPalOrder,
    capturePayPalOrder,
  };
};

```

### ClientApp\src\hooks\api\usePaymentMethod.js
```js
import { useState } from "react";
import axios from "axios";

export const usePaymentMethod = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [message, setMessage] = useState("");

  const addPaymentMethod = async (name, description) => {
    setLoading(true);
    setError(null);
    setMessage("");
    try {
      const response = await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/PaymentMethod`,
        { name, description }
      );
      setMessage(`ThÃªm thÃ nh cÃ´ng: ${response.data.name}`);
      return response.data;
    } catch (err) {
      setError("Lá»—i: " + err.message);
      setMessage("Lá»—i: " + err.message);
      return null;
    } finally {
      setLoading(false);
    }
  };

  return { addPaymentMethod, loading, error, message, setMessage };
};

```

### ClientApp\src\hooks\api\useProductData.js
```js
import { useState, useEffect } from "react";
import axios from "axios";

const API_BASE_URL = process.env.REACT_APP_API_BASE_URL;

export const useProductData = () => {
  const [categories, setCategories] = useState([]);
  const [brands, setBrands] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchData = async () => {
      setLoading(true);
      setError(null);
      try {
        const [categoriesRes, brandsRes] = await Promise.all([
          axios.get(`${API_BASE_URL}/api/categories`),
          axios.get(`${API_BASE_URL}/api/brands`),
        ]);
        setCategories(categoriesRes.data.$values || categoriesRes.data || []);
        setBrands(brandsRes.data.$values || brandsRes.data || []);
      } catch (err) {
        console.error("Error fetching product data:", err);
        setError("KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u cho danh má»¥c hoáº·c thÆ°Æ¡ng hiá»‡u.");
      } finally {
        setLoading(false);
      }
    };
    fetchData();
  }, []);

  return { categories, brands, loading, error };
};

```

### ClientApp\src\hooks\api\useProductForm.js
```js
import { useForm } from "react-hook-form";
import axios from "axios";

const API_BASE_URL = process.env.REACT_APP_API_BASE_URL;

export const useProductForm = ({ onAddProduct, onClose, initialImages = [], initialImageUrls = [""] }) => {
  const { 
    register, 
    handleSubmit, 
    reset, 
    control, 
    setValue, 
    watch,
    formState
  } = useForm({
    defaultValues: {
      name: "",
      description: "",
      categoryId: "",
      brandId: "",
      images: initialImages,
      variants: [],
    },
    mode: "onChange",
  });

  const { errors } = formState;

  const handleFormSubmit = async (data, uploadedImages) => {
    try {
      if (uploadedImages.length === 0) {
        console.error("No images provided for the product.");
        return;
      }

      const productData = {
        ...data,
        categoryId: parseInt(data.categoryId),
        brandId: parseInt(data.brandId),
        images: uploadedImages,
        variants: data.variants.map((variant) => ({
          ...variant,
          price: parseFloat(variant.price),
          discountPrice: variant.discountPrice ? parseFloat(variant.discountPrice) : null,
          stockQuantity: parseInt(variant.stockQuantity) || 0,
        })),
      };

      const response = await axios.post(
        `${API_BASE_URL}/api/Products`,
        productData
      );

      onAddProduct(response.data);
      reset(); 
      onClose(); 
      return response.data;
    } catch (error) {
      console.error("Error adding product:", error);
      throw error;
    }
  };

  return {
    register,
    handleSubmit,
    control,
    resetForm: reset,
    setValue,
    watch,
    formState,
    handleFormSubmit,
  };
};

```

### ClientApp\src\hooks\api\useProductImageManager.js
```js
import { useState } from "react";
import axios from "axios";

const API_BASE_URL = process.env.REACT_APP_API_BASE_URL;

export const useProductImageManager = (initialLocalImages = [], initialImageUrls = [""]) => {
  const [tabValue, setTabValue] = useState(0); // 0: Upload, 1: URL
  const [localImages, setLocalImages] = useState(initialLocalImages); // { file, preview, isPrimary }
  const [imageUrls, setImageUrls] = useState(initialImageUrls); // Máº£ng cÃ¡c URL áº£nh
  const [uploadingImage, setUploadingImage] = useState(false);
  const [imageError, setImageError] = useState("");

  const handleImageUploadFromDevice = (e) => {
    const files = Array.from(e.target.files);
    if (!files.length) return;

    setImageError("");
    const newImages = files.map((file, idx) => ({
      file,
      preview: URL.createObjectURL(file),
      isPrimary: localImages.length === 0 && idx === 0,
    }));

    setLocalImages((prev) => {
      const combined = [...prev, ...newImages];
      if (
        combined.filter((img) => img.isPrimary).length > 1 ||
        (prev.length > 0 &&
          combined.some(
            (img) => img.isPrimary && !prev.find((p) => p.file === img.file)?.isPrimary
          ))
      ) {
        return combined.map((img, index) => ({ ...img, isPrimary: index === 0 }));
      }
      if (combined.length > 0 && !combined.some((img) => img.isPrimary)) {
        combined[0].isPrimary = true;
      }
      return combined;
    });
  };

  const handleRemoveLocalImage = (indexToRemove) => {
    const imageToRemove = localImages[indexToRemove];
    URL.revokeObjectURL(imageToRemove.preview);
    setLocalImages((prev) => {
        const updated = prev.filter((_, index) => index !== indexToRemove);
        if (imageToRemove.isPrimary && updated.length > 0 && !updated.some(img => img.isPrimary)) {
            updated[0].isPrimary = true;
        }
        return updated;
    });
  };

  const setPrimaryLocalImage = (indexToSetPrimary) => {
    setLocalImages(prev => prev.map((img, index) => ({
        ...img,
        isPrimary: index === indexToSetPrimary
    })));
  };

  const handleAddUrlField = () => {
    setImageUrls((prev) => [...prev, ""]);
  };

  const handleUrlInputChange = (index, value) => {
    setImageError("");
    const newUrls = [...imageUrls];
    newUrls[index] = value;
    setImageUrls(newUrls);
  };

  const handleRemoveUrlInput = (index) => {
    const newUrls = imageUrls.filter((_, i) => i !== index);
    setImageUrls(newUrls);
  };

  const processImagesForSubmission = async () => {
    setUploadingImage(true);
    setImageError("");
    let processedImages = [];

    try {
      if (tabValue === 0) {
        if (localImages.length === 0) {
          setImageError("Vui lÃ²ng chá»n Ã­t nháº¥t má»™t áº£nh Ä‘á»ƒ táº£i lÃªn.");
          setUploadingImage(false);
          return { error: "Vui lÃ²ng chá»n Ã­t nháº¥t má»™t áº£nh Ä‘á»ƒ táº£i lÃªn.", images: [] };
        }

        processedImages = await Promise.all(
          localImages.map(async (img) => {
            const formData = new FormData();
            formData.append("file", img.file);
            const response = await axios.post(
              `${API_BASE_URL}/api/upload`,
              formData,
              { headers: { "Content-Type": "multipart/form-data" } }
            );
            return {
              imageUrl: response.data.imageUrl,
              isPrimary: img.isPrimary,
            };
          })
        );
      } else {
        const validUrls = imageUrls.filter(url => url && url.trim() !== "");
        if (validUrls.length === 0) {
          setImageError("Vui lÃ²ng nháº­p Ã­t nháº¥t má»™t URL áº£nh há»£p lá»‡.");
          setUploadingImage(false);
          return { error: "Vui lÃ²ng nháº­p Ã­t nháº¥t má»™t URL áº£nh há»£p lá»‡.", images: [] };
        }
        processedImages = validUrls.map((url, index) => ({
          imageUrl: url,
          isPrimary: index === 0,
        }));
      }
    } catch (error) {
      console.error("Error processing images:", error);
      setImageError("Lá»—i trong quÃ¡ trÃ¬nh xá»­ lÃ½ áº£nh. Vui lÃ²ng thá»­ láº¡i.");
      setUploadingImage(false);
      return { error: "Lá»—i trong quÃ¡ trÃ¬nh xá»­ lÃ½ áº£nh.", images: [] };
    }

    setUploadingImage(false);
    if (processedImages.length > 0 && !processedImages.some(img => img.isPrimary)) {
        processedImages[0].isPrimary = true;
    }
    return { images: processedImages, error: null };
  };

  const resetImageManager = () => {
    setLocalImages(initialLocalImages);
    imageUrls.forEach(url => { if (url && url.startsWith('blob:')) URL.revokeObjectURL(url); });
    localImages.forEach(img => URL.revokeObjectURL(img.preview));
    setImageUrls(initialImageUrls);
    setTabValue(0);
    setImageError("");
    setUploadingImage(false);
  };

  return {
    tabValue,
    setTabValue,
    localImages,
    handleImageUploadFromDevice,
    handleRemoveLocalImage,
    setPrimaryLocalImage,
    imageUrls,
    handleAddUrlField,
    handleUrlInputChange,
    handleRemoveUrlInput,
    uploadingImage,
    imageError,
    setImageError,
    processImagesForSubmission,
    resetImageManager,
  };
};

```

### ClientApp\src\hooks\api\useProducts.js
```js
import { useState, useEffect, useCallback, useMemo } from "react";
import { useApi, usePost, usePut, useDelete } from "./useApi";

/**
 * Hook for fetching products
 */
export const useProducts = (filters = {}) => {
  const {
    data: products,
    loading,
    error,
    execute,
  } = useApi("/api/Products", {
    immediate: true,
    defaultValue: [],
    transform: (data) => data.$values || data || [],
  });

  const filteredProducts = useMemo(() => {
    if (!products) return [];

    let filtered = [...products];

    // Apply category filter
    if (filters.categoryId) {
      filtered = filtered.filter(
        (product) => product.categoryId === filters.categoryId
      );
    }

    // Apply brand filter
    if (filters.brandId) {
      filtered = filtered.filter(
        (product) => product.brandId === filters.brandId
      );
    }

    // Apply price range filter
    if (filters.priceRange) {
      const { min, max } = filters.priceRange;
      filtered = filtered.filter((product) => {
        const price =
          product.variants?.[0]?.discountPrice ||
          product.variants?.[0]?.price ||
          0;
        return price >= min && price <= max;
      });
    }

    // Apply search filter
    if (filters.search) {
      const searchLower = filters.search.toLowerCase();
      filtered = filtered.filter(
        (product) =>
          product.name.toLowerCase().includes(searchLower) ||
          product.description?.toLowerCase().includes(searchLower)
      );
    }

    return filtered;
  }, [products, filters]);

  return {
    products: filteredProducts,
    allProducts: products,
    loading,
    error,
    refetch: execute,
  };
};

/**
 * Hook for fetching a single product
 */
export const useProduct = (productId) => {
  const {
    data: product,
    loading,
    error,
    execute,
  } = useApi(productId ? `/api/Products/${productId}` : null, {
    immediate: !!productId,
  });

  return {
    product,
    loading,
    error,
    refetch: execute,
  };
};

/**
 * Hook for fetching product categories
 */
export const useCategories = () => {
  const {
    data: categories,
    loading,
    error,
    execute,
  } = useApi("/api/categories", {
    immediate: true,
    defaultValue: [],
    transform: (data) => data.$values || data || [],
  });

  return {
    categories,
    loading,
    error,
    refetch: execute,
  };
};

/**
 * Hook for fetching brands
 */
export const useBrands = () => {
  const {
    data: brands,
    loading,
    error,
    execute,
  } = useApi("/api/brands", {
    immediate: true,
    defaultValue: [],
    transform: (data) => data.$values || data || [],
  });

  return {
    brands,
    loading,
    error,
    refetch: execute,
  };
};

/**
 * Hook for product search
 */
export const useProductSearch = () => {
  const [searchResults, setSearchResults] = useState(null);
  const [isSearching, setIsSearching] = useState(false);
  const [searchError, setSearchError] = useState(null);

  const search = useCallback(async (query) => {
    if (!query.trim()) {
      setSearchResults(null);
      return;
    }

    try {
      setIsSearching(true);
      setSearchError(null);

      const response = await fetch(
        `${
          process.env.REACT_APP_API_BASE_URL
        }/api/search?query=${encodeURIComponent(query)}`
      );

      if (!response.ok) throw new Error("Search failed");

      const data = await response.json();
      setSearchResults(data);
    } catch (err) {
      setSearchError(err.message);
      setSearchResults(null);
    } finally {
      setIsSearching(false);
    }
  }, []);

  const clearSearch = useCallback(() => {
    setSearchResults(null);
    setSearchError(null);
  }, []);

  return {
    searchResults,
    isSearching,
    searchError,
    search,
    clearSearch,
  };
};

/**
 * Hook for managing compare products
 */
export const useCompareProducts = () => {
  const [compareList, setCompareList] = useState([]);
  const [compareProducts, setCompareProducts] = useState([]);
  const [loading, setLoading] = useState(false);

  // Load compare list from localStorage
  useEffect(() => {
    const saved = JSON.parse(localStorage.getItem("compareList") || "[]");
    setCompareList(saved);
  }, []);

  // Fetch product details when compare list changes
  useEffect(() => {
    const fetchCompareProducts = async () => {
      if (compareList.length === 0) {
        setCompareProducts([]);
        return;
      }

      try {
        setLoading(true);
        const response = await fetch(
          `${process.env.REACT_APP_API_BASE_URL}/api/Products/compare`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(compareList),
          }
        );

        if (!response.ok) throw new Error("Failed to fetch compare products");

        const data = await response.json();
        setCompareProducts(data);
      } catch (error) {
        console.error("Error fetching compare products:", error);
        setCompareProducts([]);
      } finally {
        setLoading(false);
      }
    };

    fetchCompareProducts();
  }, [compareList]);

  const addToCompare = useCallback(
    (productId) => {
      const newList = [...compareList];
      if (!newList.includes(productId) && newList.length < 4) {
        newList.push(productId);
        setCompareList(newList);
        localStorage.setItem("compareList", JSON.stringify(newList));
        window.dispatchEvent(new Event("compareListChanged"));
      }
    },
    [compareList]
  );

  const removeFromCompare = useCallback(
    (productId) => {
      const newList = compareList.filter((id) => id !== productId);
      setCompareList(newList);
      localStorage.setItem("compareList", JSON.stringify(newList));
      window.dispatchEvent(new Event("compareListChanged"));
    },
    [compareList]
  );

  const clearCompareList = useCallback(() => {
    setCompareList([]);
    setCompareProducts([]);
    localStorage.removeItem("compareList");
    window.dispatchEvent(new Event("compareListChanged"));
  }, []);

  return {
    compareList,
    compareProducts,
    loading,
    addToCompare,
    removeFromCompare,
    clearCompareList,
    canAddMore: compareList.length < 4,
  };
};

/**
 * Hook for fetching related products
 */
export const useRelatedProducts = (productId, brandId, categoryId) => {
  const [relatedProducts, setRelatedProducts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchRelatedProducts = async () => {
      if (!productId) return;

      try {
        setLoading(true);
        setError(null);

        const [productsRes, brandsRes] = await Promise.all([
          fetch(`${process.env.REACT_APP_API_BASE_URL}/api/Products`),
          fetch(`${process.env.REACT_APP_API_BASE_URL}/api/brands`),
        ]);

        if (!productsRes.ok || !brandsRes.ok) {
          throw new Error("Failed to fetch related products");
        }

        const [productsData, brandsData] = await Promise.all([
          productsRes.json(),
          brandsRes.json(),
        ]);

        const products = productsData.$values || productsData || [];
        const brands = brandsData.$values || brandsData || [];

        // Filter related products (same brand or category, exclude current product)
        const related = products
          .filter(
            (product) =>
              product.id !== parseInt(productId) &&
              (product.brandId === brandId || product.categoryId === categoryId)
          )
          .slice(0, 8)
          .map((product) => {
            const brand = brands.find((b) => b.id === product.brandId);
            return {
              ...product,
              brand: brand || { name: "Unknown", logo: null },
            };
          });

        setRelatedProducts(related);
      } catch (err) {
        setError(err.message);
        setRelatedProducts([]);
      } finally {
        setLoading(false);
      }
    };

    fetchRelatedProducts();
  }, [productId, brandId, categoryId]);

  return {
    relatedProducts,
    loading,
    error,
  };
};

/**
 * Hook for product specifications
 */
export const useProductSpecifications = (productType, productId) => {
  const [specs, setSpecs] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchSpecifications = async () => {
      if (!productType || !productId) return;

      try {
        setLoading(true);
        setError(null);

        let endpoint;
        switch (productType) {
          case "phone":
            endpoint = "PhoneSpecifications";
            break;
          case "laptop":
            endpoint = "LaptopSpecifications";
            break;
          case "headphone":
            endpoint = "HeadphoneSpecifications";
            break;
          default:
            throw new Error("Unsupported product type");
        }

        const response = await fetch(
          `${process.env.REACT_APP_API_BASE_URL}/api/${endpoint}/product/${productId}`
        );

        if (!response.ok) {
          throw new Error("Failed to fetch specifications");
        }

        const data = await response.json();
        setSpecs(data);
      } catch (err) {
        setError(err.message);
        setSpecs(null);
      } finally {
        setLoading(false);
      }
    };

    fetchSpecifications();
  }, [productType, productId]);

  return {
    specs,
    loading,
    error,
  };
};

```

### ClientApp\src\hooks\api\useProductSpecificationManager.js
```js
import { useState, useEffect, useCallback, useMemo } from "react";
import axios from "axios";

const API_BASE_URL_SPECS = `${process.env.REACT_APP_API_BASE_URL}/api/Specifications`;

export const useSpecificationForm = (product, open, onClose) => {
  const [specifications, setSpecifications] = useState([]); // Now an array
  const [loadingState, setLoadingState] = useState({
    fetch: false,
    submit: false,
    delete: false
  });
  const [snackbarState, setSnackbarState] = useState({ open: false, message: '', severity: 'info' });
  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);
  const [specToDelete, setSpecToDelete] = useState(null); // To store the specific spec to delete

  const showSnackbar = (message, severity = 'success') => {
    setSnackbarState({ open: true, message, severity });
  };

  const resetComponentState = useCallback(() => {
    setSpecifications([]);
    setDeleteDialogOpen(false);
    setSpecToDelete(null);
  }, []);

  const fetchSpecifications = useCallback(async () => {
    if (!product?.id) {
      setSpecifications([]);
      return;
    }
    setLoadingState(prev => ({ ...prev, fetch: true }));
    try {
      const response = await axios.get(`${API_BASE_URL_SPECS}/product/${product.id}`);
      setSpecifications(response.data.$values || response.data || []);
    } catch (error) {
      console.error("Lá»—i khi táº£i thÃ´ng sá»‘ ká»¹ thuáº­t:", error);
      showSnackbar(error.response?.data?.message || error.message || "KhÃ´ng thá»ƒ táº£i thÃ´ng sá»‘ ká»¹ thuáº­t.", "error");
      setSpecifications([]);
    } finally {
      setLoadingState(prev => ({ ...prev, fetch: false }));
    }
  }, [product?.id]);

  const handleAddOrUpdateSpecification = useCallback(async (specData) => {
    if (!product?.id) {
      showSnackbar("KhÃ´ng thá»ƒ lÆ°u: Thiáº¿u thÃ´ng tin sáº£n pháº©m.", "error");
      return;
    }
    setLoadingState(prev => ({ ...prev, submit: true }));
    const payload = { ...specData, productId: product.id };

    try {
      let successMessage = "";
      if (specData.id) { // Update existing specification
        await axios.put(`${API_BASE_URL_SPECS}/${specData.id}`, payload);
        successMessage = 'Cáº­p nháº­t thÃ´ng sá»‘ thÃ nh cÃ´ng!';
      } else { // Add new specification
        const postResponse = await axios.post(API_BASE_URL_SPECS, payload);
        successMessage = 'ThÃªm thÃ´ng sá»‘ thÃ nh cÃ´ng!';
      }
      showSnackbar(successMessage, "success");
      fetchSpecifications(); // Re-fetch to update the list
    } catch (error) {
      console.error("Lá»—i khi lÆ°u thÃ´ng sá»‘:", error);
      const errorData = error.response?.data;
      let errorMsg = "ÄÃ£ xáº£y ra lá»—i khi lÆ°u thÃ´ng sá»‘.";
      if (typeof errorData === 'string') {
        errorMsg = errorData;
      } else if (errorData?.message) {
        errorMsg = errorData.message;
      } else if (errorData?.errors && typeof errorData.errors === 'object') {
        errorMsg = Object.values(errorData.errors).flat().join('; ');
      } else if (errorData?.title) {
        errorMsg = errorData.title;
      }
      showSnackbar(errorMsg, "error");
    } finally {
      setLoadingState(prev => ({ ...prev, submit: false }));
    }
  }, [product?.id, fetchSpecifications]);

  const handleDeleteSpecification = useCallback(async () => {
    if (!specToDelete) return;
    setLoadingState(prev => ({ ...prev, delete: true }));
    try {
      await axios.delete(`${API_BASE_URL_SPECS}/${specToDelete.id}`);
      showSnackbar("ThÃ´ng sá»‘ ká»¹ thuáº­t Ä‘Ã£ Ä‘Æ°á»£c xÃ³a thÃ nh cÃ´ng!", "success");
      setDeleteDialogOpen(false);
      setSpecToDelete(null);
      fetchSpecifications(); // Re-fetch to update the list
    } catch (error) {
      console.error("Lá»—i khi xÃ³a thÃ´ng sá»‘:", error);
      showSnackbar(error.response?.data?.message || error.message || "KhÃ´ng thá»ƒ xÃ³a thÃ´ng sá»‘ ká»¹ thuáº­t.", "error");
    } finally {
      setLoadingState(prev => ({ ...prev, delete: false }));
    }
  }, [specToDelete, fetchSpecifications]);

  useEffect(() => {
    if (open && product) {
      fetchSpecifications();
    } else if (!open) {
      resetComponentState();
    }
  }, [open, product, fetchSpecifications, resetComponentState]);

  const handleDeleteClick = useCallback((spec) => {
    setSpecToDelete(spec);
    setDeleteDialogOpen(true);
  }, []);

  const handleCloseDeleteDialog = () => {
    if (!loadingState.delete) {
      setDeleteDialogOpen(false);
      setSpecToDelete(null);
    }
  };

  const handleCloseSnackbar = () => {
    setSnackbarState(prev => ({ ...prev, open: false }));
  };

  const anyLoading = loadingState.fetch || loadingState.submit || loadingState.delete;
  const showInitialLoadSpinner = loadingState.fetch && specifications.length === 0 && open;
  const showRefetchProgressBar = loadingState.fetch && specifications.length > 0 && open;

  return {
    specifications,
    loadingState,
    snackbarState,
    deleteDialogOpen,
    specToDelete,
    anyLoading,
    showInitialLoadSpinner,
    showRefetchProgressBar,
    actions: {
      handleAddOrUpdateSpecification,
      handleDeleteSpecification,
      handleDeleteClick,
      handleCloseDeleteDialog,
      handleCloseSnackbar,
      showSnackbar
    }
  };
};

```

### ClientApp\src\hooks\api\useReviews.js
```js
import { useState, useEffect, useCallback } from "react";
import axios from "axios";

/**
 * Hook for managing product reviews
 */
export const useReviews = (productId) => {
  const [reviews, setReviews] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [averageRating, setAverageRating] = useState(0);
  const [ratingDistribution, setRatingDistribution] = useState({
    5: 0,
    4: 0,
    3: 0,
    2: 0,
    1: 0,
  });

  const fetchReviews = useCallback(async () => {
    if (!productId) return;

    try {
      setLoading(true);
      setError(null);

      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/Review/product/${productId}`
      );

      const reviewsData = response.data.$values || response.data || [];
      setReviews(reviewsData);

      // Calculate average rating tá»« data reviews
      if (reviewsData.length > 0) {
        const totalRating = reviewsData.reduce(
          (sum, review) => sum + review.rating,
          0
        );
        setAverageRating(totalRating / reviewsData.length);

        // Calculate rating distribution
        const distribution = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
        reviewsData.forEach((review) => {
          distribution[review.rating]++;
        });
        setRatingDistribution(distribution);
      } else {
        setAverageRating(0);
        setRatingDistribution({ 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 });
      }
    } catch (err) {
      setError(err.response?.data?.message || "KhÃ´ng thá»ƒ táº£i Ä‘Ã¡nh giÃ¡");
      console.error("Error fetching reviews:", err);
    } finally {
      setLoading(false);
    }
  }, [productId]);

  useEffect(() => {
    fetchReviews();
  }, [fetchReviews]);

  return {
    reviews,
    loading,
    error,
    averageRating,
    ratingDistribution,
    totalReviews: reviews.length,
    refetch: fetchReviews,
    fetchReviews, // Alias Ä‘á»ƒ tÆ°Æ¡ng thÃ­ch vá»›i component hiá»‡n táº¡i
    fetchAverageRating: fetchReviews, // Alias vÃ¬ average rating Ä‘Æ°á»£c tÃ­nh cÃ¹ng lÃºc
  };
};

/**
 * Hook for submitting reviews
 */
export const useSubmitReview = (productId, onSuccess) => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const submitReview = useCallback(
    async (reviewData) => {
      try {
        setLoading(true);
        setError(null);

        const token = localStorage.getItem("token");
        if (!token) {
          throw new Error("You must be logged in to submit a review");
        }

        if (!token) {
          throw new Error("You must be logged in to submit a review");
        }

        // Backend sáº½ tá»± láº¥y userId tá»« JWT token
        const response = await axios.post(
          `${process.env.REACT_APP_API_BASE_URL}/api/Review`,
          {
            productId: parseInt(productId),
            rating: reviewData.rating,
            comment: reviewData.comment,
          },
          {
            headers: { Authorization: `Bearer ${token}` },
          }
        );

        if (onSuccess) {
          onSuccess(response.data);
        }

        return response.data;
      } catch (err) {
        const errorMessage =
          err.response?.data?.message || "Failed to submit review";
        setError(errorMessage);
        throw new Error(errorMessage);
      } finally {
        setLoading(false);
      }
    },
    [productId, onSuccess]
  );

  return {
    submitReview,
    loading,
    error,
    setError,
  };
};

export const useUserReview = (userId, productId) => {
  const [userReview, setUserReview] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchUserReview = useCallback(async () => {
    if (!userId || !productId) {
      setUserReview(null);
      return;
    }

    try {
      setLoading(true);
      setError(null);
      const token = localStorage.getItem("token");
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/Review/user/${userId}/product/${productId}`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );
      setUserReview(response.data);
    } catch (err) {
      if (err.response && err.response.status === 404) {
        setUserReview(null); // No review found for this user/product
      } else {
        setError(err.response?.data?.message || "KhÃ´ng thá»ƒ táº£i Ä‘Ã¡nh giÃ¡ cá»§a báº¡n");
        console.error("Error fetching user review:", err);
      }
    } finally {
      setLoading(false);
    }
  }, [userId, productId]);

  useEffect(() => {
    fetchUserReview();
  }, [fetchUserReview]);

  return { userReview, loading, error, refetchUserReview: fetchUserReview };
};

export const useReviewModeration = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const approveReview = useCallback(async (reviewId) => {
    try {
      setLoading(true);
      setError(null);
      const token = localStorage.getItem("token");
      await axios.put(
        `${process.env.REACT_APP_API_BASE_URL}/api/Review/${reviewId}/approve`,
        {},
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );
      return true;
    } catch (err) {
      setError(err.response?.data?.message || "KhÃ´ng thá»ƒ duyá»‡t Ä‘Ã¡nh giÃ¡");
      console.error("Error approving review:", err);
      return false;
    } finally {
      setLoading(false);
    }
  }, []);

  const rejectReview = useCallback(async (reviewId) => {
    try {
      setLoading(true);
      setError(null);
      const token = localStorage.getItem("token");
      await axios.put(
        `${process.env.REACT_APP_API_BASE_URL}/api/Review/${reviewId}/reject`,
        {},
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );
      return true;
    } catch (err) {
      setError(err.response?.data?.message || "KhÃ´ng thá»ƒ tá»« chá»‘i Ä‘Ã¡nh giÃ¡");
      console.error("Error rejecting review:", err);
      return false;
    } finally {
      setLoading(false);
    }
  }, []);

  return { approveReview, rejectReview, loading, error };
};

export const useReviewAnalytics = () => {
  const [analytics, setAnalytics] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchAnalytics = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      const token = localStorage.getItem("token");
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/Review/analytics`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );
      setAnalytics(response.data);
    } catch (err) {
      setError(err.response?.data?.message || "KhÃ´ng thá»ƒ táº£i phÃ¢n tÃ­ch Ä‘Ã¡nh giÃ¡");
      console.error("Error fetching review analytics:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchAnalytics();
  }, [fetchAnalytics]);

  return { analytics, loading, error, refetchAnalytics: fetchAnalytics };
};

export const useAllReviews = (filters = {}) => {
  const [allReviews, setAllReviews] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchAllReviews = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      const token = localStorage.getItem("token");

      const queryParams = new URLSearchParams();
      for (const key in filters) {
        if (filters[key] !== null && filters[key] !== undefined && filters[key] !== '') {
          queryParams.append(key, filters[key]);
        }
      }

      const url = `${process.env.REACT_APP_API_BASE_URL}/api/Review/all?${queryParams.toString()}`;

      const response = await axios.get(
        url,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );
      setAllReviews(response.data.$values || response.data || []);
    } catch (err) {
      setError(err.response?.data?.message || "KhÃ´ng thá»ƒ táº£i táº¥t cáº£ Ä‘Ã¡nh giÃ¡");
      console.error("Error fetching all reviews:", err);
    } finally {
      setLoading(false);
    }
  }, [filters]);

  useEffect(() => {
    fetchAllReviews();
  }, [fetchAllReviews]);

  return { allReviews, loading, error, refetchAllReviews: fetchAllReviews };
};

```

### ClientApp\src\hooks\api\useSearch.js
```js
import { useState, useCallback } from "react";
import axios from "axios";

export const useSearch = () => {
  const [results, setResults] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const search = useCallback(async (query, limit = 5) => {
    setLoading(true);
    setError(null);
    try {
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/search`,
        {
          params: { query, limit },
        }
      );
      setResults(response.data);
      return response.data;
    } catch (err) {
      setError(err.response?.data?.message || "Search failed");
      setResults({ products: [], categories: [], brands: [], totalResults: 0 });
    } finally {
      setLoading(false);
    }
  }, []);

  return { results, loading, error, search };
};

```

### ClientApp\src\hooks\api\useUserProfile.js
```js
import { useState, useCallback } from "react";
import axios from "axios";
import { jwtDecode } from "jwt-decode";

export const useUserProfile = () => {
  const [user, setUser] = useState({
    fullName: "",
    email: "",
    role: "",
    phoneNumber: "",
    gender: "",
    dateOfBirth: "",
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [userId, setUserId] = useState(null);

  // Láº¥y userId tá»« token khi khá»Ÿi táº¡o
  const initUserId = useCallback(() => {
    const token = localStorage.getItem("token");
    if (token) {
      try {
        const decoded = jwtDecode(token);
        const id = parseInt(decoded.sub, 10);
        if (Number.isInteger(id)) {
          setUserId(id);
          return id;
        }
      } catch (err) {
        setError("Lá»—i khi giáº£i mÃ£ token");
      }
    }
    return null;
  }, []);

  const fetchUserProfile = useCallback(async (id) => {
    setLoading(true);
    setError(null);
    try {
      const token = localStorage.getItem("token");
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/users/${id}`,
        { headers: { Authorization: `Bearer ${token}` } }
      );
      setUser(response.data);
      return response.data;
    } catch (err) {
      setError(err.response?.data?.message || "Lá»—i khi láº¥y thÃ´ng tin user");
    } finally {
      setLoading(false);
    }
  }, []);

  const updateUserProfile = useCallback(async (updatedUser) => {
    setLoading(true);
    setError(null);
    try {
      const token = localStorage.getItem("token");
      const response = await axios.put(
        `${process.env.REACT_APP_API_BASE_URL}/api/users/profile`,
        updatedUser,
        { headers: { Authorization: `Bearer ${token}` } }
      );
      setUser(response.data.user);
      return response.data.user;
    } catch (err) {
      setError(err.response?.data?.message || "Cáº­p nháº­t tháº¥t báº¡i");
      throw err;
    } finally {
      setLoading(false);
    }
  }, []);

  return {
    user,
    setUser,
    loading,
    error,
    userId,
    setUserId,
    initUserId,
    fetchUserProfile,
    updateUserProfile,
  };
};

```

### ClientApp\src\hooks\auth\useAuth.js
```js
import {
  useState,
  useEffect,
  useCallback,
  createContext,
  useContext,
} from "react";
import { jwtDecode } from "jwt-decode";
import axios from "axios";

// Create Auth Context
const AuthContext = createContext();

/**
 * Auth Provider Component
 */
export const AuthProvider = ({ children }) => {
  const auth = useAuth();
  return <AuthContext.Provider value={auth}>{children}</AuthContext.Provider>;
};

/**
 * Hook to use auth context
 */
export const useAuthContext = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error("useAuthContext must be used within an AuthProvider");
  }
  return context;
};

/**
 * Main authentication hook
 */
export const useAuth = () => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [sessionExpired, setSessionExpired] = useState(false);

  // Check if user is authenticated on mount
  useEffect(() => {
    const token = localStorage.getItem("token");
    if (token) {
      try {
        const decoded = jwtDecode(token);
        const currentTime = Date.now() / 1000;

        if (decoded.exp > currentTime) {
          setUser({
            id: parseInt(decoded.sub, 10),
            email: decoded.email,
            role:
              decoded.role ||
              decoded[
                "http://schemas.microsoft.com/ws/2008/06/identity/claims/role"
              ],
            fullName:
              decoded.name ||
              decoded[
                "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"
              ],
          });
          setIsAuthenticated(true);
        } else {
          // Token expired
          localStorage.removeItem("token");
          setSessionExpired(true);
        }
      } catch (error) {
        console.error("Error decoding token:", error);
        localStorage.removeItem("token");
        setSessionExpired(true);
      }
    }
    setLoading(false);
  }, []);

  const login = useCallback(async (email, password) => {
    setSessionExpired(false);
    try {
      setLoading(true);
      const response = await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/auth/login`,
        { email, password }
      );

      const { token, user: userData } = response.data;

      localStorage.setItem("token", token);
      setUser(userData);
      setIsAuthenticated(true);

      return { success: true, user: userData };
    } catch (error) {
      const message = error.response?.data?.message || "Login failed";
      return { success: false, error: message };
    } finally {
      setLoading(false);
    }
  }, []);

  const register = useCallback(async (userData) => {
    setSessionExpired(false);
    try {
      setLoading(true);
      const response = await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/auth/register`,
        userData
      );

      const { token, user: newUser } = response.data;

      localStorage.setItem("token", token);
      setUser(newUser);
      setIsAuthenticated(true);

      return { success: true, user: newUser };
    } catch (error) {
      const message = error.response?.data?.message || "Registration failed";
      return { success: false, error: message };
    } finally {
      setLoading(false);
    }
  }, []);

  const logout = useCallback(() => {
    localStorage.removeItem("token");
    setUser(null);
    setIsAuthenticated(false);
    setSessionExpired(false);
  }, []);

  const updateProfile = useCallback(
    async (updates) => {
      if (!user) throw new Error("User not authenticated");

      try {
        setLoading(true);
        const token = localStorage.getItem("token");

        const response = await axios.put(
          `${process.env.REACT_APP_API_BASE_URL}/api/users/${user.id}`,
          updates,
          {
            headers: { Authorization: `Bearer ${token}` },
          }
        );

        const updatedUser = response.data;
        setUser(updatedUser);

        return { success: true, user: updatedUser };
      } catch (error) {
        const message =
          error.response?.data?.message || "Profile update failed";
        return { success: false, error: message };
      } finally {
        setLoading(false);
      }
    },
    [user]
  );

  const hasRole = useCallback(
    (role) => {
      return user?.role === role;
    },
    [user]
  );

  const isAdmin = useCallback(() => {
    return hasRole("Admin");
  }, [hasRole]);

  return {
    user,
    loading,
    isAuthenticated,
    sessionExpired,
    login,
    register,
    logout,
    updateProfile,
    hasRole,
    isAdmin,
  };
};

/**
 * Hook for user profile management
 */
export const useProfile = () => {
  const [profile, setProfile] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchProfile = useCallback(async (userId) => {
    if (!userId) return;

    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await axios.get(
        `${process.env.REACT_APP_API_BASE_URL}/api/users/${userId}`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      setProfile(response.data);
    } catch (err) {
      setError(err.response?.data?.message || "Failed to fetch profile");
    } finally {
      setLoading(false);
    }
  }, []);

  const updateProfile = useCallback(async (userId, updates) => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      const response = await axios.put(
        `${process.env.REACT_APP_API_BASE_URL}/api/users/${userId}`,
        updates,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      setProfile(response.data);
      return response.data;
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to update profile";
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  return {
    profile,
    loading,
    error,
    fetchProfile,
    updateProfile,
  };
};

/**
 * Hook for password management
 */
export const usePassword = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const changePassword = useCallback(async (currentPassword, newPassword) => {
    try {
      setLoading(true);
      setError(null);

      const token = localStorage.getItem("token");
      await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/auth/change-password`,
        {
          currentPassword,
          newPassword,
        },
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      return { success: true };
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to change password";
      setError(errorMessage);
      return { success: false, error: errorMessage };
    } finally {
      setLoading(false);
    }
  }, []);

  const resetPassword = useCallback(async (email) => {
    try {
      setLoading(true);
      setError(null);

      await axios.post(
        `${process.env.REACT_APP_API_BASE_URL}/api/auth/reset-password`,
        { email }
      );

      return { success: true };
    } catch (err) {
      const errorMessage =
        err.response?.data?.message || "Failed to send reset email";
      setError(errorMessage);
      return { success: false, error: errorMessage };
    } finally {
      setLoading(false);
    }
  }, []);

  return {
    loading,
    error,
    changePassword,
    resetPassword,
  };
};

```

### ClientApp\src\hooks\ui\useUI.js
```js
import { useState, useEffect, useCallback, useRef } from "react";

/**
 * Hook for debouncing values
 */
export const useDebounce = (value, delay) => {
  const [debouncedValue, setDebouncedValue] = useState(value);

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);

    return () => {
      clearTimeout(handler);
    };
  }, [value, delay]);

  return debouncedValue;
};

/**
 * Hook for managing loading states
 */
export const useLoading = (initialState = {}) => {
  const [loadingStates, setLoadingStates] = useState(initialState);

  const setLoading = useCallback((key, isLoading) => {
    setLoadingStates((prev) => ({
      ...prev,
      [key]: isLoading,
    }));
  }, []);

  const isLoading = useCallback(
    (key) => {
      return !!loadingStates[key];
    },
    [loadingStates]
  );

  const resetLoading = useCallback(() => {
    setLoadingStates({});
  }, []);

  return {
    loadingStates,
    setLoading,
    isLoading,
    resetLoading,
  };
};

/**
 * Hook for managing notification/toast states
 */
export const useNotification = () => {
  const [notification, setNotification] = useState(null);

  const showNotification = useCallback(
    (message, type = "info", duration = 3000, title = "") => {
      setNotification({ message, type, title });

      if (duration > 0) {
        setTimeout(() => {
          setNotification(null);
        }, duration);
      }
    },
    []
  );

  const hideNotification = useCallback(() => {
    setNotification(null);
  }, []);

  const showSuccess = useCallback(
    (message, title = "Success") => {
      showNotification(message, "success", 3000, title);
    },
    [showNotification]
  );

  const showError = useCallback(
    (message, title = "Error") => {
      showNotification(message, "error", 5000, title);
    },
    [showNotification]
  );

  const showWarning = useCallback(
    (message, title = "Warning") => {
      showNotification(message, "warning", 4000, title);
    },
    [showNotification]
  );

  const showInfo = useCallback(
    (message, title = "Info") => {
      showNotification(message, "info", 3000, title);
    },
    [showNotification]
  );

  return {
    notification,
    showNotification,
    hideNotification,
    showSuccess,
    showError,
    showWarning,
    showInfo,
  };
};

/**
 * Hook for managing modal states
 */
export const useModal = (initialState = false) => {
  const [isOpen, setIsOpen] = useState(initialState);

  const open = useCallback(() => setIsOpen(true), []);
  const close = useCallback(() => setIsOpen(false), []);
  const toggle = useCallback(() => setIsOpen((prev) => !prev), []);

  return {
    isOpen,
    open,
    close,
    toggle,
  };
};

/**
 * Hook for managing pagination
 */
export const usePagination = (totalItems, itemsPerPage = 10) => {
  const [currentPage, setCurrentPage] = useState(1);

  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, totalItems);

  const goToPage = useCallback(
    (page) => {
      const newPage = Math.max(1, Math.min(page, totalPages));
      setCurrentPage(newPage);
    },
    [totalPages]
  );

  const nextPage = useCallback(() => {
    goToPage(currentPage + 1);
  }, [currentPage, goToPage]);

  const prevPage = useCallback(() => {
    goToPage(currentPage - 1);
  }, [currentPage, goToPage]);

  const canGoNext = currentPage < totalPages;
  const canGoPrev = currentPage > 1;

  // Reset to page 1 when total items change significantly
  useEffect(() => {
    if (currentPage > totalPages && totalPages > 0) {
      setCurrentPage(1);
    }
  }, [totalPages, currentPage]);

  return {
    currentPage,
    totalPages,
    startIndex,
    endIndex,
    itemsPerPage,
    canGoNext,
    canGoPrev,
    goToPage,
    nextPage,
    prevPage,
    setCurrentPage,
  };
};

/**
 * Hook for managing form state
 */
export const useForm = (initialValues = {}, validate) => {
  const [values, setValues] = useState(initialValues);
  const [errors, setErrors] = useState({});
  const [touched, setTouched] = useState({});
  const [isSubmitting, setIsSubmitting] = useState(false);

  const setValue = useCallback(
    (name, value) => {
      setValues((prev) => ({ ...prev, [name]: value }));

      // Clear error when user starts typing
      if (errors[name]) {
        setErrors((prev) => ({ ...prev, [name]: undefined }));
      }
    },
    [errors]
  );

  const setFieldTouched = useCallback((name, isTouched = true) => {
    setTouched((prev) => ({ ...prev, [name]: isTouched }));
  }, []);

  const handleChange = useCallback(
    (e) => {
      const { name, value, type, checked } = e.target;
      setValue(name, type === "checkbox" ? checked : value);
    },
    [setValue]
  );

  const handleBlur = useCallback(
    (e) => {
      const { name } = e.target;
      setFieldTouched(name, true);

      if (validate) {
        const fieldErrors = validate({ ...values, [name]: values[name] });
        if (fieldErrors[name]) {
          setErrors((prev) => ({ ...prev, [name]: fieldErrors[name] }));
        }
      }
    },
    [values, validate, setFieldTouched]
  );

  const validateForm = useCallback(() => {
    if (!validate) return {};

    const formErrors = validate(values);
    setErrors(formErrors);
    return formErrors;
  }, [values, validate]);

  const resetForm = useCallback(
    (newValues = initialValues) => {
      setValues(newValues);
      setErrors({});
      setTouched({});
      setIsSubmitting(false);
    },
    [initialValues]
  );

  const handleSubmit = useCallback(
    (onSubmit) => {
      return async (e) => {
        if (e) {
          e.preventDefault();
        }

        setIsSubmitting(true);

        const formErrors = validateForm();
        const hasErrors = Object.keys(formErrors).length > 0;

        if (!hasErrors) {
          try {
            await onSubmit(values);
          } catch (error) {
            console.error("Form submission error:", error);
          }
        } else {
          // Mark all fields as touched to show errors
          const allTouched = Object.keys(values).reduce((acc, key) => {
            acc[key] = true;
            return acc;
          }, {});
          setTouched(allTouched);
        }

        setIsSubmitting(false);
      };
    },
    [values, validateForm]
  );

  const isValid = Object.keys(errors).length === 0;

  return {
    values,
    errors,
    touched,
    isSubmitting,
    isValid,
    setValue,
    setFieldTouched,
    handleChange,
    handleBlur,
    handleSubmit,
    resetForm,
    validateForm,
  };
};

/**
 * Hook for managing filters
 */
export const useFilters = (initialFilters = {}) => {
  const [filters, setFilters] = useState(initialFilters);

  const setFilter = useCallback((key, value) => {
    setFilters((prev) => ({ ...prev, [key]: value }));
  }, []);

  const removeFilter = useCallback((key) => {
    setFilters((prev) => {
      const newFilters = { ...prev };
      delete newFilters[key];
      return newFilters;
    });
  }, []);

  const clearFilters = useCallback(() => {
    setFilters(initialFilters);
  }, [initialFilters]);

  const hasActiveFilters = useCallback(() => {
    return Object.keys(filters).some((key) => {
      const value = filters[key];
      return (
        value !== null &&
        value !== undefined &&
        value !== "" &&
        (Array.isArray(value) ? value.length > 0 : true)
      );
    });
  }, [filters]);

  return {
    filters,
    setFilter,
    removeFilter,
    clearFilters,
    hasActiveFilters: hasActiveFilters(),
  };
};

/**
 * Hook for handling click outside
 */
export const useClickOutside = (callback) => {
  const ref = useRef(null);

  useEffect(() => {
    const handleClickOutside = (event) => {
      if (ref.current && !ref.current.contains(event.target)) {
        callback();
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [callback]);

  return ref;
};

/**
 * Hook for managing scroll position
 */
export const useScroll = () => {
  const [scrollPosition, setScrollPosition] = useState(0);

  useEffect(() => {
    const updatePosition = () => {
      setScrollPosition(window.pageYOffset);
    };

    window.addEventListener("scroll", updatePosition);
    updatePosition();

    return () => window.removeEventListener("scroll", updatePosition);
  }, []);

  const scrollToTop = useCallback(() => {
    window.scrollTo({ top: 0, behavior: "smooth" });
  }, []);

  const scrollToElement = useCallback((elementId) => {
    const element = document.getElementById(elementId);
    if (element) {
      element.scrollIntoView({ behavior: "smooth" });
    }
  }, []);

  return {
    scrollPosition,
    scrollToTop,
    scrollToElement,
  };
};

/**
 * Hook for managing local storage
 */
export const useLocalStorage = (key, initialValue) => {
  const [storedValue, setStoredValue] = useState(() => {
    try {
      const item = window.localStorage.getItem(key);
      return item ? JSON.parse(item) : initialValue;
    } catch (error) {
      console.error(`Error reading localStorage key "${key}":`, error);
      return initialValue;
    }
  });

  const setValue = useCallback(
    (value) => {
      try {
        setStoredValue(value);
        window.localStorage.setItem(key, JSON.stringify(value));
      } catch (error) {
        console.error(`Error setting localStorage key "${key}":`, error);
      }
    },
    [key]
  );

  const removeValue = useCallback(() => {
    try {
      setStoredValue(initialValue);
      window.localStorage.removeItem(key);
    } catch (error) {
      console.error(`Error removing localStorage key "${key}":`, error);
    }
  }, [key, initialValue]);

  return [storedValue, setValue, removeValue];
};

```

### ClientApp\src\pages\Admin\AnalyticsPage.jsx
```jsx
import Header from "../../components/Admin/common/Header";
import OverviewCards from "../../components/Admin/analytics/OverviewCards";
import RevenueChart from "../../components/Admin/analytics/RevenueChart";
import ChannelPerformance from "../../components/Admin/analytics/ChannelPerformance";
import ProductPerformance from "../../components/Admin/analytics/ProductPerformance";
import UserRetention from "../../components/Admin/analytics/UserRetention";
import CustomerSegmentation from "../../components/Admin/analytics/CustomerSegmentation";
import AIPoweredInsights from "../../components/Admin/analytics/AIPoweredInsights";

const AnalyticsPage = () => {
	return (
		<div className='flex-1 overflow-auto relative z-10 bg-gray-900'>
			<Header title={"PhÃ¢n tÃ­ch dá»¯ liá»‡u"} />

			<main className='max-w-7xl mx-auto py-6 px-4 lg:px-8'>
				<OverviewCards />
				<RevenueChart />

				<div className='grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8'>
					<ChannelPerformance />
					<ProductPerformance />
					<UserRetention />
					<CustomerSegmentation />
				</div>

				<AIPoweredInsights />
			</main>
		</div>
	);
};
export default AnalyticsPage;

```

### ClientApp\src\pages\Admin\BestSellerAdminPage.js
```js
import React, { useState, useEffect, useCallback } from 'react';
import axios from 'axios';
import { DragDropContext, Droppable, Draggable } from 'react-beautiful-dnd';
import BestSellerSection from '@/components/BestSellers/BestSellers'; // Import the BestSellerSection component

const BestSellerAdminPage = () => {
  const [homepageConfig, setHomepageConfig] = useState(null);
  const [bestSellerProductIds, setBestSellerProductIds] = useState([]);
  const [bestSellerProductsDetails, setBestSellerProductsDetails] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState(null);
  const [searchLoading, setSearchLoading] = useState(false);

  const fetchHomepageConfig = useCallback(async () => {
    try {
      setLoading(true);
      const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/homepage-config`);
      const config = response.data;
      setHomepageConfig(config);
      if (config.components.best_seller && config.components.best_seller.productIds) {
        setBestSellerProductIds(config.components.best_seller.productIds);
      }
    } catch (err) {
      setError('Failed to load homepage configuration.');
      console.error(err);
    } finally {
      setLoading(false);
    }
  }, []);

  const fetchProductDetails = useCallback(async (ids) => {
    if (ids.length === 0) {
      setBestSellerProductsDetails([]);
      return;
    }
    try {
      const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/products/by-ids?ids=${ids.join(',')}`);
      setBestSellerProductsDetails(response.data);
    } catch (err) {
      console.error('Failed to fetch product details:', err);
      setBestSellerProductsDetails([]); // Clear if error
    }
  }, []);

  useEffect(() => {
    fetchHomepageConfig();
  }, [fetchHomepageConfig]);

  useEffect(() => {
    if (bestSellerProductIds.length > 0) {
      fetchProductDetails(bestSellerProductIds);
    } else {
      setBestSellerProductsDetails([]);
    }
  }, [bestSellerProductIds, fetchProductDetails]);

  const handleSearch = async () => {
    if (!searchQuery.trim()) {
      setSearchResults([]);
      return;
    }
    try {
      setSearchLoading(true);
      const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/products/search?keyword=${searchQuery}`);
      // Filter out products already in the best seller list
      const filteredResults = response.data.filter(product => !bestSellerProductIds.includes(product.id));
      setSearchResults(filteredResults);
    } catch (err) {
      console.error('Failed to search products:', err);
      setSearchResults([]);
    } finally {
      setSearchLoading(false);
    }
  };

  const addProductToBestSellers = (product) => {
    if (!bestSellerProductIds.includes(product.id)) {
      setBestSellerProductIds(prevIds => [...prevIds, product.id]);
      setSearchResults(prevResults => prevResults.filter(p => p.id !== product.id)); // Remove from search results
    }
  };

  const removeProductFromBestSellers = (productId) => {
    setBestSellerProductIds(prevIds => prevIds.filter(id => id !== productId));
  };

  const onDragEnd = (result) => {
    if (!result.destination) return;

    const reorderedIds = Array.from(bestSellerProductIds);
    const [removed] = reorderedIds.splice(result.source.index, 1);
    reorderedIds.splice(result.destination.index, 0, removed);

    setBestSellerProductIds(reorderedIds);
  };

  const handleSave = async () => {
    if (!homepageConfig) return;

    try {
      setSaving(true);
      const updatedConfig = { ...homepageConfig };
      updatedConfig.components.best_seller = {
        ...updatedConfig.components.best_seller,
        enabled: true, // Ensure it's enabled when saving products
        productIds: bestSellerProductIds,
      };
      // Ensure 'best_seller' is in the layout if not already
      if (!updatedConfig.layout.includes('best_seller')) {
        updatedConfig.layout.push('best_seller');
      }

      await axios.put(`${process.env.REACT_APP_API_BASE_URL}/api/homepage-config`, updatedConfig);
      alert('Best Seller configuration saved successfully!');
    } catch (err) {
      setError('Failed to save Best Seller configuration.');
      console.error(err);
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return <div className="text-white">Loading Best Seller Admin...</div>;
  }

  if (error) {
    return <div className="text-red-500">{error}</div>;
  }

  const previewData = {
    enabled: homepageConfig?.components?.best_seller?.enabled || true,
    title: homepageConfig?.components?.best_seller?.title || "Best Sellers",
    productIds: bestSellerProductIds,
  };

  return (
    <div className="container mx-auto p-4 text-white">
      <h1 className="text-3xl font-bold mb-6">Manage Best Sellers</h1>

      {/* Search and Add Products */}
      <div className="mb-8 p-4 border border-gray-700 rounded-lg">
        <h2 className="text-2xl font-semibold mb-4">Add Products</h2>
        <div className="flex mb-4">
          <input
            type="text"
            className="flex-grow p-2 rounded-l-md bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-electric-blue"
            placeholder="Search products by name..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            onKeyPress={(e) => { if (e.key === 'Enter') handleSearch(); }}
          />
          <button
            onClick={handleSearch}
            className="bg-electric-blue text-white px-4 py-2 rounded-r-md hover:bg-electric-blue-dark transition-colors duration-200"
            disabled={searchLoading}
          >
            {searchLoading ? 'Searching...' : 'Search'}
          </button>
        </div>
        <div className="max-h-60 overflow-y-auto border border-gray-700 rounded-md p-2">
          {searchResults.length === 0 && !searchLoading && <p className="text-gray-400">No results or start typing to search.</p>}
          {searchResults.map(product => (
            <div key={product.id} className="flex items-center justify-between p-2 border-b border-gray-700 last:border-b-0">
              <div className="flex items-center">
                {product.images && product.images.length > 0 && (
                  <img src={product.images[0].imageUrl} alt={product.name} className="w-12 h-12 object-cover rounded mr-3" />
                )}
                <span>{product.name}</span>
              </div>
              <button
                onClick={() => addProductToBestSellers(product)}
                className="bg-green-600 text-white px-3 py-1 rounded-md text-sm hover:bg-green-700 transition-colors duration-200"
              >
                Add
              </button>
            </div>
          ))}
        </div>
      </div>

      {/* Best Seller List (Drag and Drop) */}
      <div className="mb-8 p-4 border border-gray-700 rounded-lg">
        <h2 className="text-2xl font-semibold mb-4">Current Best Sellers ({bestSellerProductIds.length})</h2>
        <DragDropContext onDragEnd={onDragEnd}>
          <Droppable droppableId="best-sellers-list">
            {(provided) => (
              <div
                {...provided.droppableProps}
                ref={provided.innerRef}
                className="min-h-[100px] border border-gray-600 rounded-md p-2 bg-gray-800"
              >
                {bestSellerProductsDetails.length === 0 && <p className="text-gray-400 text-center py-4">Drag products here or add from search.</p>}
                {bestSellerProductsDetails.map((product, index) => (
                  <Draggable key={product.id} draggableId={product.id.toString()} index={index}>
                    {(provided) => (
                      <div
                        ref={provided.innerRef}
                        {...provided.draggableProps}
                        {...provided.dragHandleProps}
                        className="flex items-center justify-between p-3 mb-2 bg-gray-700 rounded-md shadow-md border border-gray-600"
                      >
                        <div className="flex items-center">
                          {product.images && product.images.length > 0 && (
                            <img src={product.images[0].imageUrl} alt={product.name} className="w-16 h-16 object-cover rounded mr-4" />
                          )}
                          <span className="font-medium">{product.name}</span>
                        </div>
                        <button
                          onClick={() => removeProductFromBestSellers(product.id)}
                          className="bg-red-600 text-white px-3 py-1 rounded-md text-sm hover:bg-red-700 transition-colors duration-200"
                        >
                          Remove
                        </button>
                      </div>
                    )}
                  </Draggable>
                ))}
                {provided.placeholder}
              </div>
            )}
          </Droppable>
        </DragDropContext>
        <button
          onClick={handleSave}
          className="mt-6 bg-blue-600 text-white px-6 py-3 rounded-md text-lg hover:bg-blue-700 transition-colors duration-200 w-full"
          disabled={saving}
        >
          {saving ? 'Saving...' : 'Save Best Seller Configuration'}
        </button>
      </div>

      {/* Live Preview */}
      <div className="p-4 border border-gray-700 rounded-lg bg-gray-900">
        <h2 className="text-2xl font-semibold mb-4">Live Preview</h2>
        <BestSellerSection data={previewData} />
      </div>
    </div>
  );
};

export default BestSellerAdminPage;

```

### ClientApp\src\pages\Admin\CategoryAdminPage.js
```js
import React, { useState, useEffect } from 'react';
import axios from 'axios';

const CategoryAdminPage = () => {
  const [categories, setCategories] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [newCategoryName, setNewCategoryName] = useState('');
  const [newCategoryDescription, setNewCategoryDescription] = useState('');
  const [newCategoryImage, setNewCategoryImage] = useState('');
  const [newCategoryIsActive, setNewCategoryIsActive] = useState(true);
  const [editingCategory, setEditingCategory] = useState(null);

  useEffect(() => {
    fetchCategories();
  }, []);

  const fetchCategories = async () => {
    try {
      setLoading(true);
      const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/categories`);
      setCategories(response.data);
    } catch (err) {
      setError('Failed to load categories.');
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const handleAddCategory = async () => {
    try {
      await axios.post('/api/categories', {
        name: newCategoryName,
        description: newCategoryDescription,
        image: newCategoryImage,
        isActive: newCategoryIsActive,
      });
      setNewCategoryName('');
      setNewCategoryDescription('');
      setNewCategoryImage('');
      setNewCategoryIsActive(true);
      fetchCategories();
      alert('Category added successfully!');
    } catch (err) {
      alert('Failed to add category.');
      console.error(err);
    }
  };

  const handleEditCategory = (category) => {
    setEditingCategory(category);
    setNewCategoryName(category.name);
    setNewCategoryDescription(category.description);
    setNewCategoryImage(category.image);
    setNewCategoryIsActive(category.isActive);
  };

  const handleUpdateCategory = async () => {
    try {
      await axios.put(`/api/categories/${editingCategory.id}`, {
        id: editingCategory.id,
        name: newCategoryName,
        description: newCategoryDescription,
        image: newCategoryImage,
        isActive: newCategoryIsActive,
      });
      setEditingCategory(null);
      setNewCategoryName('');
      setNewCategoryDescription('');
      setNewCategoryImage('');
      setNewCategoryIsActive(true);
      fetchCategories();
      alert('Category updated successfully!');
    } catch (err) {
      alert('Failed to update category.');
      console.error(err);
    }
  };

  const handleDeleteCategory = async (id) => {
    if (window.confirm('Are you sure you want to delete this category?')) {
      try {
        await axios.delete(`/api/categories/${id}`);
        fetchCategories();
        alert('Category deleted successfully!');
      } catch (err) {
        alert('Failed to delete category.');
        console.error(err);
      }
    }
  };

  if (loading) {
    return <div className="p-4 text-white">Loading categories...</div>;
  }

  if (error) {
    return <div className="p-4 text-red-500">{error}</div>;
  }

  return (
    <div className="p-6 bg-gray-800 min-h-screen text-white">
      <h1 className="text-3xl font-bold mb-6">Manage Categories</h1>

      {/* Add/Edit Category Form */}
      <div className="bg-gray-700 p-6 rounded-lg mb-8">
        <h2 className="text-2xl font-semibold mb-4">
          {editingCategory ? 'Edit Category' : 'Add New Category'}
        </h2>
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-300">Name</label>
            <input
              type="text"
              className="mt-1 block w-full p-2 rounded-md bg-gray-600 border border-gray-500 text-white"
              value={newCategoryName}
              onChange={(e) => setNewCategoryName(e.target.value)}
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-300">Description</label>
            <textarea
              className="mt-1 block w-full p-2 rounded-md bg-gray-600 border border-gray-500 text-white"
              value={newCategoryDescription}
              onChange={(e) => setNewCategoryDescription(e.target.value)}
            ></textarea>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-300">Image URL</label>
            <input
              type="text"
              className="mt-1 block w-full p-2 rounded-md bg-gray-600 border border-gray-500 text-white"
              value={newCategoryImage}
              onChange={(e) => setNewCategoryImage(e.target.value)}
            />
          </div>
          <label className="inline-flex items-center cursor-pointer">
            <input
              type="checkbox"
              className="sr-only peer"
              checked={newCategoryIsActive}
              onChange={(e) => setNewCategoryIsActive(e.target.checked)}
            />
            <div className="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500 peer-checked:bg-blue-600"></div>
            <span className="ms-3 text-sm font-medium text-gray-900 dark:text-gray-300">Is Active</span>
          </label>
          <button
            onClick={editingCategory ? handleUpdateCategory : handleAddCategory}
            className="mt-4 px-6 py-3 bg-electric-blue text-primary-dark font-bold rounded-md hover:opacity-90 transition-opacity"
          >
            {editingCategory ? 'Update Category' : 'Add Category'}
          </button>
          {editingCategory && (
            <button
              onClick={() => {
                setEditingCategory(null);
                setNewCategoryName('');
                setNewCategoryDescription('');
                setNewCategoryImage('');
                setNewCategoryIsActive(true);
              }}
              className="ml-4 mt-4 px-6 py-3 bg-gray-500 text-white font-bold rounded-md hover:opacity-90 transition-opacity"
            >
              Cancel Edit
            </button>
          )}
        </div>
      </div>

      {/* Categories List */}
      <div className="bg-gray-700 p-6 rounded-lg">
        <h2 className="text-2xl font-semibold mb-4">Existing Categories</h2>
        <ul className="divide-y divide-gray-600">
          {categories.map((category) => (
            <li key={category.id} className="flex justify-between items-center py-3">
              <div>
                <p className="text-lg font-medium text-white">{category.name} {category.isActive ? '(Active)' : '(Inactive)'}</p>
                <p className="text-sm text-gray-400">{category.description}</p>
              </div>
              <div>
                <button
                  onClick={() => handleEditCategory(category)}
                  className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                >
                  Edit
                </button>
                <button
                  onClick={() => handleDeleteCategory(category.id)}
                  className="ml-2 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors"
                >
                  Delete
                </button>
              </div>
            </li>
          ))}
        </ul>
      </div>
    </div>
  );
};

export default CategoryAdminPage;

```

### ClientApp\src\pages\Admin\FlashSaleAdminPage.js
```js
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { AutoComplete, Button, Table, InputNumber, DatePicker, message, Popconfirm, Space, Card, Typography, Select, Spin, Alert, Input } from 'antd';
import { SearchOutlined, DeleteOutlined, PlusOutlined, SaveOutlined } from '@ant-design/icons';
import dayjs from 'dayjs';

const { Text } = Typography;
const API_BASE_URL = process.env.REACT_APP_API_BASE_URL;

const FlashSaleAdminPage = () => {
  const [products, setProducts] = useState([]); // All products for selection
  const [flashSaleProducts, setFlashSaleProducts] = useState([]); // Products currently on flash sale
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [searchText, setSearchText] = useState('');
  const [searchedProductsOptions, setSearchedProductsOptions] = useState([]);

  const [selectedProductToAdd, setSelectedProductToAdd] = useState(null);
  const [newFlashSalePrice, setNewFlashSalePrice] = useState(0);
  const [newFlashSaleStartDate, setNewFlashSaleStartDate] = useState(null);
  const [newFlashSaleEndDate, setNewFlashSaleEndDate] = useState(null);

  useEffect(() => {
    fetchFlashSaleProducts();
    fetchAllProducts();
  }, []);

  const fetchAllProducts = async () => {
    try {
      const response = await axios.get(`${API_BASE_URL}/api/products`);
      setProducts(response.data.$values || response.data || []);
    } catch (err) {
      message.error('Failed to load all products for selection.');
      console.error(err);
    }
  };

  const fetchFlashSaleProducts = async () => {
    setLoading(true);
    try {
      const { data } = await axios.get(`${API_BASE_URL}/api/Products/flash-sale`);
      const detailedProducts = data.$values || data || [];

      const combinedProducts = detailedProducts.map(flashSaleProduct => {
        const primaryImage = flashSaleProduct?.images?.find(img => img.isPrimary) || flashSaleProduct?.images?.[0];
        const imageUrl = primaryImage ? (primaryImage.imageUrl.startsWith("http") ? primaryImage.imageUrl : `${API_BASE_URL}/${primaryImage.imageUrl}`) : "https://via.placeholder.com/50";

        // Determine original price from variants (assuming first variant for simplicity, or find min price)
        const originalPrice = flashSaleProduct.variants?.[0]?.price || 0;

        return {
          ...flashSaleProduct,
          imageUrl: imageUrl,
          originalPrice: originalPrice,
        };
      });
      setFlashSaleProducts(combinedProducts);
    } catch (err) {
      setError('Failed to load flash sale products.');
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const handleSearchProduct = (value) => {
    if (value) {
      const filtered = products.filter(p => p.name.toLowerCase().includes(value.toLowerCase()));
      setSearchedProductsOptions(filtered.map(p => ({
        value: p.id,
        label: (
          <Space>
            <img src={p.images?.[0]?.imageUrl?.startsWith("http") ? p.images[0].imageUrl : `${API_BASE_URL}/${p.images?.[0]?.imageUrl}`} alt={p.name} style={{ width: 30, height: 30, objectFit: 'contain' }} onError={(e) => { e.target.onerror = null; e.target.src = "https://via.placeholder.com/30"; }} />
            {p.name}
          </Space>
        ),
        product: p
      })));
    } else {
      setSearchedProductsOptions([]);
    }
    setSearchText(value);
  };

  const handleSelectProduct = (value, option) => {
    setSelectedProductToAdd(option.product);
    setSearchText(option.product.name); // Keep selected product name in search input
  };

  const handleSetFlashSale = async () => {
    if (!selectedProductToAdd || !newFlashSalePrice || !newFlashSaleStartDate || !newFlashSaleEndDate) {
      message.error('Please fill all flash sale fields.');
      return;
    }

    try {
      await axios.put(`${API_BASE_URL}/api/products/${selectedProductToAdd.id}/set-flash-sale`, {
        flashSalePrice: newFlashSalePrice,
        flashSaleStartDate: newFlashSaleStartDate.toISOString(),
        flashSaleEndDate: newFlashSaleEndDate.toISOString(),
      });
      message.success('Flash sale set successfully!');
      resetForm();
      fetchFlashSaleProducts();
    } catch (err) {
      message.error('Failed to set flash sale.');
      console.error(err);
    }
  };

  const handleClearFlashSale = async (productId) => {
    try {
      await axios.put(`${API_BASE_URL}/api/products/${productId}/clear-flash-sale`);
      message.success('Flash sale cleared successfully!');
      fetchFlashSaleProducts();
    } catch (err) {
      message.error('Failed to clear flash sale.');
      console.error(err);
    }
  };

  const resetForm = () => {
    setSelectedProductToAdd(null);
    setNewFlashSalePrice(0);
    setNewFlashSaleStartDate(null);
    setNewFlashSaleEndDate(null);
    setSearchText('');
  };

  const priceOptions = [100000, 500000, 1000000, 2000000, 5000000];

  const columns = [
    {
      title: 'Product',
      key: 'productInfo',
      render: (_, record) => (
        <Space>
          <img src={record.imageUrl} alt={record.name} style={{ width: 50, height: 50, objectFit: 'contain' }} />
          <Text>{record.name}</Text>
        </Space>
      )
    },
    {
      title: 'Original Price',
      key: 'originalPrice',
      render: (_, record) => (
        <Text delete={record.flashSalePrice !== null && record.flashSalePrice < record.originalPrice}>
          {record.originalPrice.toLocaleString('vi-VN')}Ä‘
        </Text>
      )
    },
    {
      title: 'Flash Sale Price',
      dataIndex: 'flashSalePrice',
      key: 'flashSalePrice',
      render: (price) => (
        <Text strong type="danger">
          {price?.toLocaleString('vi-VN')}Ä‘
        </Text>
      )
    },
    {
      title: 'Start Date',
      dataIndex: 'flashSaleStartDate',
      key: 'flashSaleStartDate',
      render: (date) => date ? dayjs(date).format('YYYY-MM-DD HH:mm:ss') : 'N/A'
    },
    {
      title: 'End Date',
      dataIndex: 'flashSaleEndDate',
      key: 'flashSaleEndDate',
      render: (date) => date ? dayjs(date).format('YYYY-MM-DD HH:mm:ss') : 'N/A'
    },
    {
      title: 'Action',
      key: 'action',
      render: (_, record) => (
        <Popconfirm title="Are you sure you want to clear flash sale for this product?" onConfirm={() => handleClearFlashSale(record.id)} okText="Yes" cancelText="No">
          <Button danger icon={<DeleteOutlined />} />
        </Popconfirm>
      )
    }
  ];

  if (loading) {
    return <div className="flex justify-center items-center min-h-screen"><Spin size="large" /></div>;
  }

  if (error) {
    return <div className="p-8"><Alert message="Error" description={error} type="error" showIcon /></div>;
  }

  return (
    <div className="p-4 sm:p-6 lg:p-8 bg-gray-900 min-h-screen text-white">
      <h1 className="text-2xl sm:text-3xl font-bold text-white mb-6">Manage Flash Sales</h1>

      <Card title={<span className="text-lg font-semibold text-white">Set Product for Flash Sale</span>} bordered={false} className="shadow-sm mb-8 bg-gray-800" headStyle={{background:'#1f2937', border:'none'}} bodyStyle={{background:'#1f2937'}}>
        <Space direction="vertical" size="middle" style={{ width: '100%' }}>
          <Text strong className="text-white">Select Product:</Text>
          <AutoComplete
            value={searchText}
            onSearch={handleSearchProduct}
            onSelect={handleSelectProduct}
            options={searchedProductsOptions}
            style={{ width: '100%' }}
            placeholder="Search product by name..."
          >
            <Input prefix={<SearchOutlined />} />
          </AutoComplete>

          {selectedProductToAdd && (
            <Text type="secondary" className="text-gray-300">Selected: {selectedProductToAdd.name}</Text>
          )}

          <Text strong className="text-white">Flash Sale Price:</Text>
          <InputNumber
            className="w-full"
            value={newFlashSalePrice}
            onChange={setNewFlashSalePrice}
            formatter={value => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',') + 'Ä‘'}
            parser={value => value.replace(/\s?Ä‘|(,*)/g, '')}
            min={0}
          />
          <Space wrap>
            {priceOptions.map(price => (
              <Button key={price} onClick={() => setNewFlashSalePrice(price)}>
                {price.toLocaleString('vi-VN')}Ä‘
              </Button>
            ))}
          </Space>

          <Text strong className="text-white">Start Date/Time:</Text>
          <DatePicker
            showTime
            format="YYYY-MM-DD HH:mm:ss"
            value={newFlashSaleStartDate}
            onChange={setNewFlashSaleStartDate}
            style={{ width: '100%' }}
          />

          <Text strong className="text-white">End Date/Time:</Text>
          <DatePicker
            showTime
            format="YYYY-MM-DD HH:mm:ss"
            value={newFlashSaleEndDate}
            onChange={setNewFlashSaleEndDate}
            style={{ width: '100%' }}
          />

          <Button
            type="primary"
            icon={<SaveOutlined />}
            onClick={handleSetFlashSale}
            size="large"
            style={{ width: '100%' }}
          >
            Set Flash Sale
          </Button>
        </Space>
      </Card>

      <Card title={<span className="text-lg font-semibold text-white">Current Flash Sale Products</span>} bordered={false} className="shadow-sm bg-gray-800" headStyle={{background:'#1f2937', border:'none'}} bodyStyle={{background:'#1f2937'}}>
        <Table
          columns={columns}
          dataSource={flashSaleProducts}
          rowKey="id"
          loading={loading}
          pagination={{ pageSize: 10 }}
          bordered
        />
      </Card>
    </div>
  );
};

export default FlashSaleAdminPage;

```

### ClientApp\src\pages\Admin\HomepageAdminPage.js
```js
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { DragDropContext, Droppable, Draggable } from 'react-beautiful-dnd';
import { motion } from 'framer-motion';
import Header from "@/components/Admin/common/Header";

  import {
  Box,
  Button,
  Switch,
  TextField,
  Typography,
  Grid,
  Card,
  CardContent,
  CircularProgress,
  Alert,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Snackbar,
  List,
  ListItem,
  ListItemText,
  ListItemIcon,
  IconButton,
  InputAdornment,
  Collapse,
  FormControlLabel,
} from '@mui/material';

import {
  DragHandle as DragHandleIcon,
  Visibility as EyeIcon,
  Save as SaveIcon,
  Add as AddIcon,
  Delete as DeleteIcon,
} from '@mui/icons-material';

// Import preview components
import HeroBanner from '@/components/HeroBanner/HeroBanner';
import FeaturedCategories from '@/components/FeaturedCategories/FeaturedCategories';
import BestSellerSection from '@/components/BestSellers/BestSellers';
import FlashSale from '@/components/FlashSale/FlashSale';
import Commitment from '@/components/Commitment/Commitment';
import BannerSlider from '@/components/Homepage/BannerSlider';
import BestSellerManager from '@/components/BestSellerManager/BestSellerManager';

// Custom component for section editing (will be refactored in next step)
const SectionEditor = ({ sectionName, sectionData, onContentChange }) => {
  const [formData, setFormData] = useState(sectionData);

  useEffect(() => {
    setFormData(sectionData);
  }, [sectionData]);

  const handleInputChange = (e) => {
    const { name, value, type, checked } = e.target;
    const newValue = type === 'checkbox' ? checked : value;
    setFormData(prev => ({
      ...prev,
      [name]: newValue
    }));
    onContentChange(sectionName, name, newValue);
  };

  const renderFormItems = () => {
    const inputProps = {
      style: { color: '#e2e8f0' },
      sx: { '& fieldset': { borderColor: '#4a5568' }, '&:hover fieldset': { borderColor: '#63b3ed' }, '&.Mui-focused fieldset': { borderColor: '#63b3ed' } }
    };
    const inputLabelProps = { style: { color: '#a0aec0' } };

    switch (sectionName) {
      case 'hero':
        return (
          <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
            <TextField label="Headline" name="headline" value={formData.headline || ''} onChange={handleInputChange} fullWidth InputProps={inputProps} InputLabelProps={inputLabelProps} />
            <TextField label="Slogan" name="slogan" value={formData.slogan || ''} onChange={handleInputChange} fullWidth InputProps={inputProps} InputLabelProps={inputLabelProps} />
            <TextField label="CTA Text" name="cta_text" value={formData.cta_text || ''} onChange={handleInputChange} fullWidth InputProps={inputProps} InputLabelProps={inputLabelProps} />
            <TextField label="CTA Link" name="cta_link" value={formData.cta_link || ''} onChange={handleInputChange} fullWidth InputProps={inputProps} InputLabelProps={inputLabelProps} />
          </Box>
        );
      case 'featured_products':
      case 'best_seller':
        return <BestSellerManager sectionData={sectionData} onContentChange={onContentChange} />;
      case 'special_offer':
        const priceOptions = [100000, 500000, 1000000, 2000000];
        return (
          <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
            <TextField label="Headline" name="headline" value={formData.headline || ''} onChange={handleInputChange} fullWidth InputProps={inputProps} InputLabelProps={inputLabelProps} />
            <TextField label="Sub Text" name="sub_text" value={formData.sub_text || ''} onChange={handleInputChange} fullWidth InputProps={inputProps} InputLabelProps={inputLabelProps} />
            <TextField label="CTA Text" name="cta_text" value={formData.cta_text || ''} onChange={handleInputChange} fullWidth InputProps={inputProps} InputLabelProps={inputLabelProps} />
            <TextField label="CTA Link" name="cta_link" value={formData.cta_link || ''} onChange={handleInputChange} fullWidth InputProps={inputProps} InputLabelProps={inputLabelProps} />
            <TextField label="Image URL" name="image_url" value={formData.image_url || ''} onChange={handleInputChange} fullWidth InputProps={inputProps} InputLabelProps={inputLabelProps} />
            <TextField
              label="Original Price"
              name="originalPrice"
              value={formData.originalPrice || ''}
              onChange={handleInputChange}
              fullWidth
              type="number"
              InputProps={{
                startAdornment: <InputAdornment position="start" sx={{ color: '#a0aec0' }}>VNÄ</InputAdornment>,
                ...inputProps
              }}
              InputLabelProps={inputLabelProps}
            />
            <Box sx={{ display: 'flex', gap: 1, flexWrap: 'wrap' }}>
              {priceOptions.map(price => (
                <Button key={price} variant="outlined" onClick={() => onContentChange(sectionName, 'originalPrice', price)} sx={{ borderColor: '#63b3ed', color: '#63b3ed' }}>
                  {price.toLocaleString('vi-VN')}Ä‘
                </Button>
              ))}
            </Box>
            <TextField
              label="Discount Price"
              name="discountPrice"
              value={formData.discountPrice || ''}
              onChange={handleInputChange}
              fullWidth
              type="number"
              InputProps={{
                startAdornment: <InputAdornment position="start" sx={{ color: '#a0aec0' }}>VNÄ</InputAdornment>,
                ...inputProps
              }}
              InputLabelProps={inputLabelProps}
            />
            <Box sx={{ display: 'flex', gap: 1, flexWrap: 'wrap' }}>
              {priceOptions.map(price => (
                <Button key={price} variant="outlined" onClick={() => onContentChange(sectionName, 'discountPrice', price)} sx={{ borderColor: '#63b3ed', color: '#63b3ed' }}>
                  {price.toLocaleString('vi-VN')}Ä‘
                </Button>
              ))}
            </Box>
            <TextField label="Countdown End Date" name="countdown_end_date" value={formData.countdown_end_date || ''} onChange={handleInputChange} fullWidth helperText="Format: YYYY-MM-DDTHH:MM:SS" InputProps={inputProps} InputLabelProps={inputLabelProps} FormHelperTextProps={{ style: { color: '#a0aec0' } }} />
            <FormControlLabel
              control={<Switch checked={formData.countdown_enabled || false} onChange={handleInputChange} name="countdown_enabled" />}
              label="Countdown Enabled"
              sx={{ color: '#e2e8f0' }}
            />
          </Box>
        );
      case 'brand_trust':
        return (
          <Box>
            <Typography variant="h6" sx={{ mb: 2, color: '#e2e8f0' }}>Commitments</Typography>
            <List>
              {formData.commitments?.map((commitment, index) => (
                <ListItem key={index} secondaryAction={
                  <IconButton edge="end" aria-label="delete" onClick={() => {
                    const newCommitments = formData.commitments.filter((_, i) => i !== index);
                    onContentChange(sectionName, 'commitments', newCommitments);
                  }} sx={{ color: '#e2e8f0' }}>
                    <DeleteIcon />
                  </IconButton>
                }>
                  <TextField
                    label="Commitment Title"
                    value={commitment.title || ''}
                    onChange={(e) => {
                      const newCommitments = [...formData.commitments];
                      newCommitments[index].title = e.target.value;
                      onContentChange(sectionName, 'commitments', newCommitments);
                    }}
                    fullWidth
                    InputProps={inputProps}
                    InputLabelProps={inputLabelProps}
                  />
                </ListItem>
              ))}
            </List>
            <Button startIcon={<AddIcon />} onClick={() => {
              const newCommitments = [...(formData.commitments || []), { title: '' }];
              onContentChange(sectionName, 'commitments', newCommitments);
            }} sx={{ color: '#63b3ed', borderColor: '#63b3ed' }}>Add Commitment</Button>
          </Box>
        );
      default:
        return <Typography variant="body2" color="text.secondary">No editor available for this section.</Typography>;
    }
  };

  return (
    <Box sx={{ p: 2 }}>
      {renderFormItems()}
    </Box>
  );
};

const HomepageAdminPage = () => {
  const [config, setConfig] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [previewSection, setPreviewSection] = useState(null);
  const [isPreviewOpen, setIsPreviewOpen] = useState(false);
  const [snackbarOpen, setSnackbarOpen] = useState(false);
  const [snackbarMessage, setSnackbarMessage] = useState('');
  const [snackbarSeverity, setSnackbarSeverity] = useState('success');

  useEffect(() => {
    const fetchConfig = async () => {
      try {
        const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/homepage-config`);
        setConfig(response.data);
      } catch (err) {
        setError('Failed to load homepage configuration.');
        console.error(err);
      } finally {
        setLoading(false);
      }
    };
    fetchConfig();
  }, []);

  const handleSave = async () => {
    try {
      await axios.put(`${process.env.REACT_APP_API_BASE_URL}/api/homepage-config`, config);
      setSnackbarMessage('Homepage configuration saved successfully!');
      setSnackbarSeverity('success');
      setSnackbarOpen(true);
    } catch (err) {
      setSnackbarMessage('Failed to save homepage configuration.');
      setSnackbarSeverity('error');
      setSnackbarOpen(true);
      console.error(err);
    }
  };

  const handleToggleSection = (sectionName) => {
    setConfig(prevConfig => ({
      ...prevConfig,
      components: {
        ...prevConfig.components,
        [sectionName]: {
          ...prevConfig.components[sectionName],
          enabled: !prevConfig.components[sectionName].enabled,
        },
      },
    }));
  };

  const handleContentChange = (sectionName, field, value) => {
    setConfig(prevConfig => {
      const newConfig = { ...prevConfig };
      if (field) {
        newConfig.components[sectionName] = {
          ...newConfig.components[sectionName],
          [field]: value
        };
      } else {
        // This case is for when a whole object is passed (e.g., from BestSellerManager)
        newConfig.components[sectionName] = { ...newConfig.components[sectionName], ...value };
      }
      return newConfig;
    });
  };

  const handleDragEnd = (result) => {
    if (!result.destination) return;
    const newLayout = Array.from(config.layout);
    const [removed] = newLayout.splice(result.source.index, 1);
    newLayout.splice(result.destination.index, 0, removed);
    setConfig(prevConfig => ({
      ...prevConfig,
      layout: newLayout
    }));
  };

  const handlePreview = (sectionName) => {
    setPreviewSection(sectionName);
    setIsPreviewOpen(true);
  };

  const closePreview = () => {
    setIsPreviewOpen(false);
    setPreviewSection(null);
  };

  if (loading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh', bgcolor: '#1a202c' }}>
        <CircularProgress size={60} sx={{ color: '#63b3ed' }} />
      </Box>
    );
  }

  if (error) {
    return (
      <Alert severity="error" sx={{ m: 2, bgcolor: '#2d3748', color: '#e2e8f0', '& .MuiAlert-icon': { color: '#f56565' } }}>
        {error}
      </Alert>
    );
  }

  if (!config) {
    return (
      <Alert severity="warning" sx={{ m: 2, bgcolor: '#2d3748', color: '#e2e8f0', '& .MuiAlert-icon': { color: '#ecc94b' } }}>
        No configuration found.
      </Alert>
    );
  }

  const componentMap = {
    hero: HeroBanner,
    categories: FeaturedCategories,
    featured_products: BestSellerSection,
    special_offer: FlashSale,
    best_seller: BestSellerSection,
    brand_trust: Commitment,
    banner_slider: BannerSlider,
  };

  return (
    <Box sx={{ flexGrow: 1, bgcolor: '#1a202c', minHeight: '100vh', color: '#e2e8f0' }}>
      <Header title="Quáº£n lÃ½ Trang chá»§" />

      <Box component="main" sx={{ maxWidth: '7xl', mx: 'auto', py: 6, px: { xs: 2, lg: 8 } }}>
        <motion.div
          className="flex justify-between items-center mb-6"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5 }}
        >
          <Typography variant="h5" component="h1" sx={{ fontWeight: 'bold', color: '#e2e8f0' }}>
            Cáº¥u hÃ¬nh Trang chá»§
          </Typography>
          <Button variant="contained" startIcon={<SaveIcon />} onClick={handleSave}>
            LÆ°u cáº¥u hÃ¬nh
          </Button>
        </motion.div>

        <Grid container spacing={3}>
          <Grid item xs={12} lg={4}>
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5, delay: 0.1 }}
            >
              <Card elevation={0} sx={{ borderRadius: 2, bgcolor: '#2d3748', color: '#e2e8f0' }}>
                <CardContent>
                  <Typography variant="h6" sx={{ mb: 2, fontWeight: 'bold' }}>Thá»© tá»± & Hiá»ƒn thá»‹ Bá»‘ cá»¥c</Typography>
                  <DragDropContext onDragEnd={handleDragEnd}>
                    <Droppable droppableId="layout-order">
                      {(provided) => (
                        <List {...provided.droppableProps} ref={provided.innerRef}>
                          {config.layout.map((sectionName, index) => (
                            <Draggable key={sectionName} draggableId={sectionName} index={index}>
                              {(provided, snapshot) => (
                                <ListItem
                                  ref={provided.innerRef}
                                  {...provided.draggableProps}
                                  {...provided.dragHandleProps}
                                  sx={{
                                    mb: 1,
                                    bgcolor: '#4a5568',
                                    borderRadius: 1,
                                    boxShadow: 1,
                                    border: snapshot.isDragging ? '1px solid #63b3ed' : '1px solid transparent',
                                    transition: 'border 0.2s',
                                  }}
                                  secondaryAction={
                                    <Switch
                                      edge="end"
                                      checked={config.components[sectionName]?.enabled || false}
                                      onChange={() => handleToggleSection(sectionName)}
                                      size="small"
                                    />
                                  }
                                >
                                  <ListItemIcon sx={{ minWidth: 30 }}>
                                    <DragHandleIcon sx={{ color: '#e2e8f0' }} />
                                  </ListItemIcon>
                                  <ListItemText primary={sectionName.replace(/_/g, ' ')} sx={{ textTransform: 'capitalize', color: '#e2e8f0' }} />
                                </ListItem>
                              )}
                            </Draggable>
                          ))}
                          {provided.placeholder}
                        </List>
                      )}
                    </Droppable>
                  </DragDropContext>
                </CardContent>
              </Card>
            </motion.div>
          </Grid>

          <Grid item xs={12} lg={8}>
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5, delay: 0.2 }}
            >
              <Card elevation={0} sx={{ borderRadius: 2, bgcolor: '#2d3748', color: '#e2e8f0' }}>
                <CardContent>
                  <Typography variant="h6" sx={{ mb: 2, fontWeight: 'bold' }}>Ná»™i dung Pháº§n</Typography>
                  <Box>
                    {Object.entries(config.components).map(([sectionName, sectionData]) => (
                      <Collapse key={sectionName} in={true} timeout="auto" unmountOnExit>
                        <Card variant="outlined" sx={{ mb: 2, borderRadius: 1, borderColor: '#4a5568', bgcolor: '#1a202c' }}>
                          <CardContent>
                            <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 2 }}>
                              <Typography variant="subtitle1" sx={{ fontWeight: 'bold', textTransform: 'capitalize', color: '#e2e8f0' }}>
                                {sectionName.replace(/_/g, ' ')}
                              </Typography>
                              <Box>
                                <Button
                                  size="small"
                                  startIcon={<EyeIcon />}
                                  onClick={() => handlePreview(sectionName)}
                                  sx={{ mr: 1, color: '#63b3ed' }}
                                >
                                  Xem trÆ°á»›c
                                </Button>
                                <Switch
                                  checked={sectionData?.enabled || false}
                                  onChange={() => handleToggleSection(sectionName)}
                                  size="small"
                                />
                              </Box>
                            </Box>
                            <SectionEditor
                              sectionName={sectionName}
                              sectionData={sectionData}
                              onContentChange={handleContentChange}
                            />
                          </CardContent>
                        </Card>
                      </Collapse>
                    ))}
                  </Box>
                </CardContent>
              </Card>
            </motion.div>
          </Grid>
        </Grid>

        <Dialog open={isPreviewOpen} onClose={closePreview} maxWidth="md" fullWidth PaperProps={{ sx: { bgcolor: '#2d3748', color: '#e2e8f0' } }}>
          <DialogTitle sx={{ bgcolor: '#1a202c', color: '#e2e8f0' }}>Xem trÆ°á»›c: {previewSection?.replace(/_/g, ' ')}</DialogTitle>
          <DialogContent dividers sx={{ borderColor: '#4a5568' }}>
            {previewSection && componentMap[previewSection] ? (
              React.createElement(componentMap[previewSection], { data: config.components[previewSection] })
            ) : (
              <Typography variant="body1" color="text.secondary">KhÃ´ng cÃ³ báº£n xem trÆ°á»›c cho pháº§n nÃ y.</Typography>
            )}
          </DialogContent>
          <DialogActions sx={{ bgcolor: '#1a202c' }}>
            <Button onClick={closePreview} sx={{ color: '#63b3ed' }}>ÄÃ³ng</Button>
          </DialogActions>
        </Dialog>

        <Snackbar
          open={snackbarOpen}
          autoHideDuration={4000}
          onClose={() => setSnackbarOpen(false)}
          anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}
        >
          <Alert onClose={() => setSnackbarOpen(false)} severity={snackbarSeverity} sx={{ width: '100%', bgcolor: '#2d3748', color: '#e2e8f0', '& .MuiAlert-icon': { color: snackbarSeverity === 'success' ? '#48bb78' : '#f56565' } }}>
            {snackbarMessage}
          </Alert>
        </Snackbar>
      </Box>
    </Box>
  );
};

export default HomepageAdminPage;

```

### ClientApp\src\pages\Admin\HomepageOverviewPage.js
```js
import { Visibility, VisibilityOff } from '@mui/icons-material';
import { Zap, LayoutDashboard, Tags, ImageIcon } from 'lucide-react';
import React, { useState, useEffect } from "react";
import { Link as RouterLink } from "react-router-dom";
import { motion } from "framer-motion";
import Header from "@/components/Admin/common/Header";
import axios from "axios";

import {
  Box,
  Typography,
  Grid,
  Card,
  CardContent,
  Link as MuiLink,
  CircularProgress,
  Alert,
  List,
  ListItem,
  ListItemText,
  Chip,
} from "@mui/material";

const HomepageOverviewPage = () => {
  const [config, setConfig] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchConfig = async () => {
      try {
        const response = await axios.get(
          `${process.env.REACT_APP_API_BASE_URL}/api/homepage-config`
        );
        setConfig(response.data);
      } catch (err) {
        setError("Failed to load homepage configuration.");
        console.error(err);
      } finally {
        setLoading(false);
      }
    };
    fetchConfig();
  }, []);

  if (loading) {
    return (
      <Box
        sx={{
          display: "flex",
          justifyContent: "center",
          alignItems: "center",
          height: "100vh",
          bgcolor: '#1a202c',
        }}
      >
        <CircularProgress sx={{ color: '#63b3ed' }} />
      </Box>
    );
  }

  if (error) {
    return (
      <Alert severity="error" sx={{ m: 2, bgcolor: '#2d3748', color: '#e2e8f0', '& .MuiAlert-icon': { color: '#f56565' } }}>
        {error}
      </Alert>
    );
  }

  if (!config) {
    return (
      <Alert severity="warning" sx={{ m: 2, bgcolor: '#2d3748', color: '#e2e8f0', '& .MuiAlert-icon': { color: '#ecc94b' } }}>
        No homepage configuration found.
      </Alert>
    );
  }

  const totalSections = Object.keys(config.components).length;
  const enabledSections = Object.values(config.components).filter(
    (comp) => comp.enabled
  ).length;
  const disabledSections = totalSections - enabledSections;

  const managementLinks = [
    {
      title: "Bá»‘ cá»¥c & Ná»™i dung Trang chá»§",
      description: "Quáº£n lÃ½ thá»© tá»± vÃ  ná»™i dung cá»§a cÃ¡c pháº§n chÃ­nh trÃªn trang chá»§.",
      icon: LayoutDashboard,
      href: "/admin/homepage",
      color: "#6366F1",
    },
    {
      title: "Danh má»¥c Sáº£n pháº©m",
      description: "ThÃªm, chá»‰nh sá»­a, xÃ³a vÃ  kÃ­ch hoáº¡t/há»§y kÃ­ch hoáº¡t danh má»¥c sáº£n pháº©m.",
      icon: Tags,
      href: "/admin/categories",
      color: "#8B5CF6",
    },
    {
      title: "Sáº£n pháº©m Flash Sale",
      description: "Äáº·t vÃ  xÃ³a giÃ¡ flash sale cÅ©ng nhÆ° thá»i lÆ°á»£ng cho sáº£n pháº©m.",
      icon: Zap,
      href: "/admin/flash-sale",
      color: "#EC4899",
    },
    {
      title: "Banner Trang chá»§",
      description: "Quáº£n lÃ½ cÃ¡c banner hÃ¬nh áº£nh cho thanh trÆ°á»£t trang chá»§.",
      icon: ImageIcon,
      href: "/admin/banners",
      color: "#10B981",
    },
  ];

  return (
    <Box sx={{ flexGrow: 1, bgcolor: '#1a202c', minHeight: '100vh', color: '#e2e8f0' }}>
      <Header title="Tá»•ng quan Trang chá»§" />

      <Box component="main" sx={{ maxWidth: '7xl', mx: 'auto', py: 6, px: { xs: 2, lg: 8 } }}>
        {/* Overview Stats */}
        <motion.div
          className="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-3 mb-8"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5 }}
        >
          <Grid item xs={12} md={4}>
            <Card elevation={0} sx={{ borderRadius: 2, bgcolor: '#2d3748' }}>
              <CardContent>
                <Typography variant="h6" color="primary" sx={{ fontWeight: "bold" }}>
                  Tá»•ng sá»‘ pháº§n
                </Typography>
                <Typography variant="h3" sx={{ fontWeight: "bold", color: "#63b3ed" }}>
                  {totalSections}
                </Typography>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} md={4}>
            <Card elevation={0} sx={{ borderRadius: 2, bgcolor: '#2d3748' }}>
              <CardContent>
                <Typography variant="h6" color="success" sx={{ fontWeight: "bold" }}>
                  Pháº§n Ä‘ang hoáº¡t Ä‘á»™ng
                </Typography>
                <Typography variant="h3" sx={{ fontWeight: "bold", color: "#48bb78" }}>
                  {enabledSections}
                </Typography>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} md={4}>
            <Card elevation={0} sx={{ borderRadius: 2, bgcolor: '#2d3748' }}>
              <CardContent>
                <Typography variant="h6" color="error" sx={{ fontWeight: "bold" }}>
                  Pháº§n Ä‘Ã£ táº¯t
                </Typography>
                <Typography variant="h3" sx={{ fontWeight: "bold", color: "#f56565" }}>
                  {disabledSections}
                </Typography>
              </CardContent>
            </Card>
          </Grid>
        </motion.div>

        {/* Section Status List */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5, delay: 0.2 }}
        >
          <Card elevation={0} sx={{ borderRadius: 2, mb: 4, bgcolor: '#2d3748' }}>
            <CardContent>
              <Typography variant="h6" sx={{ mb: 2, fontWeight: "bold", color: '#e2e8f0' }}>
                Tráº¡ng thÃ¡i cÃ¡c pháº§n trang chá»§
              </Typography>
              <List>
                {config.layout.map((sectionName) => (
                  <ListItem
                    key={sectionName}
                    secondaryAction={
                      <Chip
                        label={config.components[sectionName]?.enabled ? "Äang hoáº¡t Ä‘á»™ng" : "ÄÃ£ táº¯t"}
                        color={config.components[sectionName]?.enabled ? "success" : "error"}
                        icon={config.components[sectionName]?.enabled ? <Visibility /> : <VisibilityOff />}
                      />
                    }
                  >
                    <ListItemText
                      primary={
                        <Typography variant="body1" sx={{ textTransform: "capitalize", color: '#e2e8f0' }}>
                          {sectionName.replace(/_/g, " ")}
                        </Typography>
                      }
                    />
                  </ListItem>
                ))}
              </List>
            </CardContent>
          </Card>
        </motion.div>

        {/* Management Links */}
        <motion.div
          className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5, delay: 0.4 }}
        >
          {managementLinks.map((item, index) => (
            <Grid item xs={12} sm={6} md={4} key={index}>
              <MuiLink
                component={RouterLink}
                to={item.href}
                sx={{
                  textDecoration: "none",
                  "&:hover": { textDecoration: "none" },
                }}
              >
                <Card
                  elevation={0}
                  sx={{
                    borderRadius: 2,
                    height: "100%",
                    display: "flex",
                    flexDirection: "column",
                    justifyContent: "space-between",
                    transition: "all 0.3s ease-in-out",
                    bgcolor: '#2d3748',
                    "&:hover": {
                      transform: "translateY(-5px)",
                      boxShadow: 6,
                    },
                  }}
                >
                  <CardContent>
                    <Box
                      sx={{
                        display: "flex",
                        alignItems: "center",
                        mb: 2,
                        color: item.color,
                      }}
                    >
                      {React.createElement(item.icon, { size: 30, style: { marginRight: "12px" } })}
                      <Typography variant="h6" component="h2" sx={{ fontWeight: "bold", color: '#e2e8f0' }}>
                        {item.title}
                      </Typography>
                    </Box>
                    <Typography variant="body2" color="text.secondary">
                      {item.description}
                    </Typography>
                  </CardContent>
                </Card>
              </MuiLink>
            </Grid>
          ))}
        </motion.div>
      </Box>
    </Box>
  );
};

export default HomepageOverviewPage;

```

### ClientApp\src\pages\Admin\OrdersPage.jsx
```jsx
import { useState, useEffect } from "react";
import { CheckCircle, Clock, DollarSign, ShoppingBag } from "lucide-react";
import { motion } from "framer-motion";
import axios from "axios";

import Header from "@/components/Admin/common/Header";
import StatCard from "@/components/Admin/common/StatCard";
// import DailyOrders from "@/components/Admin/orders/DailyOrders";
// import OrderDistribution from "@/components/Admin/orders/OrderDistribution";
import OrdersTable from "@/components/Admin/orders/OrdersTable";

const OrdersPage = () => {
  const [orderStats, setOrderStats] = useState({
    totalOrders: 0,
    pendingOrders: 0,
    completedOrders: 0,
    totalRevenue: 0,
  });

  useEffect(() => {
    const fetchOrderStats = async () => {
      try {
        const [
          totalOrdersRes,
          pendingOrdersRes,
          completedOrdersRes,
          totalRevenueRes,
        ] = await Promise.all([
          axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/orders`),
          axios.get(
            `${process.env.REACT_APP_API_BASE_URL}/api/orders/pending-orders`
          ),
          axios.get(
            `${process.env.REACT_APP_API_BASE_URL}/api/orders/completed-orders`
          ),
          axios.get(
            `${process.env.REACT_APP_API_BASE_URL}/api/orders/total-revenue`
          ),
        ]);

        setOrderStats({
          totalOrders: totalOrdersRes.data.length,
          pendingOrders: pendingOrdersRes.data.pendingOrders,
          completedOrders: completedOrdersRes.data.completedOrders,
          totalRevenue: totalRevenueRes.data.totalRevenue,
        });
      } catch (error) {
        console.error("Lá»—i khi láº¥y dá»¯ liá»‡u thá»‘ng kÃª Ä‘Æ¡n hÃ ng:", error);
      }
    };

    fetchOrderStats();
  }, []);

  return (
    <div className="flex-1 relative z-10 overflow-auto">
      <Header title={"ÄÆ¡n HÃ ng"} />

      <main className="max-w-7xl mx-auto py-6 px-4 lg:px-8">
        <motion.div
          className="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 1 }}
        >
          <StatCard
            name="Tá»•ng Ä‘Æ¡n hÃ ng"
            icon={ShoppingBag}
            value={orderStats.totalOrders}
            color="#6366F1"
          />
          <StatCard
            name="ÄÆ¡n chá» xÃ¡c nháº­n"
            icon={Clock}
            value={orderStats.pendingOrders}
            color="#F59E0B"
          />
          <StatCard
            name="ÄÆ¡n hÃ ng Ä‘Ã£ hoÃ n thÃ nh"
            icon={CheckCircle}
            value={orderStats.completedOrders}
            color="#10B981"
          />
          <StatCard
            name="Tá»•ng tiá»n dá»± tÃ­nh"
            icon={DollarSign}
            value={orderStats.totalRevenue + " VND"}
            color="#EF4444"
          />
        </motion.div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8"></div>

        <OrdersTable />
      </main>
    </div>
  );
};

export default OrdersPage;

```

### ClientApp\src\pages\Admin\OverviewPage.jsx
```jsx
import { BarChart2, ShoppingBag, Users, Zap } from "lucide-react";
import { motion } from "framer-motion";
import { useEffect, useState } from "react";
import useSWR from "swr";

import Header from "@/components/Admin/common/Header";
import StatCard from "@/components/Admin/common/StatCard";
import SalesOverviewChart from "@/components/Admin/overview/SalesOverviewChart";
import CategoryDistributionChart from "@/components/Admin/overview/CategoryDistributionChart";
import { formatCurrency } from "@/utils/formatCurrency";

const fetcher = (url) => fetch(url).then((res) => res.json());

const OverviewPage = () => {
  // Fetch data tá»« API
  const { data: statsData, error: statsError } = useSWR(
    `${process.env.REACT_APP_API_BASE_URL}/api/orders/stats`,
    fetcher
  );
  const { data: revenueData, error: revenueError } = useSWR(
    `${process.env.REACT_APP_API_BASE_URL}/api/orders/revenue`,
    fetcher
  );

  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (statsData || revenueData || statsError || revenueError) {
      setLoading(false);
    }
  }, [statsData, revenueData, statsError, revenueError]);

  if (loading) {
    return <div>Loading...</div>;
  }

  if (statsError || revenueError) {
    return <div>Error loading data</div>;
  }

  return (
    <div className="flex-1 overflow-auto relative z-10">
      <Header title="Tá»•ng quan" />

      <main className="max-w-7xl mx-auto py-6 px-4 lg:px-8">
        {/* STATS */}
        <motion.div
          className="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 1 }}
        >
          <StatCard
            name="Tá»•ng doanh thu"
            icon={Zap}
            value={formatCurrency(statsData?.totalRevenue || 0)}
            color="#6366F1"
          />
          <StatCard
            name="ÄÆ¡n hÃ ng hoÃ n thÃ nh"
            icon={Users}
            value={statsData?.completedOrders || 0}
            color="#8B5CF6"
          />
          <StatCard
            name="ÄÆ¡n hÃ ng chá» xá»­ lÃ½"
            icon={ShoppingBag}
            value={statsData?.pendingOrders || 0}
            color="#EC4899"
          />
          <StatCard
            name="Tá»•ng sá»‘ Ä‘Æ¡n hÃ ng"
            icon={BarChart2}
            value={statsData?.totalOrders || 0}
            color="#10B981"
          />
        </motion.div>

        {/* CHARTS */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <SalesOverviewChart data={revenueData} />
          <CategoryDistributionChart />
        </div>
      </main>
    </div>
  );
};

export default OverviewPage;

```

### ClientApp\src\pages\Admin\ProductsPage.jsx
```jsx
import { useEffect, useState, useCallback } from "react";
import { motion } from "framer-motion";
import axios from "axios";

import Header from "../../components/Admin/common/Header";
import StatCard from "../../components/Admin/common/StatCard";
// import CardProduct from "../../components/Admin/common/CardProduct";

import { AlertTriangle, DollarSign, Package, TrendingUp } from "lucide-react";
import CategoryDistributionChart from "../../components/Admin/overview/CategoryDistributionChart";
import SalesTrendChart from "../../components/Admin/products/SalesTrendChart";
import ProductsTable from "../../components/Admin/products/ProductsTable";

const ProductsPage = () => {
	const [totalProducts, setTotalProducts] = useState(0);
	const [lowStockProducts, setLowStockProducts] = useState(0);
	const [topSelling, setTopSelling] = useState(0);


	// HÃ m fetch thá»‘ng kÃª sáº£n pháº©m
	const fetchStats = useCallback(async () => {
		try {
			const [lowStockRes, totalProductsRes] = await Promise.all([
				axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/Products/low-stock`),
				axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/Products/count`)			]);

			setLowStockProducts(lowStockRes.data);
			setTotalProducts(totalProductsRes.data);
		} catch (error) {
			console.error("Lá»—i khi láº¥y dá»¯ liá»‡u sáº£n pháº©m:", error);
		}
	}, []);
	// Gá»i API khi component mount vÃ  khi filterType thay Ä‘á»•i
	useEffect(() => {
		fetchStats();
	}, [fetchStats]);

	return (
		<div className='flex-1 overflow-auto relative z-10'>
			<Header title='Sáº£n Pháº©m' />

			<main className='max-w-7xl mx-auto py-6 px-4 lg:px-8'>
				{/* STATS */}
				<motion.div
					className='grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8'
					initial={{ opacity: 0, y: 20 }}
					animate={{ opacity: 1, y: 0 }}
					transition={{ duration: 1 }}
				>
					<StatCard name='Tá»•ng sáº£n pháº©m' icon={Package} value={totalProducts} color='#6366F1' />
					<StatCard
						name="BÃ¡n cháº¡y"
						icon={TrendingUp}
						value={topSelling}
						color="#10B981"
					/>
					<StatCard name='Gáº§n háº¿t hÃ ng' icon={AlertTriangle} value={lowStockProducts} color='#F59E0B' />
					<StatCard name='Tá»•ng thu' icon={DollarSign} value={"145002000VND"} color='#EF4444' />
				</motion.div>

				<ProductsTable />

				{/* CHARTS */}
				<div className='grid grid-col-1 lg:grid-cols-2 gap-8'>
					<SalesTrendChart />
					<CategoryDistributionChart />
				</div>
			</main>
		</div>
	);
};

export default ProductsPage;

```

### ClientApp\src\pages\Admin\ReviewManagementPage.jsx
```jsx
import React, { useState, useEffect } from "react";
import { motion } from "framer-motion";
import Header from "@/components/Admin/common/Header";
import { 
  Box, 
  Typography, 
  CircularProgress, 
  Alert, 
  Paper, 
  Table, 
  TableBody, 
  TableCell, 
  TableContainer, 
  TableHead, 
  TableRow, 
  Button, 
  Chip, 
  Rating, 
  Grid, 
  Card, 
  CardContent,
  Snackbar,
  LinearProgress,
  TextField, // Added for filter inputs
  FormControl, // Added for select/checkbox filters
  InputLabel, // Added for select labels
  Select, // Added for dropdown filters
  MenuItem, // Added for select options
  FormGroup, // Added for checkbox group
  FormControlLabel, // Added for checkbox labels
  Checkbox // Added for boolean filters
} from "@mui/material";
import { 
  CheckCircleOutline, 
  HighlightOff, 
  Star, 
  RateReview, 
  PendingActions, 
  DoneAll,
  FilterList // Added for filter icon
} from "@mui/icons-material";
import { 
  useAllReviews, 
  useReviewAnalytics, 
  useReviewModeration 
} from "@/hooks/api/useReviews";

const ReviewManagementPage = () => {
  // Filter states
  const [filters, setFilters] = useState({
    isApproved: null,
    minRating: null,
    maxRating: null,
    productId: null,
    userId: null,
    searchComment: "",
  });

  const { allReviews, loading: reviewsLoading, error: reviewsError, refetchAllReviews } = useAllReviews(filters);
  const { analytics, loading: analyticsLoading, error: analyticsError, refetchAnalytics } = useReviewAnalytics();
  const { approveReview, rejectReview, loading: moderationLoading } = useReviewModeration();
  const [snackbar, setSnackbar] = useState({ open: false, message: "", severity: "success" });

  const handleFilterChange = (event) => {
    const { name, value, type, checked } = event.target;
    setFilters(prevFilters => ({
      ...prevFilters,
      [name]: type === 'checkbox' ? (checked ? true : false) : value === '' ? null : value,
    }));
  };

  const handleApprove = async (reviewId) => {
    const success = await approveReview(reviewId);
    if (success) {
      setSnackbar({ open: true, message: "ÄÃ¡nh giÃ¡ Ä‘Ã£ Ä‘Æ°á»£c duyá»‡t!", severity: "success" });
      refetchAllReviews();
      refetchAnalytics();
    } else {
      setSnackbar({ open: true, message: "Duyá»‡t Ä‘Ã¡nh giÃ¡ tháº¥t báº¡i.", severity: "error" });
    }
  };

  const handleReject = async (reviewId) => {
    const success = await rejectReview(reviewId);
    if (success) {
      setSnackbar({ open: true, message: "ÄÃ¡nh giÃ¡ Ä‘Ã£ bá»‹ tá»« chá»‘i!", severity: "success" });
      refetchAllReviews();
      refetchAnalytics();
    } else {
      setSnackbar({ open: true, message: "Tá»« chá»‘i Ä‘Ã¡nh giÃ¡ tháº¥t báº¡i.", severity: "error" });
    }
  };

  if (reviewsLoading || analyticsLoading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh', bgcolor: '#1a202c' }}>
        <CircularProgress sx={{ color: '#63b3ed' }} />
      </Box>
    );
  }

  if (reviewsError || analyticsError) {
    return (
      <Alert severity="error" sx={{ m: 2, bgcolor: '#2d3748', color: '#e2e8f0', '& .MuiAlert-icon': { color: '#f56565' } }}>
        Lá»—i khi táº£i dá»¯ liá»‡u: {reviewsError?.message || analyticsError?.message}
      </Alert>
    );
  }

  const safeAllReviews = Array.isArray(allReviews) ? allReviews : [];
  const safeAnalytics = analytics || {};
  const ratingDistribution = safeAnalytics.ratingDistribution || [];

  return (
    <Box sx={{ flexGrow: 1, bgcolor: '#1a202c', minHeight: '100vh', color: '#e2e8f0' }}>
      <Header title="Quáº£n lÃ½ ÄÃ¡nh giÃ¡ Sáº£n pháº©m" />

      <Box component="main" sx={{ maxWidth: '7xl', mx: 'auto', py: 6, px: { xs: 2, lg: 8 } }}>
        {/* Analytics Section */}
        <motion.div
          className="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 1 }}
        >
          <Grid item xs={12} md={4}>
            <Card elevation={0} sx={{ borderRadius: 2, bgcolor: '#2d3748', color: '#e2e8f0' }}>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', mb: 1 }}>
                  <RateReview color="primary" sx={{ fontSize: 30, mr: 1 }} />
                  <Typography variant="h6" color="primary" sx={{ fontWeight: 'bold' }}>Tá»•ng sá»‘ Ä‘Ã¡nh giÃ¡</Typography>
                </Box>
                <Typography variant="h3" sx={{ fontWeight: 'bold', color: '#63b3ed' }}>
                  {safeAnalytics.totalReviews}
                </Typography>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} md={4}>
            <Card elevation={0} sx={{ borderRadius: 2, bgcolor: '#2d3748', color: '#e2e8f0' }}>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', mb: 1 }}>
                  <DoneAll color="success" sx={{ fontSize: 30, mr: 1 }} />
                  <Typography variant="h6" color="success" sx={{ fontWeight: 'bold' }}>ÄÃ¡nh giÃ¡ Ä‘Ã£ duyá»‡t</Typography>
                </Box>
                <Typography variant="h3" sx={{ fontWeight: 'bold', color: '#48bb78' }}>
                  {safeAnalytics.approvedReviews}
                </Typography>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} md={4}>
            <Card elevation={0} sx={{ borderRadius: 2, bgcolor: '#2d3748', color: '#e2e8f0' }}>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', mb: 1 }}>
                  <PendingActions color="warning" sx={{ fontSize: 30, mr: 1 }} />
                  <Typography variant="h6" color="warning" sx={{ fontWeight: 'bold' }}>ÄÃ¡nh giÃ¡ chá» duyá»‡t</Typography>
                </Box>
                <Typography variant="h3" sx={{ fontWeight: 'bold', color: '#ecc94b' }}>
                  {safeAnalytics.pendingReviews}
                </Typography>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} md={6}>
            <Card elevation={0} sx={{ borderRadius: 2, bgcolor: '#2d3748', color: '#e2e8f0' }}>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', mb: 1 }}>
                  <Star color="action" sx={{ fontSize: 30, mr: 1 }} />
                  <Typography variant="h6" color="text.secondary" sx={{ fontWeight: 'bold' }}>Äiá»ƒm trung bÃ¬nh</Typography>
                </Box>
                <Typography variant="h3" sx={{ fontWeight: 'bold', color: '#ecc94b' }}>
                  {safeAnalytics.averageRating?.toFixed(2) || 'N/A'}
                </Typography>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} md={6}>
            <Card elevation={0} sx={{ borderRadius: 2, bgcolor: '#2d3748', color: '#e2e8f0' }}>
              <CardContent>
                <Typography variant="h6" sx={{ mb: 2, fontWeight: 'bold' }}>PhÃ¢n bá»‘ Ä‘iá»ƒm</Typography>
                {ratingDistribution.length > 0 ? (
                  ratingDistribution.map((dist) => (
                    <Box key={dist.rating} sx={{ display: 'flex', alignItems: 'center', mb: 0.5 }}>
                      <Typography sx={{ minWidth: 20, color: '#e2e8f0' }}>{dist.rating}</Typography>
                      <Star sx={{ color: '#ecc94b', fontSize: 16, mx: 0.5 }} />
                      <LinearProgress 
                        variant="determinate" 
                        value={safeAnalytics.totalReviews > 0 ? (dist.count / safeAnalytics.totalReviews) * 100 : 0}
                        sx={{ 
                          flexGrow: 1, 
                          mx: 1, 
                          height: 8, 
                          borderRadius: 4,
                          bgcolor: '#4a5568',
                          '& .MuiLinearProgress-bar': { bgcolor: '#ecc94b' }
                        }} 
                      />
                      <Typography sx={{ minWidth: 30, fontSize: '0.875rem', color: 'text.secondary' }}>
                        {dist.count}
                      </Typography>
                    </Box>
                  ))
                ) : (
                  <Typography variant="body2" color="text.secondary">KhÃ´ng cÃ³ dá»¯ liá»‡u phÃ¢n bá»‘ Ä‘iá»ƒm.</Typography>
                )}
              </CardContent>
            </Card>
          </Grid>
        </motion.div>

        {/* Filters Section */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 1, delay: 0.2 }}
        >
          <Paper elevation={0} sx={{ p: 3, mb: 4, borderRadius: 2, bgcolor: '#2d3748', color: '#e2e8f0' }}>
            <Typography variant="h6" gutterBottom sx={{ display: 'flex', alignItems: 'center', mb: 2, color: '#e2e8f0' }}>
              <FilterList sx={{ mr: 1 }} /> Bá»™ lá»c
            </Typography>
            <Grid container spacing={2}>
              <Grid item xs={12} sm={6} md={3}>
                <FormControl fullWidth size="small" sx={{ '& .MuiInputLabel-root': { color: '#a0aec0' }, '& .MuiOutlinedInput-notchedOutline': { borderColor: '#4a5568' }, '&:hover .MuiOutlinedInput-notchedOutline': { borderColor: '#63b3ed' }, '& .MuiSvgIcon-root': { color: '#e2e8f0' } }}>
                  <InputLabel>Tráº¡ng thÃ¡i duyá»‡t</InputLabel>
                  <Select
                    name="isApproved"
                    value={filters.isApproved === null ? '' : filters.isApproved}
                    label="Tráº¡ng thÃ¡i duyá»‡t"
                    onChange={handleFilterChange}
                    sx={{ color: '#e2e8f0', bgcolor: '#4a5568' }}
                  >
                    <MenuItem value="" sx={{ bgcolor: '#2d3748', color: '#e2e8f0' }}>Táº¥t cáº£</MenuItem>
                    <MenuItem value={true} sx={{ bgcolor: '#2d3748', color: '#e2e8f0' }}>ÄÃ£ duyá»‡t</MenuItem>
                    <MenuItem value={false} sx={{ bgcolor: '#2d3748', color: '#e2e8f0' }}>Chá» duyá»‡t</MenuItem>
                  </Select>
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={6} md={3}>
                <FormControl fullWidth size="small" sx={{ '& .MuiInputLabel-root': { color: '#a0aec0' }, '& .MuiOutlinedInput-notchedOutline': { borderColor: '#4a5568' }, '&:hover .MuiOutlinedInput-notchedOutline': { borderColor: '#63b3ed' }, '& .MuiSvgIcon-root': { color: '#e2e8f0' } }}>
                  <InputLabel>Äiá»ƒm tá»‘i thiá»ƒu</InputLabel>
                  <Select
                    name="minRating"
                    value={filters.minRating === null ? '' : filters.minRating}
                    label="Äiá»ƒm tá»‘i thiá»ƒu"
                    onChange={handleFilterChange}
                    sx={{ color: '#e2e8f0', bgcolor: '#4a5568' }}
                  >
                    <MenuItem value="" sx={{ bgcolor: '#2d3748', color: '#e2e8f0' }}>Táº¥t cáº£</MenuItem>
                    {[1, 2, 3, 4, 5].map(rating => (
                      <MenuItem key={rating} value={rating} sx={{ bgcolor: '#2d3748', color: '#e2e8f0' }}>{rating} Sao</MenuItem>
                    ))}
                  </Select>
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={6} md={3}>
                <FormControl fullWidth size="small" sx={{ '& .MuiInputLabel-root': { color: '#a0aec0' }, '& .MuiOutlinedInput-notchedOutline': { borderColor: '#4a5568' }, '&:hover .MuiOutlinedInput-notchedOutline': { borderColor: '#63b3ed' }, '& .MuiSvgIcon-root': { color: '#e2e8f0' } }}>
                  <InputLabel>Äiá»ƒm tá»‘i Ä‘a</InputLabel>
                  <Select
                    name="maxRating"
                    value={filters.maxRating === null ? '' : filters.maxRating}
                    label="Äiá»ƒm tá»‘i Ä‘a"
                    onChange={handleFilterChange}
                    sx={{ color: '#e2e8f0', bgcolor: '#4a5568' }}
                  >
                    <MenuItem value="" sx={{ bgcolor: '#2d3748', color: '#e2e8f0' }}>Táº¥t cáº£</MenuItem>
                    {[1, 2, 3, 4, 5].map(rating => (
                      <MenuItem key={rating} value={rating} sx={{ bgcolor: '#2d3748', color: '#e2e8f0' }}>{rating} Sao</MenuItem>
                    ))}
                  </Select>
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={6} md={3}>
                <TextField
                  fullWidth
                  size="small"
                  label="ID Sáº£n pháº©m"
                  name="productId"
                  value={filters.productId || ''}
                  onChange={handleFilterChange}
                  type="number"
                  InputLabelProps={{ style: { color: '#a0aec0' } }}
                  InputProps={{ style: { color: '#e2e8f0' }, sx: { '& fieldset': { borderColor: '#4a5568' }, '&:hover fieldset': { borderColor: '#63b3ed' } } }}
                />
              </Grid>
              <Grid item xs={12} sm={6} md={3}>
                <TextField
                  fullWidth
                  size="small"
                  label="ID NgÆ°á»i dÃ¹ng"
                  name="userId"
                  value={filters.userId || ''}
                  onChange={handleFilterChange}
                  type="number"
                  InputLabelProps={{ style: { color: '#a0aec0' } }}
                  InputProps={{ style: { color: '#e2e8f0' }, sx: { '& fieldset': { borderColor: '#4a5568' }, '&:hover fieldset': { borderColor: '#63b3ed' } } }}
                />
              </Grid>
              <Grid item xs={12} sm={6} md={6}>
                <TextField
                  fullWidth
                  size="small"
                  label="TÃ¬m kiáº¿m bÃ¬nh luáº­n"
                  name="searchComment"
                  value={filters.searchComment}
                  onChange={handleFilterChange}
                  InputLabelProps={{ style: { color: '#a0aec0' } }}
                  InputProps={{ style: { color: '#e2e8f0' }, sx: { '& fieldset': { borderColor: '#4a5568' }, '&:hover fieldset': { borderColor: '#63b3ed' } } }}
                />
              </Grid>
            </Grid>
          </Paper>
        </motion.div>

        {/* Reviews Table */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 1, delay: 0.4 }}
        >
          <Paper elevation={0} sx={{ borderRadius: 2, overflow: 'hidden', bgcolor: '#2d3748' }}>
            <TableContainer>
              <Table>
                <TableHead sx={{ bgcolor: '#4a5568' }}>
                  <TableRow>
                    <TableCell sx={{ fontWeight: 'bold', color: '#e2e8f0' }}>ID</TableCell>
                    <TableCell sx={{ fontWeight: 'bold', color: '#e2e8f0' }}>Sáº£n pháº©m</TableCell>
                    <TableCell sx={{ fontWeight: 'bold', color: '#e2e8f0' }}>NgÆ°á»i dÃ¹ng</TableCell>
                    <TableCell sx={{ fontWeight: 'bold', color: '#e2e8f0' }}>Äiá»ƒm</TableCell>
                    <TableCell sx={{ fontWeight: 'bold', color: '#e2e8f0' }}>BÃ¬nh luáº­n</TableCell>
                    <TableCell sx={{ fontWeight: 'bold', color: '#e2e8f0' }}>NgÃ y táº¡o</TableCell>
                    <TableCell sx={{ fontWeight: 'bold', color: '#e2e8f0' }}>Tráº¡ng thÃ¡i</TableCell>
                    <TableCell sx={{ fontWeight: 'bold', color: '#e2e8f0' }}>HÃ nh Ä‘á»™ng</TableCell>
                  </TableRow>
                </TableHead>
                <TableBody>
                  {safeAllReviews.length > 0 ? (
                    safeAllReviews.map((review) => (
                      <TableRow key={review.id} sx={{ '&:nth-of-type(odd)': { bgcolor: '#2d3748' }, '&:nth-of-type(even)': { bgcolor: '#1a202c' } }}>
                        <TableCell sx={{ color: '#e2e8f0' }}>{review.id}</TableCell>
                        <TableCell sx={{ color: '#e2e8f0' }}>{review.productName || review.productId}</TableCell> {/* Display product name or ID as fallback */}
                        <TableCell sx={{ color: '#e2e8f0' }}>{review.userName}</TableCell>
                        <TableCell><Rating value={review.rating} readOnly size="small" sx={{ color: '#ecc94b' }} /></TableCell>
                        <TableCell sx={{ maxWidth: 300, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', color: '#e2e8f0' }}>{review.comment}</TableCell>
                        <TableCell sx={{ color: '#e2e8f0' }}>{new Date(review.createdAt).toLocaleDateString('vi-VN')}</TableCell>
                        <TableCell>
                          <Chip
                            label={review.isApproved ? "ÄÃ£ duyá»‡t" : "Chá» duyá»‡t"}
                            color={review.isApproved ? "success" : "warning"}
                            size="small"
                            icon={review.isApproved ? <CheckCircleOutline /> : <PendingActions />}
                          />
                        </TableCell>
                        <TableCell>
                          {!review.isApproved && (
                            <Button 
                              variant="contained" 
                              color="success" 
                              size="small" 
                              onClick={() => handleApprove(review.id)} 
                              disabled={moderationLoading}
                              startIcon={<CheckCircleOutline />}
                              sx={{ mr: 1 }}
                            >
                              Duyá»‡t
                            </Button>
                          )}
                          {review.isApproved && (
                            <Button 
                              variant="outlined" 
                              color="warning" 
                              size="small" 
                              onClick={() => handleReject(review.id)} 
                              disabled={moderationLoading}
                              startIcon={<HighlightOff />}
                            >
                              Tá»« chá»‘i
                            </Button>
                          )}
                        </TableCell>
                      </TableRow>
                    ))
                  ) : (
                    <TableRow>
                      <TableCell colSpan={8} sx={{ textAlign: 'center', py: 4, color: '#e2e8f0' }}>
                        KhÃ´ng cÃ³ Ä‘Ã¡nh giÃ¡ nÃ o Ä‘á»ƒ hiá»ƒn thá»‹.
                      </TableCell>
                    </TableRow>
                  )}
                </TableBody>
              </Table>
            </TableContainer>
          </Paper>
        </motion.div>

        <Snackbar
          open={snackbar.open}
          autoHideDuration={4000}
          onClose={() => setSnackbar({ ...snackbar, open: false })}
          anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}
        >
          <Alert severity={snackbar.severity} variant="filled" sx={{ width: '100%' }}>
            {snackbar.message}
          </Alert>
        </Snackbar>
      </Box>
    </Box>
  );
};

export default ReviewManagementPage;

```

### ClientApp\src\pages\Admin\SalesPage.jsx
```jsx
import { motion } from "framer-motion";
import { useState, useEffect } from "react";
import Header from "@/components/Admin/common/Header";
import StatCard from "@/components/Admin/common/StatCard";
import {
  CreditCard,
  DollarSign,
  ShoppingCart,
  TrendingUp,
  CheckCircle,
  Clock,
} from "lucide-react";
import SalesOverviewChart from "@/components/Admin/sales/SalesOverviewChart";
import SalesByCategoryChart from "@/components/Admin/sales/SalesByCategoryChart";
import DailySalesTrend from "@/components/Admin/sales/DailySalesTrend";

const SalesPage = () => {
  const [stats, setStats] = useState({
    totalRevenue: 0,
    totalOrders: 0,
    completedOrders: 0,
    pendingOrders: 0,
    averageOrderValue: 0,
  });
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchStats = async () => {
      try {
        const response = await fetch(
          `${process.env.REACT_APP_API_BASE_URL}/api/orders/stats`
        );
        if (!response.ok) {
          throw new Error("Failed to fetch stats");
        }
        const data = await response.json();

        // Calculate average order value
        const avgOrderValue = data.totalRevenue / (data.completedOrders || 1);

        setStats({
          totalRevenue: data.totalRevenue,
          totalOrders: data.totalOrders,
          completedOrders: data.completedOrders,
          pendingOrders: data.pendingOrders,
          averageOrderValue: avgOrderValue,
        });
        setLoading(false);
      } catch (err) {
        setError(err.message);
        setLoading(false);
      }
    };

    fetchStats();
  }, []);

  // Format currency
  const formatCurrency = (value) => {
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
    }).format(value);
  };

  if (loading) return <div className="text-center py-8">Loading...</div>;
  if (error)
    return <div className="text-center py-8 text-red-500">Error: {error}</div>;

  return (
    <div className="flex-1 overflow-auto relative z-10">
      <Header title="BÃ¡n HÃ ng" />

      <main className="max-w-7xl mx-auto py-6 px-4 lg:px-8">
        {/* SALES STATS */}
        <motion.div
          className="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 1 }}
        >
          <StatCard
            name="Tá»•ng doanh thu"
            icon={DollarSign}
            value={formatCurrency(stats.totalRevenue)}
            color="#6366F1"
          />
          <StatCard
            name="GiÃ¡ trá»‹ Ä‘Æ¡n trung bÃ¬nh"
            icon={ShoppingCart}
            value={formatCurrency(stats.averageOrderValue)}
            color="#10B981"
          />
          <StatCard
            name="ÄÆ¡n hoÃ n thÃ nh"
            icon={CheckCircle}
            value={`${stats.completedOrders}/${stats.totalOrders}`}
            color="#F59E0B"
          />
          <StatCard
            name="ÄÆ¡n Ä‘ang chá»"
            icon={Clock}
            value={stats.pendingOrders.toString()}
            color="#EF4444"
          />
        </motion.div>

        <SalesOverviewChart />

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          <SalesByCategoryChart />
          <DailySalesTrend />
        </div>
      </main>
    </div>
  );
};

export default SalesPage;

```

### ClientApp\src\pages\Admin\SettingsPage.jsx
```jsx
import Header from "@/components/Admin/common/Header";
import ConnectedAccounts from "@/components/Admin/settings/ConnectedAccounts";
import DangerZone from "@/components/Admin/settings/DangerZone";
import Notifications from "@/components/Admin/settings/Notifications";
import Profile from "@/components/Admin/settings/Profile";
import Security from "@/components/Admin/settings/Security";

const SettingsPage = () => {
  return (
    <div className="flex-1 overflow-auto relative z-10 bg-gray-900">
      <Header title="Settings" />
      <main className="max-w-4xl mx-auto py-6 px-4 lg:px-8">
        <Profile />
        <Notifications />
        <Security />
        <ConnectedAccounts />
        <DangerZone />
      </main>
    </div>
  );
};
export default SettingsPage;

```

### ClientApp\src\pages\Admin\UsersPage.jsx
```jsx
import { useState, useEffect } from "react";
import { UserCheck, UserPlus, UsersIcon } from "lucide-react";
import { motion } from "framer-motion";
import axios from "axios";

import Header from "@/components/Admin/common/Header";
import StatCard from "@/components/Admin/common/StatCard";
import UsersTable from "@/components/Admin/users/UsersTable";
import UserGrowthChart from "@/components/Admin/users/UserGrowthChart";
import UserActivityHeatmap from "@/components/Admin/users/UserActivityHeatmap";
import UserDemographicsChart from "@/components/Admin/users/UserDemographicsChart";

const UsersPage = () => {
  const [userStats, setUserStats] = useState({
    totalUsers: 0,
    newUsersToday: 0,
    activeUsers: 0,
    retentionRate: "0%", // Thay churnRate thÃ nh retentionRate
  });

  useEffect(() => {
    const fetchUserStats = async () => {
      try {
        const response = await axios.get(
          `${process.env.REACT_APP_API_BASE_URL}/api/users/statistics`
        );
        setUserStats(response.data);
      } catch (error) {
        console.error("Lá»—i khi láº¥y dá»¯ liá»‡u ngÆ°á»i dÃ¹ng:", error);
      }
    };

    fetchUserStats();
  }, []);

  return (
    <div className="flex-1 overflow-auto relative z-10">
      <Header title="NgÆ°á»i dÃ¹ng" />

      <main className="max-w-7xl mx-auto py-6 px-4 lg:px-8">
        {/* STATS */}
        <motion.div
          className="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 1 }}
        >
          <StatCard
            name="Tá»•ng ngÆ°á»i dÃ¹ng"
            icon={UsersIcon}
            value={userStats.totalUsers.toLocaleString()}
            color="#6366F1"
          />
          <StatCard
            name="NgÆ°á»i dÃ¹ng má»›i táº¡o"
            icon={UserPlus}
            value={userStats.newUsersToday.toLocaleString()}
            color="#10B981"
          />
          <StatCard
            name="Tráº¡ng thÃ¡i Ä‘Ã£ kÃ­ch hoáº¡t"
            icon={UserCheck}
            value={userStats.activeUsers.toLocaleString()}
            color="#F59E0B"
          />
          <StatCard
            name="Tá»‰ lá»‡ giá»¯ chÃ¢n ngÆ°á»i dÃ¹ng" // Cáº­p nháº­t tÃªn
            icon={UserCheck} // CÃ³ thá»ƒ giá»¯ UserCheck hoáº·c Ä‘á»•i icon phÃ¹ há»£p
            value={userStats.retentionRate}
            color="#34D399" // MÃ u xanh lÃ¡ thá»ƒ hiá»‡n má»©c Ä‘á»™ giá»¯ chÃ¢n tá»‘t hÆ¡n
          />
        </motion.div>

        <UsersTable />

        {/* USER CHARTS */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
          <UserGrowthChart />
          <UserActivityHeatmap />
          <UserDemographicsChart />
        </div>
      </main>
    </div>
  );
};

export default UsersPage;

```

### ClientApp\src\pages\blog\BlogList.js
```js
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { Link } from 'react-router-dom';

const BlogList = () => {
    const [blogPosts, setBlogPosts] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    useEffect(() => {
        const fetchBlogPosts = async () => {
            try {
                const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/BlogPosts`);
                setBlogPosts(response.data);
            } catch (err) {
                setError('Failed to fetch blog posts.');
                console.error(err);
            } finally {
                setLoading(false);
            }
        };

        fetchBlogPosts();
    }, []);

    if (loading) return <div>Loading blog posts...</div>;
    if (error) return <div>Error: {error}</div>;

    return (
        <div className="container mx-auto p-4">
            <h1 className="text-3xl font-bold mb-6">Blog Posts</h1>
            <Link to="/admin/blog/new" className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mb-4 inline-block">
                Create New Post
            </Link>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {blogPosts.map((post) => (
                    <div key={post.id} className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-semibold mb-2">{post.title}</h2>
                        <p className="text-gray-600 text-sm mb-2">By {post.authorName} on {new Date(post.createdAt).toLocaleDateString()}</p>
                        <div className="text-gray-800 mb-4" dangerouslySetInnerHTML={{ __html: post.content.substring(0, 150) + '...' }}></div>
                        <Link to={`/blog/${post.id}`} className="text-blue-500 hover:underline">
                            Read More
                        </Link>
                        <Link to={`/admin/blog/edit/${post.id}`} className="ml-4 text-green-500 hover:underline">
                            Edit
                        </Link>
                    </div>
                ))}
            </div>
        </div>
    );
};

export default BlogList;

```

### ClientApp\src\pages\blog\BlogPostDetail.js
```js
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { useParams } from 'react-router-dom';

const BlogPostDetail = () => {
    const { id } = useParams();
    const [blogPost, setBlogPost] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    useEffect(() => {
        const fetchBlogPost = async () => {
            try {
                const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/BlogPosts/${id}`);
                setBlogPost(response.data);
            } catch (err) {
                setError('Failed to fetch blog post.');
                console.error(err);
            } finally {
                setLoading(false);
            }
        };

        fetchBlogPost();
    }, [id]);

    if (loading) return <div>Loading blog post...</div>;
    if (error) return <div>Error: {error}</div>;
    if (!blogPost) return <div>Blog post not found.</div>;

    return (
        <div className="container mx-auto p-4">
            <h1 className="text-4xl font-bold mb-4">{blogPost.title}</h1>
            <p className="text-gray-600 text-sm mb-4">By {blogPost.authorName} on {new Date(blogPost.createdAt).toLocaleDateString()}</p>
            <div className="prose lg:prose-xl" dangerouslySetInnerHTML={{ __html: blogPost.content }}></div>
        </div>
    );
};

export default BlogPostDetail;

```

### ClientApp\src\pages\blog\BlogPostEditor.js
```js
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { useNavigate, useParams } from 'react-router-dom';
import ReactQuill from 'react-quill';
import 'react-quill/dist/quill.snow.css'; // Import Quill styles

const BlogPostEditor = () => {
    const { id } = useParams(); // For editing existing posts
    const navigate = useNavigate();
    const [title, setTitle] = useState('');
    const [content, setContent] = useState('');
    const [isPublished, setIsPublished] = useState(false);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    const isEditing = id !== undefined;

    useEffect(() => {
        if (isEditing) {
            setLoading(true);
            axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/BlogPosts/${id}`)
                .then(response => {
                    setTitle(response.data.title);
                    setContent(response.data.content);
                    setIsPublished(response.data.isPublished);
                })
                .catch(err => {
                    setError('Failed to load blog post for editing.');
                    console.error(err);
                })
                .finally(() => setLoading(false));
        }
    }, [id, isEditing]);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError(null);

        const blogPostData = { title, content, isPublished };
        const token = localStorage.getItem('token'); // Assuming you store JWT token in localStorage

        try {
            if (isEditing) {
                await axios.put(`/api/BlogPosts/${id}`, blogPostData, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
            } else {
                await axios.post('/api/BlogPosts', blogPostData, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
            }
            navigate('/admin/blog'); // Redirect to blog list after save
        } catch (err) {
            setError('Failed to save blog post. Make sure you are logged in as an Admin.');
            console.error(err);
        } finally {
            setLoading(false);
        }
    };

    if (loading && isEditing) return <div>Loading blog post for editing...</div>;

    return (
        <div className="container mx-auto p-4">
            <h1 className="text-3xl font-bold mb-6">{isEditing ? 'Edit Blog Post' : 'Create New Blog Post'}</h1>
            {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">{error}</div>}
            <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                    <label htmlFor="title" className="block text-sm font-medium text-gray-700">Title</label>
                    <input
                        type="text"
                        id="title"
                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                        value={title}
                        onChange={(e) => setTitle(e.target.value)}
                        required
                    />
                </div>
                <div>
                    <label htmlFor="content" className="block text-sm font-medium text-gray-700">Content</label>
                    <ReactQuill
                        theme="snow"
                        value={content}
                        onChange={setContent}
                        className="mt-1"
                        modules={BlogPostEditor.modules}
                        formats={BlogPostEditor.formats}
                    />
                </div>
                <div className="flex items-center">
                    <input
                        id="isPublished"
                        name="isPublished"
                        type="checkbox"
                        className="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded"
                        checked={isPublished}
                        onChange={(e) => setIsPublished(e.target.checked)}
                    />
                    <label htmlFor="isPublished" className="ml-2 block text-sm text-gray-900">
                        Publish Post
                    </label>
                </div>
                <button
                    type="submit"
                    className="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                    disabled={loading}
                >
                    {loading ? 'Saving...' : (isEditing ? 'Update Post' : 'Create Post')}
                </button>
            </form>
        </div>
    );
};

BlogPostEditor.modules = {
    toolbar: [
        [{ 'header': '1' }, { 'header': '2' }, { 'font': [] }],
        [{ size: [] }],
        ['bold', 'italic', 'underline', 'strike', 'blockquote'],
        [{ 'list': 'ordered' }, { 'list': 'bullet' },
        { 'indent': '-1' }, { 'indent': '+1' }],
        ['link', 'image', 'video'],
        ['clean']
    ],
    clipboard: {
        // toggle to add extra newline when pasting HTML: https://quilljs.com/docs/modules/clipboard/
        matchVisual: false,
    },
};

BlogPostEditor.formats = [
    'header',
    'font',
    'size',
    'bold',
    'italic',
    'underline',
    'strike',
    'blockquote',
    'list',
    'bullet',
    'indent',
    'link',
    'image',
    'video',
];

export default BlogPostEditor;

```

### ClientApp\src\pages\Home\HomePage.js
```js
import React, { useState, useEffect } from 'react';
import axios from 'axios';

// Placeholder components for each section
import HeroBanner from '@/components/HeroBanner/HeroBanner';
import FeaturedCategories from '@/components/FeaturedCategories/FeaturedCategories';
import BestSellerSection from '@/components/BestSellers/BestSellers';
import FlashSale from '@/components/FlashSale/FlashSale';
import Commitment from '@/components/Commitment/Commitment';
import BannerSlider from '@/components/Homepage/BannerSlider'; // New import

const componentMap = {
  hero: HeroBanner,
  categories: FeaturedCategories,
  featured_products: BestSellerSection, // Changed to BestSellerSection
  special_offer: FlashSale,
  best_seller: BestSellerSection, // New mapping for best_seller
  brand_trust: Commitment,
  banner_slider: BannerSlider, // New component mapping
};

const HomePage = () => {
  const [config, setConfig] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchConfig = async () => {
      try {
        const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/api/homepage-config`);
        setConfig(response.data);
      } catch (err) {
        setError('Failed to load homepage configuration.');
        console.error(err);
      } finally {
        setLoading(false);
      }
    };

    fetchConfig();
  }, []);

  if (loading) {
    return <div className="flex items-center justify-center h-screen">Loading...</div>;
  }

  if (error) {
    return <div className="flex items-center justify-center h-screen text-red-500">{error}</div>;
  }

  if (!config) {
    return null;
  }

  return (
    <main>
      {config.layout.map((sectionName) => {
        const Component = componentMap[sectionName];
        const sectionData = config.components[sectionName];

        if (Component && sectionData && sectionData.enabled) {
          if (sectionName === 'categories') {
            return <Component key={sectionName} />;
          } else if (sectionName === 'banner_slider') { // Handle banner_slider separately
            return <Component key={sectionName} />;
          } else {
            return <Component key={sectionName} data={sectionData} />;
          }
        }

        return null;
      })}
    </main>
  );
};

export default HomePage;
```

### ClientApp\src\pages\OrderLookupPage\OrderLookupPage.jsx
```jsx
import React from "react";
import Navbar from "@/components/Navbar/Navbar";
import OrderLookup from "@/components/Order/OrderLookup";
import Footer from "@/components/Footer/Footer";

const OrderLookupPage = () => {
  return (
    <>
      <Navbar />
      <main style={{
        minHeight: "70vh",
        background: "#f5f5f5",
        paddingTop: 48,
        paddingBottom: 48,
        display: "flex",
        flexDirection: "column",
        alignItems: "center"
      }}>
        <div style={{ width: "100%", maxWidth: 1200 }}>
          <OrderLookup />
        </div>
      </main>
      <Footer />
    </>
  );
};

export default OrderLookupPage;

```

### ClientApp\src\pages\ProductList\ProductList.jsx
```jsx
import React, { useState } from "react";
import { useLocation } from "react-router-dom";
import {
  Box,
  Container,
  Paper,
  Typography,
  Breadcrumbs,
  Link,
  Button,
  InputBase,
  IconButton,
  Fade,
  useScrollTrigger,
  Zoom,
  Fab,
} from "@mui/material";
import {
  Home,
  ChevronRight,
  Search,
  ArrowUp,
  GridIcon,
  ListIcon,
} from "lucide-react";
import { motion } from "framer-motion";
import Navbar from "@/components/Navbar/Navbar";
import CategoryMenu from "@/components/List/CategoryMenu";
import FilterSection from "@/components/List/FilterSection";
import ProductGrid from "@/components/List/ProductGrid";
import Commitment from "@/components/Commitment/Commitment";
import Footer from "@/components/Footer/Footer";

const container = {
  hidden: { opacity: 0 },
  show: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      delayChildren: 0.2,
    },
  },
};

const item = {
  hidden: { opacity: 0, y: 20 },
  show: {
    opacity: 1,
    y: 0,
    transition: {
      duration: 0.5,
      ease: [0.43, 0.13, 0.23, 0.96],
    },
  },
};

const ProductList = () => {
  const location = useLocation();
  const queryParams = new URLSearchParams(location.search);
  const categoryId = queryParams.get("categoryId");
  const searchQuery = queryParams.get("search");

  const [selectedPriceRange, setSelectedPriceRange] = useState("all");
  const [selectedBrand, setSelectedBrand] = useState(null);
  const [viewMode, setViewMode] = useState("grid");
  const [searchValue, setSearchValue] = useState(searchQuery || "");
  const [currentPage, setCurrentPage] = useState(1); // ThÃªm state cho current page

  // Reset trang khi filter thay Ä‘á»•i
  const handleFilterChange = (filterType, value) => {
    setCurrentPage(1); // Reset vá» trang 1

    switch (filterType) {
      case "priceRange":
        setSelectedPriceRange(value);
        break;
      case "brand":
        setSelectedBrand(value);
        break;
      default:
        break;
    }
  };

  const trigger = useScrollTrigger({
    disableHysteresis: true,
    threshold: 100,
  });

  const scrollToTop = () => {
    window.scrollTo({
      top: 0,
      behavior: "smooth",
    });
  };

  return (
    <motion.div initial="hidden" animate="show" variants={container}>
      <Box
        sx={{
          minHeight: "100vh",
          bgcolor: "#f8fafc",
          background: "linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)",
        }}
      >
        <Navbar />

        <Container
          maxWidth="xl"
          sx={{
            pt: { xs: 3, sm: 4 },
            pb: { xs: 6, sm: 8 },
            position: "relative",
          }}
        >
          <motion.div variants={item}>
            {/* Breadcrumb Navigation */}
            <Breadcrumbs
              separator={<ChevronRight size={16} />}
              sx={{
                mb: 4,
                px: 2,
                py: 1.5,
                bgcolor: "background.paper",
                borderRadius: 2,
                backdropFilter: "blur(10px)",
                border: "1px solid rgba(230, 232, 236, 0.8)",
                "& .MuiBreadcrumbs-li": {
                  display: "flex",
                  alignItems: "center",
                },
              }}
            >
              <Link
                href="/"
                sx={{
                  display: "flex",
                  alignItems: "center",
                  gap: 0.5,
                  color: "text.secondary",
                  textDecoration: "none",
                  fontSize: "0.875rem",
                  transition: "color 0.2s ease",
                  "&:hover": { color: "primary.main" },
                }}
              >
                <Home size={16} />
                Trang chá»§
              </Link>
              <Typography
                color="text.primary"
                sx={{
                  display: "flex",
                  alignItems: "center",
                  fontSize: "0.875rem",
                  fontWeight: 500,
                }}
              >
                {searchQuery ? "TÃ¬m kiáº¿m" : "Danh má»¥c sáº£n pháº©m"}
              </Typography>
            </Breadcrumbs>
          </motion.div>

          <motion.div variants={item}>
            {/* Page Header */}
            <Box sx={{ mb: 6, textAlign: "center" }}>
              <Typography
                variant="h3"
                component="h1"
                sx={{
                  fontWeight: 800,
                  background:
                    "linear-gradient(45deg, #1e293b 30%, #334155 90%)",
                  WebkitBackgroundClip: "text",
                  WebkitTextFillColor: "transparent",
                  mb: 2,
                  letterSpacing: "-0.02em",
                  position: "relative",
                  "&::after": {
                    content: '""',
                    position: "absolute",
                    bottom: -8,
                    left: "50%",
                    transform: "translateX(-50%)",
                    width: 60,
                    height: 4,
                    borderRadius: 2,
                    background:
                      "linear-gradient(45deg, #6366F1 30%, #818CF8 90%)",
                  },
                }}
              >
                {searchQuery
                  ? `Káº¿t quáº£ tÃ¬m kiáº¿m cho "${searchQuery}"`
                  : "KhÃ¡m phÃ¡ sáº£n pháº©m"}
              </Typography>
              <Typography
                variant="subtitle1"
                sx={{
                  color: "text.secondary",
                  maxWidth: 600,
                  mx: "auto",
                  mb: 4,
                  lineHeight: 1.6,
                }}
              >
                KhÃ¡m phÃ¡ bá»™ sÆ°u táº­p sáº£n pháº©m cÃ´ng nghá»‡ Ä‘a dáº¡ng vá»›i cháº¥t lÆ°á»£ng
                Ä‘áº£m báº£o
              </Typography>
            </Box>
          </motion.div>

          <motion.div variants={item}>
            {/* Category Menu */}
            <Paper
              elevation={0}
              sx={{
                mb: 4,
                borderRadius: 3,
                overflow: "hidden",
                border: "1px solid",
                borderColor: "divider",
                backdropFilter: "blur(20px)",
                backgroundColor: "rgba(255, 255, 255, 0.9)",
                transition: "all 0.3s ease-in-out",
                "&:hover": {
                  transform: "translateY(-4px)",
                  boxShadow: "0 12px 24px -8px rgba(0,0,0,0.1)",
                },
              }}
            >
              <CategoryMenu />
            </Paper>
          </motion.div>

          <motion.div variants={item}>
            {/* View Mode Toggle */}{" "}
            <Box
              sx={{
                display: "flex",
                justifyContent: "flex-end",
                alignItems: "center",
                mb: 3,
                gap: 2,
              }}
            >
              {/* View Mode Buttons */}
              <Box sx={{ display: "flex", gap: 1 }}>
                <Button
                  size="small"
                  startIcon={<GridIcon size={18} />}
                  variant={viewMode === "grid" ? "contained" : "outlined"}
                  onClick={() => setViewMode("grid")}
                  sx={{
                    borderRadius: 2,
                    textTransform: "none",
                    boxShadow: "none",
                    transition: "all 0.3s ease",
                    "&:hover": {
                      transform: "translateY(-2px)",
                      boxShadow: "0 4px 8px -4px rgba(0,0,0,0.1)",
                    },
                  }}
                >
                  Grid
                </Button>
                <Button
                  size="small"
                  startIcon={<ListIcon size={18} />}
                  variant={viewMode === "list" ? "contained" : "outlined"}
                  onClick={() => setViewMode("list")}
                  sx={{
                    borderRadius: 2,
                    textTransform: "none",
                    boxShadow: "none",
                    transition: "all 0.3s ease",
                    "&:hover": {
                      transform: "translateY(-2px)",
                      boxShadow: "0 4px 8px -4px rgba(0,0,0,0.1)",
                    },
                  }}
                >
                  List
                </Button>
              </Box>
            </Box>
          </motion.div>

          <motion.div variants={item}>
            {/* Main Content */}
            <Box
              sx={{
                display: "grid",
                gridTemplateColumns: { xs: "1fr", lg: "280px 1fr" },
                gap: 4,
              }}
            >
              {/* Filter Section */}
              <motion.div variants={item}>
                <Paper
                  elevation={0}
                  sx={{
                    p: 3,
                    borderRadius: 3,
                    border: "1px solid",
                    borderColor: "divider",
                    height: "fit-content",
                    position: { lg: "sticky" },
                    top: { lg: 24 },
                    backdropFilter: "blur(20px)",
                    backgroundColor: "rgba(255, 255, 255, 0.9)",
                    transition: "all 0.3s ease-in-out",
                    "&:hover": {
                      boxShadow: "0 8px 16px -4px rgba(0,0,0,0.1)",
                      transform: "translateY(-4px)",
                    },
                  }}
                >
                  {" "}
                  <FilterSection
                    onPriceChange={(value) =>
                      handleFilterChange("priceRange", value)
                    }
                    onBrandChange={(value) =>
                      handleFilterChange("brand", value)
                    }
                    viewMode={viewMode}
                    onViewModeChange={setViewMode}
                  />
                </Paper>
              </motion.div>

              {/* Product Grid */}
              <motion.div variants={item} style={{ width: "100%" }}>
                <ProductGrid
                  selectedCategory={categoryId ? parseInt(categoryId) : null}
                  selectedPriceRange={selectedPriceRange}
                  selectedBrand={selectedBrand}
                  viewMode={viewMode}
                  currentPage={currentPage} // Truyá»n currentPage vÃ o Ä‘Ã¢y
                  onPageChange={setCurrentPage} // HÃ m Ä‘á»ƒ thay Ä‘á»•i trang
                />
              </motion.div>
            </Box>
          </motion.div>
        </Container>

        <motion.div variants={item}>
          <Box sx={{ bgcolor: "background.paper" }}>
            <Container maxWidth="xl" sx={{ py: 6 }}>
              <Commitment />
            </Container>
          </Box>
        </motion.div>

        <motion.div variants={item}>
          <Footer />
        </motion.div>
      </Box>

      {/* Scroll to Top Button */}
      <Zoom in={trigger}>
        <Box
          onClick={scrollToTop}
          role="presentation"
          sx={{
            position: "fixed",
            bottom: 32,
            right: 32,
            zIndex: 1000,
          }}
        >
          <Fab
            color="primary"
            size="small"
            aria-label="scroll back to top"
            sx={{
              boxShadow: "0 8px 16px -4px rgba(99, 102, 241, 0.5)",
              transition: "all 0.3s ease",
              "&:hover": {
                transform: "translateY(-2px)",
                boxShadow: "0 12px 20px -4px rgba(99, 102, 241, 0.6)",
              },
            }}
          >
            <ArrowUp size={20} />
          </Fab>
        </Box>
      </Zoom>
    </motion.div>
  );
};

export default ProductList;

```

### ClientApp\src\pages\ProductPage\ProductPage.jsx
```jsx
import React, { useState, useEffect } from "react";
import { useParams } from "react-router-dom";
import { Container, Grid, Box, Alert, CircularProgress } from "@mui/material";
import Navbar from "@/components/Navbar/Navbar";
import ProductImage from "@/components/ProductInfoPage/ProductImage";
import ProductInfo from "@/components/ProductInfoPage/ProductInfo";
import ProductVariants from "@/components/ProductInfoPage/ProductVariants";
import Footer from "@/components/Footer/Footer";
import ProductReviews from "@/components/ProductInfoPage/ProductReviews";
import RelatedProducts from "@/components/ProductInfoPage/RelatedProducts";
import SpecificationDisplay from "@/components/ProductInfoPage/ProductSpecifications";
import Commitment from "@/components/Commitment/Commitment";

const ProductPage = () => {
  const { id } = useParams();
  const [product, setProduct] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");

  useEffect(() => {
    const fetchProduct = async () => {
      try {
        setLoading(true);
        const response = await fetch(
          `${process.env.REACT_APP_API_BASE_URL}/api/Products/${id}`
        );
        if (!response.ok) {
          throw new Error("KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u sáº£n pháº©m.");
        }
        const data = await response.json();
        setProduct(data);
      } catch (err) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    };

    fetchProduct();
  }, [id]);

  const getProductType = () => {
    if (!product?.category?.name) return null;

    const categoryName = product.category.name.toLowerCase();
    if (categoryName.includes("phone") || categoryName.includes("Ä‘iá»‡n thoáº¡i")) {
      return "phone";
    } else if (
      categoryName.includes("laptop") ||
      categoryName.includes("mÃ¡y tÃ­nh")
    ) {
      return "laptop";
    } else if (
      categoryName.includes("headphone") ||
      categoryName.includes("tai nghe")
    ) {
      return "headphone";
    }
    return null;
  };

  if (loading) {
    return (
      <Box className="min-h-screen flex items-center justify-center">
        <CircularProgress size={60} thickness={4} />
      </Box>
    );
  }

  if (error) {
    return (
      <Box className="min-h-screen flex items-center justify-center p-4">
        <Alert severity="error" variant="filled">
          {error}
        </Alert>
      </Box>
    );
  }

  if (!product) {
    return (
      <Box className="min-h-screen flex items-center justify-center p-4">
        <Alert severity="warning" variant="filled">
          KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m
        </Alert>
      </Box>
    );
  }


  return (
    <Box className="min-h-screen bg-gray-50">
      <Navbar />

      <Container maxWidth="xl" sx={{ pt: { xs: 8, sm: 12 }, pb: 8 }}>
        <Grid container spacing={4}>
          {/* Product Image Section */}
          <Grid item xs={12} md={6} lg={5}>
            <Box
              sx={{
                position: "sticky",
                top: 100,
                backgroundColor: "white",
                borderRadius: 2,
                overflow: "hidden",
                boxShadow: "0 4px 20px rgba(0,0,0,0.08)",
                p: 2, // Added padding
              }}
            >
              <ProductImage images={product.images || []} name={product.name} />
            </Box>
          </Grid>
          {/* Product Info Section */}
          <Grid item xs={12} md={6} lg={7}>
            <Box sx={{ display: "flex", flexDirection: "column", gap: 3 }}>
              <ProductInfo product={product} />
              <ProductVariants
                variants={product.variants || []}
                onAddToCart={() => {}}
              />
            </Box>
          </Grid>
          {/* Product Specifications Section */}
   
            <Grid item xs={12}>
              <Box
                sx={{
                  backgroundColor: "white",
                  borderRadius: 2,
                  overflow: "hidden",
                  boxShadow: "0 4px 20px rgba(0,0,0,0.08)",
                  p: 3, // Added padding
                }}
              >
                <SpecificationDisplay
                  productId={product.id}
                />
              </Box>
            </Grid>
          {/* Product Reviews Section */}
          <Grid item xs={12}>
            <Box
              sx={{
                backgroundColor: "white",
                borderRadius: 2,
                p: 3,
                boxShadow: "0 4px 20px rgba(0,0,0,0.08)",
              }}
            >
              <ProductReviews productId={product.id} />
            </Box>
          </Grid>
          {/* Related Products Section */}
          {/* <Grid item xs={12}>
            <Box sx={{ mt: 4 }}>
              <RelatedProducts
                productId={product.id}
                brandId={product.brandId}
                categoryId={product.categoryId}
              />
            </Box>
          </Grid> */}
        </Grid>
      </Container>
    </Box>
  );
};

export default ProductPage;

```

### ClientApp\src\pages\ProfilePage\ProfilePage.jsx
```jsx
import React from "react";
import { NavLink, Outlet, useLocation } from "react-router-dom";
import Navbar from "../../components/Navbar/Navbar";
import Footer from "../../components/Footer/Footer";

const ProfilePage = () => {
  const location = useLocation();
  const activeTab = location.pathname.split("/profile/")[1] || "profile";

  const tabs = [
    { id: "info", label: "ThÃ´ng tin cÃ¡ nhÃ¢n", icon: "ğŸ‘¤" },
    { id: "address", label: "Sá»• Ä‘á»‹a chá»‰", icon: "ğŸ " },
    { id: "orders", label: "ÄÆ¡n hÃ ng", icon: "ğŸ“¦" },
    { id: "loyalty", label: "TÃ­ch Ä‘iá»ƒm", icon: "â­" },
  ];

  return (
    <div className="min-h-screen flex flex-col bg-gray-50">
      <Navbar />
      
      <div className="flex flex-1 container mx-auto px-4 py-8 gap-6">
        {/* Sidebar Navigation */}
        <div className="w-64 flex-shrink-0">
          <div className="bg-white rounded-lg shadow-sm p-4 sticky top-24">
            <h2 className="text-xl font-bold mb-6 text-gray-800 border-b pb-2">TÃ i khoáº£n cá»§a tÃ´i</h2>
            <nav className="space-y-1">
              {tabs.map((tab) => (
                <NavLink
                  key={tab.id}
                  to={`/profile/${tab.id}`}
                  className={({ isActive }) =>
                    `flex items-center px-4 py-3 rounded-lg transition-colors ${
                      isActive
                        ? "bg-blue-50 text-blue-600 font-medium"
                        : "text-gray-600 hover:bg-gray-100"
                    }`
                  }
                >
                  <span className="mr-3 text-lg">{tab.icon}</span>
                  {tab.label}
                </NavLink>
              ))}
            </nav>
          </div>
        </div>

        {/* Main Content */}
        <div className="flex-1">
          <div className="bg-white rounded-lg shadow-sm p-6 min-h-[calc(100vh-180px)]">
            <Outlet />
          </div>
        </div>
      </div>

      <Footer />
    </div>
  );
};

export default ProfilePage;
```

### ClientApp\src\pages\shoppingcart\shoppingcart.jsx
```jsx
import React, { useState, useEffect } from "react";
import Navbar from "@/components/Navbar/Navbar";
import CartItem from "@/components/shoppingcart/CartItem";
import OrderSummary from "@/components/shoppingcart/OrderSummary";
import Commitment from "@/components/Commitment/Commitment";
import Footer from "@/components/Footer/Footer";

const Shoppingcart = () => {
  const [cartItems, setCartItems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [total, setTotal] = useState(0);
  const [discount, setDiscount] = useState(0);
  const [payable, setPayable] = useState(0);
  const [rewardPoints, setRewardPoints] = useState(0);

  useEffect(() => {
    const fetchCart = async () => {
      try {
        const response = await fetch(
          `${process.env.REACT_APP_API_BASE_URL}/api/cart`,
          {
            method: "GET",
            credentials: "include",
          }
        );

        if (!response.ok) {
          throw new Error("KhÃ´ng thá»ƒ láº¥y dá»¯ liá»‡u giá» hÃ ng");
        }

        const data = await response.json();
        setCartItems(data.items);
        setTotal(data.total);
        setDiscount(data.discount);
        setPayable(data.payable);
        setRewardPoints(data.rewardPoints);
      } catch (error) {
        console.error("Lá»—i khi táº£i giá» hÃ ng:", error);
      } finally {
        setLoading(false);
      }
    };

    fetchCart();
  }, []);

  return (
    <div className="shoppingcart-container mt-14">
      <Navbar />

      <div className="flex gap-6 p-6">
        <div className="w-2/3">
          {loading ? (
            <p className="text-center text-gray-500">Äang táº£i giá» hÃ ng...</p>
          ) : cartItems.length > 0 ? (
            cartItems.map((item) => <CartItem key={item.id} item={item} />)
          ) : (
            <div className="text-center text-gray-500 font-semibold p-4">
              ğŸ›’ Giá» hÃ ng cá»§a báº¡n Ä‘ang trá»‘ng
            </div>
          )}
        </div>

        <div className="w-1/3">
          <OrderSummary
            total={total}
            discount={discount}
            payable={payable}
            rewardPoints={rewardPoints}
          />
        </div>
      </div>

      <Commitment />
      <Footer />
    </div>
  );
};

export default Shoppingcart;

```

### ClientApp\src\pages\Unauthorized\Unauthorized.jsx
```jsx
import { useNavigate } from 'react-router-dom';
import { 
  Container,
  Typography,
  Paper,
  Button,
  Divider
} from '@mui/material';
import { 
  Lock as LockIcon,
  Home as HomeIcon
} from '@mui/icons-material';

const Unauthorized = () => {
  const navigate = useNavigate();

  const handleGoHome = () => {
    navigate("/");
  };

  return (
    <Container maxWidth="sm" sx={{ mt: 8 }}>
      <Paper elevation={3} sx={{ p: 4, textAlign: 'center' }}>
        <LockIcon color="error" sx={{ fontSize: 80, mb: 2 }} />
        
        <Typography variant="h4" component="h1" gutterBottom color="error">
          Truy Cáº­p Bá»‹ Tá»« Chá»‘i
        </Typography>
        
        <Typography variant="body1" sx={{ mb: 3 }}>
          Báº¡n khÃ´ng cÃ³ quyá»n truy cáº­p trang nÃ y. Vui lÃ²ng liÃªn há»‡ quáº£n trá»‹ viÃªn náº¿u báº¡n cho ráº±ng Ä‘Ã¢y lÃ  lá»—i.
        </Typography>
        
        <Divider sx={{ my: 3 }} />
        
        <Button
          variant="contained"
          size="large"
          startIcon={<HomeIcon />}
          onClick={handleGoHome}
        >
          Quay Vá» Trang Chá»§
        </Button>
      </Paper>
    </Container>
  );
};

export default Unauthorized;
```

### ClientApp\src\services\ChatSignalRService.js
```js
import { HubConnectionBuilder, LogLevel } from '@microsoft/signalr';

class ChatSignalRService {
    constructor() {
        this.connection = null;
        this.isConnected = false;
        this.connectionId = null;
        this.eventHandlers = {};
    }

    async connect(userId = null, sessionId = null) {
        try {
            // Build connection
            this.connection = new HubConnectionBuilder()
                .withUrl(`${process.env.REACT_APP_API_BASE_URL || 'https://localhost:7157'}/chatHub`, {
                    withCredentials: true,
                    headers: userId ? { 'X-User-Id': userId } : {}
                })
                .withAutomaticReconnect([0, 2000, 10000, 30000])
                .configureLogging(LogLevel.Information)
                .build();

            // Setup event handlers
            this.setupEventHandlers();

            // Start connection
            await this.connection.start();
            this.isConnected = true;
            this.connectionId = this.connection.connectionId;

            console.log('âœ… SignalR Connected:', this.connectionId);

            // Join session if provided
            if (sessionId) {
                await this.joinSession(sessionId);
            }

            return this.connectionId;
        } catch (error) {
            console.error('âŒ SignalR Connection failed:', error);
            throw error;
        }
    }

    setupEventHandlers() {
        // Receive messages
        this.connection.on('ReceiveMessage', (message) => {
            console.log('ğŸ“¨ Message received:', message);
            this.emit('messageReceived', message);
        });

        // AI response
        this.connection.on('ReceiveAIResponse', (response) => {
            console.log('ğŸ¤– AI Response:', response);
            this.emit('aiResponse', response);
        });

        // Session updates
        this.connection.on('SessionUpdated', (session) => {
            console.log('ğŸ”„ Session updated:', session);
            this.emit('sessionUpdated', session);
        });

        // Admin joined
        this.connection.on('AdminJoined', (adminInfo) => {
            console.log('ğŸ‘¨â€ğŸ’¼ Admin joined:', adminInfo);
            this.emit('adminJoined', adminInfo);
        });

        // Typing indicators
        this.connection.on('UserTyping', (info) => {
            this.emit('userTyping', info);
        });

        // Connection state changes
        this.connection.onreconnecting(() => {
            console.log('ğŸ”„ SignalR Reconnecting...');
            this.isConnected = false;
            this.emit('reconnecting');
        });

        this.connection.onreconnected(() => {
            console.log('âœ… SignalR Reconnected');
            this.isConnected = true;
            this.emit('reconnected');
        });

        this.connection.onclose(() => {
            console.log('âŒ SignalR Disconnected');
            this.isConnected = false;
            this.emit('disconnected');
        });
    }

    // Send message
    async sendMessage(sessionId, message, messageType = 'Text') {
        if (!this.isConnected) {
            throw new Error('SignalR not connected');
        }

        try {
            await this.connection.invoke('SendMessage', sessionId, message, messageType);
        } catch (error) {
            console.error('âŒ Failed to send message:', error);
            throw error;
        }
    }

    // Join session
    async joinSession(sessionId) {
        if (!this.isConnected) {
            throw new Error('SignalR not connected');
        }

        try {
            await this.connection.invoke('JoinSession', sessionId);
            console.log(`ğŸ“¨ Joined session: ${sessionId}`);
        } catch (error) {
            console.error('âŒ Failed to join session:', error);
            throw error;
        }
    }

    // Leave session
    async leaveSession(sessionId) {
        if (!this.isConnected) {
            return;
        }

        try {
            await this.connection.invoke('LeaveSession', sessionId);
            console.log(`ğŸ‘‹ Left session: ${sessionId}`);
        } catch (error) {
            console.error('âŒ Failed to leave session:', error);
        }
    }

    // Send typing indicator
    async sendTyping(sessionId, isTyping) {
        if (!this.isConnected) {
            return;
        }

        try {
            await this.connection.invoke('SendTyping', sessionId, isTyping);
        } catch (error) {
            console.error('âŒ Failed to send typing indicator:', error);
        }
    }

    // Event system
    on(event, callback) {
        if (!this.eventHandlers[event]) {
            this.eventHandlers[event] = [];
        }
        this.eventHandlers[event].push(callback);
    }

    off(event, callback) {
        if (this.eventHandlers[event]) {
            this.eventHandlers[event] = this.eventHandlers[event].filter(cb => cb !== callback);
        }
    }

    emit(event, data) {
        if (this.eventHandlers[event]) {
            this.eventHandlers[event].forEach(callback => callback(data));
        }
    }

    // Disconnect
    async disconnect() {
        if (this.connection) {
            await this.connection.stop();
            this.isConnected = false;
            this.connectionId = null;
            console.log('ğŸ‘‹ SignalR Disconnected');
        }
    }

    // Get connection state
    getConnectionState() {
        return {
            isConnected: this.isConnected,
            connectionId: this.connectionId,
            state: this.connection?.state
        };
    }
}

// Export singleton instance
export const chatSignalR = new ChatSignalRService();
export default chatSignalR;

```

### ClientApp\src\utils\ChatTestRunner.js
```js
import { chatSignalR } from '../services/ChatSignalRService';

class ChatTestRunner {
    constructor() {
        this.testResults = [];
        this.currentTestSession = null;
    }

    // Test suite runner
    async runAllTests() {
        console.log('ğŸ§ª Starting AI Chat System Tests...');
        
        const testSuites = [
            this.testBasicConnection,
            this.testAIResponses,
            this.testContextTracking,
            this.testProductSearch,
            this.testOrderInquiry,
            this.testEscalation,
            this.testMultiSession,
            this.testErrorHandling
        ];

        for (const testSuite of testSuites) {
            try {
                await testSuite.call(this);
            } catch (error) {
                console.error(`âŒ Test suite failed: ${testSuite.name}`, error);
                this.testResults.push({
                    suite: testSuite.name,
                    status: 'FAILED',
                    error: error.message
                });
            }
        }

        this.printTestReport();
        return this.testResults;
    }

    // Test 1: Basic Connection
    async testBasicConnection() {
        console.log('ğŸ”— Testing SignalR Connection...');
        
        try {
            await chatSignalR.connect();
            this.assert(chatSignalR.isConnected, 'SignalR should be connected');
            
            this.testResults.push({
                suite: 'Basic Connection',
                status: 'PASSED',
                message: 'SignalR connection established successfully'
            });
        } catch (error) {
            throw new Error(`Connection failed: ${error.message}`);
        }
    }

    // Test 2: AI Responses
    async testAIResponses() {
        console.log('ğŸ¤– Testing AI Response System...');
        
        const testMessages = [
            { input: "Xin chÃ o", expectedIntent: "greeting", minConfidence: 0.8 },
            { input: "TÃ´i muá»‘n mua iPhone", expectedIntent: "product_search", minConfidence: 0.7 },
            { input: "GiÃ¡ Ä‘iá»‡n thoáº¡i bao nhiÃªu", expectedIntent: "price_inquiry", minConfidence: 0.7 },
            { input: "ÄÆ¡n hÃ ng cá»§a tÃ´i á»Ÿ Ä‘Ã¢u", expectedIntent: "order_status", minConfidence: 0.8 },
            { input: "Cáº£m Æ¡n báº¡n", expectedIntent: "thanks", minConfidence: 0.9 }
        ];

        const session = await this.createTestSession();
        let passedTests = 0;

        for (const test of testMessages) {
            const response = await this.sendTestMessage(session.sessionId, test.input);
            
            if (response.intent === test.expectedIntent && response.confidenceScore >= test.minConfidence) {
                passedTests++;
                console.log(`âœ… "${test.input}" -> ${response.intent} (${response.confidenceScore})`);
            } else {
                console.log(`âŒ "${test.input}" -> Expected: ${test.expectedIntent}, Got: ${response.intent}`);
            }
        }

        this.testResults.push({
            suite: 'AI Responses',
            status: passedTests === testMessages.length ? 'PASSED' : 'PARTIAL',
            message: `${passedTests}/${testMessages.length} tests passed`
        });
    }

    // Test 3: Context Tracking
    async testContextTracking() {
        console.log('ğŸ§  Testing Context Tracking...');
        
        const session = await this.createTestSession();
        
        // Conversation sequence
        const conversation = [
            "TÃ´i muá»‘n mua iPhone",
            "GiÃ¡ bao nhiÃªu?", // Should understand "giÃ¡ iPhone"
            "CÃ³ mÃ u Ä‘á» khÃ´ng?", // Should understand "iPhone mÃ u Ä‘á»"
            "TÃ´i mua luÃ´n" // Should understand purchase intent for iPhone
        ];

        let contextMaintained = true;
        
        for (let i = 0; i < conversation.length; i++) {
            const response = await this.sendTestMessage(session.sessionId, conversation[i]);
            
            if (i > 0 && !response.context?.includes('iPhone')) {
                contextMaintained = false;
                break;
            }
        }

        this.testResults.push({
            suite: 'Context Tracking',
            status: contextMaintained ? 'PASSED' : 'FAILED',
            message: contextMaintained ? 'Context maintained throughout conversation' : 'Context lost during conversation'
        });
    }

    // Test 4: Product Search
    async testProductSearch() {
        console.log('ğŸ” Testing Product Search...');
        
        const session = await this.createTestSession();
        const searchQueries = [
            "TÃ¬m iPhone 15",
            "Laptop Dell gaming",
            "Tai nghe Sony",
            "Äiá»‡n thoáº¡i Samsung dÆ°á»›i 10 triá»‡u"
        ];

        let successfulSearches = 0;

        for (const query of searchQueries) {
            const response = await this.sendTestMessage(session.sessionId, query);
            
            if (response.productRecommendations && response.productRecommendations.length > 0) {
                successfulSearches++;
            }
        }

        this.testResults.push({
            suite: 'Product Search',
            status: successfulSearches === searchQueries.length ? 'PASSED' : 'PARTIAL',
            message: `${successfulSearches}/${searchQueries.length} searches returned products`
        });
    }

    // Test 5: Order Inquiry
    async testOrderInquiry() {
        console.log('ğŸ“¦ Testing Order Inquiry...');
        
        const session = await this.createTestSession('user123'); // Mock user ID
        const response = await this.sendTestMessage(session.sessionId, "ÄÆ¡n hÃ ng cá»§a tÃ´i á»Ÿ Ä‘Ã¢u?");
        
        const hasOrderInfo = response.intent === 'order_status' && 
                           (response.message.includes('Ä‘Æ¡n hÃ ng') || response.message.includes('order'));

        this.testResults.push({
            suite: 'Order Inquiry',
            status: hasOrderInfo ? 'PASSED' : 'FAILED',
            message: hasOrderInfo ? 'Order status inquiry handled correctly' : 'Order inquiry not recognized'
        });
    }

    // Test 6: Escalation
    async testEscalation() {
        console.log('ğŸš¨ Testing Escalation Logic...');
        
        const session = await this.createTestSession();
        
        // Send complex query that should trigger escalation
        const complexQuery = "TÃ´i cÃ³ váº¥n Ä‘á» phá»©c táº¡p vá»›i sáº£n pháº©m xyz123 khÃ´ng cÃ³ trong danh sÃ¡ch";
        const response = await this.sendTestMessage(session.sessionId, complexQuery);
        
        const shouldEscalate = response.confidenceScore < 0.4 || response.requiresEscalation;

        this.testResults.push({
            suite: 'Escalation Logic',
            status: shouldEscalate ? 'PASSED' : 'FAILED',
            message: shouldEscalate ? 'Low confidence query triggered escalation' : 'Escalation not triggered when expected'
        });
    }

    // Test 7: Multi-Session
    async testMultiSession() {
        console.log('ğŸ‘¥ Testing Multi-Session Support...');
        
        const sessions = await Promise.all([
            this.createTestSession('user1'),
            this.createTestSession('user2'),
            this.createTestSession('user3')
        ]);

        const responses = await Promise.all(
            sessions.map(session => 
                this.sendTestMessage(session.sessionId, "Xin chÃ o")
            )
        );

        const allResponded = responses.every(response => response && response.message);

        this.testResults.push({
            suite: 'Multi-Session Support',
            status: allResponded ? 'PASSED' : 'FAILED',
            message: allResponded ? 'All sessions handled concurrently' : 'Some sessions failed to respond'
        });
    }

    // Test 8: Error Handling
    async testErrorHandling() {
        console.log('âš ï¸ Testing Error Handling...');
        
        const session = await this.createTestSession();
        
        try {
            // Test with empty message
            await this.sendTestMessage(session.sessionId, "");
            
            // Test with very long message
            const longMessage = "a".repeat(10000);
            await this.sendTestMessage(session.sessionId, longMessage);
            
            // Test with special characters
            await this.sendTestMessage(session.sessionId, "!@#$%^&*()_+{}|:<>?");
            
            this.testResults.push({
                suite: 'Error Handling',
                status: 'PASSED',
                message: 'System handled edge cases gracefully'
            });
        } catch (error) {
            this.testResults.push({
                suite: 'Error Handling',
                status: 'FAILED',
                message: `Error handling failed: ${error.message}`
            });
        }
    }

    // Helper Methods
    async createTestSession(userId = null) {
        const response = await fetch('/api/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: userId,
                type: 'AI',
                isTest: true
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to create test session');
        }
        
        return await response.json();
    }

    async sendTestMessage(sessionId, message) {
        const response = await fetch('/api/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                sessionId: sessionId,
                message: message,
                type: 'Text'
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to send test message');
        }
        
        return await response.json();
    }

    assert(condition, message) {
        if (!condition) {
            throw new Error(`Assertion failed: ${message}`);
        }
    }

    printTestReport() {
        console.log('\nğŸ“Š TEST REPORT');
        console.log('='.repeat(50));
        
        const passed = this.testResults.filter(r => r.status === 'PASSED').length;
        const failed = this.testResults.filter(r => r.status === 'FAILED').length;
        const partial = this.testResults.filter(r => r.status === 'PARTIAL').length;
        
        console.log(`âœ… Passed: ${passed}`);
        console.log(`âŒ Failed: ${failed}`);
        console.log(`âš ï¸ Partial: ${partial}`);
        console.log(`ğŸ“ˆ Success Rate: ${Math.round((passed / this.testResults.length) * 100)}%`);
        
        console.log('\nDetailed Results:');
        this.testResults.forEach(result => {
            const icon = result.status === 'PASSED' ? 'âœ…' : result.status === 'FAILED' ? 'âŒ' : 'âš ï¸';
            console.log(`${icon} ${result.suite}: ${result.message}`);
        });
    }
}

// Export for use in development
export const runChatTests = async () => {
    const tester = new ChatTestRunner();
    return await tester.runAllTests();
};

export default ChatTestRunner;

```

### ClientApp\src\utils\formatCurrency.js
```js
export const formatCurrency = (amount) => {
  return new Intl.NumberFormat('vi-VN', {
    style: 'currency',
    currency: 'VND'
  }).format(amount);
};
```

### ClientApp\src\utils\FormatInfo.js
```js
import { Chip } from '@mui/material'; // Import Chip náº¿u cáº§n sá»­ dá»¥ng trong cÃ¡c component khÃ¡c

// HÃ m Ä‘á»‹nh dáº¡ng tiá»n tá»‡
const formatCurrency = (amount) => {
  if (typeof amount !== 'number') return 'N/A';
  return amount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
};

// HÃ m Ä‘á»‹nh dáº¡ng ngÃ y thÃ¡ng
const formatDate = (dateString) => {
  if (!dateString) return 'N/A';
  try {
    const date = new Date(dateString);
    if (isNaN(date)) throw new Error('Invalid date');
    return date.toLocaleDateString('vi-VN', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  } catch {
    return 'NgÃ y khÃ´ng há»£p lá»‡';
  }
};

// HÃ m Ä‘á»‹nh dáº¡ng Ä‘á»‹a chá»‰
const formatAddress = (address) => {
  if (!address || typeof address !== 'object') return 'ChÆ°a cÃ³ thÃ´ng tin Ä‘á»‹a chá»‰';
  const parts = [
    address.addressLine1,
    address.addressLine2,
    address.city,
    address.state,
    address.zipCode,
    address.country,
  ].filter(Boolean); // Lá»c bá» cÃ¡c pháº§n tá»­ rá»—ng hoáº·c null/undefined
  return parts.join(', ');
};

// HÃ m láº¥y mÃ u cho tráº¡ng thÃ¡i
const getStatusColor = (status) => {
  switch (status?.toLowerCase()) {
    case 'delivered': return 'success';
    case 'processing': return 'info';
    case 'shipped': return 'primary';
    case 'cancelled': return 'error';
    case 'pending': return 'warning';
    default: return 'default'; // MÃ u máº·c Ä‘á»‹nh
  }
};

// HÃ m láº¥y tÃªn hiá»ƒn thá»‹ cá»§a tráº¡ng thÃ¡i
const getStatusDisplayName = (status) => {
  switch (status) {
      case "Pending": return "Chá» xÃ¡c nháº­n";
      case "Processing": return "ÄÃ£ xÃ¡c nháº­n";
      case "Shipped": return "Äang váº­n chuyá»ƒn";
      case "Delivered": return "ÄÃ£ xong";
      case "Cancelled": return "ÄÃ£ há»§y";
      case "WaitingForPayment": return "Chá» thanh toÃ¡n";
      case "Paid": return "ÄÃ£ thanh toÃ¡n";
      case "ShippedPayment": return "Äang váº­n chuyá»ƒn (Ä‘Ã£ thanh toÃ¡n)";
      default: return status;
  }
};

// Mapping ID phÆ°Æ¡ng thá»©c thanh toÃ¡n sang tÃªn
const paymentMethodMap = {
  1: 'Tiá»n máº·t',
  2: 'MoMo',
  3: 'PayPal',
  // ThÃªm cÃ¡c phÆ°Æ¡ng thá»©c khÃ¡c náº¿u cáº§n
};

const getPaymentMethodName = (id) => paymentMethodMap[id] || 'KhÃ´ng xÃ¡c Ä‘á»‹nh';

// Component hiá»ƒn thá»‹ Chip tráº¡ng thÃ¡i
const StatusChip = ({ status }) => (
  <Chip
    label={status || 'Unknown'}
    color={getStatusColor(status)}
    size="small"
  />
);
// HÃ m xÃ¡c Ä‘á»‹nh cÃ¡c tráº¡ng thÃ¡i Ä‘Æ°á»£c phÃ©p chuyá»ƒn Ä‘á»•i
const getAllowedStatuses = (currentStatus) => {
  switch (currentStatus) {
      case "Pending": return ["Processing", "Cancelled"];
      case "Processing": return ["Shipped", "Cancelled"];
      case "Shipped": return ["Delivered"];
      case "WaitingForPayment": return ["Paid", "Cancelled"];
      case "Paid": return ["ShippedPayment"];
      case "ShippedPayment": return ["Delivered"];
      default: return [];
  }
};
// HÃ m láº¥y mÃ u tráº¡ng thÃ¡i cho chip (vÃ­ dá»¥)
const getStatusChipClass = (status) => {
  switch (status) {
    case "Delivered": return "bg-green-100 text-green-800 hover:bg-green-200";
    case "Processing": return "bg-blue-100 text-blue-800 hover:bg-blue-200"; // Thay Processing sang Blue
    case "Shipped": return "bg-yellow-100 text-yellow-800 hover:bg-yellow-200"; // Thay Shipped sang Yellow
    case "ShippedPayment": return "bg-yellow-100 text-yellow-800 hover:bg-yellow-200";
    case "Paid": return "bg-purple-100 text-purple-800 hover:bg-purple-200"; // ThÃªm mÃ u Paid
    case "WaitingForPayment": return "bg-orange-100 text-orange-800 hover:bg-orange-200"; // ThÃªm mÃ u chá» thanh toÃ¡n
    case "Pending": return "bg-gray-100 text-gray-800 hover:bg-gray-200"; // ThÃªm mÃ u Pending
    case "Cancelled": return "bg-red-100 text-red-800 hover:bg-red-200";
    default: return "bg-gray-100 text-gray-800 hover:bg-gray-200";
  }
};

// (CÃ³ thá»ƒ Ä‘áº·t á»Ÿ ngoÃ i component hoáº·c trong file utils.js)
const getFormattedDateString = (date) => {
  return date.toISOString().split("T")[0];
};

const getDateNDaysAgo = (daysAgo) => {
  const date = new Date(); // Láº¥y ngÃ y giá» hiá»‡n táº¡i theo mÃºi giá» cá»§a client
  date.setDate(date.getDate() - daysAgo);
  return getFormattedDateString(date);
};

const getToday = () => {
  return getFormattedDateString(new Date());
};
export {
  formatCurrency,
  formatDate,
  formatAddress,
  getStatusColor,
  getPaymentMethodName,
  StatusChip,
  getStatusChipClass,
  getStatusDisplayName,
  getAllowedStatuses,
  getDateNDaysAgo,
  getToday,
};
```

### ClientApp\src\utils\timezoneTest.js
```js
// Timezone Test Utility
// This file helps debug and verify timezone formatting

// Test current time formatting
export const testTimezoneFormatting = () => {
  const now = new Date();
  const utcTime = new Date().toISOString();

  console.log("=== TIMEZONE FORMATTING TEST ===");
  console.log("Current local time:", now.toString());
  console.log("UTC time (ISO):", utcTime);

  // Test Vietnam timezone formatting
  const vietnamTime = now.toLocaleTimeString("vi-VN", {
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    timeZone: "Asia/Ho_Chi_Minh",
    hour12: false,
  });

  const vietnamDate = now.toLocaleDateString("vi-VN", {
    month: "2-digit",
    day: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    timeZone: "Asia/Ho_Chi_Minh",
    hour12: false,
  });

  console.log("Vietnam time (UTC+7):", vietnamTime);
  console.log("Vietnam date (UTC+7):", vietnamDate);

  // Test with a sample UTC timestamp like what would come from backend
  const sampleBackendTime = "2025-07-02T10:30:00.000Z"; // Sample UTC time
  const parsedTime = new Date(sampleBackendTime);

  const formattedSampleTime = parsedTime.toLocaleTimeString("vi-VN", {
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    timeZone: "Asia/Ho_Chi_Minh",
    hour12: false,
  });

  console.log("Sample backend timestamp:", sampleBackendTime);
  console.log("Formatted to Vietnam time:", formattedSampleTime);
  console.log("==================================");

  return {
    utcTime,
    vietnamTime,
    vietnamDate,
    sampleBackendTime,
    formattedSampleTime,
  };
};

// Utility functions matching AdminChatDashboard.jsx
export const formatVietnamTime = (dateString) => {
  if (!dateString) return "";
  try {
    const date = new Date(dateString);
    return date.toLocaleTimeString("vi-VN", {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      timeZone: "Asia/Ho_Chi_Minh",
      hour12: false,
    });
  } catch (error) {
    console.error("Error formatting time:", error);
    return "";
  }
};

export const formatVietnamDate = (dateString) => {
  if (!dateString) return "";
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString("vi-VN", {
      month: "2-digit",
      day: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      timeZone: "Asia/Ho_Chi_Minh",
      hour12: false,
    });
  } catch (error) {
    console.error("Error formatting date:", error);
    return "";
  }
};

// Test function to verify the current time vs a UTC timestamp
export const compareTimezones = (utcTimestamp) => {
  const utcDate = new Date(utcTimestamp);
  const localTime = utcDate.toLocaleString();
  const vietnamTime = formatVietnamTime(utcTimestamp);
  const vietnamDate = formatVietnamDate(utcTimestamp);

  console.log("UTC Timestamp:", utcTimestamp);
  console.log("Local time:", localTime);
  console.log("Vietnam time (UTC+7):", vietnamTime);
  console.log("Vietnam date (UTC+7):", vietnamDate);

  return { localTime, vietnamTime, vietnamDate };
};

```

### ClientApp\src\utils\useDebounce.js
```js
// useDebounce.js
import { useState, useEffect } from 'react';

function useDebounce(value, delay) {
  const [debouncedValue, setDebouncedValue] = useState(value);

  useEffect(() => {
    // Thiáº¿t láº­p má»™t timeout Ä‘á»ƒ cáº­p nháº­t giÃ¡ trá»‹ Ä‘Ã£ debounce sau khoáº£ng thá»i gian delay
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);

    // Há»§y timeout náº¿u value hoáº·c delay thay Ä‘á»•i, hoáº·c khi component unmount
    // Äiá»u nÃ y quan trá»ng Ä‘á»ƒ trÃ¡nh cáº­p nháº­t state trÃªn má»™t component Ä‘Ã£ unmount
    // hoáº·c khi giÃ¡ trá»‹ thay Ä‘á»•i nhanh chÃ³ng.
    return () => {
      clearTimeout(handler);
    };
  }, [value, delay]); // Chá»‰ cháº¡y láº¡i effect náº¿u value hoáº·c delay thay Ä‘á»•i

  return debouncedValue;
}

export default useDebounce;
```

### Configuration\CorsConfiguration.cs
```cs
using Microsoft.AspNetCore.Cors.Infrastructure;

namespace SHN_Gear.Configuration
{
    public static class CorsConfiguration
    {
        public static void ConfigureCors(this IServiceCollection services, IWebHostEnvironment environment)
        {
            services.AddCors(options =>
            {
                options.AddPolicy("AllowFrontend", policy =>
                {
                    var allowedOrigins = new[]
                    {
                        "https://localhost:44479",
                        "http://localhost:3000", 
                        "https://localhost:3001",
                        "https://localhost:7107",
                        "http://localhost:5067"
                    };

                    policy.WithOrigins(allowedOrigins)
                          .AllowAnyHeader()
                          .AllowAnyMethod()
                          .AllowCredentials()
                          .SetPreflightMaxAge(TimeSpan.FromSeconds(2520)); // Cache preflight for 42 minutes
                });

                // Policy riÃªng cho SignalR vá»›i cáº¥u hÃ¬nh tá»‘i Æ°u
                options.AddPolicy("SignalRPolicy", policy =>
                {
                    var allowedOrigins = new[]
                    {
                        "https://localhost:44479",
                        "http://localhost:3000", 
                        "https://localhost:3001",
                        "https://localhost:7107",
                        "http://localhost:5067"
                    };

                    policy.WithOrigins(allowedOrigins)
                          .WithHeaders("Content-Type", "Authorization", "x-requested-with", "x-signalr-user-agent", 
                                     "Cache-Control", "X-Requested-With", "Accept", "Origin", "User-Agent", "DNT", "Keep-Alive")
                          .WithMethods("GET", "POST", "PUT", "DELETE", "OPTIONS", "HEAD", "PATCH")
                          .AllowCredentials()
                          .SetPreflightMaxAge(TimeSpan.FromSeconds(2520));
                });
            });
        }

        public static void UseCorsConfiguration(this WebApplication app)
        {
            // Custom CORS middleware Ä‘á»ƒ xá»­ lÃ½ SignalR headers
            app.Use(async (context, next) =>
            {
                var origin = context.Request.Headers["Origin"].ToString();
                var isSignalRRequest = context.Request.Path.StartsWithSegments("/chatHub");
                
                if (!string.IsNullOrEmpty(origin))
                {
                    // Kiá»ƒm tra náº¿u origin Ä‘Æ°á»£c phÃ©p
                    var allowedOrigins = new[]
                    {
                        "https://localhost:44479",
                        "http://localhost:3000", 
                        "https://localhost:3001",
                        "https://localhost:7107",
                        "http://localhost:5067"
                    };

                    if (allowedOrigins.Contains(origin))
                    {
                        context.Response.Headers["Access-Control-Allow-Origin"] = origin;
                        context.Response.Headers["Access-Control-Allow-Credentials"] = "true";
                        
                        // Äáº·c biá»‡t xá»­ lÃ½ headers cho SignalR
                        if (isSignalRRequest)
                        {
                            context.Response.Headers["Access-Control-Allow-Headers"] = 
                                "Content-Type, Authorization, x-requested-with, x-signalr-user-agent, Cache-Control";
                        }
                        else
                        {
                            context.Response.Headers["Access-Control-Allow-Headers"] = "*";
                        }
                        
                        context.Response.Headers["Access-Control-Allow-Methods"] = "GET, POST, PUT, DELETE, OPTIONS";
                        context.Response.Headers["Access-Control-Max-Age"] = "2520";
                    }
                }

                // Xá»­ lÃ½ preflight requests
                if (context.Request.Method == "OPTIONS")
                {
                    context.Response.StatusCode = 200;
                    return;
                }

                await next();
            });

            app.UseCors("AllowFrontend");

            // CORS logging cho debugging
            if (app.Environment.IsDevelopment())
            {
                app.Use(async (context, next) =>
                {
                    var origin = context.Request.Headers["Origin"].ToString();
                    var method = context.Request.Method;
                    var path = context.Request.Path;
                    var headers = string.Join(", ", context.Request.Headers.Keys);
                    
                    Console.WriteLine($"[CORS] {method} {path} from {origin}");
                    Console.WriteLine($"[CORS] Headers: {headers}");
                    
                    await next();
                });
            }
        }
    }
}

```

### Controllers\AddressController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.Models;
using SHN_Gear.DTOs;
using System.Threading.Tasks;

namespace SHN_Gear.Controllers
{
    [ApiController]
    [Route("api/address")]
    public class AddressController : ControllerBase
    {
        private readonly AppDbContext _context;

        public AddressController(AppDbContext context)
        {
            _context = context;
        }

        // ThÃªm Ä‘á»‹a chá»‰ má»›i
        [HttpPost("add")]
        public async Task<IActionResult> AddAddress([FromBody] Address address)
        {
            if (address.UserId.HasValue)
            {
                var user = await _context.Users.FindAsync(address.UserId.Value);
                if (user == null)
                {
                    return NotFound("NgÆ°á»i dÃ¹ng khÃ´ng tá»“n táº¡i.");
                }
            }

            _context.Addresses.Add(address);
            await _context.SaveChangesAsync();

            return Ok(new { Message = "Äá»‹a chá»‰ Ä‘Ã£ Ä‘Æ°á»£c thÃªm.", AddressId = address.Id });
        }

        // Láº¥y Ä‘á»‹a chá»‰ theo UserId
        [HttpGet("user/{userId}")]
        public async Task<IActionResult> GetAddressesByUserId(int userId)
        {
            var addresses = await _context.Addresses
                .Where(a => a.UserId == userId)
                .ToListAsync();

            return Ok(addresses);
        }

        // Láº¥y Ä‘á»‹a chá»‰ theo AddressId
        [HttpGet("{id}")]
        public async Task<IActionResult> GetAddressById(int id)
        {
            var address = await _context.Addresses.FindAsync(id);

            if (address == null)
            {
                return NotFound("Äá»‹a chá»‰ khÃ´ng tá»“n táº¡i.");
            }

            return Ok(address);
        }

        // Cáº­p nháº­t Ä‘á»‹a chá»‰
        [HttpPut("update/{id}")]
        public async Task<IActionResult> UpdateAddress(int id, [FromBody] CreateAddressDTO addressDTO)
        {
            var address = await _context.Addresses.FindAsync(id);
            if (address == null)
            {
                return NotFound("Äá»‹a chá»‰ khÃ´ng tá»“n táº¡i.");
            }

            address.FullName = addressDTO.FullName;
            address.PhoneNumber = addressDTO.PhoneNumber;
            address.AddressLine1 = addressDTO.AddressLine1;
            address.AddressLine2 = addressDTO.AddressLine2;
            address.City = addressDTO.City;
            address.State = addressDTO.State;
            address.ZipCode = addressDTO.ZipCode;
            address.Country = addressDTO.Country;

            _context.Addresses.Update(address);
            await _context.SaveChangesAsync();

            return Ok(address);
        }

        // XÃ³a Ä‘á»‹a chá»‰
        [HttpDelete("delete/{id}")]
        public async Task<IActionResult> DeleteAddress(int id)
        {
            var address = await _context.Addresses.FindAsync(id);
            if (address == null)
            {
                return NotFound("Äá»‹a chá»‰ khÃ´ng tá»“n táº¡i.");
            }

            _context.Addresses.Remove(address);
            await _context.SaveChangesAsync();

            return Ok("Äá»‹a chá»‰ Ä‘Ã£ Ä‘Æ°á»£c xÃ³a.");
        }
    }
}

```

### Controllers\AuthController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.IdentityModel.Tokens;
using SHN_Gear.Services;
using SHN_Gear.Models;
using SHN_Gear.DTOs;
using System;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;
using System.Threading.Tasks;
using Microsoft.Extensions.Configuration;
using Microsoft.AspNetCore.Cors;
using Microsoft.AspNetCore.Authorization;

namespace SHN_Gear.Controllers
{
    [Route("api/[controller]")]
    [EnableCors("AllowFrontend")]
    [ApiController]
    public class AuthController : ControllerBase
    {
        private readonly UserService _userService;
        private readonly EmailService _emailService;
        private readonly IConfiguration _config;

        public AuthController(UserService userService, EmailService emailService, IConfiguration config)
        {
            _userService = userService;
            _emailService = emailService;
            _config = config;
        }

        // Kiá»ƒm tra email cÃ³ tá»“n táº¡i khÃ´ng
        [HttpPost("check-email")]
        public async Task<IActionResult> CheckEmailExists([FromBody] EmailDto emailDto)
        {
            if (!ModelState.IsValid || string.IsNullOrEmpty(emailDto.Email))
                return BadRequest(new { message = "Email khÃ´ng há»£p lá»‡" });

            bool exists = await _userService.CheckEmailExistsAsync(emailDto.Email);
            return Ok(new { exists });
        }

        // ÄÄƒng kÃ½ tÃ i khoáº£n
        [HttpPost("register")]
        public async Task<IActionResult> Register([FromBody] RegisterDto registerDto)
        {
            if (!ModelState.IsValid)
                return BadRequest(new { message = "Dá»¯ liá»‡u khÃ´ng há»£p lá»‡" });

            var result = await _userService.RegisterUserAsync(registerDto);
            if (!result)
                return BadRequest(new { message = "Email Ä‘Ã£ tá»“n táº¡i" });

            return Ok(new { message = "ÄÄƒng kÃ½ thÃ nh cÃ´ng" });
        }

        // ÄÄƒng nháº­p báº±ng Email
        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginDto loginDto)
        {
            if (!ModelState.IsValid)
                return BadRequest(new { message = "Dá»¯ liá»‡u khÃ´ng há»£p lá»‡" });

            var user = await _userService.AuthenticateUserAsync(loginDto);
            if (user == null)
                return Unauthorized(new { message = "Sai email hoáº·c máº­t kháº©u" });

            var token = GenerateJwtToken(user);
            return Ok(new { token });
        }

        // Gá»­i OTP qua Email
        [HttpPost("send-otp")]
        public async Task<IActionResult> SendOtp([FromBody] OtpRequestDto otpDto)
        {
            if (!ModelState.IsValid || string.IsNullOrEmpty(otpDto.Email))
                return BadRequest(new { message = "Email khÃ´ng há»£p lá»‡" });

            var success = await _emailService.SendOTPAsync(otpDto.Email);
            if (!success)
                return BadRequest(new { message = "Gá»­i OTP tháº¥t báº¡i" });

            return Ok(new { message = "OTP Ä‘Ã£ Ä‘Æ°á»£c gá»­i" });
        }
        // ğŸ”¹ API láº¥y thÃ´ng tin ngÆ°á»i dÃ¹ng Ä‘ang Ä‘Äƒng nháº­p
        [HttpGet("profile")]
        [Authorize]
        public async Task<IActionResult> GetProfile()
        {
            var userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                return Unauthorized(new { message = "KhÃ´ng tÃ¬m tháº¥y ID trong token" });
            }

            var user = _userService.GetUserById(int.Parse(userId));

            if (user == null)
            {
                return NotFound(new { message = "User khÃ´ng tá»“n táº¡i" });
            }

            return Ok(new
            {
                user.Id,
                user.FullName,
                user.Email,
                user.PhoneNumber,
                user.Gender,
                DateOfBirth = user.DateOfBirth?.ToString("yyyy-MM-dd")
            });
        }
        // ğŸ”¹ API chá»‰nh sá»­a thÃ´ng tin cÃ¡ nhÃ¢n
        [HttpPut("profile")]
        [Authorize]
        public async Task<IActionResult> UpdateProfile([FromBody] EditProfileDto editDto)
        {
            var userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userId))
                return Unauthorized();

            var updatedUser = await _userService.UpdateUserProfileAsync(int.Parse(userId), editDto);
            if (updatedUser == null)
                return BadRequest();

            return Ok(new
            {
                updatedUser.Id,
                updatedUser.FullName,
                updatedUser.Email,
                updatedUser.PhoneNumber,
                updatedUser.Gender,
                DateOfBirth = updatedUser.DateOfBirth?.ToString("yyyy-MM-dd")
            });
        }

        // ğŸ”¹ API chá»‰nh sá»­a thÃ´ng tin cÃ¡ nhÃ¢n
        [HttpPut("profile/{id}")]
        [Authorize]
        public async Task<IActionResult> EditProfile([FromBody] EditProfileDto editDto)
        {
            var userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userId))
                return Unauthorized();

            var updatedUser = await _userService.UpdateUserProfileAsync(int.Parse(userId), editDto);
            if (updatedUser == null)
                return BadRequest();

            return Ok(new
            {
                updatedUser.Id,
                updatedUser.FullName,
                updatedUser.Email,
                updatedUser.PhoneNumber,
                updatedUser.Gender,
                DateOfBirth = updatedUser.DateOfBirth?.ToString("yyyy-MM-dd")
            });
        }



        // Táº¡o JWT Token
        private string GenerateJwtToken(User user)
        {
            var key = Encoding.UTF8.GetBytes(_config["Jwt:Key"]);
            var roleName = user.Role?.Name ?? "User";

            var claims = new[]
            {
                new Claim(JwtRegisteredClaimNames.Sub, user.Id.ToString()),
                new Claim(JwtRegisteredClaimNames.Email, user.Email),
                // Chá»‰ dÃ¹ng Má»˜T trong hai cÃ¡ch sau:
                
                new Claim("roleId", user.RoleId.ToString()), // Quan trá»ng
                new Claim(ClaimTypes.Role, user.Role?.Name ?? "User"),
                new Claim("http://schemas.microsoft.com/.../role", user.Role?.Name ?? "User"),
                new Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString())
            };

            var token = new JwtSecurityToken(
                issuer: _config["Jwt:Issuer"],
                audience: _config["Jwt:Audience"],
                claims: claims,
                expires: DateTime.UtcNow.AddHours(3),
                signingCredentials: new SigningCredentials(
                    new SymmetricSecurityKey(key),
                    SecurityAlgorithms.HmacSha256)
            );

            return new JwtSecurityTokenHandler().WriteToken(token);
        }
    }
}
```

### Controllers\BlogPostsController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.Models;
using SHN_Gear.DTOs;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization;
using System.Security.Claims;

namespace SHN_Gear.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class BlogPostsController : ControllerBase
    {
        private readonly AppDbContext _context;

        public BlogPostsController(AppDbContext context)
        {
            _context = context;
        }

        // GET: api/BlogPosts
        [HttpGet]
        public async Task<ActionResult<IEnumerable<BlogPostDto>>> GetBlogPosts()
        {
            var blogPosts = await _context.BlogPosts
                .Include(bp => bp.Author)
                .Select(bp => new BlogPostDto
                {
                    Id = bp.Id,
                    Title = bp.Title,
                    Content = bp.Content,
                    AuthorId = bp.AuthorId,
                    AuthorName = bp.Author.FullName, // Using FullName property from User model
                    CreatedAt = bp.CreatedAt,
                    UpdatedAt = bp.UpdatedAt,
                    IsPublished = bp.IsPublished
                })
                .ToListAsync();
            return Ok(blogPosts);
        }

        // GET: api/BlogPosts/5
        [HttpGet("{id}")]
        public async Task<ActionResult<BlogPostDto>> GetBlogPost(int id)
        {
            var blogPost = await _context.BlogPosts
                .Include(bp => bp.Author)
                .Where(bp => bp.Id == id)
                .Select(bp => new BlogPostDto
                {
                    Id = bp.Id,
                    Title = bp.Title,
                    Content = bp.Content,
                    AuthorId = bp.AuthorId,
                    AuthorName = bp.Author.FullName,
                    CreatedAt = bp.CreatedAt,
                    UpdatedAt = bp.UpdatedAt,
                    IsPublished = bp.IsPublished
                })
                .FirstOrDefaultAsync();

            if (blogPost == null)
            {
                return NotFound();
            }

            return Ok(blogPost);
        }

        // POST: api/BlogPosts
        [HttpPost]
        [Authorize(Roles = "Admin")] // Only Admins can create blog posts
        public async Task<ActionResult<BlogPostDto>> CreateBlogPost(CreateBlogPostDto createBlogPostDto)
        {
            var userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (userId == null) return Unauthorized();

            var blogPost = new BlogPost
            {
                Title = createBlogPostDto.Title,
                Content = createBlogPostDto.Content,
                AuthorId = int.Parse(userId),
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow,
                IsPublished = createBlogPostDto.IsPublished
            };

            _context.BlogPosts.Add(blogPost);
            await _context.SaveChangesAsync();

            var createdBlogPost = await _context.BlogPosts
                .Include(bp => bp.Author)
                .Where(bp => bp.Id == blogPost.Id)
                .Select(bp => new BlogPostDto
                {
                    Id = bp.Id,
                    Title = bp.Title,
                    Content = bp.Content,
                    AuthorId = bp.AuthorId,
                    AuthorName = bp.Author.FullName,
                    CreatedAt = bp.CreatedAt,
                    UpdatedAt = bp.UpdatedAt,
                    IsPublished = bp.IsPublished
                })
                .FirstOrDefaultAsync();

            return CreatedAtAction(nameof(GetBlogPost), new { id = createdBlogPost.Id }, createdBlogPost);
        }

        // PUT: api/BlogPosts/5
        [HttpPut("{id}")]
        [Authorize(Roles = "Admin")] // Only Admins can update blog posts
        public async Task<IActionResult> UpdateBlogPost(int id, UpdateBlogPostDto updateBlogPostDto)
        {
            var blogPost = await _context.BlogPosts.FindAsync(id);

            if (blogPost == null)
            {
                return NotFound();
            }

            blogPost.Title = updateBlogPostDto.Title;
            blogPost.Content = updateBlogPostDto.Content;
            blogPost.UpdatedAt = DateTime.UtcNow;
            blogPost.IsPublished = updateBlogPostDto.IsPublished;

            try
            {
                await _context.SaveChangesAsync();
            }
            catch (DbUpdateConcurrencyException)
            {
                if (!BlogPostExists(id))
                {
                    return NotFound();
                }
                else
                {
                    throw;
                }
            }

            return NoContent();
        }

        // DELETE: api/BlogPosts/5
        [HttpDelete("{id}")]
        [Authorize(Roles = "Admin")] // Only Admins can delete blog posts
        public async Task<IActionResult> DeleteBlogPost(int id)
        {
            var blogPost = await _context.BlogPosts.FindAsync(id);
            if (blogPost == null)
            {
                return NotFound();
            }

            _context.BlogPosts.Remove(blogPost);
            await _context.SaveChangesAsync();

            return NoContent();
        }

        private bool BlogPostExists(int id)
        {
            return _context.BlogPosts.Any(e => e.Id == id);
        }
    }
}

```

### Controllers\BrandController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.Models;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace SHN_Gear.Controllers
{
    [Route("api/brands")]
    [ApiController]
    public class BrandController : ControllerBase
    {
        private readonly AppDbContext _context;

        public BrandController(AppDbContext context)
        {
            _context = context;
        }

        // Láº¥y táº¥t cáº£ thÆ°Æ¡ng hiá»‡u
        [HttpGet]
        public async Task<ActionResult<IEnumerable<Brand>>> GetBrands()
        {
            var brands = await _context.Brands.ToListAsync();
            return Ok(brands);
        }

        // Láº¥y thÆ°Æ¡ng hiá»‡u theo Id
        [HttpGet("{id}")]
        public async Task<ActionResult<Brand>> GetBrand(int id)
        {
            var brand = await _context.Brands.FindAsync(id);
            if (brand == null)
            {
                return NotFound();
            }
            return Ok(brand);
        }

        // ThÃªm thÆ°Æ¡ng hiá»‡u má»›i
        [HttpPost]
        public async Task<ActionResult<Brand>> CreateBrand(Brand brand)
        {
            _context.Brands.Add(brand);
            await _context.SaveChangesAsync();
            return CreatedAtAction(nameof(GetBrand), new { id = brand.Id }, brand);
        }

        // Cáº­p nháº­t thÆ°Æ¡ng hiá»‡u
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateBrand(int id, Brand brand)
        {
            if (id != brand.Id)
            {
                return BadRequest();
            }

            _context.Entry(brand).State = EntityState.Modified;

            try
            {
                await _context.SaveChangesAsync();
            }
            catch (DbUpdateConcurrencyException)
            {
                if (!_context.Brands.Any(e => e.Id == id))
                {
                    return NotFound();
                }
                else
                {
                    throw;
                }
            }

            return NoContent();
        }

        // XÃ³a thÆ°Æ¡ng hiá»‡u
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteBrand(int id)
        {
            var brand = await _context.Brands.FindAsync(id);
            if (brand == null)
            {
                return NotFound();
            }

            // Kiá»ƒm tra xem cÃ³ sáº£n pháº©m nÃ o thuá»™c thÆ°Æ¡ng hiá»‡u nÃ y khÃ´ng
            var hasProducts = await _context.Products.AnyAsync(p => p.BrandId == id);
            if (hasProducts)
            {
                return BadRequest("KhÃ´ng thá»ƒ xÃ³a thÆ°Æ¡ng hiá»‡u nÃ y vÃ¬ cÃ³ sáº£n pháº©m thuá»™c thÆ°Æ¡ng hiá»‡u nÃ y.");
            }

            _context.Brands.Remove(brand);
            await _context.SaveChangesAsync();
            return NoContent();
        }
    }
}
```

### Controllers\CartController.cs
```cs
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.Json;
using System.Threading.Tasks;
using SHN_Gear.Data;
using SHN_Gear.DTOs;

namespace SHN_Gear.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class CartController : ControllerBase
    {
        private readonly AppDbContext _context;
        private readonly IHttpContextAccessor _httpContextAccessor;

        public CartController(AppDbContext context, IHttpContextAccessor httpContextAccessor)
        {
            _context = context;
            _httpContextAccessor = httpContextAccessor;
        }

        // ThÃªm sáº£n pháº©m vÃ o giá» hÃ ng
        [HttpPost]
        public async Task<IActionResult> AddToCart([FromBody] CartDto request)
        {
            if (request.ProductVariantId <= 0 || request.Quantity <= 0)
            {
                return BadRequest("ThÃ´ng tin sáº£n pháº©m khÃ´ng há»£p lá»‡.");
            }

            if (request.UserId > 0)
            {
                // NgÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p
                var cart = await _context.Carts
                    .Include(c => c.Items)
                    .FirstOrDefaultAsync(c => c.UserId == request.UserId);

                if (cart == null)
                {
                    cart = new Cart { UserId = request.UserId, Items = new List<CartItem>() };
                    _context.Carts.Add(cart);
                }

                var existingItem = cart.Items.FirstOrDefault(i => i.ProductVariantId == request.ProductVariantId);
                if (existingItem != null)
                {
                    existingItem.Quantity += request.Quantity;
                    existingItem.UpdatedAt = DateTime.UtcNow;
                }
                else
                {
                    cart.Items.Add(new CartItem
                    {
                        ProductVariantId = request.ProductVariantId,
                        Quantity = request.Quantity,
                        AddedAt = DateTime.UtcNow
                    });
                }

                await _context.SaveChangesAsync();
            }
            else
            {
                // NgÆ°á»i dÃ¹ng chÆ°a Ä‘Äƒng nháº­p - LÆ°u vÃ o session
                var session = _httpContextAccessor.HttpContext!.Session;
                var sessionCart = session.GetString("Cart");
                var cartItems = string.IsNullOrEmpty(sessionCart)
                    ? new List<CartItemSession>()
                    : JsonSerializer.Deserialize<List<CartItemSession>>(sessionCart) ?? new List<CartItemSession>();

                var existingItem = cartItems.FirstOrDefault(i => i.ProductVariantId == request.ProductVariantId);
                if (existingItem != null)
                {
                    existingItem.Quantity += request.Quantity;
                }
                else
                {
                    cartItems.Add(new CartItemSession
                    {
                        ProductVariantId = request.ProductVariantId,
                        Quantity = request.Quantity
                    });
                }

                session.SetString("Cart", JsonSerializer.Serialize(cartItems));
            }

            return Ok("Sáº£n pháº©m Ä‘Ã£ Ä‘Æ°á»£c thÃªm vÃ o giá» hÃ ng.");
        }

        // Láº¥y giá» hÃ ng
        [HttpGet]
        public async Task<IActionResult> GetCart([FromQuery] int? userId)
        {
            if (userId > 0)
            {
                // Logic cÅ© cho ngÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p
                var cart = await _context.Carts
                    .Include(c => c.Items)
                        .ThenInclude(i => i.ProductVariant)
                            .ThenInclude(v => v.Product)
                                .ThenInclude(p => p.Images)
                    .FirstOrDefaultAsync(c => c.UserId == userId);

                if (cart == null || cart.Items.Count == 0)
                {
                    return Ok(new List<object>());
                }

                var cartItems = cart.Items.Select(i => new
                {
                    i.Id,
                    i.Quantity,
                    i.ProductVariantId,
                    ProductName = i.ProductVariant.Product.Name,
                    ProductImage = i.ProductVariant.Product.Images
        .OrderByDescending(img => img.IsPrimary) // Æ¯u tiÃªn áº£nh IsPrimary
        .ThenBy(img => img.Id)                  // Sau Ä‘Ã³ sáº¯p xáº¿p theo ID
        .FirstOrDefault()?.ImageUrl ?? "/images/default-product.png", // Fallback image
                    VariantColor = i.ProductVariant.Color,
                    VariantStorage = i.ProductVariant.Storage,
                    ProductPrice = i.ProductVariant.Price,
                    ProductDiscountPrice = i.ProductVariant.DiscountPrice
                }).ToList();

                return Ok(cartItems);
            }
            else
            {
                // Xá»­ lÃ½ cho ngÆ°á»i dÃ¹ng chÆ°a Ä‘Äƒng nháº­p
                var session = _httpContextAccessor.HttpContext!.Session;
                var sessionCart = session.GetString("Cart");
                var cartItems = string.IsNullOrEmpty(sessionCart)
                    ? new List<CartItemSession>()
                    : JsonSerializer.Deserialize<List<CartItemSession>>(sessionCart) ?? new List<CartItemSession>();

                // Láº¥y thÃ´ng tin sáº£n pháº©m cho tá»«ng item trong giá» hÃ ng session
                var result = new List<object>();
                foreach (var item in cartItems)
                {
                    var variant = await _context.ProductVariants
                        .Include(v => v.Product)
                            .ThenInclude(p => p.Images)
                        .FirstOrDefaultAsync(v => v.Id == item.ProductVariantId);

                    if (variant != null)
                    {
                        result.Add(new
                        {
                            item.ProductVariantId,
                            item.Quantity,
                            ProductName = variant.Product.Name,
                            ProductImage = variant.Product.Images
                                .OrderByDescending(img => img.IsPrimary)
                                .ThenBy(img => img.Id)
                                .FirstOrDefault()?.ImageUrl ?? "/images/default-product.png",
                            VariantColor = variant.Color,
                            VariantStorage = variant.Storage,
                            ProductPrice = variant.Price,
                            ProductDiscountPrice = variant.DiscountPrice
                        });
                    }
                }

                return Ok(result);
            }
        }

        // Cáº­p nháº­t sá»‘ lÆ°á»£ng sáº£n pháº©m trong giá» hÃ ng
        [HttpPut("update")]
        public async Task<IActionResult> UpdateCartItem([FromBody] CartDto request)
        {
            if (request.UserId > 0)
            {
                var cartItem = await _context.CartItems
                    .FirstOrDefaultAsync(i => i.Cart.UserId == request.UserId && i.ProductVariantId == request.ProductVariantId);

                if (cartItem == null)
                {
                    return NotFound("Sáº£n pháº©m khÃ´ng cÃ³ trong giá» hÃ ng.");
                }

                cartItem.Quantity = request.Quantity;
                cartItem.UpdatedAt = DateTime.UtcNow;
                await _context.SaveChangesAsync();
            }
            else
            {
                var session = _httpContextAccessor.HttpContext!.Session;
                var sessionCart = session.GetString("Cart");
                var cartItems = string.IsNullOrEmpty(sessionCart)
                    ? new List<CartItemSession>()
                    : JsonSerializer.Deserialize<List<CartItemSession>>(sessionCart) ?? new List<CartItemSession>();

                var cartItem = cartItems.FirstOrDefault(i => i.ProductVariantId == request.ProductVariantId);
                if (cartItem == null)
                {
                    return NotFound("Sáº£n pháº©m khÃ´ng cÃ³ trong giá» hÃ ng.");
                }

                cartItem.Quantity = request.Quantity;
                session.Set("Cart", JsonSerializer.SerializeToUtf8Bytes(cartItems));

            }

            return Ok("Cáº­p nháº­t sá»‘ lÆ°á»£ng thÃ nh cÃ´ng.");
        }

        // XÃ³a sáº£n pháº©m khá»i giá» hÃ ng
        [HttpDelete("remove/{productVariantId}")]
        public async Task<IActionResult> RemoveFromCart(int productVariantId, [FromQuery] int? userId)
        {
            if (userId > 0)
            {
                var cartItem = await _context.CartItems
                    .FirstOrDefaultAsync(i => i.Cart.UserId == userId && i.ProductVariantId == productVariantId);

                if (cartItem == null)
                {
                    return NotFound("Sáº£n pháº©m khÃ´ng cÃ³ trong giá» hÃ ng.");
                }

                _context.CartItems.Remove(cartItem);
                await _context.SaveChangesAsync();
            }
            else
            {
                var session = _httpContextAccessor.HttpContext!.Session;
                var sessionCart = session.GetString("Cart");
                var cartItems = string.IsNullOrEmpty(sessionCart)
                    ? new List<CartItemSession>()
                    : JsonSerializer.Deserialize<List<CartItemSession>>(sessionCart) ?? new List<CartItemSession>();

                var cartItem = cartItems.FirstOrDefault(i => i.ProductVariantId == productVariantId);
                if (cartItem == null)
                {
                    return NotFound("Sáº£n pháº©m khÃ´ng cÃ³ trong giá» hÃ ng.");
                }

                cartItems.Remove(cartItem);
                session.SetString("Cart", JsonSerializer.Serialize(cartItems));
            }

            return Ok("Sáº£n pháº©m Ä‘Ã£ Ä‘Æ°á»£c xÃ³a khá»i giá» hÃ ng.");
        }

        // XÃ³a toÃ n bá»™ giá» hÃ ng
        [HttpDelete("clear")]
        public async Task<IActionResult> ClearCart([FromQuery] int? userId)
        {
            if (userId > 0)
            {
                var cart = await _context.Carts.Include(c => c.Items).FirstOrDefaultAsync(c => c.UserId == userId);
                if (cart != null)
                {
                    _context.CartItems.RemoveRange(cart.Items);
                    await _context.SaveChangesAsync();
                }
            }
            else
            {
                var session = _httpContextAccessor.HttpContext!.Session;
                session.Remove("Cart");
            }

            return Ok("Giá» hÃ ng Ä‘Ã£ Ä‘Æ°á»£c lÃ m trá»‘ng.");
        }

        [HttpDelete("remove-paid-items")]
        public async Task<IActionResult> RemovePaidCartItems([FromQuery] int? userId)
        {
            if (userId == null || userId <= 0)
            {
                return BadRequest("UserId khÃ´ng há»£p lá»‡.");
            }

            // Láº¥y giá» hÃ ng cá»§a user
            var cart = await _context.Carts.Include(c => c.Items)
                                           .FirstOrDefaultAsync(c => c.UserId == userId);

            if (cart == null || cart.Items == null || !cart.Items.Any())
            {
                return NotFound("Giá» hÃ ng trá»‘ng hoáº·c khÃ´ng tá»“n táº¡i.");
            }

            // Láº¥y danh sÃ¡ch cÃ¡c sáº£n pháº©m Ä‘Ã£ Ä‘áº·t hÃ ng (cÃ³ trong OrderItem)
            var paidProductVariantIds = await _context.OrderItems
                                                      .Select(oi => oi.ProductVariantId)
                                                      .ToListAsync();

            // Lá»c cÃ¡c sáº£n pháº©m trong giá» hÃ ng Ä‘Ã£ Ä‘Æ°á»£c thanh toÃ¡n
            var paidCartItems = cart.Items
                                    .Where(item => paidProductVariantIds.Contains(item.ProductVariantId))
                                    .ToList();

            if (!paidCartItems.Any())
            {
                return Ok("KhÃ´ng cÃ³ sáº£n pháº©m nÃ o Ä‘Ã£ thanh toÃ¡n Ä‘á»ƒ xÃ³a.");
            }

            // XÃ³a cÃ¡c sáº£n pháº©m Ä‘Ã£ thanh toÃ¡n khá»i giá» hÃ ng
            _context.CartItems.RemoveRange(paidCartItems);
            await _context.SaveChangesAsync();

            return Ok(new { message = "ÄÃ£ xÃ³a cÃ¡c sáº£n pháº©m Ä‘Ã£ thanh toÃ¡n khá»i giá» hÃ ng.", removedItems = paidCartItems.Count });
        }


        // láº¥y tÃªn vÃ  áº£nh product dá»±a trÃªn productVariantId
        [HttpGet("variant-info/{productVariantId}")]
        public async Task<IActionResult> GetProductVariantInfo(int productVariantId)
        {
            try
            {
                var variant = await _context.ProductVariants
                    .Include(v => v.Product)
                        .ThenInclude(p => p.Images)
                    .FirstOrDefaultAsync(v => v.Id == productVariantId);

                if (variant == null)
                {
                    return NotFound("Biáº¿n thá»ƒ sáº£n pháº©m khÃ´ng tá»“n táº¡i");
                }

                var result = new
                {
                    ProductName = variant.Product.Name,
                    ProductImage = variant.Product.Images
                                .OrderByDescending(img => img.IsPrimary)
                                .ThenBy(img => img.Id)
                                .FirstOrDefault()?.ImageUrl ?? "/images/default-product.png",
                    VariantColor = variant.Color,
                    VariantStorage = variant.Storage,
                    Price = variant.Price,
                    DiscountPrice = variant.DiscountPrice
                };

                return Ok(result);
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Lá»—i khi láº¥y thÃ´ng tin biáº¿n thá»ƒ: {ex.Message}");
            }
        }
    }
}

```

### Controllers\CategoriesController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.DTOs;
using SHN_Gear.Models;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace SHN_Gear.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class CategoriesController : ControllerBase
    {
        private readonly AppDbContext _context;

        public CategoriesController(AppDbContext context)
        {
            _context = context;
        }

        [HttpGet]
        public async Task<ActionResult<IEnumerable<CategoryDto>>> GetCategories()
        {
            var categories = await _context.Categories
                                           .Select(c => new CategoryDto
                                           {
                                               Id = c.Id,
                                               Name = c.Name,
                                               Description = c.Description,
                                               Image = c.Image
                                           })
                                           .ToListAsync();
            return Ok(categories);
        }

        [HttpGet("{id}")]
        public async Task<ActionResult<CategoryDto>> GetCategory(int id)
        {
            var category = await _context.Categories.FindAsync(id);

            if (category == null)
            {
                return NotFound();
            }

            return Ok(new CategoryDto
            {
                Id = category.Id,
                Name = category.Name,
                Description = category.Description,
                Image = category.Image
            });
        }

        [HttpPost]
        public async Task<ActionResult<CategoryDto>> PostCategory(CreateCategoryDto categoryDto)
        {
            var category = new Category
            {
                Name = categoryDto.Name,
                Description = categoryDto.Description,
                Image = categoryDto.Image
            };

            _context.Categories.Add(category);
            await _context.SaveChangesAsync();

            var categoryResult = new CategoryDto
            {
                Id = category.Id,
                Name = category.Name,
                Description = category.Description,
                Image = category.Image
            };

            return CreatedAtAction(nameof(GetCategory), new { id = category.Id }, categoryResult);
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> PutCategory(int id, CreateCategoryDto categoryDto) // Using CreateCategoryDto for update as well
        {
            var category = await _context.Categories.FindAsync(id);
            if (category == null)
            {
                return NotFound();
            }

            category.Name = categoryDto.Name;
            category.Description = categoryDto.Description;
            category.Image = categoryDto.Image;

            await _context.SaveChangesAsync();

            return NoContent();
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteCategory(int id)
        {
            var category = await _context.Categories.FindAsync(id);
            if (category == null)
            {
                return NotFound();
            }

            _context.Categories.Remove(category);
            await _context.SaveChangesAsync();

            return NoContent();
        }

        private bool CategoryExists(int id)
        {
            return _context.Categories.Any(e => e.Id == id);
        }
    }
}
```

### Controllers\ChatController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.SignalR;
using Microsoft.AspNetCore.Cors;
using SHN_Gear.Services;
using SHN_Gear.DTOs;
using SHN_Gear.Hubs;
using System.Security.Claims;

namespace SHN_Gear.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [EnableCors("AllowFrontend")]
    public class ChatController : ControllerBase
    {
        private readonly ChatService _chatService;
        private readonly IHubContext<ChatHub> _hubContext;
        private readonly ILogger<ChatController> _logger;

        public ChatController(ChatService chatService, IHubContext<ChatHub> hubContext, ILogger<ChatController> logger)
        {
            _chatService = chatService;
            _hubContext = hubContext;
            _logger = logger;
        }

        /// <summary>
        /// Táº¡o hoáº·c láº¥y session chat hiá»‡n táº¡i
        /// </summary>
        [HttpPost("session")]
        public async Task<IActionResult> CreateOrGetSession([FromBody] CreateSessionDto dto)
        {
            try
            {
                var userId = GetCurrentUserId();
                _logger.LogInformation("Creating/getting session for userId: {UserId}, guestName: {GuestName}, guestEmail: {GuestEmail}",
                    userId, dto.GuestName, dto.GuestEmail);

                var session = await _chatService.CreateOrGetSessionAsync(
                    userId,
                    dto.GuestName,
                    dto.GuestEmail,
                    dto.SessionId
                );

                return Ok(session);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating/getting chat session");
                return StatusCode(500, new { message = "Lá»—i khi táº¡o phiÃªn chat" });
            }
        }

        /// <summary>
        /// Gá»­i tin nháº¯n tá»« user
        /// </summary>
        [HttpPost("message")]
        public async Task<IActionResult> SendMessage([FromBody] SendMessageDto dto)
        {
            try
            {
                var userId = GetCurrentUserId();
                var message = await _chatService.SendMessageAsync(dto, userId);

                // SignalR notification is handled by ChatService.NotifyNewMessage
                return Ok(message);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error sending message: {Message}", dto.Content);
                return StatusCode(500, new { message = "Lá»—i khi gá»­i tin nháº¯n" });
            }
        }

        /// <summary>
        /// Escalate chat to admin
        /// </summary>
        [HttpPost("{sessionId}/escalate")]
        public async Task<IActionResult> EscalateToAdmin(int sessionId, [FromBody] EscalateChatDto dto)
        {
            try
            {
                var session = await _chatService.EscalateToAdminAsync(sessionId, dto.Reason, dto.PreferredAdminId);

                // Notify admins via SignalR
                await _hubContext.Clients.Group("admins")
                    .SendAsync("ChatEscalated", session);

                return Ok(session);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error escalating chat session {SessionId}", sessionId);
                return StatusCode(500, new { message = "Lá»—i khi chuyá»ƒn chat sang admin" });
            }
        }

        /// <summary>
        /// Get chat session by session ID
        /// </summary>
        [HttpGet("session/{sessionId}")]
        public async Task<IActionResult> GetSession(string sessionId)
        {
            try
            {
                var session = await _chatService.GetSessionAsync(sessionId);
                if (session == null)
                    return NotFound(new { message = "KhÃ´ng tÃ¬m tháº¥y phiÃªn chat" });

                return Ok(session);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting chat session {SessionId}", sessionId);
                return StatusCode(500, new { message = "Lá»—i khi láº¥y thÃ´ng tin chat" });
            }
        }

        /// <summary>
        /// Admin: Get all active chat sessions
        /// </summary>
        [HttpGet("admin/sessions")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> GetActiveSessions()
        {
            try
            {
                var adminId = GetCurrentUserId();
                var sessions = await _chatService.GetActiveChatSessionsAsync(adminId);
                return Ok(sessions);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting active chat sessions");
                return StatusCode(500, new { message = "Lá»—i khi láº¥y danh sÃ¡ch chat" });
            }
        }

        /// <summary>
        /// Admin: Send message as admin
        /// </summary>
        [HttpPost("{sessionId}/admin-message")]
        [Authorize(Roles = "Admin")]
        public async Task<IActionResult> SendAdminMessage(string sessionId, [FromBody] AdminMessageDto dto)
        {
            try
            {
                var adminId = GetCurrentUserId();
                if (!adminId.HasValue)
                    return Unauthorized();

                var message = await _chatService.SendAdminMessageAsync(sessionId, dto.Content, adminId.Value);

                return Ok(message);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error sending admin message to session {SessionId}", sessionId);
                return StatusCode(500, new { message = "Lá»—i khi gá»­i tin nháº¯n admin" });
            }
        }

        /// <summary>
        /// Test AI response (for development)
        /// </summary>
        [HttpPost("test-ai")]
        public async Task<IActionResult> TestAI([FromBody] TestAIDto dto)
        {
            try
            {
                var aiService = HttpContext.RequestServices.GetRequiredService<AIService>();
                var response = await aiService.ProcessMessageAsync(dto.Message, dto.Context, dto.UserId);
                return Ok(response);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error testing AI: {Message}", dto.Message);
                return StatusCode(500, new { message = "Lá»—i khi test AI" });
            }
        }

        private int? GetCurrentUserId()
        {
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            return int.TryParse(userIdClaim, out var userId) ? userId : null;
        }
    }

    // Additional DTOs
    public class CreateSessionDto
    {
        public string? SessionId { get; set; }
        public string? GuestName { get; set; }
        public string? GuestEmail { get; set; }
    }

    public class AdminMessageDto
    {
        public string Content { get; set; } = null!;
    }

    public class TestAIDto
    {
        public string Message { get; set; } = null!;
        public string? Context { get; set; }
        public int? UserId { get; set; }
    }
}
```

### Controllers\CorsTestController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Cors;

namespace SHN_Gear.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [EnableCors("AllowFrontend")]
    public class CorsTestController : ControllerBase
    {
        private readonly ILogger<CorsTestController> _logger;

        public CorsTestController(ILogger<CorsTestController> logger)
        {
            _logger = logger;
        }

        /// <summary>
        /// Simple endpoint to test CORS configuration
        /// </summary>
        [HttpGet("test")]
        public IActionResult TestCors()
        {
            _logger.LogInformation("CORS test endpoint called");
            return Ok(new { 
                message = "CORS is working!", 
                timestamp = DateTime.UtcNow,
                origin = Request.Headers["Origin"].ToString(),
                userAgent = Request.Headers["User-Agent"].ToString()
            });
        }

        /// <summary>
        /// Test OPTIONS preflight request
        /// </summary>
        [HttpOptions("test")]
        public IActionResult TestCorsOptions()
        {
            _logger.LogInformation("CORS OPTIONS test endpoint called");
            return Ok();
        }

        /// <summary>
        /// Test POST request with CORS
        /// </summary>
        [HttpPost("test")]
        public IActionResult TestCorsPost([FromBody] dynamic data)
        {
            _logger.LogInformation("CORS POST test endpoint called");
            return Ok(new { 
                message = "CORS POST is working!", 
                receivedData = data,
                timestamp = DateTime.UtcNow
            });
        }
    }
}

```

### Controllers\HomepageConfigController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using SHN_Gear.Data;
using SHN_Gear.Models;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.EntityFrameworkCore;
using Newtonsoft.Json;
using SHN_Gear.DTOs; // Add this line

namespace SHN_Gear.Controllers
{
    [ApiController]
    [Route("api/homepage-config")]
    public class HomepageConfigController : ControllerBase
    {
        private readonly AppDbContext _context;

        public HomepageConfigController(AppDbContext context)
        {
            _context = context;
        }

        [HttpGet]
        public async Task<IActionResult> GetHomepageConfig()
        {
            var config = await _context.HomepageConfigurations.FirstOrDefaultAsync();

            if (config == null)
            {
                // Create a default configuration if none exists using DTOs
                var defaultHomepageConfig = new HomepageConfigDto
                {
                    Layout = new List<string> { "hero", "categories", "featured_products", "special_offer", "best_seller", "brand_trust" },
                    Components = new HomepageComponentsDto
                    {
                        Hero = new HeroSectionDto
                        {
                            Enabled = true,
                            Background_type = "video",
                            Background_url = "/videos/hero-background.mp4",
                            Headline = "GEAR FOR THE NEXT GENERATION",
                            Slogan = "Unleash Your Potential.",
                            Cta_text = "Explore Now",
                            Cta_link = "/products"
                        },
                        Categories = new CategoriesSectionDto
                        {
                            Enabled = true,
                            Items = new List<HomepageCategoryItemDto>
                            {
                                new HomepageCategoryItemDto { CategoryId = 1, DisplayOrder = 1, Name = "Laptops", Image_url = "/images/categories/laptops.png", Link = "/products/laptops" },
                                new HomepageCategoryItemDto { CategoryId = 2, DisplayOrder = 2, Name = "Keyboards", Image_url = "/images/categories/keyboards.png", Link = "/products/keyboards" },
                                new HomepageCategoryItemDto { CategoryId = 3, DisplayOrder = 3, Name = "Mice", Image_url = "/images/categories/mice.png", Link = "/products/mice" },
                                new HomepageCategoryItemDto { CategoryId = 4, DisplayOrder = 4, Name = "Headsets", Image_url = "/images/categories/headsets.png", Link = "/products/headsets" }
                            }
                        },
                        Featured_products = new FeaturedProductsSectionDto
                        {
                            Enabled = true,
                            Title = "Best Sellers",
                            Collection_id = "best-sellers"
                        },
                        Special_offer = new SpecialOfferSectionDto
                        {
                            Enabled = true,
                            Image_url = "/images/banners/special-offer.png",
                            Headline = "LIMITED TIME OFFER",
                            Sub_text = "Get 20% off on all gaming mice.",
                            Cta_text = "Shop Now",
                            Cta_link = "/products/mice",
                            Countdown_enabled = true,
                            Countdown_end_date = "2025-07-31T23:59:59"
                        },
                        Best_seller = new BestSellerSectionDto
                        {
                            Enabled = true,
                            Title = "Best Sellers",
                            Items = new List<BestSellerItemDto> { new BestSellerItemDto { ProductId = 1 }, new BestSellerItemDto { ProductId = 2 }, new BestSellerItemDto { ProductId = 3 } } // Example product IDs
                        },
                        Brand_trust = new BrandTrustSectionDto
                        {
                            Enabled = true,
                            Logos = new List<BrandLogoDto>
                            {
                                new BrandLogoDto { Id = 1, Name = "Brand A", Logo_url = "/images/brands/logo-a.svg" },
                                new BrandLogoDto { Id = 2, Name = "Brand B", Logo_url = "/images/brands/logo-b.svg" },
                                new BrandLogoDto { Id = 3, Name = "Brand C", Logo_url = "/images/brands/logo-c.svg" },
                                new BrandLogoDto { Id = 4, Name = "Brand D", Logo_url = "/images/brands/logo-d.svg" }
                            },
                            Commitments = new List<CommitmentDto>
                            {
                                new CommitmentDto { Id = 1, Icon = "shipping", Title = "Fast Shipping", Description = "Nationwide delivery." },
                                new CommitmentDto { Id = 2, Icon = "warranty", Title = "24-Month Warranty", Description = "On all products." },
                                new CommitmentDto { Id = 3, Icon = "support", Title = "24/7 Support", Description = "Always here to help." }
                            }
                        }
                    }
                };

                config = new HomepageConfig
                {
                    ConfigJson = JsonConvert.SerializeObject(defaultHomepageConfig, Formatting.Indented),
                    LastUpdated = DateTime.UtcNow,
                    UpdatedBy = "System"
                };
                _context.HomepageConfigurations.Add(config);
                await _context.SaveChangesAsync();
            }

            var settings = new JsonSerializerSettings
            {
                MissingMemberHandling = MissingMemberHandling.Ignore
            };
            var homepageConfigDto = JsonConvert.DeserializeObject<HomepageConfigDto>(config.ConfigJson, settings);
            return Ok(homepageConfigDto);
        }

        [HttpPut]
        public async Task<IActionResult> UpdateHomepageConfig([FromBody] HomepageConfigDto newConfigDto)
        {
            if (newConfigDto == null)
            {
                return BadRequest("Configuration data is required.");
            }

            var config = await _context.HomepageConfigurations.FirstOrDefaultAsync();

            if (config == null)
            {
                // If no config exists, create one (should ideally be handled by Get on first load)
                config = new HomepageConfig();
                _context.HomepageConfigurations.Add(config);
            }

            config.ConfigJson = JsonConvert.SerializeObject(newConfigDto, Formatting.Indented);
            config.LastUpdated = DateTime.UtcNow;
            // You might want to get the current user's name here for UpdatedBy
            config.UpdatedBy = User.Identity?.Name ?? "Admin"; 

            await _context.SaveChangesAsync();

            return Ok();
        }
    }
}

```

### Controllers\LoyaltyController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Models;
using SHN_Gear.Data;
using SHN_Gear.DTOs;
using System;
using System.Threading.Tasks;
using System.Linq;

[Route("api/loyalty")]
[ApiController]
public class LoyaltyController : ControllerBase
{
    private readonly AppDbContext _context;
    private readonly Random _random = new Random();

    public LoyaltyController(AppDbContext context)
    {
        _context = context;
    }

    [HttpGet("my-status")]
    public async Task<IActionResult> GetMyLoyaltyStatus([FromQuery] int userId)
    {
        if (userId <= 0)
        {
            return BadRequest("Invalid user ID");
        }

        var user = await _context.Users
            .Include(u => u.Role)
            .FirstOrDefaultAsync(u => u.Id == userId);

        if (user == null)
        {
            return NotFound("User not found");
        }

        if (!user.IsActive)
        {
            return BadRequest("User account is not active");
        }

        string currentRank = user.Role.Name == "Admin" ? "Admin" : DetermineRank(user.Points);

        // Cáº­p nháº­t Role náº¿u khÃ´ng pháº£i Admin
        if (user.Role.Name != "Admin" && user.Role.Name != currentRank)
        {
            var newRole = await _context.Roles
                .FirstOrDefaultAsync(r => r.Name == currentRank);
            if (newRole == null)
            {
                return StatusCode(500, $"Role '{currentRank}' not found in database");
            }
            user.RoleId = newRole.Id;
            user.Role = newRole;
            _context.Users.Update(user);
            await _context.SaveChangesAsync();
        }

        string nextRank = currentRank == "Admin" ? null : DetermineNextRank(currentRank);
        int pointsNeeded = currentRank == "Admin" ? 0 : CalculatePointsNeededForNextRank(user.Points, currentRank, nextRank);
        int spinCost = CalculateSpinCost(currentRank);

        return Ok(new
        {
            CurrentRank = currentRank,
            CurrentPoints = user.Points,
            PointsNeededForNextRank = pointsNeeded,
            CanSpin = user.Points >= spinCost, // Chá»‰ Admin quay vá»›i 0 Ä‘iá»ƒm, cÃ²n láº¡i cáº§n Ä‘á»§ Ä‘iá»ƒm
            SpinCost = spinCost
        });
    }

    [HttpPost("spin-wheel")]
    public async Task<IActionResult> SpinWheel([FromQuery] int userId)
    {
        if (userId <= 0)
        {
            return BadRequest("Invalid user ID");
        }

        var user = await _context.Users
            .Include(u => u.Role)
            .FirstOrDefaultAsync(u => u.Id == userId);

        if (user == null)
        {
            return NotFound("User not found");
        }

        if (!user.IsActive)
        {
            return BadRequest("User account is not active");
        }

        string currentRank = user.Role.Name == "Admin" ? "Admin" : DetermineRank(user.Points);
        int spinCost = CalculateSpinCost(currentRank);

        // Kiá»ƒm tra Ä‘á»§ Ä‘iá»ƒm Ä‘á»ƒ quay (Admin miá»…n phÃ­, cÃ¡c rank khÃ¡c cáº§n Ä‘á»§ Ä‘iá»ƒm)
        if (currentRank != "Admin" && user.Points < spinCost)
        {
            return BadRequest("Not enough points to spin the wheel.");
        }

        // Trá»« Ä‘iá»ƒm khi quay (Admin khÃ´ng bá»‹ trá»«, cÃ¡c rank khÃ¡c bá»‹ trá»«)
        if (currentRank != "Admin")
        {
            user.Points -= spinCost;
        }

        // Táº¡o pháº§n thÆ°á»Ÿng ngáº«u nhiÃªn
        var (voucherValue, prizeType) = GenerateRandomPrize(currentRank);
        object responseData;

        if (prizeType == "Voucher")
        {
            var voucher = new Voucher
            {
                Code = $"SPIN-{currentRank}-{Guid.NewGuid().ToString().Substring(0, 8)}",
                DiscountAmount = voucherValue,
                ExpiryDate = DateTime.UtcNow.AddDays(30),
                IsActive = true
            };

            _context.Vouchers.Add(voucher);
            await _context.SaveChangesAsync();

            var userVoucher = new UserVoucher
            {
                UserId = user.Id,
                VoucherId = voucher.Id,
                UsedAt = DateTime.UtcNow,
                IsUsed = false // Tráº¡ng thÃ¡i sá»­ dá»¥ng máº·c Ä‘á»‹nh lÃ  false khi nháº­n tá»« vÃ²ng quay
            };

            _context.UserVouchers.Add(userVoucher);

            responseData = new
            {
                PrizeType = prizeType,
                Voucher = new VoucherDto
                {
                    Id = voucher.Id,
                    Code = voucher.Code,
                    DiscountAmount = voucher.DiscountAmount,
                    ExpiryDate = voucher.ExpiryDate,
                    IsActive = voucher.IsActive
                },
                RemainingPoints = user.Points
            };
        }
        else
        {
            responseData = new
            {
                PrizeType = prizeType,
                Voucher = (object)null,
                RemainingPoints = user.Points
            };
        }

        // Cáº­p nháº­t Ä‘iá»ƒm ngÆ°á»i dÃ¹ng vÃ o cÆ¡ sá»Ÿ dá»¯ liá»‡u
        _context.Users.Update(user);
        await _context.SaveChangesAsync();

        return Ok(responseData);
    }

    private string DetermineRank(int points)
    {
        if (points >= 225000) return "VIP 3";
        if (points >= 125000) return "VIP 2";
        if (points >= 50000) return "VIP 1";
        return "VIP 0";
    }

    private string DetermineNextRank(string currentRank)
    {
        return currentRank switch
        {
            "VIP 0" => "VIP 1",
            "VIP 1" => "VIP 2",
            "VIP 2" => "VIP 3",
            "VIP 3" => null,
            _ => "VIP 1"
        };
    }

    private int CalculatePointsNeededForNextRank(int currentPoints, string currentRank, string nextRank)
    {
        if (nextRank == null) return 0;
        return nextRank switch
        {
            "VIP 1" => 50000 - currentPoints,
            "VIP 2" => 125000 - currentPoints,
            "VIP 3" => 225000 - currentPoints,
            _ => 50000 - currentPoints
        };
    }

    private int CalculateSpinCost(string currentRank)
    {
        return currentRank switch
        {
            "Admin" => 0,     // 
            "VIP 0" => 500, // 
            "VIP 1" => 5000,
            "VIP 2" => 5000,
            "VIP 3" => 5000,  // 
            _ => 10000
        };
    }

    private (decimal voucherValue, string prizeType) GenerateRandomPrize(string currentRank)
    {
        int chance = _random.Next(1, 101);
        switch (currentRank)
        {
            case "Admin":
                if (chance <= 50) return (500000, "Voucher"); // 50% nháº­n 500k
                else if (chance <= 80) return (350000, "Voucher"); // 30% nháº­n 350k
                else return (200000, "Voucher"); // 20% nháº­n 200k
            case "VIP 0":
                if (chance <= 50) return (50000, "Voucher"); // 50% nháº­n 50k
                else if (chance <= 80) return (20000, "Voucher"); // 30% nháº­n 20k
                else return (0, "No Prize"); // 20% khÃ´ng trÃºng
            case "VIP 1":
                if (chance <= 40) return (100000, "Voucher"); // 40% nháº­n 100k
                else if (chance <= 70) return (50000, "Voucher"); // 30% nháº­n 50k
                else return (20000, "Voucher"); // 30% nháº­n 20k
            case "VIP 2":
                if (chance <= 30) return (200000, "Voucher"); // 30% nháº­n 200k
                else if (chance <= 60) return (100000, "Voucher"); // 30% nháº­n 100k
                else return (50000, "Voucher"); // 40% nháº­n 50k
            case "VIP 3":
                if (chance <= 20) return (350000, "Voucher"); // 20% nháº­n 350k
                else if (chance <= 50) return (200000, "Voucher"); // 30% nháº­n 200k
                else return (100000, "Voucher"); // 50% nháº­n 100k
            default:
                return (0, "No Prize");
        }
    }
}
```

### Controllers\OrderController.cs
```cs
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.DTOs;
using SHN_Gear.Models;
using SHN_Gear.Services;
using System.Security.Claims;
using System.Linq;
using System.Threading.Tasks;
using System;
using Newtonsoft.Json;
using System.IO;
using OfficeOpenXml;
using iTextSharp.text;
using iTextSharp.text.pdf;
using iTextSharp.tool.xml;
using System.Drawing;
using System.Drawing.Imaging;
using System.Drawing.Drawing2D;
using System.Globalization; // Cho hÃ m ConvertToUnsigned
using System.Text;         // Cho NormalizationForm
using System.Text.RegularExpressions; // For Regex
using OfficeOpenXml.Style;
using Microsoft.AspNetCore.JsonPatch;
namespace SHN_Gear.Controllers
{
    [ApiController]
    [Route("api/orders")]
    public class OrderController : ControllerBase
    {
        private readonly AppDbContext _context;
        private readonly MoMoPaymentService _momoService;
        private readonly IConfiguration _configuration;

        public OrderController(
            AppDbContext context,
            MoMoPaymentService momoService,
            IConfiguration configuration)
        {
            _context = context;
            _momoService = momoService;
            _configuration = configuration;
        }




        // Láº¥y thÃ´ng tin Ä‘Æ¡n hÃ ng
        [HttpGet("confirm/{orderId}")]
        public async Task<IActionResult> GetOrderConfirmationDetails(int orderId)
        {
            try
            {
                var order = await _context.Orders
                    .Include(o => o.OrderItems)
                        .ThenInclude(oi => oi.ProductVariant)
                            .ThenInclude(pv => pv.Product)
                                .ThenInclude(p => p.Images)
                    .Include(o => o.Address)
                    .Include(o => o.PaymentMethod)
                    .FirstOrDefaultAsync(o => o.Id == orderId);

                if (order == null)
                {
                    return NotFound(new { Message = "KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng" });
                }

                var result = new
                {
                    OrderId = order.Id,
                    OrderDate = order.OrderDate.ToString("dd/MM/yyyy HH:mm"),
                    TotalAmount = order.TotalAmount,
                    FormattedTotal = order.TotalAmount.ToString("N0") + " VNÄ",
                    PaymentMethod = order.PaymentMethod?.Name ?? "Tiá»n máº·t",
                    OrderStatus = order.OrderStatus,
                    ShippingInfo = new
                    {
                        FullName = order.Address?.FullName ?? "N/A",
                        Phone = order.Address?.PhoneNumber ?? "N/A",
                        Address = $"{order.Address?.AddressLine1}, {order.Address?.City}, {order.Address?.State}",
                        Email = order.User?.Email ?? "N/A"
                    },
                    Products = order.OrderItems.Select(oi => new
                    {
                        Id = oi.ProductVariant.Product.Id,
                        Name = oi.ProductVariant.Product.Name,
                        Image = oi.ProductVariant.Product.Images.FirstOrDefault(i => i.IsPrimary)?.ImageUrl
                               ?? "/images/default-product.png",
                        Variant = $"{oi.ProductVariant.Color} - {oi.ProductVariant.Storage}",
                        Quantity = oi.Quantity,
                        Price = oi.Price,
                        Total = oi.Price * oi.Quantity
                    }),
                    EstimatedDelivery = order.OrderDate.AddDays(3).ToString("dd/MM/yyyy")
                };

                return Ok(result);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { Message = "Lá»—i khi láº¥y thÃ´ng tin Ä‘Æ¡n hÃ ng", Error = ex.Message });
            }
        }
        // Láº¥y danh sÃ¡ch Ä‘Æ¡n hÃ ng
        [HttpGet]
        public async Task<IActionResult> GetOrders()
        {
            var orders = await _context.Orders
                .Include(o => o.OrderItems)
                .OrderByDescending(o => o.OrderDate)
                .ToListAsync();

            var orderDtos = orders.Select(order => new OrderDto
            {
                Id = order.Id,
                UserId = order.UserId,
                OrderDate = order.OrderDate,
                TotalAmount = order.TotalAmount,
                OrderStatus = order.OrderStatus,
                AddressId = order.AddressId,
                PaymentMethodId = order.PaymentMethodId,
                OrderItems = order.OrderItems.Select(oi => new OrderItemDto
                {
                    ProductVariantId = oi.ProductVariantId,
                    Quantity = oi.Quantity,
                    Price = oi.Price
                }).ToList()
            }).ToList();

            return Ok(orderDtos);
        }
        [HttpPut("{id}")]
        [Authorize]
        public async Task<IActionResult> UpdateOrder(int id, [FromBody] UpdateOrderDto updateOrderDto)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();

            try
            {
                // Láº¥y Ä‘Æ¡n hÃ ng hiá»‡n táº¡i
                var order = await _context.Orders
                    .Include(o => o.OrderItems)
                    .FirstOrDefaultAsync(o => o.Id == id);

                if (order == null)
                {
                    return NotFound("ÄÆ¡n hÃ ng khÃ´ng tá»“n táº¡i.");
                }

                // Kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng - chá»‰ cho phÃ©p chá»‰nh sá»­a khi á»Ÿ tráº¡ng thÃ¡i Pending
                if (order.OrderStatus != "Pending")
                {
                    return BadRequest("Chá»‰ cÃ³ thá»ƒ chá»‰nh sá»­a Ä‘Æ¡n hÃ ng khi á»Ÿ tráº¡ng thÃ¡i 'Chá» xá»­ lÃ½'");
                }

                // Cáº­p nháº­t Ä‘á»‹a chá»‰ náº¿u cÃ³
                if (updateOrderDto.AddressId.HasValue)
                {
                    var address = await _context.Addresses.FindAsync(updateOrderDto.AddressId.Value);
                    if (address == null)
                    {
                        return BadRequest("Äá»‹a chá»‰ khÃ´ng tá»“n táº¡i");
                    }
                    order.AddressId = updateOrderDto.AddressId.Value;
                }

                // Xá»­ lÃ½ voucher
                Voucher? voucher = null;
                if (updateOrderDto.VoucherId.HasValue)
                {
                    voucher = await _context.Vouchers.FindAsync(updateOrderDto.VoucherId.Value);
                    if (voucher == null || !voucher.IsActive || voucher.ExpiryDate < DateTime.UtcNow)
                    {
                        return BadRequest("Voucher khÃ´ng há»£p lá»‡.");
                    }
                    order.VoucherId = updateOrderDto.VoucherId;
                }
                else
                {
                    order.VoucherId = null;
                }

                // Xá»­ lÃ½ cÃ¡c sáº£n pháº©m trong Ä‘Æ¡n hÃ ng
                if (updateOrderDto.OrderItems != null && updateOrderDto.OrderItems.Count > 0)
                {
                    // XÃ³a cÃ¡c items cÅ©
                    _context.OrderItems.RemoveRange(order.OrderItems);

                    // ThÃªm cÃ¡c items má»›i
                    foreach (var itemDto in updateOrderDto.OrderItems)
                    {
                        var variant = await _context.ProductVariants
                            .Include(pv => pv.Product)
                            .FirstOrDefaultAsync(pv => pv.Id == itemDto.ProductVariantId);

                        if (variant == null)
                        {
                            return BadRequest($"KhÃ´ng tÃ¬m tháº¥y biáº¿n thá»ƒ sáº£n pháº©m vá»›i ID {itemDto.ProductVariantId}");
                        }

                        if (variant.StockQuantity < itemDto.Quantity)
                        {
                            return BadRequest($"Sá»‘ lÆ°á»£ng tá»“n kho khÃ´ng Ä‘á»§ cho sáº£n pháº©m {variant.Product.Name}");
                        }

                        order.OrderItems.Add(new OrderItem
                        {
                            ProductVariantId = itemDto.ProductVariantId,
                            Quantity = itemDto.Quantity,
                            Price = variant.DiscountPrice ?? variant.Price
                        });
                    }
                }

                // TÃ­nh toÃ¡n láº¡i tá»•ng tiá»n
                order.TotalAmount = order.OrderItems.Sum(oi => oi.Quantity * oi.Price);

                // Ãp dá»¥ng voucher náº¿u cÃ³
                if (voucher != null)
                {
                    order.TotalAmount -= voucher.DiscountAmount;
                    if (order.TotalAmount < 0) order.TotalAmount = 0;
                }
                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                return Ok(new { Message = "ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t thÃ nh cÃ´ng." });
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                return StatusCode(500, $"Lá»—i há»‡ thá»‘ng: {ex.Message}");
            }
        }

        //cáº­p nháº­t má»™t pháº§n Ä‘Æ¡n
        [HttpPatch("{id}")]
        [Authorize]
        public async Task<IActionResult> PartialUpdateOrder(int id, [FromBody] JsonPatchDocument<Order> patchDoc)
        {
            if (patchDoc == null)
            {
                return BadRequest("Dá»¯ liá»‡u cáº­p nháº­t khÃ´ng há»£p lá»‡");
            }

            var order = await _context.Orders.FindAsync(id);
            if (order == null)
            {
                return NotFound("ÄÆ¡n hÃ ng khÃ´ng tá»“n táº¡i");
            }

            // Kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng
            if (order.OrderStatus != "Pending")
            {
                return BadRequest("Chá»‰ cÃ³ thá»ƒ chá»‰nh sá»­a Ä‘Æ¡n hÃ ng khi á»Ÿ tráº¡ng thÃ¡i 'Chá» xá»­ lÃ½'");
            }

            // Ãp dá»¥ng cÃ¡c thay Ä‘á»•i
            patchDoc.ApplyTo(order);

            if (!ModelState.IsValid)
            {
                return BadRequest(ModelState);
            }

            // Kiá»ƒm tra sá»‘ lÆ°á»£ng tá»“n kho náº¿u cÃ³ thay Ä‘á»•i vá» sáº£n pháº©m
            if (patchDoc.Operations.Any(op => op.path.Contains("OrderItems")))
            {
                var orderWithItems = await _context.Orders
                    .Include(o => o.OrderItems)
                    .FirstOrDefaultAsync(o => o.Id == id);

                foreach (var item in orderWithItems.OrderItems)
                {
                    var variant = await _context.ProductVariants.FindAsync(item.ProductVariantId);
                    if (variant.StockQuantity < item.Quantity)
                    {
                        return BadRequest($"Sá»‘ lÆ°á»£ng tá»“n kho khÃ´ng Ä‘á»§ cho sáº£n pháº©m ID {item.ProductVariantId}");
                    }
                }
            }
            await _context.SaveChangesAsync();

            return Ok(new { Message = "ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t thÃ nh cÃ´ng." });
        }
        // Táº¡o Ä‘Æ¡n hÃ ng
        [HttpPost]
        public async Task<IActionResult> CreateOrder([FromBody] OrderDto orderDto)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();

            try
            {
                // Validate user
                User? user = null;
                if (orderDto.UserId.HasValue && orderDto.UserId.Value != 0)
                {
                    user = await _context.Users.FindAsync(orderDto.UserId.Value);
                    if (user == null) return NotFound("NgÆ°á»i dÃ¹ng khÃ´ng tá»“n táº¡i.");
                }

                // Validate voucher
                Voucher? voucher = null;
                UserVoucher? userVoucher = null;
                if (orderDto.VoucherId.HasValue)
                {
                    voucher = await _context.Vouchers.FindAsync(orderDto.VoucherId.Value);
                    if (voucher == null || !voucher.IsActive || voucher.ExpiryDate < DateTime.UtcNow)
                    {
                        return BadRequest("Voucher khÃ´ng há»£p lá»‡ hoáº·c Ä‘Ã£ háº¿t háº¡n.");
                    }

                    // Kiá»ƒm tra xem voucher Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n cho ngÆ°á»i dÃ¹ng chÆ°a
                    userVoucher = await _context.UserVouchers
                        .FirstOrDefaultAsync(uv => uv.VoucherId == voucher.Id && uv.UserId == orderDto.UserId.Value);
                    if (userVoucher == null)
                    {
                        return BadRequest("Báº¡n chÆ°a sá»Ÿ há»¯u voucher nÃ y.");
                    }

                    // Kiá»ƒm tra tráº¡ng thÃ¡i IsUsed
                    if (userVoucher.IsUsed)
                    {
                        return BadRequest("Voucher Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng.");
                    }
                }

                // Kiá»ƒm tra sá»‘ lÆ°á»£ng tá»“n kho
                foreach (var item in orderDto.OrderItems)
                {
                    var variant = await _context.ProductVariants
                        .Include(pv => pv.Product)
                        .FirstOrDefaultAsync(pv => pv.Id == item.ProductVariantId);

                    if (variant == null) return BadRequest($"KhÃ´ng tÃ¬m tháº¥y biáº¿n thá»ƒ sáº£n pháº©m vá»›i ID {item.ProductVariantId}");
                    if (variant.StockQuantity < item.Quantity)
                        return BadRequest($"Sá»‘ lÆ°á»£ng tá»“n kho khÃ´ng Ä‘á»§ cho sáº£n pháº©m {variant.Product.Name}");
                }

                // Create order
                var order = new Order
                {
                    UserId = orderDto.UserId,
                    OrderDate = DateTime.UtcNow,
                    TotalAmount = orderDto.TotalAmount,
                    OrderStatus = orderDto.PaymentMethodId == 1 ? "Pending" : "WaitingForPayment",
                    AddressId = orderDto.AddressId,
                    PaymentMethodId = orderDto.PaymentMethodId,
                    VoucherId = orderDto.VoucherId,
                    OrderItems = orderDto.OrderItems.Select(oi => new OrderItem
                    {
                        ProductVariantId = oi.ProductVariantId,
                        Quantity = oi.Quantity,
                        Price = oi.Price
                    }).ToList()
                };

                // Apply voucher discount
                if (voucher != null)
                {
                    order.TotalAmount -= voucher.DiscountAmount;
                    if (order.TotalAmount < 0) order.TotalAmount = 0;
                }

                _context.Orders.Add(order);
                await _context.SaveChangesAsync();

                // Trá»« sá»‘ lÆ°á»£ng tá»“n kho
                foreach (var item in orderDto.OrderItems)
                {
                    var variant = await _context.ProductVariants.FindAsync(item.ProductVariantId);
                    variant.StockQuantity -= item.Quantity;
                }

                // Thanh toÃ¡n vá»›i MoMo (cáº£ QR vÃ  tháº»)
                if (orderDto.PaymentMethodId == 2)
                {
                    try
                    {
                        var momoOrderId = $"SHN{order.Id}";
                        bool isCardPayment = Request.Headers["Payment-Type"].ToString() == "card";

                        var payUrl = await _momoService.CreatePaymentAsync(
                            momoOrderId,
                            $"Thanh toÃ¡n Ä‘Æ¡n hÃ ng SHN#{order.Id}",
                            (long)order.TotalAmount,
                            isCardPayment);

                        await transaction.CommitAsync();

                        return Ok(new
                        {
                            Success = true,
                            OrderId = order.Id,
                            PaymentUrl = payUrl,
                            Message = isCardPayment
                                ? "Vui lÃ²ng thanh toÃ¡n báº±ng tháº» Visa/MasterCard"
                                : "Vui lÃ²ng thanh toÃ¡n qua QR MoMo"
                        });
                    }
                    catch (Exception ex)
                    {
                        await transaction.RollbackAsync();
                        return BadRequest(new
                        {
                            Success = false,
                            Message = "Lá»—i khi khá»Ÿi táº¡o thanh toÃ¡n MoMo: " + ex.Message
                        });
                    }
                }

                // Process voucher and mark as used
                if (voucher != null && userVoucher != null)
                {
                    userVoucher.IsUsed = true;
                    _context.UserVouchers.Update(userVoucher);
                }

                // Remove purchased items from cart
                if (orderDto.UserId.HasValue)
                {
                    var productVariantIds = orderDto.OrderItems.Select(oi => oi.ProductVariantId).ToList();

                    var cartItemsToRemove = await _context.CartItems
                        .Where(ci => ci.Cart.UserId == orderDto.UserId.Value &&
                                     productVariantIds.Contains(ci.ProductVariantId))
                        .ToListAsync();

                    if (cartItemsToRemove.Any())
                    {
                        _context.CartItems.RemoveRange(cartItemsToRemove);
                    }
                }

                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                return Ok(new
                {
                    Message = "ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c táº¡o.",
                    OrderId = order.Id,
                    CartItemsRemoved = orderDto.UserId.HasValue // Indicate if cart items were removed
                });
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                return StatusCode(500, $"Lá»—i há»‡ thá»‘ng: {ex.Message}");
            }
        }

        // MoMo payment callback
        [HttpPost("momo/callback")]
        public async Task<IActionResult> MoMoCallback([FromBody] MoMoCallbackModel callback)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();

            try
            {
                // Verify signature
                var rawData = $"accessKey={_configuration["MoMoConfig:AccessKey"]}" +
                             $"&amount={callback.Amount}" +
                             $"&extraData=" +
                             $"&ipnUrl={_configuration["MoMoConfig:NotifyUrl"]}" +
                             $"&orderId={callback.OrderId}" +
                             $"&orderInfo={callback.OrderInfo}" +
                             $"&partnerCode={callback.PartnerCode}" +
                             $"&redirectUrl={_configuration["MoMoConfig:ReturnUrl"]}" +
                             $"&requestId={callback.RequestId}" +
                             $"&requestType={_configuration["MoMoConfig:RequestType"]}";

                if (!_momoService.VerifySignature(callback.Signature, rawData))
                {
                    return BadRequest("Invalid signature");
                }

                // Find order
                var orderIdStr = callback.OrderId.Replace("SHN", "");
                if (!int.TryParse(orderIdStr, out int orderId))
                {
                    return BadRequest("Invalid order ID");
                }

                var order = await _context.Orders
                    .Include(o => o.OrderItems)
                    .Include(o => o.User)
                    .FirstOrDefaultAsync(o => o.Id == orderId);

                if (order == null)
                {
                    return NotFound("Order not found");
                }

                // Update payment info
                order.MoMoTransId = callback.TransId;
                order.MoMoResponse = JsonConvert.SerializeObject(callback);

                // Process payment result
                if (callback.ResultCode == 0) // Success
                {
                    order.OrderStatus = "Paid";

                    // Trá»« sá»‘ lÆ°á»£ng tá»“n kho (náº¿u chÆ°a trá»«)
                    foreach (var item in order.OrderItems)
                    {
                        var variant = await _context.ProductVariants.FindAsync(item.ProductVariantId);
                        if (variant != null)
                        {
                            variant.StockQuantity -= item.Quantity;
                        }
                    }

                    // Mark voucher as used if exists
                    if (order.VoucherId.HasValue && order.UserId.HasValue)
                    {
                        var userVoucher = new UserVoucher
                        {
                            UserId = order.UserId.Value,
                            VoucherId = order.VoucherId.Value,
                            UsedAt = DateTime.UtcNow
                        };
                        _context.UserVouchers.Add(userVoucher);
                    }

                    await _context.SaveChangesAsync();
                    await transaction.CommitAsync();

                    // Tráº£ vá» URL xÃ¡c nháº­n
                    return Ok(new
                    {
                        Success = true,
                        RedirectUrl = $"/order-confirmation/{orderId}",
                        OrderId = orderId
                    });
                }
                else // Failed
                {
                    order.OrderStatus = "PaymentFailed";
                    await _context.SaveChangesAsync();
                    await transaction.CommitAsync();

                    return Ok(new
                    {
                        Success = false,
                        RedirectUrl = $"/checkout?payment=failed&orderId={orderId}",
                        Message = callback.Message
                    });
                }


            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                return StatusCode(500, $"Internal server error: {ex.Message}");
            }
        }

        // Láº¥y thÃ´ng tin Ä‘Æ¡n hÃ ng theo Id
        [HttpGet("{id}")]
        public async Task<IActionResult> GetOrderById(int id)
        {
            var order = await _context.Orders
                .Include(o => o.OrderItems)
                .FirstOrDefaultAsync(o => o.Id == id);

            if (order == null)
            {
                return NotFound("ÄÆ¡n hÃ ng khÃ´ng tá»“n táº¡i.");
            }

            var orderDto = new OrderDto
            {
                Id = order.Id,
                UserId = order.UserId,
                OrderDate = order.OrderDate,
                TotalAmount = order.TotalAmount,
                OrderStatus = order.OrderStatus,
                AddressId = order.AddressId,
                PaymentMethodId = order.PaymentMethodId,
                OrderItems = order.OrderItems.Select(oi => new OrderItemDto
                {
                    ProductVariantId = oi.ProductVariantId,
                    Quantity = oi.Quantity,
                    Price = oi.Price
                }).ToList()
            };

            return Ok(orderDto);
        }

        // XÃ³a Ä‘Æ¡n hÃ ng
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteOrder(int id)
        {
            var order = await _context.Orders.FindAsync(id);
            if (order == null)
            {
                return NotFound("ÄÆ¡n hÃ ng khÃ´ng tá»“n táº¡i.");
            }

            _context.Orders.Remove(order);
            await _context.SaveChangesAsync();

            return Ok(new { Message = "ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c xÃ³a." });
        }

        // Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng
        [HttpPut("{id}/status")]
        public async Task<IActionResult> UpdateOrderStatus(int id, [FromBody] UpdateStatusDto updateStatusDto)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();

            try
            {
                var order = await _context.Orders
                    .Include(o => o.User)
                    .FirstOrDefaultAsync(o => o.Id == id);

                if (order == null)
                {
                    return NotFound("ÄÆ¡n hÃ ng khÃ´ng tá»“n táº¡i.");
                }

                // LÆ°u tráº¡ng thÃ¡i cÅ© Ä‘á»ƒ kiá»ƒm tra
                var oldStatus = order.OrderStatus;
                order.OrderStatus = updateStatusDto.NewStatus;

                // Náº¿u chuyá»ƒn sang tráº¡ng thÃ¡i "Delivered" vÃ  trÆ°á»›c Ä‘Ã³ chÆ°a pháº£i lÃ  "Delivered"
                if (updateStatusDto.NewStatus == "Delivered" && oldStatus != "Delivered")
                {
                    // Cá»™ng 500 Ä‘iá»ƒm cho user
                    if (order.UserId.HasValue && order.User != null)
                    {
                        order.User.Points += 500;
                    }
                }

                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                return Ok(new { Message = "Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t." });
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                return StatusCode(500, $"Lá»—i há»‡ thá»‘ng: {ex.Message}");
            }
        }

        // Láº¥y danh sÃ¡ch Ä‘Æ¡n hÃ ng theo userId
        [HttpGet("user/{userId}")]
        public async Task<IActionResult> GetOrdersByUserId(int userId)
        {
            var orders = await _context.Orders
                .Where(o => o.UserId == userId)
                .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.ProductVariant)
                .ThenInclude(pv => pv.Product)
                .ThenInclude(p => p.Images) // Láº¥y hÃ¬nh áº£nh sáº£n pháº©m
                .ToListAsync();

            if (orders == null || orders.Count == 0)
            {
                return NotFound("KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng nÃ o cho ngÆ°á»i dÃ¹ng nÃ y.");
            }

            var orderDtos = orders.Select(order => new
            {
                Id = order.Id,
                UserId = order.UserId,
                OrderDate = order.OrderDate,
                TotalAmount = order.TotalAmount,
                OrderStatus = order.OrderStatus,
                AddressId = order.AddressId,
                PaymentMethodId = order.PaymentMethodId,
                Items = order.OrderItems.Select(oi => new
                {
                    ProductName = oi.ProductVariant.Product.Name,
                    ProductDescription = oi.ProductVariant.Product.Description,
                    ProductImage = oi.ProductVariant.Product.Images.FirstOrDefault(img => img.IsPrimary)?.ImageUrl,
                    VariantColor = oi.ProductVariant.Color,
                    VariantStorage = oi.ProductVariant.Storage,
                    Quantity = oi.Quantity,
                    Price = oi.Price
                }).ToList()
            }).ToList();

            return Ok(orderDtos);
        }

        [HttpGet("user/{userId}/paged")]
        public async Task<IActionResult> GetPagedOrdersByUserId(int userId, int page = 1, int pageSize = 10)
        {
            var query = _context.Orders
                .Where(o => o.UserId == userId)
                .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.ProductVariant)
                .ThenInclude(pv => pv.Product)
                .ThenInclude(p => p.Images) // Láº¥y hÃ¬nh áº£nh sáº£n pháº©m
                .OrderByDescending(o => o.OrderDate);

            var totalOrders = await query.CountAsync();
            var orders = await query
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .ToListAsync();

            var orderDtos = orders.Select(order => new
            {
                Id = order.Id,
                UserId = order.UserId,
                OrderDate = order.OrderDate,
                TotalAmount = order.TotalAmount,
                OrderStatus = order.OrderStatus,
                AddressId = order.AddressId,
                PaymentMethodId = order.PaymentMethodId,
                Items = order.OrderItems.Select(oi => new
                {
                    ProductId = oi.ProductVariant.Product.Id, // ThÃªm ProductId
                    ProductVariantId = oi.ProductVariantId,
                    ProductName = oi.ProductVariant.Product.Name,
                    ProductDescription = oi.ProductVariant.Product.Description,
                    ProductImage = oi.ProductVariant.Product.Images
                                .OrderByDescending(img => img.IsPrimary)
                                .ThenBy(img => img.Id)
                                .FirstOrDefault()?.ImageUrl ?? "/images/default-product.png",
                    VariantColor = oi.ProductVariant.Color,
                    VariantStorage = oi.ProductVariant.Storage,
                    Quantity = oi.Quantity,
                    Price = oi.Price
                }).ToList()
            }).ToList();

            return Ok(new
            {
                TotalOrders = totalOrders,
                Page = page,
                PageSize = pageSize,
                Orders = orderDtos
            });
        }
        // Tá»•ng doanh thu theo ngÃ y
        [HttpGet("revenue/day")]
        public async Task<IActionResult> GetDailyRevenue()
        {
            var today = DateTime.UtcNow.Date;
            var revenue = await _context.Orders
                .Where(o => o.OrderDate.Date == today && o.OrderStatus == "Delivered")
                .SumAsync(o => o.TotalAmount);

            return Ok(new { Revenue = revenue });
        }

        // Tá»•ng doanh thu theo tuáº§n
        [HttpGet("revenue/week")]
        public async Task<IActionResult> GetWeeklyRevenue()
        {
            var startOfWeek = DateTime.UtcNow.Date.AddDays(-(int)DateTime.UtcNow.DayOfWeek);
            var revenue = await _context.Orders
                .Where(o => o.OrderDate.Date >= startOfWeek && o.OrderStatus == "Delivered")
                .SumAsync(o => o.TotalAmount);

            return Ok(new { Revenue = revenue });
        }

        // Tá»•ng doanh thu theo thÃ¡ng
        [HttpGet("revenue/month")]
        public async Task<IActionResult> GetMonthlyRevenue()
        {
            var startOfMonth = new DateTime(DateTime.UtcNow.Year, DateTime.UtcNow.Month, 1);
            var revenue = await _context.Orders
                .Where(o => o.OrderDate.Date >= startOfMonth && o.OrderStatus == "Delivered")
                .SumAsync(o => o.TotalAmount);

            return Ok(new { Revenue = revenue });
        }

        // Tá»•ng doanh thu theo nÄƒm
        [HttpGet("revenue/year")]
        public async Task<IActionResult> GetYearlyRevenue()
        {
            var startOfYear = new DateTime(DateTime.UtcNow.Year, 1, 1);
            var revenue = await _context.Orders
                .Where(o => o.OrderDate.Date >= startOfYear && o.OrderStatus == "Delivered")
                .SumAsync(o => o.TotalAmount);

            return Ok(new { Revenue = revenue });
        }

        // Sá»‘ lÆ°á»£ng Ä‘Æ¡n hÃ ng Ä‘Ã£ hoÃ n thÃ nh
        [HttpGet("completed-orders")]
        public async Task<IActionResult> GetCompletedOrdersCount()
        {
            var count = await _context.Orders
                .Where(o => o.OrderStatus == "Delivered")
                .CountAsync();

            return Ok(new { CompletedOrders = count });
        }

        // Sá»‘ lÆ°á»£ng Ä‘Æ¡n hÃ ng chá» xÃ¡c nháº­n
        [HttpGet("pending-orders")]
        public async Task<IActionResult> GetPendingOrdersCount()
        {
            var count = await _context.Orders
                .Where(o => o.OrderStatus == "Pending")
                .CountAsync();

            return Ok(new { PendingOrders = count });
        }

        // Tá»•ng tiá»n Ä‘Æ¡n hÃ ng Ä‘Ã£ hoÃ n thÃ nh
        [HttpGet("completed-orders-total")]
        public async Task<IActionResult> GetCompletedOrdersTotal()
        {
            var total = await _context.Orders
                .Where(o => o.OrderStatus == "Delivered")
                .SumAsync(o => o.TotalAmount);

            return Ok(new { CompletedOrdersTotal = total });
        }

        // Tá»•ng doanh thu
        [HttpGet("total-revenue")]
        public async Task<IActionResult> GetTotalRevenue()
        {
            var totalRevenue = await _context.Orders
                .Where(o => o.OrderStatus == "Delivered")
                .SumAsync(o => o.TotalAmount);

            return Ok(new { TotalRevenue = totalRevenue });
        }

        [HttpGet("{id}/details")]
        public async Task<IActionResult> GetOrderDetails(int id)
        {
            var order = await _context.Orders
                .Include(o => o.OrderItems)
                    .ThenInclude(oi => oi.ProductVariant)
                        .ThenInclude(pv => pv.Product) // ThÃªm ThenInclude Ä‘á»ƒ láº¥y Product
                                        .ThenInclude(p => p.Images) // QUAN TRá»ŒNG: Include cáº£ Images

                .Include(o => o.Address)
                .FirstOrDefaultAsync(o => o.Id == id);

            if (order == null)
            {
                return NotFound("ÄÆ¡n hÃ ng khÃ´ng tá»“n táº¡i.");
            }

            Console.WriteLine($"Order {id} has {order.OrderItems.Count} items");

            var orderDetails = new
            {
                Id = order.Id,
                UserId = order.UserId,
                OrderDate = order.OrderDate,
                TotalAmount = order.TotalAmount,
                OrderStatus = order.OrderStatus,
                AddressId = order.AddressId,
                Address = order.Address != null ? new
                {
                    Id = order.Address.Id,
                    FullName = order.Address.FullName,
                    PhoneNumber = order.Address.PhoneNumber,
                    AddressLine1 = order.Address.AddressLine1,
                    AddressLine2 = order.Address.AddressLine2,
                    City = order.Address.City,
                    State = order.Address.State,
                    ZipCode = order.Address.ZipCode,
                    Country = order.Address.Country
                } : null,
                PaymentMethodId = order.PaymentMethodId,
                Items = order.OrderItems.Select(oi => new
                {
                    VariantId = oi.ProductVariantId,
                    Quantity = oi.Quantity,
                    Price = oi.Price,
                    // ProductImage = oi.ProductVariant?.Product?.Images, // Láº¥y áº£nh tá»« Product
                    ProductImage = oi.ProductVariant.Product.Images
                                .OrderByDescending(img => img.IsPrimary)
                                .ThenBy(img => img.Id)
                                .FirstOrDefault()?.ImageUrl ?? "/images/default-product.png",
                    ProductName = oi.ProductVariant?.Product?.Name // CÃ³ thá»ƒ thÃªm tÃªn sáº£n pháº©m náº¿u cáº§n
                }).ToList()
            };

            return Ok(orderDetails);
        }
        [HttpGet("{orderId}/export/excel")]
        public async Task<IActionResult> ExportOrderToExcel(int orderId)
        {
            try
            {
                // Láº¥y thÃ´ng tin Ä‘Æ¡n hÃ ng tá»« database
                var order = await _context.Orders
                    .Include(o => o.OrderItems)
                    .ThenInclude(oi => oi.ProductVariant)
                    .ThenInclude(pv => pv.Product)
                    .Include(o => o.Address)
                    .FirstOrDefaultAsync(o => o.Id == orderId);

                if (order == null)
                {
                    return NotFound(new { Message = $"KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng vá»›i ID {orderId}" });
                }

                // Táº¡o file Excel vá»›i EPPlus
                using (var excelPackage = new ExcelPackage())
                {
                    // Táº¡o worksheet
                    var worksheet = excelPackage.Workbook.Worksheets.Add("HÃ³a Ä‘Æ¡n");

                    // Äá»‹nh dáº¡ng tiÃªu Ä‘á»
                    worksheet.Cells["A1"].Value = "HÃ“A ÄÆ N BÃN HÃ€NG";
                    worksheet.Cells["A1:E1"].Merge = true;
                    worksheet.Cells["A1"].Style.Font.Bold = true;
                    worksheet.Cells["A1"].Style.Font.Size = 16;
                    worksheet.Cells["A1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    // ThÃ´ng tin Ä‘Æ¡n hÃ ng
                    worksheet.Cells["A3"].Value = "MÃ£ Ä‘Æ¡n hÃ ng:";
                    worksheet.Cells["B3"].Value = order.Id;
                    worksheet.Cells["A4"].Value = "NgÃ y táº¡o:";
                    worksheet.Cells["B4"].Value = order.OrderDate.ToString("dd/MM/yyyy HH:mm");
                    worksheet.Cells["A5"].Value = "KhÃ¡ch hÃ ng:";
                    worksheet.Cells["B5"].Value = order.Address?.FullName ?? "N/A";

                    // TiÃªu Ä‘á» báº£ng
                    var headerRow = 7;
                    worksheet.Cells[headerRow, 1].Value = "STT";
                    worksheet.Cells[headerRow, 2].Value = "TÃªn sáº£n pháº©m";
                    worksheet.Cells[headerRow, 3].Value = "Sá»‘ lÆ°á»£ng";
                    worksheet.Cells[headerRow, 4].Value = "ÄÆ¡n giÃ¡";
                    worksheet.Cells[headerRow, 5].Value = "ThÃ nh tiá»n";

                    // Äá»‹nh dáº¡ng tiÃªu Ä‘á» báº£ng
                    using (var range = worksheet.Cells[headerRow, 1, headerRow, 5])
                    {
                        range.Style.Font.Bold = true;
                        range.Style.Fill.PatternType = ExcelFillStyle.Solid;
                        range.Style.Fill.BackgroundColor.SetColor(Color.LightGray);
                    }

                    // Äá»• dá»¯ liá»‡u sáº£n pháº©m
                    int row = 8;
                    foreach (var item in order.OrderItems)
                    {
                        worksheet.Cells[row, 1].Value = row - headerRow;
                        worksheet.Cells[row, 2].Value = item.ProductVariant.Product.Name;
                        worksheet.Cells[row, 3].Value = item.Quantity;
                        worksheet.Cells[row, 4].Value = item.Price;
                        worksheet.Cells[row, 4].Style.Numberformat.Format = "#,##0";
                        worksheet.Cells[row, 5].Value = item.Quantity * item.Price;
                        worksheet.Cells[row, 5].Style.Numberformat.Format = "#,##0";
                        row++;
                    }

                    // Tá»•ng cá»™ng
                    worksheet.Cells[row, 4].Value = "Tá»•ng cá»™ng:";
                    worksheet.Cells[row, 4].Style.Font.Bold = true;
                    worksheet.Cells[row, 5].Value = order.TotalAmount;
                    worksheet.Cells[row, 5].Style.Font.Bold = true;
                    worksheet.Cells[row, 5].Style.Numberformat.Format = "#,##0";

                    // Tá»± Ä‘á»™ng Ä‘iá»u chá»‰nh Ä‘á»™ rá»™ng cá»™t
                    worksheet.Cells[worksheet.Dimension.Address].AutoFitColumns();

                    // Xuáº¥t file
                    var stream = new MemoryStream();
                    excelPackage.SaveAs(stream);
                    stream.Position = 0;

                    return File(
                        fileContents: stream.ToArray(),
                        contentType: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                        fileDownloadName: $"HoaDon_{orderId}.xlsx");
                }
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { Message = "ÄÃ£ xáº£y ra lá»—i khi xuáº¥t file Excel" });
            }
        }

        // HÃ m chuyá»ƒn Ä‘á»•i sá»‘ thÃ nh chá»¯ tiáº¿ng Viá»‡t (Cáº¦N TRIá»‚N KHAI HOáº¶C DÃ™NG THÆ¯ VIá»†N)
        private string ConvertNumberToWords_VI(decimal number)
        {
            if (number == 0) return "KhÃ´ng Ä‘á»“ng";
            // HÃ m NumberToTextVN.DocSo chá»‹u trÃ¡ch nhiá»‡m chÃ­nh cho viá»‡c chuyá»ƒn Ä‘á»•i.
            // ThÃªm "(... Ä‘á»“ng cháºµn./.)" lÃ  má»™t quy Æ°á»›c thÆ°á»ng tháº¥y trÃªn hÃ³a Ä‘Æ¡n.
            return $"({NumberToTextVN.DocSo((long)Math.Round(number))} Ä‘á»“ng cháºµn./.)";
        }


        private async Task<OrderInvoiceViewModel> PrepareInvoiceViewModel(int orderId)
        {
            var order = await _context.Orders
                .Include(o => o.OrderItems)
                    .ThenInclude(oi => oi.ProductVariant)
                        .ThenInclude(pv => pv.Product)
                .Include(o => o.Address)
                .Include(o => o.PaymentMethod)
                // .Include(o => o.User) // KhÃ´ng cÃ²n cáº§n User náº¿u chá»‰ láº¥y TaxCode tá»« Ä‘Ã³
                .FirstOrDefaultAsync(o => o.Id == orderId);

            if (order == null)
            {
                return null;
            }

            var sellerInfo = new SellerInfo();

            decimal subtotal = order.OrderItems.Sum(oi => oi.Quantity * oi.Price);
            decimal vatRate = 0.1m;
            decimal vatAmount = subtotal * vatRate;
            decimal finalTotal = subtotal + vatAmount;

            // KhÃ´ng cÃ²n láº¥y BuyerTaxCode ná»¯a
            // string buyerTaxCode = order.User?.TaxCode; 
            // if (string.IsNullOrEmpty(buyerTaxCode) && order.Address is ExtendedAddress extAddr)
            // {
            //     buyerTaxCode = extAddr.TaxCode;
            // }

            var viewModel = new OrderInvoiceViewModel
            {
                OrderId = order.Id,
                OrderDate = order.OrderDate,
                Seller = sellerInfo,
                BuyerFullName = order.Address?.FullName ?? "N/A",
                BuyerAddress = order.Address?.AddressLine1 ?? "N/A",
                // BuyerTaxCode = buyerTaxCode ?? "N/A", // <<<< LOáº I Bá» DÃ’NG NÃ€Y
                PaymentMethodName = order.PaymentMethod?.Name ?? "Tiá»n máº·t",
                Items = order.OrderItems.Select((item, index) => new InvoiceItemViewModel
                {
                    Index = index + 1,
                    ProductName = item.ProductVariant?.Product?.Name ?? "N/A",
                    Quantity = item.Quantity,
                    Price = item.Price
                }).ToList(),
                SubtotalAmount = subtotal,
                VatRate = vatRate,
                VatAmount = vatAmount,
                FinalTotalAmount = finalTotal,
                TotalAmountInWords = ConvertNumberToWords_VI(finalTotal)
            };

            return viewModel;
        }

        [HttpGet("{id}/export/image")]
        public async Task<IActionResult> ExportOrderToImage(int id)
        {
            try
            {
                var invoiceData = await PrepareInvoiceViewModel(id);
                if (invoiceData == null)
                {
                    return NotFound("KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng hoáº·c khÃ´ng thá»ƒ chuáº©n bá»‹ dá»¯ liá»‡u hÃ³a Ä‘Æ¡n.");
                }

                int width = 800;
                float currentY = 10f;
                float lineSpacing = 5f;
                float sectionSpacing = 15f;
                float leftMargin = 20f;
                float rightMarginContent = width - 20f;

                var titleFont = new System.Drawing.Font("Arial", 16, System.Drawing.FontStyle.Bold);
                var headerFont = new System.Drawing.Font("Arial", 10, System.Drawing.FontStyle.Bold);
                var normalFont = new System.Drawing.Font("Arial", 9, System.Drawing.FontStyle.Regular);
                var smallFont = new System.Drawing.Font("Arial", 8, System.Drawing.FontStyle.Regular);
                var blackBrush = Brushes.Black;
                var grayBrush = Brushes.Gray;

                var sfCenter = new StringFormat { Alignment = StringAlignment.Center };
                var sfRight = new StringFormat { Alignment = StringAlignment.Far };
                var sfLeft = new StringFormat { Alignment = StringAlignment.Near };

                int baseHeight = 430; // Giáº£m nháº¹ baseHeight do bá» BuyerTaxCode
                int itemRowHeight = 20;
                int calculatedHeight = baseHeight + (invoiceData.Items.Count * itemRowHeight) + (invoiceData.Items.Count > 0 ? 20 : 0);
                int height = Math.Max(580, calculatedHeight); // Giáº£m chiá»u cao tá»‘i thiá»ƒu náº¿u cáº§n

                using (var bitmap = new Bitmap(width, height))
                using (var graphics = Graphics.FromImage(bitmap))
                {
                    graphics.Clear(Color.White);
                    graphics.SmoothingMode = SmoothingMode.AntiAlias;
                    graphics.TextRenderingHint = System.Drawing.Text.TextRenderingHint.AntiAliasGridFit;

                    var sellerInfo = invoiceData.Seller;

                    // Váº½ ThÃ´ng tin ngÆ°á»i bÃ¡n
                    graphics.DrawString(sellerInfo.CompanyName, headerFont, blackBrush, leftMargin, currentY);
                    currentY += headerFont.GetHeight(graphics) + lineSpacing;
                    graphics.DrawString(sellerInfo.Address, normalFont, blackBrush, leftMargin, currentY);
                    currentY += normalFont.GetHeight(graphics) + lineSpacing;
                    graphics.DrawString(sellerInfo.TaxCode, normalFont, blackBrush, leftMargin, currentY);
                    currentY += normalFont.GetHeight(graphics) + lineSpacing;
                    graphics.DrawString(sellerInfo.PhoneNumber, normalFont, blackBrush, leftMargin, currentY);
                    currentY += normalFont.GetHeight(graphics) + sectionSpacing;

                    // Váº½ ThÃ´ng tin hÃ³a Ä‘Æ¡n (Máº«u sá»‘, KÃ½ hiá»‡u, Sá»‘)
                    float initialYForInvoiceMeta = 10f;
                    graphics.DrawString($"Máº«u sá»‘: {invoiceData.InvoiceTemplateNo}", normalFont, blackBrush, width - 200, initialYForInvoiceMeta, sfLeft);
                    initialYForInvoiceMeta += normalFont.GetHeight(graphics) + lineSpacing;
                    graphics.DrawString($"KÃ½ hiá»‡u: {invoiceData.InvoiceSeries}", normalFont, blackBrush, width - 200, initialYForInvoiceMeta, sfLeft);
                    initialYForInvoiceMeta += normalFont.GetHeight(graphics) + lineSpacing;
                    graphics.DrawString($"Sá»‘: {invoiceData.InvoiceNumberFormatted}", normalFont, blackBrush, width - 200, initialYForInvoiceMeta, sfLeft);

                    // Váº½ TiÃªu Ä‘á» hÃ³a Ä‘Æ¡n
                    string invoiceTitle = "HÃ“A ÄÆ N BÃN HÃ€NG";
                    SizeF titleSize = graphics.MeasureString(invoiceTitle, titleFont);
                    graphics.DrawString(invoiceTitle, titleFont, blackBrush, (width - titleSize.Width) / 2, currentY);
                    currentY += titleSize.Height + lineSpacing;
                    SizeF dateSize = graphics.MeasureString(invoiceData.FormattedOrderDate, normalFont);
                    graphics.DrawString(invoiceData.FormattedOrderDate, normalFont, blackBrush, (width - dateSize.Width) / 2, currentY);
                    currentY += dateSize.Height + sectionSpacing;

                    // Váº½ ThÃ´ng tin ngÆ°á»i mua (Ä‘Ã£ bá» MÃ£ sá»‘ thuáº¿)
                    graphics.DrawString($"ÄÆ¡n vá»‹ mua hÃ ng (Há» tÃªn ngÆ°á»i mua): {invoiceData.BuyerFullName}", normalFont, blackBrush, leftMargin, currentY);
                    currentY += normalFont.GetHeight(graphics) + lineSpacing;
                    graphics.DrawString($"Äá»‹a chá»‰: {invoiceData.BuyerAddress}", normalFont, blackBrush, leftMargin, currentY);
                    currentY += normalFont.GetHeight(graphics) + lineSpacing;
                    graphics.DrawString($"HÃ¬nh thá»©c thanh toÃ¡n: {invoiceData.PaymentMethodName}", normalFont, blackBrush, leftMargin, currentY);
                    currentY += normalFont.GetHeight(graphics) + sectionSpacing;

                    // Váº½ Báº£ng chi tiáº¿t sáº£n pháº©m (Ä‘Ã£ bá» cá»™t ÄVT)
                    float tableHeaderY = currentY;
                    float colSttX = leftMargin;
                    float colProductNameX = colSttX + 40;
                    float colQuantityX = colProductNameX + 380; // TÄƒng chiá»u rá»™ng cá»™t TÃªn sáº£n pháº©m thÃªm
                    float colUnitPriceX = colQuantityX + 100;  // Dá»‹ch chuyá»ƒn cá»™t Sá»‘ lÆ°á»£ng
                    float colAmountX = colUnitPriceX + 100;    // Dá»‹ch chuyá»ƒn cá»™t ÄÆ¡n giÃ¡

                    graphics.DrawLine(Pens.Black, leftMargin, tableHeaderY, rightMarginContent, tableHeaderY);
                    tableHeaderY += lineSpacing;
                    graphics.DrawString("STT", headerFont, blackBrush, colSttX, tableHeaderY);
                    graphics.DrawString("TÃªn hÃ ng hÃ³a, dá»‹ch vá»¥", headerFont, blackBrush, colProductNameX, tableHeaderY);
                    graphics.DrawString("Sá»‘ lÆ°á»£ng", headerFont, blackBrush, colQuantityX, tableHeaderY, sfRight);
                    graphics.DrawString("ÄÆ¡n giÃ¡", headerFont, blackBrush, colUnitPriceX, tableHeaderY, sfRight);
                    graphics.DrawString("ThÃ nh tiá»n", headerFont, blackBrush, colAmountX, tableHeaderY, sfRight);

                    tableHeaderY += headerFont.GetHeight(graphics) + lineSpacing;
                    graphics.DrawLine(Pens.Black, leftMargin, tableHeaderY, rightMarginContent, tableHeaderY);
                    currentY = tableHeaderY;

                    if (invoiceData.Items.Any())
                    {
                        foreach (var item in invoiceData.Items)
                        {
                            currentY += lineSpacing;
                            graphics.DrawString(item.Index.ToString(), normalFont, blackBrush, colSttX + 5, currentY);
                            graphics.DrawString(item.ProductName, normalFont, blackBrush, colProductNameX, currentY, new StringFormat { Trimming = StringTrimming.EllipsisCharacter });
                            graphics.DrawString(item.Quantity.ToString(), normalFont, blackBrush, colQuantityX, currentY, sfRight);
                            graphics.DrawString(item.Price.ToString("N0"), normalFont, blackBrush, colUnitPriceX, currentY, sfRight);
                            graphics.DrawString(item.Amount.ToString("N0"), normalFont, blackBrush, colAmountX, currentY, sfRight);
                            currentY += itemRowHeight;
                            graphics.DrawLine(Pens.LightGray, leftMargin, currentY, rightMarginContent, currentY);
                        }
                    }
                    else
                    {
                        currentY += itemRowHeight;
                        graphics.DrawString("KhÃ´ng cÃ³ sáº£n pháº©m/dá»‹ch vá»¥.", normalFont, grayBrush, (width - graphics.MeasureString("KhÃ´ng cÃ³ sáº£n pháº©m/dá»‹ch vá»¥.", normalFont).Width) / 2, currentY);
                        currentY += itemRowHeight;
                        graphics.DrawLine(Pens.LightGray, leftMargin, currentY, rightMarginContent, currentY);
                    }

                    // Váº½ Pháº§n tá»•ng cá»™ng
                    currentY += lineSpacing;
                    float summaryLabelX = colUnitPriceX - 120; // Äiá»u chá»‰nh cho phÃ¹ há»£p vá»›i cá»™t má»›i
                    float summaryValueX = colAmountX;

                    graphics.DrawString("Cá»™ng tiá»n hÃ ng:", normalFont, blackBrush, summaryLabelX, currentY, sfRight);
                    graphics.DrawString(invoiceData.SubtotalAmount.ToString("N0"), normalFont, blackBrush, summaryValueX, currentY, sfRight);
                    currentY += normalFont.GetHeight(graphics) + lineSpacing;

                    if (invoiceData.VatAmount > 0)
                    {
                        graphics.DrawString($"Thuáº¿ GTGT ({invoiceData.VatRateFormatted}):", normalFont, blackBrush, summaryLabelX, currentY, sfRight);
                        graphics.DrawString(invoiceData.VatAmount.ToString("N0"), normalFont, blackBrush, summaryValueX, currentY, sfRight);
                        currentY += normalFont.GetHeight(graphics) + lineSpacing;
                    }

                    graphics.DrawLine(Pens.Black, summaryLabelX - 70, currentY, rightMarginContent, currentY);
                    currentY += lineSpacing;

                    graphics.DrawString("Tá»”NG Cá»˜NG THANH TOÃN:", headerFont, blackBrush, summaryLabelX, currentY, sfRight);
                    graphics.DrawString(invoiceData.FinalTotalAmount.ToString("N0"), headerFont, blackBrush, summaryValueX, currentY, sfRight);
                    currentY += headerFont.GetHeight(graphics) + lineSpacing;

                    RectangleF wordsRect = new RectangleF(leftMargin, currentY, width - leftMargin - leftMargin, 40);
                    graphics.DrawString($"Sá»‘ tiá»n viáº¿t báº±ng chá»¯: {invoiceData.TotalAmountInWords}", normalFont, blackBrush, wordsRect, sfLeft);
                    currentY += 40 + sectionSpacing;

                    // Váº½ Chá»¯ kÃ½
                    float signatureY = Math.Max(currentY, height - 100);
                    float buyerSignatureX = leftMargin + 100; // Äiá»u chá»‰nh vá»‹ trÃ­ chá»¯ kÃ½
                    float sellerSignatureX = width - 100 - graphics.MeasureString("NgÆ°á»i bÃ¡n hÃ ng", headerFont).Width / 2 - 50; // Äiá»u chá»‰nh

                    graphics.DrawString("NgÆ°á»i mua hÃ ng", headerFont, blackBrush, buyerSignatureX, signatureY, sfCenter);
                    graphics.DrawString("(KÃ½, ghi rÃµ há» tÃªn)", smallFont, blackBrush, buyerSignatureX, signatureY + headerFont.GetHeight(graphics) + 2, sfCenter);

                    graphics.DrawString("NgÆ°á»i bÃ¡n hÃ ng", headerFont, blackBrush, sellerSignatureX, signatureY, sfCenter);
                    graphics.DrawString("(KÃ½, ghi rÃµ há» tÃªn, Ä‘Ã³ng dáº¥u)", smallFont, blackBrush, sellerSignatureX, signatureY + headerFont.GetHeight(graphics) + 2, sfCenter);

                    // Váº½ Footer
                    string footerMessage = "Xin cáº£m Æ¡n QuÃ½ khÃ¡ch!";
                    SizeF footerSize = graphics.MeasureString(footerMessage, normalFont);
                    graphics.DrawString(footerMessage, normalFont, grayBrush, (width - footerSize.Width) / 2, height - footerSize.Height - 10);

                    using (var stream = new MemoryStream())
                    {
                        bitmap.Save(stream, ImageFormat.Png);
                        stream.Position = 0;
                        return File(stream.ToArray(), "image/png", $"HoaDon_{invoiceData.OrderId}_{DateTime.Now:yyyyMMddHHmmss}.png");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Lá»—i khi xuáº¥t hÃ³a Ä‘Æ¡n áº£nh cho Order ID {id}: {ex.ToString()}");
                return StatusCode(500, $"Lá»—i mÃ¡y chá»§ ná»™i bá»™ khi xuáº¥t hÃ³a Ä‘Æ¡n áº£nh: {ex.Message}");
            }
        }

        // --- HÃ€M XUáº¤T HÃ“A ÄÆ N RA PDF ---
        [HttpGet("{id}/export/template")]
        public async Task<IActionResult> ExportOrderToPdf(int id)
        {
            try
            {
                var invoiceData = await PrepareInvoiceViewModel(id);
                if (invoiceData == null)
                {
                    return NotFound("KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng hoáº·c khÃ´ng thá»ƒ chuáº©n bá»‹ dá»¯ liá»‡u hÃ³a Ä‘Æ¡n.");
                }

                using (var stream = new MemoryStream())
                {
                    var document = new Document(PageSize.A4, 30, 30, 30, 30);
                    PdfWriter writer = PdfWriter.GetInstance(document, stream);
                    document.Open();

                    BaseFont bfBase;
                    try
                    {
                        string baseDirectory = AppDomain.CurrentDomain.BaseDirectory;
                        string fontFileName = "times.ttf"; // HOáº¶C "arial.ttf" - Äáº¢M Báº¢O FILE NÃ€Y Tá»’N Táº I
                        string fontPath = Path.Combine(baseDirectory, "Fonts", fontFileName);
                        if (!System.IO.File.Exists(fontPath))
                        {
                            // Thá»­ tÃ¬m trong thÆ° má»¥c font há»‡ thá»‘ng nhÆ° má»™t giáº£i phÃ¡p dá»± phÃ²ng cuá»‘i cÃ¹ng
                            string systemFontPath = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.Fonts), fontFileName);
                            if (System.IO.File.Exists(systemFontPath))
                            {
                                fontPath = systemFontPath;
                            }
                            else
                            {
                                throw new FileNotFoundException($"File font '{fontFileName}' khÃ´ng Ä‘Æ°á»£c tÃ¬m tháº¥y táº¡i '{Path.Combine(baseDirectory, "Fonts")}' hoáº·c trong thÆ° má»¥c font há»‡ thá»‘ng.");
                            }
                        }
                        bfBase = BaseFont.CreateFont(fontPath, BaseFont.IDENTITY_H, BaseFont.EMBEDDED);
                    }
                    catch (Exception fontEx)
                    {
                        Console.Error.WriteLine($"Lá»–I nghiÃªm trá»ng khi táº£i font: {fontEx.ToString()}. PDF cÃ³ thá»ƒ khÃ´ng hiá»ƒn thá»‹ Ä‘Ãºng tiáº¿ng Viá»‡t. Sá»­ dá»¥ng font máº·c Ä‘á»‹nh.");
                        bfBase = BaseFont.CreateFont(BaseFont.HELVETICA, BaseFont.CP1252, BaseFont.EMBEDDED);
                    }

                    iTextSharp.text.Font fontTitle = new iTextSharp.text.Font(bfBase, 18, iTextSharp.text.Font.BOLD);
                    iTextSharp.text.Font fontHeader = new iTextSharp.text.Font(bfBase, 11, iTextSharp.text.Font.BOLD);
                    iTextSharp.text.Font fontNormal = new iTextSharp.text.Font(bfBase, 10, iTextSharp.text.Font.NORMAL);
                    iTextSharp.text.Font fontNormalBold = new iTextSharp.text.Font(bfBase, 10, iTextSharp.text.Font.BOLD);
                    iTextSharp.text.Font fontSmall = new iTextSharp.text.Font(bfBase, 9, iTextSharp.text.Font.NORMAL);

                    // Váº½ Header (ThÃ´ng tin ngÆ°á»i bÃ¡n & ThÃ´ng tin hÃ³a Ä‘Æ¡n)
                    PdfPTable headerTable = new PdfPTable(2) { WidthPercentage = 100 };
                    headerTable.SetWidths(new float[] { 60f, 40f });
                    PdfPCell sellerCell = new PdfPCell { Border = PdfPCell.NO_BORDER, Padding = 5f };
                    sellerCell.AddElement(new Paragraph(invoiceData.Seller.CompanyName, fontHeader));
                    sellerCell.AddElement(new Paragraph(invoiceData.Seller.Address, fontNormal));
                    sellerCell.AddElement(new Paragraph(invoiceData.Seller.TaxCode, fontNormal));
                    sellerCell.AddElement(new Paragraph(invoiceData.Seller.PhoneNumber, fontNormal));
                    headerTable.AddCell(sellerCell);
                    PdfPCell invoiceMetaCell = new PdfPCell { Border = PdfPCell.NO_BORDER, Padding = 5f };
                    invoiceMetaCell.AddElement(new Paragraph($"Máº«u sá»‘: {invoiceData.InvoiceTemplateNo}", fontNormal) { Alignment = Element.ALIGN_RIGHT });
                    invoiceMetaCell.AddElement(new Paragraph($"KÃ½ hiá»‡u: {invoiceData.InvoiceSeries}", fontNormal) { Alignment = Element.ALIGN_RIGHT });
                    invoiceMetaCell.AddElement(new Paragraph($"Sá»‘: {invoiceData.InvoiceNumberFormatted}", fontNormal) { Alignment = Element.ALIGN_RIGHT });
                    document.Add(headerTable);

                    // Váº½ TiÃªu Ä‘á» hÃ³a Ä‘Æ¡n
                    Paragraph title = new Paragraph("HÃ“A ÄÆ N BÃN HÃ€NG", fontTitle)
                    { Alignment = Element.ALIGN_CENTER, SpacingBefore = 10f, SpacingAfter = 5f };
                    document.Add(title);
                    Paragraph invoiceDate = new Paragraph(invoiceData.FormattedOrderDate, fontNormal)
                    { Alignment = Element.ALIGN_CENTER, SpacingAfter = 20f };
                    document.Add(invoiceDate);

                    // Váº½ ThÃ´ng tin ngÆ°á»i mua (Ä‘Ã£ bá» MÃ£ sá»‘ thuáº¿)
                    document.Add(new Paragraph($"ÄÆ¡n vá»‹ mua hÃ ng (Há» tÃªn ngÆ°á»i mua): {invoiceData.BuyerFullName}", fontNormal));
                    document.Add(new Paragraph($"Äá»‹a chá»‰: {invoiceData.BuyerAddress}", fontNormal));
                    document.Add(new Paragraph($"HÃ¬nh thá»©c thanh toÃ¡n: {invoiceData.PaymentMethodName}", fontNormal));
                    document.Add(new Paragraph(" ") { SpacingAfter = 5f });

                    // Váº½ Báº£ng chi tiáº¿t sáº£n pháº©m (Ä‘Ã£ bá» cá»™t ÄVT)
                    PdfPTable itemsTable = new PdfPTable(5); // 5 cá»™t
                    itemsTable.WidthPercentage = 100;
                    itemsTable.SetWidths(new float[] { 5f, 50f, 10f, 15f, 20f }); // STT, TÃªn, SL, ÄÆ¡n giÃ¡, ThÃ nh tiá»n
                    itemsTable.SpacingBefore = 10f;

                    string[] tableHeaders = { "STT", "TÃªn hÃ ng hÃ³a, dá»‹ch vá»¥", "Sá»‘ lÆ°á»£ng", "ÄÆ¡n giÃ¡ (VNÄ)", "ThÃ nh tiá»n (VNÄ)" };
                    foreach (string headerText in tableHeaders)
                    {
                        PdfPCell headerCell = new PdfPCell(new Phrase(headerText, fontNormalBold))
                        { HorizontalAlignment = Element.ALIGN_CENTER, VerticalAlignment = Element.ALIGN_MIDDLE, BackgroundColor = new BaseColor(217, 217, 217), Padding = 5f };
                        itemsTable.AddCell(headerCell);
                    }

                    foreach (var item in invoiceData.Items)
                    {
                        itemsTable.AddCell(new PdfPCell(new Phrase(item.Index.ToString(), fontNormal)) { Padding = 5f, HorizontalAlignment = Element.ALIGN_CENTER });
                        itemsTable.AddCell(new PdfPCell(new Phrase(item.ProductName, fontNormal)) { Padding = 5f });
                        itemsTable.AddCell(new PdfPCell(new Phrase(item.Quantity.ToString(), fontNormal)) { Padding = 5f, HorizontalAlignment = Element.ALIGN_RIGHT });
                        itemsTable.AddCell(new PdfPCell(new Phrase(item.Price.ToString("N0"), fontNormal)) { Padding = 5f, HorizontalAlignment = Element.ALIGN_RIGHT });
                        itemsTable.AddCell(new PdfPCell(new Phrase(item.Amount.ToString("N0"), fontNormal)) { Padding = 5f, HorizontalAlignment = Element.ALIGN_RIGHT });
                    }
                    document.Add(itemsTable);

                    // Váº½ Pháº§n tá»•ng káº¿t
                    PdfPTable summaryTable = new PdfPTable(2) { WidthPercentage = 100, SpacingBefore = 10f };
                    summaryTable.SetWidths(new float[] { 75f, 25f });
                    summaryTable.DefaultCell.Border = PdfPCell.NO_BORDER;
                    summaryTable.DefaultCell.Padding = 3f;
                    summaryTable.AddCell(new Phrase("Cá»™ng tiá»n hÃ ng:", fontNormal));
                    var subtotalCell = new PdfPCell(new Phrase(invoiceData.SubtotalAmount.ToString("N0") + " VNÄ", fontNormal));
                    subtotalCell.HorizontalAlignment = Element.ALIGN_RIGHT;
                    summaryTable.AddCell(subtotalCell);
                    summaryTable.AddCell(new Phrase($"Tiá»n thuáº¿ GTGT ({invoiceData.VatRateFormatted}):", fontNormal));
                    var vatAmountCell = new PdfPCell(new Phrase(invoiceData.VatAmount.ToString("N0") + " VNÄ", fontNormal));
                    vatAmountCell.HorizontalAlignment = Element.ALIGN_RIGHT;
                    summaryTable.AddCell(vatAmountCell);
                    summaryTable.AddCell(new Phrase("Tá»•ng cá»™ng tiá»n thanh toÃ¡n:", fontNormalBold));
                    var finalTotalCell = new PdfPCell(new Phrase(invoiceData.FinalTotalAmount.ToString("N0") + " VNÄ", fontNormalBold));
                    finalTotalCell.HorizontalAlignment = Element.ALIGN_RIGHT;
                    summaryTable.AddCell(finalTotalCell);
                    document.Add(summaryTable);

                    Paragraph amountInWords = new Paragraph($"Sá»‘ tiá»n viáº¿t báº±ng chá»¯: {invoiceData.TotalAmountInWords}", fontNormal)
                    { SpacingBefore = 5f, SpacingAfter = 20f };
                    document.Add(amountInWords);

                    // Váº½ Chá»¯ kÃ½
                    PdfPTable signatureTable = new PdfPTable(2) { WidthPercentage = 100, SpacingBefore = 30f };
                    signatureTable.SetWidths(new float[] { 50f, 50f });
                    signatureTable.DefaultCell.Border = PdfPCell.NO_BORDER;
                    PdfPCell buyerSignCellPdf = new PdfPCell { Border = PdfPCell.NO_BORDER, HorizontalAlignment = Element.ALIGN_CENTER };
                    buyerSignCellPdf.AddElement(new Paragraph("NgÆ°á»i mua hÃ ng", fontNormalBold) { Alignment = Element.ALIGN_CENTER });
                    buyerSignCellPdf.AddElement(new Paragraph("(KÃ½, ghi rÃµ há» tÃªn)", fontSmall) { Alignment = Element.ALIGN_CENTER });
                    signatureTable.AddCell(buyerSignCellPdf);
                    PdfPCell sellerSignCellPdf = new PdfPCell { Border = PdfPCell.NO_BORDER, HorizontalAlignment = Element.ALIGN_CENTER };
                    sellerSignCellPdf.AddElement(new Paragraph("NgÆ°á»i bÃ¡n hÃ ng", fontNormalBold) { Alignment = Element.ALIGN_CENTER });
                    sellerSignCellPdf.AddElement(new Paragraph("(KÃ½, ghi rÃµ há» tÃªn, Ä‘Ã³ng dáº¥u)", fontSmall) { Alignment = Element.ALIGN_CENTER });
                    signatureTable.AddCell(sellerSignCellPdf);
                    document.Add(signatureTable);

                    document.Close();
                    writer.Close();

                    return File(stream.ToArray(), "application/pdf", $"HoaDon_{invoiceData.OrderId}_{DateTime.Now:yyyyMMddHHmmss}.pdf");
                }
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Lá»—i khi xuáº¥t hÃ³a Ä‘Æ¡n PDF cho Order ID {id}: {ex.ToString()}");
                return StatusCode(500, $"Lá»—i mÃ¡y chá»§ ná»™i bá»™ khi xuáº¥t hÃ³a Ä‘Æ¡n PDF: {ex.Message}");
            }
        }
        // Láº¥y Ä‘á»‹a chá»‰ theo Ä‘Æ¡n
        [HttpGet("by-phone/{phoneNumber}")]
        public async Task<IActionResult> GetOrdersByPhoneNumber(string phoneNumber)
        {
            try
            {
                // TÃ¬m cÃ¡c Ä‘á»‹a chá»‰ cÃ³ sá»‘ Ä‘iá»‡n thoáº¡i trÃ¹ng khá»›p
                var addresses = await _context.Addresses
                    .Where(a => a.PhoneNumber == phoneNumber)
                    .Select(a => a.Id) // Chá»‰ láº¥y ID
                    .ToListAsync();

                if (!addresses.Any())
                {
                    return NotFound(new { Message = "KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng nÃ o vá»›i sá»‘ Ä‘iá»‡n thoáº¡i nÃ y" });
                }

                // Láº¥y cÃ¡c Ä‘Æ¡n hÃ ng
                var orders = await _context.Orders
                    .Where(o => addresses.Contains(o.AddressId ?? 0))
                    .Include(o => o.OrderItems)
                        .ThenInclude(oi => oi.ProductVariant)
                            .ThenInclude(pv => pv.Product)
                            .ThenInclude(p => p.Images) // Láº¥y hÃ¬nh áº£nh sáº£n pháº©m
                    .Include(o => o.Address)
                    .Include(o => o.PaymentMethod)
                    .OrderByDescending(o => o.OrderDate)
                    .ToListAsync();

                var result = orders.Select(order => new
                {
                    OrderId = order.Id,
                    OrderDate = order.OrderDate.ToString("dd/MM/yyyy HH:mm"),
                    TotalAmount = order.TotalAmount,
                    FormattedTotal = order.TotalAmount.ToString("N0") + " VNÄ",
                    PaymentMethod = order.PaymentMethod != null ? order.PaymentMethod.Name : "Tiá»n máº·t",
                    OrderStatus = order.OrderStatus,
                    ShippingInfo = new
                    {
                        FullName = order.Address != null ? order.Address.FullName : "N/A",
                        Phone = order.Address != null ? order.Address.PhoneNumber : "N/A",
                        Address = order.Address != null
                            ? $"{order.Address.AddressLine1}, {order.Address.City}, {order.Address.State}"
                            : "N/A",
                        Email = order.User != null ? order.User.Email : "N/A"
                    },
                    Products = order.OrderItems.Select(oi => new
                    {
                        Id = oi.ProductVariant.Product.Id,
                        Name = oi.ProductVariant.Product.Name,
                        Image = oi.ProductVariant.Product.Images
        .OrderByDescending(i => i.IsPrimary) // Æ¯u tiÃªn áº£nh IsPrimary
        .ThenBy(i => i.Id)                  // Sáº¯p xáº¿p thá»© tá»±
        .FirstOrDefault()?                  // Láº¥y áº£nh Ä‘áº§u tiÃªn
        .ImageUrl ?? "/images/default-product.png", // Fallback náº¿u null
                        Variant = $"{oi.ProductVariant.Color} - {oi.ProductVariant.Storage}",
                        Quantity = oi.Quantity,
                        Price = oi.Price,
                        Total = oi.Price * oi.Quantity
                    }),
                    EstimatedDelivery = order.OrderDate.AddDays(3).ToString("dd/MM/yyyy")
                });

                return Ok(result);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { Message = "Lá»—i khi láº¥y thÃ´ng tin Ä‘Æ¡n hÃ ng", Error = ex.Message });
            }
        }
        [HttpGet("dashboard/sales-overview")]
        public async Task<IActionResult> GetSalesOverview([FromQuery] string range = "month")
        {
            try
            {
                DateTime startDate;
                Func<DateTime, string> groupByFormat;
                Func<string, string> formatPeriodLabel;
                string xAxisKey;

                switch (range.ToLower())
                {
                    case "week":
                        startDate = DateTime.UtcNow.Date.AddDays(-7);
                        groupByFormat = date => ((int)date.DayOfWeek).ToString();
                        formatPeriodLabel = periodNum =>
                        {
                            var daysOfWeek = new[] { "Chá»§ Nháº­t", "Thá»© Hai", "Thá»© Ba", "Thá»© TÆ°", "Thá»© NÄƒm", "Thá»© SÃ¡u", "Thá»© Báº£y" };
                            int dayIndex;
                            return int.TryParse(periodNum, out dayIndex) && dayIndex >= 0 && dayIndex < 7
                                ? daysOfWeek[dayIndex]
                                : periodNum;
                        };
                        xAxisKey = "day";
                        break;

                    case "year":
                        startDate = DateTime.UtcNow.Date.AddYears(0);
                        groupByFormat = date => date.Month.ToString();
                        formatPeriodLabel = period => $"ThÃ¡ng {period}";
                        xAxisKey = "month";
                        break;

                    default: // month
                        startDate = DateTime.UtcNow.Date.AddMonths(-1);
                        groupByFormat = date => date.Day.ToString();
                        formatPeriodLabel = period => $"NgÃ y {period}";
                        xAxisKey = "day";
                        break;
                }

                // Get data from database
                var orders = await _context.Orders
                    .Where(o => o.OrderDate >= startDate && o.OrderStatus == "Delivered")
                    .Select(o => new { o.OrderDate, o.TotalAmount })
                    .ToListAsync();

                // Group and format data
                var salesData = orders
                    .GroupBy(o => groupByFormat(o.OrderDate))
                    .Select(g => new
                    {
                        Period = g.Key,
                        FormattedPeriod = formatPeriodLabel(g.Key),
                        ShortPeriod = range switch
                        {
                            "week" => formatPeriodLabel(g.Key).Replace("Chá»§ Nháº­t", "CN").Replace("Thá»© ", ""),
                            "year" => $"T{g.Key}",
                            _ => g.Key
                        },
                        Sales = g.Sum(o => o.TotalAmount),
                        OrderCount = g.Count()
                    })
                    .OrderBy(x => int.Parse(x.Period))
                    .ToList();

                // Fill missing periods
                var allPeriods = range switch
                {
                    "week" => Enumerable.Range(0, 7).Select(i => i.ToString()),
                    "year" => Enumerable.Range(1, 12).Select(i => i.ToString()),
                    _ => Enumerable.Range(1, DateTime.DaysInMonth(DateTime.UtcNow.Year, DateTime.UtcNow.Month))
                        .Select(i => i.ToString())
                };

                salesData = allPeriods
                    .GroupJoin(salesData,
                        period => period,
                        data => data.Period,
                        (period, data) => new
                        {
                            Period = period,
                            FormattedPeriod = formatPeriodLabel(period),
                            ShortPeriod = range switch
                            {
                                "week" => formatPeriodLabel(period).Replace("Chá»§ Nháº­t", "CN").Replace("Thá»© ", ""),
                                "year" => $"T{period}",
                                _ => period
                            },
                            Sales = data.FirstOrDefault()?.Sales ?? 0,
                            OrderCount = data.FirstOrDefault()?.OrderCount ?? 0
                        })
                    .OrderBy(x => int.Parse(x.Period))
                    .ToList();

                // Create summary object based on range
                object summary;
                switch (range.ToLower())
                {
                    case "week":
                        summary = new
                        {
                            TotalSales = salesData.Sum(x => x.Sales),
                            AverageDailySales = salesData.Average(x => x.Sales)
                        };
                        break;
                    case "month":
                        summary = new
                        {
                            TotalSales = salesData.Sum(x => x.Sales),
                            AverageDailySales = salesData.Average(x => x.Sales)
                        };
                        break;
                    case "year":
                        summary = new
                        {
                            TotalSales = salesData.Sum(x => x.Sales),
                            AverageMonthlySales = salesData.Average(x => x.Sales),
                            BestMonth = salesData.OrderByDescending(x => x.Sales).FirstOrDefault()?.FormattedPeriod,
                            WorstMonth = salesData.OrderBy(x => x.Sales).FirstOrDefault()?.FormattedPeriod
                        };
                        break;
                    default:
                        summary = new { };
                        break;
                }

                return Ok(new
                {
                    Data = salesData,
                    XAxisKey = xAxisKey,
                    TimeRange = range,
                    Currency = "VND",
                    Summary = summary
                });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { Message = "Lá»—i khi láº¥y dá»¯ liá»‡u tá»•ng quan bÃ¡n hÃ ng", Error = ex.Message });
            }
        }
        // Äáº¿m tá»•ng sá»‘ Ä‘Æ¡n hÃ ng
        [HttpGet("total-count")]
        public async Task<IActionResult> GetTotalOrderCount()
        {
            try
            {
                var totalOrders = await _context.Orders.CountAsync();
                return Ok(new { TotalOrders = totalOrders });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { Message = "Lá»—i khi Ä‘áº¿m sá»‘ lÆ°á»£ng Ä‘Æ¡n hÃ ng", Error = ex.Message });
            }
        }

        // ThÃªm vÃ o OrderController
        [HttpGet("stats")]
        public async Task<IActionResult> GetOrderStats()
        {
            try
            {
                var totalOrders = await _context.Orders.CountAsync();
                var completedOrders = await _context.Orders
                    .Where(o => o.OrderStatus == "Delivered")
                    .CountAsync();
                var pendingOrders = await _context.Orders
                    .Where(o => o.OrderStatus == "Pending")
                    .CountAsync();
                var totalRevenue = await _context.Orders
                    .Where(o => o.OrderStatus == "Delivered")
                    .SumAsync(o => o.TotalAmount);

                return Ok(new
                {
                    TotalOrders = totalOrders,
                    CompletedOrders = completedOrders,
                    PendingOrders = pendingOrders,
                    TotalRevenue = totalRevenue
                });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { Message = "Lá»—i khi láº¥y thá»‘ng kÃª", Error = ex.Message });
            }
        }

        [HttpGet("user/{userId}/has-purchased/{productId}")]
        public async Task<ActionResult<bool>> HasUserPurchasedProduct(int userId, int productId)
        {
            var hasPurchased = await _context.OrderItems
                .Include(oi => oi.Order)
                .Include(oi => oi.ProductVariant)
                .AnyAsync(oi => oi.Order.UserId == userId &&
                                oi.ProductVariant.ProductId == productId &&
                                oi.Order.OrderStatus == "Delivered");

            return Ok(hasPurchased);
        }
        [HttpGet("revenue-year")]
        public async Task<IActionResult> GetRevenueDataYear([FromQuery] string range = "year")
        {
            try
            {
                DateTime startDate = DateTime.UtcNow.AddYears(-1); // LuÃ´n láº¥y 1 nÄƒm gáº§n nháº¥t
                var currentDate = DateTime.UtcNow;

                var revenueData = await _context.Orders
                    .Where(o => o.OrderDate >= startDate &&
                               o.OrderDate <= currentDate &&
                               o.OrderStatus == "Delivered")
                    .GroupBy(o => new { o.OrderDate.Month, o.OrderDate.Year })
                    .Select(g => new
                    {
                        Month = g.Key.Month,
                        Year = g.Key.Year,
                        Revenue = g.Sum(o => o.TotalAmount)
                    })
                    .OrderBy(x => x.Year)
                    .ThenBy(x => x.Month)
                    .ToListAsync();

                // Äáº£m báº£o luÃ´n cÃ³ Ä‘á»§ 12 thÃ¡ng
                var fullYearData = Enumerable.Range(0, 12)
                    .Select(i => new
                    {
                        Date = startDate.AddMonths(i),
                        Month = startDate.AddMonths(i).Month,
                        Year = startDate.AddMonths(i).Year,
                        Revenue = revenueData
                            .FirstOrDefault(d => d.Month == startDate.AddMonths(i).Month &&
                                               d.Year == startDate.AddMonths(i).Year)?.Revenue ?? 0
                    })
                    .ToList();

                return Ok(fullYearData);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { Message = "Lá»—i khi láº¥y dá»¯ liá»‡u doanh thu", Error = ex.Message });
            }
        }

        [HttpGet("revenue")]
        public async Task<IActionResult> GetRevenueData([FromQuery] string range = "month")
        {
            try
            {
                DateTime startDate = range switch
                {
                    "week" => DateTime.UtcNow.AddDays(-7),
                    "year" => DateTime.UtcNow.AddYears(-1),
                    _ => DateTime.UtcNow.AddMonths(-1)
                };

                var revenueData = await _context.Orders
                    .Where(o => o.OrderDate >= startDate && o.OrderStatus == "Delivered")
                    .GroupBy(o => new { o.OrderDate.Date })
                    .Select(g => new
                    {
                        Date = g.Key.Date,
                        Revenue = g.Sum(o => o.TotalAmount)
                    })
                    .OrderBy(x => x.Date)
                    .ToListAsync();

                return Ok(revenueData);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { Message = "Lá»—i khi láº¥y dá»¯ liá»‡u doanh thu", Error = ex.Message });
            }
        }

    }


    public static class NumberToTextVN
    {
        private static readonly string[] ChuSo = { "khÃ´ng", "má»™t", "hai", "ba", "bá»‘n", "nÄƒm", "sÃ¡u", "báº£y", "tÃ¡m", "chÃ­n" };
        private static readonly string[] DonVi = { "", "nghÃ¬n", "triá»‡u", "tá»·" }; // Má»Ÿ rá»™ng náº¿u cáº§n (nghÃ¬n tá»·, triá»‡u tá»·,...)

        private static string DocNhomBaChuSo(int baChuSo)
        {
            string tram, chuc, donViStr; // Äá»•i tÃªn 'donVi' Ä‘á»ƒ trÃ¡nh trÃ¹ng vá»›i máº£ng 'DonVi'
            string ketQua = "";

            if (baChuSo < 0 || baChuSo > 999) return ""; // Chá»‰ xá»­ lÃ½ sá»‘ cÃ³ 3 chá»¯ sá»‘

            tram = ChuSo[baChuSo / 100];
            chuc = ChuSo[(baChuSo % 100) / 10];
            donViStr = ChuSo[baChuSo % 10];

            if (baChuSo == 0) return ""; // NhÃ³m ba sá»‘ lÃ  000 thÃ¬ khÃ´ng Ä‘á»c gÃ¬

            // Äá»c hÃ ng trÄƒm
            if (baChuSo / 100 > 0)
            {
                ketQua += tram + " trÄƒm ";
                if ((baChuSo % 100) == 0) return ketQua.Trim(); // Náº¿u lÃ  xxx00 (vÃ­ dá»¥: má»™t trÄƒm)
            }

            // Äá»c hÃ ng chá»¥c vÃ  Ä‘Æ¡n vá»‹
            int phanDuTram = baChuSo % 100;
            if (phanDuTram / 10 > 0) // CÃ³ hÃ ng chá»¥c (tá»« 10-99)
            {
                if (chuc == "má»™t") ketQua += "mÆ°á»i "; // 1x -> mÆ°á»i
                else ketQua += chuc + " mÆ°Æ¡i ";    // 2x-9x -> hai mÆ°Æ¡i, ba mÆ°Æ¡i...

                if (phanDuTram % 10 == 0) return ketQua.Trim(); // Náº¿u lÃ  xx0 (vÃ­ dá»¥: hai mÆ°Æ¡i)

                if (phanDuTram % 10 == 5 && chuc != "khÃ´ng") ketQua += "lÄƒm"; // x5 (trá»« 05) -> lÄƒm
                else if (phanDuTram % 10 == 1 && chuc != "khÃ´ng" && chuc != "má»™t") ketQua += "má»‘t"; // x1 (trá»« 01, 11) -> má»‘t
                else if (phanDuTram % 10 > 0) ketQua += donViStr;
            }
            else // HÃ ng chá»¥c lÃ  0 (sá»‘ dáº¡ng x0x)
            {
                // Náº¿u cÃ³ hÃ ng trÄƒm vÃ  hÃ ng Ä‘Æ¡n vá»‹ > 0 (vÃ­ dá»¥ 101, 205) thÃ¬ thÃªm "linh"
                if (baChuSo / 100 > 0 && (phanDuTram % 10) > 0) ketQua += "linh ";

                if ((phanDuTram % 10) > 0) ketQua += donViStr; // Äá»c hÃ ng Ä‘Æ¡n vá»‹ (vÃ­ dá»¥ "má»™t" trong "má»™t trÄƒm linh má»™t", hoáº·c "má»™t" náº¿u sá»‘ lÃ  1)
            }
            return ketQua.Trim();
        }

        public static string DocSo(long soTien)
        {
            if (soTien == 0) return ChuSo[0]; // "khÃ´ng"
            if (soTien < 0) return "Ã‚m " + DocSo(Math.Abs(soTien)); // Viáº¿t hoa "Ã‚m"

            string chuoiSo = "";
            int i = 0; // Index cho máº£ng DonVi (Ä‘Æ¡n vá»‹ nghÃ¬n, triá»‡u, tá»·)

            if (soTien == 0) return ChuSo[0]; // Xá»­ lÃ½ trÆ°á»ng há»£p 0

            while (soTien > 0)
            {
                long soDu = soTien % 1000; // Láº¥y 3 sá»‘ cuá»‘i (nhÃ³m ba chá»¯ sá»‘)
                soTien /= 1000;      // Loáº¡i bá» 3 sá»‘ cuá»‘i Ä‘Ã£ xá»­ lÃ½

                if (soDu > 0) // Chá»‰ Ä‘á»c nhÃ³m nÃ y náº¿u nÃ³ khÃ¡c 000
                {
                    string strNhomBa = DocNhomBaChuSo((int)soDu);
                    // ThÃªm Ä‘Æ¡n vá»‹ (nghÃ¬n, triá»‡u, tá»·) náº¿u cÃ³ vÃ  khÃ´ng pháº£i lÃ  nhÃ³m Ä‘Æ¡n vá»‹ cuá»‘i cÃ¹ng (i > 0)
                    // Hoáº·c náº¿u lÃ  nhÃ³m Ä‘Æ¡n vá»‹ cuá»‘i cÃ¹ng nhÆ°ng strNhomBa khÃ´ng rá»—ng (tá»©c lÃ  Ä‘á»c sá»‘ tá»« 1-999)
                    chuoiSo = strNhomBa + (i > 0 ? (" " + DonVi[i]) : "") + (string.IsNullOrEmpty(chuoiSo) ? "" : " ") + chuoiSo;
                }


                i++;
                if (i >= DonVi.Length && soTien > 0) // Náº¿u vÆ°á»£t quÃ¡ Ä‘Æ¡n vá»‹ tá»· vÃ  váº«n cÃ²n sá»‘
                {
                    // Cáº§n má»Ÿ rá»™ng máº£ng DonVi hoáº·c xá»­ lÃ½ Ä‘áº·c biá»‡t cho sá»‘ quÃ¡ lá»›n
                    // Hiá»‡n táº¡i sáº½ dá»«ng á»Ÿ "tá»·"
                    Console.Error.WriteLine("Sá»‘ tiá»n quÃ¡ lá»›n, vÆ°á»£t quÃ¡ kháº£ nÄƒng Ä‘á»c cá»§a Ä‘Æ¡n vá»‹ 'tá»·'.");
                    break;
                }
            }

            chuoiSo = chuoiSo.Trim();

            // Dá»n dáº¹p khoáº£ng tráº¯ng thá»«a vÃ  cÃ¡c cá»¥m tá»« khÃ´ng mong muá»‘n
            chuoiSo = Regex.Replace(chuoiSo, @"\s+", " "); // Chuáº©n hÃ³a khoáº£ng tráº¯ng
            // CÃ¡c lá»‡nh Regex sau cÃ³ thá»ƒ khÃ´ng cáº§n thiáº¿t náº¿u DocNhomBaChuSo vÃ  logic vÃ²ng láº·p Ä‘Ã£ chuáº©n
            // VÃ­ dá»¥: "khÃ´ng trÄƒm linh" -> "linh" (náº¿u lÃ  Ä‘áº§u chuá»—i)
            if (chuoiSo.StartsWith("khÃ´ng trÄƒm linh ")) chuoiSo = chuoiSo.Substring("khÃ´ng trÄƒm linh ".Length);
            else if (chuoiSo.StartsWith("khÃ´ng trÄƒm ")) chuoiSo = chuoiSo.Substring("khÃ´ng trÄƒm ".Length);
            // "mÆ°Æ¡i khÃ´ng" -> "mÆ°Æ¡i"
            chuoiSo = chuoiSo.Replace(" mÆ°Æ¡i khÃ´ng ", " mÆ°Æ¡i ");
            if (chuoiSo.EndsWith(" mÆ°Æ¡i khÃ´ng")) chuoiSo = chuoiSo.Substring(0, chuoiSo.Length - " khÃ´ng".Length);


            // Viáº¿t hoa chá»¯ cÃ¡i Ä‘áº§u tiÃªn cá»§a chuá»—i káº¿t quáº£
            if (!string.IsNullOrEmpty(chuoiSo))
            {
                chuoiSo = char.ToUpper(chuoiSo[0]) + chuoiSo.Substring(1);
            }

            return chuoiSo;
        }
    }

    // Äáº·t cÃ¡c lá»›p ViewModel nÃ y trong namespace DTOs cá»§a báº¡n hoáº·c trong cÃ¹ng file controller náº¿u tiá»‡n
    public class OrderInvoiceViewModel
    {
        public int OrderId { get; set; }
        public DateTime OrderDate { get; set; }
        public string FormattedOrderDate => $"NgÃ y {OrderDate:dd} thÃ¡ng {OrderDate:MM} nÄƒm {OrderDate:yyyy}";

        public SellerInfo Seller { get; set; }

        public string BuyerFullName { get; set; }
        public string BuyerAddress { get; set; }
        // public string BuyerTaxCode { get; set; } // <<<< LOáº I Bá» DÃ’NG NÃ€Y
        public string PaymentMethodName { get; set; }

        public List<InvoiceItemViewModel> Items { get; set; }

        public decimal SubtotalAmount { get; set; }
        public decimal VatRate { get; set; }
        public string VatRateFormatted => $"{VatRate * 100:N0}%";
        public decimal VatAmount { get; set; }
        public decimal FinalTotalAmount { get; set; }
        public string TotalAmountInWords { get; set; }

        public string InvoiceTemplateNo => Seller.InvoiceTemplateNo;
        public string InvoiceSeries => Seller.InvoiceSeries;
        public string InvoiceNumberFormatted => OrderId.ToString("D7");
    }

    // InvoiceItemViewModel giá»¯ nguyÃªn nhÆ° láº§n cáº­p nháº­t trÆ°á»›c (Ä‘Ã£ bá» Unit)
    public class InvoiceItemViewModel
    {
        public int Index { get; set; }
        public string ProductName { get; set; }
        public int Quantity { get; set; }
        public decimal Price { get; set; }
        public decimal Amount => Quantity * Price;
    }

    public class SellerInfo
    {
        public string CompanyName { get; set; } = "CÃ”NG TY TNHH SHN GEAR";
        public string Address { get; set; } = "117 ÄÆ°á»ng Nguyá»…n ThÃ´ng, Quáº­n 3, TP.HCM";
        public string TaxCode { get; set; } = "0123456789";
        public string PhoneNumber { get; set; } = "0778 706 084";
        public string InvoiceTemplateNo { get; set; } = "01GTKT0/001";
        public string InvoiceSeries { get; set; } = "AA/22E";
    }

    public class MoMoCallbackModel
    {
        public string PartnerCode { get; set; }
        public string OrderId { get; set; }
        public string RequestId { get; set; }
        public long Amount { get; set; }
        public string OrderInfo { get; set; }
        public string OrderType { get; set; }
        public string TransId { get; set; }
        public int ResultCode { get; set; }
        public string Message { get; set; }
        public string PayType { get; set; }
        public string Signature { get; set; }
    }
}
```

### Controllers\PaymentMethodController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.Models;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace SHN_Gear.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class PaymentMethodController : ControllerBase
    {
        private readonly AppDbContext _context;

        public PaymentMethodController(AppDbContext context)
        {
            _context = context;
        }

        // GET: api/PaymentMethod
        [HttpGet]
        public async Task<ActionResult<IEnumerable<PaymentMethod>>> GetPaymentMethods()
        {
            return await _context.PaymentMethods.ToListAsync();
        }

        // GET: api/PaymentMethod/5
        [HttpGet("{id}")]
        public async Task<ActionResult<PaymentMethod>> GetPaymentMethod(int id)
        {
            var paymentMethod = await _context.PaymentMethods.FindAsync(id);

            if (paymentMethod == null)
            {
                return NotFound();
            }

            return paymentMethod;
        }

        // POST: api/PaymentMethod
        [HttpPost]
        public async Task<ActionResult<PaymentMethod>> PostPaymentMethod(PaymentMethod paymentMethod)
        {
            _context.PaymentMethods.Add(paymentMethod);
            await _context.SaveChangesAsync();

            return CreatedAtAction("GetPaymentMethod", new { id = paymentMethod.Id }, paymentMethod);
        }

        // PUT: api/PaymentMethod/5
        [HttpPut("{id}")]
        public async Task<IActionResult> PutPaymentMethod(int id, PaymentMethod paymentMethod)
        {
            if (id != paymentMethod.Id)
            {
                return BadRequest();
            }

            _context.Entry(paymentMethod).State = EntityState.Modified;

            try
            {
                await _context.SaveChangesAsync();
            }
            catch (DbUpdateConcurrencyException)
            {
                if (!PaymentMethodExists(id))
                {
                    return NotFound();
                }
                else
                {
                    throw;
                }
            }

            return NoContent();
        }

        // DELETE: api/PaymentMethod/5
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeletePaymentMethod(int id)
        {
            var paymentMethod = await _context.PaymentMethods.FindAsync(id);
            if (paymentMethod == null)
            {
                return NotFound();
            }

            _context.PaymentMethods.Remove(paymentMethod);
            await _context.SaveChangesAsync();

            return NoContent();
        }

        private bool PaymentMethodExists(int id)
        {
            return _context.PaymentMethods.Any(e => e.Id == id);
        }

        // ThÃªm endpoint Ä‘á»ƒ seed dá»¯ liá»‡u phÆ°Æ¡ng thá»©c thanh toÃ¡n máº«u
        [HttpPost("seed")]
        public async Task<IActionResult> SeedPaymentMethods()
        {
            if (await _context.PaymentMethods.AnyAsync())
            {
                return Conflict("Payment methods already exist in database");
            }

            var paymentMethods = new List<PaymentMethod>
            {
                new PaymentMethod
                {
                    Id = 1,
                    Name = "Tiá»n máº·t khi nháº­n hÃ ng",
                    Description = "Thanh toÃ¡n báº±ng tiá»n máº·t khi nháº­n hÃ ng"
                },
                new PaymentMethod
                {
                    Id = 2,
                    Name = "VÃ­ Ä‘iá»‡n tá»­ MoMo",
                    Description = "Thanh toÃ¡n qua á»©ng dá»¥ng MoMo"
                }
            };

            await _context.PaymentMethods.AddRangeAsync(paymentMethods);
            await _context.SaveChangesAsync();

            return Ok("Payment methods seeded successfully");
        }
    }
}
```

### Controllers\PayPalController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Models;
using SHN_Gear.DTOs;
using PayPalCheckoutSdk.Core;
using PayPalCheckoutSdk.Orders;
using Microsoft.Extensions.Logging;
using SHN_Gear.Data;
using SHN_Gear.Services;
using System.Globalization;

namespace SHN_Gear.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class PayPalController : ControllerBase
    {
        private readonly AppDbContext _context;
        private readonly PayPalService _payPalService;
        private readonly ILogger<PayPalController> _logger;
        private const decimal VND_TO_USD_RATE = 25000m;
        private const string CLIENT_URL = "https://localhost:44479";

        public PayPalController(
            AppDbContext context,
            PayPalService payPalService,
            ILogger<PayPalController> logger)
        {
            _context = context;
            _payPalService = payPalService;
            _logger = logger;
        }
        // táº¡o Ä‘Æ¡n hÃ ng PayPal
        [HttpPost("create-order")]
        public async Task<ActionResult<PayPalOrderResponse>> CreatePayPalOrder([FromBody] OrderDto orderDto)
        {
            if (orderDto.PaymentMethodId != 3)
            {
                return BadRequest(new { Message = "Invalid payment method. Only PayPal is accepted." });
            }

            using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                // Validate and create order in database
                var order = await CreateDatabaseOrder(orderDto);
                if (order is null)
                {
                    return BadRequest(new { Message = "Could not create order. Please check your request." });
                }

                // Convert VND to USD (minimum $0.01 USD)
                decimal amountInUSD = Math.Max(order.TotalAmount / VND_TO_USD_RATE, 0.01m);
                amountInUSD = Math.Round(amountInUSD, 2);

                // Create PayPal order
                var payPalOrderId = await _payPalService.CreateOrder(
                    amountInUSD,
                    "USD",
                    $"SHN{order.Id}",
                    $"https://localhost:7107/api/paypal/capture-order?orderId={order.Id}",
                    $"{CLIENT_URL}/payment-canceled?orderId={order.Id}"
                );

                if (string.IsNullOrEmpty(payPalOrderId))
                {
                    throw new Exception("Failed to create PayPal order");
                }

                // Update order with PayPal information
                order.PayPalOrderId = payPalOrderId;
                order.PayPalPaymentUrl = $"https://www.sandbox.paypal.com/checkoutnow?token={payPalOrderId}";
                await _context.SaveChangesAsync();

                // Remove purchased items from cart (if user is authenticated)
                if (orderDto.UserId.HasValue)
                {
                    var productVariantIds = orderDto.OrderItems.Select(oi => oi.ProductVariantId).ToList();

                    var cartItemsToRemove = await _context.CartItems
                        .Where(ci => ci.Cart.UserId == orderDto.UserId.Value &&
                                    productVariantIds.Contains(ci.ProductVariantId))
                        .ToListAsync();

                    if (cartItemsToRemove.Any())
                    {
                        _context.CartItems.RemoveRange(cartItemsToRemove);
                        await _context.SaveChangesAsync();
                    }
                }

                await transaction.CommitAsync();

                return Ok(new PayPalOrderResponse
                {
                    OrderId = order.Id,
                    PayPalOrderId = payPalOrderId,
                    ApprovalUrl = order.PayPalPaymentUrl,
                    TotalAmount = amountInUSD,
                    Currency = "USD",
                    CartItemsRemoved = orderDto.UserId.HasValue
                });
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError(ex, "Failed to create PayPal order");
                return StatusCode(500, new
                {
                    Error = "Payment processing failed",
                    Details = ex.Message
                });
            }
        }

        private async Task<Models.Order?> CreateDatabaseOrder(OrderDto orderDto)
        {
            try
            {
                // Validate user
                if (orderDto.UserId.HasValue &&
                    !await _context.Users.AnyAsync(u => u.Id == orderDto.UserId.Value))
                {
                    return null;
                }

                // Validate product variants
                foreach (var item in orderDto.OrderItems)
                {
                    var variant = await _context.ProductVariants
                        .Include(pv => pv.Product)
                        .FirstOrDefaultAsync(pv => pv.Id == item.ProductVariantId);

                    if (variant is null || variant.StockQuantity < item.Quantity)
                    {
                        return null;
                    }
                }

                // Create order
                var order = new Models.Order
                {
                    UserId = orderDto.UserId,
                    OrderDate = DateTime.UtcNow,
                    TotalAmount = orderDto.TotalAmount,
                    OrderStatus = "WaitingForPayment",
                    AddressId = orderDto.AddressId,
                    PaymentMethodId = 3, // PayPal
                    VoucherId = orderDto.VoucherId,
                    OrderItems = orderDto.OrderItems.Select(oi => new OrderItem
                    {
                        ProductVariantId = oi.ProductVariantId,
                        Quantity = oi.Quantity,
                        Price = oi.Price
                    }).ToList()
                };

                _context.Orders.Add(order);
                await _context.SaveChangesAsync();

                // Update stock
                foreach (var item in orderDto.OrderItems)
                {
                    var variant = await _context.ProductVariants.FindAsync(item.ProductVariantId);
                    if (variant is not null)
                    {
                        variant.StockQuantity -= item.Quantity;
                    }
                }
                await _context.SaveChangesAsync();

                return order;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Failed to create order in database");
                return null;
            }
        }

        [HttpGet("capture-order")]
        public async Task<IActionResult> CaptureOrder([FromQuery] string token, [FromQuery] int orderId)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                var order = await _context.Orders.FindAsync(orderId);
                if (order is null || order.PayPalOrderId != token)
                {
                    return BadRequest(new { Message = "Order not found or invalid PayPal token" });
                }

                var captureResult = await _payPalService.CaptureOrder(token);

                if (!captureResult.Success)
                {
                    order.OrderStatus = "PaymentFailed";
                    await _context.SaveChangesAsync();
                    await transaction.CommitAsync();
                    return new RedirectResult($"{CLIENT_URL}/payment-failed?orderId={order.Id}", true);
                }

                // Update order status
                order.OrderStatus = "Paid";
                order.PayPalTransactionId = captureResult.TransactionId;
                order.PayPalResponse = captureResult.RawResponse;

                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                // Redirect to payment success page
                var redirectUrl = $"{CLIENT_URL}/payment-success?orderId={order.Id}";
                return new RedirectResult(redirectUrl, true);
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError(ex, $"Failed to capture PayPal payment for order {orderId}");
                return Redirect($"{CLIENT_URL}/payment-error?message={Uri.EscapeDataString(ex.Message)}");
            }
        }
    }

    public class PayPalOrderResponse
    {
        public int OrderId { get; set; }
        public string PayPalOrderId { get; set; } = null!;
        public string ApprovalUrl { get; set; } = null!;
        public decimal TotalAmount { get; set; }
        public string Currency { get; set; } = null!;
        public bool CartItemsRemoved { get; set; }
    }
}
```

### Controllers\ProductsController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.DTOs;
using SHN_Gear.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace SHN_Gear.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class ProductsController : ControllerBase
    {
        private readonly AppDbContext _context;

        public ProductsController(AppDbContext context)
        {
            _context = context;
        }

        // Helper method to map Product to ProductDto
        private ProductDto MapProductToDto(Product product)
        {
            var now = DateTime.UtcNow;
            bool isInFlashSale = product.IsFlashSale &&
                                 product.FlashSaleStartDate.HasValue && product.FlashSaleStartDate.Value <= now &&
                                 product.FlashSaleEndDate.HasValue && product.FlashSaleEndDate.Value >= now;

            return new ProductDto
            {
                Id = product.Id,
                Name = product.Name,
                Description = product.Description,
                CategoryId = product.CategoryId,
                BrandId = product.BrandId,
                Images = product.Images.Select(img => new ProductImageDto
                {
                    ImageUrl = img.ImageUrl,
                    IsPrimary = img.IsPrimary
                }).ToList(),
                Variants = product.Variants.Select(v => new ProductVariantDto
                {
                    Color = v.Color,
                    Storage = v.Storage,
                    Price = v.Price, // Always show original price
                    DiscountPrice = isInFlashSale && product.FlashSalePrice.HasValue
                                    ? product.FlashSalePrice.Value // Flash sale price overrides discount price
                                    : v.DiscountPrice,
                    StockQuantity = v.StockQuantity
                }).ToList(),
                IsFlashSale = isInFlashSale, // Reflect actual flash sale status
                FlashSalePrice = product.FlashSalePrice,
                FlashSaleStartDate = product.FlashSaleStartDate,
                FlashSaleEndDate = product.FlashSaleEndDate
            };
        }

        // Láº¥y danh sÃ¡ch sáº£n pháº©m (cÃ³ há»— trá»£ lá»c theo danh má»¥c)
        [HttpGet]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetProducts([FromQuery] int? categoryId = null)
        {
            var query = _context.Products
                .Include(p => p.Images)
                .Include(p => p.Variants)
                .Include(p => p.Category)
                .Include(p => p.Brand)
                .AsQueryable();

            if (categoryId.HasValue)
            {
                query = query.Where(p => p.CategoryId == categoryId.Value);
            }

            var products = await query.ToListAsync();
            return Ok(products.Select(p => MapProductToDto(p)));
        }

        // Láº¥y thÃ´ng tin chi tiáº¿t sáº£n pháº©m theo ID
        [HttpGet("{id}")]
        public async Task<ActionResult<ProductDto>> GetProduct(int id)
        {
            var product = await _context.Products
                .Include(p => p.Images)
                .Include(p => p.Variants)
                .Include(p => p.Category)
                .Include(p => p.Brand)
                .FirstOrDefaultAsync(p => p.Id == id);

            if (product == null)
            {
                return NotFound();
            }

            return Ok(MapProductToDto(product));
        }

        // ThÃªm sáº£n pháº©m má»›i
        [HttpPost]
        public async Task<ActionResult<ProductDto>> PostProduct([FromBody] ProductDto productDto)
        {
            if (productDto == null)
                return BadRequest("Dá»¯ liá»‡u sáº£n pháº©m khÃ´ng há»£p lá»‡.");

            if (string.IsNullOrWhiteSpace(productDto.Name) || productDto.CategoryId <= 0 || productDto.BrandId <= 0)
                return BadRequest("TÃªn, danh má»¥c hoáº·c thÆ°Æ¡ng hiá»‡u khÃ´ng há»£p lá»‡.");

            var product = new Product
            {
                Name = productDto.Name,
                Description = productDto.Description,
                CategoryId = productDto.CategoryId,
                BrandId = productDto.BrandId,
                Images = productDto.Images?.Select(img => new ProductImage
                {
                    ImageUrl = img.ImageUrl,
                    IsPrimary = img.IsPrimary
                }).ToList() ?? new List<ProductImage>(),
                Variants = productDto.Variants?.Select(v => new ProductVariant
                {
                    Color = v.Color,
                    Storage = v.Storage,
                    Price = v.Price,
                    DiscountPrice = v.DiscountPrice,
                    StockQuantity = v.StockQuantity
                }).ToList() ?? new List<ProductVariant>(),
                IsFlashSale = productDto.IsFlashSale,
                FlashSalePrice = productDto.FlashSalePrice,
                FlashSaleStartDate = productDto.FlashSaleStartDate,
                FlashSaleEndDate = productDto.FlashSaleEndDate
            };

            _context.Products.Add(product);
            await _context.SaveChangesAsync();

            return CreatedAtAction(nameof(GetProduct), new { id = product.Id }, MapProductToDto(product));
        }

        // Cáº­p nháº­t sáº£n pháº©m
        [HttpPut("{id}")]
        public async Task<IActionResult> PutProduct(int id, [FromBody] ProductDto productDto)
        {
            if (productDto == null || id <= 0)
                return BadRequest("Dá»¯ liá»‡u sáº£n pháº©m khÃ´ng há»£p lá»‡.");

            var existingProduct = await _context.Products
                .Include(p => p.Images)
                .Include(p => p.Variants)
                .FirstOrDefaultAsync(p => p.Id == id);

            if (existingProduct == null)
                return NotFound("Sáº£n pháº©m khÃ´ng tá»“n táº¡i.");

            existingProduct.Name = productDto.Name;
            existingProduct.Description = productDto.Description;
            existingProduct.CategoryId = productDto.CategoryId;
            existingProduct.BrandId = productDto.BrandId;

            // Update images (consider more robust handling for image updates)
            existingProduct.Images.Clear();
            foreach (var imgDto in productDto.Images)
            {
                existingProduct.Images.Add(new ProductImage { ImageUrl = imgDto.ImageUrl, IsPrimary = imgDto.IsPrimary });
            }

            // Update variants (consider more robust handling for variant updates)
            existingProduct.Variants.Clear();
            foreach (var variantDto in productDto.Variants)
            {
                existingProduct.Variants.Add(new ProductVariant
                {
                    Color = variantDto.Color,
                    Storage = variantDto.Storage,
                    Price = variantDto.Price,
                    DiscountPrice = variantDto.DiscountPrice,
                    StockQuantity = variantDto.StockQuantity
                });
            }

            existingProduct.IsFlashSale = productDto.IsFlashSale;
            existingProduct.FlashSalePrice = productDto.FlashSalePrice;
            existingProduct.FlashSaleStartDate = productDto.FlashSaleStartDate;
            existingProduct.FlashSaleEndDate = productDto.FlashSaleEndDate;

            _context.Products.Update(existingProduct);
            await _context.SaveChangesAsync();

            return NoContent();
        }

        // XÃ³a sáº£n pháº©m
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteProduct(int id)
        {
            var product = await _context.Products
                .Include(p => p.Images)
                .Include(p => p.Variants)
                .FirstOrDefaultAsync(p => p.Id == id);

            if (product == null)
            {
                return NotFound();
            }

            _context.Products.Remove(product);
            await _context.SaveChangesAsync();

            return NoContent();
        }

        // Láº¥y danh sÃ¡ch sáº£n pháº©m liÃªn quan theo thÆ°Æ¡ng hiá»‡u (brand)
        [HttpGet("related-by-brand/{brandId}/{currentProductId}")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetRelatedProductsByBrand(int brandId, int currentProductId)
        {
            var relatedProducts = await _context.Products
                .Where(p => p.BrandId == brandId && p.Id != currentProductId)
                .Include(p => p.Images)
                .Include(p => p.Variants)
                .ToListAsync();

            return Ok(relatedProducts.Select(p => MapProductToDto(p)));
        }

        // API láº¥y danh sÃ¡ch biáº¿n thá»ƒ (mÃ u sáº¯c + dung lÆ°á»£ng + sá»‘ lÆ°á»£ng tá»“n) cá»§a sáº£n pháº©m
        [HttpGet("{id}/variants")]
        public async Task<ActionResult<IEnumerable<object>>> GetProductVariants(int id)
        {
            var product = await _context.Products
                .Include(p => p.Variants)
                .FirstOrDefaultAsync(p => p.Id == id);

            if (product == null)
            {
                return NotFound("Sáº£n pháº©m khÃ´ng tá»“n táº¡i.");
            }

            var variants = product.Variants
                .Select(v => new
                {
                    v.Color,
                    v.Storage,
                    v.StockQuantity,
                    v.Price,
                    v.DiscountPrice
                })
                .ToList();

            return Ok(variants);
        }

        // Láº¥y tá»•ng sá»‘ sáº£n pháº©m
        [HttpGet("count")]
        public async Task<ActionResult<int>> GetProductCount()
        {
            int totalProducts = await _context.Products.CountAsync();
            return Ok(totalProducts);
        }

        [HttpGet("search")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> SearchProducts([FromQuery] string keyword)
        {
            if (string.IsNullOrWhiteSpace(keyword))
            {
                return BadRequest("Vui lÃ²ng nháº­p tá»« khÃ³a tÃ¬m kiáº¿m.");
            }

            var products = await _context.Products
                .Include(p => p.Images)
                .Include(p => p.Category)
                .Include(p => p.Brand)
                .Include(p => p.Variants)
                .Where(p =>
                    p.Name.Contains(keyword) ||
                    p.Description.Contains(keyword) ||
                    (p.Category != null && p.Category.Name.Contains(keyword)) ||
                    (p.Brand != null && p.Brand.Name.Contains(keyword))
                )
                .ToListAsync();

            if (products.Count == 0)
            {
                return NotFound("KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m nÃ o phÃ¹ há»£p.");
            }

            return Ok(products.Select(p => MapProductToDto(p)));
        }

        [HttpGet("low-stock")]
        public async Task<ActionResult<int>> GetLowStockProducts()
        {
            int lowStockThreshold = 20;

            var lowStockProducts = await _context.Products
                .Where(p => p.Variants.Sum(v => v.StockQuantity) <= lowStockThreshold) // Sá»­a logic á»Ÿ Ä‘Ã¢y
                .CountAsync();

            return Ok(lowStockProducts);
        }

        [HttpGet("by-category")]
        public async Task<ActionResult> GetProductCountByCategory()
        {
            var categoryCounts = await _context.Products
                .GroupBy(p => p.Category.Name)
                .Select(g => new { Category = g.Key, Count = g.Count() })
                .ToListAsync();

            return Ok(categoryCounts);
        }

        // Láº¥y brand cÃ³ sá»‘ lÆ°á»£ng sáº£n pháº©m nhiá»u nháº¥t
        [HttpGet("by-brand")]
        public async Task<ActionResult> GetProductCountByBrand()
        {
            var topBrand = await _context.Products
            .GroupBy(p => p.Brand.Name)
            .Select(g => new { Brand = g.Key, Count = g.Count() })
            .OrderByDescending(g => g.Count) // Sáº¯p xáº¿p giáº£m dáº§n theo sá»‘ lÆ°á»£ng
            .FirstOrDefaultAsync(); // Láº¥y thÆ°Æ¡ng hiá»‡u cÃ³ sá»‘ lÆ°á»£ng cao nháº¥t

            return Ok(topBrand);
        }

        // GET: api/Products/lowest-price
        [HttpGet("lowest-price")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetProductsWithLowestPrice()
        {
            var now = DateTime.UtcNow;

            var products = await _context.Products
                .Include(p => p.Images)
                .Include(p => p.Variants)
                .Include(p => p.Brand)
                .Include(p => p.Category)
                .Where(p => p.Variants.Any()) // Chá»‰ láº¥y sáº£n pháº©m cÃ³ Ã­t nháº¥t 1 variant
                .Select(p => new
                {
                    Product = p,
                    // Láº¥y giÃ¡ tháº¥p nháº¥t (Æ°u tiÃªn giÃ¡ khuyáº¿n mÃ£i náº¿u cÃ³)
                    MinPrice = p.IsFlashSale && p.FlashSaleStartDate <= now && now <= p.FlashSaleEndDate
                        ? p.FlashSalePrice ?? p.Variants.Min(v => v.Price)
                        : p.Variants.Min(v => v.Price)
                })
                .OrderBy(x => x.MinPrice) // Sáº¯p xáº¿p theo giÃ¡ tháº¥p nháº¥t
                .Take(10) // Láº¥y 10 sáº£n pháº©m
                .Select(x => x.Product) // Chá»‰ láº¥y thÃ´ng tin Product
                .ToListAsync();

            return Ok(products.Select(p => MapProductToDto(p)));
        }

        // Láº¥y thÃ´ng tin sáº£n pháº©m vÃ  hÃ¬nh áº£nh dá»±a trÃªn variantId
        [HttpGet("by-variant/{variantId}")]
        public async Task<ActionResult<object>> GetProductByVariantId(int variantId)
        {
            // TÃ¬m variant theo variantId vÃ  bao gá»“m thÃ´ng tin sáº£n pháº©m vÃ  hÃ¬nh áº£nh
            var variant = await _context.ProductVariants
                .Include(v => v.Product)
                    .ThenInclude(p => p.Images)
                .Include(v => v.Product)
                    .ThenInclude(p => p.Category)
                .Include(v => v.Product)
                    .ThenInclude(p => p.Brand)
                .FirstOrDefaultAsync(v => v.Id == variantId);

            if (variant == null)
            {
                return NotFound("KhÃ´ng tÃ¬m tháº¥y biáº¿n thá»ƒ sáº£n pháº©m.");
            }

            // Táº¡o Ä‘á»‘i tÆ°á»£ng tráº£ vá» vá»›i thÃ´ng tin sáº£n pháº©m vÃ  hÃ¬nh áº£nh
            var result = new
            {
                Product = new
                {
                    variant.Product.Id,
                    variant.Product.Name,
                    variant.Product.Description,
                    Category = variant.Product.Category?.Name,
                    Brand = variant.Product.Brand?.Name,
                    variant.Product.IsFlashSale,
                    variant.Product.FlashSalePrice,
                    variant.Product.FlashSaleStartDate,
                    variant.Product.FlashSaleEndDate
                },
                Variant = new
                {
                    variant.Id,
                    variant.Color,
                    variant.Storage,
                    variant.Price,
                    variant.DiscountPrice,
                    variant.StockQuantity
                },
                Images = variant.Product.Images.Select(img => new
                {
                    img.Id,
                    img.ImageUrl,
                    img.IsPrimary
                }).ToList()
            };

            return Ok(result);
        }

        [HttpPost("compare")]
        public async Task<IActionResult> CompareProducts([FromBody] List<int> productIds)
        {
            if (productIds == null || productIds.Count < 1)
            {
                return BadRequest("Vui lÃ²ng thÃªm sáº£n pháº©m Ä‘á»ƒ so sÃ¡nh.");
            }

            var products = await _context.Products
                .Where(p => productIds.Contains(p.Id))
                .Include(p => p.Images)
                .Include(p => p.Brand)
                .Include(p => p.Category)
                .Include(p => p.Variants)
                .ToListAsync();

            if (products.Count < 1)
            {
                return NotFound("KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m Ä‘á»ƒ so sÃ¡nh.");
            }

            var result = new List<object>();

            foreach (var product in products)
            {
                object specifications = null;

                // Fetch specifications based on category
                var categoryName = product.Category?.Name?.ToLower();

                // Debug logging
                System.Console.WriteLine($"Product: {product.Name}, Category: {categoryName}");

                // Get unified product specifications
                var productSpecs = await _context.ProductSpecifications
                    .Where(s => s.ProductId == product.Id)
                    .OrderBy(s => s.DisplayOrder)
                    .ThenBy(s => s.Name)
                    .ToListAsync();

                if (productSpecs.Any())
                {
                    // Convert to a dynamic object with Name-Value pairs
                    var specDict = productSpecs.ToDictionary(s => s.Name, s => new ProductSpecificationDetailDto { Value = s.Value, Unit = s.Unit });

                    specifications = new
                    {
                        Type = "unified",
                        Specifications = specDict,
                        Count = productSpecs.Count
                    };
                }

                result.Add(new
                {
                    product.Id,
                    product.Name,
                    product.Description,
                    Brand = product.Brand?.Name,
                    Category = product.Category?.Name,
                    Images = product.Images.Select(img => new
                    {
                        img.Id,
                        img.ImageUrl,
                        img.IsPrimary
                    }).ToList(),
                    Variants = product.Variants.Select(v => new
                    {
                        v.Color,
                        v.Storage,
                        v.Price,
                        v.DiscountPrice,
                        v.StockQuantity
                    }).ToList(),
                    Specifications = specifications,
                    product.IsFlashSale,
                    product.FlashSalePrice,
                    product.FlashSaleStartDate,
                    product.FlashSaleEndDate
                });
            }

            return Ok(result);
        }

        // New: Get products by a list of IDs
        [HttpGet("by-ids")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetProductsByIds([FromQuery] string ids)
        {
            if (string.IsNullOrWhiteSpace(ids))
            {
                return BadRequest("Product IDs are required.");
            }

            var productIds = ids.Split(',').Select(int.Parse).ToList();

            var products = await _context.Products
                .Where(p => productIds.Contains(p.Id))
                .Include(p => p.Images)
                .Include(p => p.Variants)
                .Include(p => p.Category)
                .Include(p => p.Brand)
                .ToListAsync();

            if (!products.Any())
            {
                return NotFound("No products found for the given IDs.");
            }

            return Ok(products.Select(p => MapProductToDto(p)));
        }

        // New: Get products currently on Flash Sale
        [HttpGet("flash-sale")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> GetFlashSaleProducts()
        {
            var now = DateTime.UtcNow;
            var flashSaleProducts = await _context.Products
                .Include(p => p.Images)
                .Include(p => p.Variants)
                .Where(p => p.IsFlashSale && p.FlashSaleStartDate <= now && now <= p.FlashSaleEndDate)
                .ToListAsync();

            return Ok(flashSaleProducts.Select(p => MapProductToDto(p)));
        }

        // New: Set a product to Flash Sale
        [HttpPut("{id}/set-flash-sale")]
        public async Task<IActionResult> SetFlashSale(int id, [FromBody] FlashSaleUpdateDto flashSaleDto)
        {
            var product = await _context.Products.FindAsync(id);
            if (product == null)
            {
                return NotFound();
            }

            product.IsFlashSale = true;
            product.FlashSalePrice = flashSaleDto.FlashSalePrice;
            product.FlashSaleStartDate = flashSaleDto.FlashSaleStartDate;
            product.FlashSaleEndDate = flashSaleDto.FlashSaleEndDate;

            await _context.SaveChangesAsync();
            return NoContent();
        }

        // New: Clear Flash Sale from a product
        [HttpPut("{id}/clear-flash-sale")]
        public async Task<IActionResult> ClearFlashSale(int id)
        {
            var product = await _context.Products.FindAsync(id);
            if (product == null)
            {
                return NotFound();
            }

            product.IsFlashSale = false;
            product.FlashSalePrice = null;
            product.FlashSaleStartDate = null;
            product.FlashSaleEndDate = null;

            await _context.SaveChangesAsync();
            return NoContent();
        }
    }
}
```

### Controllers\ReviewsController.cs
```cs
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.DTOs;
using SHN_Gear.Models;
using System.Security.Claims;

[Route("api/[controller]")]
[ApiController]
public class ReviewController : ControllerBase
{
    private readonly AppDbContext _context;
    public ReviewController(AppDbContext context) => _context = context;

    [HttpGet("product/{productId}")]
    public async Task<ActionResult<IEnumerable<ReviewDto>>> GetReviewsByProduct(int productId)
    {
        var reviews = await _context.Reviews
            .Where(r => r.ProductId == productId && r.IsApproved)
            .Include(r => r.User)
            .Include(r => r.Product)
            .OrderByDescending(r => r.CreatedAt)
            .Select(r => new ReviewDto
            {
                Id = r.Id,
                ProductId = r.ProductId,
                ProductName = r.Product.Name,
                UserId = r.UserId,
                UserName = r.User.FullName,
                Rating = r.Rating,
                Comment = r.Comment,
                CreatedAt = r.CreatedAt,
                IsApproved = r.IsApproved,
                HasPurchased = _context.OrderItems
                                .Include(oi => oi.Order)
                                .Include(oi => oi.ProductVariant)
                                .Any(oi => oi.Order.UserId == r.UserId && oi.ProductVariant.ProductId == r.ProductId && oi.Order.OrderStatus == "Delivered")
            })
            .ToListAsync();

        return Ok(reviews);
    }

    [HttpGet("product/{productId}/average-rating")]
    public async Task<ActionResult<double>> GetAverageRating(int productId)
    {
        var avg = await _context.Reviews
            .Where(r => r.ProductId == productId && r.IsApproved)
            .AverageAsync(r => (double?)r.Rating) ?? 0;

        return Ok(avg);
    }

    [Authorize]
    [HttpPost]
    public async Task<ActionResult> CreateReview([FromBody] CreateReviewDto dto)
    {
        var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)!.Value);

        if (!await _context.Products.AnyAsync(p => p.Id == dto.ProductId))
            return NotFound("Sáº£n pháº©m khÃ´ng tá»“n táº¡i");

        bool purchased = await _context.OrderItems
            .Include(oi => oi.Order)
            .Include(oi => oi.ProductVariant)
            .AnyAsync(oi => oi.Order.UserId == userId && oi.ProductVariant.ProductId == dto.ProductId && oi.Order.OrderStatus == "Delivered");

        if (!purchased)
            return BadRequest("Báº¡n cáº§n mua vÃ  nháº­n hÃ ng Ä‘á»ƒ Ä‘Ã¡nh giÃ¡");

        bool reviewed = await _context.Reviews.AnyAsync(r => r.UserId == userId && r.ProductId == dto.ProductId);

        if (reviewed)
            return BadRequest("Báº¡n Ä‘Ã£ Ä‘Ã¡nh giÃ¡ sáº£n pháº©m nÃ y rá»“i");

        var review = new Review
        {
            ProductId = dto.ProductId,
            UserId = userId,
            Rating = dto.Rating,
            Comment = dto.Comment,
            CreatedAt = DateTime.UtcNow,
            IsApproved = false // Máº·c Ä‘á»‹nh lÃ  false, cáº§n admin duyá»‡t
        };

        _context.Reviews.Add(review);
        await _context.SaveChangesAsync();

        return Ok("ÄÃ¡nh giÃ¡ thÃ nh cÃ´ng, Ä‘ang chá» duyá»‡t");
    }

    [Authorize]
    [HttpPut("{id}")]
    public async Task<IActionResult> UpdateReview(int id, [FromBody] UpdateReviewDto dto)
    {
        var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)!.Value);
        var review = await _context.Reviews.FindAsync(id);

        if (review == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y Ä‘Ã¡nh giÃ¡");
        if (review.UserId != userId) return Forbid("KhÃ´ng cÃ³ quyá»n");

        review.Rating = dto.Rating;
        review.Comment = dto.Comment;
        await _context.SaveChangesAsync();

        return NoContent();
    }

    [Authorize]
    [HttpDelete("{id}")]
    public async Task<IActionResult> DeleteReview(int id)
    {
        var userId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)!.Value);
        var review = await _context.Reviews.FindAsync(id);

        if (review == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y Ä‘Ã¡nh giÃ¡");
        if (review.UserId != userId) return Forbid("KhÃ´ng cÃ³ quyá»n");

        _context.Reviews.Remove(review);
        await _context.SaveChangesAsync();

        return NoContent();
    }

    [Authorize(Roles = "Admin")]
    [HttpPut("{id}/approve")]
    public async Task<IActionResult> ApproveReview(int id)
    {
        var review = await _context.Reviews.FindAsync(id);
        if (review == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y Ä‘Ã¡nh giÃ¡");

        review.IsApproved = true;
        await _context.SaveChangesAsync();
        return Ok("ÄÃ¡nh giÃ¡ Ä‘Ã£ Ä‘Æ°á»£c duyá»‡t.");
    }

    [Authorize(Roles = "Admin")]
    [HttpPut("{id}/reject")]
    public async Task<IActionResult> RejectReview(int id)
    {
        var review = await _context.Reviews.FindAsync(id);
        if (review == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y Ä‘Ã¡nh giÃ¡");

        review.IsApproved = false;
        await _context.SaveChangesAsync();
        return Ok("ÄÃ¡nh giÃ¡ Ä‘Ã£ bá»‹ tá»« chá»‘i.");
    }

    [Authorize]
    [HttpGet("user/{userId}/product/{productId}")]
    public async Task<ActionResult<ReviewDto>> GetUserReviewForProduct(int userId, int productId)
    {
        var review = await _context.Reviews
            .Where(r => r.UserId == userId && r.ProductId == productId)
            .Include(r => r.User)
            .Include(r => r.Product)
            .Select(r => new ReviewDto
            {
                Id = r.Id,
                ProductId = r.ProductId,
                ProductName = r.Product.Name,
                UserId = r.UserId,
                UserName = r.User.FullName,
                Rating = r.Rating,
                Comment = r.Comment,
                CreatedAt = r.CreatedAt,
                IsApproved = r.IsApproved,
                HasPurchased = _context.OrderItems
                                .Include(oi => oi.Order)
                                .Include(oi => oi.ProductVariant)
                                .Any(oi => oi.Order.UserId == r.UserId && oi.ProductVariant.ProductId == r.ProductId && oi.Order.OrderStatus == "Delivered")
            })
            .FirstOrDefaultAsync();

        if (review == null) return NotFound("KhÃ´ng tÃ¬m tháº¥y Ä‘Ã¡nh giÃ¡ cá»§a ngÆ°á»i dÃ¹ng cho sáº£n pháº©m nÃ y.");

        return Ok(review);
    }

    [Authorize(Roles = "Admin")]
    [HttpGet("analytics")]
    public async Task<ActionResult> GetReviewAnalytics()
    {
        var totalReviews = await _context.Reviews.CountAsync();
        var approvedReviews = await _context.Reviews.CountAsync(r => r.IsApproved);
        var pendingReviews = await _context.Reviews.CountAsync(r => !r.IsApproved);
        var averageRating = await _context.Reviews.AverageAsync(r => (double?)r.Rating) ?? 0;

        var ratingDistribution = await _context.Reviews
            .GroupBy(r => r.Rating)
            .Select(g => new { Rating = g.Key, Count = g.Count() })
            .OrderBy(x => x.Rating)
            .ToListAsync();

        return Ok(new
        {
            TotalReviews = totalReviews,
            ApprovedReviews = approvedReviews,
            PendingReviews = pendingReviews,
            AverageRating = averageRating,
            RatingDistribution = ratingDistribution
        });
    }

    [Authorize(Roles = "Admin")]
    [HttpGet("all")]
    public async Task<ActionResult<IEnumerable<ReviewDto>>> GetAllReviews(
        [FromQuery] bool? isApproved = null,
        [FromQuery] int? minRating = null,
        [FromQuery] int? maxRating = null,
        [FromQuery] int? productId = null,
        [FromQuery] int? userId = null,
        [FromQuery] string? searchComment = null)
    {
        var query = _context.Reviews.AsQueryable();

        if (isApproved.HasValue)
        {
            query = query.Where(r => r.IsApproved == isApproved.Value);
        }

        if (minRating.HasValue)
        {
            query = query.Where(r => r.Rating >= minRating.Value);
        }

        if (maxRating.HasValue)
        {
            query = query.Where(r => r.Rating <= maxRating.Value);
        }

        if (productId.HasValue)
        {
            query = query.Where(r => r.ProductId == productId.Value);
        }

        if (userId.HasValue)
        {
            query = query.Where(r => r.UserId == userId.Value);
        }

        if (!string.IsNullOrEmpty(searchComment))
        {
            query = query.Where(r => r.Comment.Contains(searchComment));
        }

        var reviews = await query
            .Include(r => r.User)
            .Include(r => r.Product)
            .OrderByDescending(r => r.CreatedAt)
            .Select(r => new ReviewDto
            {
                Id = r.Id,
                ProductId = r.ProductId,
                ProductName = r.Product.Name,
                UserId = r.UserId,
                UserName = r.User.FullName,
                Rating = r.Rating,
                Comment = r.Comment,
                CreatedAt = r.CreatedAt,
                IsApproved = r.IsApproved,
                HasPurchased = _context.OrderItems
                                .Include(oi => oi.Order)
                                .Include(oi => oi.ProductVariant)
                                .Any(oi => oi.Order.UserId == r.UserId && oi.ProductVariant.ProductId == r.ProductId && oi.Order.OrderStatus == "Delivered")
            })
            .ToListAsync();

        return Ok(reviews);
    }
}
```

### Controllers\RoleController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.Models;
using System.Threading.Tasks;

namespace SHN_Gear.Controllers
{
    [ApiController]
    [Route("api/roles")]
    public class RoleController : ControllerBase
    {
        private readonly AppDbContext _context;

        public RoleController(AppDbContext context)
        {
            _context = context;
        }

        // Láº¥y danh sÃ¡ch vai trÃ²
        [HttpGet]
        public async Task<IActionResult> GetRoles()
        {
            var roles = await _context.Roles.ToListAsync();
            return Ok(roles);
        }

        // ThÃªm vai trÃ² má»›i
        [HttpPost]
        public async Task<IActionResult> AddRole([FromBody] Role role)
        {
            if (string.IsNullOrWhiteSpace(role.Name))
            {
                return BadRequest("TÃªn vai trÃ² khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.");
            }

            _context.Roles.Add(role);
            await _context.SaveChangesAsync();
            return Ok(role);
        }

        // Chá»‰nh sá»­a vai trÃ²
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateRole(int id, [FromBody] Role updatedRole)
        {
            if (string.IsNullOrWhiteSpace(updatedRole.Name))
            {
                return BadRequest("TÃªn vai trÃ² khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.");
            }

            var existingRole = await _context.Roles.FirstOrDefaultAsync(r => r.Id == id);
            if (existingRole == null)
            {
                return NotFound("Vai trÃ² khÃ´ng tá»“n táº¡i.");
            }

            existingRole.Name = updatedRole.Name;
            await _context.SaveChangesAsync();

            return Ok(existingRole);
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteRole(int id)
        {
            // TÃ¬m vai trÃ² theo Id
            var role = await _context.Roles.Include(r => r.Users).FirstOrDefaultAsync(r => r.Id == id);
            if (role == null)
            {
                return NotFound("Vai trÃ² khÃ´ng tá»“n táº¡i.");
            }

            // Kiá»ƒm tra náº¿u vai trÃ² Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi báº¥t ká»³ ngÆ°á»i dÃ¹ng nÃ o
            if (role.Users.Any())
            {
                return BadRequest("KhÃ´ng thá»ƒ xÃ³a vai trÃ² vÃ¬ Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi ngÆ°á»i dÃ¹ng.");
            }

            // XÃ³a vai trÃ²
            _context.Roles.Remove(role);
            await _context.SaveChangesAsync();

            return Ok(new { Message = "Vai trÃ² Ä‘Ã£ Ä‘Æ°á»£c xÃ³a thÃ nh cÃ´ng." });
        }
    }
}
```

### Controllers\SearchController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.Models.DTOs;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace SHN_Gear.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class SearchController : ControllerBase
    {
        private readonly AppDbContext _context;
        private readonly ILogger<SearchController> _logger;

        public SearchController(AppDbContext context, ILogger<SearchController> logger)
        {
            _context = context;
            _logger = logger;
        }

        /// <summary>
        /// TÃ¬m kiáº¿m tá»•ng há»£p sáº£n pháº©m, danh má»¥c vÃ  thÆ°Æ¡ng hiá»‡u
        /// </summary>
        /// <param name="query">Tá»« khÃ³a tÃ¬m kiáº¿m</param>
        /// <param name="limit">Sá»‘ lÆ°á»£ng káº¿t quáº£ tá»‘i Ä‘a cho má»—i loáº¡i (máº·c Ä‘á»‹nh: 3)</param>
        /// <returns>Káº¿t quáº£ tÃ¬m kiáº¿m gá»“m sáº£n pháº©m, danh má»¥c vÃ  thÆ°Æ¡ng hiá»‡u</returns>
        [HttpGet]
        public async Task<ActionResult<SearchResultDto>> Search(
            [FromQuery] string query,
            [FromQuery] int limit = 3)
        {
            try
            {
                _logger.LogInformation("Search endpoint called with query: {Query}, limit: {Limit}", query, limit);

                if (string.IsNullOrWhiteSpace(query))
                {
                    _logger.LogInformation("Empty query provided, returning empty result");
                    return Ok(new SearchResultDto()); // Tráº£ vá» káº¿t quáº£ rá»—ng náº¿u query trá»‘ng
                }

                var normalizedQuery = query.Trim().ToLower();
                var result = new SearchResultDto();

                _logger.LogInformation("Searching for products with normalized query: {NormalizedQuery}", normalizedQuery);

                // TÃ¬m kiáº¿m sáº£n pháº©m
                try
                {
                    result.Products = await SearchProducts(normalizedQuery, limit);
                    _logger.LogInformation("Found {Count} products", result.Products.Count);
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Error searching products");
                    result.Products = new List<SearchProductDto>();
                }

                // TÃ¬m kiáº¿m danh má»¥c
                try
                {
                    result.Categories = await SearchCategories(normalizedQuery, limit);
                    _logger.LogInformation("Found {Count} categories", result.Categories.Count);
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Error searching categories");
                    result.Categories = new List<SearchCategoryDto>();
                }

                // TÃ¬m kiáº¿m thÆ°Æ¡ng hiá»‡u
                try
                {
                    result.Brands = await SearchBrands(normalizedQuery, limit);
                    _logger.LogInformation("Found {Count} brands", result.Brands.Count);
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Error searching brands");
                    result.Brands = new List<SearchBrandDto>();
                }

                result.TotalResults = result.Products.Count + result.Categories.Count + result.Brands.Count;

                _logger.LogInformation("Search completed with {TotalResults} total results", result.TotalResults);
                return Ok(result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Lá»—i khi thá»±c hiá»‡n tÃ¬m kiáº¿m");
                return StatusCode(500, new { Message = "ÄÃ£ xáº£y ra lá»—i khi tÃ¬m kiáº¿m", Error = ex.Message });
            }
        }

        private async Task<List<SearchProductDto>> SearchProducts(string query, int limit)
        {
            try
            {
                _logger.LogInformation("Starting product search with query: {Query}, limit: {Limit}", query, limit);
                
                var products = await _context.Products
                    .Include(p => p.Images)
                    .Include(p => p.Variants)
                    .Where(p => p.Name.ToLower().Contains(query) ||
                               (p.Description != null && p.Description.ToLower().Contains(query)))
                    .OrderBy(p => p.Name)
                    .Take(limit)
                    .Select(p => new SearchProductDto
                    {
                        Id = p.Id,
                        Name = p.Name,
                        ImageUrl = p.Images.Any(i => i.IsPrimary) 
                                 ? p.Images.FirstOrDefault(i => i.IsPrimary).ImageUrl
                                 : p.Images.Any() 
                                   ? p.Images.FirstOrDefault().ImageUrl
                                   : "/images/default-product.png",
                        Price = p.Variants.Any() ? p.Variants.Min(v => v.Price) : 0
                    })
                    .ToListAsync();

                _logger.LogInformation("Product search completed, found {Count} products", products.Count);
                return products;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error in SearchProducts method");
                throw;
            }
        }

        private async Task<List<SearchCategoryDto>> SearchCategories(string query, int limit)
        {
            try
            {
                _logger.LogInformation("Starting category search with query: {Query}, limit: {Limit}", query, limit);
                
                var categories = await _context.Categories
                    .Where(c => c.Name.ToLower().Contains(query))
                    .OrderBy(c => c.Name)
                    .Take(limit)
                    .Select(c => new SearchCategoryDto
                    {
                        Id = c.Id,
                        Name = c.Name
                    })
                    .ToListAsync();

                _logger.LogInformation("Category search completed, found {Count} categories", categories.Count);
                return categories;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error in SearchCategories method");
                throw;
            }
        }

        private async Task<List<SearchBrandDto>> SearchBrands(string query, int limit)
        {
            try
            {
                _logger.LogInformation("Starting brand search with query: {Query}, limit: {Limit}", query, limit);
                
                var brands = await _context.Brands
                    .Where(b => b.Name.ToLower().Contains(query))
                    .OrderBy(b => b.Name)
                    .Take(limit)
                    .Select(b => new SearchBrandDto
                    {
                        Id = b.Id,
                        Name = b.Name,
                        LogoUrl = b.Logo ?? "/images/default-brand.png"
                    })
                    .ToListAsync();

                _logger.LogInformation("Brand search completed, found {Count} brands", brands.Count);
                return brands;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error in SearchBrands method");
                throw;
            }
        }

        /// <summary>
        /// API tÃ¬m kiáº¿m nÃ¢ng cao vá»›i phÃ¢n trang
        /// </summary>
        [HttpGet("advanced")]
        public async Task<ActionResult<SearchResultDto>> AdvancedSearch(
            [FromQuery] string query,
            [FromQuery] int page = 1,
            [FromQuery] int pageSize = 10)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(query))
                {
                    return Ok(new SearchResultDto());
                }

                var normalizedQuery = query.Trim().ToLower();
                var result = new SearchResultDto
                {
                    Page = page,
                    PageSize = pageSize
                };

                // TÃ¬m kiáº¿m sáº£n pháº©m vá»›i phÃ¢n trang
                var productQuery = _context.Products
                    .Include(p => p.Images)
                    .Include(p => p.Variants)
                    .Where(p => p.Name.ToLower().Contains(normalizedQuery) ||
                               (p.Description != null && p.Description.ToLower().Contains(normalizedQuery)));

                result.Products = await productQuery
                    .OrderBy(p => p.Name)
                    .Skip((page - 1) * pageSize)
                    .Take(pageSize)
                    .Select(p => new SearchProductDto
                    {
                        Id = p.Id,
                        Name = p.Name,
                        ImageUrl = p.Images.Any() 
                                 ? p.Images.FirstOrDefault().ImageUrl 
                                 : "/images/default-product.png",
                        Price = p.Variants.Any() ? p.Variants.Min(v => v.Price) : 0
                    })
                    .ToListAsync();

                // Äáº¿m tá»•ng sá»‘ sáº£n pháº©m
                var totalProducts = await productQuery.CountAsync();
                result.TotalResults = totalProducts;

                return Ok(result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Lá»—i khi thá»±c hiá»‡n tÃ¬m kiáº¿m nÃ¢ng cao");
                return StatusCode(500, new { Message = "ÄÃ£ xáº£y ra lá»—i khi tÃ¬m kiáº¿m" });
            }
        }

        /// <summary>
        /// Health check endpoint to test database connectivity
        /// </summary>
        [HttpGet("health")]
        public async Task<ActionResult> HealthCheck()
        {
            try
            {
                var productCount = await _context.Products.CountAsync();
                var categoryCount = await _context.Categories.CountAsync();
                var brandCount = await _context.Brands.CountAsync();

                return Ok(new
                {
                    Status = "Healthy",
                    ProductCount = productCount,
                    CategoryCount = categoryCount,
                    BrandCount = brandCount,
                    Timestamp = DateTime.UtcNow
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Health check failed");
                return StatusCode(500, new
                {
                    Status = "Unhealthy",
                    Error = ex.Message,
                    Timestamp = DateTime.UtcNow
                });
            }
        }
    }
}
```

### Controllers\SpecificationsController.cs
```cs

using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.Models;
using SHN_Gear.DTOs;

namespace SHN_Gear.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class SpecificationsController : ControllerBase
    {
        private readonly AppDbContext _context;

        public SpecificationsController(AppDbContext context)
        {
            _context = context;
        }

        // GET: api/Specifications
        [HttpGet]
        public async Task<ActionResult<IEnumerable<ProductSpecificationDto>>> GetAllSpecifications()
        {
            var specifications = await _context.ProductSpecifications
                .OrderBy(s => s.ProductId)
                .ThenBy(s => s.DisplayOrder)
                .ThenBy(s => s.Name)
                .Select(s => new ProductSpecificationDto
                {
                    Id = s.Id,
                    ProductId = s.ProductId,
                    Name = s.Name,
                    Value = s.Value,
                    Unit = s.Unit,
                    DisplayOrder = s.DisplayOrder,
                    CreatedAt = s.CreatedAt
                })
                .ToListAsync();

            return Ok(specifications);
        }
        // GET: api/Specifications/by-product/{productId}
        [HttpGet("by-product/{productId}")]
        public async Task<ActionResult<IEnumerable<ProductSpecificationDto>>> GetSpecificationsByProductId(int productId)
        {
            var product = await _context.Products.FindAsync(productId);
            if (product == null)
            {
                return NotFound("Sáº£n pháº©m khÃ´ng tá»“n táº¡i.");
            }

            var specifications = await _context.ProductSpecifications
                .Where(s => s.ProductId == productId)
                .OrderBy(s => s.DisplayOrder)
                .ThenBy(s => s.Name)
                .Select(s => new ProductSpecificationDto
                {
                    Id = s.Id,
                    ProductId = s.ProductId,
                    Name = s.Name,
                    Value = s.Value,
                    Unit = s.Unit,
                    DisplayOrder = s.DisplayOrder,
                    CreatedAt = s.CreatedAt
                })
                .ToListAsync();

            return Ok(specifications);
        }
        // GET: api/Specifications/{id}
        [HttpGet("{id}")]
        public async Task<ActionResult<ProductSpecificationDto>> GetSpecification(int id)
        {
            var specification = await _context.ProductSpecifications
                .Where(s => s.Id == id)
                .Select(s => new ProductSpecificationDto
                {
                    Id = s.Id,
                    ProductId = s.ProductId,
                    Name = s.Name,
                    Value = s.Value,
                    Unit = s.Unit,
                    DisplayOrder = s.DisplayOrder,
                    CreatedAt = s.CreatedAt
                })
                .FirstOrDefaultAsync();

            if (specification == null)
            {
                return NotFound("ThÃ´ng sá»‘ ká»¹ thuáº­t khÃ´ng tá»“n táº¡i.");
            }

            return Ok(specification);
        }

        // GET: api/Specifications/product/{productId}
        [HttpGet("product/{productId}")]
        public async Task<ActionResult<IEnumerable<ProductSpecificationDto>>> GetSpecificationsByProduct(int productId)
        {
            var product = await _context.Products.FindAsync(productId);
            if (product == null)
            {
                return NotFound("Sáº£n pháº©m khÃ´ng tá»“n táº¡i.");
            }

            var specifications = await _context.ProductSpecifications
                .Where(s => s.ProductId == productId)
                .OrderBy(s => s.DisplayOrder)
                .ThenBy(s => s.Name)
                .Select(s => new ProductSpecificationDto
                {
                    Id = s.Id,
                    ProductId = s.ProductId,
                    Name = s.Name,
                    Value = s.Value,
                    Unit = s.Unit,
                    DisplayOrder = s.DisplayOrder,
                    CreatedAt = s.CreatedAt
                })
                .ToListAsync();

            return Ok(specifications);
        }

        // POST: api/Specifications
        [HttpPost]
        public async Task<ActionResult<ProductSpecificationDto>> CreateSpecification([FromBody] CreateProductSpecificationDto createDto)
        {
            var product = await _context.Products.FindAsync(createDto.ProductId);
            if (product == null)
            {
                return NotFound("Sáº£n pháº©m khÃ´ng tá»“n táº¡i.");
            }

            var specification = new ProductSpecification
            {
                ProductId = createDto.ProductId,
                Name = createDto.Name,
                Value = createDto.Value,
                Unit = createDto.Unit,
                DisplayOrder = createDto.DisplayOrder,
                CreatedAt = DateTime.UtcNow
            };

            _context.ProductSpecifications.Add(specification);
            await _context.SaveChangesAsync();

            var result = new ProductSpecificationDto
            {
                Id = specification.Id,
                ProductId = specification.ProductId,
                Name = specification.Name,
                Value = specification.Value,
                Unit = specification.Unit,
                DisplayOrder = specification.DisplayOrder,
                CreatedAt = specification.CreatedAt
            };

            return CreatedAtAction(nameof(GetSpecification), new { id = specification.Id }, result);
        }

        // PUT: api/Specifications/{id}
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateSpecification(int id, [FromBody] UpdateProductSpecificationDto updateDto)
        {
            var specification = await _context.ProductSpecifications.FindAsync(id);
            if (specification == null)
            {
                return NotFound("ThÃ´ng sá»‘ ká»¹ thuáº­t khÃ´ng tá»“n táº¡i.");
            }

            specification.Name = updateDto.Name;
            specification.Value = updateDto.Value;
            specification.Unit = updateDto.Unit;
            specification.DisplayOrder = updateDto.DisplayOrder;

            try
            {
                await _context.SaveChangesAsync();
            }
            catch (DbUpdateConcurrencyException)
            {
                if (!SpecificationExists(id))
                {
                    return NotFound();
                }
                else
                {
                    throw;
                }
            }

            return NoContent();
        }

        // DELETE: api/Specifications/{id}
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteSpecification(int id)
        {
            var specification = await _context.ProductSpecifications.FindAsync(id);
            if (specification == null)
            {
                return NotFound("ThÃ´ng sá»‘ ká»¹ thuáº­t khÃ´ng tá»“n táº¡i.");
            }

            _context.ProductSpecifications.Remove(specification);
            await _context.SaveChangesAsync();

            return NoContent();
        }

        // POST: api/Specifications/bulk
        [HttpPost("bulk")]
        public async Task<ActionResult> CreateBulkSpecifications([FromBody] IEnumerable<CreateProductSpecificationDto> specifications)
        {
            var productIds = specifications.Select(s => s.ProductId).Distinct().ToList();
            var existingProducts = await _context.Products
                .Where(p => productIds.Contains(p.Id))
                .Select(p => p.Id)
                .ToListAsync();

            var invalidProductIds = productIds.Except(existingProducts).ToList();
            if (invalidProductIds.Any())
            {
                return BadRequest($"CÃ¡c sáº£n pháº©m khÃ´ng tá»“n táº¡i: {string.Join(", ", invalidProductIds)}");
            }

            var specificationEntities = specifications.Select(s => new ProductSpecification
            {
                ProductId = s.ProductId,
                Name = s.Name,
                Value = s.Value,
                Unit = s.Unit,
                DisplayOrder = s.DisplayOrder,
                CreatedAt = DateTime.UtcNow
            }).ToList();

            _context.ProductSpecifications.AddRange(specificationEntities);
            await _context.SaveChangesAsync();

            return Ok($"ÄÃ£ táº¡o {specificationEntities.Count} thÃ´ng sá»‘ ká»¹ thuáº­t.");
        }

        // DELETE: api/Specifications/product/{productId}
        [HttpDelete("product/{productId}")]
        public async Task<IActionResult> DeleteSpecificationsByProduct(int productId)
        {
            var product = await _context.Products.FindAsync(productId);
            if (product == null)
            {
                return NotFound("Sáº£n pháº©m khÃ´ng tá»“n táº¡i.");
            }

            var specifications = await _context.ProductSpecifications
                .Where(s => s.ProductId == productId)
                .ToListAsync();

            if (specifications.Any())
            {
                _context.ProductSpecifications.RemoveRange(specifications);
                await _context.SaveChangesAsync();
            }

            return Ok($"ÄÃ£ xÃ³a {specifications.Count} thÃ´ng sá»‘ ká»¹ thuáº­t cá»§a sáº£n pháº©m {productId}.");
        }

        private bool SpecificationExists(int id)
        {
            return _context.ProductSpecifications.Any(e => e.Id == id);
        }
    }
}
```

### Controllers\UploadController.cs
```cs
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using System;
using System.IO;
using System.Threading.Tasks;

[Route("api/upload")]
[ApiController]
public class UploadController : ControllerBase
{
    private readonly string _uploadFolder = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");


    [HttpPost]
    public async Task<IActionResult> UploadImage(IFormFile file)
    {
        if (file == null || file.Length == 0)
        {
            return BadRequest(new { message = "KhÃ´ng cÃ³ file nÃ o Ä‘Æ°á»£c táº£i lÃªn!" });
        }

        string uniqueFileName = $"{DateTime.Now.Ticks}_{file.FileName}";
        string filePath = Path.Combine(_uploadFolder, uniqueFileName);

        using (var stream = new FileStream(filePath, FileMode.Create))
        {
            await file.CopyToAsync(stream);
        }

        string imageUrl = $"/{uniqueFileName}";
        return Ok(new { imageUrl });
    }
    /// <summary>
    /// Láº¥y danh sÃ¡ch táº¥t cáº£ áº£nh Ä‘Ã£ táº£i lÃªn
    /// </summary>
    [HttpGet]
    public IActionResult GetAllImages()
    {
        if (!Directory.Exists(_uploadFolder))
        {
            return NotFound(new { message = "ThÆ° má»¥c áº£nh trá»‘ng!" });
        }

        var files = Directory.GetFiles(_uploadFolder)
            .Select(Path.GetFileName)
.Select(fileName => new { imageUrl = $"/{fileName}" })
            .ToList();

        return Ok(files);
    }

    /// XÃ³a áº£nh theo tÃªn file
    [HttpDelete("{fileName}")]
    public IActionResult DeleteImage(string fileName)
    {
        string filePath = Path.Combine(_uploadFolder, fileName);

        if (!System.IO.File.Exists(filePath))
        {
            return NotFound(new { message = "áº¢nh khÃ´ng tá»“n táº¡i!" });
        }

        System.IO.File.Delete(filePath);
        return Ok(new { message = "áº¢nh Ä‘Ã£ Ä‘Æ°á»£c xÃ³a!" });
    }
    [HttpGet("get-image/{fileName}")]
    public IActionResult GetImage(string fileName)
    {
        var imagePath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", fileName);
        if (!System.IO.File.Exists(imagePath))
        {
            return NotFound();
        }
        return PhysicalFile(imagePath, "image/png");
    }
}

```

### Controllers\UserController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.Models;
using System.Threading.Tasks;
using System.Collections.Generic;
using SHN_Gear.DTOs;
using SHN_Gear.Services;
using Microsoft.AspNetCore.Authorization;
using System.Security.Claims;
namespace SHN_Gear.Controllers
{
    [ApiController]
    [Route("api/users")]
    public class UserController : ControllerBase
    {
        private readonly AppDbContext _context;

        public UserController(AppDbContext context)
        {
            _context = context;
        }

        // Láº¥y danh sÃ¡ch ngÆ°á»i dÃ¹ng
        [HttpGet]
        public async Task<IActionResult> GetUsers()
        {
            var users = await _context.Users.Include(u => u.Role).ToListAsync();
            return Ok(users);
        }

        // Láº¥y thÃ´ng tin ngÆ°á»i dÃ¹ng theo Id
        [HttpGet("{id}")]
        public async Task<IActionResult> GetUserById(int id)
        {
            var user = await _context.Users.Include(u => u.Role).FirstOrDefaultAsync(u => u.Id == id);

            if (user == null)
            {
                return NotFound("NgÆ°á»i dÃ¹ng khÃ´ng tá»“n táº¡i.");
            }

            return Ok(user);
        }

        [HttpPost]
        public async Task<IActionResult> AddUser([FromBody] UserDto userDto, [FromServices] UserService userService)
        {
            // Kiá»ƒm tra RoleId cÃ³ tá»“n táº¡i trong báº£ng Roles khÃ´ng
            var role = await _context.Roles.FindAsync(userDto.RoleId);
            if (role == null)
            {
                return BadRequest("Vai trÃ² khÃ´ng tá»“n táº¡i.");
            }

            // Kiá»ƒm tra email Ä‘Ã£ tá»“n táº¡i chÆ°a
            if (await _context.Users.AnyAsync(u => u.Email == userDto.Email))
            {
                return BadRequest("Email Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng.");
            }

            // MÃ£ hÃ³a máº­t kháº©u
            string hashedPassword = userService.HashPassword(userDto.Password);

            // Táº¡o Ä‘á»‘i tÆ°á»£ng User tá»« UserDto
            var user = new User
            {
                FullName = userDto.FullName,
                Email = userDto.Email,
                PhoneNumber = userDto.PhoneNumber,
                Password = hashedPassword, // LÆ°u máº­t kháº©u Ä‘Ã£ mÃ£ hÃ³a
                RoleId = userDto.RoleId,
                CreatedAt = DateTime.UtcNow,
                IsActive = true

            };

            // ThÃªm ngÆ°á»i dÃ¹ng má»›i vÃ o cÆ¡ sá»Ÿ dá»¯ liá»‡u
            _context.Users.Add(user);
            await _context.SaveChangesAsync();

            return Ok(user);
        }
        // Cáº­p nháº­t thÃ´ng tin ngÆ°á»i dÃ¹ng (Admin)
        [HttpPut("{id}")]
        public async Task<IActionResult> AdminUpdateUser(int id, [FromBody] AdminUserUpdateDto userUpdateDto)
        {
            var user = await _context.Users.FindAsync(id);
            if (user == null)
            {
                return NotFound("NgÆ°á»i dÃ¹ng khÃ´ng tá»“n táº¡i.");
            }

            var role = await _context.Roles.FindAsync(userUpdateDto.RoleId);
            if (role == null)
            {
                return BadRequest("Vai trÃ² khÃ´ng há»£p lá»‡.");
            }

            user.FullName = userUpdateDto.FullName;
            user.Gender = userUpdateDto.Gender;
            user.PhoneNumber = userUpdateDto.PhoneNumber;
            user.Email = userUpdateDto.Email;
            user.DateOfBirth = userUpdateDto.DateOfBirth;
            user.RoleId = userUpdateDto.RoleId;
            user.IsActive = userUpdateDto.IsActive;

            await _context.SaveChangesAsync();

            return Ok(new { Message = "Cáº­p nháº­t thÃ´ng tin ngÆ°á»i dÃ¹ng thÃ nh cÃ´ng." });
        }

        [HttpPut("profile")]
        public async Task<IActionResult> UpdateProfile([FromBody] EditProfileDto dto)
        {
            // Láº¥y ID ngÆ°á»i dÃ¹ng tá»« token
            var userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userId))
                return Unauthorized(new { Message = "KhÃ´ng xÃ¡c thá»±c Ä‘Æ°á»£c ngÆ°á»i dÃ¹ng" });

            // TÃ¬m ngÆ°á»i dÃ¹ng trong database
            var user = await _context.Users.FindAsync(int.Parse(userId));
            if (user == null)
                return NotFound(new { Message = "NgÆ°á»i dÃ¹ng khÃ´ng tá»“n táº¡i" });

            // Cáº­p nháº­t thÃ´ng tin
            user.FullName = dto.FullName;
            user.Email = dto.Email;
            user.PhoneNumber = dto.PhoneNumber;
            user.Gender = dto.Gender;
            user.DateOfBirth = dto.DateOfBirth;

            try
            {
                await _context.SaveChangesAsync();
                return Ok(new
                {
                    Message = "Cáº­p nháº­t thÃ´ng tin thÃ nh cÃ´ng",
                    User = new
                    {
                        user.FullName,
                        user.Email,
                        user.PhoneNumber,
                        user.Gender,
                        DateOfBirth = user.DateOfBirth?.ToString("yyyy-MM-dd")
                    }
                });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { Message = "Lá»—i khi cáº­p nháº­t", Error = ex.Message });
            }
        }

        // Cáº­p nháº­t vai trÃ² cá»§a ngÆ°á»i dÃ¹ng
        [HttpPut("{id}/role")]
        public async Task<IActionResult> UpdateUserRole(int id, [FromBody] RoleUpdateDto roleUpdateDto)
        {
            if (roleUpdateDto == null || roleUpdateDto.RoleId <= 0)
            {
                return BadRequest("Dá»¯ liá»‡u vai trÃ² khÃ´ng há»£p lá»‡.");
            }

            var user = await _context.Users.FindAsync(id);
            if (user == null)
            {
                return NotFound("NgÆ°á»i dÃ¹ng khÃ´ng tá»“n táº¡i.");
            }

            var role = await _context.Roles.FindAsync(roleUpdateDto.RoleId);
            if (role == null)
            {
                return NotFound("Vai trÃ² khÃ´ng tá»“n táº¡i.");
            }

            user.RoleId = roleUpdateDto.RoleId;
            await _context.SaveChangesAsync();

            return Ok(new { Message = "Vai trÃ² ngÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t thÃ nh cÃ´ng." });
        }

        [HttpGet("statistics")]
        public async Task<IActionResult> GetUserStatistics()
        {
            var totalUsers = await _context.Users.CountAsync(); // Tá»•ng sá»‘ ngÆ°á»i dÃ¹ng

            var today = DateTime.UtcNow.Date;
            var newUsersToday = await _context.Users.CountAsync(u => u.CreatedAt.Date == today); // NgÆ°á»i dÃ¹ng má»›i hÃ´m nay

            var activeUsers = await _context.Users.CountAsync(u => u.IsActive); // NgÆ°á»i dÃ¹ng Ä‘ang hoáº¡t Ä‘á»™ng

            var oneMonthAgo = DateTime.UtcNow.AddMonths(-1);
            var usersLastMonth = await _context.Users.CountAsync(u => u.CreatedAt <= oneMonthAgo); // NgÆ°á»i dÃ¹ng tá»« thÃ¡ng trÆ°á»›c
                                                                                                   // TÃ­nh tá»· lá»‡ duy trÃ¬
            double retentionRate = usersLastMonth > 0 ? (double)activeUsers / usersLastMonth * 100 : 0;


            return Ok(new
            {
                TotalUsers = totalUsers,
                NewUsersToday = newUsersToday,
                ActiveUsers = activeUsers,
                RetentionRate = retentionRate.ToString("0.00") + "%"
            });
        }
        [HttpGet("growth")]
        public async Task<IActionResult> GetUserGrowth()
        {
            var userGrowth = await _context.Users
                .GroupBy(u => new { u.CreatedAt.Year, u.CreatedAt.Month })
                .Select(g => new
                {
                    Month = g.Key.Month,
                    Year = g.Key.Year,
                    Users = g.Count()
                })
                .OrderBy(g => g.Year)
                .ThenBy(g => g.Month)
                .ToListAsync();

            // Chuyá»ƒn Ä‘á»•i dá»¯ liá»‡u thÃ nh format cáº§n thiáº¿t
            var formattedData = userGrowth.Select(g => new
            {
                Month = new DateTime(g.Year, g.Month, 1).ToString("MMM"), // "Jan", "Feb", ...
                Users = g.Users
            });

            return Ok(formattedData);
        }
        //api láº¥y role cá»§a ngÆ°á»i dÃ¹ng hiá»‡n táº¡i
        // [HttpGet("current/role")]
        // [Authorize]
        // public async Task<IActionResult> GetCurrentUserRole()
        // {
        //     try
        //     {
        //         // Láº¥y UserId tá»« claims trong token
        //         var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier);

        //         if (userIdClaim == null || !int.TryParse(userIdClaim.Value, out int userId))
        //         {
        //             return Unauthorized(new { Message = "Token khÃ´ng há»£p lá»‡ - KhÃ´ng xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c ngÆ°á»i dÃ¹ng" });
        //         }

        //         // Láº¥y thÃ´ng tin user vÃ  role tá»« database
        //         var userWithRole = await _context.Users
        //             .Where(u => u.Id == userId)
        //             .Select(u => new
        //             {
        //                 UserId = u.Id,
        //                 RoleId = u.Role.Id,
        //                 RoleName = u.Role.Name,
        //                 // ThÃªm cÃ¡c thÃ´ng tin cáº§n thiáº¿t khÃ¡c
        //                 Email = u.Email,
        //                 IsActive = u.IsActive
        //             })
        //             .FirstOrDefaultAsync();

        //         if (userWithRole == null)
        //         {
        //             return NotFound(new { Message = "KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin ngÆ°á»i dÃ¹ng" });
        //         }

        //         // Táº¡o response object
        //         var response = new
        //         {
        //             userWithRole.UserId,
        //             userWithRole.Email,
        //             userWithRole.IsActive,
        //             Role = new
        //             {
        //                 userWithRole.RoleId,
        //                 userWithRole.RoleName
        //             },
        //             // ThÃªm thÃ´ng tin tá»« token náº¿u cáº§n
        //             Claims = new
        //             {
        //                 // Láº¥y trá»±c tiáº¿p tá»« claims hiá»‡n táº¡i
        //                 RoleClaim = User.FindFirst(ClaimTypes.Role)?.Value,
        //                 MicrosoftRoleClaim = User.FindFirst("http://schemas.microsoft.com/ws/2008/06/identity/claims/role")?.Value
        //             }
        //         };

        //         return Ok(response);
        //     }
        //     catch (Exception ex)
        //     {
        //         return StatusCode(500, new
        //         {
        //             Message = "Lá»—i server khi láº¥y thÃ´ng tin role",
        //             Error = ex.Message
        //         });
        //     }
        // }
    }
}
```

### Controllers\VoucherController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.DTOs;
using SHN_Gear.Models;
using System.Linq;
using System.Threading.Tasks;

namespace SHN_Gear.Controllers
{
    [ApiController]
    [Route("api/vouchers")]
    public class VoucherController : ControllerBase
    {
        private readonly AppDbContext _context;

        public VoucherController(AppDbContext context)
        {
            _context = context;
        }

        // Láº¥y danh sÃ¡ch táº¥t cáº£ cÃ¡c voucher
        [HttpGet]
        public async Task<IActionResult> GetAllVouchers()
        {
            var vouchers = await _context.Vouchers
                .Select(v => new VoucherDto
                {
                    Id = v.Id,
                    Code = v.Code,
                    DiscountAmount = v.DiscountAmount,
                    ExpiryDate = v.ExpiryDate,
                    IsActive = v.IsActive
                })
                .ToListAsync();

            return Ok(vouchers);
        }

        // Láº¥y thÃ´ng tin chi tiáº¿t cá»§a má»™t voucher
        [HttpGet("{id}")]
        public async Task<IActionResult> GetVoucherById(int id)
        {
            var voucher = await _context.Vouchers
                .Where(v => v.Id == id)
                .Select(v => new VoucherDto
                {
                    Id = v.Id,
                    Code = v.Code,
                    DiscountAmount = v.DiscountAmount,
                    ExpiryDate = v.ExpiryDate,
                    IsActive = v.IsActive
                })
                .FirstOrDefaultAsync();

            if (voucher == null)
            {
                return NotFound("Voucher khÃ´ng tá»“n táº¡i.");
            }

            return Ok(voucher);
        }

        [HttpGet("code/{code}")]
        public async Task<IActionResult> GetVoucherByCode(string code)
        {
            var voucher = await _context.Vouchers.FirstOrDefaultAsync(v => v.Code == code);
            if (voucher == null)
            {
                return NotFound("Voucher khÃ´ng tá»“n táº¡i.");
            }

            return Ok(new { id = voucher.Id });
        }

        // ThÃªm má»›i má»™t voucher
        [HttpPost]
        public async Task<IActionResult> AddVoucher([FromBody] VoucherDto dto)
        {
            var voucher = new Voucher
            {
                Code = dto.Code,
                DiscountAmount = dto.DiscountAmount,
                ExpiryDate = dto.ExpiryDate,
                IsActive = dto.IsActive
            };

            _context.Vouchers.Add(voucher);
            await _context.SaveChangesAsync();

            return Ok(new { Message = "Voucher Ä‘Ã£ Ä‘Æ°á»£c thÃªm.", VoucherId = voucher.Id });
        }

        // Cáº­p nháº­t thÃ´ng tin cá»§a má»™t voucher
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateVoucher(int id, [FromBody] VoucherDto dto)
        {
            var voucher = await _context.Vouchers.FindAsync(id);
            if (voucher == null)
            {
                return NotFound("Voucher khÃ´ng tá»“n táº¡i.");
            }

            voucher.Code = dto.Code;
            voucher.DiscountAmount = dto.DiscountAmount;
            voucher.ExpiryDate = dto.ExpiryDate;
            voucher.IsActive = dto.IsActive;

            await _context.SaveChangesAsync();

            return Ok(new { Message = "Voucher Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t." });
        }

        // XÃ³a má»™t voucher
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteVoucher(int id)
        {
            var voucher = await _context.Vouchers.FindAsync(id);
            if (voucher == null)
            {
                return NotFound("Voucher khÃ´ng tá»“n táº¡i.");
            }

            _context.Vouchers.Remove(voucher);
            await _context.SaveChangesAsync();

            return Ok(new { Message = "Voucher Ä‘Ã£ Ä‘Æ°á»£c xÃ³a." });
        }

        // GÃ¡n voucher cho ngÆ°á»i dÃ¹ng
        [HttpPost("assign")]
        public async Task<IActionResult> AssignVoucherToUser([FromBody] UserVoucherDto dto)
        {
            var user = await _context.Users.FindAsync(dto.UserId);
            if (user == null)
            {
                return NotFound("NgÆ°á»i dÃ¹ng khÃ´ng tá»“n táº¡i.");
            }

            var voucher = await _context.Vouchers.FindAsync(dto.VoucherId);
            if (voucher == null)
            {
                return NotFound("Voucher khÃ´ng tá»“n táº¡i.");
            }

            var userVoucher = new UserVoucher
            {
                UserId = dto.UserId,
                VoucherId = dto.VoucherId,
                UsedAt = dto.UsedAt
            };

            _context.UserVouchers.Add(userVoucher);
            await _context.SaveChangesAsync();

            return Ok(new { Message = "Voucher Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n cho ngÆ°á»i dÃ¹ng." });
        }

        [HttpPost("apply")]
        public async Task<IActionResult> ApplyVoucher([FromBody] ApplyVoucherDto dto)
        {
            // Kiá»ƒm tra voucher há»£p lá»‡
            var voucher = await _context.Vouchers
                .FirstOrDefaultAsync(v => v.Code == dto.Code && v.IsActive && v.ExpiryDate >= DateTime.UtcNow);
            if (voucher == null)
            {
                return BadRequest("Voucher khÃ´ng há»£p lá»‡ hoáº·c Ä‘Ã£ háº¿t háº¡n.");
            }

            // Kiá»ƒm tra xem voucher Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n cho ngÆ°á»i dÃ¹ng nÃ o chÆ°a
            var userVoucher = await _context.UserVouchers
                .FirstOrDefaultAsync(uv => uv.VoucherId == voucher.Id);

            // Náº¿u voucher chÆ°a Ä‘Æ°á»£c gÃ¡n cho báº¥t ká»³ ai
            if (userVoucher == null)
            {
                return BadRequest("Voucher nÃ y chÆ°a Ä‘Æ°á»£c gÃ¡n cho ngÆ°á»i dÃ¹ng nÃ o.");
            }

            // Náº¿u voucher Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n, kiá»ƒm tra xem ngÆ°á»i dÃ¹ng hiá»‡n táº¡i cÃ³ pháº£i lÃ  chá»§ sá»Ÿ há»¯u khÃ´ng
            if (userVoucher.UserId != dto.UserId)
            {
                return BadRequest("Voucher nÃ y chá»‰ cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi ngÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n.");
            }

            // Kiá»ƒm tra tráº¡ng thÃ¡i IsUsed
            if (userVoucher.IsUsed)
            {
                return BadRequest("Voucher Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng.");
            }

            // Náº¿u IsUsed = false vÃ  UserId khá»›p, cho phÃ©p Ã¡p dá»¥ng
            return Ok(new { discountAmount = voucher.DiscountAmount });
        }
    }
}
```

### Controllers\WeatherForecastController.cs
```cs
ï»¿using Microsoft.AspNetCore.Mvc;

namespace SHN_Gear.Controllers;

[ApiController]
[Route("[controller]")]
public class WeatherForecastController : ControllerBase
{
    private static readonly string[] Summaries = new[]
    {
        "Freezing", "Bracing", "Chilly", "Cool", "Mild", "Warm", "Balmy", "Hot", "Sweltering", "Scorching"
    };

    private readonly ILogger<WeatherForecastController> _logger;

    public WeatherForecastController(ILogger<WeatherForecastController> logger)
    {
        _logger = logger;
    }

    [HttpGet]
    public IEnumerable<WeatherForecast> Get()
    {
        return Enumerable.Range(1, 5).Select(index => new WeatherForecast
        {
            Date = DateOnly.FromDateTime(DateTime.Now.AddDays(index)),
            TemperatureC = Random.Shared.Next(-20, 55),
            Summary = Summaries[Random.Shared.Next(Summaries.Length)]
        })
        .ToArray();
    }
}

```

### Data\AppDbContext.cs
```cs
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Models;

namespace SHN_Gear.Data
{
    public class AppDbContext : DbContext
    {
        public AppDbContext(DbContextOptions<AppDbContext> options) : base(options) { }

        // Äá»‹nh nghÄ©a cÃ¡c báº£ng
        public DbSet<User> Users { get; set; }
        public DbSet<Role> Roles { get; set; }
        public DbSet<Product> Products { get; set; }
        public DbSet<ProductSpecification> ProductSpecifications { get; set; }
        public DbSet<ProductImage> ProductImages { get; set; }
        public DbSet<Cart> Carts { get; set; }
        public DbSet<CartItem> CartItems { get; set; }
        public DbSet<ProductVariant> ProductVariants { get; set; } // ThÃªm DbSet cho ProductVariant
        public DbSet<Category> Categories { get; set; } // ThÃªm DbSet cho Category
        public DbSet<Brand> Brands { get; set; } // ThÃªm DbSet cho Brand
        public DbSet<Order> Orders { get; set; } // ThÃªm DbSet cho Order
        public DbSet<OrderItem> OrderItems { get; set; } // ThÃªm DbSet cho OrderItem
        public DbSet<Address> Addresses { get; set; } // ThÃªm DbSet cho Address
        public DbSet<PaymentMethod> PaymentMethods { get; set; } // ThÃªm DbSet cho PaymentMethod
        public DbSet<Review> Reviews { get; set; } // ThÃªm DbSet cho Review
        public DbSet<Delivery> Deliveries { get; set; } // ThÃªm DbSet cho Delivery
        public DbSet<Voucher> Vouchers { get; set; }
        public DbSet<UserVoucher> UserVouchers { get; set; } // ThÃªm DbSet cho UserVoucher
        public DbSet<HomepageConfig> HomepageConfigurations { get; set; }

        // Chat System DbSets
        public DbSet<ChatSession> ChatSessions { get; set; }
        public DbSet<ChatMessage> ChatMessages { get; set; }
        public DbSet<AIKnowledgeBase> AIKnowledgeBases { get; set; }
        public DbSet<BlogPost> BlogPosts { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);

            // Seed dá»¯ liá»‡u máº·c Ä‘á»‹nh cho Role
            modelBuilder.Entity<Role>().HasData(
                new Role { Id = 1, Name = "Admin" },
                new Role { Id = 2, Name = "VIP 1" },
                new Role { Id = 3, Name = "VIP 2" },
                new Role { Id = 4, Name = "VIP 3" }
            );
            // âœ… Seed dá»¯ liá»‡u máº·c Ä‘á»‹nh cho PaymentMethod
            modelBuilder.Entity<PaymentMethod>().HasData(
                new PaymentMethod { Id = 1, Name = "Tiá»n Máº·t", Description = "Thanh toÃ¡n báº±ng tiá»n máº·t" },
                new PaymentMethod { Id = 2, Name = "MoMo", Description = "Thanh toÃ¡n báº±ng Momo" },
                new PaymentMethod { Id = 3, Name = "Paypal", Description = "Thanh toÃ¡n báº±ng vÃ­ Paypal" }
            );
            // âœ… Thiáº¿t láº­p quan há»‡ Category - Product (1-N)
            modelBuilder.Entity<Product>()
                .HasOne(p => p.Category)
                .WithMany(c => c.Products)
                .HasForeignKey(p => p.CategoryId);

            // Thiáº¿t láº­p duy nháº¥t cho sá»‘ Ä‘iá»‡n thoáº¡i (KhÃ´ng cho phÃ©p sá»‘ trÃ¹ng)
            modelBuilder.Entity<User>()
                .HasIndex(u => u.PhoneNumber)
                .IsUnique();

            // Specify the SQL Server column type for the Price property in ProductVariant
            modelBuilder.Entity<ProductVariant>()
                .Property(pv => pv.Price)
                .HasColumnType("decimal(18,2)");

            // Specify the SQL Server column type for the DiscountPrice property in ProductVariant
            modelBuilder.Entity<ProductVariant>()
                .Property(pv => pv.DiscountPrice)
                .HasPrecision(18, 2);

            // Specify the SQL Server column type for FlashSalePrice in Product
            modelBuilder.Entity<Product>()
                .Property(p => p.FlashSalePrice)
                .HasColumnType("decimal(18,2)");

            modelBuilder.Entity<OrderItem>()
                .HasOne(oi => oi.Order)
                .WithMany(o => o.OrderItems)
                .OnDelete(DeleteBehavior.Cascade); // XÃ³a Ä‘Æ¡n hÃ ng thÃ¬ xÃ³a cáº£ cÃ¡c máº·t hÃ ng trong Ä‘Æ¡n hÃ ng.

            // Thiáº¿t láº­p khÃ³a chÃ­nh cho báº£ng UserVoucher
            modelBuilder.Entity<UserVoucher>()
                .HasKey(uv => new { uv.UserId, uv.VoucherId });

            // Thiáº¿t láº­p quan há»‡ giá»¯a User vÃ  UserVoucher
            modelBuilder.Entity<UserVoucher>()
                .HasOne(uv => uv.User)
                .WithMany(u => u.UserVouchers)
                .HasForeignKey(uv => uv.UserId);

            // Thiáº¿t láº­p quan há»‡ giá»¯a Voucher vÃ  UserVoucher
            modelBuilder.Entity<UserVoucher>()
                .HasOne(uv => uv.Voucher)
                .WithMany(v => v.UserVouchers)
                .HasForeignKey(uv => uv.VoucherId);

            modelBuilder.Entity<Review>(entity =>
            {
                entity.HasKey(r => r.Id);

                entity.Property(r => r.Comment).IsRequired();
                entity.Property(r => r.Rating);
                entity.Property(r => r.CreatedAt);
                entity.Property(r => r.IsApproved);

                entity.HasOne(r => r.User)
                    .WithMany(u => u.Reviews)
                    .HasForeignKey(r => r.UserId);

                entity.HasOne(r => r.Product) // âœ… má»›i
                    .WithMany()
                    .HasForeignKey(r => r.ProductId); // âœ… má»›i
            });

            modelBuilder.Entity<Delivery>(entity =>
    {
        // Giáº£ Ä‘á»‹nh Delivery cÃ³ thuá»™c tÃ­nh ShippingCost
        entity.Property(d => d.ShippingCost).HasColumnType("decimal(18, 2)");
    });

            modelBuilder.Entity<Order>(entity =>
            {
                // Giáº£ Ä‘á»‹nh Order cÃ³ thuá»™c tÃ­nh TotalAmount
                entity.Property(o => o.TotalAmount).HasColumnType("decimal(18, 2)");
            });

            modelBuilder.Entity<OrderItem>(entity =>
            {
                // Giáº£ Ä‘á»‹nh OrderItem cÃ³ thuá»™c tÃ­nh Price (ngoÃ i giÃ¡ gá»‘c tá»« ProductVariant)
                // Náº¿u OrderItem khÃ´ng cÃ³ cá»™t Price riÃªng mÃ  dÃ¹ng giÃ¡ tá»« ProductVariant thÃ¬ khÃ´ng cáº§n dÃ²ng nÃ y
                entity.Property(oi => oi.Price).HasColumnType("decimal(18, 2)");
            });
            modelBuilder.Entity<Voucher>(entity =>
    {
        // Giáº£ Ä‘á»‹nh Voucher cÃ³ thuá»™c tÃ­nh DiscountAmount
        entity.Property(v => v.DiscountAmount).HasColumnType("decimal(18, 2)");
    });

            // âœ… Chat System decimal configurations
            modelBuilder.Entity<AIKnowledgeBase>(entity =>
            {
                entity.Property(a => a.EscalationThreshold).HasPrecision(5, 3); // 0.000 to 99.999
                entity.Property(a => a.MinConfidenceScore).HasPrecision(5, 3); // 0.000 to 99.999
            });

            modelBuilder.Entity<ChatMessage>(entity =>
            {
                entity.Property(cm => cm.AIConfidenceScore).HasPrecision(5, 3); // 0.000 to 99.999

                // Configure relationship with SenderUser
                entity.HasOne(cm => cm.SenderUser)
                      .WithMany()
                      .HasForeignKey(cm => cm.SenderId)
                      .OnDelete(DeleteBehavior.SetNull);
            });

            modelBuilder.Entity<ChatSession>(entity =>
            {
                entity.Property(cs => cs.ConfidenceScore).HasPrecision(5, 3); // 0.000 to 99.999
            });

            // ThÃªm cÃ¡c quan há»‡ khÃ¡c tÆ°Æ¡ng tá»± á»Ÿ Ä‘Ã¢y.

            // Add indexes for query optimization
            modelBuilder.Entity<Product>(entity =>
            {
                entity.HasIndex(p => p.CategoryId).HasDatabaseName("IX_Products_CategoryId");
                entity.HasIndex(p => p.BrandId).HasDatabaseName("IX_Products_BrandId");
                entity.HasIndex(p => p.IsFlashSale).HasDatabaseName("IX_Products_IsFlashSale");
            });

            modelBuilder.Entity<ProductVariant>(entity =>
            {
                entity.HasIndex(pv => pv.ProductId).HasDatabaseName("IX_ProductVariants_ProductId");
                entity.HasIndex(pv => pv.Price).HasDatabaseName("IX_ProductVariants_Price");
            });
        }
    }
}

```

### DTOs\AccountDto.cs
```cs
namespace SHN_Gear.DTOs
{
    public class EmailDto
    {
        public string Email { get; set; } = string.Empty;
    }

    public class LoginDto
    {
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }

    public class RegisterDto
    {
        public string FullName { get; set; } = string.Empty;
        public string PhoneNumber { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }


    public class OtpRequestDto
    {
        public string Email { get; set; } = string.Empty;
    }


    public class EditProfileDto
    {

        public string FullName { get; set; } = string.Empty;


        public string Email { get; set; } = string.Empty;

        public string? PhoneNumber { get; set; }

        public string? Gender { get; set; }

        public DateTime? DateOfBirth { get; set; }
    }

}
```

### DTOs\AddressDTO.cs
```cs
namespace SHN_Gear.DTOs
{
    public class AddressDTO
    {
        public int Id { get; set; }
        public string FullName { get; set; } = null!;
        public string PhoneNumber { get; set; } = null!;
        public string AddressLine1 { get; set; } = null!;
        public string? AddressLine2 { get; set; }
        public string City { get; set; } = null!;
        public string? State { get; set; }
        public string ZipCode { get; set; } = null!;
        public string Country { get; set; } = null!;
    }

    public class CreateAddressDTO
    {
        public int UserId { get; set; } // âœ… ÄÃ£ sá»­a thÃ nh kiá»ƒu int
        public string FullName { get; set; } = null!;
        public string PhoneNumber { get; set; } = null!;
        public string AddressLine1 { get; set; } = null!;
        public string? AddressLine2 { get; set; }
        public string City { get; set; } = null!;
        public string? State { get; set; }
        public string ZipCode { get; set; } = null!;
        public string Country { get; set; } = null!;
    }
}

```

### DTOs\AdminMessageDto.cs
```cs
namespace SHN_Gear.DTOs
{
    public class AdminMessageDto
    {
        public string Content { get; set; } = null!;
    }
}

```

### DTOs\AdminUserUpdateDto.cs
```cs
public class AdminUserUpdateDto
{
    public string FullName { get; set; } = string.Empty;
    public string? Gender { get; set; }
    public DateTime? DateOfBirth { get; set; }
    public int RoleId { get; set; }
    public string PhoneNumber { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;

    public bool IsActive { get; set; } = true;
}

```

### DTOs\BlogPostDto.cs
```cs
using System;
using System.ComponentModel.DataAnnotations;

namespace SHN_Gear.DTOs
{
    public class BlogPostDto
    {
        public int Id { get; set; }
        public string Title { get; set; }
        public string Content { get; set; }
        public int AuthorId { get; set; }
        public string AuthorName { get; set; } // To display author's name
        public DateTime CreatedAt { get; set; }
        public DateTime UpdatedAt { get; set; }
        public bool IsPublished { get; set; }
    }
}

```

### DTOs\CartDto.cs
```cs
namespace SHN_Gear.DTOs
{
    public class CartDto
    {
        public int UserId { get; set; }
        public int ProductVariantId { get; set; }
        public int Quantity { get; set; }
    }

    public class CartItemSession
    {
        public int ProductVariantId { get; set; }
        public int Quantity { get; set; }

    }

}
```

### DTOs\CategoryDto.cs
```cs
using System.ComponentModel.DataAnnotations;

namespace SHN_Gear.DTOs
{
    public class CategoryDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = null!;
        public string Description { get; set; } = null!;
        public string Image { get; set; } = null!;
    }

    public class CreateCategoryDto
    {
        [Required]
        [StringLength(100)]
        public string Name { get; set; } = null!;

        [Required]
        public string Description { get; set; } = null!;

        [Required]
        public string Image { get; set; } = null!;
    }
}
```

### DTOs\ChatDto.cs
```cs
namespace SHN_Gear.DTOs
{
    public class ChatSessionDto
    {
        public int Id { get; set; }
        public string SessionId { get; set; } = null!;
        public string? GuestName { get; set; }
        public string? GuestEmail { get; set; }
        public UserDto? User { get; set; }
        public DateTime CreatedAt { get; set; }
        public DateTime LastActivityAt { get; set; }
        public string Status { get; set; } = null!;
        public string Type { get; set; } = null!;
        public UserDto? AssignedAdmin { get; set; }
        public bool RequiresHumanSupport { get; set; }
        public List<ChatMessageDto> Messages { get; set; } = new();
    }

    public class ChatMessageDto
    {
        public int Id { get; set; }
        public int ChatSessionId { get; set; } // Add this field for frontend filtering
        public string Content { get; set; } = null!;
        public string Type { get; set; } = null!;
        public string Sender { get; set; } = null!;
        public UserDto? SenderUser { get; set; }
        public DateTime SentAt { get; set; }
        public bool IsRead { get; set; }
        public decimal? AIConfidenceScore { get; set; }
        public string? AIIntent { get; set; }
        public bool RequiresEscalation { get; set; }
        public List<object>? Attachments { get; set; }
        public List<SuggestedActionDto>? SuggestedActions { get; set; }
        public object? Metadata { get; set; }
    }

    public class SuggestedActionDto
    {
        public string Text { get; set; } = null!;
        public string Action { get; set; } = null!; // "quick_reply", "view_product", "contact_admin"
        public object? Data { get; set; } // Additional data cho action
    }

    public class SendMessageDto
    {
        public string Content { get; set; } = null!;
        public string? SessionId { get; set; } // Null Ä‘á»ƒ táº¡o session má»›i
        public string? GuestName { get; set; } // Cho guest users
        public string? GuestEmail { get; set; }
        public object? Context { get; set; } // Context vá» user preferences, current product, etc.
    }

    public class AIResponseDto
    {
        public string Response { get; set; } = null!;
        public decimal ConfidenceScore { get; set; }
        public string Intent { get; set; } = null!;
        public bool RequiresEscalation { get; set; }
        public List<SuggestedActionDto>? SuggestedActions { get; set; }
        public List<ProductRecommendationDto>? ProductRecommendations { get; set; }
        public object? Context { get; set; }
    }

    public class ProductRecommendationDto
    {
        public int ProductId { get; set; }
        public string Name { get; set; } = null!;
        public string ImageUrl { get; set; } = null!;
        public decimal Price { get; set; }
        public decimal? DiscountPrice { get; set; }
        public string Brand { get; set; } = null!;
        public string Category { get; set; } = null!;
        public string Reason { get; set; } = null!; // LÃ½ do recommend
    }

    public class EscalateChatDto
    {
        public int SessionId { get; set; }
        public string Reason { get; set; } = null!;
        public int? PreferredAdminId { get; set; }
    }
}

```

### DTOs\CreateBlogPostDto.cs
```cs
using System.ComponentModel.DataAnnotations;

namespace SHN_Gear.DTOs
{
    public class CreateBlogPostDto
    {
        [Required]
        [MaxLength(250)]
        public string Title { get; set; }

        [Required]
        public string Content { get; set; }

        public bool IsPublished { get; set; } = false;
    }
}

```

### DTOs\CreateProductDto.cs
```cs
namespace SHN_Gear.DTOs
{
    public class CreateProductDto
    {
        public string Name { get; set; } = null!;
        public string Description { get; set; } = null!;
        public int CategoryId { get; set; }
        public int BrandId { get; set; }
        public List<IFormFile> Images { get; set; } = new();
    }
}

```

### DTOs\FlashSaleUpdateDto.cs
```cs
using System;
using System.ComponentModel.DataAnnotations;

namespace SHN_Gear.DTOs
{
    public class FlashSaleUpdateDto
    {
        [Required]
        public decimal FlashSalePrice { get; set; }

        [Required]
        public DateTime FlashSaleStartDate { get; set; }

        [Required]
        public DateTime FlashSaleEndDate { get; set; }
    }
}

```

### DTOs\HeadphoneSpecificationDto.cs
```cs
namespace SHN_Gear
{
    public class HeadphoneSpecificationDto
    {
        public int ProductId { get; set; }
        public string Weight { get; set; } = null!;

        public string Type { get; set; } = null!; // KhÃ´ng dÃ¢y, Chá»¥p tai
        public string ConnectionType { get; set; } = null!;
        public string Port { get; set; } = null!;
    }

}
```

### DTOs\HomepageDtos.cs
```cs
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;

namespace SHN_Gear.DTOs
{
    public class HomepageConfigDto
    {
        public List<string> Layout { get; set; } = new List<string>();
        public HomepageComponentsDto Components { get; set; } = new HomepageComponentsDto();
    }

    public class HomepageComponentsDto
    {
        public HeroSectionDto Hero { get; set; } = new HeroSectionDto();
        public CategoriesSectionDto Categories { get; set; } = new CategoriesSectionDto();
        public FeaturedProductsSectionDto Featured_products { get; set; } = new FeaturedProductsSectionDto();
        public SpecialOfferSectionDto Special_offer { get; set; } = new SpecialOfferSectionDto();
        public BestSellerSectionDto Best_seller { get; set; } = new BestSellerSectionDto(); // New Best Seller Section
        public BrandTrustSectionDto Brand_trust { get; set; } = new BrandTrustSectionDto();
    }

    // New DTO for Categories Section
    public class CategoriesSectionDto
    {
        public bool Enabled { get; set; }
        public List<HomepageCategoryItemDto> Items { get; set; } = new List<HomepageCategoryItemDto>(); // Changed to HomepageCategoryItemDto
    }

    public class HomepageCategoryItemDto
    {
        public int CategoryId { get; set; }
        public int DisplayOrder { get; set; }
        // These will be populated on the fly for GET requests
        public string? Name { get; set; }
        public string? Image_url { get; set; }
        public string? Link { get; set; }
    }

    public class HeroSectionDto
    {
        public bool Enabled { get; set; }
        public string Background_type { get; set; } = "";
        public string Background_url { get; set; } = "";
        public string Headline { get; set; } = "";
        public string Slogan { get; set; } = "";
        public string Cta_text { get; set; } = "";
        public string Cta_link { get; set; } = "";
    }

    public class FeaturedProductsSectionDto
    {
        public bool Enabled { get; set; }
        public string Title { get; set; } = "";
        public string Collection_id { get; set; } = "";
    }

    public class SpecialOfferSectionDto
    {
        public bool Enabled { get; set; }
        public string Image_url { get; set; } = "";
        public string Headline { get; set; } = "";
        public string Sub_text { get; set; } = "";
        public string Cta_text { get; set; } = "";
        public string Cta_link { get; set; } = "";
        public bool Countdown_enabled { get; set; }
        public string Countdown_end_date { get; set; } = "";
        public decimal? OriginalPrice { get; set; }
        public decimal? DiscountPrice { get; set; }
    }

    public class BestSellerSectionDto
    {
        public bool Enabled { get; set; }
        public string Title { get; set; } = "";
        public List<BestSellerItemDto> Items { get; set; } = new List<BestSellerItemDto>();
    }

    public class BestSellerItemDto
    {
        public int ProductId { get; set; }
        public decimal? OverridePrice { get; set; }
    }

    public class BrandTrustSectionDto
    {
        public bool Enabled { get; set; }
        public List<BrandLogoDto> Logos { get; set; } = new List<BrandLogoDto>();
        public List<CommitmentDto> Commitments { get; set; } = new List<CommitmentDto>();
    }

    public class BrandLogoDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Logo_url { get; set; } = "";
    }

    public class CommitmentDto
    {
        public int Id { get; set; }
        public string Icon { get; set; } = "";
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
    }
}
```

### DTOs\LaptopSpecificationDto.cs
```cs
namespace SHN_Gear{
     public class LaptopSpecificationDto
{
    public int ProductId { get; set; }
    public string Weight { get; set; } = null!;
    public string Material { get; set; } = null!;
    public string CPUType { get; set; } = null!;
    public int CPUNumberOfCores { get; set; }
    public string RAM { get; set; } = null!;
    public string MaxRAMSupport { get; set; } = null!;
    public string SSDStorage { get; set; } = null!;
    public string ScreenSize { get; set; } = null!;
    public string Resolution { get; set; } = null!;
    public string RefreshRate { get; set; } = null!;
    public bool SupportsTouch { get; set; }
}

}
```

### DTOs\LoyaltyStatusDto.cs
```cs
namespace SHN_Gear.DTOs
{
    // DTO cho thÃ´ng tin tráº¡ng thÃ¡i loyalty
    public class LoyaltyStatusDto
    {
        public string CurrentRank { get; set; } = string.Empty;
        public int CurrentPoints { get; set; }
        public int PointsNeededForNextRank { get; set; }
        public bool CanClaimVoucher { get; set; }
        public decimal VoucherValue { get; set; }
    }

    // DTO cho pháº£n há»“i khi claim voucher
    public class VoucherClaimResponseDto
    {
        public VoucherDto Voucher { get; set; } = new VoucherDto();
        public string Message { get; set; } = string.Empty;
    }

    // DTO má»Ÿ rá»™ng tá»« VoucherDto Ä‘á»ƒ bao gá»“m thÃ´ng tin sá»­ dá»¥ng
    public class UserVoucherDetailDto : VoucherDto
    {
        public DateTime UsedAt { get; set; }
        public bool IsUsed => UsedAt != DateTime.MinValue;
    }

    // DTO cho thÃ´ng tin ngÆ°á»i dÃ¹ng trong chÆ°Æ¡ng trÃ¬nh loyalty
    public class LoyaltyUserDto
    {
        public int Id { get; set; }
        public string FullName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public int Points { get; set; }
        public string RoleName { get; set; } = string.Empty;
        public DateTime MemberSince { get; set; }
    }
}
```

### DTOs\OrderDto.cs
```cs
namespace SHN_Gear.DTOs
{
    public class OrderDto
    {
        public int Id { get; set; }
        public int? UserId { get; set; }
        public DateTime OrderDate { get; set; } = DateTime.UtcNow;
        public decimal TotalAmount { get; set; }
        public string OrderStatus { get; set; } = "Pending";
        public int? AddressId { get; set; }
        public int PaymentMethodId { get; set; }
        public List<OrderItemDto> OrderItems { get; set; } = new List<OrderItemDto>();
        public int? VoucherId { get; set; }
    }

    public class OrderItemDto
    {
        public int ProductVariantId { get; set; }
        public int Quantity { get; set; }
        public decimal Price { get; set; }
    }
    public class UpdateStatusDto
    {
        public string NewStatus { get; set; }
    }
    public class UpdateOrderDto
    {
        public int? AddressId { get; set; }
        public List<OrderItemDto> OrderItems { get; set; } = new List<OrderItemDto>();
        public int? VoucherId { get; set; }
    }

}

```

### DTOs\PhoneSpecificationDto.cs
```cs
namespace SHN_Gear{
    public class PhoneSpecificationDto
{
    public int ProductId { get; set; }
    public string ScreenSize { get; set; } = null!;
    public string Resolution { get; set; } = null!;
    public string ScreenType { get; set; } = null!;
    public string Weight { get; set; } = null!;
    public string Material { get; set; } = null!;
    public string CPUModel { get; set; } = null!;
    public int CPUCores { get; set; }
    public string RAM { get; set; } = null!;
    public string InternalStorage { get; set; } = null!;
    public string FrontCamera { get; set; } = null!;
    public string RearCamera { get; set; } = null!;
    public string BatteryCapacity { get; set; } = null!;
    public bool SupportsNFC { get; set; }
}

}
```

### DTOs\ProductDto.cs
```cs
public class ProductDto
{
    public int Id { get; set; }
    public string Name { get; set; } = null!;
    public string Description { get; set; } = null!;
    public int CategoryId { get; set; }
    public int BrandId { get; set; }
    public List<ProductImageDto> Images { get; set; } = new();
    public List<ProductVariantDto> Variants { get; set; } = new();
    public bool IsFlashSale { get; set; }
    public decimal? FlashSalePrice { get; set; }
    public DateTime? FlashSaleStartDate { get; set; }
    public DateTime? FlashSaleEndDate { get; set; }
}

public class ProductImageDto
{
    public string ImageUrl { get; set; } = null!;
    public bool IsPrimary { get; set; }
}

public class ProductVariantDto
{
    public string Color { get; set; } = null!;
    public string Storage { get; set; } = null!;
    public decimal Price { get; set; }
    public decimal? DiscountPrice { get; set; }
    public int StockQuantity { get; set; }
}

```

### DTOs\ProductSpecificationDetailDto.cs
```cs
namespace SHN_Gear.DTOs
{
    public class ProductSpecificationDetailDto
    {
        public string Value { get; set; }
        public string? Unit { get; set; }
    }
}
```

### DTOs\ProductSpecificationDto.cs
```cs
namespace SHN_Gear.DTOs
{
    public class ProductSpecificationDto
    {
        public int Id { get; set; }
        public int ProductId { get; set; }
        public string Name { get; set; }
        public string Value { get; set; }
        public string? Unit { get; set; }
        public int DisplayOrder { get; set; }
        public DateTime CreatedAt { get; set; }
    }

    public class CreateProductSpecificationDto
    {
        public int ProductId { get; set; }
        public string Name { get; set; }
        public string Value { get; set; }
        public string? Unit { get; set; }
        public int DisplayOrder { get; set; } = 0;
    }

    public class UpdateProductSpecificationDto
    {
        public string Name { get; set; }
        public string Value { get; set; }
        public string? Unit { get; set; }
        public int DisplayOrder { get; set; }
    }
}

```

### DTOs\ReviewDto.cs
```cs
namespace SHN_Gear.DTOs
{
    public class ReviewDto
    {
        public int Id { get; set; }
        public int ProductId { get; set; }
        public int UserId { get; set; }
        public string UserName { get; set; } = string.Empty;
        public int Rating { get; set; }
        public string Comment { get; set; } = string.Empty;
        public DateTime CreatedAt { get; set; }
        public bool IsApproved { get; set; }
        public bool HasPurchased { get; set; }
        public string ProductName { get; set; } = string.Empty;
    }

    public class CreateReviewDto
    {
        public int ProductId { get; set; }
        public int Rating { get; set; }
        public string Comment { get; set; } = string.Empty;
    }

    public class UpdateReviewDto
    {
        public int Rating { get; set; }
        public string Comment { get; set; } = string.Empty;
    }
}

```

### DTOs\SearchDto.cs
```cs
// Models/DTOs/SearchDto.cs
namespace SHN_Gear.Models.DTOs
{
    public class SearchResultDto
    {
        public List<SearchProductDto> Products { get; set; } = new List<SearchProductDto>();
        public List<SearchCategoryDto> Categories { get; set; } = new List<SearchCategoryDto>();
        public List<SearchBrandDto> Brands { get; set; } = new List<SearchBrandDto>();
        public int TotalResults { get; set; }
        public int Page { get; set; } = 1;
        public int PageSize { get; set; } = 10;
    }

    public class SearchProductDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = null!;
        public string ImageUrl { get; set; } = null!;
        public decimal Price { get; set; }
    }

    public class SearchCategoryDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = null!;
    }

    public class SearchBrandDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = null!;
        public string LogoUrl { get; set; } = null!;
    }
}
```

### DTOs\UpdateBlogPostDto.cs
```cs
using System.ComponentModel.DataAnnotations;

namespace SHN_Gear.DTOs
{
    public class UpdateBlogPostDto
    {
        [Required]
        [MaxLength(250)]
        public string Title { get; set; }

        [Required]
        public string Content { get; set; }

        public bool IsPublished { get; set; }
    }
}

```

### DTOs\UploadResponseDto.cs
```cs
namespace SHN_Gear.DTOs
{
    public class UploadResponseDto
    {
        public bool Success { get; set; }
        public string Message { get; set; }
        public string Url { get; set; }
        public string PublicId { get; set; }
    }
}
```

### DTOs\UserDto.cs
```cs
namespace SHN_Gear.DTOs
{
    public class UserDto
    {
        public int Id { get; set; }
        public string FullName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string PhoneNumber { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public int RoleId { get; set; }
    }
    public class RoleUpdateDto
    {
        public int RoleId { get; set; }
    }
    public class UserRoleDto
    {
        public int RoleId { get; set; }
        public string RoleName { get; set; } = string.Empty;
    }
}
```

### DTOs\VoucherDto.cs
```cs
namespace SHN_Gear.DTOs
{
    public class VoucherDto
    {
        public int Id { get; set; }
        public string Code { get; set; } = null!; // MÃ£ voucher
        public decimal DiscountAmount { get; set; } // Sá»‘ tiá»n giáº£m giÃ¡
        public DateTime ExpiryDate { get; set; } // NgÃ y háº¿t háº¡n
        public bool IsActive { get; set; } = true; // Tráº¡ng thÃ¡i hoáº¡t Ä‘á»™ng cá»§a voucher
    }
    public class UserVoucherDto
    {
        public int UserId { get; set; }
        public int VoucherId { get; set; }
        public DateTime UsedAt { get; set; } // Thá»i gian sá»­ dá»¥ng voucher
    }
    public class ApplyVoucherDto
    {
        public string Code { get; set; } = null!;
        public int UserId { get; set; }
    }
}
```

### Hubs\ChatHub.cs
```cs
using Microsoft.AspNetCore.SignalR;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Cors;
using SHN_Gear.Services;
using System.Security.Claims;

namespace SHN_Gear.Hubs
{
    [EnableCors("SignalRPolicy")]
    public class ChatHub : Hub
    {
        private readonly ChatService _chatService;
        private readonly ILogger<ChatHub> _logger;

        public ChatHub(ChatService chatService, ILogger<ChatHub> logger)
        {
            _chatService = chatService;
            _logger = logger;
        }

        /// <summary>
        /// User joins a chat session
        /// </summary>
        public async Task JoinSession(string sessionId)
        {
            try
            {
                await Groups.AddToGroupAsync(Context.ConnectionId, $"session_{sessionId}");
                _logger.LogInformation("User {ConnectionId} joined session {SessionId}", Context.ConnectionId, sessionId);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error joining session {SessionId}", sessionId);
            }
        }

        /// <summary>
        /// User leaves a chat session
        /// </summary>
        public async Task LeaveSession(string sessionId)
        {
            try
            {
                await Groups.RemoveFromGroupAsync(Context.ConnectionId, $"session_{sessionId}");
                _logger.LogInformation("User {ConnectionId} left session {SessionId}", Context.ConnectionId, sessionId);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error leaving session {SessionId}", sessionId);
            }
        }

        /// <summary>
        /// Admin joins admin group to receive escalation notifications
        /// </summary>
        public async Task JoinAdminGroup()
        {
            try
            {
                var userId = GetCurrentUserId();
                var userName = GetCurrentUserName();
                var isAuthenticated = Context.User?.Identity?.IsAuthenticated == true;

                // Log the attempt with more details
                _logger.LogInformation("Admin join attempt: UserId={UserId}, UserName={UserName}, IsAuthenticated={IsAuthenticated}, ConnectionId={ConnectionId}",
                    userId, userName, isAuthenticated, Context.ConnectionId);

                // Check if user is admin (more flexible than [Authorize])
                var isAdmin = Context.User?.IsInRole("Admin") == true ||
                             Context.User?.FindFirst("role")?.Value == "Admin" ||
                             Context.User?.FindFirst(ClaimTypes.Role)?.Value == "Admin";

                _logger.LogInformation("Admin role check: IsAdmin={IsAdmin} for UserId={UserId}", isAdmin, userId);

                if (isAdmin || (isAuthenticated && userId.HasValue)) // Allow if admin or any authenticated user for now
                {
                    await Groups.AddToGroupAsync(Context.ConnectionId, "admins");
                    _logger.LogInformation("Admin {UserId} ({UserName}) joined admin group with connection {ConnectionId}",
                        userId, userName, Context.ConnectionId);
                }
                else
                {
                    _logger.LogWarning("Non-admin user attempted to join admin group: IsAuthenticated={IsAuthenticated}, UserId={UserId}, ConnectionId={ConnectionId}",
                        isAuthenticated, userId, Context.ConnectionId);
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error joining admin group for connection {ConnectionId}", Context.ConnectionId);
            }
        }

        /// <summary>
        /// Admin leaves admin group
        /// </summary>
        public async Task LeaveAdminGroup()
        {
            try
            {
                await Groups.RemoveFromGroupAsync(Context.ConnectionId, "admins");
                var userId = GetCurrentUserId();
                var userName = GetCurrentUserName();
                _logger.LogInformation("Admin {UserId} ({UserName}) left admin group with connection {ConnectionId}",
                    userId, userName, Context.ConnectionId);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error leaving admin group for connection {ConnectionId}", Context.ConnectionId);
            }
        }

        /// <summary>
        /// Send typing indicator
        /// </summary>
        public async Task SendTypingIndicator(string sessionId, bool isTyping)
        {
            try
            {
                var userId = GetCurrentUserId();
                var userName = GetCurrentUserName();

                await Clients.GroupExcept($"session_{sessionId}", Context.ConnectionId)
                    .SendAsync("TypingIndicator", new
                    {
                        SessionId = sessionId,
                        UserId = userId,
                        UserName = userName,
                        IsTyping = isTyping,
                        Timestamp = DateTime.UtcNow
                    });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error sending typing indicator for session {SessionId}", sessionId);
            }
        }

        /// <summary>
        /// Mark messages as read
        /// </summary>
        public async Task MarkMessagesAsRead(string sessionId, int lastMessageId)
        {
            try
            {
                // Here you could update message read status in database
                await Clients.Group($"session_{sessionId}")
                    .SendAsync("MessagesRead", new
                    {
                        SessionId = sessionId,
                        LastMessageId = lastMessageId,
                        ReadBy = GetCurrentUserId(),
                        ReadAt = DateTime.UtcNow
                    });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error marking messages as read for session {SessionId}", sessionId);
            }
        }

        /// <summary>
        /// Quick action from suggested actions
        /// </summary>
        public async Task ExecuteQuickAction(string sessionId, string action, object? data = null)
        {
            try
            {
                var userId = GetCurrentUserId();

                await Clients.Group($"session_{sessionId}")
                    .SendAsync("QuickActionExecuted", new
                    {
                        SessionId = sessionId,
                        Action = action,
                        Data = data,
                        ExecutedBy = userId,
                        ExecutedAt = DateTime.UtcNow
                    });

                _logger.LogInformation("Quick action {Action} executed in session {SessionId}", action, sessionId);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error executing quick action {Action} for session {SessionId}", action, sessionId);
            }
        }

        public override async Task OnConnectedAsync()
        {
            try
            {
                var userId = GetCurrentUserId();
                var userName = GetCurrentUserName();
                var isAdmin = Context.User?.IsInRole("Admin") == true;
                var isAuthenticated = Context.User?.Identity?.IsAuthenticated == true;

                _logger.LogInformation("User connected: UserId={UserId}, UserName={UserName}, IsAdmin={IsAdmin}, IsAuthenticated={IsAuthenticated}, ConnectionId={ConnectionId}",
                    userId, userName, isAdmin, isAuthenticated, Context.ConnectionId);

                // Auto-join user to their personal group for receiving messages
                if (userId.HasValue)
                {
                    await Groups.AddToGroupAsync(Context.ConnectionId, $"user_{userId.Value}");
                    _logger.LogInformation("User {UserId} auto-joined to user_{UserId} group", userId.Value, userId.Value);
                }

                // Auto-join admins to admin group if they are authenticated as admin
                if (isAdmin && isAuthenticated)
                {
                    await Groups.AddToGroupAsync(Context.ConnectionId, "admins");
                    _logger.LogInformation("Admin {UserId} ({UserName}) auto-joined admin group with connection {ConnectionId}",
                        userId, userName, Context.ConnectionId);
                }

                await base.OnConnectedAsync();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error in OnConnectedAsync for connection {ConnectionId}", Context.ConnectionId);
            }
        }

        public override async Task OnDisconnectedAsync(Exception? exception)
        {
            try
            {
                var userId = GetCurrentUserId();
                var isAdmin = Context.User?.IsInRole("Admin") == true;

                _logger.LogInformation("User {UserId} disconnected from connection {ConnectionId}", userId, Context.ConnectionId);

                // Auto-cleanup: remove from user group
                if (userId.HasValue)
                {
                    await Groups.RemoveFromGroupAsync(Context.ConnectionId, $"user_{userId.Value}");
                    _logger.LogInformation("User {UserId} removed from user_{UserId} group on disconnect", userId.Value, userId.Value);
                }

                // Auto-cleanup: remove from admin group if was admin
                if (isAdmin)
                {
                    await Groups.RemoveFromGroupAsync(Context.ConnectionId, "admins");
                    _logger.LogInformation("Admin {UserId} removed from admin group on disconnect", userId);
                }

                if (exception != null)
                {
                    _logger.LogError(exception, "User disconnected with error");
                }

                await base.OnDisconnectedAsync(exception);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error in OnDisconnectedAsync");
            }
        }

        private int? GetCurrentUserId()
        {
            var userIdClaim = Context.User?.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            return int.TryParse(userIdClaim, out var userId) ? userId : null;
        }

        private string? GetCurrentUserName()
        {
            return Context.User?.FindFirst(ClaimTypes.Name)?.Value ??
                   Context.User?.FindFirst("fullName")?.Value;
        }
    }
}
```

### Middleware\CorsDebugMiddleware.cs
```cs
using Microsoft.AspNetCore.Http;

namespace SHN_Gear.Middleware
{
    public class CorsDebugMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<CorsDebugMiddleware> _logger;

        public CorsDebugMiddleware(RequestDelegate next, ILogger<CorsDebugMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            // Log detailed information about CORS requests
            if (context.Request.Headers.ContainsKey("Origin"))
            {
                var origin = context.Request.Headers["Origin"].ToString();
                var method = context.Request.Method;
                var path = context.Request.Path;
                var userAgent = context.Request.Headers["User-Agent"].ToString();
                
                _logger.LogInformation($"[CORS DEBUG] {method} {path} from origin: {origin}");
                _logger.LogInformation($"[CORS DEBUG] User-Agent: {userAgent}");
                
                // Log all headers for debugging
                var headers = string.Join(", ", context.Request.Headers.Keys);
                _logger.LogInformation($"[CORS DEBUG] All headers: {headers}");
                
                // Check for specific problematic headers
                if (context.Request.Headers.ContainsKey("x-requested-with"))
                {
                    var xRequestedWith = context.Request.Headers["x-requested-with"].ToString();
                    _logger.LogWarning($"[CORS DEBUG] x-requested-with header found: {xRequestedWith}");
                }
            }

            await _next(context);

            // Log response headers
            if (context.Request.Headers.ContainsKey("Origin"))
            {
                var responseHeaders = string.Join(", ", context.Response.Headers.Keys);
                _logger.LogInformation($"[CORS DEBUG] Response headers: {responseHeaders}");
                
                if (context.Response.Headers.ContainsKey("Access-Control-Allow-Origin"))
                {
                    var allowOrigin = context.Response.Headers["Access-Control-Allow-Origin"].ToString();
                    _logger.LogInformation($"[CORS DEBUG] Access-Control-Allow-Origin: {allowOrigin}");
                }
            }
        }
    }
}

```

### Middleware\GlobalCorsMiddleware.cs
```cs
using Microsoft.AspNetCore.Http;

namespace SHN_Gear.Middleware
{
    public class GlobalCorsMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<GlobalCorsMiddleware> _logger;

        private readonly string[] _allowedOrigins = {
            "https://localhost:44479",
            "http://localhost:3000",
            "https://localhost:3001", 
            "https://localhost:7107",
            "http://localhost:5067"
        };

        public GlobalCorsMiddleware(RequestDelegate next, ILogger<GlobalCorsMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var origin = context.Request.Headers["Origin"].ToString();
            var isApiRequest = context.Request.Path.StartsWithSegments("/api");
            var isSignalRRequest = context.Request.Path.StartsWithSegments("/chatHub");
            
            // Log for debugging
            _logger.LogInformation($"[Global CORS] Processing: {context.Request.Method} {context.Request.Path} from {origin}");

            if (!string.IsNullOrEmpty(origin) && _allowedOrigins.Contains(origin))
            {
                // Set CORS headers for all requests
                context.Response.Headers["Access-Control-Allow-Origin"] = origin;
                context.Response.Headers["Access-Control-Allow-Credentials"] = "true";
                
                // Äáº·t headers khÃ¡c nhau cho SignalR vÃ  API thÃ´ng thÆ°á»ng
                if (isSignalRRequest)
                {
                    context.Response.Headers["Access-Control-Allow-Headers"] = 
                        "Content-Type, Authorization, x-requested-with, x-signalr-user-agent, Cache-Control, X-Requested-With, Accept, Origin, User-Agent, DNT, Keep-Alive";
                }
                else
                {
                    context.Response.Headers["Access-Control-Allow-Headers"] = 
                        "Content-Type, Authorization, x-requested-with, Accept, Origin, X-Requested-With";
                }
                
                context.Response.Headers["Access-Control-Allow-Methods"] = "GET, POST, PUT, DELETE, OPTIONS, PATCH, HEAD";
                context.Response.Headers["Access-Control-Max-Age"] = "86400"; // 24 hours
                
                _logger.LogInformation($"[Global CORS] Set headers for origin: {origin}");
            }

            // Handle preflight requests
            if (context.Request.Method == "OPTIONS")
            {
                _logger.LogInformation("[Global CORS] Handling OPTIONS preflight request");
                context.Response.StatusCode = 200;
                return;
            }

            await _next(context);
        }
    }
}

```

### Middleware\HeaderLoggingMiddleware.cs
```cs
using Microsoft.AspNetCore.Http;

namespace SHN_Gear.Middleware
{
    public class HeaderLoggingMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<HeaderLoggingMiddleware> _logger;

        public HeaderLoggingMiddleware(RequestDelegate next, ILogger<HeaderLoggingMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            // Only log SignalR related requests for debugging
            if (context.Request.Path.StartsWithSegments("/chatHub"))
            {
                _logger.LogInformation($"[Header Logging] Request: {context.Request.Method} {context.Request.Path}");
                _logger.LogInformation($"[Header Logging] Query: {context.Request.QueryString}");
                
                // Log all request headers
                foreach (var header in context.Request.Headers)
                {
                    _logger.LogInformation($"[Header Logging] Request Header: {header.Key} = {header.Value}");
                }
            }

            await _next(context);

            // Log response headers for SignalR requests
            if (context.Request.Path.StartsWithSegments("/chatHub"))
            {
                _logger.LogInformation($"[Header Logging] Response Status: {context.Response.StatusCode}");
                
                foreach (var header in context.Response.Headers)
                {
                    _logger.LogInformation($"[Header Logging] Response Header: {header.Key} = {header.Value}");
                }
            }
        }
    }
}

```

### Middleware\SignalRCorsMiddleware.cs
```cs
using Microsoft.AspNetCore.Http;

namespace SHN_Gear.Middleware
{
    public class SignalRCorsMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<SignalRCorsMiddleware> _logger;

        private readonly string[] _allowedOrigins = {
            "https://localhost:44479",
            "http://localhost:3000",
            "https://localhost:3001", 
            "https://localhost:7107",
            "http://localhost:5067"
        };

        public SignalRCorsMiddleware(RequestDelegate next, ILogger<SignalRCorsMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            // Chá»‰ xá»­ lÃ½ requests Ä‘áº¿n SignalR Hub
            if (context.Request.Path.StartsWithSegments("/chatHub"))
            {
                var origin = context.Request.Headers["Origin"].ToString();
                
                _logger.LogInformation($"[SignalR CORS] Processing request: {context.Request.Method} {context.Request.Path} from {origin}");

                if (!string.IsNullOrEmpty(origin) && _allowedOrigins.Contains(origin))
                {
                    // Äáº·t headers CORS cho SignalR vá»›i táº¥t cáº£ headers cáº§n thiáº¿t
                    context.Response.Headers["Access-Control-Allow-Origin"] = origin;
                    context.Response.Headers["Access-Control-Allow-Credentials"] = "true";
                    context.Response.Headers["Access-Control-Allow-Headers"] = 
                        "Content-Type, Authorization, x-requested-with, x-signalr-user-agent, Cache-Control, X-Requested-With, Accept, Origin, User-Agent, DNT, Keep-Alive, X-Mx-ReqToken, X-CSRF-Token";
                    context.Response.Headers["Access-Control-Allow-Methods"] = "GET, POST, PUT, DELETE, OPTIONS, HEAD, PATCH";
                    context.Response.Headers["Access-Control-Max-Age"] = "86400"; // 24 hours
                    
                    _logger.LogInformation($"[SignalR CORS] Headers set for origin: {origin}");
                }
                else if (!string.IsNullOrEmpty(origin))
                {
                    _logger.LogWarning($"[SignalR CORS] Origin not allowed: {origin}");
                }

                // Xá»­ lÃ½ preflight requests
                if (context.Request.Method == "OPTIONS")
                {
                    _logger.LogInformation("[SignalR CORS] Handling OPTIONS preflight request");
                    context.Response.StatusCode = 200;
                    return;
                }
            }

            await _next(context);
        }
    }
}

```

### Middleware\SignalRNegotiationCorsMiddleware.cs
```cs
using Microsoft.AspNetCore.Http;

namespace SHN_Gear.Middleware
{
    public class SignalRNegotiationCorsMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<SignalRNegotiationCorsMiddleware> _logger;

        private readonly string[] _allowedOrigins = {
            "https://localhost:44479",
            "http://localhost:3000",
            "https://localhost:3001", 
            "https://localhost:7107",
            "http://localhost:5067"
        };

        public SignalRNegotiationCorsMiddleware(RequestDelegate next, ILogger<SignalRNegotiationCorsMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            // Chá»‰ xá»­ lÃ½ SignalR negotiation requests
            if (context.Request.Path.StartsWithSegments("/chatHub/negotiate") || 
                context.Request.Path.StartsWithSegments("/chatHub"))
            {
                var origin = context.Request.Headers["Origin"].ToString();
                
                _logger.LogInformation($"[SignalR Negotiation CORS] Processing: {context.Request.Method} {context.Request.Path} from {origin}");

                // Always set CORS headers for SignalR requests, regardless of origin validation
                if (!string.IsNullOrEmpty(origin))
                {
                    context.Response.Headers["Access-Control-Allow-Origin"] = origin;
                    context.Response.Headers["Access-Control-Allow-Credentials"] = "true";
                    // Cannot use wildcard (*) with credentials, must explicitly list headers
                    context.Response.Headers["Access-Control-Allow-Headers"] = 
                        "Content-Type, Authorization, x-requested-with, x-signalr-user-agent, Cache-Control, X-Requested-With, Accept, Origin, User-Agent, DNT, Keep-Alive, X-Mx-ReqToken, X-CSRF-Token, x-signalr-connection-id";
                    context.Response.Headers["Access-Control-Allow-Methods"] = "GET, POST, PUT, DELETE, OPTIONS, HEAD, PATCH";
                    context.Response.Headers["Access-Control-Max-Age"] = "86400";
                    
                    _logger.LogInformation($"[SignalR Negotiation CORS] Set explicit headers for origin: {origin}");
                }

                // Handle preflight requests immediately
                if (context.Request.Method == "OPTIONS")
                {
                    _logger.LogInformation("[SignalR Negotiation CORS] Handling OPTIONS preflight - returning 200");
                    context.Response.StatusCode = 200; // OK instead of 204
                    return; // Don't write anything to response body
                }
            }

            await _next(context);
        }
    }
}

```

### Middleware\SimpleRateLimitMiddleware.cs
```cs
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Caching.Memory;
using System;
using System.Threading.Tasks;

namespace SHN_Gear.Middleware
{
    public class SimpleRateLimitMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly IMemoryCache _cache;
        private readonly int _limit;
        private readonly TimeSpan _period;

        public SimpleRateLimitMiddleware(RequestDelegate next, IMemoryCache cache, int limit = 10, int seconds = 60)
        {
            _next = next;
            _cache = cache;
            _limit = limit;
            _period = TimeSpan.FromSeconds(seconds);
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var path = context.Request.Path.Value?.ToLower() ?? "";
            if (path.Contains("/api/chat") || path.Contains("/api/gemini"))
            {
                var ip = context.Connection.RemoteIpAddress?.ToString() ?? "unknown";
                var key = $"rl:{ip}";
                var count = _cache.GetOrCreate(key, entry =>
                {
                    entry.AbsoluteExpirationRelativeToNow = _period;
                    return 0;
                });
                if (count >= _limit)
                {
                    context.Response.StatusCode = 429;
                    await context.Response.WriteAsync("Rate limit exceeded. Please try again later.");
                    return;
                }
                _cache.Set(key, count + 1, _period);
            }
            await _next(context);
        }
    }
}

```

### Middleware\UnifiedCorsMiddleware.cs
```cs
using Microsoft.AspNetCore.Http;

namespace SHN_Gear.Middleware
{
    public class UnifiedCorsMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<UnifiedCorsMiddleware> _logger;

        private readonly string[] _allowedOrigins = {
            "https://localhost:44479",
            "http://localhost:3000",
            "https://localhost:3001", 
            "https://localhost:7107",
            "http://localhost:5067"
        };

        // Comprehensive headers list for all scenarios
        private readonly string _allHeaders = 
            "Content-Type, Authorization, x-requested-with, x-signalr-user-agent, Cache-Control, " +
            "X-Requested-With, Accept, Origin, User-Agent, DNT, Keep-Alive, X-Mx-ReqToken, " +
            "X-CSRF-Token, x-signalr-connection-id, x-signalr-negotiateversion";

        public UnifiedCorsMiddleware(RequestDelegate next, ILogger<UnifiedCorsMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var origin = context.Request.Headers["Origin"].ToString();
            
            // Only process if there's an origin header
            if (!string.IsNullOrEmpty(origin))
            {
                _logger.LogInformation($"[Unified CORS] Processing: {context.Request.Method} {context.Request.Path} from {origin}");

                // Check if origin is allowed
                if (_allowedOrigins.Contains(origin))
                {
                    // Set comprehensive CORS headers
                    context.Response.Headers["Access-Control-Allow-Origin"] = origin;
                    context.Response.Headers["Access-Control-Allow-Credentials"] = "true";
                    context.Response.Headers["Access-Control-Allow-Headers"] = _allHeaders;
                    context.Response.Headers["Access-Control-Allow-Methods"] = "GET, POST, PUT, DELETE, OPTIONS, HEAD, PATCH";
                    context.Response.Headers["Access-Control-Max-Age"] = "86400";
                    
                    _logger.LogInformation($"[Unified CORS] Set headers for origin: {origin}");
                }
                else
                {
                    _logger.LogWarning($"[Unified CORS] Origin not allowed: {origin}");
                }

                // Handle preflight requests
                if (context.Request.Method == "OPTIONS")
                {
                    _logger.LogInformation("[Unified CORS] Handling OPTIONS preflight request");
                    context.Response.StatusCode = 200;
                    return;
                }
            }

            await _next(context);
        }
    }
}

```

### Migrations\AppDbContextModelSnapshot.cs
```cs
ï»¿// <auto-generated />
using System;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Metadata;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using SHN_Gear.Data;

#nullable disable

namespace SHN_Gear.Migrations
{
    [DbContext(typeof(AppDbContext))]
    partial class AppDbContextModelSnapshot : ModelSnapshot
    {
        protected override void BuildModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "9.0.2")
                .HasAnnotation("Relational:MaxIdentifierLength", 128);

            SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);

            modelBuilder.Entity("SHN_Gear.Models.AIKnowledgeBase", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("Answer")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("BrandIds")
                        .HasColumnType("nvarchar(max)");

                    b.Property<int>("Category")
                        .HasColumnType("int");

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<decimal>("EscalationThreshold")
                        .HasPrecision(5, 3)
                        .HasColumnType("decimal(5,3)");

                    b.Property<bool>("IsActive")
                        .HasColumnType("bit");

                    b.PrimitiveCollection<string>("Keywords")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<decimal>("MinConfidenceScore")
                        .HasPrecision(5, 3)
                        .HasColumnType("decimal(5,3)");

                    b.Property<int>("Priority")
                        .HasColumnType("int");

                    b.Property<string>("ProductCategoryIds")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Question")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("RequiresLogin")
                        .HasColumnType("bit");

                    b.Property<string>("Topic")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<DateTime>("UpdatedAt")
                        .HasColumnType("datetime2");

                    b.HasKey("Id");

                    b.ToTable("AIKnowledgeBases");
                });

            modelBuilder.Entity("SHN_Gear.Models.Address", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("AddressLine1")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("AddressLine2")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("City")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Country")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("FullName")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PhoneNumber")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("State")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<int?>("UserId")
                        .HasColumnType("int");

                    b.Property<string>("ZipCode")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("Addresses");
                });

            modelBuilder.Entity("SHN_Gear.Models.BlogPost", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<int>("AuthorId")
                        .HasColumnType("int");

                    b.Property<string>("Content")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<bool>("IsPublished")
                        .HasColumnType("bit");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasMaxLength(250)
                        .HasColumnType("nvarchar(250)");

                    b.Property<DateTime>("UpdatedAt")
                        .HasColumnType("datetime2");

                    b.HasKey("Id");

                    b.HasIndex("AuthorId");

                    b.ToTable("BlogPosts");
                });

            modelBuilder.Entity("SHN_Gear.Models.Brand", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("Description")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Logo")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.HasKey("Id");

                    b.ToTable("Brands");
                });

            modelBuilder.Entity("SHN_Gear.Models.Cart", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<DateTime>("UpdatedAt")
                        .HasColumnType("datetime2");

                    b.Property<int>("UserId")
                        .HasColumnType("int");

                    b.HasKey("Id");

                    b.ToTable("Carts");
                });

            modelBuilder.Entity("SHN_Gear.Models.CartItem", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<DateTime>("AddedAt")
                        .HasColumnType("datetime2");

                    b.Property<int>("CartId")
                        .HasColumnType("int");

                    b.Property<int>("ProductVariantId")
                        .HasColumnType("int");

                    b.Property<int>("Quantity")
                        .HasColumnType("int");

                    b.Property<DateTime>("UpdatedAt")
                        .HasColumnType("datetime2");

                    b.HasKey("Id");

                    b.HasIndex("CartId");

                    b.HasIndex("ProductVariantId");

                    b.ToTable("CartItems");
                });

            modelBuilder.Entity("SHN_Gear.Models.Category", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("Description")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Image")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.HasKey("Id");

                    b.ToTable("Categories");
                });

            modelBuilder.Entity("SHN_Gear.Models.ChatMessage", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<decimal?>("AIConfidenceScore")
                        .HasPrecision(5, 3)
                        .HasColumnType("decimal(5,3)");

                    b.Property<string>("AIContext")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("AIIntent")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("AttachmentsJson")
                        .HasColumnType("nvarchar(max)");

                    b.Property<int>("ChatSessionId")
                        .HasColumnType("int");

                    b.Property<string>("Content")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("IsRead")
                        .HasColumnType("bit");

                    b.Property<string>("MetadataJson")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("RequiresEscalation")
                        .HasColumnType("bit");

                    b.Property<int>("Sender")
                        .HasColumnType("int");

                    b.Property<int?>("SenderId")
                        .HasColumnType("int");

                    b.Property<DateTime>("SentAt")
                        .HasColumnType("datetime2");

                    b.Property<string>("SuggestedActionsJson")
                        .HasColumnType("nvarchar(max)");

                    b.Property<int>("Type")
                        .HasColumnType("int");

                    b.HasKey("Id");

                    b.HasIndex("ChatSessionId");

                    b.HasIndex("SenderId");

                    b.ToTable("ChatMessages");
                });

            modelBuilder.Entity("SHN_Gear.Models.ChatSession", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<int?>("AssignedAdminId")
                        .HasColumnType("int");

                    b.Property<decimal?>("ConfidenceScore")
                        .HasPrecision(5, 3)
                        .HasColumnType("decimal(5,3)");

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<string>("GuestEmail")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("GuestName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<DateTime>("LastActivityAt")
                        .HasColumnType("datetime2");

                    b.Property<bool>("RequiresHumanSupport")
                        .HasColumnType("bit");

                    b.Property<string>("SessionId")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<int>("Status")
                        .HasColumnType("int");

                    b.Property<int>("Type")
                        .HasColumnType("int");

                    b.Property<string>("UserContext")
                        .HasColumnType("nvarchar(max)");

                    b.Property<int?>("UserId")
                        .HasColumnType("int");

                    b.HasKey("Id");

                    b.HasIndex("AssignedAdminId");

                    b.HasIndex("UserId");

                    b.ToTable("ChatSessions");
                });

            modelBuilder.Entity("SHN_Gear.Models.Delivery", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<DateTime?>("DeliveryDate")
                        .HasColumnType("datetime2");

                    b.Property<int>("OrderId")
                        .HasColumnType("int");

                    b.Property<decimal>("ShippingCost")
                        .HasColumnType("decimal(18, 2)");

                    b.Property<string>("ShippingMethod")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("TrackingNumber")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.HasKey("Id");

                    b.HasIndex("OrderId");

                    b.ToTable("Deliveries");
                });

            modelBuilder.Entity("SHN_Gear.Models.HomepageConfig", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ConfigJson")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<DateTime>("LastUpdated")
                        .HasColumnType("datetime2");

                    b.Property<string>("UpdatedBy")
                        .HasColumnType("nvarchar(max)");

                    b.HasKey("Id");

                    b.ToTable("HomepageConfigurations");
                });

            modelBuilder.Entity("SHN_Gear.Models.Order", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<int?>("AddressId")
                        .HasColumnType("int");

                    b.Property<string>("MoMoOrderId")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("MoMoPayUrl")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("MoMoRequestId")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("MoMoResponse")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("MoMoTransId")
                        .HasColumnType("nvarchar(max)");

                    b.Property<DateTime>("OrderDate")
                        .HasColumnType("datetime2");

                    b.Property<string>("OrderStatus")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PayPalOrderId")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PayPalPaymentUrl")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PayPalResponse")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PayPalTransactionId")
                        .HasColumnType("nvarchar(max)");

                    b.Property<int>("PaymentMethodId")
                        .HasColumnType("int");

                    b.Property<decimal>("TotalAmount")
                        .HasColumnType("decimal(18, 2)");

                    b.Property<int?>("UserId")
                        .HasColumnType("int");

                    b.Property<int?>("VoucherId")
                        .HasColumnType("int");

                    b.HasKey("Id");

                    b.HasIndex("AddressId");

                    b.HasIndex("PaymentMethodId");

                    b.HasIndex("UserId");

                    b.HasIndex("VoucherId");

                    b.ToTable("Orders");
                });

            modelBuilder.Entity("SHN_Gear.Models.OrderItem", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<int>("OrderId")
                        .HasColumnType("int");

                    b.Property<decimal>("Price")
                        .HasColumnType("decimal(18, 2)");

                    b.Property<int>("ProductVariantId")
                        .HasColumnType("int");

                    b.Property<int>("Quantity")
                        .HasColumnType("int");

                    b.HasKey("Id");

                    b.HasIndex("OrderId");

                    b.HasIndex("ProductVariantId");

                    b.ToTable("OrderItems");
                });

            modelBuilder.Entity("SHN_Gear.Models.PaymentMethod", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("Description")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.HasKey("Id");

                    b.ToTable("PaymentMethods");

                    b.HasData(
                        new
                        {
                            Id = 1,
                            Description = "Thanh toÃ¡n báº±ng tiá»n máº·t",
                            Name = "Tiá»n Máº·t"
                        },
                        new
                        {
                            Id = 2,
                            Description = "Thanh toÃ¡n báº±ng Momo",
                            Name = "MoMo"
                        },
                        new
                        {
                            Id = 3,
                            Description = "Thanh toÃ¡n báº±ng vÃ­ Paypal",
                            Name = "Paypal"
                        });
                });

            modelBuilder.Entity("SHN_Gear.Models.Product", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<int>("BrandId")
                        .HasColumnType("int");

                    b.Property<int>("CategoryId")
                        .HasColumnType("int");

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<string>("Description")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<DateTime?>("FlashSaleEndDate")
                        .HasColumnType("datetime2");

                    b.Property<decimal?>("FlashSalePrice")
                        .HasColumnType("decimal(18,2)");

                    b.Property<DateTime?>("FlashSaleStartDate")
                        .HasColumnType("datetime2");

                    b.Property<bool>("IsBestSeller")
                        .HasColumnType("bit");

                    b.Property<bool>("IsFlashSale")
                        .HasColumnType("bit");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.HasKey("Id");

                    b.HasIndex("BrandId")
                        .HasDatabaseName("IX_Products_BrandId");

                    b.HasIndex("CategoryId")
                        .HasDatabaseName("IX_Products_CategoryId");

                    b.HasIndex("IsFlashSale")
                        .HasDatabaseName("IX_Products_IsFlashSale");

                    b.ToTable("Products");
                });

            modelBuilder.Entity("SHN_Gear.Models.ProductImage", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ImageUrl")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("IsPrimary")
                        .HasColumnType("bit");

                    b.Property<int>("ProductId")
                        .HasColumnType("int");

                    b.HasKey("Id");

                    b.HasIndex("ProductId");

                    b.ToTable("ProductImages");
                });

            modelBuilder.Entity("SHN_Gear.Models.ProductSpecification", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<int>("DisplayOrder")
                        .HasColumnType("int");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasMaxLength(100)
                        .HasColumnType("nvarchar(100)");

                    b.Property<int>("ProductId")
                        .HasColumnType("int");

                    b.Property<string>("Unit")
                        .HasMaxLength(20)
                        .HasColumnType("nvarchar(20)");

                    b.Property<string>("Value")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("nvarchar(500)");

                    b.HasKey("Id");

                    b.HasIndex("ProductId");

                    b.ToTable("ProductSpecifications");
                });

            modelBuilder.Entity("SHN_Gear.Models.ProductVariant", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("Color")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<decimal?>("DiscountPrice")
                        .HasPrecision(18, 2)
                        .HasColumnType("decimal(18,2)");

                    b.Property<DateTime?>("FlashSaleEnd")
                        .HasColumnType("datetime2");

                    b.Property<DateTime?>("FlashSaleStart")
                        .HasColumnType("datetime2");

                    b.Property<decimal>("Price")
                        .HasColumnType("decimal(18,2)");

                    b.Property<int>("ProductId")
                        .HasColumnType("int");

                    b.Property<int>("StockQuantity")
                        .HasColumnType("int");

                    b.Property<string>("Storage")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.HasKey("Id");

                    b.HasIndex("Price")
                        .HasDatabaseName("IX_ProductVariants_Price");

                    b.HasIndex("ProductId")
                        .HasDatabaseName("IX_ProductVariants_ProductId");

                    b.ToTable("ProductVariants");
                });

            modelBuilder.Entity("SHN_Gear.Models.Review", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("Comment")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<bool>("IsApproved")
                        .HasColumnType("bit");

                    b.Property<int>("ProductId")
                        .HasColumnType("int");

                    b.Property<int>("Rating")
                        .HasColumnType("int");

                    b.Property<int>("UserId")
                        .HasColumnType("int");

                    b.HasKey("Id");

                    b.HasIndex("ProductId");

                    b.HasIndex("UserId");

                    b.ToTable("Reviews");
                });

            modelBuilder.Entity("SHN_Gear.Models.Role", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.HasKey("Id");

                    b.ToTable("Roles");

                    b.HasData(
                        new
                        {
                            Id = 1,
                            Name = "Admin"
                        },
                        new
                        {
                            Id = 2,
                            Name = "VIP 1"
                        },
                        new
                        {
                            Id = 3,
                            Name = "VIP 2"
                        },
                        new
                        {
                            Id = 4,
                            Name = "VIP 3"
                        });
                });

            modelBuilder.Entity("SHN_Gear.Models.User", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("AvatarUrl")
                        .HasColumnType("nvarchar(max)");

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("datetime2");

                    b.Property<DateTime?>("DateOfBirth")
                        .HasColumnType("datetime2");

                    b.Property<string>("Email")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("FullName")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Gender")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("IsActive")
                        .HasColumnType("bit");

                    b.Property<string>("OtpCode")
                        .HasColumnType("nvarchar(max)");

                    b.Property<DateTime?>("OtpExpiry")
                        .HasColumnType("datetime2");

                    b.Property<string>("Password")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PhoneNumber")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.Property<int>("Points")
                        .HasColumnType("int");

                    b.Property<int>("RoleId")
                        .HasColumnType("int");

                    b.HasKey("Id");

                    b.HasIndex("PhoneNumber")
                        .IsUnique();

                    b.HasIndex("RoleId");

                    b.ToTable("Users");
                });

            modelBuilder.Entity("SHN_Gear.Models.UserVoucher", b =>
                {
                    b.Property<int>("UserId")
                        .HasColumnType("int");

                    b.Property<int>("VoucherId")
                        .HasColumnType("int");

                    b.Property<bool>("IsUsed")
                        .HasColumnType("bit");

                    b.Property<DateTime>("UsedAt")
                        .HasColumnType("datetime2");

                    b.HasKey("UserId", "VoucherId");

                    b.HasIndex("VoucherId");

                    b.ToTable("UserVouchers");
                });

            modelBuilder.Entity("SHN_Gear.Models.Voucher", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("Code")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<decimal>("DiscountAmount")
                        .HasColumnType("decimal(18, 2)");

                    b.Property<DateTime>("ExpiryDate")
                        .HasColumnType("datetime2");

                    b.Property<bool>("IsActive")
                        .HasColumnType("bit");

                    b.HasKey("Id");

                    b.ToTable("Vouchers");
                });

            modelBuilder.Entity("SHN_Gear.Models.Address", b =>
                {
                    b.HasOne("SHN_Gear.Models.User", "User")
                        .WithMany()
                        .HasForeignKey("UserId");

                    b.Navigation("User");
                });

            modelBuilder.Entity("SHN_Gear.Models.BlogPost", b =>
                {
                    b.HasOne("SHN_Gear.Models.User", "Author")
                        .WithMany()
                        .HasForeignKey("AuthorId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Author");
                });

            modelBuilder.Entity("SHN_Gear.Models.CartItem", b =>
                {
                    b.HasOne("SHN_Gear.Models.Cart", "Cart")
                        .WithMany("Items")
                        .HasForeignKey("CartId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("SHN_Gear.Models.ProductVariant", "ProductVariant")
                        .WithMany()
                        .HasForeignKey("ProductVariantId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Cart");

                    b.Navigation("ProductVariant");
                });

            modelBuilder.Entity("SHN_Gear.Models.ChatMessage", b =>
                {
                    b.HasOne("SHN_Gear.Models.ChatSession", "ChatSession")
                        .WithMany("Messages")
                        .HasForeignKey("ChatSessionId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("SHN_Gear.Models.User", "SenderUser")
                        .WithMany()
                        .HasForeignKey("SenderId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.Navigation("ChatSession");

                    b.Navigation("SenderUser");
                });

            modelBuilder.Entity("SHN_Gear.Models.ChatSession", b =>
                {
                    b.HasOne("SHN_Gear.Models.User", "AssignedAdmin")
                        .WithMany()
                        .HasForeignKey("AssignedAdminId");

                    b.HasOne("SHN_Gear.Models.User", "User")
                        .WithMany()
                        .HasForeignKey("UserId");

                    b.Navigation("AssignedAdmin");

                    b.Navigation("User");
                });

            modelBuilder.Entity("SHN_Gear.Models.Delivery", b =>
                {
                    b.HasOne("SHN_Gear.Models.Order", "Order")
                        .WithMany()
                        .HasForeignKey("OrderId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Order");
                });

            modelBuilder.Entity("SHN_Gear.Models.Order", b =>
                {
                    b.HasOne("SHN_Gear.Models.Address", "Address")
                        .WithMany()
                        .HasForeignKey("AddressId");

                    b.HasOne("SHN_Gear.Models.PaymentMethod", "PaymentMethod")
                        .WithMany()
                        .HasForeignKey("PaymentMethodId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("SHN_Gear.Models.User", "User")
                        .WithMany()
                        .HasForeignKey("UserId");

                    b.HasOne("SHN_Gear.Models.Voucher", "Voucher")
                        .WithMany()
                        .HasForeignKey("VoucherId");

                    b.Navigation("Address");

                    b.Navigation("PaymentMethod");

                    b.Navigation("User");

                    b.Navigation("Voucher");
                });

            modelBuilder.Entity("SHN_Gear.Models.OrderItem", b =>
                {
                    b.HasOne("SHN_Gear.Models.Order", "Order")
                        .WithMany("OrderItems")
                        .HasForeignKey("OrderId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("SHN_Gear.Models.ProductVariant", "ProductVariant")
                        .WithMany()
                        .HasForeignKey("ProductVariantId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Order");

                    b.Navigation("ProductVariant");
                });

            modelBuilder.Entity("SHN_Gear.Models.Product", b =>
                {
                    b.HasOne("SHN_Gear.Models.Brand", "Brand")
                        .WithMany("Products")
                        .HasForeignKey("BrandId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("SHN_Gear.Models.Category", "Category")
                        .WithMany("Products")
                        .HasForeignKey("CategoryId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Brand");

                    b.Navigation("Category");
                });

            modelBuilder.Entity("SHN_Gear.Models.ProductImage", b =>
                {
                    b.HasOne("SHN_Gear.Models.Product", "Product")
                        .WithMany("Images")
                        .HasForeignKey("ProductId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Product");
                });

            modelBuilder.Entity("SHN_Gear.Models.ProductSpecification", b =>
                {
                    b.HasOne("SHN_Gear.Models.Product", "Product")
                        .WithMany("ProductSpecifications")
                        .HasForeignKey("ProductId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Product");
                });

            modelBuilder.Entity("SHN_Gear.Models.ProductVariant", b =>
                {
                    b.HasOne("SHN_Gear.Models.Product", "Product")
                        .WithMany("Variants")
                        .HasForeignKey("ProductId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Product");
                });

            modelBuilder.Entity("SHN_Gear.Models.Review", b =>
                {
                    b.HasOne("SHN_Gear.Models.Product", "Product")
                        .WithMany()
                        .HasForeignKey("ProductId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("SHN_Gear.Models.User", "User")
                        .WithMany("Reviews")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Product");

                    b.Navigation("User");
                });

            modelBuilder.Entity("SHN_Gear.Models.User", b =>
                {
                    b.HasOne("SHN_Gear.Models.Role", "Role")
                        .WithMany("Users")
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Role");
                });

            modelBuilder.Entity("SHN_Gear.Models.UserVoucher", b =>
                {
                    b.HasOne("SHN_Gear.Models.User", "User")
                        .WithMany("UserVouchers")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("SHN_Gear.Models.Voucher", "Voucher")
                        .WithMany("UserVouchers")
                        .HasForeignKey("VoucherId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");

                    b.Navigation("Voucher");
                });

            modelBuilder.Entity("SHN_Gear.Models.Brand", b =>
                {
                    b.Navigation("Products");
                });

            modelBuilder.Entity("SHN_Gear.Models.Cart", b =>
                {
                    b.Navigation("Items");
                });

            modelBuilder.Entity("SHN_Gear.Models.Category", b =>
                {
                    b.Navigation("Products");
                });

            modelBuilder.Entity("SHN_Gear.Models.ChatSession", b =>
                {
                    b.Navigation("Messages");
                });

            modelBuilder.Entity("SHN_Gear.Models.Order", b =>
                {
                    b.Navigation("OrderItems");
                });

            modelBuilder.Entity("SHN_Gear.Models.Product", b =>
                {
                    b.Navigation("Images");

                    b.Navigation("ProductSpecifications");

                    b.Navigation("Variants");
                });

            modelBuilder.Entity("SHN_Gear.Models.Role", b =>
                {
                    b.Navigation("Users");
                });

            modelBuilder.Entity("SHN_Gear.Models.User", b =>
                {
                    b.Navigation("Reviews");

                    b.Navigation("UserVouchers");
                });

            modelBuilder.Entity("SHN_Gear.Models.Voucher", b =>
                {
                    b.Navigation("UserVouchers");
                });
#pragma warning restore 612, 618
        }
    }
}

```

### Models\Address.cs
```cs
namespace SHN_Gear.Models
{
    public class Address
    {
        public int Id { get; set; }
        public int? UserId { get; set; }
        public User? User { get; set; } = null!;
        public string FullName { get; set; } = null!;
        public string PhoneNumber { get; set; } = null!;
        public string AddressLine1 { get; set; } = null!;
        public string AddressLine2 { get; set; } = null!;
        public string City { get; set; } = null!;
        public string State { get; set; } = null!;
        public string ZipCode { get; set; } = null!;
        public string Country { get; set; } = null!;
    }

}

```

### Models\AIKnowledgeBase.cs
```cs
namespace SHN_Gear.Models
{
    public class AIKnowledgeBase
    {
        public int Id { get; set; }
        public string Topic { get; set; } = null!; // Chá»§ Ä‘á»: product_info, policy, shipping, etc.
        public string Question { get; set; } = null!; // CÃ¢u há»i máº«u
        public string Answer { get; set; } = null!; // CÃ¢u tráº£ lá»i
        public string[] Keywords { get; set; } = []; // Keywords Ä‘á»ƒ match
        public KnowledgeCategory Category { get; set; }
        public int Priority { get; set; } = 1; // Äá»™ Æ°u tiÃªn (1-10)
        public bool IsActive { get; set; } = true;
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

        // Context conditions
        public string? ProductCategoryIds { get; set; } // JSON array of category IDs
        public string? BrandIds { get; set; } // JSON array of brand IDs
        public bool RequiresLogin { get; set; } = false; // Cáº§n Ä‘Äƒng nháº­p má»›i tráº£ lá»i

        // Confidence thresholds
        public decimal MinConfidenceScore { get; set; } = 0.7m; // Threshold Ä‘á»ƒ AI tráº£ lá»i
        public decimal EscalationThreshold { get; set; } = 0.4m; // DÆ°á»›i ngÆ°á»¡ng nÃ y sáº½ escalate
    }

    public enum KnowledgeCategory
    {
        ProductInfo,        // ThÃ´ng tin sáº£n pháº©m
        Pricing,           // GiÃ¡ cáº£, khuyáº¿n mÃ£i
        Shipping,          // Váº­n chuyá»ƒn
        Returns,           // Äá»•i tráº£
        Account,           // TÃ i khoáº£n
        Payment,           // Thanh toÃ¡n
        Technical,         // Há»— trá»£ ká»¹ thuáº­t
        General,           // Chung
        Policy             // ChÃ­nh sÃ¡ch
    }
}

```

### Models\BlogPost.cs
```cs
using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace SHN_Gear.Models
{
    public class BlogPost
    {
        [Key]
        public int Id { get; set; }

        [Required]
        [MaxLength(250)]
        public string Title { get; set; }

        [Required]
        public string Content { get; set; } // Store HTML or Markdown content

        public int AuthorId { get; set; } // Assuming a User model exists
        [ForeignKey("AuthorId")]
        public User Author { get; set; }

        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

        public bool IsPublished { get; set; } = false;
    }
}

```

### Models\Brand.cs
```cs
namespace SHN_Gear.Models
{
    public class Brand
    {
        public int Id { get; set; }
        public string Name { get; set; } = null!;
        public string Description { get; set; } = null!;
        public string Logo { get; set; } = null!;

        // Danh sÃ¡ch sáº£n pháº©m thuá»™c Brand nÃ y
        public List<Product> Products { get; set; } = new();
    }
}

```

### Models\Cart.cs
```cs
namespace SHN_Gear.Models
{
    public class Cart
    {
        public int Id { get; set; }
        public int UserId { get; set; } // Id cá»§a ngÆ°á»i dÃ¹ng hoáº·c khÃ¡ch vÃ£ng lai
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow; // Thá»i gian táº¡o giá» hÃ ng
        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow; // Thá»i gian cáº­p nháº­t giá» hÃ ng

        public ICollection<CartItem> Items { get; set; } = new List<CartItem>(); // Danh sÃ¡ch sáº£n pháº©m trong giá» hÃ ng
    }
}
```

### Models\CartItem.cs
```cs
namespace SHN_Gear.Models
{
    public class CartItem
{
    public int Id { get; set; }
    public int CartId { get; set; }
    public Cart Cart { get; set; } = null!;

    public int ProductVariantId { get; set; }  // ğŸ”¹ Thay Ä‘á»•i tá»« ProductId sang ProductVariantId
    public ProductVariant ProductVariant { get; set; } = null!;  // ğŸ”¹ LiÃªn káº¿t Ä‘áº¿n ProductVariant

    public int Quantity { get; set; }
    public DateTime AddedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
}

}
```

### Models\Category.cs
```cs
namespace SHN_Gear.Models
{
    public class Category
    {
        public int Id { get; set; }
        public string Name { get; set; } = null!;
        public string Description { get; set; } = null!;
        public string Image { get; set; } = null!;

        // âœ… ThÃªm danh sÃ¡ch sáº£n pháº©m
        public List<Product> Products { get; set; } = new();
    }
}

```

### Models\ChatMessage.cs
```cs
namespace SHN_Gear.Models
{
    public class ChatMessage
    {
        public int Id { get; set; }
        public int ChatSessionId { get; set; }
        public ChatSession ChatSession { get; set; } = null!;
        public string Content { get; set; } = null!;
        public MessageType Type { get; set; }
        public MessageSender Sender { get; set; }
        public int? SenderId { get; set; } // UserId náº¿u tá»« user hoáº·c admin
        public User? SenderUser { get; set; }
        public DateTime SentAt { get; set; } = DateTime.UtcNow;
        public bool IsRead { get; set; } = false;

        // AI specific fields
        public decimal? AIConfidenceScore { get; set; } // Äá»™ tin cáº­y cá»§a cÃ¢u tráº£ lá»i AI
        public string? AIIntent { get; set; } // Intent mÃ  AI detect Ä‘Æ°á»£c
        public string? AIContext { get; set; } // Context mÃ  AI sá»­ dá»¥ng
        public bool RequiresEscalation { get; set; } = false; // AI khÃ´ng tráº£ lá»i Ä‘Æ°á»£c

        // Rich content support
        public string? AttachmentsJson { get; set; } // JSON cho attachments, images, product links
        public string? SuggestedActionsJson { get; set; } // JSON cho quick replies, buttons

        // Metadata
        public string? MetadataJson { get; set; } // Additional data (product IDs, order IDs, etc.)
    }

    public enum MessageType
    {
        Text,
        Image,
        ProductRecommendation,
        OrderInfo,
        QuickReply,
        SystemMessage,
        EscalationNotice
    }

    public enum MessageSender
    {
        User,
        AI,
        Admin,
        System
    }
}

```

### Models\ChatSession.cs
```cs
namespace SHN_Gear.Models
{
    public class ChatSession
    {
        public int Id { get; set; }
        public int? UserId { get; set; } // Null cho guest users
        public User? User { get; set; }
        public string SessionId { get; set; } = Guid.NewGuid().ToString(); // Unique session ID
        public string? GuestName { get; set; } // TÃªn khÃ¡ch náº¿u khÃ´ng Ä‘Äƒng nháº­p
        public string? GuestEmail { get; set; } // Email khÃ¡ch náº¿u cÃ³

        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        public DateTime LastActivityAt { get; set; } = DateTime.UtcNow;
        public ChatSessionStatus Status { get; set; } = ChatSessionStatus.Active;
        public ChatType Type { get; set; } = ChatType.AI; // AI hoáº·c Admin
        public int? AssignedAdminId { get; set; } // Admin Ä‘Æ°á»£c gÃ¡n
        public User? AssignedAdmin { get; set; }

        // Context Ä‘á»ƒ AI hiá»ƒu vá» user
        public string? UserContext { get; set; } // JSON context vá» user preferences, cart, etc.
        public decimal? ConfidenceScore { get; set; } // Äá»™ tin cáº­y cá»§a AI
        public bool RequiresHumanSupport { get; set; } = false; // Cáº§n chuyá»ƒn sang admin

        public ICollection<ChatMessage> Messages { get; set; } = new List<ChatMessage>();
    }

    public enum ChatSessionStatus
    {
        Active,
        Resolved,
        Escalated, // Chuyá»ƒn lÃªn admin
        Closed
    }

    public enum ChatType
    {
        AI,
        Admin,
        Mixed // Cáº£ AI vÃ  Admin
    }
}

```

### Models\Delivery.cs
```cs
namespace SHN_Gear.Models
{
    public class Delivery
    {
        public int Id { get; set; }
        public int OrderId { get; set; }
        public Order Order { get; set; } = null!;
        public string ShippingMethod { get; set; } = null!;
        public decimal ShippingCost { get; set; }
        public DateTime? DeliveryDate { get; set; }
        public string TrackingNumber { get; set; } = null!;
    }
}

```

### Models\HomepageConfig.cs
```cs
using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace SHN_Gear.Models
{
    public class HomepageConfig
    {
        [Key]
        [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
        public int Id { get; set; }

        [Required]
        public string ConfigJson { get; set; }

        public DateTime LastUpdated { get; set; }

        public string? UpdatedBy { get; set; }
    }
}

```

### Models\Order.cs
```cs
namespace SHN_Gear.Models
{
    public class Order
    {
        public int Id { get; set; }
        public int? UserId { get; set; }
        public User? User { get; set; }
        public DateTime OrderDate { get; set; } = DateTime.UtcNow;
        public decimal TotalAmount { get; set; }
        public string OrderStatus { get; set; } = "Pending";
        public int? AddressId { get; set; }
        public Address? Address { get; set; }
        public int PaymentMethodId { get; set; }
        public PaymentMethod PaymentMethod { get; set; } = null!;
        public ICollection<OrderItem> OrderItems { get; set; } = new List<OrderItem>();
        public int? VoucherId { get; set; }
        public Voucher? Voucher { get; set; }

        // ThÃªm cÃ¡c trÆ°á»ng má»›i cho MoMo
        public string? MoMoRequestId { get; set; } // MÃ£ request tá»« MoMo
        public string? MoMoOrderId { get; set; } // MÃ£ Ä‘Æ¡n hÃ ng gá»­i sang MoMo
        public string? MoMoTransId { get; set; } // MÃ£ giao dá»‹ch tá»« MoMo
        public string? MoMoPayUrl { get; set; } // URL thanh toÃ¡n MoMo
        public string? MoMoResponse { get; set; } // Raw response tá»« MoMo
        // paypal
        public string? PayPalOrderId { get; set; }
        public string? PayPalPaymentUrl { get; set; }
        public string? PayPalTransactionId { get; set; }
        public string? PayPalResponse { get; set; }
    }
}
```

### Models\OrderItem.cs
```cs
namespace SHN_Gear.Models
{
    public class OrderItem
    {
        public int Id { get; set; }
        public int OrderId { get; set; } // KhÃ³a ngoáº¡i tá»›i Order
        public Order Order { get; set; } = null!;
        public int ProductVariantId { get; set; } // KhÃ³a ngoáº¡i tá»›i ProductVariant
        public ProductVariant ProductVariant { get; set; } = null!;
        public int Quantity { get; set; }
        public decimal Price { get; set; } // GiÃ¡ sáº£n pháº©m táº¡i thá»i Ä‘iá»ƒm Ä‘áº·t hÃ ng (cÃ³ thá»ƒ khÃ¡c vá»›i giÃ¡ hiá»‡n táº¡i)
    }
}

```

### Models\PaymentMethod.cs
```cs
namespace SHN_Gear.Models
{
    public class PaymentMethod
    {
        public int Id { get; set; }
        public string Name { get; set; } = null!; // VÃ­ dá»¥: "Cash on Delivery", "Momo"
        public string Description { get; set; } = null!; // MÃ´ táº£ ngáº¯n gá»n vá» phÆ°Æ¡ng thá»©c thanh toÃ¡n
    }
}

```

### Models\ProductImages.cs
```cs
namespace SHN_Gear.Models
{
    public class ProductImage
    {
        public int Id { get; set; }
        public int ProductId { get; set; } // KhÃ³a ngoáº¡i liÃªn káº¿t vá»›i sáº£n pháº©m
        public string ImageUrl { get; set; } = null!;
        public bool IsPrimary { get; set; } // áº¢nh chÃ­nh hay khÃ´ng

        // KhÃ³a ngoáº¡i
        public Product Product { get; set; } = null!;
    }
}

```

### Models\Products.cs
```cs
namespace SHN_Gear.Models
{
    public class Product
    {
        public int Id { get; set; }
        public string Name { get; set; } = null!;
        public string Description { get; set; } = null!;
        public List<ProductImage> Images { get; set; } = new();
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        public int CategoryId { get; set; }
        public Category Category { get; set; } = null!;
        public int BrandId { get; set; } // âœ… ThÃªm BrandId vÃ o model
        public Brand Brand { get; set; } = null!; // âœ… Thiáº¿t láº­p quan há»‡ vá»›i Brand
        public List<ProductVariant> Variants { get; set; } = new();

        // Flash Sale Properties
        public bool IsFlashSale { get; set; } = false;
        public decimal? FlashSalePrice { get; set; } // Nullable decimal
        public DateTime? FlashSaleStartDate { get; set; } // Nullable DateTime
        public DateTime? FlashSaleEndDate { get; set; } // Nullable DateTime

        public bool IsBestSeller { get; set; } = false; // New property for best sellers

        public ICollection<ProductSpecification> ProductSpecifications { get; set; } = new List<ProductSpecification>();

        public bool IsOutOfStock()
        {
            return Variants.Sum(v => v.StockQuantity) <= 0;
        }
    }
}

```

### Models\ProductSpecification.cs
```cs
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace SHN_Gear.Models
{
    [Table("ProductSpecifications")]
    public class ProductSpecification
    {
        [Key]
        public int Id { get; set; }

        [Required]
        public int ProductId { get; set; }

        [Required]
        [StringLength(100)]
        public string Name { get; set; }

        [Required]
        [StringLength(500)]
        public string Value { get; set; }

        [StringLength(20)]
        public string? Unit { get; set; }

        public int DisplayOrder { get; set; } = 0;

        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;        // Navigation property
        [ForeignKey("ProductId")]
        public virtual Product Product { get; set; }
    }
}

```

### Models\ProductVariant.cs
```cs
namespace SHN_Gear.Models
{
    public class ProductVariant
    {
        public int Id { get; set; }
        public int ProductId { get; set; }
        public Product Product { get; set; } = null!;
        public string Color { get; set; } = null!;
        public string Storage { get; set; } = null!;
        public decimal Price { get; set; }
        public decimal? DiscountPrice { get; set; }
        public int StockQuantity { get; set; }

        public DateTime? FlashSaleStart { get; set; }  // âœ… Flash Sale riÃªng cho tá»«ng variant
        public DateTime? FlashSaleEnd { get; set; }
    }
}

```

### Models\Review.cs
```cs
namespace SHN_Gear.Models
{
    public class Review
    {
        public int Id { get; set; }
        public int ProductId { get; set; }
        public Product Product { get; set; }
        public int UserId { get; set; }
        public User User { get; set; }
        public int Rating { get; set; }
        public string Comment { get; set; } = string.Empty;
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        public bool IsApproved { get; set; } = false;
    }
}

```

### Models\Role.cs
```cs
namespace SHN_Gear.Models
{
    public class Role
    {
        public int Id { get; set; }  // Id cá»§a vai trÃ² (Admin, VIP 1, VIP 2,...)
        public string Name { get; set; } = string.Empty;  // TÃªn vai trÃ² (Admin, VIP 1, VIP 2,...)
        
        public ICollection<User> Users { get; set; } = new List<User>(); // Danh sÃ¡ch ngÆ°á»i dÃ¹ng cÃ³ role nÃ y
    }
}

```

### Models\User.cs
```cs
namespace SHN_Gear.Models
{
    public class User
    {
        public int Id { get; set; }
        public string FullName { get; set; } = string.Empty;
        public string PhoneNumber { get; set; } = string.Empty;
        public string? Gender { get; set; }  // CÃ³ thá»ƒ null
        public DateTime? DateOfBirth { get; set; }  // CÃ³ thá»ƒ null
        public string Email { get; set; } = string.Empty;
        public string? AvatarUrl { get; set; }  // CÃ³ thá»ƒ null
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        public int Points { get; set; } = 0;
        public string Password { get; set; } = string.Empty;

        public bool IsActive { get; set; } = true;  // Máº·c Ä‘á»‹nh lÃ  kÃ­ch hoáº¡t

        // OTP Login
        public string? OtpCode { get; set; }  // CÃ³ thá»ƒ null
        public DateTime? OtpExpiry { get; set; }  // CÃ³ thá»ƒ null

        // Quan há»‡ vá»›i Role
        public int RoleId { get; set; }
        public Role Role { get; set; } = null!;

        // Quan há»‡ vá»›i UserVoucher
        public ICollection<UserVoucher> UserVouchers { get; set; } = new List<UserVoucher>();
        public ICollection<Review> Reviews { get; set; } = new List<Review>();

    }

}
```

### Models\UserVoucher.cs
```cs
namespace SHN_Gear.Models
{
    public class UserVoucher
    {
        public int UserId { get; set; }
        public User User { get; set; } = null!;

        public int VoucherId { get; set; }
        public Voucher Voucher { get; set; } = null!;

        public DateTime UsedAt { get; set; } // Thá»i gian nháº­n/gÃ¡n voucher
        public bool IsUsed { get; set; } = true; // Tráº¡ng thÃ¡i sá»­ dá»¥ng
    }
}
```

### Models\Voucher.cs
```cs
namespace SHN_Gear.Models
{
    public class Voucher
    {
        public int Id { get; set; }
        public string Code { get; set; } = null!; // MÃ£ voucher
        public decimal DiscountAmount { get; set; } // Sá»‘ tiá»n giáº£m giÃ¡
        public DateTime ExpiryDate { get; set; } // NgÃ y háº¿t háº¡n
        public bool IsActive { get; set; } = true; // Tráº¡ng thÃ¡i hoáº¡t Ä‘á»™ng cá»§a voucher

        public ICollection<UserVoucher> UserVouchers { get; set; } = new List<UserVoucher>(); // Quan há»‡ vá»›i UserVoucher
    }
}
```

### Pages\Error.cshtml.cs
```cs
using System.Diagnostics;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;

namespace SHN_Gear.Pages;

[ResponseCache(Duration = 0, Location = ResponseCacheLocation.None, NoStore = true)]
public class ErrorModel : PageModel
{
    private readonly ILogger<ErrorModel> _logger;

    public ErrorModel(ILogger<ErrorModel> logger)
    {
        _logger = logger;
    }

    public string? RequestId { get; set; }

    public bool ShowRequestId => !string.IsNullOrEmpty(RequestId);

    public void OnGet()
    {
        RequestId = Activity.Current?.Id ?? HttpContext.TraceIdentifier;
    }
}

```

### Pages\Admin\Blog.cshtml.cs
```cs
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.AspNetCore.Authorization;

namespace SHN_Gear.Pages.Admin
{
    [Authorize(Roles = "Admin")]
    public class BlogModel : PageModel
    {
        public void OnGet()
        {
        }
    }
}

```

### Services\AIService.cs
```cs
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.Models;
using SHN_Gear.DTOs;
using System.Text.Json;
using System.Text.RegularExpressions;

namespace SHN_Gear.Services
{
    public class AIService
    {
        private readonly AppDbContext _context;
        private readonly ILogger<AIService> _logger;
        private readonly ContextManager _contextManager;
        private readonly GeminiService _geminiService;
        private readonly IConfiguration _configuration;

        public AIService(AppDbContext context, ILogger<AIService> logger, ContextManager contextManager, GeminiService geminiService, IConfiguration configuration)
        {
            _context = context;
            _logger = logger;
            _contextManager = contextManager;
            _geminiService = geminiService;
            _configuration = configuration;
        }

        public async Task<AIResponseDto> ProcessMessageAsync(string userMessage, string sessionId, int? userId = null)
        {
            string intent = "general"; // Initialize intent early for catch block access

            try
            {
                // Validate input parameters
                if (string.IsNullOrEmpty(userMessage))
                {
                    _logger.LogError("User message cannot be null or empty");
                    throw new ArgumentException("User message cannot be null or empty", nameof(userMessage));
                }

                if (string.IsNullOrEmpty(sessionId))
                {
                    _logger.LogError("SessionId cannot be null or empty");
                    throw new ArgumentException("SessionId cannot be null or empty", nameof(sessionId));
                }

                // 1. Get conversation context
                var context = await _contextManager.GetOrCreateContextAsync(sessionId, userId);

                // 2. Detect intent vÃ  extract keywords vá»›i context
                intent = DetectIntentWithContext(userMessage, context);
                var keywords = ExtractKeywords(userMessage);
                var entities = ExtractEntities(userMessage, intent);

                // Check if fallback mode is enabled
                var useFallbackMode = _configuration.GetValue<bool>("AIConfig:ChatSettings:FallbackMode", false);
                if (useFallbackMode)
                {
                    _logger.LogInformation("Using fallback mode for AI responses");
                    return CreateIntelligentFallbackResponse(userMessage, intent);
                }

                // 3. TÃ¬m kiáº¿m trong knowledge base
                var knowledgeMatches = await FindKnowledgeMatches(userMessage, keywords, intent);

                // 4. Calculate confidence score
                var confidenceScore = CalculateConfidenceScore(intent, knowledgeMatches, context);

                // 5. Check if should escalate
                if (_contextManager.ShouldEscalate(context, confidenceScore))
                {
                    var escalationResponse = CreateEscalationResponse(context, userMessage);
                    _contextManager.UpdateContextAsync(sessionId, userMessage, intent, entities, escalationResponse.Response);
                    return escalationResponse;
                }

                // 6. Xá»­ lÃ½ theo intent vá»›i context
                AIResponseDto response;
                switch (intent.ToLower())
                {
                    case "product_search":
                        response = await HandleProductSearchWithContext(userMessage, keywords, context);
                        break;
                    case "product_compare":
                        response = await HandleProductSearch(userMessage, keywords);
                        break;
                    case "price_inquiry":
                        response = HandlePriceInquiry(userMessage, keywords);
                        break;
                    case "order_status":
                        response = await HandleOrderStatus(userMessage, userId);
                        break;
                    case "shipping_info":
                        response = HandleShippingInfo(userMessage);
                        break;
                    case "return_policy":
                        response = HandleReturnPolicy(userMessage);
                        break;
                    case "technical_support":
                        response = HandleTechnicalSupport(userMessage, keywords);
                        break;
                    case "greeting":
                        response = HandleGreetingWithContext(context);
                        break;
                    case "thanks":
                        response = HandleThanks();
                        break;
                    default:
                        // Use Gemini AI for general queries
                        response = await HandleWithGeminiAI(userMessage, intent, context, keywords);
                        break;
                }

                // 7. Update confidence score
                response.ConfidenceScore = (decimal)confidenceScore;

                // 8. Add suggested actions with context
                response.SuggestedActions = GenerateSuggestedActionsWithContext(intent, response, context);

                // 9. Update conversation context
                _contextManager.UpdateContextAsync(sessionId, userMessage, intent, entities, response.Response);

                return response;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error processing AI message: {Message}", userMessage);
                // Use intelligent fallback based on detected intent
                return CreateIntelligentFallbackResponse(userMessage, intent);
            }
        }

        private string DetectIntentWithContext(string message, ConversationContext context)
        {
            var basicIntent = DetectIntent(message);

            // Enhance intent detection with context
            if (basicIntent == "general" && context.CurrentState != ConversationState.Discovery)
            {
                // If in middle of conversation, try to infer intent from current state
                return context.CurrentState switch
                {
                    ConversationState.ProductDiscovery => "product_search",
                    ConversationState.PriceNegotiation => "price_inquiry",
                    ConversationState.OrderSupport => "order_status",
                    ConversationState.TechnicalSupport => "technical_support",
                    _ => basicIntent
                };
            }

            return basicIntent;
        }

        private string DetectIntent(string message)
        {
            var lowerMessage = message.ToLower();

            // Product search patterns
            if (Regex.IsMatch(lowerMessage, @"(tÃ¬m|kiáº¿m|xem|cÃ³|bÃ¡n).*?(Ä‘iá»‡n thoáº¡i|laptop|tai nghe|iphone|samsung|macbook)"))
                return "product_search";

            // Product compare patterns  
            if (Regex.IsMatch(lowerMessage, @"(so sÃ¡nh|khÃ¡c nhau|nÃªn chá»n|tá»‘t hÆ¡n)"))
                return "product_compare";

            // Price patterns
            if (Regex.IsMatch(lowerMessage, @"(giÃ¡|bao nhiÃªu|tiá»n|cost|price|khuyáº¿n mÃ£i|giáº£m giÃ¡)"))
                return "price_inquiry";

            // Order patterns
            if (Regex.IsMatch(lowerMessage, @"(Ä‘Æ¡n hÃ ng|order|giao hÃ ng|váº­n chuyá»ƒn|ship)"))
                return "order_status";

            // Shipping patterns
            if (Regex.IsMatch(lowerMessage, @"(giao hÃ ng|váº­n chuyá»ƒn|ship|delivery|khi nÃ o nháº­n)"))
                return "shipping_info";

            // Return patterns
            if (Regex.IsMatch(lowerMessage, @"(Ä‘á»•i tráº£|return|hoÃ n tiá»n|báº£o hÃ nh|warranty)"))
                return "return_policy";

            // Technical patterns
            if (Regex.IsMatch(lowerMessage, @"(lá»—i|bug|khÃ´ng hoáº¡t Ä‘á»™ng|há»ng|sá»­a|fix)"))
                return "technical_support";

            // Greeting patterns
            if (Regex.IsMatch(lowerMessage, @"^(xin chÃ o|hello|hi|chÃ o|háº¿ lÃ´)"))
                return "greeting";

            // Thanks patterns
            if (Regex.IsMatch(lowerMessage, @"(cáº£m Æ¡n|thank|thanks|tks)"))
                return "thanks";

            return "general";
        }

        private List<string> ExtractKeywords(string message)
        {
            var keywords = new List<string>();
            var words = message.ToLower().Split(' ', StringSplitOptions.RemoveEmptyEntries);

            var productKeywords = new[] { "Ä‘iá»‡n thoáº¡i", "phone", "smartphone", "laptop", "mÃ¡y tÃ­nh", "tai nghe", "headphone" };
            var brandKeywords = new[] { "iphone", "samsung", "xiaomi", "oppo", "vivo", "macbook", "dell", "hp", "asus" };
            var featureKeywords = new[] { "camera", "pin", "mÃ n hÃ¬nh", "bá»™ nhá»›", "ram", "ssd", "gaming", "vÄƒn phÃ²ng" };

            foreach (var word in words)
            {
                if (productKeywords.Contains(word) || brandKeywords.Contains(word) || featureKeywords.Contains(word))
                {
                    keywords.Add(word);
                }
            }

            return keywords.Distinct().ToList();
        }

        private async Task<List<AIKnowledgeBase>> FindKnowledgeMatches(string message, List<string> keywords, string intent)
        {
            var matches = new List<AIKnowledgeBase>();

            try
            {
                // TÃ¬m kiáº¿m theo keywords
                var knowledgeItems = await _context.AIKnowledgeBases
                    .Where(k => keywords.Any(kw => k.Keywords.Contains(kw)))
                    .ToListAsync();

                foreach (var item in knowledgeItems)
                {
                    var score = CalculateRelevanceScore(message, item);
                    if (score > (double)item.MinConfidenceScore)
                    {
                        matches.Add(item);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error finding knowledge matches");
            }

            return matches.OrderByDescending(m => CalculateRelevanceScore(message, m)).ToList();
        }

        private double CalculateRelevanceScore(string message, AIKnowledgeBase knowledgeItem)
        {
            var score = 0.0;
            var lowerMessage = message.ToLower();
            var keywords = knowledgeItem.Keywords ?? Array.Empty<string>();

            foreach (var keyword in keywords)
            {
                if (lowerMessage.Contains(keyword.Trim().ToLower()))
                {
                    score += 0.2;
                }
            }

            if (!string.IsNullOrEmpty(knowledgeItem.Question) && lowerMessage.Contains(knowledgeItem.Question.ToLower()))
            {
                score += 0.5;
            }

            return Math.Min(score, 1.0);
        }

        private Dictionary<string, object> ExtractEntities(string message, string intent)
        {
            var entities = new Dictionary<string, object>();
            var lowerMessage = message.ToLower();

            // Extract product categories
            if (Regex.IsMatch(lowerMessage, @"(Ä‘iá»‡n thoáº¡i|phone|smartphone)"))
                entities["product_category"] = "phone";
            else if (Regex.IsMatch(lowerMessage, @"(laptop|mÃ¡y tÃ­nh|computer)"))
                entities["product_category"] = "laptop";
            else if (Regex.IsMatch(lowerMessage, @"(tai nghe|headphone|earphone)"))
                entities["product_category"] = "headphone";

            // Extract brands
            var brands = new[] { "iphone", "samsung", "xiaomi", "oppo", "vivo", "macbook", "dell", "hp", "asus", "sony", "jbl" };
            foreach (var brand in brands)
            {
                if (lowerMessage.Contains(brand))
                {
                    entities["brand"] = brand;
                    break;
                }
            }

            // Extract budget
            var budgetMatch = Regex.Match(lowerMessage, @"(\d+)\s*(triá»‡u|tr|million|k|nghÃ¬n)");
            if (budgetMatch.Success)
            {
                var amount = int.Parse(budgetMatch.Groups[1].Value);
                var unit = budgetMatch.Groups[2].Value.ToLower();

                var budget = unit switch
                {
                    "triá»‡u" or "tr" or "million" => amount * 1000000,
                    "k" or "nghÃ¬n" => amount * 1000,
                    _ => amount
                };

                entities["budget"] = budget;
            }

            // Extract order ID
            var orderMatch = Regex.Match(message, @"#?(\d{4,})");
            if (orderMatch.Success && intent == "order_status")
            {
                entities["order_id"] = orderMatch.Groups[1].Value;
            }

            return entities;
        }

        private double CalculateConfidenceScore(string intent, List<AIKnowledgeBase> knowledgeMatches, ConversationContext context)
        {
            double baseScore = 0.5;

            // Intent confidence
            if (intent != "general") baseScore += 0.2;

            // Knowledge base matches
            if (knowledgeMatches.Any()) baseScore += 0.2;
            if (knowledgeMatches.Any(k => k.MinConfidenceScore > 0.8m)) baseScore += 0.1;

            // Context continuity
            if (context.Topics.ContainsKey(intent)) baseScore += 0.1;

            // User profile completeness
            if (!string.IsNullOrEmpty(context.UserProfile.Name)) baseScore += 0.05;
            if (context.UserProfile.TotalOrders > 0) baseScore += 0.05;

            return Math.Min(baseScore, 1.0);
        }

        private AIResponseDto CreateEscalationResponse(ConversationContext context, string userMessage)
        {
            return new AIResponseDto
            {
                Response = GetEscalationMessage(context),
                Intent = "escalation",
                ConfidenceScore = 1.0m,
                SuggestedActions = new List<SuggestedActionDto>
                {
                    new SuggestedActionDto { Text = "Chuyá»ƒn Ä‘áº¿n chuyÃªn viÃªn", Action = "escalate" },
                    new SuggestedActionDto { Text = "Tiáº¿p tá»¥c vá»›i AI", Action = "continue" },
                    new SuggestedActionDto { Text = "Gá»i hotline", Action = "call", Data = "1900-xxx-xxx" }
                },
                RequiresEscalation = true
            };
        }

        private string GetEscalationMessage(ConversationContext context)
        {
            if (context.UserProfile.IsVIP)
            {
                return "TÃ´i sáº½ káº¿t ná»‘i báº¡n vá»›i chuyÃªn viÃªn VIP cá»§a chÃºng tÃ´i ngay láº­p tá»©c Ä‘á»ƒ Ä‘Æ°á»£c há»— trá»£ tá»‘t nháº¥t! â­";
            }

            return "Äá»ƒ Ä‘áº£m báº£o báº¡n nháº­n Ä‘Æ°á»£c há»— trá»£ chÃ­nh xÃ¡c nháº¥t, tÃ´i sáº½ chuyá»ƒn báº¡n Ä‘áº¿n chuyÃªn viÃªn tÆ° váº¥n. Thá»i gian chá» dá»± kiáº¿n: 2-3 phÃºt. ğŸ‘¨â€ğŸ’¼";
        }

        private AIResponseDto CreateFallbackResponse()
        {
            return new AIResponseDto
            {
                Response = "Xin chÃ o! TÃ´i lÃ  trá»£ lÃ½ AI cá»§a SHN-Gear. Hiá»‡n táº¡i há»‡ thá»‘ng AI Ä‘ang táº¡m thá»i báº£o trÃ¬, nhÆ°ng tÃ´i váº«n cÃ³ thá»ƒ há»— trá»£ báº¡n vá»›i cÃ¡c thÃ´ng tin cÆ¡ báº£n vá» sáº£n pháº©m. Báº¡n cÃ³ thá»ƒ há»i tÃ´i vá» Ä‘iá»‡n thoáº¡i, laptop, tai nghe hoáº·c liÃªn há»‡ nhÃ¢n viÃªn tÆ° váº¥n Ä‘á»ƒ Ä‘Æ°á»£c há»— trá»£ chi tiáº¿t.",
                Intent = "system_maintenance",
                ConfidenceScore = 0.5m,
                RequiresEscalation = false,
                SuggestedActions = new List<SuggestedActionDto>
                {
                    new SuggestedActionDto { Text = "ğŸ“± Xem Ä‘iá»‡n thoáº¡i", Action = "search_phones" },
                    new SuggestedActionDto { Text = "ğŸ’» Xem laptop", Action = "search_laptops" },
                    new SuggestedActionDto { Text = "ğŸ§ Xem tai nghe", Action = "search_headphones" },
                    new SuggestedActionDto { Text = "ğŸ‘¨â€ğŸ’¼ LiÃªn há»‡ nhÃ¢n viÃªn", Action = "escalate" }
                }
            };
        }

        private AIResponseDto CreateIntelligentFallbackResponse(string userMessage, string intent)
        {
            var lowerMessage = userMessage.ToLower();
            string response;
            var actions = new List<SuggestedActionDto>();

            // Create intelligent responses based on detected intent
            switch (intent.ToLower())
            {
                case "greeting":
                    response = "Xin chÃ o! ChÃ o má»«ng báº¡n Ä‘áº¿n vá»›i SHN-Gear! TÃ´i lÃ  trá»£ lÃ½ AI vÃ  cÃ³ thá»ƒ giÃºp báº¡n tÃ¬m hiá»ƒu vá» cÃ¡c sáº£n pháº©m Ä‘iá»‡n thoáº¡i, laptop vÃ  tai nghe. Báº¡n Ä‘ang quan tÃ¢m Ä‘áº¿n sáº£n pháº©m nÃ o?";
                    actions.AddRange(new[]
                    {
                        new SuggestedActionDto { Text = "ğŸ“± Äiá»‡n thoáº¡i", Action = "search_phones" },
                        new SuggestedActionDto { Text = "ğŸ’» Laptop", Action = "search_laptops" },
                        new SuggestedActionDto { Text = "ğŸ§ Tai nghe", Action = "search_headphones" }
                    });
                    break;

                case "product_search":
                    if (lowerMessage.Contains("Ä‘iá»‡n thoáº¡i") || lowerMessage.Contains("phone"))
                    {
                        response = "TÃ´i cÃ³ thá»ƒ giÃºp báº¡n tÃ¬m Ä‘iá»‡n thoáº¡i phÃ¹ há»£p! SHN-Gear cÃ³ Ä‘áº§y Ä‘á»§ cÃ¡c dÃ²ng iPhone, Samsung, Xiaomi, OPPO vá»›i nhiá»u má»©c giÃ¡ khÃ¡c nhau. Báº¡n cÃ³ ngÃ¢n sÃ¡ch khoáº£ng bao nhiÃªu vÃ  thÆ°Æ¡ng hiá»‡u nÃ o yÃªu thÃ­ch?";
                        actions.Add(new SuggestedActionDto { Text = "Xem Ä‘iá»‡n thoáº¡i", Action = "view_products", Data = new { category = "phones" } });
                    }
                    else if (lowerMessage.Contains("laptop") || lowerMessage.Contains("mÃ¡y tÃ­nh"))
                    {
                        response = "ChÃºng tÃ´i cÃ³ nhiá»u laptop tá»« gaming Ä‘áº¿n vÄƒn phÃ²ng, cÃ¡c thÆ°Æ¡ng hiá»‡u Dell, HP, Asus, Macbook. Báº¡n dÃ¹ng laptop Ä‘á»ƒ lÃ m gÃ¬ chá»§ yáº¿u: gaming, há»c táº­p hay cÃ´ng viá»‡c?";
                        actions.Add(new SuggestedActionDto { Text = "Xem laptop", Action = "view_products", Data = new { category = "laptops" } });
                    }
                    else if (lowerMessage.Contains("tai nghe") || lowerMessage.Contains("headphone"))
                    {
                        response = "SHN-Gear cÃ³ nhiá»u loáº¡i tai nghe: gaming, Ã¢m nháº¡c, khÃ´ng dÃ¢y, cÃ³ mic... Báº¡n cáº§n tai nghe Ä‘á»ƒ lÃ m gÃ¬ vÃ  ngÃ¢n sÃ¡ch khoáº£ng bao nhiÃªu?";
                        actions.Add(new SuggestedActionDto { Text = "Xem tai nghe", Action = "view_products", Data = new { category = "headphones" } });
                    }
                    else
                    {
                        response = "TÃ´i cÃ³ thá»ƒ giÃºp báº¡n tÃ¬m sáº£n pháº©m phÃ¹ há»£p! Báº¡n Ä‘ang quan tÃ¢m Ä‘áº¿n Ä‘iá»‡n thoáº¡i, laptop hay tai nghe?";
                        actions.AddRange(new[]
                        {
                            new SuggestedActionDto { Text = "ğŸ“± Äiá»‡n thoáº¡i", Action = "search_phones" },
                            new SuggestedActionDto { Text = "ğŸ’» Laptop", Action = "search_laptops" },
                            new SuggestedActionDto { Text = "ğŸ§ Tai nghe", Action = "search_headphones" }
                        });
                    }
                    break;

                case "price_inquiry":
                    response = "Vá» giÃ¡ cáº£, chÃºng tÃ´i luÃ´n cÃ³ chÃ­nh sÃ¡ch giÃ¡ tá»‘t nháº¥t vÃ  nhiá»u chÆ°Æ¡ng trÃ¬nh khuyáº¿n mÃ£i. Báº¡n quan tÃ¢m Ä‘áº¿n sáº£n pháº©m nÃ o cá»¥ thá»ƒ Ä‘á»ƒ tÃ´i cÃ³ thá»ƒ tÆ° váº¥n giÃ¡ chÃ­nh xÃ¡c?";
                    actions.AddRange(new[]
                    {
                        new SuggestedActionDto { Text = "Xem khuyáº¿n mÃ£i", Action = "view_promotions" },
                        new SuggestedActionDto { Text = "So sÃ¡nh giÃ¡", Action = "compare_prices" }
                    });
                    break;

                case "thanks":
                    response = "Cáº£m Æ¡n báº¡n! Ráº¥t vui Ä‘Æ°á»£c há»— trá»£ báº¡n. Náº¿u cÃ³ thÃªm cÃ¢u há»i gÃ¬, Ä‘á»«ng ngáº§n ngáº¡i há»i tÃ´i nhÃ©!";
                    break;

                default:
                    response = "TÃ´i hiá»ƒu báº¡n cáº§n há»— trá»£. Máº·c dÃ¹ há»‡ thá»‘ng AI Ä‘ang táº¡m thá»i báº£o trÃ¬, tÃ´i váº«n cÃ³ thá»ƒ giÃºp báº¡n tÃ¬m hiá»ƒu vá» sáº£n pháº©m hoáº·c káº¿t ná»‘i vá»›i nhÃ¢n viÃªn tÆ° váº¥n chuyÃªn nghiá»‡p.";
                    actions.AddRange(new[]
                    {
                        new SuggestedActionDto { Text = "Xem sáº£n pháº©m", Action = "browse_products" },
                        new SuggestedActionDto { Text = "LiÃªn há»‡ nhÃ¢n viÃªn", Action = "escalate" }
                    });
                    break;
            }

            return new AIResponseDto
            {
                Response = response,
                Intent = intent,
                ConfidenceScore = 0.7m,
                RequiresEscalation = false,
                SuggestedActions = actions
            };
        }

        // Enhanced handlers with context
        private async Task<AIResponseDto> HandleProductSearchWithContext(string message, List<string> keywords, ConversationContext context)
        {
            // Check if user has mentioned preferences before
            var category = context.Entities.GetValueOrDefault("product_category")?.ToString();
            var brand = context.Entities.GetValueOrDefault("brand")?.ToString();
            var budget = context.Entities.GetValueOrDefault("budget");

            // Continue from where we left off
            if (!string.IsNullOrEmpty(category) && context.CurrentState == ConversationState.ProductDiscovery)
            {
                return ContinueProductDiscovery(message, category, brand, budget, context);
            }

            // Fresh product search
            return await HandleProductSearch(message, keywords);
        }

        private AIResponseDto ContinueProductDiscovery(string message, string category, string? brand, object? budget, ConversationContext context)
        {
            var response = new AIResponseDto
            {
                Response = $"Dá»±a trÃªn cuá»™c trÃ² chuyá»‡n trÆ°á»›c, tÃ´i hiá»ƒu báº¡n Ä‘ang tÃ¬m {category}" +
                         (brand != null ? $" {brand}" : "") +
                         (budget != null ? $" trong khoáº£ng {budget}" : "") +
                         ". HÃ£y cho tÃ´i biáº¿t thÃªm vá» nhu cáº§u sá»­ dá»¥ng cá»¥ thá»ƒ?",
                Intent = "product_search",
                ConfidenceScore = 0.8m
            };

            return response;
        }

        private AIResponseDto HandleGreetingWithContext(ConversationContext context)
        {
            string greeting;

            if (!string.IsNullOrEmpty(context.UserProfile.Name))
            {
                if (context.UserProfile.IsVIP)
                {
                    greeting = $"Xin chÃ o {context.UserProfile.Name}! Ráº¥t vui Ä‘Æ°á»£c phá»¥c vá»¥ thÃ nh viÃªn VIP cá»§a SHN-Gear. TÃ´i cÃ³ thá»ƒ há»— trá»£ gÃ¬ cho báº¡n hÃ´m nay? â­";
                }
                else
                {
                    greeting = $"ChÃ o {context.UserProfile.Name}! Ráº¥t vui Ä‘Æ°á»£c gáº·p láº¡i báº¡n táº¡i SHN-Gear. TÃ´i cÃ³ thá»ƒ giÃºp gÃ¬ cho báº¡n? ğŸ˜Š";
                }
            }
            else
            {
                greeting = "Xin chÃ o! TÃ´i lÃ  SHN Assistant, trá»£ lÃ½ AI cá»§a SHN-Gear. TÃ´i cÃ³ thá»ƒ há»— trá»£ báº¡n tÃ¬m sáº£n pháº©m, kiá»ƒm tra Ä‘Æ¡n hÃ ng, hoáº·c giáº£i Ä‘Ã¡p tháº¯c máº¯c. Báº¡n cáº§n tÃ´i giÃºp gÃ¬? ğŸ¤–";
            }

            return new AIResponseDto
            {
                Response = greeting,
                Intent = "greeting",
                ConfidenceScore = 1.0m,
                SuggestedActions = new List<SuggestedActionDto>
                {
                    new SuggestedActionDto { Text = "TÃ¬m sáº£n pháº©m", Action = "search_products" },
                    new SuggestedActionDto { Text = "Kiá»ƒm tra Ä‘Æ¡n hÃ ng", Action = "check_order" },
                    new SuggestedActionDto { Text = "Há»i vá» chÃ­nh sÃ¡ch", Action = "policies" },
                    new SuggestedActionDto { Text = "Há»— trá»£ ká»¹ thuáº­t", Action = "technical_support" }
                }
            };
        }

        private List<SuggestedActionDto> GenerateSuggestedActionsWithContext(string intent, AIResponseDto response, ConversationContext context)
        {
            var actions = new List<SuggestedActionDto>();

            switch (intent)
            {
                case "product_search":
                    actions.Add(new SuggestedActionDto { Text = "So sÃ¡nh sáº£n pháº©m", Action = "compare" });
                    actions.Add(new SuggestedActionDto { Text = "Xem khuyáº¿n mÃ£i", Action = "promotions" });
                    actions.Add(new SuggestedActionDto { Text = "Äáº·t mua ngay", Action = "order" });
                    if (context.UserProfile.TotalOrders > 0)
                        actions.Add(new SuggestedActionDto { Text = "Xem lá»‹ch sá»­ mua hÃ ng", Action = "order_history" });
                    break;

                case "price_inquiry":
                    actions.Add(new SuggestedActionDto { Text = "Xem khuyáº¿n mÃ£i", Action = "promotions" });
                    actions.Add(new SuggestedActionDto { Text = "So sÃ¡nh giÃ¡", Action = "compare_price" });
                    actions.Add(new SuggestedActionDto { Text = "Äáº·t mua", Action = "order" });
                    if (context.UserProfile.IsVIP)
                        actions.Add(new SuggestedActionDto { Text = "Æ¯u Ä‘Ã£i VIP", Action = "vip_deals" });
                    break;

                case "order_status":
                    actions.Add(new SuggestedActionDto { Text = "Theo dÃµi váº­n chuyá»ƒn", Action = "track_shipping" });
                    actions.Add(new SuggestedActionDto { Text = "Äá»•i Ä‘á»‹a chá»‰", Action = "change_address" });
                    actions.Add(new SuggestedActionDto { Text = "Há»§y Ä‘Æ¡n hÃ ng", Action = "cancel_order" });
                    break;

                default:
                    actions.Add(new SuggestedActionDto { Text = "TÃ¬m sáº£n pháº©m", Action = "search_products" });
                    actions.Add(new SuggestedActionDto { Text = "LiÃªn há»‡ tÆ° váº¥n", Action = "contact_advisor" });
                    break;
            }

            return actions;
        }

        // Basic handlers
        private async Task<AIResponseDto> HandleProductSearch(string message, List<string> keywords)
        {
            var products = await SearchProducts(keywords);

            if (products.Any())
            {
                return new AIResponseDto
                {
                    Response = "TÃ´i tÃ¬m tháº¥y má»™t sá»‘ sáº£n pháº©m phÃ¹ há»£p vá»›i yÃªu cáº§u cá»§a báº¡n:",
                    Intent = "product_search",
                    ConfidenceScore = 0.8m,
                    ProductRecommendations = products.Take(3).ToList()
                };
            }

            return new AIResponseDto
            {
                Response = "TÃ´i chÆ°a tÃ¬m tháº¥y sáº£n pháº©m nÃ o phÃ¹ há»£p. Báº¡n cÃ³ thá»ƒ mÃ´ táº£ chi tiáº¿t hÆ¡n nhu cáº§u cá»§a mÃ¬nh khÃ´ng?",
                Intent = "product_search",
                ConfidenceScore = 0.4m,
                RequiresEscalation = false
            };
        }

        private AIResponseDto HandlePriceInquiry(string message, List<string> keywords)
        {
            return new AIResponseDto
            {
                Response = "Äá»ƒ biáº¿t giÃ¡ chÃ­nh xÃ¡c nháº¥t vÃ  cÃ¡c chÆ°Æ¡ng trÃ¬nh khuyáº¿n mÃ£i hiá»‡n táº¡i, vui lÃ²ng liÃªn há»‡ vá»›i nhÃ¢n viÃªn tÆ° váº¥n hoáº·c xem trá»±c tiáº¿p trÃªn website.",
                Intent = "price_inquiry",
                ConfidenceScore = 0.7m,
                RequiresEscalation = true
            };
        }

        private async Task<AIResponseDto> HandleOrderStatus(string message, int? userId)
        {
            if (userId.HasValue)
            {
                try
                {
                    var recentOrder = await _context.Orders
                        .Where(o => o.UserId == userId)
                        .OrderByDescending(o => o.Id)
                        .FirstOrDefaultAsync();

                    if (recentOrder != null)
                    {
                        return new AIResponseDto
                        {
                            Response = $"ÄÆ¡n hÃ ng gáº§n nháº¥t #{recentOrder.Id} cá»§a báº¡n Ä‘ang Ä‘Æ°á»£c xá»­ lÃ½",
                            Intent = "order_status",
                            ConfidenceScore = 0.9m
                        };
                    }
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Error retrieving order status");
                }
            }

            return new AIResponseDto
            {
                Response = "Äá»ƒ kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng, vui lÃ²ng cung cáº¥p mÃ£ Ä‘Æ¡n hÃ ng hoáº·c Ä‘Äƒng nháº­p vÃ o tÃ i khoáº£n.",
                Intent = "order_status",
                ConfidenceScore = 0.6m,
                RequiresEscalation = false
            };
        }

        private AIResponseDto HandleShippingInfo(string message)
        {
            return new AIResponseDto
            {
                Response = "SHN-Gear há»— trá»£ giao hÃ ng toÃ n quá»‘c vá»›i nhiá»u hÃ¬nh thá»©c:\n" +
                          "â€¢ Giao hÃ ng tiÃªu chuáº©n: 2-3 ngÃ y lÃ m viá»‡c\n" +
                          "â€¢ Giao hÃ ng nhanh: 1-2 ngÃ y lÃ m viá»‡c\n" +
                          "â€¢ Giao hÃ ng siÃªu tá»‘c: Trong ngÃ y (khu vá»±c ná»™i thÃ nh)\n" +
                          "â€¢ Miá»…n phÃ­ giao hÃ ng cho Ä‘Æ¡n tá»« 500,000Ä‘",
                ConfidenceScore = 0.95m,
                Intent = "shipping_info",
                RequiresEscalation = false
            };
        }

        private AIResponseDto HandleReturnPolicy(string message)
        {
            return new AIResponseDto
            {
                Response = "ChÃ­nh sÃ¡ch Ä‘á»•i tráº£ cá»§a SHN-Gear:\n" +
                          "â€¢ Äá»•i tráº£ trong 7 ngÃ y ká»ƒ tá»« ngÃ y mua\n" +
                          "â€¢ Sáº£n pháº©m cÃ²n nguyÃªn seal, chÆ°a sá»­ dá»¥ng\n" +
                          "â€¢ Giá»¯ nguyÃªn há»™p vÃ  phá»¥ kiá»‡n Ä‘i kÃ¨m\n" +
                          "â€¢ Báº£o hÃ nh 12-24 thÃ¡ng tÃ¹y sáº£n pháº©m\n" +
                          "â€¢ Há»— trá»£ Ä‘á»•i tráº£ táº¡i cá»­a hÃ ng hoáº·c qua ship",
                ConfidenceScore = 0.95m,
                Intent = "return_policy",
                RequiresEscalation = false
            };
        }

        private AIResponseDto HandleTechnicalSupport(string message, List<string> keywords)
        {
            return new AIResponseDto
            {
                Response = "TÃ´i hiá»ƒu báº¡n Ä‘ang gáº·p váº¥n Ä‘á» ká»¹ thuáº­t. Äá»ƒ Ä‘Æ°á»£c há»— trá»£ tá»‘t nháº¥t, tÃ´i sáº½ káº¿t ná»‘i báº¡n vá»›i team ká»¹ thuáº­t chuyÃªn nghiá»‡p cá»§a chÃºng tÃ´i.",
                ConfidenceScore = 0.7m,
                Intent = "technical_support",
                RequiresEscalation = true
            };
        }

        private AIResponseDto HandleThanks()
        {
            return new AIResponseDto
            {
                Response = "Cáº£m Æ¡n báº¡n! TÃ´i luÃ´n sáºµn sÃ ng há»— trá»£ báº¡n. ChÃºc báº¡n cÃ³ tráº£i nghiá»‡m tuyá»‡t vá»i táº¡i SHN-Gear! ğŸ˜Š",
                Intent = "thanks",
                ConfidenceScore = 1.0m
            };
        }

        private AIResponseDto HandleGeneralQuery(string message, List<AIKnowledgeBase> knowledgeMatches)
        {
            if (knowledgeMatches.Any())
            {
                var bestMatch = knowledgeMatches.First();
                return new AIResponseDto
                {
                    Response = bestMatch.Answer ?? "TÃ´i chÆ°a cÃ³ thÃ´ng tin chi tiáº¿t vá» váº¥n Ä‘á» nÃ y.",
                    Intent = "general",
                    ConfidenceScore = (decimal)CalculateRelevanceScore(message, bestMatch)
                };
            }

            return new AIResponseDto
            {
                Response = "TÃ´i chÆ°a hiá»ƒu rÃµ cÃ¢u há»i cá»§a báº¡n. Báº¡n cÃ³ thá»ƒ nÃ³i rÃµ hÆ¡n hoáº·c Ä‘á»ƒ tÃ´i káº¿t ná»‘i vá»›i nhÃ¢n viÃªn tÆ° váº¥n?",
                Intent = "general",
                ConfidenceScore = 0.3m,
                RequiresEscalation = true
            };
        }

        private async Task<List<ProductRecommendationDto>> SearchProducts(List<string> keywords)
        {
            var products = new List<ProductRecommendationDto>();

            try
            {
                var productQuery = await _context.Products
                    .Include(p => p.Brand)
                    .Include(p => p.Category)
                    .Include(p => p.Variants)
                    .Include(p => p.ProductSpecifications) // Include ProductSpecifications
                    .Where(p => keywords.Any(k => p.Name.ToLower().Contains(k) ||
                                                p.Brand.Name.ToLower().Contains(k) ||
                                                p.Category.Name.ToLower().Contains(k)))
                    .Take(5)
                    .ToListAsync();

                products = productQuery.Select(p => new ProductRecommendationDto
                {
                    ProductId = p.Id,
                    Name = p.Name,
                    ImageUrl = "/images/no-image.jpg", // Default image
                    Price = p.Variants.Any() ? p.Variants.Min(v => v.Price) : 0,
                    DiscountPrice = p.Variants.Any() ? p.Variants.Min(v => v.DiscountPrice) : null,
                    Brand = p.Brand.Name,
                    Category = p.Category.Name,
                    Reason = "PhÃ¹ há»£p vá»›i tÃ¬m kiáº¿m cá»§a báº¡n"
                }).ToList();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error searching products");
            }

            return products;
        }

        // Enhanced handlers with Gemini AI
        private async Task<AIResponseDto> HandleWithGeminiAI(string userMessage, string intent, ConversationContext context, List<string> keywords)
        {
            try
            {
                // Build context for Gemini
                var contextInfo = BuildContextInfo(context, keywords);

                // Generate AI response using Gemini
                var aiResponse = await _geminiService.GenerateResponseAsync(userMessage, contextInfo, intent);

                // Calculate confidence score
                var confidence = await _geminiService.CalculateConfidenceScoreAsync(userMessage, intent);

                return new AIResponseDto
                {
                    Response = aiResponse,
                    Intent = intent,
                    ConfidenceScore = (decimal)confidence,
                    SuggestedActions = GenerateSuggestedActionsWithContext(intent, new AIResponseDto { Response = aiResponse, Intent = intent }, context),
                    RequiresEscalation = confidence < 0.4
                };
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error generating AI response with Gemini");
                // Return intelligent fallback instead of basic fallback
                var basicIntent = DetectIntent(userMessage);
                return CreateIntelligentFallbackResponse(userMessage, basicIntent);
            }
        }

        private string BuildContextInfo(ConversationContext context, List<string> keywords)
        {
            var contextBuilder = new System.Text.StringBuilder();

            // User profile info
            if (!string.IsNullOrEmpty(context.UserProfile.Name))
            {
                contextBuilder.AppendLine($"KhÃ¡ch hÃ ng: {context.UserProfile.Name}");
                if (context.UserProfile.IsVIP)
                    contextBuilder.AppendLine("LÃ  khÃ¡ch hÃ ng VIP");
            }

            // Previous conversation topics
            if (context.Topics.Any())
            {
                contextBuilder.AppendLine("CÃ¡c chá»§ Ä‘á» Ä‘Ã£ tháº£o luáº­n:");
                foreach (var topic in context.Topics.Take(3))
                {
                    contextBuilder.AppendLine($"- {topic.Key}: {topic.Value} láº§n");
                }
            }

            // Current conversation state
            contextBuilder.AppendLine($"Tráº¡ng thÃ¡i cuá»™c trÃ² chuyá»‡n: {context.CurrentState}");

            // Keywords
            if (keywords.Any())
            {
                contextBuilder.AppendLine($"Tá»« khÃ³a quan trá»ng: {string.Join(", ", keywords)}");
            }

            return contextBuilder.ToString();
        }
    }
}

```

### Services\AIService_New.cs
```cs
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.Models;
using SHN_Gear.DTOs;
using System.Text.Json;
using System.Text.RegularExpressions;

namespace SHN_Gear.Services
{
    // Äá»•i tÃªn class Ä‘á»ƒ trÃ¡nh trÃ¹ng láº·p
    public class AIService_New
    {
        private readonly AppDbContext _context;
        private readonly ILogger<AIService> _logger;
        private readonly ContextManager _contextManager;

        public AIService_New(AppDbContext context, ILogger<AIService> logger, ContextManager contextManager)
        {
            _context = context;
            _logger = logger;
            _contextManager = contextManager;
        }

        public async Task<AIResponseDto> ProcessMessageAsync(string userMessage, string sessionId, int? userId = null)
        {
            try
            {
                // 1. Get conversation context
                var context = await _contextManager.GetOrCreateContextAsync(sessionId, userId);

                // 2. Detect intent vÃ  extract keywords vá»›i context
                var intent = DetectIntentWithContext(userMessage, context);
                var keywords = ExtractKeywords(userMessage);
                var entities = ExtractEntities(userMessage, intent);

                // 3. TÃ¬m kiáº¿m trong knowledge base
                var knowledgeMatches = await FindKnowledgeMatches(userMessage, keywords, intent);

                // 4. Calculate confidence score
                var confidenceScore = CalculateConfidenceScore(intent, knowledgeMatches, context);

                // 5. Check if should escalate
                if (_contextManager.ShouldEscalate(context, confidenceScore))
                {
                    var escalationResponse = CreateEscalationResponse(context, userMessage);
                    await _contextManager.UpdateContextAsync(sessionId, userMessage, intent, entities, escalationResponse.Response);
                    return escalationResponse;
                }

                // 6. Xá»­ lÃ½ theo intent vá»›i context
                AIResponseDto response = intent.ToLower() switch
                {
                    "product_search" => await HandleProductSearchWithContext(userMessage, keywords, context),
                    "product_compare" => await HandleProductSearch(userMessage, keywords),
                    "price_inquiry" => await HandlePriceInquiry(userMessage, keywords),
                    "order_status" => await HandleOrderStatus(userMessage, userId),
                    "shipping_info" => await HandleShippingInfo(userMessage),
                    "return_policy" => await HandleReturnPolicy(userMessage),
                    "technical_support" => await HandleTechnicalSupport(userMessage, keywords),
                    "greeting" => await HandleGreetingWithContext(context),
                    "thanks" => await HandleThanks(),
                    _ => await HandleGeneralQuery(userMessage, knowledgeMatches)
                };

                // 7. Update confidence score
                response.ConfidenceScore = (decimal)confidenceScore;

                // 8. Add suggested actions with context
                response.SuggestedActions = GenerateSuggestedActionsWithContext(intent, response, context);

                // 9. Update conversation context
                await _contextManager.UpdateContextAsync(sessionId, userMessage, intent, entities, response.Response);

                return response;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error processing AI message: {Message}", userMessage);
                return CreateFallbackResponse();
            }
        }

        private string DetectIntentWithContext(string message, ConversationContext context)
        {
            var basicIntent = DetectIntent(message);

            // Enhance intent detection with context
            if (basicIntent == "general" && context.CurrentState != ConversationState.Discovery)
            {
                // If in middle of conversation, try to infer intent from current state
                return context.CurrentState switch
                {
                    ConversationState.ProductDiscovery => "product_search",
                    ConversationState.PriceNegotiation => "price_inquiry",
                    ConversationState.OrderSupport => "order_status",
                    ConversationState.TechnicalSupport => "technical_support",
                    _ => basicIntent
                };
            }

            return basicIntent;
        }

        private string DetectIntent(string message)
        {
            var lowerMessage = message.ToLower();

            // Product search patterns
            if (Regex.IsMatch(lowerMessage, @"(tÃ¬m|kiáº¿m|xem|cÃ³|bÃ¡n).*?(Ä‘iá»‡n thoáº¡i|laptop|tai nghe|iphone|samsung|macbook)"))
                return "product_search";

            // Product compare patterns  
            if (Regex.IsMatch(lowerMessage, @"(so sÃ¡nh|khÃ¡c nhau|nÃªn chá»n|tá»‘t hÆ¡n)"))
                return "product_compare";

            // Price patterns
            if (Regex.IsMatch(lowerMessage, @"(giÃ¡|bao nhiÃªu|tiá»n|cost|price|khuyáº¿n mÃ£i|giáº£m giÃ¡)"))
                return "price_inquiry";

            // Order patterns
            if (Regex.IsMatch(lowerMessage, @"(Ä‘Æ¡n hÃ ng|order|giao hÃ ng|váº­n chuyá»ƒn|ship)"))
                return "order_status";

            // Shipping patterns
            if (Regex.IsMatch(lowerMessage, @"(giao hÃ ng|váº­n chuyá»ƒn|ship|delivery|khi nÃ o nháº­n)"))
                return "shipping_info";

            // Return patterns
            if (Regex.IsMatch(lowerMessage, @"(Ä‘á»•i tráº£|return|hoÃ n tiá»n|báº£o hÃ nh|warranty)"))
                return "return_policy";

            // Technical patterns
            if (Regex.IsMatch(lowerMessage, @"(lá»—i|bug|khÃ´ng hoáº¡t Ä‘á»™ng|há»ng|sá»­a|fix)"))
                return "technical_support";

            // Greeting patterns
            if (Regex.IsMatch(lowerMessage, @"^(xin chÃ o|hello|hi|chÃ o|háº¿ lÃ´)"))
                return "greeting";

            // Thanks patterns
            if (Regex.IsMatch(lowerMessage, @"(cáº£m Æ¡n|thank|thanks|tks)"))
                return "thanks";

            return "general";
        }

        private List<string> ExtractKeywords(string message)
        {
            var keywords = new List<string>();
            var words = message.ToLower().Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);

            var productKeywords = new[] { "Ä‘iá»‡n thoáº¡i", "phone", "smartphone", "laptop", "mÃ¡y tÃ­nh", "tai nghe", "headphone" };
            var brandKeywords = new[] { "iphone", "samsung", "xiaomi", "oppo", "vivo", "macbook", "dell", "hp", "asus" };
            var featureKeywords = new[] { "camera", "pin", "mÃ n hÃ¬nh", "bá»™ nhá»›", "ram", "ssd", "gaming", "vÄƒn phÃ²ng" };

            foreach (var word in words)
            {
                if (productKeywords.Contains(word) || brandKeywords.Contains(word) || featureKeywords.Contains(word))
                {
                    keywords.Add(word);
                }
            }

            return keywords.Distinct().ToList();
        }

        private async Task<List<AIKnowledgeBase>> FindKnowledgeMatches(string message, List<string> keywords, string intent)
        {
            var matches = new List<AIKnowledgeBase>();

            try
            {
                // TÃ¬m kiáº¿m theo keywords
                var knowledgeItems = await _context.AIKnowledgeBases
                    .Where(k => keywords.Any(kw => k.Keywords.Contains(kw)))
                    .ToListAsync();

                foreach (var item in knowledgeItems)
                {
                    var score = CalculateRelevanceScore(message, item);
                    if (score > (double)item.MinConfidenceScore)
                    {
                        matches.Add(item);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error finding knowledge matches");
            }

            return matches.OrderByDescending(m => CalculateRelevanceScore(message, m)).ToList();
        }

        private double CalculateRelevanceScore(string message, AIKnowledgeBase knowledgeItem)
        {
            var score = 0.0;
            var lowerMessage = message.ToLower();
            var keywords = knowledgeItem.Keywords ?? Array.Empty<string>();

            foreach (var keyword in keywords)
            {
                if (lowerMessage.Contains(keyword.Trim().ToLower()))
                {
                    score += 0.2;
                }
            }

            if (!string.IsNullOrEmpty(knowledgeItem.Question) && lowerMessage.Contains(knowledgeItem.Question.ToLower()))
            {
                score += 0.5;
            }

            return Math.Min(score, 1.0);
        }

        private Dictionary<string, object> ExtractEntities(string message, string intent)
        {
            var entities = new Dictionary<string, object>();
            var lowerMessage = message.ToLower();

            // Extract product categories
            if (Regex.IsMatch(lowerMessage, @"(Ä‘iá»‡n thoáº¡i|phone|smartphone)"))
                entities["product_category"] = "phone";
            else if (Regex.IsMatch(lowerMessage, @"(laptop|mÃ¡y tÃ­nh|computer)"))
                entities["product_category"] = "laptop";
            else if (Regex.IsMatch(lowerMessage, @"(tai nghe|headphone|earphone)"))
                entities["product_category"] = "headphone";

            // Extract brands
            var brands = new[] { "iphone", "samsung", "xiaomi", "oppo", "vivo", "macbook", "dell", "hp", "asus", "sony", "jbl" };
            foreach (var brand in brands)
            {
                if (lowerMessage.Contains(brand))
                {
                    entities["brand"] = brand;
                    break;
                }
            }

            // Extract budget
            var budgetMatch = Regex.Match(lowerMessage, @"(\d+)\s*(triá»‡u|tr|million|k|nghÃ¬n)");
            if (budgetMatch.Success)
            {
                var amount = int.Parse(budgetMatch.Groups[1].Value);
                var unit = budgetMatch.Groups[2].Value.ToLower();

                var budget = unit switch
                {
                    "triá»‡u" or "tr" or "million" => amount * 1000000,
                    "k" or "nghÃ¬n" => amount * 1000,
                    _ => amount
                };

                entities["budget"] = budget;
            }

            // Extract order ID
            var orderMatch = Regex.Match(message, @"#?(\d{4,})");
            if (orderMatch.Success && intent == "order_status")
            {
                entities["order_id"] = orderMatch.Groups[1].Value;
            }

            return entities;
        }

        private double CalculateConfidenceScore(string intent, List<AIKnowledgeBase> knowledgeMatches, ConversationContext context)
        {
            double baseScore = 0.5;

            // Intent confidence
            if (intent != "general") baseScore += 0.2;

            // Knowledge base matches
            if (knowledgeMatches.Any()) baseScore += 0.2;
            if (knowledgeMatches.Any(k => k.MinConfidenceScore > 0.8m)) baseScore += 0.1;

            // Context continuity
            if (context.Topics.ContainsKey(intent)) baseScore += 0.1;

            // User profile completeness
            if (!string.IsNullOrEmpty(context.UserProfile.Name)) baseScore += 0.05;
            if (context.UserProfile.TotalOrders > 0) baseScore += 0.05;

            return Math.Min(baseScore, 1.0);
        }

        private AIResponseDto CreateEscalationResponse(ConversationContext context, string userMessage)
        {
            return new AIResponseDto
            {
                Response = GetEscalationMessage(context),
                Intent = "escalation",
                ConfidenceScore = 1.0m,
                SuggestedActions = new List<SuggestedActionDto>
                {
                    new SuggestedActionDto { Text = "Chuyá»ƒn Ä‘áº¿n chuyÃªn viÃªn", Action = "escalate" },
                    new SuggestedActionDto { Text = "Tiáº¿p tá»¥c vá»›i AI", Action = "continue" },
                    new SuggestedActionDto { Text = "Gá»i hotline", Action = "call", Data = "1900-xxx-xxx" }
                },
                RequiresEscalation = true
            };
        }

        private string GetEscalationMessage(ConversationContext context)
        {
            if (context.UserProfile.IsVIP)
            {
                return "TÃ´i sáº½ káº¿t ná»‘i báº¡n vá»›i chuyÃªn viÃªn VIP cá»§a chÃºng tÃ´i ngay láº­p tá»©c Ä‘á»ƒ Ä‘Æ°á»£c há»— trá»£ tá»‘t nháº¥t! â­";
            }

            return "Äá»ƒ Ä‘áº£m báº£o báº¡n nháº­n Ä‘Æ°á»£c há»— trá»£ chÃ­nh xÃ¡c nháº¥t, tÃ´i sáº½ chuyá»ƒn báº¡n Ä‘áº¿n chuyÃªn viÃªn tÆ° váº¥n. Thá»i gian chá» dá»± kiáº¿n: 2-3 phÃºt. ğŸ‘¨â€ğŸ’¼";
        }

        private AIResponseDto CreateFallbackResponse()
        {
            return new AIResponseDto
            {
                Response = "Xin lá»—i, hiá»‡n táº¡i tÃ´i gáº·p má»™t chÃºt trá»¥c tráº·c. Vui lÃ²ng thá»­ láº¡i sau Ã­t phÃºt hoáº·c liÃªn há»‡ vá»›i nhÃ¢n viÃªn tÆ° váº¥n Ä‘á»ƒ Ä‘Æ°á»£c há»— trá»£ ngay láº­p tá»©c.",
                Intent = "error",
                ConfidenceScore = 0.0m,
                RequiresEscalation = true,
                SuggestedActions = new List<SuggestedActionDto>
                {
                    new SuggestedActionDto { Text = "Thá»­ láº¡i", Action = "retry" },
                    new SuggestedActionDto { Text = "LiÃªn há»‡ nhÃ¢n viÃªn", Action = "escalate" }
                }
            };
        }

        // Enhanced handlers with context
        private async Task<AIResponseDto> HandleProductSearchWithContext(string message, List<string> keywords, ConversationContext context)
        {
            // Check if user has mentioned preferences before
            var category = context.Entities.GetValueOrDefault("product_category")?.ToString();
            var brand = context.Entities.GetValueOrDefault("brand")?.ToString();
            var budget = context.Entities.GetValueOrDefault("budget");

            // Continue from where we left off
            if (!string.IsNullOrEmpty(category) && context.CurrentState == ConversationState.ProductDiscovery)
            {
                return ContinueProductDiscovery(message, category, brand, budget, context);
            }

            // Fresh product search
            return await HandleProductSearch(message, keywords);
        }

        private AIResponseDto ContinueProductDiscovery(string message, string category, string? brand, object? budget, ConversationContext context)
        {
            var response = new AIResponseDto
            {
                Response = $"Dá»±a trÃªn cuá»™c trÃ² chuyá»‡n trÆ°á»›c, tÃ´i hiá»ƒu báº¡n Ä‘ang tÃ¬m {category}" +
                         (brand != null ? $" {brand}" : "") +
                         (budget != null ? $" trong khoáº£ng {budget}" : "") +
                         ". HÃ£y cho tÃ´i biáº¿t thÃªm vá» nhu cáº§u sá»­ dá»¥ng cá»¥ thá»ƒ?",
                Intent = "product_search",
                ConfidenceScore = 0.8m
            };

            return response;
        }

        private Task<AIResponseDto> HandleGreetingWithContext(ConversationContext context)
        {
            string greeting;

            if (!string.IsNullOrEmpty(context.UserProfile.Name))
            {
                if (context.UserProfile.IsVIP)
                {
                    greeting = $"Xin chÃ o {context.UserProfile.Name}! Ráº¥t vui Ä‘Æ°á»£c phá»¥c vá»¥ thÃ nh viÃªn VIP cá»§a SHN-Gear. TÃ´i cÃ³ thá»ƒ há»— trá»£ gÃ¬ cho báº¡n hÃ´m nay? â­";
                }
                else
                {
                    greeting = $"ChÃ o {context.UserProfile.Name}! Ráº¥t vui Ä‘Æ°á»£c gáº·p láº¡i báº¡n táº¡i SHN-Gear. TÃ´i cÃ³ thá»ƒ giÃºp gÃ¬ cho báº¡n? ğŸ˜Š";
                }
            }
            else
            {
                greeting = "Xin chÃ o! TÃ´i lÃ  SHN Assistant, trá»£ lÃ½ AI cá»§a SHN-Gear. TÃ´i cÃ³ thá»ƒ há»— trá»£ báº¡n tÃ¬m sáº£n pháº©m, kiá»ƒm tra Ä‘Æ¡n hÃ ng, hoáº·c giáº£i Ä‘Ã¡p tháº¯c máº¯c. Báº¡n cáº§n tÃ´i giÃºp gÃ¬? ğŸ¤–";
            }

            return Task.FromResult(new AIResponseDto
            {
                Response = greeting,
                Intent = "greeting",
                ConfidenceScore = 1.0m,
                SuggestedActions = new List<SuggestedActionDto>
                {
                    new SuggestedActionDto { Text = "TÃ¬m sáº£n pháº©m", Action = "search_products" },
                    new SuggestedActionDto { Text = "Kiá»ƒm tra Ä‘Æ¡n hÃ ng", Action = "check_order" },
                    new SuggestedActionDto { Text = "Há»i vá» chÃ­nh sÃ¡ch", Action = "policies" },
                    new SuggestedActionDto { Text = "Há»— trá»£ ká»¹ thuáº­t", Action = "technical_support" }
                }
            });
        }

        private List<SuggestedActionDto> GenerateSuggestedActionsWithContext(string intent, AIResponseDto response, ConversationContext context)
        {
            var actions = new List<SuggestedActionDto>();

            switch (intent)
            {
                case "product_search":
                    actions.Add(new SuggestedActionDto { Text = "So sÃ¡nh sáº£n pháº©m", Action = "compare" });
                    actions.Add(new SuggestedActionDto { Text = "Xem khuyáº¿n mÃ£i", Action = "promotions" });
                    actions.Add(new SuggestedActionDto { Text = "Äáº·t mua ngay", Action = "order" });
                    if (context.UserProfile.TotalOrders > 0)
                        actions.Add(new SuggestedActionDto { Text = "Xem lá»‹ch sá»­ mua hÃ ng", Action = "order_history" });
                    break;

                case "price_inquiry":
                    actions.Add(new SuggestedActionDto { Text = "Xem khuyáº¿n mÃ£i", Action = "promotions" });
                    actions.Add(new SuggestedActionDto { Text = "So sÃ¡nh giÃ¡", Action = "compare_price" });
                    actions.Add(new SuggestedActionDto { Text = "Äáº·t mua", Action = "order" });
                    if (context.UserProfile.IsVIP)
                        actions.Add(new SuggestedActionDto { Text = "Æ¯u Ä‘Ã£i VIP", Action = "vip_deals" });
                    break;

                case "order_status":
                    actions.Add(new SuggestedActionDto { Text = "Theo dÃµi váº­n chuyá»ƒn", Action = "track_shipping" });
                    actions.Add(new SuggestedActionDto { Text = "Äá»•i Ä‘á»‹a chá»‰", Action = "change_address" });
                    actions.Add(new SuggestedActionDto { Text = "Há»§y Ä‘Æ¡n hÃ ng", Action = "cancel_order" });
                    break;

                default:
                    actions.Add(new SuggestedActionDto { Text = "TÃ¬m sáº£n pháº©m", Action = "search_products" });
                    actions.Add(new SuggestedActionDto { Text = "LiÃªn há»‡ tÆ° váº¥n", Action = "contact_advisor" });
                    break;
            }

            return actions;
        }

        // Basic handlers
        private async Task<AIResponseDto> HandleProductSearch(string message, List<string> keywords)
        {
            var products = await SearchProducts(keywords);

            if (products.Any())
            {
                return new AIResponseDto
                {
                    Response = "TÃ´i tÃ¬m tháº¥y má»™t sá»‘ sáº£n pháº©m phÃ¹ há»£p vá»›i yÃªu cáº§u cá»§a báº¡n:",
                    Intent = "product_search",
                    ConfidenceScore = 0.8m,
                    ProductRecommendations = products.Take(3).ToList()
                };
            }

            return new AIResponseDto
            {
                Response = "TÃ´i chÆ°a tÃ¬m tháº¥y sáº£n pháº©m nÃ o phÃ¹ há»£p. Báº¡n cÃ³ thá»ƒ mÃ´ táº£ chi tiáº¿t hÆ¡n nhu cáº§u cá»§a mÃ¬nh khÃ´ng?",
                Intent = "product_search",
                ConfidenceScore = 0.4m,
                RequiresEscalation = false
            };
        }

        private Task<AIResponseDto> HandlePriceInquiry(string message, List<string> keywords)
        {
            return Task.FromResult(new AIResponseDto
            {
                Response = "Äá»ƒ biáº¿t giÃ¡ chÃ­nh xÃ¡c nháº¥t vÃ  cÃ¡c chÆ°Æ¡ng trÃ¬nh khuyáº¿n mÃ£i hiá»‡n táº¡i, vui lÃ²ng liÃªn há»‡ vá»›i nhÃ¢n viÃªn tÆ° váº¥n hoáº·c xem trá»±c tiáº¿p trÃªn website.",
                Intent = "price_inquiry",
                ConfidenceScore = 0.7m,
                RequiresEscalation = true
            });
        }

        private async Task<AIResponseDto> HandleOrderStatus(string message, int? userId)
        {
            if (userId.HasValue)
            {
                try
                {
                    var recentOrder = await _context.Orders
                        .Where(o => o.UserId == userId)
                        .OrderByDescending(o => o.Id)
                        .FirstOrDefaultAsync();

                    if (recentOrder != null)
                    {
                        return new AIResponseDto
                        {
                            Response = $"ÄÆ¡n hÃ ng gáº§n nháº¥t #{recentOrder.Id} cá»§a báº¡n Ä‘ang Ä‘Æ°á»£c xá»­ lÃ½",
                            Intent = "order_status",
                            ConfidenceScore = 0.9m
                        };
                    }
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Error retrieving order status");
                }
            }

            return new AIResponseDto
            {
                Response = "Äá»ƒ kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng, vui lÃ²ng cung cáº¥p mÃ£ Ä‘Æ¡n hÃ ng hoáº·c Ä‘Äƒng nháº­p vÃ o tÃ i khoáº£n.",
                Intent = "order_status",
                ConfidenceScore = 0.6m,
                RequiresEscalation = false
            };
        }

        private Task<AIResponseDto> HandleShippingInfo(string message)
        {
            return Task.FromResult(new AIResponseDto
            {
                Response = "SHN-Gear há»— trá»£ giao hÃ ng toÃ n quá»‘c vá»›i nhiá»u hÃ¬nh thá»©c:\n" +
                          "â€¢ Giao hÃ ng tiÃªu chuáº©n: 2-3 ngÃ y lÃ m viá»‡c\n" +
                          "â€¢ Giao hÃ ng nhanh: 1-2 ngÃ y lÃ m viá»‡c\n" +
                          "â€¢ Giao hÃ ng siÃªu tá»‘c: Trong ngÃ y (khu vá»±c ná»™i thÃ nh)\n" +
                          "â€¢ Miá»…n phÃ­ giao hÃ ng cho Ä‘Æ¡n tá»« 500,000Ä‘",
                ConfidenceScore = 0.95m,
                Intent = "shipping_info",
                RequiresEscalation = false
            });
        }

        private Task<AIResponseDto> HandleReturnPolicy(string message)
        {
            return Task.FromResult(new AIResponseDto
            {
                Response = "ChÃ­nh sÃ¡ch Ä‘á»•i tráº£ cá»§a SHN-Gear:\n" +
                          "â€¢ Äá»•i tráº£ trong 7 ngÃ y ká»ƒ tá»« ngÃ y mua\n" +
                          "â€¢ Sáº£n pháº©m cÃ²n nguyÃªn seal, chÆ°a sá»­ dá»¥ng\n" +
                          "â€¢ Giá»¯ nguyÃªn há»™p vÃ  phá»¥ kiá»‡n Ä‘i kÃ¨m\n" +
                          "â€¢ Báº£o hÃ nh 12-24 thÃ¡ng tÃ¹y sáº£n pháº©m\n" +
                          "â€¢ Há»— trá»£ Ä‘á»•i tráº£ táº¡i cá»­a hÃ ng hoáº·c qua ship",
                ConfidenceScore = 0.95m,
                Intent = "return_policy",
                RequiresEscalation = false
            });
        }

        private Task<AIResponseDto> HandleTechnicalSupport(string message, List<string> keywords)
        {
            return Task.FromResult(new AIResponseDto
            {
                Response = "TÃ´i hiá»ƒu báº¡n Ä‘ang gáº·p váº¥n Ä‘á» ká»¹ thuáº­t. Äá»ƒ Ä‘Æ°á»£c há»— trá»£ tá»‘t nháº¥t, tÃ´i sáº½ káº¿t ná»‘i báº¡n vá»›i team ká»¹ thuáº­t chuyÃªn nghiá»‡p cá»§a chÃºng tÃ´i.",
                ConfidenceScore = 0.7m,
                Intent = "technical_support",
                RequiresEscalation = true
            });
        }

        private Task<AIResponseDto> HandleThanks()
        {
            return Task.FromResult(new AIResponseDto
            {
                Response = "Cáº£m Æ¡n báº¡n! TÃ´i luÃ´n sáºµn sÃ ng há»— trá»£ báº¡n. ChÃºc báº¡n cÃ³ tráº£i nghiá»‡m tuyá»‡t vá»i táº¡i SHN-Gear! ğŸ˜Š",
                Intent = "thanks",
                ConfidenceScore = 1.0m
            });
        }

        private async Task<AIResponseDto> HandleGeneralQuery(string message, List<AIKnowledgeBase> knowledgeMatches)
        {
            if (knowledgeMatches.Any())
            {
                var bestMatch = knowledgeMatches.First();
                return new AIResponseDto
                {
                    Response = bestMatch.Answer ?? "TÃ´i chÆ°a cÃ³ thÃ´ng tin chi tiáº¿t vá» váº¥n Ä‘á» nÃ y.",
                    Intent = "general",
                    ConfidenceScore = (decimal)CalculateRelevanceScore(message, bestMatch)
                };
            }

            return new AIResponseDto
            {
                Response = "TÃ´i chÆ°a hiá»ƒu rÃµ cÃ¢u há»i cá»§a báº¡n. Báº¡n cÃ³ thá»ƒ nÃ³i rÃµ hÆ¡n hoáº·c Ä‘á»ƒ tÃ´i káº¿t ná»‘i vá»›i nhÃ¢n viÃªn tÆ° váº¥n?",
                Intent = "general",
                ConfidenceScore = 0.3m,
                RequiresEscalation = true
            };
        }

        private async Task<List<ProductRecommendationDto>> SearchProducts(List<string> keywords)
        {
            var products = new List<ProductRecommendationDto>();

            try
            {
                var productQuery = await _context.Products
                    .Include(p => p.Brand)
                    .Include(p => p.Category)
                    .Include(p => p.ProductSpecifications) // Include ProductSpecifications
                    .Where(p => keywords.Any(k => p.Name.ToLower().Contains(k) ||
                                                p.Brand.Name.ToLower().Contains(k) ||
                                                p.Category.Name.ToLower().Contains(k)))
                    .Take(5)
                    .ToListAsync();

                products = productQuery.Select(p => new ProductRecommendationDto
                {
                    ProductId = p.Id,
                    Name = p.Name,
                    ImageUrl = "/images/no-image.jpg", // Default image
                    Price = 0, // Needs actual price field
                    DiscountPrice = null,
                    Brand = p.Brand.Name,
                    Category = p.Category.Name,
                    Reason = "PhÃ¹ há»£p vá»›i tÃ¬m kiáº¿m cá»§a báº¡n"
                }).ToList();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error searching products");
            }

            return products;
        }
    }
}

```

### Services\ChatService.cs
```cs
using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.SignalR;
using SHN_Gear.Data;
using SHN_Gear.Models;
using SHN_Gear.DTOs;
using SHN_Gear.Hubs;
using System.Text.Json;

namespace SHN_Gear.Services
{
    public class ChatService
    {
        private readonly AppDbContext _context;
        // private readonly AIService _aiService; // Táº¡m thá»i bá» AI
        private readonly ILogger<ChatService> _logger;
        private readonly IHubContext<ChatHub> _hubContext;

        public ChatService(AppDbContext context, ILogger<ChatService> logger, IHubContext<ChatHub> hubContext)
        {
            _context = context;
            // _aiService = aiService; // Táº¡m thá»i bá» AI
            _logger = logger;
            _hubContext = hubContext;
        }

        public async Task<ChatSessionDto> CreateOrGetSessionAsync(int? userId, string? guestName = null, string? guestEmail = null, string? sessionId = null)
        {
            ChatSession? session = null;

            _logger.LogInformation("CreateOrGetSessionAsync called with userId: {UserId}, guestName: {GuestName}, guestEmail: {GuestEmail}, sessionId: {SessionId}",
                userId, guestName, guestEmail, sessionId);

            // Náº¿u cÃ³ userId, tÃ¬m session hiá»‡n táº¡i cá»§a user
            if (userId.HasValue)
            {
                _logger.LogInformation("Looking for existing session for userId: {UserId}", userId.Value);
                session = await _context.ChatSessions
                    .Include(s => s.User)
                    .Include(s => s.AssignedAdmin)
                    .Include(s => s.Messages.OrderBy(m => m.SentAt))
                        .ThenInclude(m => m.SenderUser)
                    .FirstOrDefaultAsync(s => s.UserId == userId && s.Status == ChatSessionStatus.Active);

                if (session != null)
                {
                    _logger.LogInformation("Found existing session {SessionId} for user {UserId}", session.SessionId, userId.Value);
                }
                else
                {
                    _logger.LogInformation("No existing session found for user {UserId}", userId.Value);
                }
            }
            // Náº¿u khÃ´ng cÃ³ userId nhÆ°ng cÃ³ sessionId, tÃ¬m theo sessionId
            else if (!string.IsNullOrEmpty(sessionId))
            {
                session = await _context.ChatSessions
                    .Include(s => s.User)
                    .Include(s => s.AssignedAdmin)
                    .Include(s => s.Messages.OrderBy(m => m.SentAt))
                        .ThenInclude(m => m.SenderUser)
                    .FirstOrDefaultAsync(s => s.SessionId == sessionId && s.Status == ChatSessionStatus.Active);
            }

            if (session != null)
            {
                // Update last activity and guest info if provided
                session.LastActivityAt = DateTime.UtcNow;

                // Update guest info if provided and not already set
                if (!string.IsNullOrEmpty(guestName) && string.IsNullOrEmpty(session.GuestName))
                {
                    session.GuestName = guestName;
                }
                if (!string.IsNullOrEmpty(guestEmail) && string.IsNullOrEmpty(session.GuestEmail))
                {
                    session.GuestEmail = guestEmail;
                }

                await _context.SaveChangesAsync();
                return MapToDto(session);
            }

            // Táº¡o session má»›i
            session = new ChatSession
            {
                UserId = userId,
                SessionId = string.IsNullOrEmpty(sessionId) ? Guid.NewGuid().ToString() : sessionId,
                GuestName = guestName,
                GuestEmail = guestEmail,
                CreatedAt = DateTime.UtcNow,
                LastActivityAt = DateTime.UtcNow,
                Status = ChatSessionStatus.Active,
                Type = ChatType.AI
            };

            _context.ChatSessions.Add(session);
            await _context.SaveChangesAsync();

            // Gá»­i welcome message
            await AddWelcomeMessage(session.Id);

            // Reload session vá»›i messages vÃ  User
            session = await _context.ChatSessions
                .Include(s => s.User)
                .Include(s => s.AssignedAdmin)
                .Include(s => s.Messages.OrderBy(m => m.SentAt))
                    .ThenInclude(m => m.SenderUser)
                .FirstAsync(s => s.Id == session.Id);

            // ThÃ´ng bÃ¡o cho admin dashboard vá» session má»›i
            await NotifyAdminsNewSession(session);

            return MapToDto(session);
        }

        public async Task<ChatMessageDto> SendMessageAsync(SendMessageDto messageDto, int? userId = null)
        {
            try
            {
                // Get or create session
                var sessionDto = await CreateOrGetSessionAsync(userId, messageDto.GuestName, messageDto.GuestEmail, messageDto.SessionId);
                var session = await _context.ChatSessions
                    .Include(s => s.User)
                    .FirstOrDefaultAsync(s => s.Id == sessionDto.Id);

                if (session == null)
                    throw new InvalidOperationException("Session not found");

                // Validate that SessionId is not null
                if (string.IsNullOrEmpty(session.SessionId))
                {
                    _logger.LogError("Session {SessionId} has null or empty SessionId", sessionDto.Id);
                    throw new InvalidOperationException("Session has invalid SessionId");
                }

                // Save user message
                var userMessage = new ChatMessage
                {
                    ChatSessionId = session.Id,
                    Content = messageDto.Content,
                    Type = MessageType.Text,
                    Sender = MessageSender.User,
                    SenderId = userId,
                    SentAt = DateTime.UtcNow,
                    MetadataJson = messageDto.Context != null ? JsonSerializer.Serialize(messageDto.Context) : null
                };

                _context.ChatMessages.Add(userMessage);
                await _context.SaveChangesAsync();

                // Reload message with SenderUser information
                var messageWithUser = await _context.ChatMessages
                    .Include(m => m.SenderUser)
                    .FirstOrDefaultAsync(m => m.Id == userMessage.Id);

                // Gá»­i tin nháº¯n user real-time
                await NotifyNewMessage(messageWithUser ?? userMessage, session.SessionId);

                // Process with AI (if session type is AI or Mixed)
                // if (session.Type == ChatType.AI || session.Type == ChatType.Mixed)
                // {
                //     await ProcessAIResponse(session, messageDto.Content, userId, messageDto.Context);
                // }

                // Update session activity
                session.LastActivityAt = DateTime.UtcNow;
                await _context.SaveChangesAsync();

                // Return the user message
                return MapMessageToDto(messageWithUser ?? userMessage);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error sending message: {Message}", messageDto.Content);
                throw;
            }
        }

        private async Task ProcessAIResponse(ChatSession session, string userMessage, int? userId, object? context)
        {
            // Táº¡m thá»i bá» AI xá»­ lÃ½
            // (method intentionally left blank)
        }

        public async Task<ChatMessageDto> SendAdminMessageAsync(string sessionId, string content, int adminId)
        {
            try
            {
                var session = await _context.ChatSessions
                    .FirstOrDefaultAsync(s => s.SessionId == sessionId);

                if (session == null)
                    throw new InvalidOperationException("Session not found");

                var admin = await _context.Users.FirstOrDefaultAsync(u => u.Id == adminId);
                if (admin == null)
                    throw new InvalidOperationException("Admin not found");

                // Create admin message
                var adminMessage = new ChatMessage
                {
                    ChatSessionId = session.Id,
                    Content = content,
                    Type = MessageType.Text,
                    Sender = MessageSender.Admin,
                    SenderId = adminId,
                    SentAt = DateTime.UtcNow
                };

                _context.ChatMessages.Add(adminMessage);

                // Update session to admin mode if not already
                if (session.Type != ChatType.Admin)
                {
                    session.Type = ChatType.Mixed; // Allow both AI and admin
                    session.AssignedAdminId = adminId;
                }

                session.LastActivityAt = DateTime.UtcNow;
                await _context.SaveChangesAsync();

                // Gá»­i tin nháº¯n admin real-time
                await NotifyNewMessage(adminMessage, session.SessionId);

                return MapMessageToDto(adminMessage);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error sending admin message to session {SessionId}", sessionId);
                throw;
            }
        }

        public async Task<ChatSessionDto> EscalateToAdminAsync(int sessionId, string reason, int? preferredAdminId = null)
        {
            var session = await _context.ChatSessions
                .Include(s => s.Messages)
                .FirstOrDefaultAsync(s => s.Id == sessionId);

            if (session == null)
                throw new InvalidOperationException("Session not found");

            // Find available admin
            var admin = preferredAdminId.HasValue
                ? await _context.Users.FirstOrDefaultAsync(u => u.Id == preferredAdminId && u.RoleId == 1)
                : await FindAvailableAdmin();

            session.Type = ChatType.Admin;
            session.Status = ChatSessionStatus.Escalated;
            session.AssignedAdminId = admin?.Id;
            session.RequiresHumanSupport = true;

            // Add escalation message
            var escalationMessage = new ChatMessage
            {
                ChatSessionId = session.Id,
                Content = admin != null
                    ? $"Báº¡n Ä‘Ã£ Ä‘Æ°á»£c káº¿t ná»‘i vá»›i {admin.FullName}. NhÃ¢n viÃªn sáº½ há»— trá»£ báº¡n trong giÃ¢y lÃ¡t."
                    : "Cuá»™c trÃ² chuyá»‡n Ä‘Ã£ Ä‘Æ°á»£c chuyá»ƒn Ä‘áº¿n bá»™ pháº­n há»— trá»£. NhÃ¢n viÃªn sáº½ liÃªn há»‡ vá»›i báº¡n sá»›m nháº¥t cÃ³ thá»ƒ.",
                Type = MessageType.EscalationNotice,
                Sender = MessageSender.System,
                SentAt = DateTime.UtcNow,
                MetadataJson = JsonSerializer.Serialize(new { Reason = reason, AdminId = admin?.Id })
            };

            _context.ChatMessages.Add(escalationMessage);
            await _context.SaveChangesAsync();

            return MapToDto(session);
        }

        public async Task<ChatMessageDto> SendAdminMessageAsync(int sessionId, int adminId, string content)
        {
            var session = await _context.ChatSessions.FindAsync(sessionId);
            if (session == null)
                throw new InvalidOperationException("Session not found");

            var admin = await _context.Users.FindAsync(adminId);
            if (admin == null || admin.RoleId != 1)
                throw new UnauthorizedAccessException("Invalid admin");

            var message = new ChatMessage
            {
                ChatSessionId = sessionId,
                Content = content,
                Type = MessageType.Text,
                Sender = MessageSender.Admin,
                SenderId = adminId,
                SentAt = DateTime.UtcNow
            };

            _context.ChatMessages.Add(message);

            // Update session
            session.LastActivityAt = DateTime.UtcNow;
            session.AssignedAdminId = adminId;
            session.Type = ChatType.Admin;

            await _context.SaveChangesAsync();

            return MapMessageToDto(message);
        }

        public async Task<List<ChatSessionDto>> GetActiveChatSessionsAsync(int? adminId = null)
        {
            _logger.LogInformation("GetActiveChatSessionsAsync called with adminId: {AdminId}", adminId);

            // First, check total sessions count
            var totalSessionsCount = await _context.ChatSessions.CountAsync();
            _logger.LogInformation("Total sessions in database: {Count}", totalSessionsCount);

            var query = _context.ChatSessions
                .Include(s => s.User)
                .Include(s => s.AssignedAdmin)
                .Include(s => s.Messages.OrderByDescending(m => m.SentAt).Take(1))
                    .ThenInclude(m => m.SenderUser)
                .Where(s => s.Status == ChatSessionStatus.Active || s.Status == ChatSessionStatus.Escalated);

            // Check count before applying admin filter
            var activeSessionsCount = await query.CountAsync();
            _logger.LogInformation("Active/Escalated sessions count: {Count}", activeSessionsCount);

            // For now, show all active sessions to all admins
            // Later you can implement admin assignment logic
            if (adminId.HasValue)
            {
                // Show all sessions to admin: 
                // 1. Assigned to them
                // 2. Requiring human support  
                // 3. Unassigned sessions (both guest and logged-in users)
                // 4. All logged-in user sessions (so admin can see all customer conversations)
                query = query.Where(s =>
                    s.AssignedAdminId == adminId ||
                    s.RequiresHumanSupport ||
                    s.AssignedAdminId == null); // All unassigned sessions regardless of guest or logged-in
                var filteredCount = await query.CountAsync();
                _logger.LogInformation("Filtered sessions count for admin {AdminId}: {Count}", adminId, filteredCount);
            }

            var sessions = await query
                .OrderByDescending(s => s.LastActivityAt)
                .ToListAsync();

            _logger.LogInformation("Returning {Count} sessions", sessions.Count);
            return sessions.Select(MapToDto).ToList();
        }

        public async Task<ChatSessionDto?> GetSessionAsync(string sessionId)
        {
            var session = await _context.ChatSessions
                .Include(s => s.User)
                .Include(s => s.AssignedAdmin)
                .Include(s => s.Messages.OrderBy(m => m.SentAt))
                    .ThenInclude(m => m.SenderUser)
                .FirstOrDefaultAsync(s => s.SessionId == sessionId);

            return session != null ? MapToDto(session) : null;
        }

        private async Task AddWelcomeMessage(int sessionId)
        {
            var welcomeMessages = new[]
            {
                "Xin chÃ o! TÃ´i lÃ  trá»£ lÃ½ AI cá»§a SHN-Gear. TÃ´i cÃ³ thá»ƒ giÃºp báº¡n tÃ¬m sáº£n pháº©m, kiá»ƒm tra giÃ¡ cáº£, hoáº·c tráº£ lá»i cÃ¡c cÃ¢u há»i. Báº¡n cáº§n há»— trá»£ gÃ¬?",
                "ChÃ o má»«ng báº¡n Ä‘áº¿n vá»›i SHN-Gear! TÃ´i cÃ³ thá»ƒ giÃºp báº¡n tÃ¬m hiá»ƒu vá» Ä‘iá»‡n thoáº¡i, laptop, tai nghe vÃ  nhiá»u sáº£n pháº©m khÃ¡c. HÃ£y cho tÃ´i biáº¿t báº¡n Ä‘ang quan tÃ¢m gÃ¬ nhÃ©!",
                "Hi! TÃ´i lÃ  AI assistant cá»§a SHN-Gear. Báº¡n cÃ³ thá»ƒ há»i tÃ´i vá» sáº£n pháº©m, giÃ¡ cáº£, chÃ­nh sÃ¡ch, hoáº·c báº¥t cá»© Ä‘iá»u gÃ¬. TÃ´i sáºµn sÃ ng há»— trá»£!"
            };

            var welcomeMessage = new ChatMessage
            {
                ChatSessionId = sessionId,
                Content = welcomeMessages[Random.Shared.Next(welcomeMessages.Length)],
                Type = MessageType.Text,
                Sender = MessageSender.AI,
                SentAt = DateTime.UtcNow,
                AIConfidenceScore = 1.0m,
                AIIntent = "greeting",
                SuggestedActionsJson = JsonSerializer.Serialize(new[]
                {
                    new SuggestedActionDto { Text = "TÃ¬m Ä‘iá»‡n thoáº¡i", Action = "search_phones" },
                    new SuggestedActionDto { Text = "TÃ¬m laptop", Action = "search_laptops" },
                    new SuggestedActionDto { Text = "TÃ¬m tai nghe", Action = "search_headphones" },
                    new SuggestedActionDto { Text = "Xem khuyáº¿n mÃ£i", Action = "view_promotions" }
                })
            };

            _context.ChatMessages.Add(welcomeMessage);
            await _context.SaveChangesAsync();
        }

        private async Task NotifyAdminsNewSession(ChatSession session)
        {
            try
            {
                await _hubContext.Clients.Group("admins").SendAsync("NewChatSession", MapToDto(session));
                _logger.LogInformation("Notified admins about new session {SessionId}", session.SessionId);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error notifying admins about new session {SessionId}", session.SessionId);
            }
        }

        private async Task NotifyNewMessage(ChatMessage message, string sessionId)
        {
            try
            {
                var messageDto = MapMessageToDto(message);

                // TÃ¬m session Ä‘á»ƒ láº¥y userId
                var session = await _context.ChatSessions
                    .AsNoTracking()
                    .FirstOrDefaultAsync(s => s.SessionId == sessionId);

                // Gá»­i cho user cá»¥ thá»ƒ (náº¿u cÃ³ userId)
                if (session?.UserId.HasValue == true)
                {
                    await _hubContext.Clients.Group($"user_{session.UserId.Value}").SendAsync("NewMessage", messageDto);
                    _logger.LogInformation("Sent message to user_{UserId} group", session.UserId.Value);
                }

                // Gá»­i cho táº¥t cáº£ clients trong session (cho guest users vÃ  admins trong session)
                await _hubContext.Clients.Group($"session_{sessionId}").SendAsync("NewMessage", messageDto);

                // Gá»­i cho admin dashboard
                await _hubContext.Clients.Group("admins").SendAsync("NewMessage", messageDto);
                _logger.LogInformation("Sent message to admins group for session {SessionId}", sessionId);

                _logger.LogInformation("Sent real-time message for session {SessionId}", sessionId);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error sending real-time message for session {SessionId}", sessionId);
            }
        }

        private async Task<User?> FindAvailableAdmin()
        {
            // Simple logic: find admin with least active chats
            var adminChatCounts = await _context.ChatSessions
                .Where(s => s.Status == ChatSessionStatus.Active || s.Status == ChatSessionStatus.Escalated)
                .Where(s => s.AssignedAdminId.HasValue)
                .GroupBy(s => s.AssignedAdminId)
                .Select(g => new { AdminId = g.Key, Count = g.Count() })
                .ToListAsync();

            var allAdmins = await _context.Users
                .Where(u => u.RoleId == 1 && u.IsActive)
                .ToListAsync();

            return allAdmins
                .OrderBy(a => adminChatCounts.FirstOrDefault(acc => acc.AdminId == a.Id)?.Count ?? 0)
                .FirstOrDefault();
        }

        private ChatSessionDto MapToDto(ChatSession session)
        {
            return new ChatSessionDto
            {
                Id = session.Id,
                SessionId = session.SessionId,
                GuestName = session.GuestName,
                GuestEmail = session.GuestEmail,
                User = session.User != null ? new UserDto { Id = session.User.Id, FullName = session.User.FullName, Email = session.User.Email } : null,
                CreatedAt = session.CreatedAt,
                LastActivityAt = session.LastActivityAt,
                Status = session.Status.ToString(),
                Type = session.Type.ToString(),
                AssignedAdmin = session.AssignedAdmin != null ? new UserDto { Id = session.AssignedAdmin.Id, FullName = session.AssignedAdmin.FullName } : null,
                RequiresHumanSupport = session.RequiresHumanSupport,
                Messages = session.Messages?.Select(MapMessageToDto).ToList() ?? new List<ChatMessageDto>()
            };
        }

        private ChatMessageDto MapMessageToDto(ChatMessage message)
        {
            return new ChatMessageDto
            {
                Id = message.Id,
                ChatSessionId = message.ChatSessionId, // Add this field
                Content = message.Content,
                Type = message.Type.ToString(),
                Sender = message.Sender.ToString(),
                SenderUser = message.SenderUser != null ? new UserDto { Id = message.SenderUser.Id, FullName = message.SenderUser.FullName } : null,
                SentAt = message.SentAt,
                IsRead = message.IsRead,
                AIConfidenceScore = message.AIConfidenceScore,
                AIIntent = message.AIIntent,
                RequiresEscalation = message.RequiresEscalation,
                SuggestedActions = !string.IsNullOrEmpty(message.SuggestedActionsJson)
                    ? JsonSerializer.Deserialize<List<SuggestedActionDto>>(message.SuggestedActionsJson)
                    : null,
                Metadata = !string.IsNullOrEmpty(message.MetadataJson)
                    ? JsonSerializer.Deserialize<object>(message.MetadataJson)
                    : null
            };
        }
    }
}

```

### Services\CloudinaryService.cs
```cs
using CloudinaryDotNet;
using CloudinaryDotNet.Actions;
using Microsoft.Extensions.Configuration;

public class CloudinaryService : ICloudinaryService
{
    private readonly Cloudinary _cloudinary;

    public CloudinaryService(IConfiguration configuration)
    {
        var cloudName = configuration["Cloudinary:CloudName"];
        var apiKey = configuration["Cloudinary:ApiKey"];
        var apiSecret = configuration["Cloudinary:ApiSecret"];

        var account = new Account(
            cloudName,
            apiKey,
            apiSecret);

        _cloudinary = new Cloudinary(account);
        _cloudinary.Api.Secure = true;
    }

    public async Task<string> UploadImageAsync(IFormFile file)
    {
        if (file == null || file.Length == 0)
            throw new ArgumentException("No file uploaded");

        using var stream = file.OpenReadStream();
        var uploadParams = new ImageUploadParams
        {
            File = new FileDescription(file.FileName, stream),
            Transformation = new Transformation()
                .Width(800)
                .Height(800)
                .Crop("limit")
        };

        var uploadResult = await _cloudinary.UploadAsync(uploadParams);

        if (uploadResult.Error != null)
            throw new Exception(uploadResult.Error.Message);

        return uploadResult.SecureUrl.ToString();
    }

    public async Task DeleteImageAsync(string publicId)
    {
        var deletionParams = new DeletionParams(publicId);
        var result = await _cloudinary.DestroyAsync(deletionParams);

        if (result.Result != "ok")
            throw new Exception($"Failed to delete image with publicId: {publicId}");
    }
}
```

### Services\ContextManager.cs
```cs
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.Models;
using SHN_Gear.DTOs;
using System.Text.Json;

namespace SHN_Gear.Services
{
    public class ContextManager
    {
        private readonly AppDbContext _context;
        private readonly ILogger<ContextManager> _logger;

        // In-memory cache for active sessions (Redis in production)
        private static readonly Dictionary<string, ConversationContext> _activeContexts = new();
        private static readonly object _lock = new object();

        public ContextManager(AppDbContext context, ILogger<ContextManager> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<ConversationContext> GetOrCreateContextAsync(string sessionId, int? userId = null)
        {
            // Validate sessionId
            if (string.IsNullOrEmpty(sessionId))
            {
                _logger.LogError("SessionId cannot be null or empty");
                throw new ArgumentException("SessionId cannot be null or empty", nameof(sessionId));
            }

            lock (_lock)
            {
                if (_activeContexts.TryGetValue(sessionId, out var existingContext))
                {
                    // Check if context is still valid (not expired)
                    if (existingContext.LastActivity.AddMinutes(30) > DateTime.UtcNow)
                    {
                        return existingContext;
                    }
                    else
                    {
                        // Context expired, remove from cache
                        _activeContexts.Remove(sessionId);
                    }
                }
            }

            // Load from database or create new
            var session = await _context.ChatSessions
                .Include(s => s.Messages.OrderByDescending(m => m.SentAt).Take(50))
                .FirstOrDefaultAsync(s => s.SessionId == sessionId);

            var context = new ConversationContext
            {
                SessionId = sessionId,
                UserId = userId,
                LastActivity = DateTime.UtcNow,
                CurrentState = ConversationState.Discovery,
                MessageHistory = session?.Messages?.Select(m => new ContextMessage
                {
                    Content = m.Content,
                    Sender = m.Sender.ToString(),
                    Timestamp = m.SentAt,
                    Intent = m.AIIntent ?? "",
                    Entities = string.IsNullOrEmpty(m.MetadataJson) ? new() :
                              JsonSerializer.Deserialize<Dictionary<string, object>>(m.MetadataJson) ?? new()
                }).ToList() ?? new(),
                UserProfile = userId.HasValue ? await LoadUserProfile(userId.Value) : new(),
                Topics = new(),
                Entities = new(),
                Preferences = new()
            };

            // Analyze conversation state from history
            AnalyzeConversationState(context);

            lock (_lock)
            {
                _activeContexts[sessionId] = context;
            }

            return context;
        }

        public Task UpdateContextAsync(string sessionId, string message, string intent,
            Dictionary<string, object>? entities = null, string? response = null)
        {
            lock (_lock)
            {
                if (_activeContexts.TryGetValue(sessionId, out var context))
                {
                    // Add new message to history
                    context.MessageHistory.Add(new ContextMessage
                    {
                        Content = message,
                        Sender = "user",
                        Timestamp = DateTime.UtcNow,
                        Intent = intent,
                        Entities = entities ?? new()
                    });

                    if (!string.IsNullOrEmpty(response))
                    {
                        context.MessageHistory.Add(new ContextMessage
                        {
                            Content = response,
                            Sender = "ai",
                            Timestamp = DateTime.UtcNow,
                            Intent = "response",
                            Entities = new()
                        });
                    }

                    // Update entities and topics
                    UpdateEntitiesAndTopics(context, intent, entities);

                    // Update conversation state
                    UpdateConversationState(context, intent);

                    // Keep only last 50 messages
                    if (context.MessageHistory.Count > 50)
                    {
                        context.MessageHistory = context.MessageHistory
                            .OrderByDescending(m => m.Timestamp)
                            .Take(50)
                            .ToList();
                    }

                    context.LastActivity = DateTime.UtcNow;
                }
            }
            return Task.CompletedTask;
        }

        public string BuildContextualPrompt(ConversationContext context, string currentMessage)
        {
            var prompt = new List<string>();

            // System context
            prompt.Add("CONVERSATION CONTEXT:");
            prompt.Add($"- User: {context.UserProfile.Name ?? "Guest"}");
            prompt.Add($"- State: {context.CurrentState}");
            prompt.Add($"- Session Duration: {DateTime.UtcNow - context.MessageHistory.FirstOrDefault()?.Timestamp ?? TimeSpan.Zero}");

            // Current topics and entities
            if (context.Topics.Any())
            {
                prompt.Add($"- Current Topics: {string.Join(", ", context.Topics.Keys)}");
            }

            if (context.Entities.Any())
            {
                prompt.Add("- Mentioned Entities:");
                foreach (var entity in context.Entities.Take(5))
                {
                    prompt.Add($"  * {entity.Key}: {entity.Value}");
                }
            }

            // Recent conversation
            var recentMessages = context.MessageHistory
                .OrderByDescending(m => m.Timestamp)
                .Take(6)
                .Reverse()
                .ToList();

            if (recentMessages.Any())
            {
                prompt.Add("\nRECENT CONVERSATION:");
                foreach (var msg in recentMessages)
                {
                    prompt.Add($"{msg.Sender}: {msg.Content}");
                }
            }

            // User preferences
            if (context.Preferences.Any())
            {
                prompt.Add("\nUSER PREFERENCES:");
                foreach (var pref in context.Preferences)
                {
                    prompt.Add($"- {pref.Key}: {pref.Value}");
                }
            }

            prompt.Add($"\nCURRENT MESSAGE: {currentMessage}");

            return string.Join("\n", prompt);
        }

        public void ResetContext(string sessionId)
        {
            lock (_lock)
            {
                if (_activeContexts.ContainsKey(sessionId))
                {
                    var context = _activeContexts[sessionId];
                    context.CurrentState = ConversationState.Discovery;
                    context.Topics.Clear();
                    context.Entities.Clear();
                    context.LastActivity = DateTime.UtcNow;
                }
            }
        }

        public bool ShouldEscalate(ConversationContext context, double confidenceScore)
        {
            // Escalate if confidence is too low
            if (confidenceScore < 0.5) return true;

            // Escalate if user seems frustrated (multiple failed attempts)
            var recentFailures = context.MessageHistory
                .Where(m => m.Sender == "ai" && m.Timestamp > DateTime.UtcNow.AddMinutes(-10))
                .Count(m => m.Content.Contains("khÃ´ng hiá»ƒu") || m.Content.Contains("chuyá»ƒn chuyÃªn viÃªn"));

            if (recentFailures >= 2) return true;

            // Escalate for complex technical issues
            var complexKeywords = new[] { "lá»—i phá»©c táº¡p", "khÃ´ng kháº¯c phá»¥c Ä‘Æ°á»£c", "cáº§n ká»¹ thuáº­t viÃªn" };
            var hasComplexIssue = context.MessageHistory
                .Where(m => m.Sender == "user" && m.Timestamp > DateTime.UtcNow.AddMinutes(-5))
                .Any(m => complexKeywords.Any(k => m.Content.ToLower().Contains(k)));

            return hasComplexIssue;
        }

        private async Task<UserProfile> LoadUserProfile(int userId)
        {
            var user = await _context.Users.FindAsync(userId);
            if (user == null) return new UserProfile();

            // Load user order history for context
            var orders = await _context.Orders
                .Where(o => o.UserId == userId)
                .OrderByDescending(o => o.OrderDate)
                .Take(5)
                .Select(o => new { o.Id, o.OrderStatus, o.TotalAmount, o.OrderDate })
                .ToListAsync();

            return new UserProfile
            {
                Name = user.FullName,
                Email = user.Email,
                Phone = user.PhoneNumber,
                IsVIP = false, // Simplified for now
                TotalOrders = orders.Count(),
                RecentOrders = orders.Select(o => $"#{o.Id} - {o.OrderStatus} - {o.TotalAmount:C}").ToList(),
                JoinDate = user.CreatedAt
            };
        }

        private void AnalyzeConversationState(ConversationContext context)
        {
            if (!context.MessageHistory.Any())
            {
                context.CurrentState = ConversationState.Greeting;
                return;
            }

            var recentIntents = context.MessageHistory
                .Where(m => m.Sender == "user")
                .OrderByDescending(m => m.Timestamp)
                .Take(3)
                .Select(m => m.Intent)
                .ToList();

            // Determine state based on recent intents
            if (recentIntents.Any(i => i == "product_search" || i == "product_compare"))
            {
                context.CurrentState = ConversationState.ProductDiscovery;
            }
            else if (recentIntents.Any(i => i == "price_inquiry"))
            {
                context.CurrentState = ConversationState.PriceNegotiation;
            }
            else if (recentIntents.Any(i => i == "order_status"))
            {
                context.CurrentState = ConversationState.OrderSupport;
            }
            else if (recentIntents.Any(i => i == "technical_support"))
            {
                context.CurrentState = ConversationState.TechnicalSupport;
            }
            else
            {
                context.CurrentState = ConversationState.Discovery;
            }
        }

        private void UpdateEntitiesAndTopics(ConversationContext context, string intent,
            Dictionary<string, object>? entities)
        {
            // Update current topic
            context.Topics[intent] = DateTime.UtcNow;

            // Clean old topics (older than 10 minutes)
            var cutoff = DateTime.UtcNow.AddMinutes(-10);
            var oldTopics = context.Topics.Where(t => t.Value < cutoff).Select(t => t.Key).ToList();
            foreach (var topic in oldTopics)
            {
                context.Topics.Remove(topic);
            }

            // Update entities
            if (entities != null)
            {
                foreach (var entity in entities)
                {
                    context.Entities[entity.Key] = entity.Value;
                }
            }
        }

        private void UpdateConversationState(ConversationContext context, string intent)
        {
            context.CurrentState = intent switch
            {
                "greeting" => ConversationState.Greeting,
                "product_search" or "product_compare" => ConversationState.ProductDiscovery,
                "price_inquiry" => ConversationState.PriceNegotiation,
                "order_status" => ConversationState.OrderSupport,
                "technical_support" => ConversationState.TechnicalSupport,
                "thanks" => ConversationState.Closing,
                _ => ConversationState.Discovery
            };
        }

        // Cleanup old contexts periodically
        public void CleanupExpiredContexts()
        {
            lock (_lock)
            {
                var expiredKeys = _activeContexts
                    .Where(kvp => kvp.Value.LastActivity.AddMinutes(30) < DateTime.UtcNow)
                    .Select(kvp => kvp.Key)
                    .ToList();

                foreach (var key in expiredKeys)
                {
                    _activeContexts.Remove(key);
                }
            }
        }
    }

    public class ConversationContext
    {
        public string SessionId { get; set; } = string.Empty;
        public int? UserId { get; set; }
        public DateTime LastActivity { get; set; }
        public ConversationState CurrentState { get; set; }
        public List<ContextMessage> MessageHistory { get; set; } = new();
        public UserProfile UserProfile { get; set; } = new();
        public Dictionary<string, DateTime> Topics { get; set; } = new();
        public Dictionary<string, object> Entities { get; set; } = new();
        public Dictionary<string, string> Preferences { get; set; } = new();
    }

    public class ContextMessage
    {
        public string Content { get; set; } = string.Empty;
        public string Sender { get; set; } = string.Empty;
        public DateTime Timestamp { get; set; }
        public string Intent { get; set; } = string.Empty;
        public Dictionary<string, object> Entities { get; set; } = new();
    }

    public class UserProfile
    {
        public string Name { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Phone { get; set; } = string.Empty;
        public bool IsVIP { get; set; }
        public int TotalOrders { get; set; }
        public List<string> RecentOrders { get; set; } = new();
        public DateTime? JoinDate { get; set; }
    }

    public enum ConversationState
    {
        Greeting,
        Discovery,
        ProductDiscovery,
        PriceNegotiation,
        OrderSupport,
        TechnicalSupport,
        Closing,
        Escalated
    }
}

```

### Services\DatabaseSeeder.cs
```cs
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.Models;
using SHN_Gear.Services;

namespace SHN_Gear.Services
{
    public class DatabaseSeeder
    {
        private readonly AppDbContext _context;
        private readonly ILogger<DatabaseSeeder> _logger;

        public DatabaseSeeder(AppDbContext context, ILogger<DatabaseSeeder> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task SeedAsync()
        {
            try
            {
                // Seed AI Knowledge Base if empty
                if (!_context.AIKnowledgeBases.Any())
                {
                    _logger.LogInformation("Seeding AI Knowledge Base...");
                    await SeedAIKnowledgeBase();
                }

                // You can add other seeding methods here
                // await SeedDefaultAdminUsers();
                // await SeedProductCategories();

                await _context.SaveChangesAsync();
                _logger.LogInformation("Database seeding completed successfully.");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "An error occurred while seeding the database.");
                throw;
            }
        }

        private async Task SeedAIKnowledgeBase()
        {
            var knowledgeEntries = KnowledgeBaseSeeder.GetDefaultKnowledgeBase();

            await _context.AIKnowledgeBases.AddRangeAsync(knowledgeEntries);

            _logger.LogInformation($"Added {knowledgeEntries.Count} AI knowledge base entries.");
        }

        public async Task SeedSpecificProductKnowledge()
        {
            // Seed knowledge vá» sáº£n pháº©m cá»¥ thá»ƒ tá»« database
            var products = await _context.Products
                .Include(p => p.Category)
                .Include(p => p.Brand)
                .Include(p => p.Variants)
                .Take(20) // Top 20 sáº£n pháº©m phá»• biáº¿n
                .ToListAsync();

            var productKnowledge = new List<AIKnowledgeBase>();

            foreach (var product in products)
            {
                // Táº¡o knowledge entry cho tá»«ng sáº£n pháº©m
                productKnowledge.Add(new AIKnowledgeBase
                {
                    Topic = "product_specific",
                    Question = $"ThÃ´ng tin vá» {product.Name}",
                    Answer = $"ğŸ“± {product.Name}\n" +
                            $"ğŸ’° GiÃ¡: {product.Variants.FirstOrDefault()?.Price:C}\n" +
                            $"ğŸ·ï¸ Danh má»¥c: {product.Category?.Name}\n" +
                            $"ğŸ¢ ThÆ°Æ¡ng hiá»‡u: {product.Brand?.Name}\n" +
                            $"ğŸ“ MÃ´ táº£: {(product.Description?.Length > 200 ? product.Description.Substring(0, 200) + "..." : product.Description)}\n\n" +
                            $"ğŸ‘‰ Xem chi tiáº¿t táº¡i: /products/{product.Id}",
                    Keywords = [product.Name.ToLower(), product.Brand?.Name?.ToLower() ?? "", product.Category?.Name?.ToLower() ?? ""],
                    Category = KnowledgeCategory.ProductInfo,
                    Priority = 5,
                    ProductCategoryIds = $"[{product.CategoryId}]",
                    BrandIds = $"[{product.BrandId}]",
                    IsActive = true,
                    MinConfidenceScore = 0.6m,
                    EscalationThreshold = 0.3m
                });
            }

            await _context.AIKnowledgeBases.AddRangeAsync(productKnowledge);
            await _context.SaveChangesAsync();

            _logger.LogInformation($"Added {productKnowledge.Count} product-specific knowledge entries.");
        }
    }
}

```

### Services\EmailService.cs
```cs
using System;
using System.Security.Cryptography;
using System.Text;
using System.Threading.Tasks;
using MailKit.Net.Smtp;
using MailKit.Security;
using Microsoft.Extensions.Configuration;
using MimeKit;
namespace SHN_Gear.Services
{
public class EmailService
{
    private readonly IConfiguration _config;

    public EmailService(IConfiguration config)
    {
        _config = config;
    }

    public async Task<bool> SendOTPAsync(string recipientEmail)
    {
        try
        {
            var emailSettings = _config.GetSection("EmailSettings");
            string otpCode = GenerateOTP();

            var message = new MimeMessage();
            message.From.Add(new MailboxAddress("SHN Gear", emailSettings["SenderEmail"]));
            message.To.Add(new MailboxAddress("", recipientEmail));
            message.Subject = "MÃ£ OTP cá»§a báº¡n";
            message.Body = new TextPart("plain") { Text = $"MÃ£ OTP cá»§a báº¡n lÃ : {otpCode}" };

            using var client = new SmtpClient();
            await client.ConnectAsync(emailSettings["SMTPHost"], int.Parse(emailSettings["SMTPPort"]), SecureSocketOptions.StartTls);
            await client.AuthenticateAsync(emailSettings["SenderEmail"], emailSettings["SenderPassword"]);
            await client.SendAsync(message);
            await client.DisconnectAsync(true);

            return true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Lá»—i gá»­i email: {ex.Message}");
            return false;
        }
    }

    private string GenerateOTP()
    {
        using var rng = new RNGCryptoServiceProvider();
        var data = new byte[4];
        rng.GetBytes(data);
        int otp = BitConverter.ToUInt16(data, 0) % 1000000;
        return otp.ToString("D6");
    }
}
}
```

### Services\GeminiService.cs
```cs
using System.Text;
using System.Text.Json;
using System.Globalization;
using Microsoft.Extensions.Caching.Memory;
using SHN_Gear.DTOs;

namespace SHN_Gear.Services
{
    public class GeminiService
    {
        private readonly HttpClient _httpClient;
        private readonly IConfiguration _configuration;
        private readonly ILogger<GeminiService> _logger;
        private readonly IMemoryCache _cache;
        private readonly string _apiKey;
        private readonly string _model;
        private readonly string _baseUrl;

        public GeminiService(HttpClient httpClient, IConfiguration configuration, ILogger<GeminiService> logger, IMemoryCache cache)
        {
            _httpClient = httpClient;
            _configuration = configuration;
            _logger = logger;
            _cache = cache;

            _apiKey = _configuration["AIConfig:Gemini:ApiKey"] ?? throw new ArgumentNullException("Gemini API Key not configured");
            _model = _configuration["AIConfig:Gemini:Model"] ?? "gemini-1.5-flash";
            _baseUrl = _configuration["AIConfig:Gemini:BaseUrl"] ?? "https://generativelanguage.googleapis.com/v1beta/models";
        }

        // Äá»c tri thá»©c website tá»« file JSON (cache trong memory)
        private static string? _websiteKnowledgeCache = null;
        private static DateTime _websiteKnowledgeCacheTime = DateTime.MinValue;
        private static readonly object _knowledgeLock = new();

        private string GetWebsiteKnowledge()
        {
            lock (_knowledgeLock)
            {
                if (_websiteKnowledgeCache != null && (DateTime.Now - _websiteKnowledgeCacheTime).TotalMinutes < 10)
                    return _websiteKnowledgeCache;
                try
                {
                    var path = Path.Combine(AppContext.BaseDirectory, "Data", "WebsiteKnowledgeBase.json");
                    if (File.Exists(path))
                    {
                        var json = File.ReadAllText(path);
                        using var doc = JsonDocument.Parse(json);
                        var root = doc.RootElement;
                        var sb = new StringBuilder();
                        if (root.TryGetProperty("websiteName", out var websiteName))
                            sb.AppendLine($"TÃªn website: {websiteName.GetString()}");
                        if (root.TryGetProperty("description", out var description))
                            sb.AppendLine($"MÃ´ táº£: {description.GetString()}");
                        if (root.TryGetProperty("contact", out var contact))
                        {
                            sb.AppendLine("ThÃ´ng tin liÃªn há»‡:");
                            if (contact.TryGetProperty("hotline", out var hotline))
                                sb.AppendLine($"- Hotline: {hotline.GetString()}");
                            if (contact.TryGetProperty("email", out var email))
                                sb.AppendLine($"- Email: {email.GetString()}");
                            if (contact.TryGetProperty("address", out var address))
                                sb.AppendLine($"- Äá»‹a chá»‰: {address.GetString()}");
                        }
                        if (root.TryGetProperty("policies", out var policies))
                        {
                            sb.AppendLine("\nChÃ­nh sÃ¡ch:");
                            if (policies.TryGetProperty("shipping", out var shipping) && !string.IsNullOrWhiteSpace(shipping.GetString()))
                                sb.AppendLine($"- Váº­n chuyá»ƒn: {shipping.GetString()}");
                            if (policies.TryGetProperty("return", out var returns) && !string.IsNullOrWhiteSpace(returns.GetString()))
                                sb.AppendLine($"- Äá»•i tráº£: {returns.GetString()}");
                            if (policies.TryGetProperty("warranty", out var warranty) && !string.IsNullOrWhiteSpace(warranty.GetString()))
                                sb.AppendLine($"- Báº£o hÃ nh: {warranty.GetString()}");
                        }
                        if (root.TryGetProperty("faq", out var faq) && faq.ValueKind == JsonValueKind.Array && faq.GetArrayLength() > 0)
                        {
                            sb.AppendLine("\nCÃ¡c cÃ¢u há»i thÆ°á»ng gáº·p:");
                            foreach (var item in faq.EnumerateArray())
                            {
                                var q = item.TryGetProperty("question", out var qv) ? qv.GetString() : null;
                                var a = item.TryGetProperty("answer", out var av) ? av.GetString() : null;
                                if (!string.IsNullOrWhiteSpace(q) && !string.IsNullOrWhiteSpace(a))
                                {
                                    sb.AppendLine($"- Q: {q}");
                                    sb.AppendLine($"  A: {a}");
                                }
                            }
                        }
                        if (root.TryGetProperty("products", out var products) && products.ValueKind == JsonValueKind.Array && products.GetArrayLength() > 0)
                        {
                            sb.AppendLine("\nMá»™t sá»‘ sáº£n pháº©m tiÃªu biá»ƒu:");
                            int count = 0;
                            foreach (var item in products.EnumerateArray())
                            {
                                if (count++ >= 10) break; // chá»‰ láº¥y 10 sáº£n pháº©m Ä‘áº§u
                                var name = item.TryGetProperty("name", out var nv) ? nv.GetString() : null;
                                var cat = item.TryGetProperty("category", out var cv) ? cv.GetString() : null;
                                var brand = item.TryGetProperty("brand", out var bv) ? bv.GetString() : null;
                                var price = item.TryGetProperty("price", out var pv) ? pv.GetString() : null;
                                if (!string.IsNullOrWhiteSpace(name))
                                {
                                    sb.Append("- ");
                                    sb.Append(name);
                                    if (!string.IsNullOrWhiteSpace(cat)) sb.Append($" ({cat}");
                                    if (!string.IsNullOrWhiteSpace(brand)) sb.Append($", {brand}");
                                    if (!string.IsNullOrWhiteSpace(cat) || !string.IsNullOrWhiteSpace(brand)) sb.Append(")");
                                    if (!string.IsNullOrWhiteSpace(price)) sb.Append($": {price}");
                                    sb.AppendLine();
                                }
                            }
                        }
                        _websiteKnowledgeCache = sb.ToString();
                        _websiteKnowledgeCacheTime = DateTime.Now;
                        return _websiteKnowledgeCache;
                    }
                }
                catch { }
                return string.Empty;
            }
        }

        public async Task<string> GenerateResponseAsync(string userMessage, string context = "", string intent = "general")
        {
            try
            {
                // ÄÆ°a tri thá»©c website vÃ o context cho Gemini
                var websiteKnowledge = GetWebsiteKnowledge();
                var fullContext = string.IsNullOrEmpty(context) ? websiteKnowledge : (websiteKnowledge + "\n" + context);
                var prompt = BuildPrompt(userMessage, fullContext, intent);
                string cacheKey = $"Gemini:{intent}:{prompt.GetHashCode()}";
                if (_cache.TryGetValue(cacheKey, out string? cachedResponse) && cachedResponse != null)
                {
                    _logger.LogInformation($"[GeminiService] Cache hit for key: {cacheKey}");
                    return cachedResponse;
                }

                // Parse and validate temperature
                var tempValue = double.Parse(_configuration["AIConfig:Gemini:Temperature"] ?? "0.7", CultureInfo.InvariantCulture);
                if (tempValue < 0.0 || tempValue > 2.0)
                {
                    _logger.LogWarning("Temperature value {Temperature} is out of range [0.0, 2.0]. Using default 0.7", tempValue);
                    tempValue = 0.7;
                }

                // Parse and validate maxTokens
                var maxTokens = int.Parse(_configuration["AIConfig:Gemini:MaxTokens"] ?? "150", CultureInfo.InvariantCulture);
                if (maxTokens <= 0 || maxTokens > 8192)
                {
                    _logger.LogWarning("MaxTokens value {MaxTokens} is out of range. Using default 150", maxTokens);
                    maxTokens = 150;
                }

                var requestBody = new
                {
                    contents = new[]
                    {
                        new
                        {
                            parts = new[]
                            {
                                new { text = prompt }
                            }
                        }
                    },
                    generationConfig = new
                    {
                        temperature = tempValue,
                        maxOutputTokens = maxTokens,
                        topP = 0.8,
                        topK = 10
                    }
                };

                var json = JsonSerializer.Serialize(requestBody, new JsonSerializerOptions
                {
                    PropertyNamingPolicy = JsonNamingPolicy.CamelCase
                });

                var content = new StringContent(json, Encoding.UTF8, "application/json");

                var url = $"{_baseUrl}/{_model}:generateContent?key={_apiKey}";
                var response = await _httpClient.PostAsync(url, content);

                if (response.IsSuccessStatusCode)
                {
                    var responseContent = await response.Content.ReadAsStringAsync();
                    _logger.LogInformation($"[GeminiService] Gemini API response: {responseContent}");
                    var geminiResponse = JsonSerializer.Deserialize<GeminiResponse>(responseContent);
                    var result = geminiResponse?.Candidates?.FirstOrDefault()?.Content?.Parts?.FirstOrDefault()?.Text
                        ?? "Xin lá»—i, tÃ´i khÃ´ng thá»ƒ xá»­ lÃ½ yÃªu cáº§u cá»§a báº¡n lÃºc nÃ y.";
                    _cache.Set(cacheKey, result, TimeSpan.FromMinutes(5));
                    return result;
                }
                else
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    _logger.LogError($"[GeminiService] Gemini API error: StatusCode={response.StatusCode}, Content={errorContent}, Url={url}, Prompt={prompt}");
                    return "Xin lá»—i, cÃ³ lá»—i xáº£y ra khi xá»­ lÃ½ yÃªu cáº§u cá»§a báº¡n.";
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"[GeminiService] Exception when calling Gemini API. Prompt: {userMessage}, Context: {context}, Intent: {intent}");
                return "Xin lá»—i, cÃ³ lá»—i xáº£y ra khi xá»­ lÃ½ yÃªu cáº§u cá»§a báº¡n.";
            }
        }

        private string BuildPrompt(string userMessage, string context, string intent)
        {
            var promptBuilder = new StringBuilder();

            promptBuilder.AppendLine("Báº¡n lÃ  SHN Assistant, trá»£ lÃ½ AI thÃ´ng minh cá»§a cá»­a hÃ ng SHN-Gear chuyÃªn bÃ¡n Ä‘iá»‡n thoáº¡i, laptop vÃ  tai nghe.");
            promptBuilder.AppendLine("Nhiá»‡m vá»¥ cá»§a báº¡n lÃ  há»— trá»£ khÃ¡ch hÃ ng má»™t cÃ¡ch thÃ¢n thiá»‡n, chÃ­nh xÃ¡c vÃ  há»¯u Ã­ch.");
            promptBuilder.AppendLine();

            // Context information
            if (!string.IsNullOrEmpty(context))
            {
                promptBuilder.AppendLine("Bá»‘i cáº£nh cuá»™c trÃ² chuyá»‡n:");
                promptBuilder.AppendLine(context);
                promptBuilder.AppendLine();
            }

            // Intent-specific instructions
            switch (intent.ToLower())
            {
                case "product_search":
                    promptBuilder.AppendLine("KhÃ¡ch hÃ ng Ä‘ang tÃ¬m kiáº¿m sáº£n pháº©m. HÃ£y:");
                    promptBuilder.AppendLine("- Há»i vá» nhu cáº§u cá»¥ thá»ƒ (má»¥c Ä‘Ã­ch sá»­ dá»¥ng, ngÃ¢n sÃ¡ch)");
                    promptBuilder.AppendLine("- ÄÆ°a ra gá»£i Ã½ phÃ¹ há»£p");
                    promptBuilder.AppendLine("- Giá»›i thiá»‡u Æ°u Ä‘iá»ƒm cá»§a sáº£n pháº©m");
                    break;

                case "price_inquiry":
                    promptBuilder.AppendLine("KhÃ¡ch hÃ ng há»i vá» giÃ¡. HÃ£y:");
                    promptBuilder.AppendLine("- ThÃ´ng bÃ¡o ráº±ng giÃ¡ cÃ³ thá»ƒ thay Ä‘á»•i theo thá»i gian");
                    promptBuilder.AppendLine("- Äá» xuáº¥t liÃªn há»‡ Ä‘á»ƒ cÃ³ giÃ¡ chÃ­nh xÃ¡c nháº¥t");
                    promptBuilder.AppendLine("- Giá»›i thiá»‡u cÃ¡c chÆ°Æ¡ng trÃ¬nh khuyáº¿n mÃ£i hiá»‡n cÃ³");
                    break;

                case "technical_support":
                    promptBuilder.AppendLine("KhÃ¡ch hÃ ng cáº§n há»— trá»£ ká»¹ thuáº­t. HÃ£y:");
                    promptBuilder.AppendLine("- Há»i chi tiáº¿t vá» váº¥n Ä‘á»");
                    promptBuilder.AppendLine("- ÄÆ°a ra hÆ°á»›ng dáº«n cÆ¡ báº£n");
                    promptBuilder.AppendLine("- Äá» xuáº¥t liÃªn há»‡ ká»¹ thuáº­t viÃªn náº¿u cáº§n");
                    break;

                default:
                    promptBuilder.AppendLine("HÃ£y tráº£ lá»i má»™t cÃ¡ch thÃ¢n thiá»‡n vÃ  há»¯u Ã­ch.");
                    break;
            }

            promptBuilder.AppendLine();
            promptBuilder.AppendLine("YÃªu cáº§u quan trá»ng:");
            promptBuilder.AppendLine("- Tráº£ lá»i báº±ng tiáº¿ng Viá»‡t");
            promptBuilder.AppendLine("- Giá»¯ phong cÃ¡ch thÃ¢n thiá»‡n, chuyÃªn nghiá»‡p");
            promptBuilder.AppendLine("- Tráº£ lá»i ngáº¯n gá»n, khÃ´ng quÃ¡ 150 tá»«");
            promptBuilder.AppendLine("- Náº¿u khÃ´ng cháº¯c cháº¯n, hÃ£y Ä‘á» xuáº¥t liÃªn há»‡ nhÃ¢n viÃªn tÆ° váº¥n");
            promptBuilder.AppendLine();

            promptBuilder.AppendLine("Tin nháº¯n cá»§a khÃ¡ch hÃ ng:");
            promptBuilder.AppendLine(userMessage);

            return promptBuilder.ToString();
        }

        public async Task<double> CalculateConfidenceScoreAsync(string userMessage, string intent)
        {
            try
            {
                var prompt = $@"
ÄÃ¡nh giÃ¡ Ä‘á»™ tin cáº­y cá»§a viá»‡c tráº£ lá»i cÃ¢u há»i sau vá»›i Ã½ Ä‘á»‹nh '{intent}'.
Tráº£ vá» má»™t sá»‘ tá»« 0.0 Ä‘áº¿n 1.0 (vÃ­ dá»¥: 0.8):

CÃ¢u há»i: {userMessage}
Ã Ä‘á»‹nh: {intent}

Chá»‰ tráº£ vá» sá»‘, khÃ´ng giáº£i thÃ­ch:";

                var response = await GenerateResponseAsync(prompt, "", "confidence_evaluation");

                if (double.TryParse(response.Trim(), out double confidence))
                {
                    return Math.Max(0.0, Math.Min(1.0, confidence));
                }

                return 0.5; // Default medium confidence
            }
            catch
            {
                return 0.5; // Default medium confidence on error
            }
        }
    }

    // Response model classes for Gemini API
    public class GeminiResponse
    {
        public GeminiCandidate[]? Candidates { get; set; }
    }

    public class GeminiCandidate
    {
        public GeminiContent? Content { get; set; }
    }

    public class GeminiContent
    {
        public GeminiPart[]? Parts { get; set; }
    }

    public class GeminiPart
    {
        public string? Text { get; set; }
    }
}

```

### Services\ICloudinaryService.cs
```cs
public interface ICloudinaryService
{
    Task<string> UploadImageAsync(IFormFile file);
    Task DeleteImageAsync(string publicId);
}
```

### Services\JwtService.cs
```cs
using System;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;
using Microsoft.Extensions.Configuration;
using Microsoft.IdentityModel.Tokens;
using SHN_Gear.Models;

namespace SHN_Gear.Services
{
    public class JwtService
    {
        private readonly IConfiguration _config;

        public JwtService(IConfiguration config)
        {
            _config = config;
        }

        public string GenerateToken(User user)
        {
            var key = Encoding.UTF8.GetBytes(_config["Jwt:Key"]);
            var tokenHandler = new JwtSecurityTokenHandler();

            // Äáº·t thá»i gian sá»‘ng token tá»‘i Ä‘a 60 phÃºt
            var tokenDescriptor = new SecurityTokenDescriptor
            {
                Subject = new ClaimsIdentity(new[]
                {
                    new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),
                    new Claim(ClaimTypes.Name, user.FullName),
                    new Claim(ClaimTypes.Email, user.Email),
                    new Claim(ClaimTypes.Role, user.Role.Name)
                }),
                Expires = DateTime.UtcNow.AddMinutes(60), // Giá»›i háº¡n token 60 phÃºt
                Issuer = _config["Jwt:Issuer"],
                Audience = _config["Jwt:Audience"],
                SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)
            };

            var token = tokenHandler.CreateToken(tokenDescriptor);
            return tokenHandler.WriteToken(token);
        }
    }
}

```

### Services\KnowledgeBaseSeeder.cs
```cs
using SHN_Gear.Models;

namespace SHN_Gear.Services
{
    public class KnowledgeBaseSeeder
    {
        public static List<AIKnowledgeBase> GetDefaultKnowledgeBase()
        {
            return new List<AIKnowledgeBase>
            {
                // PRODUCT INFO
                new AIKnowledgeBase
                {
                    Topic = "product_info",
                    Question = "CÃ³ nhá»¯ng loáº¡i sáº£n pháº©m gÃ¬?",
                    Answer = "SHN-Gear chuyÃªn cung cáº¥p 3 loáº¡i sáº£n pháº©m chÃ­nh:\n" +
                            "ğŸ“± Äiá»‡n thoáº¡i: iPhone, Samsung Galaxy, Xiaomi, Oppo, Vivo\n" +
                            "ğŸ’» Laptop: MacBook, Dell, HP, Asus, Acer, Lenovo\n" +
                            "ğŸ§ Tai nghe: AirPods, Sony, JBL, Beats, Samsung Buds\n\n" +
                            "Táº¥t cáº£ Ä‘á»u lÃ  hÃ ng chÃ­nh hÃ£ng, báº£o hÃ nh Ä‘áº§y Ä‘á»§!",
                    Keywords = ["sáº£n pháº©m", "bÃ¡n gÃ¬", "cÃ³ gÃ¬", "loáº¡i nÃ o", "categories"],
                    Category = KnowledgeCategory.ProductInfo,
                    Priority = 10,
                    MinConfidenceScore = 0.8m
                },

                new AIKnowledgeBase
                {
                    Topic = "product_info",
                    Question = "iPhone cÃ³ nhá»¯ng phiÃªn báº£n nÃ o?",
                    Answer = "Hiá»‡n táº¡i SHN-Gear cÃ³ Ä‘áº§y Ä‘á»§ cÃ¡c dÃ²ng iPhone:\n" +
                            "ğŸ”¥ iPhone 15 Series: 15, 15 Plus, 15 Pro, 15 Pro Max\n" +
                            "ğŸ“± iPhone 14 Series: 14, 14 Plus, 14 Pro, 14 Pro Max\n" +
                            "ğŸ’« iPhone 13 Series: 13, 13 mini, 13 Pro, 13 Pro Max\n" +
                            "âš¡ iPhone 12 Series vÃ  iPhone SE\n\n" +
                            "Táº¥t cáº£ Ä‘á»u VN/A chÃ­nh hÃ£ng, Ä‘á»§ mÃ u Ä‘á»§ dung lÆ°á»£ng!",
                    Keywords = ["iphone", "apple", "ip", "Ä‘iá»‡n thoáº¡i apple"],
                    Category = KnowledgeCategory.ProductInfo,
                    Priority = 9,
                    ProductCategoryIds = "[1]", // Phone category
                    BrandIds = "[1]" // Apple brand (giáº£ sá»­)
                },

                // PRICING
                new AIKnowledgeBase
                {
                    Topic = "pricing",
                    Question = "CÃ³ chÆ°Æ¡ng trÃ¬nh khuyáº¿n mÃ£i khÃ´ng?",
                    Answer = "SHN-Gear luÃ´n cÃ³ nhiá»u chÆ°Æ¡ng trÃ¬nh háº¥p dáº«n:\n" +
                            "ğŸ‰ Flash Sale cuá»‘i tuáº§n: giáº£m Ä‘áº¿n 30%\n" +
                            "ğŸ’³ Tráº£ gÃ³p 0%: 6-12 thÃ¡ng khÃ´ng lÃ£i suáº¥t\n" +
                            "ğŸ Táº·ng phá»¥ kiá»‡n: á»‘p lÆ°ng, cÃ¡p sáº¡c, tai nghe\n" +
                            "ğŸ’° Thu cÅ© Ä‘á»•i má»›i: giÃ¡ cao, thá»§ tá»¥c nhanh\n" +
                            "ğŸ·ï¸ Voucher sinh nháº­t: Æ°u Ä‘Ã£i Ä‘áº·c biá»‡t\n\n" +
                            "Theo dÃµi fanpage Ä‘á»ƒ cáº­p nháº­t khuyáº¿n mÃ£i má»›i nháº¥t nhÃ©!",
                    Keywords = ["khuyáº¿n mÃ£i", "giáº£m giÃ¡", "Æ°u Ä‘Ã£i", "sale", "promotion"],
                    Category = KnowledgeCategory.Pricing,
                    Priority = 9
                },

                new AIKnowledgeBase
                {
                    Topic = "pricing",
                    Question = "CÃ³ tráº£ gÃ³p khÃ´ng?",
                    Answer = "CÃ³! SHN-Gear há»— trá»£ nhiá»u hÃ¬nh thá»©c tráº£ gÃ³p:\n" +
                            "ğŸ¦ Tráº£ gÃ³p qua tháº» tÃ­n dá»¥ng: 3-24 thÃ¡ng\n" +
                            "ğŸ’³ Tráº£ gÃ³p 0% lÃ£i suáº¥t: 6-12 thÃ¡ng\n" +
                            "ğŸ“± Tráº£ gÃ³p online: duyá»‡t nhanh 15 phÃºt\n" +
                            "ğŸª Tráº£ gÃ³p táº¡i cá»­a hÃ ng: thá»§ tá»¥c Ä‘Æ¡n giáº£n\n\n" +
                            "Äiá»u kiá»‡n: CMND + sá»• há»™ kháº©u. Tá»« 18 tuá»•i trá»Ÿ lÃªn.",
                    Keywords = ["tráº£ gÃ³p", "installment", "gÃ³p", "tráº£ cháº­m"],
                    Category = KnowledgeCategory.Pricing,
                    Priority = 8
                },

                // SHIPPING
                new AIKnowledgeBase
                {
                    Topic = "shipping",
                    Question = "Giao hÃ ng máº¥t bao lÃ¢u?",
                    Answer = "Thá»i gian giao hÃ ng tÃ¹y theo khu vá»±c:\n" +
                            "ğŸï¸ Ná»™i thÃ nh HN, HCM: 2-4 giá» (giao nhanh)\n" +
                            "ğŸšš CÃ¡c tá»‰nh thÃ nh khÃ¡c: 1-3 ngÃ y lÃ m viá»‡c\n" +
                            "ğŸ“¦ VÃ¹ng xa, miá»n nÃºi: 3-5 ngÃ y lÃ m viá»‡c\n" +
                            "âš¡ Giao siÃªu tá»‘c: trong 1 giá» (má»™t sá»‘ khu vá»±c)\n\n" +
                            "ğŸ“ Shipper sáº½ gá»i trÆ°á»›c khi giao 30 phÃºt!",
                    Keywords = ["giao hÃ ng", "ship", "delivery", "bao lÃ¢u", "khi nÃ o"],
                    Category = KnowledgeCategory.Shipping,
                    Priority = 9
                },

                new AIKnowledgeBase
                {
                    Topic = "shipping",
                    Question = "PhÃ­ giao hÃ ng bao nhiÃªu?",
                    Answer = "ChÃ­nh sÃ¡ch giao hÃ ng cá»§a SHN-Gear:\n" +
                            "ğŸ†“ Miá»…n phÃ­: Ä‘Æ¡n hÃ ng tá»« 500,000Ä‘\n" +
                            "ğŸï¸ Giao nhanh ná»™i thÃ nh: 30,000Ä‘\n" +
                            "ğŸšš Giao tiÃªu chuáº©n: 20,000-50,000Ä‘\n" +
                            "âš¡ Giao siÃªu tá»‘c (1h): 100,000Ä‘\n\n" +
                            "ğŸ’¡ Tip: Mua Ä‘á»§ 500k Ä‘á»ƒ Ä‘Æ°á»£c freeship nhÃ©!",
                    Keywords = ["phÃ­ giao hÃ ng", "phÃ­ ship", "shipping fee", "tiá»n ship"],
                    Category = KnowledgeCategory.Shipping,
                    Priority = 8
                },

                // RETURNS
                new AIKnowledgeBase
                {
                    Topic = "returns",
                    Question = "ChÃ­nh sÃ¡ch Ä‘á»•i tráº£ nhÆ° tháº¿ nÃ o?",
                    Answer = "ChÃ­nh sÃ¡ch Ä‘á»•i tráº£ linh hoáº¡t táº¡i SHN-Gear:\n" +
                            "â° Thá»i gian: 7 ngÃ y ká»ƒ tá»« ngÃ y mua\n" +
                            "ğŸ“¦ Äiá»u kiá»‡n: NguyÃªn seal, chÆ°a sá»­ dá»¥ng\n" +
                            "ğŸ“„ Giáº¥y tá»: HÃ³a Ä‘Æ¡n + phiáº¿u báº£o hÃ nh\n" +
                            "ğŸ’¸ HoÃ n tiá»n: 100% giÃ¡ trá»‹ sáº£n pháº©m\n" +
                            "ğŸ”„ Äá»•i sang SP khÃ¡c: náº¿u cÃ³ chÃªnh lá»‡ch\n\n" +
                            "ğŸª Äá»•i tráº£ táº¡i cá»­a hÃ ng hoáº·c gá»i hotline!",
                    Keywords = ["Ä‘á»•i tráº£", "return", "hoÃ n tiá»n", "Ä‘á»•i sáº£n pháº©m"],
                    Category = KnowledgeCategory.Returns,
                    Priority = 9
                },

                new AIKnowledgeBase
                {
                    Topic = "returns",
                    Question = "Báº£o hÃ nh nhÆ° tháº¿ nÃ o?",
                    Answer = "Cháº¿ Ä‘á»™ báº£o hÃ nh toÃ n diá»‡n:\n" +
                            "ğŸ“± Äiá»‡n thoáº¡i: 12 thÃ¡ng chÃ­nh hÃ£ng\n" +
                            "ğŸ’» Laptop: 12-24 thÃ¡ng tÃ¹y hÃ£ng\n" +
                            "ğŸ§ Tai nghe: 6-12 thÃ¡ng\n" +
                            "âš¡ Báº£o hÃ nh nhanh: 1-3 ngÃ y\n" +
                            "ğŸ”„ Äá»•i má»›i: náº¿u lá»—i NSX trong 30 ngÃ y\n\n" +
                            "ğŸ­ Trung tÃ¢m báº£o hÃ nh á»§y quyá»n chÃ­nh thá»©c!",
                    Keywords = ["báº£o hÃ nh", "warranty", "sá»­a chá»¯a", "lá»—i"],
                    Category = KnowledgeCategory.Returns,
                    Priority = 8
                },

                // ACCOUNT
                new AIKnowledgeBase
                {
                    Topic = "account",
                    Question = "LÃ m sao Ä‘á»ƒ Ä‘Äƒng kÃ½ tÃ i khoáº£n?",
                    Answer = "ÄÄƒng kÃ½ tÃ i khoáº£n SHN-Gear ráº¥t Ä‘Æ¡n giáº£n:\n" +
                            "1ï¸âƒ£ Click nÃºt 'ÄÄƒng kÃ½' gÃ³c pháº£i mÃ n hÃ¬nh\n" +
                            "2ï¸âƒ£ Nháº­p email + sá»‘ Ä‘iá»‡n thoáº¡i\n" +
                            "3ï¸âƒ£ Táº¡o máº­t kháº©u máº¡nh (8+ kÃ½ tá»±)\n" +
                            "4ï¸âƒ£ XÃ¡c thá»±c OTP qua SMS\n" +
                            "5ï¸âƒ£ HoÃ n thÃ nh thÃ´ng tin cÃ¡ nhÃ¢n\n\n" +
                            "ğŸ Táº·ng voucher 100k cho láº§n mua Ä‘áº§u tiÃªn!",
                    Keywords = ["Ä‘Äƒng kÃ½", "táº¡o tÃ i khoáº£n", "register", "sign up"],
                    Category = KnowledgeCategory.Account,
                    Priority = 7
                },

                // PAYMENT
                new AIKnowledgeBase
                {
                    Topic = "payment",
                    Question = "CÃ³ nhá»¯ng hÃ¬nh thá»©c thanh toÃ¡n nÃ o?",
                    Answer = "SHN-Gear há»— trá»£ Ä‘a dáº¡ng phÆ°Æ¡ng thá»©c thanh toÃ¡n:\n" +
                            "ğŸ’° Tiá»n máº·t: khi nháº­n hÃ ng (COD)\n" +
                            "ğŸ’³ Tháº» tÃ­n dá»¥ng: Visa, Master, JCB\n" +
                            "ğŸ¦ Chuyá»ƒn khoáº£n: ngÃ¢n hÃ ng, vÃ­ Ä‘iá»‡n tá»­\n" +
                            "ğŸ“± VÃ­ MoMo, ZaloPay, ShopeePay\n" +
                            "ğŸ’ PayPal: cho khÃ¡ch quá»‘c táº¿\n\n" +
                            "ğŸ”’ Báº£o máº­t SSL 256-bit, an toÃ n tuyá»‡t Ä‘á»‘i!",
                    Keywords = ["thanh toÃ¡n", "payment", "tráº£ tiá»n", "phÆ°Æ¡ng thá»©c"],
                    Category = KnowledgeCategory.Payment,
                    Priority = 8
                },

                // TECHNICAL SUPPORT
                new AIKnowledgeBase
                {
                    Topic = "technical",
                    Question = "Sáº£n pháº©m bá»‹ lá»—i thÃ¬ lÃ m sao?",
                    Answer = "Náº¿u sáº£n pháº©m gáº·p sá»± cá»‘, hÃ£y lÃ m theo hÆ°á»›ng dáº«n:\n" +
                            "1ï¸âƒ£ Kiá»ƒm tra láº¡i cÃ¡ch sá»­ dá»¥ng trong hÆ°á»›ng dáº«n\n" +
                            "2ï¸âƒ£ Restart/khá»Ÿi Ä‘á»™ng láº¡i thiáº¿t bá»‹\n" +
                            "3ï¸âƒ£ LiÃªn há»‡ hotline: 1900-XXX-XXX\n" +
                            "4ï¸âƒ£ Mang sáº£n pháº©m Ä‘áº¿n cá»­a hÃ ng kiá»ƒm tra\n" +
                            "5ï¸âƒ£ Báº£o hÃ nh/Ä‘á»•i má»›i náº¿u thuá»™c Ä‘iá»u kiá»‡n\n\n" +
                            "ğŸ”§ Team ká»¹ thuáº­t há»— trá»£ 24/7!",
                    Keywords = ["lá»—i", "há»ng", "khÃ´ng hoáº¡t Ä‘á»™ng", "sá»­a", "technical"],
                    Category = KnowledgeCategory.Technical,
                    Priority = 7,
                    EscalationThreshold = 0.2m // Lower threshold for technical issues - should escalate faster
                },

                // GENERAL
                new AIKnowledgeBase
                {
                    Topic = "general",
                    Question = "ThÃ´ng tin liÃªn há»‡ cá»­a hÃ ng?",
                    Answer = "ThÃ´ng tin liÃªn há»‡ SHN-Gear:\n" +
                            "ğŸ“ Äá»‹a chá»‰: [Äá»‹a chá»‰ cá»­a hÃ ng]\n" +
                            "ğŸ“ Hotline: 1900-XXX-XXX\n" +
                            "ğŸ“§ Email: support@shngear.com\n" +
                            "ğŸ•’ Giá» lÃ m viá»‡c: 8:00 - 22:00 (T2-CN)\n" +
                            "ğŸŒ Website: shngear.com\n" +
                            "ğŸ“˜ Facebook: fb.com/shngear\n\n" +
                            "ğŸ’¬ Chat online 24/7 táº¡i website!",
                    Keywords = ["liÃªn há»‡", "Ä‘á»‹a chá»‰", "hotline", "contact", "thÃ´ng tin"],
                    Category = KnowledgeCategory.General,
                    Priority = 6
                },

                new AIKnowledgeBase
                {
                    Topic = "general",
                    Question = "CÃ³ cá»­a hÃ ng offline khÃ´ng?",
                    Answer = "SHN-Gear cÃ³ há»‡ thá»‘ng cá»­a hÃ ng toÃ n quá»‘c:\n" +
                            "ğŸª HÃ  Ná»™i: 5 cá»­a hÃ ng\n" +
                            "ğŸª TP.HCM: 8 cá»­a hÃ ng\n" +
                            "ğŸª ÄÃ  Náºµng: 2 cá»­a hÃ ng\n" +
                            "ğŸª Cáº§n ThÆ¡: 1 cá»­a hÃ ng\n" +
                            "ğŸª Háº£i PhÃ²ng: 1 cá»­a hÃ ng\n\n" +
                            "ğŸ“ Xem Ä‘á»‹a chá»‰ chi tiáº¿t táº¡i: shngear.com/stores\n" +
                            "ğŸš— Miá»…n phÃ­ gá»­i xe táº¡i táº¥t cáº£ cá»­a hÃ ng!",
                    Keywords = ["cá»­a hÃ ng", "offline", "Ä‘á»‹a chá»‰", "store", "chi nhÃ¡nh"],
                    Category = KnowledgeCategory.General,
                    Priority = 7
                }
            };
        }
    }
}

```

### Services\KnowledgeExportService.cs
```cs
using System.Text.Json;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.Models;

namespace SHN_Gear.Services
{
    public class KnowledgeExportService
    {
        private readonly AppDbContext _context;
        public KnowledgeExportService(AppDbContext context)
        {
            _context = context;
        }

        public async Task ExportWebsiteKnowledgeBaseAsync(string filePath)
        {
            var products = await _context.Products
                .Include(p => p.Brand)
                .Include(p => p.Category)
                .Include(p => p.Variants)
                .Select(p => new
                {
                    name = p.Name,
                    category = p.Category.Name,
                    brand = p.Brand.Name,
                    price = p.Variants.OrderBy(v => v.Price).FirstOrDefault() != null ? p.Variants.OrderBy(v => v.Price).First().Price.ToString("N0") + "Ä‘" : null,
                    warranty = "12 thÃ¡ng"
                })
                .ToListAsync();

            var faqs = await _context.AIKnowledgeBases
                .Where(kb => kb.Category == KnowledgeCategory.General || kb.Category == KnowledgeCategory.Policy)
                .Select(kb => new { question = kb.Question, answer = kb.Answer })
                .ToListAsync();

            var policies = await _context.AIKnowledgeBases
                .Where(kb => kb.Category == KnowledgeCategory.Policy)
                .ToListAsync();

            var shipping = policies.FirstOrDefault(p => p.Topic.ToLower().Contains("shipping"))?.Answer ?? "";
            var returns = policies.FirstOrDefault(p => p.Topic.ToLower().Contains("return"))?.Answer ?? "";
            var warranty = policies.FirstOrDefault(p => p.Topic.ToLower().Contains("warranty"))?.Answer ?? "";

            var knowledge = new
            {
                websiteName = "SHN Gear",
                description = "SHN Gear lÃ  há»‡ thá»‘ng thÆ°Æ¡ng máº¡i Ä‘iá»‡n tá»­ chuyÃªn vá» thiáº¿t bá»‹ cÃ´ng nghá»‡, phá»¥ kiá»‡n, laptop, Ä‘iá»‡n thoáº¡i, tai nghe, vÃ  cÃ¡c sáº£n pháº©m cÃ´ng nghá»‡ chÃ­nh hÃ£ng.",
                contact = new
                {
                    hotline = "0123 456 789",
                    email = "support@shngear.vn",
                    address = "123 ÄÆ°á»ng CÃ´ng Nghá»‡, Quáº­n 1, TP.HCM"
                },
                policies = new
                {
                    shipping = shipping,
                    @return = returns,
                    warranty = warranty
                },
                faq = faqs,
                products = products
            };

            var jsonOptions = new JsonSerializerOptions
            {
                WriteIndented = true,
                Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
            };
            var json = JsonSerializer.Serialize(knowledge, jsonOptions);
            await File.WriteAllTextAsync(filePath, json, System.Text.Encoding.UTF8);
        }
    }
}

```

### Services\MoMoPaymentService.cs
```cs
using System;
using System.Collections.Generic;
using System.Net.Http;
using System.Security.Cryptography;
using System.Text;
using System.Threading.Tasks;
using Microsoft.Extensions.Configuration;
using Newtonsoft.Json;

namespace SHN_Gear.Services
{
    public class MoMoPaymentService
    {
        private readonly IConfiguration _configuration;

        public MoMoPaymentService(IConfiguration configuration)
        {
            _configuration = configuration;
        }

        public async Task<string> CreatePaymentAsync(string orderId, string orderInfo, long amount, bool isCardPayment = false)
        {
            var momoConfig = _configuration.GetSection("MoMoConfig");

            // Táº¡o requestId má»›i cho má»—i láº§n gá»i API
            var requestId = Guid.NewGuid().ToString();
            var requestType = isCardPayment ? "capture" : "captureWallet";
            var extraData = isCardPayment ? "{\"paymentType\":\"CREDIT_CARD\"}" : "";

            // Táº¡o rawHash vá»›i requestId
            var rawHash = "accessKey=" + momoConfig["AccessKey"] +
                         "&amount=" + amount +
                         "&extraData=" + extraData +
                         "&ipnUrl=" + momoConfig["NotifyUrl"] +
                         "&orderId=" + orderId +
                         "&orderInfo=" + orderInfo +
                         "&partnerCode=" + momoConfig["PartnerCode"] +
                         "&redirectUrl=" + momoConfig["ReturnUrl"] +
                         "&requestId=" + requestId +  // Äáº£m báº£o requestId Ä‘Æ°á»£c thÃªm vÃ o
                         "&requestType=" + requestType;

            var signature = ComputeHmacSha256(rawHash, momoConfig["SecretKey"]);

            var requestBody = new
            {
                partnerCode = momoConfig["PartnerCode"],
                partnerName = "SHN Gear",
                requestId = requestId,  // Truyá»n requestId vÃ o body
                amount = amount,
                orderId = orderId,
                orderInfo = orderInfo,
                redirectUrl = momoConfig["ReturnUrl"],
                ipnUrl = momoConfig["NotifyUrl"],
                requestType = requestType,
                extraData = extraData,
                signature = signature,
                lang = "vi"
            };

            using (var httpClient = new HttpClient())
            {
                var content = new StringContent(
                    JsonConvert.SerializeObject(requestBody),
                    Encoding.UTF8,
                    "application/json");

                var response = await httpClient.PostAsync(momoConfig["ApiEndpoint"], content);

                if (!response.IsSuccessStatusCode)
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    throw new Exception($"Lá»—i tá»« MoMo API: {response.StatusCode} - {errorContent}");
                }

                var responseContent = await response.Content.ReadAsStringAsync();
                var responseData = JsonConvert.DeserializeObject<Dictionary<string, string>>(responseContent);

                return responseData?["payUrl"] ?? throw new Exception("KhÃ´ng nháº­n Ä‘Æ°á»£c URL thanh toÃ¡n tá»« MoMo");
            }
        }

        public bool VerifySignature(string signature, string rawData)
        {
            var secretKey = _configuration["MoMoConfig:SecretKey"];
            var computedSignature = ComputeHmacSha256(rawData, secretKey);
            return signature.Equals(computedSignature, StringComparison.OrdinalIgnoreCase);
        }

        private string ComputeHmacSha256(string message, string secretKey)
        {
            using (var hmacsha256 = new HMACSHA256(Encoding.UTF8.GetBytes(secretKey)))
            {
                var hashMessage = hmacsha256.ComputeHash(Encoding.UTF8.GetBytes(message));
                return BitConverter.ToString(hashMessage).Replace("-", "").ToLower();
            }
        }
    }
}
```

### Services\PayPalService.cs
```cs
using PayPalCheckoutSdk.Core;
using PayPalCheckoutSdk.Orders;
using System.Text.Json;
using System.Globalization;

namespace SHN_Gear.Services
{
    public class PayPalService
    {
        private readonly PayPalHttpClient _client;
        private readonly IConfiguration _config;
        private readonly ILogger<PayPalService> _logger;

        public PayPalService(IConfiguration config, ILogger<PayPalService> logger)
        {
            _config = config;
            _logger = logger;

            var clientId = _config["PayPal:ClientId"];
            var secret = _config["PayPal:Secret"];

            PayPalEnvironment environment = _config["PayPal:Mode"] == "Sandbox"
                ? new SandboxEnvironment(clientId, secret)
                : new LiveEnvironment(clientId, secret);

            _client = new PayPalHttpClient(environment);
        }

        public async Task<string> CreateOrder(
            decimal amount,
            string currency,
            string invoiceId,
            string returnUrl,
            string cancelUrl)
        {
            try
            {
                var amountString = amount.ToString("0.00", CultureInfo.InvariantCulture);
                _logger.LogInformation($"Creating PayPal order with amount: {amountString} {currency}");

                var orderRequest = new OrderRequest()
                {
                    CheckoutPaymentIntent = "CAPTURE", // Sá»­ dá»¥ng CheckoutPaymentIntent thay vÃ¬ Intent
                    PurchaseUnits = new List<PurchaseUnitRequest>
                    {
                        new PurchaseUnitRequest
                        {
                            ReferenceId = "default",
                            InvoiceId = invoiceId,
                            AmountWithBreakdown = new AmountWithBreakdown
                            {
                                CurrencyCode = currency,
                                Value = amountString,
                                AmountBreakdown = new AmountBreakdown
                                {
                                    ItemTotal = new Money
                                    {
                                        CurrencyCode = currency,
                                        Value = amountString
                                    }
                                }
                            }
                        }
                    },
                    ApplicationContext = new ApplicationContext
                    {
                        ReturnUrl = returnUrl,
                        CancelUrl = cancelUrl,
                        BrandName = "SHN Gear",
                        UserAction = "PAY_NOW",
                        ShippingPreference = "NO_SHIPPING"
                    }
                };

                var request = new OrdersCreateRequest();
                request.Prefer("return=representation");
                request.RequestBody(orderRequest);

                var response = await _client.Execute(request);
                var result = response.Result<Order>();

                _logger.LogInformation($"Created PayPal Order ID: {result.Id}");
                return result.Id;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Failed to create PayPal order");
                return string.Empty;
            }
        }

        public async Task<PayPalCaptureResult> CaptureOrder(string orderId)
        {
            try
            {
                var request = new OrdersCaptureRequest(orderId);
                request.RequestBody(new OrderActionRequest());
                request.Prefer("return=representation");

                var response = await _client.Execute(request);
                var result = response.Result<Order>();

                var transactionId = result.PurchaseUnits?[0]?.Payments?.Captures?[0]?.Id;
                _logger.LogInformation($"Captured PayPal Order: {orderId}, Transaction ID: {transactionId}");

                return new PayPalCaptureResult
                {
                    Success = result.Status == "COMPLETED",
                    TransactionId = transactionId,
                    RawResponse = JsonSerializer.Serialize(result)
                };
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"Failed to capture PayPal order {orderId}");
                return new PayPalCaptureResult
                {
                    Success = false,
                    ErrorMessage = ex.Message
                };
            }
        }
    }

    public class PayPalCaptureResult
    {
        public bool Success { get; set; }
        public string? TransactionId { get; set; }
        public string? RawResponse { get; set; }
        public string? ErrorMessage { get; set; }
    }
}
```

### Services\UserService.cs
```cs
using System;
using System.Linq;
using System.Security.Cryptography;
using System.Text;
using System.Threading.Tasks;
using Microsoft.EntityFrameworkCore;
using SHN_Gear.Data;
using SHN_Gear.DTOs;
using SHN_Gear.Models;

namespace SHN_Gear.Services
{
    public class UserService
    {
        private readonly AppDbContext _context;
        public User? GetUserById(int userId)
        {
            return _context.Users
                .Include(u => u.Role) // Náº¿u User cÃ³ Role, ta include vÃ o Ä‘á»ƒ láº¥y thÃ´ng tin
                .FirstOrDefault(u => u.Id == userId);
        }

        public UserService(AppDbContext context)
        {
            _context = context;
        }

        public async Task<bool> RegisterUserAsync(RegisterDto registerDto)
        {
            if (await _context.Users.AnyAsync(u => u.Email == registerDto.Email))
            {
                return false; // Email Ä‘Ã£ tá»“n táº¡i
            }

            var role = await _context.Roles.FindAsync(2);
            if (role == null)
            {
                return false;
            }

            string hashedPassword = HashPassword(registerDto.Password);

            var user = new User
            {
                Email = registerDto.Email,
                Password = hashedPassword,
                CreatedAt = DateTime.UtcNow,
                RoleId = role.Id,
                Role = role,

                // GÃ¡n giÃ¡ trá»‹ tá»« DTO
                FullName = !string.IsNullOrWhiteSpace(registerDto.FullName) ? registerDto.FullName : "",
                PhoneNumber = !string.IsNullOrWhiteSpace(registerDto.PhoneNumber) ? registerDto.PhoneNumber : ""
            };

            _context.Users.Add(user);
            await _context.SaveChangesAsync();
            return true;
        }


        public async Task<User> AuthenticateUserAsync(LoginDto loginDto)
        {
            // ThÃªm Include Ä‘á»ƒ load thÃ´ng tin Role
            var user = await _context.Users
                .Include(u => u.Role) // Quan trá»ng
                .FirstOrDefaultAsync(u => u.Email == loginDto.Email);

            if (user == null || !VerifyPassword(loginDto.Password, user.Password))
                return null;

            return user;
        }

        public string HashPassword(string password)
        {
            using var sha256 = SHA256.Create();
            var hashedBytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(password));
            return Convert.ToBase64String(hashedBytes);
        }

        private bool VerifyPassword(string inputPassword, string storedHash)
        {
            return HashPassword(inputPassword) == storedHash;
        }
        public async Task<bool> CheckEmailExistsAsync(string email)
        {
            return await _context.Users.AnyAsync(u => u.Email == email);
        }

        public async Task<User?> GetUserByIdAsync(int userId)
        {
            return await _context.Users.FindAsync(userId);
        }
        public async Task<User?> UpdateUserProfileAsync(int userId, EditProfileDto editDto)
        {
            var user = await _context.Users.FindAsync(userId);
            if (user == null) return null;

            user.FullName = editDto.FullName;
            user.Email = editDto.Email;
            user.PhoneNumber = editDto.PhoneNumber;
            user.Gender = editDto.Gender;
            user.DateOfBirth = editDto.DateOfBirth;

            await _context.SaveChangesAsync();
            return user;
        }
    }
}

```
